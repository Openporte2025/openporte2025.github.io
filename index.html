<!DOCTYPE html>
<!--
    Open Porte v3.5 - FASE 021f: FIX COMPLETAMENTO >100% ‚úÖ
    
    ‚ú® MODIFICHE FASE 021f (03 NOV 2025 - CHAT 021 FIX PERCENTUALE):
    ‚úÖ FIX COMPLETAMENTO SUPERIORE AL 100%:
       - PROBLEMA: Completamento posizione mostrava 130% invece di max 100%
       - UTENTE: "COME FA AD ESSERE SUPERIORE DEL 100% INCOMPLETO"
       - CAUSA: Punti doppi assegnati per prodotti assenti
       - BUG: Riga 3181 dava 30 punti per prodotti assenti
              Riga 3215 aggiungeva ALTRI 30 punti se tutti assenti
              Totale: 20 + 20 + 30 + 30 = 100... ma 30 contati 2 volte = 130%!
       - SOLUZIONE: Rimossa riga 3214-3216 (aggiunta doppia punti misure)
       - RISULTATO: Completamento MAX 100% sempre! ‚úÖ
    
    üéØ LOGICA CORRETTA PUNTEGGIO:
       ```
       1. Nome posizione:  20 punti max
       2. Ambiente:        20 punti max
       3. Prodotti OK:     30 punti max (presenti + dichiarati assenti)
       4. Misure complete: 30 punti max (solo per prodotti PRESENTI)
       ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
       TOTALE MAX:        100 punti (100%)
       ```
    
    ‚ú® MODIFICHE FASE 021e (03 NOV 2025 - CHAT 021 FIX DROPDOWN):
    ‚úÖ FIX HEADER CHE COPRE DROPDOWN:
       - PROBLEMA: Header fisso con z-index alto copriva dropdown select
       - UTENTE: "Non riesco a selezionare la parte alta" 
       - SOLUZIONE 1: position fixed ‚Üí sticky (scorre con pagina)
       - SOLUZIONE 2: z-index 1000 ‚Üí 40 (meno invasivo)
       - SOLUZIONE 3: height 60px ‚Üí 50px (header pi√π compatto)
       - SOLUZIONE 4: select:focus z-index: 50 (dropdown sopra header)
       - RISULTATO: Dropdown selezionabili in tutta la pagina! ‚ú®
    
    üéØ MODIFICHE CSS:
       ```css
       .app-header {
           position: sticky;    /* era: fixed */
           height: 50px;        /* era: 60px */
           z-index: 40;         /* era: 1000 */
       }
       
       select:focus {
           position: relative;
           z-index: 50;         /* sopra header */
       }
       ```
    
    ‚ú® MODIFICHE FASE 021d (03 NOV 2025 - CHAT 021 FIX HEADER):
    ‚úÖ FIX CRITICO HEADER POSIZIONI:
       - PROBLEMA: Header hamburger NON appariva in pagina posizioni
       - CAUSA: renderProjectMenu() usava state.projects[currentProject] (accesso array per indice)
       - CORRETTO: state.projects.find(p => p.id === currentProject) (ricerca per ID)
       - RISULTATO: Header con menu hamburger ora visibile in tutte le pagine progetto
       - Menu "‚Üê Lista Progetti" funziona in ogni sezione
    
    üêõ BUG SPECIFICO:
       ```javascript
       // PRIMA (SBAGLIATO) - riga 2064
       const project = state.projects[state.currentProject]; // currentProject √® ID, non indice!
       
       // DOPO (CORRETTO)
       const project = state.projects.find(p => p.id === state.currentProject);
       ```
    
    ‚ú® MODIFICHE FASE 021c (03 NOV 2025 - CHAT 021 FIX FINALE):
    ‚úÖ FIX MENU SISTEMA COMPLETO:
       - Rimosso COMPLETAMENTE vecchio header e menu statico dal body
       - Header ora renderizzato dinamicamente per ogni sezione
       - Lista progetti: Header() con pulsanti Import/Export/Nuovo
       - Progetto: renderTopNavbar() con hamburger + menu laterale
       - PositionDetail: renderTopNavbar() con menu laterale (come progetto)
       - Pulsante "‚Üê Lista Progetti" nel menu laterale ora funziona
       - Navigazione pulita senza duplicazioni header
       - Un solo sistema di menu, zero conflitti
    
    üîß PROBLEMI RISOLTI:
       - Due header sovrapposti (vecchio statico + nuovo dinamico)
       - Pulsanti che chiamavano funzioni inesistenti (toggleMenu, navigateTo)
       - Menu "Config Globali" che non faceva nulla
       - Impossibilit√† tornare a lista progetti
       - Overlay conflittuali
    
    üéØ STRUTTURA FINALE:
       - body: Solo <div id="app"></div>
       - render(): Chiama ProjectsList/ProjectSetup/PositionDetail
       - ProjectsList(): Include Header() con azioni lista
       - ProjectSetup(): Include renderTopNavbar() con menu laterale
       - PositionDetail(): Include renderTopNavbar() con menu laterale
    
    ‚ú® MODIFICHE FASE 021b (31 OTT 2025 - CHAT 021 CONTINUAZIONE):
    ‚úÖ FIX CRITICO VALIDAZIONE:
       - TMV >= LF: Telaio Montante Verticale deve CONTENERE Luce Foro
       - HMT >= HF: Altezza Montante Telaio deve CONTENERE Altezza Foro
       - PRIMA (SBAGLIATO): Controllava TMV < LF, HMT < HF (invertito!)
       - DOPO (CORRETTO): Controlla TMV >= LF, HMT >= HF (logica corretta)
       - Messaggio errore aggiornato con logica corretta
    
    üéØ LOGICA CORRETTA:
       Il telaio/muro (TMV, HMT) deve essere PI√ô GRANDE del foro (LF, HF)
       perch√© il foro sta DENTRO il telaio/muro, non viceversa!
    
    ‚ú® MODIFICHE FASE 021 (31 OTT 2025 - CHAT 021):
    ‚úÖ MENU LATERALE HAMBURGER:
       - Header compatto fisso con pulsante hamburger ‚ò∞
       - Menu laterale scorrevole (slide-in da sinistra)
       - Overlay scuro semi-trasparente per chiusura
       - Animazioni smooth (300ms cubic-bezier)
       - Responsive: mobile 85%, tablet 280px, desktop 320px
    
    ‚úÖ STRUTTURA MENU:
       - Info progetto (Nome + Ambiente)
       - Navigazione principale con indicatori completamento
       - Submenu Config espandibile con percentuali prodotti
       - Azioni rapide (Export JSON/PDF, Import, Lista progetti)
       - Badge completamento colorati (verde/giallo/rosso)
    
    ‚úÖ FUNZIONALIT√Ä:
       - toggleProjectMenu(): apre/chiude menu laterale
       - closeProjectMenu(): chiude menu (anche con click overlay)
       - toggleConfigMenu(): espande/collassa submenu Config
       - Navigazione chiude menu automaticamente
       - Preservate tutte funzioni calcolo completamento
       - Disabilita Posizioni se Setup incompleto
    
    ‚úÖ UX MIGLIORATA:
       - Pi√π spazio per contenuto principale
       - Mobile-friendly (standard UX mobile)
       - Azioni export/import sempre accessibili
       - Header pulito e minimale
       - Focus massimo sul contenuto
    
    ‚ú® MODIFICHE FASE 017 (29 OTT 2025 - CHAT 017):
    ‚úÖ FIX RICARICA IMMEDIATA QUANTIT√Ä:
       - Cambio quantit√† ora ricarica la pagina IMMEDIATAMENTE
       - Visualizzazione minimale/completa si aggiorna in tempo reale
       - UX migliorata: feedback istantaneo all'utente
       - Implementazione: render() chiamato automaticamente quando field='qta'
       - Fix applicato in updateProduct() dopo saveState()
    
    ‚ú® MODIFICHE FASE 016 (29 OTT 2025 - CHAT 016):
    ‚úÖ QTA=0 MANTIENE PRODOTTO VISIBILE:
       - Impostare quantit√†=0 NON elimina pi√π il prodotto dalla posizione
       - Prodotto rimane configurato e visibile
       - Utente pu√≤ aumentare quantit√† in qualsiasi momento (0‚Üí1‚Üí2‚Üí3...)
       - Logica: qta=0 = "prodotto configurato ma non presente in questa posizione"
       - Ideale per: prodotto opzionale, da decidere dopo, in attesa ordine
       - Vantaggi: Zero click inutili, massima flessibilit√†
    ‚úÖ VISUALIZZAZIONE MINIMALE PER QTA=0:
       - qta=0: Mostra SOLO il dropdown quantit√† (pagina pulita)
       - qta‚â•1: Mostra TUTTI i campi del prodotto (pagina completa)
       - Transizione automatica: cambio qta 0‚Üî1 aggiorna visualizzazione (FASE 017: fix immediato)
       - Dati sempre preservati: anche con qta=0 tutti i dati rimangono salvati
       - Applicato a: Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
       - UX migliorata: meno confusione visiva quando prodotto assente
    
    ‚ú® MODIFICHE FASE 015 (29 OTT 2025 - CHAT 015):
    ‚úÖ GESTIONE ESPLICITA DEGLI 0:
       - FIX CRITICO: cleanNegativeValues() ora preserva '0' espliciti (non li sovrascrive)
       - FIX CRITICO: addCassonetto() non sovrascrive pi√π BSuperiore='0' dell'utente
       - FIX: Visualizzazione BRM mostra "0" invece di "-" quando il valore √® zero
       - Placeholder informativi: "Inserisci misura (anche 0 se assente)"
       - Completamento: prodotto con BRM=0 √® considerato "compilato" (gi√† funzionante)
       - Export JSON: valori 0 vengono inclusi correttamente (gi√† funzionante)
       - Validazione: accetta 0 come valore valido (gi√† funzionante)
       - ‚úÖ QUANTIT√Ä PRODOTTI: Dropdown quantit√† ora parte da 0 a 10 (prima 1-10)
         * Applicato a: Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
         * Permette di indicare "quantit√† 0" per prodotti assenti in posizione
       
    üéØ PRINCIPIO FONDAMENTALE:
       - "0" nelle MISURE = VALORE ESPLICITO (l'utente ha inserito zero)
       - "" (vuoto) nelle MISURE = CAMPO MANCANTE (non ancora compilato)
       - "0" nella QUANTIT√Ä = PRODOTTO CONFIGURATO MA ASSENTE (rimane visibile e modificabile)
       - Distinzione preservata in tutto il codice!
    
    ‚ú® MODIFICHE FASE 012 (28 OTT 2025 - CHAT 012):
    
    ‚ú® MODIFICHE FASE 012 (28 OTT 2025 - CHAT 012):
    ‚úÖ MENU PRINCIPALE MIGLIORATO:
       - LAYOUT A DUE RIGHE: Nome progetto e utility in alto, navigazione in basso
       - PULSANTE "‚Üê Lista" per tornare rapidamente alla lista progetti
       - NOME PROGETTO E AMBIENTE visibili sempre nel menu
       - INDICATORI DI COMPLETAMENTO su ogni sezione (pallino colorato)
       - PERCENTUALI DI COMPLETAMENTO nel dropdown Config
       - PULSANTE "üìã Riepilogo" per visualizzare riepilogo rilievi
       - DROPDOWN CONFIG MIGLIORATO con percentuali per ogni prodotto
       
    ‚úÖ FUNZIONI DI CALCOLO COMPLETAMENTO:
       - calcolaCompletamentoCliente() - verifica campi cliente compilati
       - calcolaCompletamentoSetup() - verifica prodotti selezionati
       - calcolaCompletamentoConfig() - media completamento configurazioni
       - calcolaCompletamentoPosizioni() - posizioni con misure
       - Funzioni specifiche per ogni prodotto (Infissi, Persiane, etc.)
       
    ‚úÖ INDICATORI VISIVI:
       - Pallino VERDE = 100% completo
       - Pallino GIALLO = 50-99% completo  
       - Pallino ROSSO = 1-49% completo
       - Nessun pallino = 0% (non iniziato)
       
    ‚úÖ MIGLIORAMENTI USABILIT√Ä:
       - Click fuori dal dropdown lo chiude automaticamente
       - Tooltip con percentuale esatta al passaggio del mouse
       - Menu pi√π compatto e organizzato
       - Navigazione pi√π intuitiva con feedback visivo
    
    ‚ú® MODIFICHE FASE 03 (25 OTT 2025 - PRECEDENTE):
    ‚úÖ EXPORT JSON COMPLETO CON DATI MURO:
       - Aggiunto campo "nome_ricerca" per ricerca facile (cliente + progetto)
       - Aggiunto "caratteristiche_muro_globali" con tutti i dati globali del progetto
       - Aggiunto "caratteristiche_muro_override" per ogni posizione (se presente)
       - Aggiunto "rilievo_preesistente" per ogni posizione (se presente)
       - Include: telaio, falso, guida, coprifilo, profondit√† muro, battuta superiore tapparella
       - Versione JSON aggiornata a "1.0-FASE007"
       
    üîç RICERCA NEL JSON:
       Cerca il campo "nome_ricerca" per trovare rapidamente il progetto
       Esempio: "nome_ricerca": "Mario Rossi Appartamento Centro"
    
    ‚ú® MODIFICHE FASE 02 (25 OTT 2025 - PRECEDENTE):
    ‚úÖ BSup PRE-COMPILATO CON BATTUTA SUPERIORE TAPPARELLA:
       - Quando aggiungi un cassonetto, BSuperiore viene automaticamente pre-compilato
       - Il valore iniziale √® "Battuta Superiore con Tapparella" dalle caratteristiche muro
       - Usa le caratteristiche muro override se presenti, altrimenti quelle globali
       - Il campo rimane MODIFICABILE dall'utente
       - Migrazione automatica: cassonetti esistenti vengono inizializzati all'avvio
       - Funzioni modificate: addCassonetto(), ricalcolaBRMCassonetto(), cleanNegativeValues()
    
    ‚ú® MODIFICHE FASE 01 (25 OTT 2025 - PRECEDENTE):
    ‚úÖ OVERRIDE MANUALE VALIDAZIONE MISURE:
       - Nuovo sistema per confermare manualmente misure con errore di validazione
       - Pulsante "‚úì Conferma OK" appare accanto ai campi con errore (bordo rosso)
       - Dopo conferma: campo diventa VERDE con badge "‚úÖ CONFERMATO (manuale)"
       - L'override ignora solo l'errore specifico di quel campo
       - Pulsante "‚úï Annulla conferma" per rimuovere l'override se necessario
       - Gli override vengono salvati nel state (pos.validationOverrides)
       - Utile per casi particolari sul campo dove la misura √® corretta ma la validazione automatica √® troppo restrittiva
    
    ‚ú® MODIFICHE FASE 28 (22 OTT 2025 - PRECEDENTE):
    ‚úÖ STEP DINAMICI IN BASE AI PRODOTTI SELEZIONATI:
       - La barra degli step mostra SOLO i prodotti selezionati
       - MURO INTEGRATO NELLO STEP "PRODOTTI": Step 2 contiene sia selezione prodotti che config muro
       - Ordine: Cliente ‚Üí Prodotti+Muro ‚Üí Config Prodotti selezionati ‚Üí Posizioni
       - I numeri degli step si adattano automaticamente (es: 1,2,3,4 invece di 1,2,3,4,5,6,7,8,9)
       - Navigazione intelligente: i pulsanti Avanti/Indietro saltano solo agli step validi
       - Se deseleziono un prodotto mentre sono sul suo step ‚Üí salto automaticamente allo step successivo
    
    ‚úÖ CARATTERISTICHE MURO PERSONALIZZATE PER POSIZIONE - RISOLTO:
       - Quando clicchi "Personalizza caratteristiche muro" ora APPARE l'intera sezione modificabile
       - Aggiunta funzione updateCaratteristicheMuroOverride() per gestire le modifiche delle posizioni
       - Aggiunta funzione renderCaratteristicheMuroOverride() per mostrare tutti i campi
       - I campi vengono mostrati in un box viola/giallo per distinguerli dal globale
       - Funziona esattamente come la config globale ma modifica pos.caratteristicheMuroOverride
       - Pulsante "Ripristina globali" sempre visibile per tornare ai valori globali
    
    ‚ú® MODIFICHE FASE 27 (22 OTT 2025 - PRECEDENTE):
    ‚úÖ MODAL "NUOVO PROGETTO" OTTIMIZZATO:
       - Campo "Cliente" SEMPRE OBBLIGATORIO (identifica il progetto)
       - Campo "Nome progetto" OPZIONALE
       - Ordine invertito: Cliente ‚Üí Nome progetto
       - Se Nome progetto vuoto ‚Üí usa nome Cliente come identificativo
       - Validazione migliorata con alert se Cliente mancante
       - UI migliorata: bordo viola per campo obbligatorio, testo esplicativo
    
    ‚ú® NUOVE FUNZIONALIT√Ä PER ODOO (22 OTT 2025):
    ‚úÖ PULSANTE "STAMPA PDF":
       - Genera un PDF professionale del rilievo completo
       - Include tutti i dati: cliente, posizioni, prodotti, misure BRM
       - Pronto per essere caricato su Odoo come allegato
       - Layout ottimizzato per stampa con intestazione aziendale
    
    ‚úÖ PULSANTE "EXPORT JSON PER ODOO":
       - Esporta il singolo progetto in formato JSON
       - Struttura ottimizzata per integrazione con Odoo
       - Include: cliente, posizioni, prodotti, misure, BRM, totali
       - Nome file: RILIEVO-[Cliente]-[Progetto]-[Data].json
       - Pronto per essere caricato su Odoo e letto dal sistema
    
    ‚úÖ WORKFLOW INTEGRATO:
       1. Fai rilievo con app ‚Üí Compila tutti i dati
       2. Clicca "Stampa PDF" ‚Üí Salva PDF per archivio/stampa
       3. Clicca "Export JSON" ‚Üí Scarica file JSON
       4. Apri Odoo ‚Üí Progetto S00XXX ‚Üí Allega entrambi i file
       5. La ragazza legge il PDF per fare preventivo
       6. Il JSON √® pronto per future automazioni
    
    üéØ VANTAGGI:
       - Zero costi di sviluppo
       - Immediate integration con Odoo
       - Dati sempre aggiornati e tracciati
       - Squadra posa pu√≤ scaricare PDF da Odoo su smartphone
    
    ‚ú® MODIFICHE FASE 26 (22 OTT 2025 - PRECEDENTE):
    ‚úÖ CAMPO "TIPO TAGLI" ELIMINATO:
       - Rimosso completamente il campo "Tipo Tagli" dalla posizione infissi
       - Il campo era ridondante con la selezione "Tagli Telaio"
       - Rimangono attivi: Tagli Telaio (dropdown) e COD.TAGLI (campi multipli editabili)
    
    ‚ú® MODIFICHE FASE 25 (21 OTT 2025):
    ‚úÖ BRM FINESTRA/PORTAFINESTRA - INFISSI:
       - Config Globale (STEP 3): Aggiunta sezione "BRM FINESTRA" e "BRM PORTAFINESTRA"
       - BRM Finestra usa HF per altezza
       - BRM Portafinestra usa HPF per altezza
       - Nelle posizioni: Se tipo √® F1/F2/F3/FISSO ‚Üí usa BRM Finestra
       - Nelle posizioni: Se tipo √® PF1/PF2/PF3 ‚Üí usa BRM Portafinestra
       - Ricalcolo automatico quando cambia il tipo di infisso
       
    ‚úÖ BRM FINESTRA/PORTAFINESTRA - ZANZARIERE:
       - Config Globale (STEP 6): Aggiunta sezione "BRM FINESTRA" e "BRM PORTAFINESTRA"
       - BRM Finestra usa LF/HF
       - BRM Portafinestra usa LPF/HPF
       - Nelle posizioni: Legge il tipo dell'INFISSO nella stessa posizione
       - Se infisso √® F1/F2/F3/FISSO ‚Üí usa BRM Finestra
       - Se infisso √® PF1/PF2/PF3 ‚Üí usa BRM Portafinestra
       - Ricalcolo automatico quando cambia il tipo di infisso
       
    ‚úÖ COD.TAGLI FIX:
       - RISOLTO: Campo codTagli ora viene copiato dalla config globale in addInfisso
       - Quando selezioni "4 Lati", vedrai correttamente: SOPRA, SOTTO, SX, DX
       - Tutti i tag sono modificabili singolarmente
       
    ‚úÖ MODIFICHE TECNICHE:
       - calculateBRM() ora accetta parametro 'tipo' (es: "F1", "PF2")
       - Se tipo contiene "PF" usa configurazioni _PF (misuraBaseH_PF, etc)
       - Tutte le funzioni di ricalcolo BRM passano il tipo corretto
       - updateProduct() ricalcola BRM quando cambia tipo infisso
    
    ‚ú® MODIFICHE FASE 24 (21 OTT 2025 - PRECEDENTE):
    ‚úÖ INFISSI - HPF AGGIUNTO:
       - Aggiunto HPF (Altezza Portafinestra) nei dropdown BRM personalizzati
       - Ora disponibili: HF (finestra) e HPF (portafinestra) per altezza
       
    ‚úÖ ZANZARIERE - LPF E HPF AGGIUNTI:
       - Aggiunto LPF (Larghezza Portafinestra) nei dropdown BRM personalizzati per larghezza
       - Aggiunto HPF (Altezza Portafinestra) nei dropdown BRM personalizzati per altezza
       - Distinzione completa tra Finestra (LF/HF) e Portafinestra (LPF/HPF)
       
    ‚úÖ CASSONETTI - BRM_C E BRM_B IMPLEMENTATI:
       - Aggiunto BRM_C e BRM_B nella configurazione globale (brmConfigCassonetti)
       - Aggiunto calcolo BRM_C e BRM_B nella funzione calculateBRM()
       - Aggiunto inizializzazione BRM_C e BRM_B in addCassonetto()
       - Aggiunto ricalcolo BRM_C e BRM_B in ricalcolaBRMCassonetto()
       - Aggiunto gestione BRM_C e BRM_B in applicaBRMPersonalizzato()
       - Aggiunto gestione BRM_C e BRM_B in ripristinaGlobale()
       - Aggiunto gestione BRM_C e BRM_B in personalizzaBRM()
       - Visualizzazione formula globale e personalizzata per C e B
       - Dropdown per selezionare misure base (C, B, HCASS, BSuperiore)
       - Campi risultato per BRM_C e BRM_B
    
    ‚ú® MODIFICHE FASE 20A (20 OTT 2025 - PRECEDENTE):
    ‚úÖ NUOVO SISTEMA BRM PERSONALIZZATO - COMPLETAMENTE RIDISEGNATO:
    ‚úÖ NUOVO SISTEMA BRM PERSONALIZZATO - COMPLETAMENTE RIDISEGNATO:
       - RIMOSSO: Propriet√† usaGlobale (confusa e causava errori)
       - RIMOSSO: Funzione toggleUsaGlobale()
       - AGGIUNTO: personalizzaBRM() - Crea formula personalizzata per posizione
       - AGGIUNTO: ripristinaGlobale() - Elimina personalizzazione, torna a globale
       
    üéØ NUOVO FUNZIONAMENTO PI√ô CHIARO:
       - Di default ‚Üí Ogni posizione usa la formula GLOBALE (dalle impostazioni progetto)
       - Per personalizzare ‚Üí Bottone "üé® Personalizza BRM" (viola)
       - Personalizzato ‚Üí Mostra form con dropdown per modificare formula
       - Ripristina ‚Üí Bottone "‚Ü©Ô∏è Usa Globale" (verde) per tornare a formula standard
       
    ‚úÖ LOGICA SEMPLIFICATA:
       - Se esiste product.brmPersonalizzato ‚Üí Usa formula personalizzata
       - Se NON esiste ‚Üí Usa formula globale (project.brmConfigXXX)
       - Nessun toggle, nessuna ambiguit√†!
       
    ‚úÖ APPLICATO A TUTTI I PRODOTTI:
       - Infissi, Persiane, Tapparelle, Zanzariere, Cassonetti
       - Per cassonetti: bottone "Ricalcola BRM" visibile SOLO con formula globale
       
    ‚úÖ VANTAGGI:
       - Pi√π chiaro: o usi globale, o usi personalizzato (no toggle confuso)
       - Visivamente distinto: bottoni colorati diversamente
       - Pi√π facile da debuggare: logica lineare senza flag booleani
       - Pi√π stabile: nessun conflitto tra usaGlobale e brmPersonalizzato
    
    ‚ú® MODIFICHE FASE 15_FIX3 (20 OTT 2025 - PRECEDENTE):
    ‚úÖ CONFIG GLOBALE INFISSI (STEP 3) - ULTRA SEMPLIFICATA:
       - RIMOSSO: Misure Principali (LVT, HVT, LF, HF, TMV, HMT, LVAR, HVAR)
       - RIMOSSO: Delta (Delta INT, Delta EST)
       - RIMOSSO: Altezze (H Soffitto, H Parapetto/Soffitto, H Pavimento/Parapetto)
       - Nella config globale STEP 3 rimangono SOLO:
         * üîß Materiale (con toggle SELECT/INPUT)
         * üìù Note
         * üî® Da togliere? (checkbox)
         * üóëÔ∏è Da smaltire? (checkbox)
         * üìè Coprifili INT? (checkbox)
         * üìê Coprifili EST? (checkbox)
       - TUTTE le misure (Principali, Delta, Altezze) sono ora SOLO nelle posizioni
       - Config globale focalizzata su informazioni comuni e scelte operative
    
    ‚ú® MODIFICHE FASE 15_FIX2 (20 OTT 2025 - PRECEDENTE):
    ‚úÖ MISURE PRINCIPALI INFISSI - SOLO NELLE POSIZIONI:
       - RIMOSSO: Misure Principali (LVT, HVT, LF, HF, TMV, HMT, LVAR, HVAR) dalla config globale STEP 3
       - Le Misure Principali ora sono disponibili SOLO dentro ogni singola posizione
       - Nella config globale (STEP 3) rimangono solo:
         * Delta (Delta INT, Delta EST)
         * Altezze (H Soffitto, H Parapetto/Soffitto, H Pavimento/Parapetto)
         * Materiale
         * Note
         * Checkbox (Da togliere, Da smaltire, Coprifili INT, Coprifili EST)
    
    ‚ú® MODIFICHE FASE 15_FIX (20 OTT 2025 - PRECEDENTE):
    ‚úÖ BRM PERSONALIZZATO SEMPLIFICATO:
       - updateBRMPersonalizzato() ora fa semplicemente render() completo
       - RIMOSSO: Codice complesso con querySelector che cercava manualmente gli elementi
       - RISULTATO: Nessun errore di inserimento nella posizione!
       - Pi√π stabile, pi√π affidabile, pi√π semplice da manutenere
       - Il BRM si aggiorna correttamente in tempo reale
    
    ‚ú® MODIFICHE FASE 15 (PRECEDENTE):
    ‚úÖ RILIEVO PREESISTENTE INFISSI - MISURE VISIBILI SUBITO:
    ‚úÖ RILIEVO PREESISTENTE INFISSI - MISURE VISIBILI SUBITO:
       - Misure Principali (LVT, HVT, LF, HF, TMV, HMT, LVAR, HVAR) in griglia 4 colonne
       - Delta (Delta INT, Delta EST) in griglia compatta
       - Altezze (H Soffitto, H Parapetto/Soffitto, H Pavimento/Parapetto)
       - Posizionate PRIMA di Materiale e Note
       - Visibili SOLO per Infissi
       - Funzione updateMisureGlobaliInfissi(projectId, field, value)
       - Salvataggio in project.misureGlobaliInfissi
    
    ‚ú® MODIFICHE FASE 13a (PRECEDENTI):
    ‚úÖ CAMPO "COSA C'√à" - ELIMINATO:
       - Rimosso completamente il campo "üè† Cosa c'√®?" dal rilievo preesistente
       - Layout adattato da 3 a 2 colonne (Materiale + Note)
    
    ‚úÖ CAMPO "MATERIALE" - SELECT/INPUT INTERCAMBIABILE:
       - Aggiunto bottone toggle "‚úèÔ∏è Scrivi" / "üìã Tendina"
       - Modalit√† SELECT (default): Dropdown con opzioni predefinite (Legno, PVC, Alluminio, Ferro)
       - Modalit√† INPUT: Campo testo libero per materiali personalizzati
       - Sincronizzazione automatica del valore tra le due modalit√†
       - Funzione toggleMaterialeMode(productType, projectId) per gestire il cambio modalit√†
    
    ‚ú® MODIFICHE FASE 13 (PRECEDENTI):
    ‚úÖ RILIEVO PREESISTENTE GLOBALE:
       - Aggiunta sezione "RILIEVO PREESISTENTE" negli STEP di configurazione (3,4,5,7)
       - Ogni prodotto (Infissi, Persiane, Tapparelle, Cassonetti) ha il suo rilievo globale
       - Campi globali per ogni prodotto:
         * üîß Materiale (SELECT/INPUT intercambiabile)
         * üìù Note
         * üî® Da togliere? (checkbox)
         * üóëÔ∏è Da smaltire? (checkbox)
       - SOLO per INFISSI anche:
         * üìè Coprifili INT? (checkbox)
         * üìê Coprifili EST? (checkbox)
       
    ‚úÖ SALVATAGGIO DATI:
       - I dati globali vengono salvati in: project.rilievoInfissi, project.rilievoPersiane, etc.
       - Ogni posizione pu√≤ modificare localmente questi dati (pos.rilievo)
       - Indicatore progresso: 0-100% completezza campi
       - Validazione visiva con colori (rosso = incompleto, verde = completo)
    
    ‚úÖ FUNZIONI NUOVE:
       - updateRilievoGlobale(projectId, productType, field, value)
       - getRilievoGlobale(project, productType)
       - calculateRilievoGlobaleCompleteness(project, productType)
       - renderRilievoGlobale(project, productType, productLabel, icon)
       - toggleMaterialeMode(productType, projectId) - FASE 13a
    
    ‚ú® MODIFICHE FASE 11_1A (PRECEDENTE):
    ‚úÖ BRM CASSONETTI - Nuove Misure Larghezza:
       - Opzioni specifiche per cassonetti: LARGH_CASS, LS, LVT, TMV, LF, MIS_FIN_INF_L, LS+SRDX+SRSX
       - Le altre tipologie di prodotto mantengono le misure standard
       - FORMULE COMPOSITE: Supporto per formule tipo "LS+SRDX+SRSX" (somma automatica di pi√π misure)
       - Le misure del cassonetto sono salvate nel cassonetto stesso (non in pos.misure)
       - Ricalcolo automatico BRM quando cambiano le misure (LS, SRSX, SRDX, etc.)
       - Bottone "Ricalcola BRM" visibile SOLO con "Usa Globale" attivo
       - Con formula personalizzata, il BRM si aggiorna automaticamente modificando i dropdown
    
    ‚úÖ TAGLI INFISSO - COD.TAGLI Automatico:
       - ELIMINATO campo "Tipo Tagli" (campo testo libero)
       - AGGIUNTO campo "COD.TAGLI" (sola lettura, automatico)
       - Codice generato automaticamente in base alla selezione di "Tagli Telaio":
         * Sopra ‚Üí SOPRA
         * Sotto ‚Üí SOTTO
         * Sopra/Sotto ‚Üí SOPRA SOTTO
         * DX ‚Üí DX
         * SX ‚Üí SX
         * DX/SX ‚Üí DX SX
         * 4 Lati ‚Üí SOPRA SOTTO SX DX
         * Sopra/Laterali ‚Üí SOPRA SX DX
         * Sotto/Laterali ‚Üí SOTTO SX DX
    
    üîß FIX TECNICI:
       - calculateBRM() ora gestisce formule composite con "+" e rimuove spazi
       - addCassonetto() inizializza tutte le misure a 0
       - updateProduct() ricalcola BRM per tutte le misure del cassonetto
       - toggleUsaGlobale() copia correttamente l'operazione dalla config globale
       - updateBRMPersonalizzato() usa le misure corrette per cassonetti
       - Bottone "Ricalcola BRM" nascosto quando si usa formula personalizzata (non serve)
    
    ‚ú® MODIFICHE FASE 11a (PRECEDENTE):
    ‚úÖ CASSONETTI - Nuovo Campo "Tipo Cassonetto":
       - Datalist selezionabile: LARGH_CASS, LS, LVT, TMV, LP, MIS_FIN_INF_L, LS+SRDX+SRSX
       - Permette sia selezione da dropdown che scrittura libera
    
    ‚úÖ MOTORI TAPPARELLE - Sistema Completo:
       - üè≠ MARCA: Somfy, Nice, Cherubini (datalist)
       - üì° MODELLO/Trasmettitore: Dinamico basato su marca
       - ‚ö° ALIMENTAZIONE: Radio Filare/Telecomando
       - üìª TRASMETTITORE: Solo se Telecomando
    
    ‚úÖ SOSTITUZIONE TAPPARELLE:
       - Radio: Solo Motore/Solo Tapparella/Entrambi
       - Campi intelligenti in base alla selezione
    
    ‚úÖ BREADCRUMB NAVIGATION:
       - Sostituita freccia con breadcrumb
       - Mostra: Progetti ‚Ä∫ Progetto ‚Ä∫ Posizione
    
    ‚ú® MODIFICHE FASE 10a (PRECEDENTE):
    ‚úÖ TUTTI I PRODOTTI - Campi Configurazione con Datalist:
       - INPUT + DATALIST: Permette sia selezione da dropdown che scrittura libera
       - INFISSO: Finitura Int/Est, Colore Int/Est, Tipo Anta, Telaio, Allarme, Vetro, Tagli Telaio
       - PERSIANA: Modello, Fissaggio, Tipo Telaio, Colore Persiana, Colore Telaio, Battuta
       - TAPPARELLA: Azienda, Modello, Colore, Manuale/Motorizzato, Sost. Esistente, Guida, Colore Guida
       - ZANZARIERA: Colore Telaio, Tipo Rete, Colore Rete
       - CASSONETTO: Tipo, Azienda, Colore, Sovrappi/Sostit, A Soffitto
    
    üí° FUNZIONAMENTO DATALIST:
    - Click sulla freccia dropdown ‚Üí Mostra opzioni predefinite dalla tabella globale
    - Scrittura diretta ‚Üí Accetta qualsiasi valore personalizzato
    - Suggerimenti mentre si digita ‚Üí Filtra le opzioni disponibili
    
    ‚ú® MODIFICHE FASE 9a-UPDATE (PRECEDENTE):
    ‚úÖ INFISSO - Tipo e Apertura aggiornati:
       - TIPO: F1, PF1, F2, PF2, F3, PF3, HST, FISSO + ‚úèÔ∏è ALTRO - SCRIVO
       - APERTURA: SX, DX, Fisso, Ribalta, Sp. SX, Sp. DX, SCORR.PARALL + ‚úèÔ∏è ALTRO - SCRIVO
       - Possibilit√† di scrivere custom e tornare a selezionare dal dropdown
    
    ‚úÖ PERSIANA - Tipo e Apertura aggiornati:
       - TIPO: FA, PFA, F2, PF2, F3, PF3, SCORREVOLE + ‚úèÔ∏è ALTRO - SCRIVO
       - APERTURA: SP SX, SP DX, LIB SX, LIB DX, SCORR SX, SCORR DX + ‚úèÔ∏è Altro SCRIVO
       - Campo input che appare quando si seleziona ALTRO - SCRIVO
       - Possibilit√† di tornare a selezionare dal dropdown
    
    ‚ú® MODIFICHE FASE 9a (RIORGANIZZAZIONE COMPLETA):
    ‚úÖ INFISSO: Riorganizzato con sezioni separate
       - üìã Dati Specifici: Quantit√†, Tipo, Apertura
       - ‚öôÔ∏è Configurazione: Finitura Int/Est, Colore Int/Est, Tipo Anta, Telaio, Allarme, Vetro, Tagli Telaio, Tipo Tagli
    
    ‚úÖ PERSIANA: Riorganizzata con sezioni separate + foto
       - üìã Dati Specifici: Quantit√†, Tipo, Apertura
       - ‚öôÔ∏è Configurazione: Modello, Fissaggio, Tipo Telaio, Colore Persiana, Colore Telaio, Battuta
       - üì∑ Foto Persiana: Upload e gestione foto
       - RISOLTO: Rimossa doppia selezione QT√Ä
    
    ‚úÖ TAPPARELLA: Riorganizzata con sezioni separate + motori dinamici
       - üìã Dati Specifici: Quantit√†
       - ‚öôÔ∏è Configurazione: Azienda, Modello, Colore, Manuale/Motorizzato, Sost. Esistente, Guida, Colore Guida
       - üîå Motori: Sezione dinamica con "+ Aggiungi Motore"
    
    ‚úÖ ZANZARIERA: Riorganizzata con tipo infisso associato
       - üîß Tipo Infisso Associato: Radio button F (Finestra) / PF (Porta Finestra)
       - ‚ö†Ô∏è Avviso: "Seleziona prima se F o PF"
       - üìã Dati Specifici: Quantit√†, Tipo, Apertura
       - ‚öôÔ∏è Configurazione: Colore Telaio, Tipo Rete, Colore Rete
    
    ‚úÖ CASSONETTO: Riorganizzato con misure dettagliate
       - üìã Dati Generali: Quantit√†, Tipo, Azienda, Colore, Sovrappi/Sostit, A Soffitto
       - üìè Misure Cassonetto (mm): LS, SRSX, ZSX, SRDX, ZDX, HCASS, B, C, BSuperiore
       - üìù Nota: "Se SRSX = ZSX ‚Üí Muro a SX | Se SRDX = ZDX ‚Üí Muro a DX"
    
    ‚ú® MODIFICHE FASE 31 (INTEGRAZIONE):
    ‚úÖ FOTO PERSIANE: Aggiunte funzioni per gestire foto specifiche delle persiane
       - addFotoPersiana: Aggiunge foto a una persiana specifica
       - removeFotoPersiana: Rimuove foto da una persiana specifica
    
    ‚úÖ MOTORI TAPPARELLE: Aggiunte funzioni per gestire motori delle tapparelle
       - addMotoreTapparella: Aggiunge un motore a una tapparella
       - updateMotoreTapparella: Aggiorna il modello di un motore
       - removeMotoreTapparella: Rimuove un motore da una tapparella
    
    ‚ú® MODIFICHE FASE 28:
    ‚úÖ INFISSI: Aggiunto campo QT√Ä selezionabile (1-10) come per le Persiane
       - Select dropdown per selezionare quantit√†
       - Default: 1
       - Visibile nella griglia dettagli infisso
    
    ‚úÖ PERSIANE TIPO: Aggiunte opzioni F1 e PF1
       - Lista completa: FA, PFA, F1, PF1, F2, PF2, F3, PF3, SCORREVOLE
       - Opzione "‚úèÔ∏è ALTRO - SCRIVO" per tipi personalizzati
    
    ‚úÖ LAYOUT OTTIMIZZATO:
       - Grid infissi: 4 colonne (QT√Ä + 6 campi)
       - Prima riga: QT√Ä, Azienda, Finitura Int, Finitura Est
       - Seconda riga: Colore Int, Colore Est, Tipo Anta
    
    MODIFICHE FASE 21 (PRECEDENTE):
    ‚úÖ CAMPO PIANO: Dropdown selezionabile con opzioni predefinite
       - Piano Seminterrato, Piano Terra, Piano Rialzato
       - Primo-Quinto Piano, Attico, Mansarda
    
    ‚úÖ CONFIG INFISSI: Rimossa sezione Motori (i motori vanno su tapparelle)
       - Mantiene tutti gli altri 10 campi
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG PERSIANE: Campi completi con dropdown
       - Tipo (Battente, Scorrevole, A libro, Orientabile)
       - Materiale (Alluminio, Legno, PVC, Alluminio-Legno)
       - Colore/Finitura (input libero)
       - Apertura (Interna, Esterna)
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG TAPPARELLE: Campi completi con MOTORI
       - Tipo (Standard, Blindata, Coibentata, Orientabile)
       - Materiale (PVC, Alluminio, Alluminio Coibentato, Acciaio)
       - Colore (input libero)
       - Comando (Manuale, Motorizzata)
       - Motori: Azienda (Somfy, Nice, Cherubini, Faac) + Modello
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG ZANZARIERE: Campi completi
       - Tipo (Avvolgibile, Pliss√©, Battente, Scorrevole, Fissa)
       - Colore Telaio (input libero)
       - Tipo Rete (Standard, Anti-polline, Pet-resistant, Micro-forata)
       - Colore Rete (Nero, Grigio, Bianco)
       - Formula BRM personalizzabile
    
    ‚úÖ CONFIG CASSONETTI: Campi completi
       - Tipo (Esterno, Incasso, Sopra-finestra, Semi-incasso)
       - Materiale (PVC, Alluminio, Alluminio Coibentato, Legno)
       - Finitura/Colore (input libero)
       - Coibentazione (Standard, Rinforzata, Acustica)
       - Formula BRM personalizzabile
    
    ‚úÖ QUANTIT√Ä NELLE POSIZIONI: Campo numerico
       - Default: 1
       - Modificabile per ogni posizione
       - Visibile nella griglia dettagli posizione
    
    ‚úÖ INIZIALIZZAZIONE AUTOMATICA: I prodotti ereditano i valori dalle config default
       - Quando aggiungi un prodotto, i campi sono pre-compilati
       - Puoi personalizzare ogni singolo prodotto
    
    ‚úÖ FUNZIONI UPDATE: Aggiunte per tutti i config
       - updateConfigPersiane
       - updateConfigTapparelle
       - updateConfigZanzariere
       - updateConfigCassonetti
    
    MODIFICHE FASE 20:
    ‚úÖ DROPDOWN PER FORMULA PERSONALIZZATA quando usaGlobale √® false
    ‚úÖ CALCOLO AUTOMATICO BRM con formula personalizzata
    ‚úÖ FIX ERRORI VARIABILI nei render delle tab prodotti
    
    MODIFICHE FASE 18B:
    ‚úÖ UN SOLO prodotto per tipo per posizione (no pi√π array)
    ‚úÖ Pulsante "Usa Globale" per BRM
    ‚úÖ Migrazione automatica dati
    ‚úÖ UI migliorata
-->
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Open Porte v3.0 - FASE 13: Rilievo Preesistente Globale üìã‚ú®üéØ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Inter', sans-serif;
        }
        body { 
            overscroll-behavior-y: contain;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        input, select, textarea { 
            font-size: 16px !important;
        }
        .compact-input {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        .step-indicator {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            transition: all 0.3s;
        }
        .step-indicator.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
        }
        .step-indicator.completed {
            background: #10b981;
            color: white;
        }
        .section-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1rem;
            box-shadow: 0 4px 6px rgba(0,0,0,0.07);
            transition: all 0.3s;
        }
        .section-card:hover {
            box-shadow: 0 8px 15px rgba(0,0,0,0.1);
        }
        .product-pill {
            padding: 0.5rem 1rem;
            border-radius: 9999px;
            border: 2px solid;
            transition: all 0.3s;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 500;
        }
        .product-pill.selected {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            background: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            z-index: 9999;
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .brm-calculator {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 2px solid #f59e0b;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        .brm-result {
            background: white;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-weight: bold;
            font-size: 0.875rem;
            color: #f59e0b;
            text-align: center;
            margin-top: 0.5rem;
        }
        
        /* üéØ FASE 18A - STILI VALIDAZIONE */
        .input-valid {
            border: 2px solid #10b981 !important;
            background: #f0fdf4 !important;
        }
        .input-warning {
            border: 2px solid #f59e0b !important;
            background: #fffbeb !important;
        }
        .input-error {
            border: 2px solid #ef4444 !important;
            background: #fef2f2 !important;
        }
        .validation-message {
            font-size: 0.75rem;
            margin-top: 0.25rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }
        .validation-message.error {
            color: #ef4444;
        }
        .validation-message.warning {
            color: #f59e0b;
        }
        .validation-message.success {
            color: #10b981;
        }
        /* üõ°Ô∏è OVERRIDE VALIDAZIONE MANUALE */
        .input-overridden {
            border: 2px solid #10b981 !important;
            background: #f0fdf4 !important;
        }
        .validation-override-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #10b981;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }
        .btn-override-confirm {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #10b981;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: 0.5rem;
            border: none;
            transition: all 0.2s;
        }
        .btn-override-confirm:hover {
            background: #059669;
            transform: scale(1.05);
        }
        .btn-override-cancel {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: #6b7280;
            color: white;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.7rem;
            font-weight: 600;
            cursor: pointer;
            margin-left: 0.5rem;
            border: none;
            transition: all 0.2s;
        }
        .btn-override-cancel:hover {
            background: #4b5563;
            transform: scale(1.05);
        }
        .validation-summary {
            position: sticky;
            top: 0;
            z-index: 10;
            margin-bottom: 1rem;
        }
        .pulse-error {
            animation: pulseRed 2s infinite;
        }
        @keyframes pulseRed {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); }
        }
        .product-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-bottom: 0.75rem;
            transition: all 0.3s;
        }
        .product-card:hover {
            border-color: #8b5cf6;
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.15);
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-weight: 500;
            transition: all 0.3s;
        }
        .tab-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        /* ============================================
           üçî MENU SISTEMA - FASE 021: MENU LATERALE
           ============================================ */

        :root {
            --menu-primary: #2563eb;
            --menu-header-bg: #1e40af;
            --menu-bg: #f8fafc;
            --menu-hover: #e2e8f0;
            --menu-text: #1e293b;
            --menu-text-sec: #64748b;
            --menu-border: #cbd5e1;
            --menu-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Header fisso compatto */
        .app-header {
            position: sticky;
            top: 0;
            left: 0;
            right: 0;
            height: 50px;
            background: var(--menu-header-bg);
            color: white;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 40;
            box-shadow: var(--menu-shadow);
        }

        /* Assicura che select/dropdown nativi siano sopra header */
        select:focus {
            position: relative;
            z-index: 50;
        }

        /* Container principale con padding per non andare sotto header */
        body {
            padding-top: 0;
        }

        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            padding: 8px;
            margin-right: 16px;
            transition: transform 0.2s;
        }

        .menu-toggle:hover {
            transform: scale(1.1);
        }

        .app-title {
            flex: 1;
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .btn-icon {
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 18px;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-icon:hover {
            background: rgba(255,255,255,0.2);
        }

        /* Menu laterale progetto */
        .side-menu-project {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: var(--menu-bg);
            box-shadow: var(--menu-shadow);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1100;
            overflow-y: auto;
        }

        .side-menu-project.open {
            left: 0;
        }

        .project-menu-header {
            min-height: 50px;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: var(--menu-header-bg);
            color: white;
            font-weight: bold;
        }

        .project-menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
            transition: transform 0.2s;
        }

        .project-menu-close:hover {
            transform: scale(1.1);
        }

        /* Info progetto */
        .project-info-box {
            padding: 16px;
            background: white;
            border-bottom: 2px solid var(--menu-border);
        }

        .project-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--menu-text);
            margin-bottom: 4px;
        }

        .project-ambiente {
            font-size: 14px;
            color: var(--menu-text-sec);
        }

        /* Navigazione menu */
        .nav-section {
            padding: 8px 0;
        }

        .nav-title {
            padding: 12px 16px 8px;
            font-size: 11px;
            font-weight: 600;
            color: var(--menu-text-sec);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            color: var(--menu-text);
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--menu-hover);
            border-left-color: var(--menu-primary);
        }

        .nav-item.active {
            background: rgba(37, 99, 235, 0.1);
            border-left-color: var(--menu-primary);
            color: var(--menu-primary);
            font-weight: 600;
        }

        .nav-item.disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        .nav-item.disabled:hover {
            background: transparent;
            border-left-color: transparent;
        }

        .nav-label {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-icon {
            font-size: 20px;
        }

        /* Submenu Config */
        .nav-submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.02);
        }

        .nav-submenu.open {
            max-height: 500px;
        }

        .nav-submenu-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 20px 12px 52px;
            color: var(--menu-text);
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-submenu-item:hover {
            background: var(--menu-hover);
        }

        .nav-submenu-item.active {
            background: rgba(37, 99, 235, 0.1);
            color: var(--menu-primary);
            font-weight: 600;
        }

        /* Indicatori completamento */
        .completion-badge {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .completion-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .completion-dot.green { background: #22c55e; }
        .completion-dot.yellow { background: #eab308; }
        .completion-dot.red { background: #ef4444; }

        .completion-percent {
            font-size: 11px;
            font-weight: 600;
            color: var(--menu-text-sec);
        }

        /* Azioni menu */
        .menu-actions {
            padding: 16px;
            border-top: 2px solid var(--menu-border);
            background: white;
        }

        .menu-action-btn {
            width: 100%;
            padding: 12px;
            margin-bottom: 8px;
            border: 1px solid var(--menu-border);
            background: white;
            color: var(--menu-text);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-action-btn:hover {
            background: var(--menu-hover);
            border-color: var(--menu-primary);
        }

        .menu-action-btn.primary {
            background: var(--menu-primary);
            color: white;
            border-color: var(--menu-primary);
        }

        .menu-action-btn.primary:hover {
            background: #1d4ed8;
        }

        /* Overlay */
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 1050;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }

        .menu-overlay.active {
            opacity: 1;
            pointer-events: all;
        }
        
        /* ===== MENU PRINCIPALE APPLICAZIONE ===== */
        .main-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: var(--menu-bg, #ffffff);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.15);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1100;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        .main-menu.open {
            left: 0;
        }
        
        .main-menu-header {
            min-height: 56px;
            display: flex;
            align-items: center;
            padding: 12px 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
        }
        
        .main-menu-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            margin-right: 12px;
            transition: transform 0.2s;
        }
        
        .main-menu-close:hover {
            transform: scale(1.1);
        }
        
        .main-menu-title {
            font-size: 14px;
            letter-spacing: 0.5px;
        }
        
        /* Search Bar */
        .main-menu-search {
            padding: 12px 16px;
            border-bottom: 1px solid #e5e5e5;
        }
        
        .search-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.2s;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        /* Main Navigation Section */
        .main-nav-section {
            flex: 1;
            padding: 8px 0;
        }
        
        .main-nav-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            color: #333;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .main-nav-item:hover {
            background: #f5f5f5;
            transform: translateX(5px);
        }
        
        .main-nav-item.expandable .main-nav-arrow {
            transition: transform 0.3s;
        }
        
        .main-nav-item.expanded .main-nav-arrow {
            transform: rotate(90deg);
        }
        
        .main-nav-label {
            display: flex;
            align-items: center;
            gap: 12px;
            flex: 1;
        }
        
        .main-nav-icon {
            font-size: 20px;
        }
        
        .main-nav-arrow {
            margin-left: auto;
            color: #999;
            font-size: 12px;
        }
        
        /* Submenu */
        .main-submenu {
            max-height: 0;
            overflow: hidden;
            background: #f8f8f8;
            transition: max-height 0.3s ease-out;
        }
        
        .main-submenu.open {
            max-height: 300px;
        }
        
        .main-submenu-item {
            padding: 12px 20px 12px 52px;
            color: #555;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }
        
        .main-submenu-item:hover {
            background: #e8e8e8;
            border-left-color: #667eea;
            color: #333;
        }
        
        /* Main Menu Overlay */
        .main-menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1050;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .main-menu-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        
        /* Quick Actions Bottom */
        .main-menu-bottom {
            padding: 16px;
            border-top: 2px solid #e5e5e5;
            background: white;
        }
        
        .quick-actions-title {
            font-size: 11px;
            font-weight: 600;
            color: #999;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 12px;
        }
        
        .quick-actions-grid {
            display: flex;
            gap: 8px;
            justify-content: space-around;
        }
        
        .quick-action-btn {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            border: 2px solid #e5e5e5;
            background: white;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .quick-action-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: transparent;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        /* Main content */
        .main-content {
            margin-top: 60px;
            padding: 20px;
            transition: margin-left 0.3s ease;
        }

        /* Responsive */
        @media (max-width: 767px) {
            .side-menu-project {
                width: 85%;
                max-width: 320px;
            }
        }

        @media (min-width: 1024px) {
            .header-actions {
                gap: 12px;
            }
            
            .btn-icon {
                padding: 10px 16px;
            }
        }

        /* ‚òÅÔ∏è FASE 022a: OneDrive Sync UI */
        .sync-badge {
            display: inline-block;
            margin-left: auto;
        }

        .sync-settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .sync-settings-dialog {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 500px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .sync-settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 2px solid #e2e8f0;
        }

        .sync-settings-header h3 {
            margin: 0;
            font-size: 20px;
            color: #1e293b;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #64748b;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.2s;
        }

        .close-btn:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .sync-account {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            margin: 20px;
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border-radius: 8px;
            border: 1px solid #bae6fd;
        }

        .sync-options {
            padding: 0 20px;
            margin: 20px 0;
        }

        .sync-options label {
            display: flex;
            align-items: center;
            padding: 12px 0;
            cursor: pointer;
            color: #1e293b;
            transition: color 0.2s;
        }

        .sync-options label:hover {
            color: #2563eb;
        }

        .sync-options input[type="checkbox"] {
            margin-right: 12px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .sync-actions {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            padding: 0 20px;
            margin: 20px 0;
        }

        .btn-sync {
            padding: 10px 16px;
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }

        .btn-sync:hover {
            background: #f8fafc;
            border-color: #2563eb;
            color: #2563eb;
        }

        .btn-sync:active {
            transform: scale(0.98);
        }

        .btn-primary {
            background: #2563eb;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary:hover {
            background: #1e40af;
        }

        .btn-secondary {
            background: white;
            color: #64748b;
            border: 1px solid #cbd5e1;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary:hover {
            background: #f1f5f9;
            color: #1e293b;
        }

        .sync-info {
            padding: 20px;
            background: #f8fafc;
            border-top: 1px solid #e2e8f0;
            font-size: 14px;
            color: #64748b;
        }

        .sync-info p {
            margin: 0 0 8px 0;
        }

        .sync-info strong {
            color: #1e293b;
        }

        .sync-info ul {
            margin: 8px 0;
        }

        .sync-info li {
            margin: 6px 0;
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body>
    <!-- üéØ FASE 021b: App container - tutto renderizzato dinamicamente -->
    <div id="app"></div>
    
    <script>
        // State Management
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null,
            currentPosition: null,
            setupStep: 1,
            showRiepilogoRilievi: false,  // Per mostrare il riepilogo rilievi
            sincronizzazioneVerificata: false,  // Flag per verifica sincronizzazione (1 volta per sessione)
            projectMenuOpen: false,  // ‚úÖ FASE 021: Menu laterale aperto/chiuso
            configMenuExpanded: false,  // ‚úÖ FASE 021: Submenu Config espanso/collassato
            mainMenuOpen: false,  // ‚úÖ FASE 023: Menu principale applicazione
            // ‚òÅÔ∏è FASE 022a: OneDrive Sync
            onedrive: {
                connected: false,
                userEmail: null,
                accessToken: null,
                refreshToken: null,
                tokenExpiry: null,
                lastSyncTime: null,
                syncStatus: 'disconnected', // disconnected|synced|syncing|error
                autoSyncEnabled: true,
                autoBackupEnabled: true,
                syncNotifications: true
            }
        };

        // ‚òÅÔ∏è FASE 022a: Configurazione OneDrive
        const ONEDRIVE_CONFIG = {
            // ‚úÖ CLIENT_ID configurato da Azure Portal
            // App: Open Porte OneDrive | Ricreata: 03/11/2025
            clientId: '43564a57-a8aa-4b5f-9e05-451c0375439b',
            authority: 'https://login.microsoftonline.com/common/oauth2/v2.0',
            redirectUri: 'https://openporte2025.github.io/',
            scopes: ['Files.ReadWrite', 'offline_access'],
            apiEndpoint: 'https://graph.microsoft.com/v1.0',
            folderPath: '/OpenPorte',
            fileName: 'data.json',
            autoSyncInterval: 5 * 60 * 1000  // 5 minuti
        };

        let syncInterval = null;  // Timer per sync automatica
        
        // ‚ö° FASE 024B: Sistema aggiornamenti parziali DOM (approccio cloud)
        // Invece di render() completo, aggiorniamo solo gli elementi necessari
        
        /**
         * ‚ö° FASE 024B: Tracking digitazione utente (per sync silenzioso)
         */
        let lastTypingTime = 0;
        const TYPING_TIMEOUT = 3000; // 3 secondi dopo ultima digitazione
        
        function markUserTyping() {
            lastTypingTime = Date.now();
        }
        
        function isUserTyping() {
            return (Date.now() - lastTypingTime) < TYPING_TIMEOUT;
        }
        
        /**
         * Aggiorna status sync visualizzato senza render completo
         */
        function updateSyncStatusDisplay(status) {
            // Aggiorna badge sync nel menu principale
            const syncBadges = document.querySelectorAll('[data-sync-status]');
            syncBadges.forEach(badge => {
                const statusMap = {
                    'syncing': { text: '‚Üª', class: 'text-blue-500 animate-spin' },
                    'synced': { text: '‚òÅ', class: 'text-green-500' },
                    'error': { text: '‚ö†', class: 'text-red-500' },
                    'disconnected': { text: '‚óã', class: 'text-gray-400' }
                };
                const config = statusMap[status] || statusMap['disconnected'];
                badge.textContent = config.text;
                badge.className = config.class;
            });
        }
        
        /**
         * Aggiorna un singolo campo DOM senza render completo
         */
        function updateDOMField(elementId, value) {
            const el = document.getElementById(elementId);
            if (el) {
                if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
                    el.value = value;
                } else {
                    el.textContent = value;
                }
            }
        }
        
        /**
         * Aggiorna i BRM visualizzati per un prodotto specifico
         */
        function updateBRMDisplay(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            const product = pos[productType];
            if (!product) return;
            
            // Aggiorna i campi BRM visualizzati
            updateDOMField(`brm-l-${posId}-${productType}`, product.BRM_L || '');
            updateDOMField(`brm-h-${posId}-${productType}`, product.BRM_H || '');
        }
        
        /**
         * Aggiorna indicatori completamento senza render
         */
        function updateCompletenessIndicators(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || !project.positions) return;
            
            project.positions.forEach(pos => {
                const comp = calculatePositionCompleteness(pos);
                const indicator = document.getElementById(`completeness-${pos.id}`);
                if (indicator) {
                    indicator.textContent = `${comp.percentage}%`;
                    indicator.className = comp.percentage === 100 
                        ? 'text-green-600 font-bold' 
                        : 'text-orange-600 font-bold';
                }
            });
        }

        // Load/Save Functions
        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) {
                try {
                    state = JSON.parse(saved);
                    migrateOldData(); // Migra dati vecchi formato array -> singolo oggetto
                    cleanNegativeValues(); // ‚úÖ NUOVO: Pulisce valori negativi nei BRM
                    migrateOldProjectsMetadata(); // ‚úÖ SOLUZIONE C: Migra progetti senza metadata
                    migrateOneDriveStructure(); // ‚òÅÔ∏è FASE 022a: Migra struttura OneDrive se mancante
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        // ‚òÅÔ∏è FASE 022a: Migrazione struttura OneDrive per backward compatibility
        function migrateOneDriveStructure() {
            // Se state.onedrive non esiste, crealo con valori default
            if (!state.onedrive) {
                console.log('üîÑ Migrazione: Aggiunta struttura OneDrive');
                state.onedrive = {
                    connected: false,
                    userEmail: null,
                    accessToken: null,
                    refreshToken: null,
                    tokenExpiry: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
                // Salva lo state migrato
                saveState();
            }
        }

        // ‚úÖ NUOVO: Funzione per pulire valori negativi nei BRM
        function cleanNegativeValues() {
            if (!state.projects) return;
            
            state.projects.forEach(project => {
                // Pulisci config globali
                const configs = ['brmConfigInfissi', 'brmConfigPersiane', 'brmConfigTapparelle', 
                                 'brmConfigZanzariere', 'brmConfigCassonetti'];
                
                configs.forEach(configKey => {
                    if (project[configKey]) {
                        ['valoreL', 'valoreH', 'valoreC', 'valoreB', 
                         'valoreL_PF', 'valoreH_PF'].forEach(field => {
                            if (project[configKey][field]) {
                                const val = parseFloat(project[configKey][field]);
                                if (!isNaN(val) && val < 0) {
                                    project[configKey][field] = Math.abs(val).toString();
                                }
                            }
                        });
                    }
                });
                
                // Pulisci BRM personalizzati nelle posizioni
                if (project.positions) {
                    project.positions.forEach(pos => {
                        ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(productType => {
                            const product = pos[productType];
                            if (product && product.brmPersonalizzato) {
                                ['valoreL', 'valoreH', 'valoreC', 'valoreB'].forEach(field => {
                                    if (product.brmPersonalizzato[field]) {
                                        const val = parseFloat(product.brmPersonalizzato[field]);
                                        if (!isNaN(val) && val < 0) {
                                            product.brmPersonalizzato[field] = Math.abs(val).toString();
                                        }
                                    }
                                });
                            }
                        });
                        
                        // üîß Inizializza BSuperiore nei cassonetti esistenti
                        if (pos.cassonetto) {
                            const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                                ? pos.caratteristicheMuroOverride 
                                : project.caratteristicheMuro || {};
                            
                            const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
                            
                            // ‚úÖ FASE 015: Se BSuperiore non esiste (undefined/null/''), inizializzalo
                            // NON sovrascrivere '0' esplicito dell'utente!
                            if (pos.cassonetto.BSuperiore === undefined || 
                                pos.cassonetto.BSuperiore === null || 
                                pos.cassonetto.BSuperiore === '') {
                                pos.cassonetto.BSuperiore = bSuperioreDefault;
                            }
                        }
                    });
                }
            });
        }

        // Migrazione dati da vecchio formato (array) a nuovo formato (oggetto singolo)
        function migrateOldData() {
            if (!state.projects) return;
            
            state.projects.forEach(project => {
                if (!project.positions) return;
                
                project.positions.forEach(pos => {
                    // Migra infissi
                    if (pos.infissi && Array.isArray(pos.infissi) && pos.infissi.length > 0) {
                        pos.infisso = pos.infissi[0]; // Prendi il primo
                        delete pos.infissi;
                    }
                    
                    // Migra persiane
                    if (pos.persiane && Array.isArray(pos.persiane) && pos.persiane.length > 0) {
                        pos.persiana = pos.persiane[0];
                        delete pos.persiane;
                    }
                    
                    // Migra tapparelle
                    if (pos.tapparelle && Array.isArray(pos.tapparelle) && pos.tapparelle.length > 0) {
                        pos.tapparella = pos.tapparelle[0];
                        delete pos.tapparelle;
                    }
                    
                    // Migra zanzariere
                    if (pos.zanzariere && Array.isArray(pos.zanzariere) && pos.zanzariere.length > 0) {
                        pos.zanzariera = pos.zanzariere[0];
                        delete pos.zanzariere;
                    }
                    
                    // Migra cassonetti
                    if (pos.cassonetti && Array.isArray(pos.cassonetti) && pos.cassonetti.length > 0) {
                        pos.cassonetto = pos.cassonetti[0];
                        delete pos.cassonetti;
                    }
                });
            });
            
            saveState(); // Salva i dati migrati
        }

        function saveState() {
            // ‚òÅÔ∏è FASE 022a: Aggiorna metadata modifiche
            if (!state.metadata) {
                state.metadata = {};
            }
            state.metadata.lastModified = Date.now();
            state.metadata.appVersion = '3.5.022af';
            
            // ‚òÅÔ∏è FASE 022a: Assicurati che onedrive structure esista
            if (!state.onedrive) {
                state.onedrive = {
                    connected: false,
                    userEmail: null,
                    accessToken: null,
                    refreshToken: null,
                    tokenExpiry: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
            }
            
            localStorage.setItem('openPorteData', JSON.stringify(state));
            
            // ‚òÅÔ∏è FASE 022a: Auto-backup su OneDrive (debounced)
            // Solo se connesso, auto-backup abilitato e non gi√† in sync
            if (state.onedrive && state.onedrive.connected && 
                state.onedrive.autoBackupEnabled && 
                state.onedrive.syncStatus !== 'syncing') {
                
                // Debounce: aspetta 2 secondi di inattivit√† prima di sync
                clearTimeout(window.onedriveSyncDebounce);
                window.onedriveSyncDebounce = setTimeout(() => {
                    uploadToOneDrive();
                }, 2000);
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚ö° FASE 024C: SISTEMA UNIVERSALE TOGGLE SELECT/INPUT
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        /**
         * Toggle universale tra select e input per qualsiasi campo
         * @param {string} fieldId - ID base del campo (es. 'azienda', 'coloreInt')
         * @param {string} context - Contesto univoco (es. 'infisso-proj123', 'pos456')
         */
        window.toggleFieldMode = (fieldId, context) => {
            const selectEl = document.getElementById(`${fieldId}-select-${context}`);
            const inputEl = document.getElementById(`${fieldId}-input-${context}`);
            const btnEl = document.getElementById(`${fieldId}-toggle-${context}`);
            
            if (!selectEl || !inputEl) return;
            
            if (selectEl.style.display === 'none') {
                // Torna a SELECT
                selectEl.style.display = 'block';
                inputEl.style.display = 'none';
                if (btnEl) btnEl.innerHTML = '‚úèÔ∏è Scrivi manualmente';
                
                // Trasferisci valore da input a select se presente
                if (inputEl.value && inputEl.value.trim() !== '') {
                    // Se il valore non √® nelle opzioni, aggiungilo temporaneamente
                    const existingOption = Array.from(selectEl.options).find(opt => opt.value === inputEl.value);
                    if (!existingOption) {
                        const newOption = document.createElement('option');
                        newOption.value = inputEl.value;
                        newOption.text = inputEl.value;
                        newOption.selected = true;
                        selectEl.appendChild(newOption);
                    } else {
                        selectEl.value = inputEl.value;
                    }
                }
            } else {
                // Passa a INPUT
                selectEl.style.display = 'none';
                inputEl.style.display = 'block';
                if (btnEl) btnEl.innerHTML = 'üìã Torna a selezione';
                
                // Trasferisci valore da select a input
                if (selectEl.value && selectEl.value !== '') {
                    inputEl.value = selectEl.value;
                }
                inputEl.focus();
            }
        };
        
        /**
         * Genera HTML per campo con toggle select/input
         * @param {Object} config - Configurazione campo
         * @returns {string} HTML completo del campo
         */
        function renderFieldWithToggle(config) {
            const {
                fieldId,           // 'azienda', 'coloreInt', ecc.
                context,           // 'infisso-proj123' o 'pos456'
                label,             // 'Azienda'
                currentValue,      // Valore corrente
                options,           // Array opzioni ['Oknoplast', 'Finstral', ...]
                updateFunction,    // Nome funzione da chiamare (es. 'updateConfigInfissi')
                updateParams,      // Parametri per la funzione update
                required = false   // Se il campo √® obbligatorio
            } = config;
            
            const isEmpty = !currentValue || currentValue === '';
            const borderClass = required && isEmpty ? 'border-red-300 bg-red-50' : 'border-gray-300 bg-white';
            const statusIcon = required ? (isEmpty ? '<span class="text-red-600">‚óè</span>' : '<span class="text-green-600">‚úì</span>') : '';
            
            // Costruisci parametri per update function
            const updateCall = `${updateFunction}(${updateParams.map(p => `'${p}'`).join(', ')}, this.value)`;
            
            return `
                <div class="mb-3">
                    <div class="flex items-center justify-between mb-1">
                        <label class="text-sm font-semibold flex items-center gap-2">
                            ${label}
                            ${statusIcon}
                        </label>
                        <button onclick="toggleFieldMode('${fieldId}', '${context}')" 
                                id="${fieldId}-toggle-${context}"
                                class="text-xs bg-gray-200 hover:bg-gray-300 px-3 py-1 rounded-full font-medium transition">
                            ‚úèÔ∏è Scrivi manualmente
                        </button>
                    </div>
                    
                    <!-- SELECT MODE (default) -->
                    <select id="${fieldId}-select-${context}"
                            onchange="${updateCall}"
                            class="w-full px-3 py-2 border-2 ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                            style="display: block;">
                        <option value="">Seleziona...</option>
                        ${options.map(opt => `<option value="${opt}" ${currentValue === opt ? 'selected' : ''}>${opt}</option>`).join('')}
                    </select>
                    
                    <!-- INPUT MODE (hidden) -->
                    <input type="text" 
                           id="${fieldId}-input-${context}"
                           value="${currentValue || ''}"
                           oninput="${updateCall}"
                           placeholder="Scrivi ${label.toLowerCase()}..."
                           class="w-full px-3 py-2 border-2 ${borderClass} rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                           style="display: none;">
                </div>
            `;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéØ SELECT CON CUSTOM INPUT - FASE 020
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Handler globale per gestire il cambio tra select e custom input
        window.handleSelectCustomChange = (fieldName, selectElement, projectId, posId, productType) => {
            const value = selectElement.value;
            const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
            const customInput = document.getElementById(customInputId);
            
            if (value === '__custom__') {
                // Mostra input custom
                if (customInput) {
                    customInput.style.display = 'block';
                    customInput.focus();
                }
            } else if (value !== '') {
                // Nascondi input custom
                if (customInput) {
                    customInput.style.display = 'none';
                    customInput.value = '';
                }
                
                // ‚ö° RITARDA il render per permettere al select di chiudersi naturalmente
                setTimeout(() => {
                    // Chiama il callback appropriato in base al contesto
                    if (posId && productType) {
                        // √à una posizione
                        updateProduct(projectId, posId, productType, fieldName, value);
                    } else {
                        // √à config globale o rilievo globale
                        if (productType === 'infisso') {
                            updateConfigInfissi(projectId, fieldName, value);
                        } else if (productType === 'persiana') {
                            updateConfigPersiane(projectId, fieldName, value);
                        } else if (productType === 'tapparella') {
                            updateConfigTapparelle(projectId, fieldName, value);
                        } else if (productType === 'zanzariera') {
                            updateConfigZanzariere(projectId, fieldName, value);
                        } else if (productType === 'cassonetto') {
                            updateConfigCassonetti(projectId, fieldName, value);
                        } else if (productType === 'infissi' || productType === 'persiane' || productType === 'tapparelle' || productType === 'zanzariere' || productType === 'cassonetti') {
                            // Rilievo Globale (productType plurale)
                            updateRilievoGlobale(projectId, productType, fieldName, value);
                        }
                    }
                }, 50); // 50ms di delay
            }
        };
        
        // Funzione per renderizzare select con opzione custom
        function renderSelectWithCustom(fieldName, currentValue, options, projectId, posId, productType, label) {
            // Determina se il valore corrente √® custom (non nella lista)
            const isCustom = currentValue && currentValue !== '' && !options.includes(currentValue);
            const selectedValue = isCustom ? '__custom__' : (currentValue || '');
            const isEmpty = !currentValue || currentValue === '';
            
            // ID univoco per l'input custom
            const customInputId = `${fieldName}_custom_${projectId || 'global'}_${posId || 'config'}_${productType || 'infisso'}`;
            
            return `
                <div class="mb-2">
                    ${label ? `<label class="block text-base font-bold mb-1 text-gray-800">${label}</label>` : ''}
                    
                    <!-- Select principale -->
                    <select 
                        class="w-full px-3 py-2.5 border-2 rounded-lg text-base font-medium ${isEmpty ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500 focus:border-purple-500" 
                        onchange="handleSelectCustomChange('${fieldName}', this, '${projectId}', '${posId || ''}', '${productType}')"
                    >
                        <option value="" class="text-gray-400">‚ñº Seleziona...</option>
                        ${options.map(opt => `
                            <option value="${opt}" ${selectedValue === opt ? 'selected' : ''} class="text-gray-900 font-medium">
                                ${opt}
                            </option>
                        `).join('')}
                        <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">
                            üñäÔ∏è Scrivi manualmente
                        </option>
                    </select>
                    
                    <!-- Input custom (nascosto se non serve) -->
                    <input 
                        type="text" 
                        class="w-full px-3 py-2.5 border-2 border-blue-400 rounded-lg mt-2 text-base font-medium bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                        id="${customInputId}"
                        placeholder="‚úèÔ∏è Scrivi valore personalizzato..."
                        value="${isCustom ? currentValue : ''}"
                        style="display: ${isCustom ? 'block' : 'none'};"
                        onchange="${posId ? `updateProduct('${projectId}', '${posId}', '${productType}', '${fieldName}', this.value)` : 
                                  productType === 'infisso' ? `updateConfigInfissi('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'persiana' ? `updateConfigPersiane('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'tapparella' ? `updateConfigTapparelle('${projectId}', '${fieldName}', this.value)` :
                                  productType === 'zanzariera' ? `updateConfigZanzariere('${projectId}', '${fieldName}', this.value)` :
                                  `updateConfigCassonetti('${projectId}', '${fieldName}', this.value)`}"
                    />
                </div>
            `;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéØ SOLUZIONE C: SISTEMA ANTI-DUPLICATI ENTERPRISE (Chat 010)
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 1: DEVICE IDENTIFICATION
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        
        function getDeviceId() {
            // Ottiene o crea ID univoco dispositivo
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + generateId();
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        function getDeviceName() {
            // Ottiene o rileva nome dispositivo
            let deviceName = localStorage.getItem('deviceName');
            if (!deviceName) {
                deviceName = detectDeviceName();
                // Permetti modifica nome
                const customName = localStorage.getItem('customDeviceName');
                if (customName) deviceName = customName;
                localStorage.setItem('deviceName', deviceName);
            }
            return deviceName;
        }

        function detectDeviceName() {
            // Rileva tipo dispositivo automaticamente
            const ua = navigator.userAgent;
            
            if (/iPad/i.test(ua)) return 'Tablet iPad';
            if (/iPhone/i.test(ua)) return 'Smartphone iPhone';
            if (/Android/i.test(ua)) {
                if (/Mobile/i.test(ua)) return 'Smartphone Android';
                return 'Tablet Android';
            }
            if (/Windows/i.test(ua)) return 'PC Windows';
            if (/Mac/i.test(ua)) return 'PC Mac';
            if (/Linux/i.test(ua)) return 'PC Linux';
            
            return 'Dispositivo Sconosciuto';
        }

        function setCustomDeviceName(name) {
            // Permette utente di personalizzare nome dispositivo
            localStorage.setItem('customDeviceName', name);
            localStorage.setItem('deviceName', name);
            showNotification(`‚úÖ Nome dispositivo impostato: ${name}`, 'success');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 2: METADATA & VERSIONING
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function initMetadata() {
            // Inizializza metadata per nuovo progetto
            return {
                createdAt: new Date().toISOString(),
                lastModified: new Date().toISOString(),
                version: "1.0",
                deviceId: getDeviceId(),
                deviceName: getDeviceName(),
                syncStatus: "local",  // local | synced | conflict
                history: [{
                    timestamp: new Date().toISOString(),
                    device: getDeviceName(),
                    deviceId: getDeviceId(),
                    action: "created",
                    changes: "Progetto creato"
                }]
            };
        }

        function updateProjectTimestamp(projectId, action, changes) {
            // Auto-aggiorna timestamp e history ad ogni modifica
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Inizializza metadata se non esiste (backward compatibility)
            if (!project.metadata) {
                project.metadata = initMetadata();
                project.metadata.createdAt = project.createdDate || new Date().toISOString();
            }
            
            // Aggiorna timestamp
            project.metadata.lastModified = new Date().toISOString();
            
            // Incrementa versione
            project.metadata.version = incrementVersion(project.metadata.version);
            
            // Aggiorna status
            project.metadata.syncStatus = "local";
            
            // Aggiungi a history
            project.metadata.history.push({
                timestamp: new Date().toISOString(),
                device: getDeviceName(),
                deviceId: getDeviceId(),
                action: action,
                changes: changes
            });
            
            // Limita history a ultimi 50 entries
            if (project.metadata.history.length > 50) {
                project.metadata.history = project.metadata.history.slice(-50);
            }
            
            saveState();
        }

        function incrementVersion(currentVersion) {
            // Incrementa numero versione (1.0 ‚Üí 1.1 ‚Üí 1.2 ... ‚Üí 2.0)
            const [major, minor] = currentVersion.split('.').map(Number);
            const newMinor = minor + 1;
            
            if (newMinor >= 10) {
                return `${major + 1}.0`;
            }
            return `${major}.${newMinor}`;
        }

        function migrateOldProjectsMetadata() {
            // Migra progetti vecchi senza metadata
            let migrated = 0;
            
            state.projects.forEach(project => {
                if (!project.metadata) {
                    project.metadata = initMetadata();
                    // Usa date esistenti se disponibili
                    if (project.createdDate) {
                        project.metadata.createdAt = project.createdDate;
                    }
                    migrated++;
                }
            });
            
            if (migrated > 0) {
                saveState();
                console.log(`‚úÖ Migrati ${migrated} progetti con metadata`);
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 3: IMPORT JSON
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function importProjectsJSON() {
            // Crea input file nascosto
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                showNotification('üì• Lettura file in corso...', 'info');
                
                try {
                    const text = await file.text();
                    const data = JSON.parse(text);
                    
                    // Valida struttura
                    if (!validateImportJSON(data)) {
                        showNotification('‚ùå File JSON non valido', 'error');
                        return;
                    }
                    
                    // Processa import
                    await processImport(data);
                    
                } catch (error) {
                    console.error('Errore import:', error);
                    showNotification('‚ùå Errore durante import: ' + error.message, 'error');
                }
            };
            
            input.click();
        }

        function validateImportJSON(data) {
            // Valida struttura JSON importato
            if (!data || typeof data !== 'object') return false;
            
            // Accetta sia formato singolo progetto che array progetti
            if (Array.isArray(data.projects)) {
                // Formato export multiplo
                return data.projects.every(p => p.id && p.name);
            } else if (data.id && data.name) {
                // Formato singolo progetto
                return true;
            }
            
            return false;
        }

        async function processImport(data) {
            // Processa l'import con gestione duplicati
            
            // Converti in array se singolo progetto
            let importedProjects = Array.isArray(data.projects) ? data.projects : [data];
            
            showNotification(`üìä Analisi ${importedProjects.length} progetti...`, 'info');
            
            // Rileva duplicati
            const analysis = detectDuplicates(importedProjects);
            
            // Mostra preview
            const proceed = await showImportPreview(analysis);
            if (!proceed) return;
            
            // Crea backup pre-import
            createBackup(`Pre-import: ${importedProjects.length} progetti`);
            
            // Processa progetti nuovi (facile)
            analysis.newProjects.forEach(project => {
                state.projects.push(project);
            });
            
            // Processa conflitti (complesso)
            for (const conflict of analysis.conflicts) {
                const resolution = await resolveConflict(conflict);
                applyConflictResolution(conflict, resolution);
            }
            
            // Salva e aggiorna
            saveState();
            render();
            
            // Notifica risultato
            const replacedCount = analysis.conflicts.filter(c => c.resolution === 'replace').length;
            const keptCount = analysis.conflicts.filter(c => c.resolution === 'keep').length;
            
            showNotification(
                `‚úÖ Import completato!\nNuovi: ${analysis.newProjects.length} | Aggiornati: ${replacedCount} | Mantenuti: ${keptCount}`,
                'success'
            );
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 4: RILEVAMENTO DUPLICATI
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function detectDuplicates(importedProjects) {
            // Analizza e classifica progetti importati
            const results = {
                newProjects: [],      // Mai visti prima
                existingProjects: [], // Identici, nessun conflitto
                conflicts: []         // Stessi ma diversi
            };
            
            importedProjects.forEach(imported => {
                const existing = state.projects.find(p => p.id === imported.id);
                
                if (!existing) {
                    // Progetto nuovo
                    results.newProjects.push(imported);
                } else {
                    // Progetto esistente - confronta versioni
                    const comparison = compareProjects(existing, imported);
                    
                    if (comparison.identical) {
                        // Identici, nessun conflitto
                        results.existingProjects.push({
                            imported: imported,
                            existing: existing
                        });
                    } else {
                        // Diversi, conflitto!
                        results.conflicts.push({
                            imported: imported,
                            existing: existing,
                            comparison: comparison
                        });
                    }
                }
            });
            
            return results;
        }

        function compareProjects(project1, project2) {
            // Confronta due progetti in dettaglio
            const result = {
                identical: false,
                newerProject: null,  // 'project1' | 'project2' | null
                differences: {
                    positions: false,
                    products: false,
                    caratteristiche: false,
                    clientData: false
                },
                timestamps: {
                    project1: project1.metadata?.lastModified || null,
                    project2: project2.metadata?.lastModified || null
                }
            };
            
            // Confronta timestamp
            const ts1 = new Date(project1.metadata?.lastModified || 0);
            const ts2 = new Date(project2.metadata?.lastModified || 0);
            
            if (ts1 > ts2) {
                result.newerProject = 'project1';
            } else if (ts2 > ts1) {
                result.newerProject = 'project2';
            }
            
            // Confronta contenuti
            if (project1.positions?.length !== project2.positions?.length) {
                result.differences.positions = true;
            }
            
            if (JSON.stringify(project1.prodotti) !== JSON.stringify(project2.prodotti)) {
                result.differences.products = true;
            }
            
            if (JSON.stringify(project1.caratteristicheMuro) !== JSON.stringify(project2.caratteristicheMuro)) {
                result.differences.caratteristiche = true;
            }
            
            if (project1.name !== project2.name || project1.client !== project2.client) {
                result.differences.clientData = true;
            }
            
            // Determina se identici
            result.identical = !Object.values(result.differences).some(d => d);
            
            return result;
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ 
        // üìã SEZIONE 5: GESTIONE CONFLITTI
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function resolveConflict(conflict) {
            // Mostra dialog e ottiene scelta utente
            return new Promise((resolve) => {
                showConflictDialog(conflict, resolve);
            });
        }

        function showConflictDialog(conflict, callback) {
            // Crea e mostra dialog modale conflitto
            const { imported, existing, comparison } = conflict;
            
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
            modal.style.position = 'fixed';
            modal.style.top = '0';
            modal.style.left = '0';
            modal.style.right = '0';
            modal.style.bottom = '0';
            
            modal.innerHTML = `
                <div class="bg-white rounded-xl shadow-2xl max-w-2xl w-full max-h-[90vh] overflow-auto">
                    <div class="p-6">
                        <h2 class="text-2xl font-bold mb-4 text-red-600">
                            ‚ö†Ô∏è Conflitto Rilevato
                        </h2>
                        
                        <div class="mb-4">
                            <p class="font-semibold text-lg">${existing.name}</p>
                            <p class="text-gray-600">${existing.client || 'Nessun cliente'}</p>
                            <p class="text-sm text-gray-500">ID: ${existing.id}</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 mb-6 border rounded-lg p-4">
                            <div class="border-r pr-4">
                                <h3 class="font-bold mb-2 text-blue-600">üì± LOCALE</h3>
                                <p class="text-sm"><strong>Data:</strong> ${formatDate(comparison.timestamps.project1)}</p>
                                <p class="text-sm"><strong>Dispositivo:</strong> ${existing.metadata?.deviceName || 'Sconosciuto'}</p>
                                <p class="text-sm"><strong>Posizioni:</strong> ${existing.positions?.length || 0}</p>
                                <p class="text-sm"><strong>Versione:</strong> ${existing.metadata?.version || '1.0'}</p>
                                ${comparison.newerProject === 'project1' ? '<p class="text-green-600 font-bold mt-2">‚≠ê Pi√π recente</p>' : ''}
                            </div>
                            
                            <div class="pl-4">
                                <h3 class="font-bold mb-2 text-purple-600">üì• IMPORTATO</h3>
                                <p class="text-sm"><strong>Data:</strong> ${formatDate(comparison.timestamps.project2)}</p>
                                <p class="text-sm"><strong>Dispositivo:</strong> ${imported.metadata?.deviceName || 'Sconosciuto'}</p>
                                <p class="text-sm"><strong>Posizioni:</strong> ${imported.positions?.length || 0}</p>
                                <p class="text-sm"><strong>Versione:</strong> ${imported.metadata?.version || '1.0'}</p>
                                ${comparison.newerProject === 'project2' ? '<p class="text-green-600 font-bold mt-2">‚≠ê Pi√π recente</p>' : ''}
                            </div>
                        </div>
                        
                        ${renderDifferences(comparison.differences)}
                        
                        <div class="space-y-3 mb-6">
                            <p class="font-semibold">Cosa vuoi fare?</p>
                            
                            <label class="flex items-center p-3 border-2 border-purple-300 bg-purple-50 rounded-lg cursor-pointer hover:bg-purple-100">
                                <input type="radio" name="resolution" value="merge" class="mr-3" checked>
                                <div>
                                    <p class="font-semibold text-purple-700">üîÄ Unisci (MERGE) - CONSIGLIATO</p>
                                    <p class="text-sm text-gray-700">Combina entrambe le versioni senza perdere dati</p>
                                    <p class="text-xs text-purple-600 mt-1">‚úì Preserva tutte le posizioni di entrambe le versioni</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-blue-50">
                                <input type="radio" name="resolution" value="replace" class="mr-3">
                                <div>
                                    <p class="font-semibold">Sostituisci con versione importata</p>
                                    <p class="text-sm text-gray-600">La versione locale sar√† sovrascritta</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-green-50">
                                <input type="radio" name="resolution" value="keep" class="mr-3">
                                <div>
                                    <p class="font-semibold">Mantieni versione locale</p>
                                    <p class="text-sm text-gray-600">La versione importata sar√† ignorata</p>
                                </div>
                            </label>
                            
                            <label class="flex items-center p-3 border rounded-lg cursor-pointer hover:bg-purple-50">
                                <input type="radio" name="resolution" value="duplicate" class="mr-3">
                                <div>
                                    <p class="font-semibold">Crea nuovo progetto (duplica)</p>
                                    <p class="text-sm text-gray-600">Mantieni entrambe le versioni come progetti separati</p>
                                </div>
                            </label>
                        </div>
                        
                        <div class="flex gap-3">
                            <button onclick="window.closeConflictDialog('cancel')" 
                                    class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="window.closeConflictDialog('apply')" 
                                    class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                Applica
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Funzione per chiudere dialog
            window.closeConflictDialog = (action) => {
                if (action === 'apply') {
                    const selected = document.querySelector('input[name="resolution"]:checked');
                    const resolution = selected ? selected.value : 'keep';
                    conflict.resolution = resolution; // Salva per stats
                    callback(resolution);
                } else {
                    callback('cancel');
                }
                document.body.removeChild(modal);
                delete window.closeConflictDialog;
            };
        }

        function renderDifferences(differences) {
            // Renderizza elenco differenze trovate
            const diffs = [];
            if (differences.positions) diffs.push('Numero posizioni diverso');
            if (differences.products) diffs.push('Prodotti selezionati diversi');
            if (differences.caratteristiche) diffs.push('Caratteristiche muro diverse');
            if (differences.clientData) diffs.push('Dati cliente diversi');
            
            if (diffs.length === 0) {
                return '<p class="text-sm text-gray-600 mb-4">‚ö†Ô∏è Stesso ID ma versioni diverse</p>';
            }
            
            return `
                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-lg">
                    <p class="font-semibold text-sm mb-2">Differenze rilevate:</p>
                    <ul class="text-sm space-y-1">
                        ${diffs.map(d => `<li>‚Ä¢ ${d}</li>`).join('')}
                    </ul>
                </div>
            `;
        }

        // üÜï FASE 027: MERGE INTELLIGENTE PROGETTI
        function mergeProjects(local, remote) {
            // Unisce due versioni dello stesso progetto preservando tutti i dati
            console.log('üîÄ MERGE progetti:', local.name);
            console.log('  üì± Locale:', local.positions?.length || 0, 'posizioni');
            console.log('  ‚òÅÔ∏è Remote:', remote.positions?.length || 0, 'posizioni');
            
            // Base: parte dalla versione pi√π recente
            const localTime = new Date(local.metadata?.lastModified || 0);
            const remoteTime = new Date(remote.metadata?.lastModified || 0);
            const base = localTime > remoteTime ? {...local} : {...remote};
            
            // Merge posizioni (il pi√π importante!)
            const mergedPositions = mergePositions(
                local.positions || [], 
                remote.positions || []
            );
            
            base.positions = mergedPositions;
            
            // Aggiorna metadata
            if (!base.metadata) base.metadata = {};
            base.metadata.lastModified = new Date().toISOString();
            base.metadata.mergeCount = (base.metadata.mergeCount || 0) + 1;
            base.metadata.lastMerge = {
                localPositions: local.positions?.length || 0,
                remotePositions: remote.positions?.length || 0,
                mergedPositions: mergedPositions.length,
                timestamp: new Date().toISOString()
            };
            
            console.log('  ‚úÖ Merge completato:', mergedPositions.length, 'posizioni totali');
            
            return base;
        }

        function mergePositions(localPositions, remotePositions) {
            // Unisce array di posizioni senza perdere nulla
            const merged = [];
            const processedIds = new Set();
            
            // Map per accesso rapido
            const localMap = new Map(localPositions.map(p => [p.id, p]));
            const remoteMap = new Map(remotePositions.map(p => [p.id, p]));
            
            // 1. Processa posizioni locali
            localPositions.forEach(localPos => {
                const remotePos = remoteMap.get(localPos.id);
                
                if (!remotePos) {
                    // Posizione solo locale ‚Üí mantieni
                    merged.push(localPos);
                } else {
                    // Posizione in entrambi ‚Üí prendi pi√π recente o merge campi
                    const localTime = new Date(localPos.metadata?.lastModified || 0);
                    const remoteTime = new Date(remotePos.metadata?.lastModified || 0);
                    
                    merged.push(localTime >= remoteTime ? localPos : remotePos);
                }
                
                processedIds.add(localPos.id);
            });
            
            // 2. Aggiungi posizioni solo remote (non ancora processate)
            remotePositions.forEach(remotePos => {
                if (!processedIds.has(remotePos.id)) {
                    merged.push(remotePos);
                }
            });
            
            return merged;
        }

        // üÜï FASE 027: MERGE ONEDRIVE DATA
        async function mergeOneDriveData(cloudData) {
            // Analizza e unisce dati OneDrive con locali
            console.log('‚òÅÔ∏è MERGE OneDrive: inizio analisi');
            console.log('  üì± Progetti locali:', state.projects.length);
            console.log('  ‚òÅÔ∏è Progetti cloud:', cloudData.projects?.length || 0);
            
            const result = {
                hasConflicts: false,
                conflicts: [],
                newProjects: [],
                identicalProjects: []
            };
            
            const cloudProjects = cloudData.projects || [];
            
            cloudProjects.forEach(cloudProject => {
                const localProject = state.projects.find(p => p.id === cloudProject.id);
                
                if (!localProject) {
                    // Progetto solo su cloud ‚Üí aggiungi
                    console.log('  ‚ûï Nuovo da cloud:', cloudProject.name);
                    result.newProjects.push(cloudProject);
                } else {
                    // Progetto esiste in entrambi ‚Üí confronta
                    const comparison = compareProjects(localProject, cloudProject);
                    
                    if (comparison.identical) {
                        // Identici ‚Üí nessun conflitto
                        console.log('  ‚úÖ Identico:', cloudProject.name);
                        result.identicalProjects.push(cloudProject);
                    } else {
                        // Diversi ‚Üí conflitto!
                        console.log('  ‚ö†Ô∏è Conflitto:', cloudProject.name);
                        result.hasConflicts = true;
                        result.conflicts.push({
                            imported: cloudProject,
                            existing: localProject,
                            comparison: comparison
                        });
                    }
                }
            });
            
            console.log('‚òÅÔ∏è MERGE OneDrive: analisi completata');
            console.log('  ‚ûï Nuovi:', result.newProjects.length);
            console.log('  ‚ö†Ô∏è Conflitti:', result.conflicts.length);
            console.log('  ‚úÖ Identici:', result.identicalProjects.length);
            
            return result;
        }

        // üö® FASE 027B: Determina se conflitto √® auto-mergeable
        function isAutoMergeable(conflict) {
            // Auto-merge se SOLO differenza numero posizioni
            // Chiedi utente se ci sono altre differenze (prodotti, caratteristiche, client)
            const { comparison } = conflict;
            const diffs = comparison.differences;
            
            // Se solo posizioni diverse ‚Üí AUTO-MERGE sicuro
            if (diffs.positions && !diffs.products && !diffs.caratteristiche && !diffs.clientData) {
                console.log('  üîÄ Auto-mergeable: solo posizioni diverse');
                return true;
            }
            
            // Altrimenti chiedi
            console.log('  ‚ùì Non auto-mergeable: altre differenze', diffs);
            return false;
        }

        function applyConflictResolution(conflict, resolution) {
            // Applica la risoluzione scelta dall'utente
            const { imported, existing } = conflict;
            const existingIndex = state.projects.findIndex(p => p.id === existing.id);
            
            switch (resolution) {
                case 'replace':
                    // Sostituisci locale con importato
                    if (imported.metadata) {
                        imported.metadata.syncStatus = 'synced';
                    }
                    state.projects[existingIndex] = imported;
                    break;
                    
                case 'keep':
                    // Mantieni locale, ignora importato
                    if (existing.metadata) {
                        existing.metadata.syncStatus = 'synced';
                    }
                    // Non fare nulla
                    break;
                    
                case 'merge':
                    // üÜï FASE 027: MERGE INTELLIGENTE - Unisce posizioni senza perdere nulla
                    const merged = mergeProjects(existing, imported);
                    if (merged.metadata) {
                        merged.metadata.syncStatus = 'synced';
                    }
                    state.projects[existingIndex] = merged;
                    break;
                    
                case 'duplicate':
                    // Crea nuovo ID per importato e aggiungi
                    imported.id = generateId();
                    imported.name = imported.name + ' (importato)';
                    if (imported.metadata) {
                        imported.metadata.syncStatus = 'local';
                    }
                    state.projects.push(imported);
                    break;
                    
                case 'cancel':
                    // Non fare nulla
                    break;
            }
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 6: BACKUP SYSTEM
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        function createBackup(reason) {
            // Crea backup completo stato corrente
            const backup = {
                id: `backup_${Date.now()}`,
                timestamp: new Date().toISOString(),
                reason: reason || 'Backup manuale',
                projects: JSON.parse(JSON.stringify(state.projects)),
                count: state.projects.length,
                deviceName: getDeviceName()
            };
            
            const backups = getBackups();
            backups.push(backup);
            
            // Mantieni solo ultimi 10 backup
            if (backups.length > 10) {
                backups.shift();
            }
            
            localStorage.setItem('openPorteBackups', JSON.stringify(backups));
            
            console.log(`üíæ Backup creato: ${backup.id}`);
            return backup.id;
        }

        function getBackups() {
            // Ottiene lista backup
            const stored = localStorage.getItem('openPorteBackups');
            return stored ? JSON.parse(stored) : [];
        }

        function restoreBackup(backupId) {
            // Ripristina backup specifico
            const backups = getBackups();
            const backup = backups.find(b => b.id === backupId);
            
            if (!backup) {
                showNotification('‚ùå Backup non trovato', 'error');
                return false;
            }
            
            if (!confirm(`Ripristinare backup del ${formatDate(backup.timestamp)}?\nQuesta azione sovrascriver√† i dati correnti.`)) {
                return false;
            }
            
            // Crea backup corrente prima di restore (safety)
            createBackup('Pre-restore safety backup');
            
            // Restore
            state.projects = JSON.parse(JSON.stringify(backup.projects));
            saveState();
            render();
            
            showNotification(`‚úÖ Backup ripristinato: ${backup.reason}`, 'success');
            return true;
        }

        function deleteBackup(backupId) {
            // Elimina backup specifico
            let backups = getBackups();
            backups = backups.filter(b => b.id !== backupId);
            localStorage.setItem('openPorteBackups', JSON.stringify(backups));
            
            showNotification('üóëÔ∏è Backup eliminato', 'info');
        }

        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        // üìã SEZIONE 7: UI HELPER FUNCTIONS
        // ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

        async function showImportPreview(analysis) {
            // Mostra preview progetti da importare
            return new Promise((resolve) => {
                const { newProjects, existingProjects, conflicts } = analysis;
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4';
                modal.style.position = 'fixed';
                modal.style.top = '0';
                modal.style.left = '0';
                modal.style.right = '0';
                modal.style.bottom = '0';
                
                modal.innerHTML = `
                    <div class="bg-white rounded-xl shadow-2xl max-w-xl w-full">
                        <div class="p-6">
                            <h2 class="text-2xl font-bold mb-4 text-blue-600">
                                üì• Anteprima Import
                            </h2>
                            
                            <div class="space-y-4 mb-6">
                                <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <p class="font-bold text-green-700">‚úÖ Nuovi Progetti: ${newProjects.length}</p>
                                    <p class="text-sm text-gray-600">Saranno aggiunti senza conflitti</p>
                                </div>
                                
                                ${conflicts.length > 0 ? `
                                <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                    <p class="font-bold text-yellow-700">‚ö†Ô∏è Conflitti Rilevati: ${conflicts.length}</p>
                                    <p class="text-sm text-gray-600">Ti verr√† chiesto come gestirli</p>
                                </div>
                                ` : ''}
                                
                                ${existingProjects.length > 0 ? `
                                <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <p class="font-bold text-blue-700">üìã Progetti Identici: ${existingProjects.length}</p>
                                    <p class="text-sm text-gray-600">Saranno ignorati (gi√† presenti)</p>
                                </div>
                                ` : ''}
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="window.closeImportPreview(false)" 
                                        class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                    Annulla
                                </button>
                                <button onclick="window.closeImportPreview(true)" 
                                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                                    Continua Import
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                
                window.closeImportPreview = (proceed) => {
                    document.body.removeChild(modal);
                    delete window.closeImportPreview;
                    resolve(proceed);
                };
            });
        }

        function formatDate(isoString) {
            // Formatta data ISO in formato leggibile
            if (!isoString) return 'Mai';
            const date = new Date(isoString);
            return date.toLocaleString('it-IT', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // ‚òÅÔ∏è FASE 022a: ONEDRIVE SYNC MODULE
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // ‚îÄ‚îÄ‚îÄ UTILITY FUNCTIONS ‚îÄ‚îÄ‚îÄ
        
        function renderSyncBadge() {
            // ‚òÅÔ∏è Controllo sicurezza: se onedrive non esiste, ritorna disconnesso
            if (!state.onedrive || !state.onedrive.connected) {
                return '<span style="font-size: 14px; color: #94a3b8;">‚ö™</span>'; // Disconnesso
            }
            
            switch(state.onedrive.syncStatus) {
                case 'synced':
                    return '<span style="font-size: 14px; color: #22c55e;">üü¢</span>'; // Verde
                case 'syncing':
                    return '<span style="font-size: 14px; color: #eab308;">üü°</span>'; // Giallo
                case 'error':
                    return '<span style="font-size: 14px; color: #ef4444;">üî¥</span>'; // Rosso
                default:
                    return '<span style="font-size: 14px; color: #3b82f6;">üîµ</span>'; // Blu
            }
        }
        
        function getTimeSince(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            const minutes = Math.floor(diff / 60000);
            const hours = Math.floor(diff / 3600000);
            const days = Math.floor(diff / 86400000);
            
            if (minutes < 1) return 'Ora';
            if (minutes < 60) return `${minutes} min fa`;
            if (hours < 24) return `${hours} ore fa`;
            return `${days} giorni fa`;
        }
        
        // ‚îÄ‚îÄ‚îÄ AUTHENTICATION ‚îÄ‚îÄ‚îÄ
        
        async function connectOneDrive() {
            try {
                // Verifica configurazione CLIENT_ID
                if (ONEDRIVE_CONFIG.clientId === 'YOUR_CLIENT_ID_HERE') {
                    showNotification('‚ö†Ô∏è Configurare CLIENT_ID in Azure Portal prima!', 'error', 8000);
                    showOneDriveSetupInstructions();
                    return;
                }
                
                showNotification('üîó Connessione a OneDrive...', 'info');
                
                // Genera PKCE challenge
                const codeVerifier = generateRandomString(128);
                const codeChallenge = await generateCodeChallenge(codeVerifier);
                
                // Salva verifier per dopo
                sessionStorage.setItem('onedrive_code_verifier', codeVerifier);
                
                // Costruisci URL autorizzazione
                const authUrl = `${ONEDRIVE_CONFIG.authority}/authorize?` +
                    `client_id=${ONEDRIVE_CONFIG.clientId}` +
                    `&response_type=code` +
                    `&redirect_uri=${encodeURIComponent(ONEDRIVE_CONFIG.redirectUri)}` +
                    `&scope=${encodeURIComponent(ONEDRIVE_CONFIG.scopes.join(' '))}` +
                    `&code_challenge=${codeChallenge}` +
                    `&code_challenge_method=S256` +
                    `&prompt=select_account`;
                
                // Reindirizza a pagina auth Microsoft
                window.location.href = authUrl;
                
            } catch (error) {
                console.error('Error connecting to OneDrive:', error);
                showNotification('‚ùå Errore connessione OneDrive', 'error');
            }
        }
        
        async function handleAuthCallback() {
            // Gestisce il callback dopo l'autenticazione
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');
            
            if (error) {
                showNotification('‚ùå Autenticazione annullata', 'error');
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }
            
            if (code) {
                try {
                    showNotification('üîê Ottenimento token...', 'info');
                    
                    const codeVerifier = sessionStorage.getItem('onedrive_code_verifier');
                    sessionStorage.removeItem('onedrive_code_verifier');
                    
                    // Scambia code con access token
                    const tokenResponse = await fetch(`${ONEDRIVE_CONFIG.authority}/token`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: new URLSearchParams({
                            client_id: ONEDRIVE_CONFIG.clientId,
                            scope: ONEDRIVE_CONFIG.scopes.join(' '),
                            code: code,
                            redirect_uri: ONEDRIVE_CONFIG.redirectUri,
                            grant_type: 'authorization_code',
                            code_verifier: codeVerifier
                        })
                    });
                    
                    if (!tokenResponse.ok) {
                        throw new Error('Token exchange failed');
                    }
                    
                    const tokens = await tokenResponse.json();
                    
                    // Salva token
                    state.onedrive.connected = true;
                    state.onedrive.accessToken = tokens.access_token;
                    state.onedrive.refreshToken = tokens.refresh_token;
                    state.onedrive.tokenExpiry = Date.now() + (tokens.expires_in * 1000);
                    
                    // Ottieni info utente
                    const userInfo = await fetch(`${ONEDRIVE_CONFIG.apiEndpoint}/me`, {
                        headers: { 'Authorization': `Bearer ${tokens.access_token}` }
                    });
                    
                    if (userInfo.ok) {
                        const user = await userInfo.json();
                        state.onedrive.userEmail = user.userPrincipalName || user.mail;
                    }
                    
                    state.onedrive.syncStatus = 'synced';
                    saveState();
                    
                    // Pulisci URL
                    window.history.replaceState({}, document.title, window.location.pathname);
                    
                    showNotification('‚úÖ Connesso a OneDrive!', 'success');
                    
                    // Avvia sync automatica
                    if (state.onedrive.autoSyncEnabled) {
                        startAutoSync();
                    }
                    
                    // üÜï SCARICA AUTOMATICAMENTE I DATI DAL CLOUD
                    // Se l'utente connette OneDrive su nuovo dispositivo, scarica i progetti esistenti
                    setTimeout(async () => {
                        if (state.projects.length === 0) {
                            // Prova a scaricare dati dal cloud
                            showNotification('üì• Controllo dati su OneDrive...', 'info');
                            const downloaded = await downloadFromOneDrive();
                            if (downloaded) {
                                showNotification('‚úÖ Progetti sincronizzati da OneDrive!', 'success', 3000);
                            }
                        }
                    }, 1500);
                    
                    render();
                    
                } catch (error) {
                    console.error('Token exchange error:', error);
                    showNotification('‚ùå Errore ottenimento token', 'error');
                    state.onedrive.connected = false;
                    saveState();
                }
            }
        }
        
        async function disconnectOneDrive() {
            if (confirm('Disconnettere OneDrive? I dati locali NON verranno eliminati.')) {
                stopAutoSync();
                
                state.onedrive = {
                    connected: false,
                    userEmail: null,
                    accessToken: null,
                    refreshToken: null,
                    tokenExpiry: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
                
                saveState();
                render();
                showNotification('üëã OneDrive disconnesso', 'info');
            }
        }
        
        async function refreshAccessToken() {
            try {
                if (!state.onedrive.refreshToken) {
                    throw new Error('No refresh token');
                }
                
                const response = await fetch(`${ONEDRIVE_CONFIG.authority}/token`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: new URLSearchParams({
                        client_id: ONEDRIVE_CONFIG.clientId,
                        scope: ONEDRIVE_CONFIG.scopes.join(' '),
                        refresh_token: state.onedrive.refreshToken,
                        grant_type: 'refresh_token'
                    })
                });
                
                if (!response.ok) {
                    throw new Error('Token refresh failed');
                }
                
                const tokens = await response.json();
                
                state.onedrive.accessToken = tokens.access_token;
                if (tokens.refresh_token) {
                    state.onedrive.refreshToken = tokens.refresh_token;
                }
                state.onedrive.tokenExpiry = Date.now() + (tokens.expires_in * 1000);
                
                saveState();
                return true;
                
            } catch (error) {
                console.error('Token refresh error:', error);
                showNotification('‚ö†Ô∏è Riconnetti OneDrive', 'error');
                state.onedrive.connected = false;
                stopAutoSync();
                saveState();
                return false;
            }
        }
        
        async function ensureValidToken() {
            // Verifica e rinnova token se necessario
            if (!state.onedrive.connected) {
                return false;
            }
            
            // Se token scade tra meno di 5 minuti, rinnova
            if (state.onedrive.tokenExpiry && (Date.now() + 300000) >= state.onedrive.tokenExpiry) {
                return await refreshAccessToken();
            }
            
            return true;
        }
        
        // ‚îÄ‚îÄ‚îÄ PKCE HELPERS ‚îÄ‚îÄ‚îÄ
        
        function generateRandomString(length) {
            const charset = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
            let result = '';
            const values = crypto.getRandomValues(new Uint8Array(length));
            for (let i = 0; i < length; i++) {
                result += charset[values[i] % charset.length];
            }
            return result;
        }
        
        async function generateCodeChallenge(codeVerifier) {
            const encoder = new TextEncoder();
            const data = encoder.encode(codeVerifier);
            const hash = await crypto.subtle.digest('SHA-256', data);
            const base64 = btoa(String.fromCharCode(...new Uint8Array(hash)));
            return base64.replace(/=/g, '').replace(/\+/g, '-').replace(/\//g, '_');
        }
        
        // ‚îÄ‚îÄ‚îÄ SYNC OPERATIONS ‚îÄ‚îÄ‚îÄ
        
        async function uploadToOneDrive() {
            if (!await ensureValidToken()) {
                showNotification('‚ö†Ô∏è Riconnetti OneDrive', 'error');
                return false;
            }
            
            try {
                state.onedrive.syncStatus = 'syncing';
                // ‚ö° FASE 024B: Aggiorna status DOM invece di render completo
                updateSyncStatusDisplay('syncing');
                
                // Prepara dati per upload
                const dataToUpload = {
                    ...state,
                    onedrive: {
                        ...state.onedrive,
                        accessToken: null,  // Non salvare token nel cloud!
                        refreshToken: null
                    },
                    metadata: {
                        lastModified: Date.now(),
                        appVersion: '3.5.022a',
                        deviceId: getDeviceId()
                    }
                };
                
                const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
                const url = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}:/content`;
                
                const response = await fetch(url, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(dataToUpload, null, 2)
                });
                
                if (!response.ok) {
                    throw new Error(`Upload failed: ${response.status}`);
                }
                
                state.onedrive.lastSyncTime = Date.now();
                state.onedrive.syncStatus = 'synced';
                // ‚ö° FASE 024B: Aggiorna status DOM invece di render completo
                updateSyncStatusDisplay('synced');
                
                // Mostra notifica SOLO se abilitato e non di recente
                // ‚ö° FASE 024B: Notifica silenziosa se utente sta digitando
                if (state.onedrive.syncNotifications && !isUserTyping()) {
                    if (!window.lastSyncNotification || (Date.now() - window.lastSyncNotification) > 5000) {
                        window.lastSyncNotification = Date.now();
                        showNotification('‚òÅÔ∏è Caricato su OneDrive', 'success', 2000);
                    }
                }
                
                return true;
                
            } catch (error) {
                console.error('Upload error:', error);
                state.onedrive.syncStatus = 'error';
                // ‚ö° FASE 024B: Aggiorna status DOM invece di render completo
                updateSyncStatusDisplay('error');
                showNotification('‚ùå Errore upload OneDrive', 'error');
                return false;
            }
        }
        
        async function downloadFromOneDrive() {
            console.log('üîΩ downloadFromOneDrive: INIZIO');
            
            // Check 1: Token valido?
            console.log('üîΩ Check token...');
            if (!await ensureValidToken()) {
                console.error('üîΩ ERRORE: Token non valido');
                showNotification('‚ö†Ô∏è Riconnetti OneDrive', 'error');
                return false;
            }
            console.log('üîΩ Token OK');
            
            try {
                state.onedrive.syncStatus = 'syncing';
                render();
                
                // Check 2: Percorso file
                const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
                const url = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}:/content`;
                console.log('üîΩ Percorso file:', filePath);
                console.log('üîΩ URL completo:', url);
                
                // Check 3: Notifica utente
                showNotification('üì• Download da OneDrive in corso...', 'info', 3000);
                
                // Check 4: Fetch
                console.log('üîΩ Avvio fetch...');
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                console.log('üîΩ Fetch completato. Status:', response.status);
                
                if (!response.ok) {
                    if (response.status === 404) {
                        console.log('üîΩ File non trovato (404). Primo upload?');
                        showNotification('üì§ File non trovato su OneDrive. Primo upload...', 'info');
                        return await uploadToOneDrive();
                    }
                    console.error('üîΩ ERRORE HTTP:', response.status, response.statusText);
                    throw new Error(`Download failed: ${response.status} ${response.statusText}`);
                }
                
                // Check 5: Parse JSON
                console.log('üîΩ Download OK. Parsing JSON...');
                const cloudData = await response.json();
                console.log('üîΩ JSON parsed. Progetti trovati:', cloudData.projects?.length || 0);
                
                // Check 6: Validazione dati
                if (!cloudData.projects || !Array.isArray(cloudData.projects)) {
                    console.error('üîΩ ERRORE: Dati non validi. projects non √® array');
                    throw new Error('Dati OneDrive non validi');
                }
                
                // Check 7: Backup locale
                console.log('üîΩ Creazione backup locale...');
                if (state.onedrive.autoBackupEnabled) {
                    createBackup('Pre-sync OneDrive');
                }
                
                // Check 8: MERGE INTELLIGENTE invece di sovrascrivere
                console.log('üîΩ MERGE INTELLIGENTE dati OneDrive...');
                const mergeResult = await mergeOneDriveData(cloudData);
                
                if (mergeResult.hasConflicts) {
                    // Ci sono conflitti ‚Üí analizza tipo
                    console.log('üîΩ Conflitti rilevati:', mergeResult.conflicts.length);
                    
                    for (const conflict of mergeResult.conflicts) {
                        // üö® FASE 027B: Auto-merge se solo differenza posizioni
                        const autoMergeable = isAutoMergeable(conflict);
                        
                        if (autoMergeable) {
                            // AUTO-MERGE: solo differenza posizioni ‚Üí unisci automaticamente
                            console.log('üîΩ Auto-merge per:', conflict.existing.name);
                            applyConflictResolution(conflict, 'merge');
                        } else {
                            // CHIEDI utente: conflitti complessi
                            console.log('üîΩ Richiesta utente per:', conflict.existing.name);
                            const resolution = await resolveConflict(conflict);
                            if (resolution === 'cancel') {
                                showNotification('‚ùå Sync annullata', 'error');
                                return false;
                            }
                            applyConflictResolution(conflict, resolution);
                        }
                    }
                    
                    // Notifica quanti auto-merged
                    const autoMerged = mergeResult.conflicts.filter(c => isAutoMergeable(c)).length;
                    if (autoMerged > 0) {
                        console.log(`‚úÖ ${autoMerged} progetti auto-merged senza dialogs`);
                    }
                } else {
                    // Nessun conflitto ‚Üí applica direttamente
                    console.log('üîΩ Nessun conflitto, applico merge diretto');
                    mergeResult.newProjects.forEach(project => {
                        state.projects.push(project);
                    });
                }
                
                state.onedrive.lastSyncTime = Date.now();
                state.onedrive.syncStatus = 'synced';
                
                // Check 9: Salvataggio
                console.log('üîΩ Salvataggio state...');
                saveState();
                
                // Check 10: Render
                console.log('üîΩ Render UI...');
                render();
                
                // Check 11: Notifica successo
                console.log('üîΩ DOWNLOAD COMPLETATO! Progetti:', state.projects.length);
                showNotification(`‚úÖ ${state.projects.length} progetti scaricati da OneDrive!`, 'success', 3000);
                
                return true;
                
            } catch (error) {
                console.error('üîΩ ERRORE DOWNLOAD:', error);
                console.error('üîΩ Error message:', error.message);
                console.error('üîΩ Error stack:', error.stack);
                
                state.onedrive.syncStatus = 'error';
                render();
                
                // Notifica con dettaglio errore
                showNotification(`‚ùå Errore download: ${error.message}`, 'error', 5000);
                return false;
            }
        }
        
        // Variabile globale per tracciare l'ultimo sync
        let lastSyncAttempt = 0;
        const MIN_SYNC_INTERVAL = 10000; // Minimo 10 secondi tra sync
        
        async function performSync() {
            // Previeni sync troppo frequenti
            const now = Date.now();
            if (now - lastSyncAttempt < MIN_SYNC_INTERVAL) {
                console.log('Sync skipped - troppo frequente');
                return false;
            }
            lastSyncAttempt = now;
            
            if (!state.onedrive.connected) {
                showNotification('‚ö†Ô∏è Connetti OneDrive prima', 'info');
                openSyncSettings();
                return;
            }
            
            try {
                // üö® FASE 027B FIX: SEMPRE download con merge, MAI sovrascrivere
                console.log('üîÑ SYNC: Avvio download con merge intelligente');
                
                const cloudMeta = await getCloudFileMetadata();
                
                if (!cloudMeta) {
                    // File non esiste su cloud, upload locale
                    console.log('üîÑ SYNC: File non su cloud ‚Üí upload');
                    return await uploadToOneDrive();
                }
                
                // File esiste su cloud ‚Üí SEMPRE merge per sicurezza
                console.log('üîÑ SYNC: File su cloud ‚Üí download con merge');
                return await downloadFromOneDrive();
                
            } catch (error) {
                console.error('Sync error:', error);
                state.onedrive.syncStatus = 'error';
                showNotification('‚ùå Errore sincronizzazione', 'error');
                return false;
            }
        }
        
        async function getCloudFileMetadata() {
            try {
                if (!await ensureValidToken()) {
                    return null;
                }
                
                const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
                const url = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}`;
                
                const response = await fetch(url, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (!response.ok) {
                    if (response.status === 404) {
                        return null; // File non esiste
                    }
                    throw new Error(`Metadata fetch failed: ${response.status}`);
                }
                
                return await response.json();
                
            } catch (error) {
                console.error('Metadata fetch error:', error);
                return null;
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ AUTO SYNC ‚îÄ‚îÄ‚îÄ
        
        function startAutoSync() {
            if (!state.onedrive.connected || !state.onedrive.autoSyncEnabled) {
                return;
            }
            
            stopAutoSync(); // Pulisci timer esistente
            
            // USA INTERVALLO SICURO DI 5 MINUTI INVECE DI CONFIG
            const SAFE_SYNC_INTERVAL = 5 * 60 * 1000; // 5 minuti fissi
            
            syncInterval = setInterval(async () => {
                if (state.onedrive.connected && state.onedrive.autoSyncEnabled) {
                    console.log('Auto-sync triggered at', new Date().toLocaleTimeString());
                    await performSync();
                }
            }, SAFE_SYNC_INTERVAL);
            
            console.log('Auto-sync attivata (ogni 5 min effettivi)');
        }
        
        function stopAutoSync() {
            if (syncInterval) {
                clearInterval(syncInterval);
                syncInterval = null;
                console.log('Auto-sync disattivata');
            }
        }
        
        // ‚îÄ‚îÄ‚îÄ UI FUNCTIONS ‚îÄ‚îÄ‚îÄ
        
        async function testOneDriveConnection() {
            console.log('üß™ TEST CONNESSIONE ONEDRIVE');
            showNotification('üß™ Test connessione in corso...', 'info');
            
            try {
                // Test 1: Token valido?
                if (!state.onedrive.connected) {
                    throw new Error('OneDrive non connesso');
                }
                
                if (!state.onedrive.accessToken) {
                    throw new Error('Access token mancante');
                }
                
                console.log('‚úÖ Token presente');
                
                // Test 2: Verifica scadenza token
                if (state.onedrive.tokenExpiry && Date.now() >= state.onedrive.tokenExpiry) {
                    console.log('‚ö†Ô∏è Token scaduto, refresh...');
                    await refreshAccessToken();
                }
                
                // Test 3: Test API Microsoft Graph
                console.log('üß™ Test API Microsoft Graph...');
                const testUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive`;
                const testResponse = await fetch(testUrl, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (!testResponse.ok) {
                    throw new Error(`API test failed: ${testResponse.status}`);
                }
                
                console.log('‚úÖ API Microsoft Graph OK');
                
                // Test 4: Controlla se cartella OpenPorte esiste
                console.log('üß™ Controllo cartella OpenPorte...');
                const folderUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${ONEDRIVE_CONFIG.folderPath}`;
                const folderResponse = await fetch(folderUrl, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (folderResponse.ok) {
                    console.log('‚úÖ Cartella OpenPorte trovata');
                } else if (folderResponse.status === 404) {
                    console.log('‚ö†Ô∏è Cartella OpenPorte non esiste');
                }
                
                // Test 5: Controlla se file data.json esiste
                console.log('üß™ Controllo file data.json...');
                const filePath = `${ONEDRIVE_CONFIG.folderPath}/${ONEDRIVE_CONFIG.fileName}`;
                const fileUrl = `${ONEDRIVE_CONFIG.apiEndpoint}/me/drive/root:${filePath}`;
                const fileResponse = await fetch(fileUrl, {
                    headers: {
                        'Authorization': `Bearer ${state.onedrive.accessToken}`
                    }
                });
                
                if (fileResponse.ok) {
                    const fileInfo = await fileResponse.json();
                    console.log('‚úÖ File data.json trovato');
                    console.log('üìÑ Size:', fileInfo.size, 'bytes');
                    console.log('üìÖ Modified:', fileInfo.lastModifiedDateTime);
                    showNotification(`‚úÖ Test OK! File trovato (${Math.round(fileInfo.size/1024)}KB)`, 'success', 3000);
                } else if (fileResponse.status === 404) {
                    console.log('‚ö†Ô∏è File data.json non esiste su OneDrive');
                    showNotification('‚ö†Ô∏è File non trovato su OneDrive. Carica prima dal PC!', 'error', 5000);
                } else {
                    throw new Error(`File check failed: ${fileResponse.status}`);
                }
                
                return true;
                
            } catch (error) {
                console.error('‚ùå TEST FALLITO:', error);
                showNotification(`‚ùå Test fallito: ${error.message}`, 'error', 5000);
                return false;
            }
        }
        
        function openSyncSettings() {
            // ‚òÅÔ∏è Controllo sicurezza: assicura che onedrive structure esista
            if (!state.onedrive) {
                state.onedrive = {
                    connected: false,
                    userEmail: null,
                    accessToken: null,
                    refreshToken: null,
                    tokenExpiry: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected',
                    autoSyncEnabled: true,
                    autoBackupEnabled: true,
                    syncNotifications: true
                };
            }
            
            const modal = document.createElement('div');
            modal.className = 'sync-settings-modal';
            modal.innerHTML = `
                <div class="sync-settings-dialog">
                    <div class="sync-settings-header">
                        <h3>‚òÅÔ∏è Impostazioni OneDrive</h3>
                        <button onclick="this.closest('.sync-settings-modal').remove()" class="close-btn">‚úï</button>
                    </div>
                    
                    <div class="sync-account">
                        ${state.onedrive.connected ? `
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">
                                    üü¢ ${state.onedrive.userEmail || 'Connesso'}
                                </div>
                                <div style="font-size: 12px; color: #64748b;">
                                    ${state.onedrive.lastSyncTime ? 
                                        'Ultima sync: ' + getTimeSince(state.onedrive.lastSyncTime) : 
                                        'Mai sincronizzato'}
                                </div>
                            </div>
                            <button onclick="disconnectOneDrive(); this.closest('.sync-settings-modal').remove();" class="btn-secondary">
                                Disconnetti
                            </button>
                        ` : `
                            <div>
                                <div style="font-weight: 600; margin-bottom: 4px;">
                                    ‚ö™ Non connesso
                                </div>
                                <div style="font-size: 12px; color: #64748b;">
                                    Connetti per backup automatico
                                </div>
                            </div>
                            <button onclick="connectOneDrive(); this.closest('.sync-settings-modal').remove();" class="btn-primary">
                                üîó Connetti
                            </button>
                        `}
                    </div>
                    
                    ${state.onedrive.connected ? `
                        <div class="sync-options">
                            <label>
                                <input type="checkbox" ${state.onedrive.autoSyncEnabled ? 'checked' : ''} 
                                       onchange="state.onedrive.autoSyncEnabled = this.checked; saveState(); this.checked ? startAutoSync() : stopAutoSync();">
                                <span>Sincronizzazione automatica (ogni 5 min)</span>
                            </label>
                            
                            <label>
                                <input type="checkbox" ${state.onedrive.autoBackupEnabled ? 'checked' : ''} 
                                       onchange="state.onedrive.autoBackupEnabled = this.checked; saveState();">
                                <span>Backup automatico prima di sync</span>
                            </label>
                            
                            <label>
                                <input type="checkbox" ${state.onedrive.syncNotifications ? 'checked' : ''} 
                                       onchange="state.onedrive.syncNotifications = this.checked; saveState();">
                                <span>Notifiche sincronizzazione</span>
                            </label>
                        </div>
                        
                        <div class="sync-actions">
                            <button onclick="performSync()" class="btn-sync">
                                üîÑ Sincronizza Ora
                            </button>
                            <button onclick="downloadFromOneDrive()" class="btn-sync">
                                ‚¨áÔ∏è Scarica
                            </button>
                            <button onclick="uploadToOneDrive()" class="btn-sync">
                                ‚¨ÜÔ∏è Carica
                            </button>
                            <button onclick="testOneDriveConnection()" class="btn-sync" style="background: #8b5cf6;">
                                üß™ Test Connessione
                            </button>
                        </div>
                    ` : ''}
                    
                    ${state.onedrive.connected ? `
                        <div class="sync-debug" style="margin-top: 16px; padding: 12px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px;">
                            <p style="font-weight: 600; margin-bottom: 8px;">üîç Debug Info</p>
                            <div style="font-size: 12px; color: #64748b; font-family: monospace;">
                                <div>Progetti locali: <strong>${state.projects?.length || 0}</strong></div>
                                <div>Token valido: <strong>${state.onedrive.accessToken ? '‚úÖ S√¨' : '‚ùå No'}</strong></div>
                                <div>Token scade: <strong>${state.onedrive.tokenExpiry ? new Date(state.onedrive.tokenExpiry).toLocaleString('it-IT') : 'N/A'}</strong></div>
                                <div>Stato sync: <strong>${state.onedrive.syncStatus || 'N/A'}</strong></div>
                                <div style="margin-top: 8px;">
                                    <button onclick="window.open('', '_blank').document.write('<pre>' + JSON.stringify(state.onedrive, null, 2) + '</pre>')" 
                                            style="font-size: 11px; padding: 4px 8px; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">
                                        üìã Mostra Config Completa
                                    </button>
                                    <button onclick="console.log('STATE COMPLETO:', state); alert('Vedi console browser (F12)');" 
                                            style="font-size: 11px; padding: 4px 8px; background: #8b5cf6; color: white; border: none; border-radius: 4px; cursor: pointer; margin-left: 4px;">
                                        üîç Log Console
                                    </button>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="sync-info">
                        <p><strong>‚ÑπÔ∏è Come funziona:</strong></p>
                        <ul style="margin: 8px 0; padding-left: 20px; font-size: 13px; color: #64748b;">
                            <li>Backup automatico in OneDrive ogni 5 minuti</li>
                            <li>Sincronizzazione tra dispositivi</li>
                            <li>I dati locali sono sempre disponibili offline</li>
                            <li>Gestione automatica conflitti</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Chiudi con click fuori
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.remove();
                }
            });
        }
        
        function showOneDriveSetupInstructions() {
            const modal = document.createElement('div');
            modal.className = 'sync-settings-modal';
            modal.innerHTML = `
                <div class="sync-settings-dialog" style="max-width: 600px;">
                    <div class="sync-settings-header">
                        <h3>‚öôÔ∏è Setup OneDrive</h3>
                        <button onclick="this.closest('.sync-settings-modal').remove()" class="close-btn">‚úï</button>
                    </div>
                    
                    <div style="padding: 20px; line-height: 1.6;">
                        <p><strong>Per abilitare OneDrive sync:</strong></p>
                        
                        <ol style="margin: 16px 0; padding-left: 20px;">
                            <li style="margin: 12px 0;">
                                Vai su <a href="https://portal.azure.com" target="_blank" style="color: #2563eb;">
                                    Azure Portal
                                </a>
                            </li>
                            <li style="margin: 12px 0;">
                                Vai su "App registrations" ‚Üí "New registration"
                            </li>
                            <li style="margin: 12px 0;">
                                Nome app: <strong>Open Porte</strong>
                            </li>
                            <li style="margin: 12px 0;">
                                Supported account types: <strong>Accounts in any organizational directory and personal Microsoft accounts</strong>
                            </li>
                            <li style="margin: 12px 0;">
                                Redirect URI: <strong>${window.location.origin}</strong>
                            </li>
                            <li style="margin: 12px 0;">
                                Copia il <strong>Client ID</strong> generato
                            </li>
                            <li style="margin: 12px 0;">
                                Modifica il file HTML sostituendo <code>YOUR_CLIENT_ID_HERE</code> con il tuo Client ID
                            </li>
                        </ol>
                        
                        <p style="margin-top: 20px; padding: 12px; background: #fef3c7; border-left: 3px solid #f59e0b; font-size: 13px;">
                            <strong>‚ö†Ô∏è Nota:</strong> Questo setup √® necessario solo una volta. Il Client ID pu√≤ essere condiviso tra dispositivi.
                        </p>
                    </div>
                    
                    <div style="text-align: center; padding: 20px;">
                        <button onclick="this.closest('.sync-settings-modal').remove()" class="btn-primary">
                            Ho capito
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }
        
        function getDeviceId() {
            let deviceId = localStorage.getItem('deviceId');
            if (!deviceId) {
                deviceId = 'device_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('deviceId', deviceId);
            }
            return deviceId;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // üéØ FASE 021: MENU LATERALE HAMBURGER
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // Genera HTML menu laterale con header compatto
        function renderProjectMenu() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '';
            
            // Determina quali prodotti sono selezionati
            const hasInfissi = project.prodotti?.infissi || false;
            const hasPersiane = project.prodotti?.persiane || false;
            const hasTapparelle = project.prodotti?.tapparelle || false;
            const hasZanzariere = project.prodotti?.zanzariere || false;
            const hasCassonetti = project.prodotti?.cassonetti || false;
            
            // Verifica prerequisiti per navigazione
            const canGoToPositions = hasInfissi || hasPersiane || hasTapparelle || 
                                     hasZanzariere || hasCassonetti;
            
            // Determina se sezione √® attiva
            const isStep1Active = state.setupStep === 1;
            const isStep2Active = state.setupStep === 2;
            const isStep3Active = state.setupStep === 3 && hasInfissi;
            const isStep4Active = state.setupStep === 4 && hasPersiane;
            const isStep5Active = state.setupStep === 5 && hasTapparelle;
            const isStep6Active = state.setupStep === 6 && hasZanzariere;
            const isStep7Active = state.setupStep === 7 && hasCassonetti;
            const isStep9Active = state.setupStep === 9;
            
            // Calcola completamento per ogni sezione
            const completamentoCliente = calcolaCompletamentoCliente(project);
            const completamentoSetup = calcolaCompletamentoSetup(project);
            const completamentoConfig = calcolaCompletamentoConfig(project);
            const completamentoPosizioni = calcolaCompletamentoPosizioni(project);
            
            // Stato menu Config (espanso o collassato)
            const configExpanded = state.configMenuExpanded || false;
            
            return `
                <!-- Header compatto fisso -->
                <header class="app-header">
                    <button class="menu-toggle" onclick="toggleProjectMenu()">‚ò∞</button>
                    <h1 class="app-title">
                        ${project.clientName || 'Nuovo Progetto'}
                        ${project.ambiente ? ` - ${project.ambiente}` : ''}
                    </h1>
                    <div class="header-actions">
                        <button class="btn-icon" onclick="exportCurrentProjectJSON()" title="Export JSON">üíæ</button>
                        <button class="btn-icon" onclick="printCurrentProjectPDF()" title="Export PDF">üñ®Ô∏è</button>
                    </div>
                </header>
                
                <!-- Menu laterale progetto -->
                <aside class="side-menu-project ${state.projectMenuOpen ? 'open' : ''}" id="projectSideMenu">
                    <!-- Header menu -->
                    <div class="project-menu-header">
                        <button class="project-menu-close" onclick="toggleProjectMenu()">‚úï</button>
                        <span>MENU PROGETTO</span>
                    </div>
                    
                    <!-- Info Progetto -->
                    <div class="project-info-box">
                        <div class="project-name">${project.clientName || 'Nuovo Progetto'}</div>
                        ${project.ambiente ? `<div class="project-ambiente">${project.ambiente}</div>` : ''}
                    </div>
                    
                    <!-- Navigazione Principale -->
                    <div class="nav-section">
                        <div class="nav-title">Navigazione</div>
                        
                        <!-- Cliente -->
                        <div class="nav-item ${isStep1Active ? 'active' : ''}" 
                             onclick="navigateToStep(1); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">üë§</span>
                                <span>Cliente</span>
                            </div>
                            ${renderCompletionBadge(completamentoCliente)}
                        </div>
                        
                        <!-- Setup -->
                        <div class="nav-item ${isStep2Active ? 'active' : ''}" 
                             onclick="navigateToStep(2); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">üõ†Ô∏è</span>
                                <span>Setup</span>
                            </div>
                            ${renderCompletionBadge(completamentoSetup)}
                        </div>
                        
                        <!-- Config (con submenu) -->
                        <div class="nav-item ${(isStep3Active || isStep4Active || isStep5Active || isStep6Active || isStep7Active) ? 'active' : ''}" 
                             onclick="toggleConfigMenu(event)">
                            <div class="nav-label">
                                <span class="nav-icon">‚öôÔ∏è</span>
                                <span>Config</span>
                                <span style="margin-left: auto; font-size: 12px;">${configExpanded ? '‚ñº' : '‚ñ∂'}</span>
                            </div>
                            ${renderCompletionBadge(completamentoConfig)}
                        </div>
                        
                        <!-- Submenu Config -->
                        <div class="nav-submenu ${configExpanded ? 'open' : ''}" id="configSubmenu">
                            ${hasInfissi ? `
                                <div class="nav-submenu-item ${isStep3Active ? 'active' : ''}" 
                                     onclick="navigateToStep(3); closeProjectMenu();">
                                    <span>ü™ü Infissi</span>
                                    ${renderCompletionBadge(calcolaCompletamentoInfissi(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasPersiane ? `
                                <div class="nav-submenu-item ${isStep4Active ? 'active' : ''}" 
                                     onclick="navigateToStep(4); closeProjectMenu();">
                                    <span>üö™ Persiane</span>
                                    ${renderCompletionBadge(calcolaCompletamentoPersiane(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasTapparelle ? `
                                <div class="nav-submenu-item ${isStep5Active ? 'active' : ''}" 
                                     onclick="navigateToStep(5); closeProjectMenu();">
                                    <span>üéöÔ∏è Tapparelle</span>
                                    ${renderCompletionBadge(calcolaCompletamentoTapparelle(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasZanzariere ? `
                                <div class="nav-submenu-item ${isStep6Active ? 'active' : ''}" 
                                     onclick="navigateToStep(6); closeProjectMenu();">
                                    <span>ü¶ü Zanzariere</span>
                                    ${renderCompletionBadge(calcolaCompletamentoZanzariere(project), true)}
                                </div>
                            ` : ''}
                            
                            ${hasCassonetti ? `
                                <div class="nav-submenu-item ${isStep7Active ? 'active' : ''}" 
                                     onclick="navigateToStep(7); closeProjectMenu();">
                                    <span>üì¶ Cassonetti</span>
                                    ${renderCompletionBadge(calcolaCompletamentoCassonetti(project), true)}
                                </div>
                            ` : ''}
                            
                            ${!hasInfissi && !hasPersiane && !hasTapparelle && !hasZanzariere && !hasCassonetti ? `
                                <div style="padding: 12px 20px 12px 52px; color: #64748b; font-size: 14px; font-style: italic;">
                                    Nessun prodotto selezionato
                                </div>
                            ` : ''}
                        </div>
                        
                        <!-- Posizioni -->
                        <div class="nav-item ${!canGoToPositions ? 'disabled' : ''} ${isStep9Active ? 'active' : ''}" 
                             onclick="${canGoToPositions ? 'navigateToPositions(); closeProjectMenu();' : ''}">
                            <div class="nav-label">
                                <span class="nav-icon">üìç</span>
                                <span>Posizioni</span>
                            </div>
                            ${canGoToPositions ? renderCompletionBadge(completamentoPosizioni) : ''}
                        </div>
                        
                        <!-- Riepilogo -->
                        <div class="nav-item ${state.showRiepilogoRilievi ? 'active' : ''}" 
                             onclick="toggleRiepilogoRilievi(); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">üìã</span>
                                <span>Riepilogo</span>
                            </div>
                        </div>
                        
                        <!-- ‚òÅÔ∏è FASE 022a: OneDrive Sync -->
                        <div style="border-top: 1px solid var(--menu-border); margin: 12px 0;"></div>
                        
                        <div class="nav-item" onclick="openSyncSettings(); closeProjectMenu();">
                            <div class="nav-label">
                                <span class="nav-icon">‚òÅÔ∏è</span>
                                <span>OneDrive</span>
                            </div>
                            <span class="sync-badge" id="syncBadge">
                                ${renderSyncBadge()}
                            </span>
                        </div>
                        
                        ${state.onedrive.connected ? `
                            <div style="padding: 8px 20px; font-size: 12px; color: var(--menu-text-sec);">
                                <div>üü¢ ${state.onedrive.userEmail || 'Connesso'}</div>
                                ${state.onedrive.lastSyncTime ? `
                                    <div style="margin-top: 4px;">
                                        üîÑ ${getTimeSince(state.onedrive.lastSyncTime)}
                                    </div>
                                ` : ''}
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Azioni Rapide -->
                    <div class="menu-actions">
                        <button class="menu-action-btn" style="background: #10b981; color: white; font-weight: bold; border: 2px solid #059669;" onclick="forceSave(); closeProjectMenu();">
                            üíæ SALVA FORZATO
                        </button>
                        <button class="menu-action-btn" onclick="exportCurrentProjectJSON(); closeProjectMenu();">
                            üì§ Export JSON
                        </button>
                        <button class="menu-action-btn" onclick="printCurrentProjectPDF(); closeProjectMenu();">
                            üñ®Ô∏è Export PDF
                        </button>
                        <button class="menu-action-btn" onclick="importProjectsJSON(); closeProjectMenu();">
                            üì• Import JSON
                        </button>
                        <button class="menu-action-btn primary" onclick="tornaAllaLista();">
                            ‚Üê Lista Progetti
                        </button>
                    </div>
                </aside>
                
                <!-- Overlay -->
                <div class="menu-overlay ${state.projectMenuOpen ? 'active' : ''}" 
                     id="projectMenuOverlay" 
                     onclick="closeProjectMenu()"></div>
            `;
        }
        
        // Funzioni di gestione menu laterale
        function toggleProjectMenu() {
            state.projectMenuOpen = !state.projectMenuOpen;
            render();
        }
        
        function closeProjectMenu() {
            state.projectMenuOpen = false;
            render();
        }
        
        function toggleConfigMenu(event) {
            if (event) event.stopPropagation();
            state.configMenuExpanded = !state.configMenuExpanded;
            render();
        }
        
        // Render badge completamento
        function renderCompletionBadge(percentuale, mini = false) {
            if (percentuale === 0) return '';
            
            const dotColor = percentuale === 100 ? 'green' : 
                           percentuale >= 50 ? 'yellow' : 'red';
            
            if (mini) {
                return `<span class="completion-percent">${percentuale}%</span>`;
            }
            
            return `
                <div class="completion-badge">
                    <div class="completion-dot ${dotColor}"></div>
                    <span class="completion-percent">${percentuale}%</span>
                </div>
            `;
        }
        
        // Mantieni compatibilit√† nomi vecchi
        const renderTopNavbar = renderProjectMenu;

        // ‚úÖ FASE 012 - FUNZIONI CALCOLO COMPLETAMENTO
        
        // Calcola completamento sezione Cliente
        function calcolaCompletamentoCliente(project) {
            if (!project) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 5; // Nome, Indirizzo, Telefono, Email, Ambiente
            
            if (project.clientName) campiCompilati++;
            if (project.clientAddress) campiCompilati++;
            if (project.clientPhone) campiCompilati++;
            if (project.clientEmail) campiCompilati++;
            if (project.ambiente) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        // Calcola completamento Setup
        function calcolaCompletamentoSetup(project) {
            if (!project || !project.prodotti) return 0;
            
            // Almeno un prodotto selezionato = 100%
            const hasAnyProduct = project.prodotti.infissi || project.prodotti.persiane ||
                                 project.prodotti.tapparelle || project.prodotti.zanzariere ||
                                 project.prodotti.cassonetti;
            
            return hasAnyProduct ? 100 : 0;
        }

        // Calcola completamento Config generale
        function calcolaCompletamentoConfig(project) {
            if (!project || !project.prodotti) return 0;
            
            let totaleCompletamento = 0;
            let prodottiSelezionati = 0;
            
            if (project.prodotti.infissi) {
                totaleCompletamento += calcolaCompletamentoInfissi(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.persiane) {
                totaleCompletamento += calcolaCompletamentoPersiane(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.tapparelle) {
                totaleCompletamento += calcolaCompletamentoTapparelle(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.zanzariere) {
                totaleCompletamento += calcolaCompletamentoZanzariere(project);
                prodottiSelezionati++;
            }
            if (project.prodotti.cassonetti) {
                totaleCompletamento += calcolaCompletamentoCassonetti(project);
                prodottiSelezionati++;
            }
            
            if (prodottiSelezionati === 0) return 0;
            
            return Math.round(totaleCompletamento / prodottiSelezionati);
        }

        // Calcola completamento Posizioni
        function calcolaCompletamentoPosizioni(project) {
            if (!project || !project.positions || project.positions.length === 0) return 0;
            
            let posizioniCompletate = 0;
            
            project.positions.forEach(pos => {
                // Una posizione √® completa se ha almeno nome e un prodotto con misure
                if (pos.name) {
                    let hasMeasures = false;
                    
                    ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(tipo => {
                        if (pos[tipo] && (pos[tipo].larghezza || pos[tipo].altezza)) {
                            hasMeasures = true;
                        }
                    });
                    
                    if (hasMeasures) posizioniCompletate++;
                }
            });
            
            return project.positions.length > 0 ? 
                   Math.round((posizioniCompletate / project.positions.length) * 100) : 0;
        }

        // Funzioni specifiche per ogni prodotto
        function calcolaCompletamentoInfissi(project) {
            if (!project.brmConfigInfissi) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigInfissi.valoreL) campiCompilati++;
            if (project.brmConfigInfissi.valoreH) campiCompilati++;
            if (project.rilievoInfissi?.materiale) campiCompilati++;
            if (project.rilievoInfissi?.note) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoPersiane(project) {
            if (!project.brmConfigPersiane) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigPersiane.valoreL) campiCompilati++;
            if (project.brmConfigPersiane.valoreH) campiCompilati++;
            if (project.rilievoPersiane?.materiale) campiCompilati++;
            if (project.rilievoPersiane?.note) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoTapparelle(project) {
            if (!project.brmConfigTapparelle) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigTapparelle.valoreL) campiCompilati++;
            if (project.brmConfigTapparelle.valoreH) campiCompilati++;
            if (project.rilievoTapparelle?.materiale) campiCompilati++;
            if (project.rilievoTapparelle?.note) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoZanzariere(project) {
            if (!project.brmConfigZanzariere) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 2;
            
            if (project.brmConfigZanzariere.valoreL) campiCompilati++;
            if (project.brmConfigZanzariere.valoreH) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        function calcolaCompletamentoCassonetti(project) {
            if (!project.brmConfigCassonetti) return 0;
            
            let campiCompilati = 0;
            let campiTotali = 4;
            
            if (project.brmConfigCassonetti.valoreL) campiCompilati++;
            if (project.brmConfigCassonetti.valoreC) campiCompilati++;
            if (project.brmConfigCassonetti.valoreB) campiCompilati++;
            if (project.rilievoCassonetti?.materiale) campiCompilati++;
            
            return Math.round((campiCompilati / campiTotali) * 100);
        }

        // Funzione per tornare alla lista progetti
        function tornaAllaLista() {
            if (confirm('Vuoi tornare alla lista progetti? Le modifiche sono salvate automaticamente.')) {
                state.screen = 'list';
                state.currentProject = null;
                state.setupStep = 1;
                saveState();
                render();
            }
        }

        // Toggle riepilogo rilievi
        function toggleRiepilogoRilievi() {
            state.showRiepilogoRilievi = !state.showRiepilogoRilievi;
            saveState();
            render();
        }

        // Naviga a step specifico con validazione prerequisiti
        function navigateToStep(stepNumber) {
            // Chiudi dropdown se aperto
            const dropdown = document.getElementById('configDropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            
            // Verifica se pu√≤ navigare
            if (!canNavigateToStep(stepNumber)) {
                showNotification('‚ö†Ô∏è Completa prima i passaggi precedenti', 'warning');
                return;
            }
            
            // Cambia step e renderizza
            state.setupStep = stepNumber;
            saveState();
            render();
        }

        // Naviga direttamente a Step 9 (Posizioni)
        function navigateToPositions() {
            // Chiudi dropdown se aperto
            const dropdown = document.getElementById('configDropdown');
            if (dropdown) {
                dropdown.classList.add('hidden');
            }
            
            const project = state.projects[state.currentProject];
            if (!project) return;
            
            // Verifica che ci sia almeno un prodotto selezionato
            const hasProducts = project.prodotti?.infissi || 
                                project.prodotti?.persiane || 
                                project.prodotti?.tapparelle || 
                                project.prodotti?.zanzariere || 
                                project.prodotti?.cassonetti;
            
            if (!hasProducts) {
                showNotification('‚ö†Ô∏è Seleziona almeno un prodotto nello Setup', 'warning');
                return;
            }
            
            // Salta direttamente a step 9
            state.setupStep = 9;
            saveState();
            render();
        }

        // Verifica se √® possibile navigare a uno step specifico
        function canNavigateToStep(stepNumber) {
            const project = state.projects[state.currentProject];
            if (!project) return false;
            
            // Step 1-2 sempre accessibili
            if (stepNumber <= 2) {
                return true;
            }
            
            // Step 3-7: Config prodotti - verificare se prodotto selezionato
            if (stepNumber === 3) {
                return project.prodotti?.infissi || false;
            }
            if (stepNumber === 4) {
                return project.prodotti?.persiane || false;
            }
            if (stepNumber === 5) {
                return project.prodotti?.tapparelle || false;
            }
            if (stepNumber === 6) {
                return project.prodotti?.zanzariere || false;
            }
            if (stepNumber === 7) {
                return project.prodotti?.cassonetti || false;
            }
            
            // Step 9: Posizioni - almeno un prodotto selezionato
            if (stepNumber === 9) {
                return project.prodotti?.infissi || 
                       project.prodotti?.persiane || 
                       project.prodotti?.tapparelle || 
                       project.prodotti?.zanzariere || 
                       project.prodotti?.cassonetti;
            }
            
            return false;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        
        // üéØ FASE 28: Navigazione intelligente tra step dinamici
        function getValidSteps(project) {
            const steps = [1, 2]; // Sempre presenti: Dati Cliente, Prodotti (include Muro)
            
            // Aggiungi solo gli step dei prodotti selezionati
            if (project.prodotti?.infissi) steps.push(3);
            if (project.prodotti?.persiane) steps.push(4);
            if (project.prodotti?.tapparelle) steps.push(5);
            if (project.prodotti?.zanzariere) steps.push(6);
            if (project.prodotti?.cassonetti) steps.push(7);
            
            // Step finale sempre presente
            steps.push(9);
            
            return steps;
        }

        function getNextValidStep(currentStep, project) {
            const validSteps = getValidSteps(project);
            const currentIndex = validSteps.indexOf(currentStep);
            if (currentIndex !== -1 && currentIndex < validSteps.length - 1) {
                return validSteps[currentIndex + 1];
            }
            return currentStep; // Se siamo all'ultimo step, rimani l√¨
        }

        function getPrevValidStep(currentStep, project) {
            const validSteps = getValidSteps(project);
            const currentIndex = validSteps.indexOf(currentStep);
            if (currentIndex > 0) {
                return validSteps[currentIndex - 1];
            }
            return currentStep; // Se siamo al primo step, rimani l√¨
        }

        window.goToNextStep = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                state.setupStep = getNextValidStep(state.setupStep, project);
                saveState();
                render();
            }
        };

        window.goToPrevStep = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                state.setupStep = getPrevValidStep(state.setupStep, project);
                render();
            }
        };

        // üéØ FASE 25: Gestione Select con "Altro e scrivo"
        function handleSelectWithCustom(projectId, field, selectId, inputId, value, options) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
                // Non salvare ancora
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                updateClientData(projectId, field, value);
            }
        }

        function handleConfigSelectWithCustom(projectId, configType, field, selectId, inputId, value) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                // Chiama la funzione di update appropriata
                const updateFnMap = {
                    'persiane': updateConfigPersiane,
                    'tapparelle': updateConfigTapparelle,
                    'zanzariere': updateConfigZanzariere,
                    'cassonetti': updateConfigCassonetti
                };
                const updateFn = updateFnMap[configType];
                if (updateFn) {
                    updateFn(projectId, field, value);
                }
            }
        }

        function handleProductSelectWithCustom(projectId, posId, productType, field, selectId, inputId, value) {
            const select = document.getElementById(selectId);
            const input = document.getElementById(inputId);
            
            if (!select || !input) return;
            
            if (value === '__ALTRO__') {
                // Mostra input personalizzato
                input.style.display = 'block';
                input.focus();
            } else if (value) {
                // Opzione standard selezionata
                input.style.display = 'none';
                input.value = '';
                updateProduct(projectId, posId, productType, field, value);
            }
        }

        // Notification System
        function showNotification(message, type = 'info') {
            const colors = {
                success: 'bg-green-100 text-green-800 border-green-300',
                error: 'bg-red-100 text-red-800 border-red-300',
                info: 'bg-blue-100 text-blue-800 border-blue-300'
            };
            
            const notification = document.createElement('div');
            notification.className = `notification ${colors[type]} border-2`;
            notification.innerHTML = `<strong>${message}</strong>`;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => document.body.removeChild(notification), 300);
            }, 2000);
        }

        // üéØ FASE 18A - SISTEMA VALIDAZIONE MISURE
        function validateMisure(project, pos) {
            const errors = [];
            const warnings = [];
            
            const misure = pos.misure || {};
            
            // Prendi caratteristiche muro (override o globali)
            const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                ? pos.caratteristicheMuroOverride 
                : project.caratteristicheMuro || {};
            
            const LF = parseFloat(misure.LF) || 0;
            const HF = parseFloat(misure.HF) || 0;
            const LVT = parseFloat(misure.LVT) || 0;
            const HVT = parseFloat(misure.HVT) || 0;
            const TMV = parseFloat(misure.TMV) || 0;
            const HMT = parseFloat(misure.HMT) || 0;
            
            const LT = parseFloat(cm.telaioLarghezza) || 0;
            
            // Calcola ARIA
            let ARIA = 0;
            if (cm.falsoEsistente === 'si') {
                ARIA = parseFloat(cm.distanzaFalsoInfisso) || 0;
            } else if (cm.falsoEsistente === 'no') {
                ARIA = parseFloat(cm.distanzaMuroInfisso) || 0;
            }
            
            // Calcola SPESSORE_FALSO
            const SPESSORE_FALSO = cm.falsoEsistente === 'si' ? (parseFloat(cm.spessoreFalso) || 0) : 0;
            
            // 1. LF >= LVT (Luce Foro deve essere >= Luce Vano Telaio)
            if (LF > 0 && LVT > 0) {
                if (LF < LVT) {
                    errors.push({
                        field: 'LF',
                        message: `LF (${LF}) deve essere ‚â• LVT (${LVT})`
                    });
                }
            }
            
            // 2. HF >= HVT (Altezza Foro deve essere >= Altezza Vano Telaio)
            if (HF > 0 && HVT > 0) {
                if (HF < HVT) {
                    errors.push({
                        field: 'HF',
                        message: `HF (${HF}) deve essere ‚â• HVT (${HVT})`
                    });
                }
            }
            
            // 3. HVT + LT <= HMT
            if (HVT > 0 && LT > 0 && HMT > 0) {
                if (HVT + LT > HMT) {
                    errors.push({
                        field: 'HMT',
                        message: `HMT (${HMT}) deve essere ‚â• HVT (${HVT}) + LT (${LT}) = ${HVT + LT}`
                    });
                }
            }
            
            // 4. TMV >= LF (Telaio Montante Verticale deve contenere la Luce Foro)
            if (LF > 0 && TMV > 0) {
                if (TMV < LF) {
                    errors.push({
                        field: 'TMV',
                        message: `TMV (${TMV}) deve essere ‚â• LF (${LF})`
                    });
                }
            }
            
            // 5. HMT >= HF (Altezza Montante Telaio deve contenere l'Altezza Foro)
            if (HF > 0 && HMT > 0) {
                if (HMT < HF) {
                    errors.push({
                        field: 'HMT',
                        message: `HMT (${HMT}) deve essere ‚â• HF (${HF})`
                    });
                }
            }
            
            // 6. LVT + ((LT + ARIA + SPESSORE_FALSO)*2) <= TMV
            if (LVT > 0 && LT > 0 && TMV > 0) {
                const calcolato = LVT + ((LT + ARIA + SPESSORE_FALSO) * 2);
                if (calcolato > TMV) {
                    errors.push({
                        field: 'TMV',
                        message: `TMV (${TMV}) deve essere ‚â• LVT (${LVT}) + [(LT (${LT}) + ARIA (${ARIA}) + FALSO (${SPESSORE_FALSO})) √ó 2] = ${calcolato.toFixed(1)}`
                    });
                } else if (calcolato > TMV * 0.95) {
                    warnings.push({
                        field: 'TMV',
                        message: `TMV vicino al limite: calcolato ${calcolato.toFixed(1)} / max ${TMV}`
                    });
                }
            }
            
            // Warnings per valori sospetti
            if (LF > 0 && LF < 300) {
                warnings.push({
                    field: 'LF',
                    message: 'LF molto piccolo (< 300mm)'
                });
            }
            if (LF > 3000) {
                warnings.push({
                    field: 'LF',
                    message: 'LF molto grande (> 3000mm)'
                });
            }
            if (HF > 0 && HF < 300) {
                warnings.push({
                    field: 'HF',
                    message: 'HF molto piccolo (< 300mm)'
                });
            }
            if (HF > 3000) {
                warnings.push({
                    field: 'HF',
                    message: 'HF molto grande (> 3000mm)'
                });
            }
            
            // üõ°Ô∏è Filtra gli errori che hanno un override manuale confermato
            const filteredErrors = errors.filter(error => {
                return !(pos.validationOverrides && pos.validationOverrides[error.field]);
            });
            
            return { 
                errors: filteredErrors, 
                warnings, 
                isValid: filteredErrors.length === 0 
            };
        }

        function getFieldValidationClass(project, pos, fieldName) {
            // üõ°Ô∏è Controlla se c'√® un override manuale per questo campo
            if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
                return 'input-overridden'; // Verde con badge confermato
            }
            
            const validation = validateMisure(project, pos);
            
            const hasError = validation.errors.some(e => e.field === fieldName);
            const hasWarning = validation.warnings.some(w => w.field === fieldName);
            
            const misure = pos.misure || {};
            const value = parseFloat(misure[fieldName]) || 0;
            
            if (hasError) return 'input-error';
            if (hasWarning) return 'input-warning';
            if (value > 0) return 'input-valid';
            
            return '';
        }

        function getFieldValidationMessage(project, pos, fieldName) {
            // üõ°Ô∏è Se c'√® un override manuale, mostra il badge CONFERMATO
            if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
                return `
                    <div class="validation-message success">
                        ‚úÖ CONFERMATO (manuale)
                        <button 
                            class="btn-override-cancel" 
                            onclick="cancelValidationOverride('${project.id}', '${pos.id}', '${fieldName}')"
                            title="Annulla conferma manuale">
                            ‚úï Annulla
                        </button>
                    </div>
                `;
            }
            
            const validation = validateMisure(project, pos);
            
            const error = validation.errors.find(e => e.field === fieldName);
            if (error) {
                return `
                    <div class="validation-message error">
                        üî¥ ${error.message}
                        <button 
                            class="btn-override-confirm" 
                            onclick="confirmValidationOverride('${project.id}', '${pos.id}', '${fieldName}')"
                            title="Ho verificato, la misura √® corretta">
                            ‚úì Conferma OK
                        </button>
                    </div>
                `;
            }
            
            const warning = validation.warnings.find(w => w.field === fieldName);
            if (warning) {
                return `<div class="validation-message warning">üü° ${warning.message}</div>`;
            }
            
            const misure = pos.misure || {};
            const value = parseFloat(misure[fieldName]) || 0;
            if (value > 0) {
                return `<div class="validation-message success">‚úÖ OK</div>`;
            }
            
            return '';
        }

        // üõ°Ô∏è OVERRIDE VALIDAZIONE MANUALE - Conferma che una misura √® corretta
        function confirmValidationOverride(projectId, posId, fieldName) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            // Inizializza l'oggetto validationOverrides se non esiste
            if (!pos.validationOverrides) {
                pos.validationOverrides = {};
            }
            
            // Salva la conferma per questo campo
            pos.validationOverrides[fieldName] = {
                confirmed: true,
                timestamp: new Date().toISOString(),
                value: pos.misure ? pos.misure[fieldName] : null
            };
            
            saveState();
            render();
        }

        // üõ°Ô∏è OVERRIDE VALIDAZIONE MANUALE - Annulla la conferma manuale
        function cancelValidationOverride(projectId, posId, fieldName) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            const pos = project.positions.find(p => p.id === posId);
            if (!pos) return;
            
            // Rimuovi l'override per questo campo
            if (pos.validationOverrides && pos.validationOverrides[fieldName]) {
                delete pos.validationOverrides[fieldName];
                
                // Se non ci sono pi√π override, rimuovi l'oggetto intero
                if (Object.keys(pos.validationOverrides).length === 0) {
                    delete pos.validationOverrides;
                }
            }
            
            saveState();
            render();
        }

        // üìã RILIEVO PREESISTENTE - Gestione e Validazione
        function updateRilievo(projectId, posId, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.rilievo) {
                        pos.rilievo = {
                            togliere: false,
                            smaltimento: false,
                            materiale: '',
                            coprifiliInt: false,
                            coprifiliEst: false,
                            note: ''
                        };
                    }
                    
                    // Gestione checkbox (boolean)
                    if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                        pos.rilievo[field] = value === true || value === 'true';
                    } else {
                        pos.rilievo[field] = value;
                    }
                    
                    saveState();
                    render();
                }
            }
        }

        // üÜï CALCOLA COMPLETEZZA PER SINGOLO PRODOTTO
        function calculateRilievoCompletenessForProduct(pos, productType) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const rilievo = pos[rilievoKey];
            
            if (!rilievo) return { percentage: 0, completed: 0, total: productType === 'infissi' ? 5 : 3 };
            
            let completed = 0;
            const hasCoprifili = productType === 'infissi';
            const total = hasCoprifili ? 5 : 3; // infissi: 5 campi | altri: 3 campi
            
            // Conta i campi compilati
            if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
            if (rilievo.togliere !== undefined && rilievo.togliere !== null) completed++;
            if (rilievo.smaltimento !== undefined && rilievo.smaltimento !== null) completed++;
            
            if (hasCoprifili) {
                if (rilievo.coprifiliInt !== undefined && rilievo.coprifiliInt !== null) completed++;
                if (rilievo.coprifiliEst !== undefined && rilievo.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            return { percentage, completed, total };
        }

        function getRilievoStatusForProduct(pos, productType) {
            const completeness = calculateRilievoCompletenessForProduct(pos, productType);
            
            if (completeness.percentage === 0) {
                return { icon: '‚ö™', color: 'gray', text: 'NON INIZIATO', badge: 'bg-gray-500' };
            } else if (completeness.percentage < 50) {
                return { icon: 'üî¥', color: 'red', text: 'INCOMPLETO', badge: 'bg-red-500' };
            } else if (completeness.percentage < 100) {
                return { icon: 'üü°', color: 'amber', text: 'PARZIALE', badge: 'bg-amber-500' };
            } else {
                return { icon: 'üü¢', color: 'green', text: 'COMPLETO', badge: 'bg-green-500' };
            }
        }
        
        // üÜï CALCOLA COMPLETEZZA MEDIA DI UNA POSIZIONE (tutti i prodotti)
        function calculateRilievoCompleteness(pos) {
            // Questa funzione mantiene il nome originale per retrocompatibilit√†
            // Calcola la media di completezza di tutti i prodotti nella posizione
            const project = state.projects.find(p => p.positions.some(position => position.id === pos.id));
            if (!project) return { percentage: 0, completed: 0, total: 0 };
            
            const prodotti = ['infissi', 'persiane', 'tapparelle', 'zanzariere', 'cassonetti'];
            const prodottiAttivi = prodotti.filter(p => project.prodotti?.[p]);
            
            if (prodottiAttivi.length === 0) return { percentage: 0, completed: 0, total: 0 };
            
            let totalPercentage = 0;
            let totalCompleted = 0;
            let totalFields = 0;
            
            prodottiAttivi.forEach(productType => {
                const comp = calculateRilievoCompletenessForProduct(pos, productType);
                totalPercentage += comp.percentage;
                totalCompleted += comp.completed;
                totalFields += comp.total;
            });
            
            const avgPercentage = Math.round(totalPercentage / prodottiAttivi.length);
            return { percentage: avgPercentage, completed: totalCompleted, total: totalFields };
        }

        function getRilievoStatus(pos) {
            const completeness = calculateRilievoCompleteness(pos);
            
            if (completeness.percentage === 0) {
                return { icon: '‚ö™', color: 'gray', text: 'NON INIZIATO', badge: 'bg-gray-500' };
            } else if (completeness.percentage < 50) {
                return { icon: 'üî¥', color: 'red', text: 'INCOMPLETO', badge: 'bg-red-500' };
            } else if (completeness.percentage < 100) {
                return { icon: 'üü°', color: 'amber', text: 'PARZIALE', badge: 'bg-amber-500' };
            } else {
                return { icon: 'üü¢', color: 'green', text: 'COMPLETO', badge: 'bg-green-500' };
            }
        }

        // üÜï FASE 013 (28 OTT 2025) - Calcolo completamento posizione base
        // Controlla: nome, ambiente, prodotti enabled, misure compilate
        // ‚úÖ Foto NON necessarie | ‚úÖ Prodotti OBBLIGATORI | ‚úÖ Misure anche "0" valide
        // üÜï FASE 014 - Calcolo completamento basato su TUTTI i prodotti del progetto
        function calculatePositionCompleteness(pos, project) {
            let score = 0;
            const missing = [];
            
            // 1. Nome posizione (20 punti)
            if (pos.name && pos.name.trim() !== '') {
                score += 20;
            } else {
                missing.push('Nome posizione');
            }
            
            // 2. Ambiente (20 punti)
            if (pos.ambiente && pos.ambiente.trim() !== '') {
                score += 20;
            } else {
                missing.push('Ambiente');
            }
            
            // üîß FASE 014 FIX: Controlla TUTTI i prodotti abilitati nel PROGETTO
            // Non solo quelli presenti nella posizione!
            const mapProdotti = {
                'infissi': 'infisso',
                'persiane': 'persiana', 
                'tapparelle': 'tapparella',
                'zanzariere': 'zanzariera',
                'cassonetti': 'cassonetto'
            };
            
            // Ottieni prodotti abilitati nel progetto
            const prodottiProgetto = [];
            if (project?.prodotti) {
                Object.keys(project.prodotti).forEach(tipo => {
                    if (project.prodotti[tipo] === true) {
                        prodottiProgetto.push(mapProdotti[tipo]);
                    }
                });
            }
            
            // Se non ci sono prodotti nel progetto, √® un problema
            if (prodottiProgetto.length === 0) {
                missing.push('Nessun prodotto configurato nel progetto');
                return {
                    percentage: score,
                    isComplete: false,
                    missing: missing,
                    enabledProducts: 0
                };
            }
            
            // 3. Verifica TUTTI i prodotti del progetto (30 punti)
            const prodottiPresenti = [];
            const prodottiAssenti = pos.prodottiAssenti || [];
            const prodottiMancanti = [];
            
            prodottiProgetto.forEach(tipo => {
                const hasProdotto = pos[tipo] && typeof pos[tipo] === 'object';
                const isDichiaratoAssente = prodottiAssenti.includes(tipo);
                
                if (hasProdotto) {
                    prodottiPresenti.push(tipo);
                } else if (isDichiaratoAssente) {
                    // OK: dichiarato come non presente in questa posizione
                } else {
                    // MANCANTE: n√© presente n√© dichiarato assente
                    prodottiMancanti.push(tipo);
                }
            });
            
            // Calcola punteggio prodotti
            const prodottiOk = prodottiPresenti.length + prodottiAssenti.length;
            const percentualeProdotti = prodottiProgetto.length > 0 ? (prodottiOk / prodottiProgetto.length) : 0;
            score += Math.round(30 * percentualeProdotti);
            
            if (prodottiMancanti.length > 0) {
                missing.push(`Prodotti mancanti (${prodottiOk}/${prodottiProgetto.length}): ${prodottiMancanti.join(', ')}`);
            }
            
            // 4. Misure compilate (30 punti) - solo per prodotti PRESENTI
            if (prodottiPresenti.length > 0) {
                let misureOk = 0;
                let prodottiConMisureMancanti = [];
                
                prodottiPresenti.forEach(tipo => {
                    const prod = pos[tipo];
                    // Controlla che BRM_L e BRM_H siano compilate (anche "0" va bene)
                    const hasLarghezza = prod.BRM_L !== undefined && prod.BRM_L !== null && prod.BRM_L !== '';
                    const hasAltezza = prod.BRM_H !== undefined && prod.BRM_H !== null && prod.BRM_H !== '';
                    
                    if (hasLarghezza && hasAltezza) {
                        misureOk++;
                    } else {
                        prodottiConMisureMancanti.push(tipo);
                    }
                });
                
                if (misureOk === prodottiPresenti.length) {
                    score += 30;
                } else {
                    const parziale = Math.round(30 * (misureOk / prodottiPresenti.length));
                    score += parziale;
                    missing.push(`Misure incomplete (${misureOk}/${prodottiPresenti.length}): ${prodottiConMisureMancanti.join(', ')}`);
                }
            } else {
                // Nessun prodotto presente: punti misure gi√† assegnati nella sezione prodotti
                // Non aggiungere punti doppi!
            }
            
            return {
                percentage: score,
                isComplete: score === 100,
                missing: missing,
                enabledProducts: prodottiProgetto.length,
                prodottiPresenti: prodottiPresenti.length,
                prodottiAssenti: prodottiAssenti.length
            };
        }

        // üÜï FASE 014 - Toggle prodotto assente/presente in posizione
        function toggleProdottoAssente(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (!project || !pos) return;
            
            // Inizializza array se non esiste
            if (!pos.prodottiAssenti) {
                pos.prodottiAssenti = [];
            }
            
            const mapProdotti = {
                'infissi': 'infisso',
                'persiane': 'persiana',
                'tapparelle': 'tapparella',
                'zanzariere': 'zanzariera',
                'cassonetti': 'cassonetto'
            };
            
            const prodottoSingolare = mapProdotti[productType];
            const index = pos.prodottiAssenti.indexOf(prodottoSingolare);
            
            if (index > -1) {
                // Era assente, rimuovi (ora deve essere presente)
                pos.prodottiAssenti.splice(index, 1);
            } else {
                // Era presente (o non dichiarato), marca come assente
                pos.prodottiAssenti.push(prodottoSingolare);
                
                // Se c'era il prodotto fisico, rimuovilo
                if (pos[prodottoSingolare]) {
                    delete pos[prodottoSingolare];
                }
            }
            
            saveState();
            render();
        }

        // üÜï FASE 013 - Helper per status badge completamento posizione
        // üîß FASE 014 - Aggiunto parametro project
        function getPositionCompletenessStatus(pos, project) {
            const comp = calculatePositionCompleteness(pos, project);
            
            if (comp.percentage === 100) {
                return { 
                    icon: 'üü¢', 
                    color: 'green', 
                    text: '100% ‚úÖ', 
                    badge: 'bg-green-500',
                    comp: comp 
                };
            } else if (comp.percentage >= 70) {
                return { 
                    icon: 'üü°', 
                    color: 'amber', 
                    text: `${comp.percentage}% ‚ö†Ô∏è`, 
                    badge: 'bg-amber-500',
                    comp: comp 
                };
            } else if (comp.percentage > 0) {
                return { 
                    icon: 'üü†', 
                    color: 'orange', 
                    text: `${comp.percentage}% ‚ö†Ô∏è`, 
                    badge: 'bg-orange-500',
                    comp: comp 
                };
            } else {
                return { 
                    icon: 'üî¥', 
                    color: 'red', 
                    text: '0% ‚ùå', 
                    badge: 'bg-red-500',
                    comp: comp 
                };
            }
        }

        // üÜï FASE 13 - Gestione Rilievo Globale per Prodotti
        // üÜï FASE 014 - Sincronizzazione Intelligente Globale ‚Üí Posizioni
        function updateRilievoGlobale(projectId, productType, field, value) {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                if (!project[rilievoKey]) {
                    project[rilievoKey] = {
                        materiale: '',
                        note: '',
                        togliere: false,
                        smaltimento: false
                    };
                    
                    // Aggiungi coprifili solo per infissi
                    if (productType === 'infissi') {
                        project[rilievoKey].coprifiliInt = false;
                        project[rilievoKey].coprifiliEst = false;
                    }
                }
                
                // üîç FASE 014 - Salva valore precedente per sync intelligente
                const previousValue = project[rilievoKey][field];
                
                // Gestione checkbox (boolean)
                if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                    project[rilievoKey][field] = value === true || value === 'true';
                } else {
                    project[rilievoKey][field] = value;
                }
                
                // üîÑ FASE 014 - Sincronizzazione Intelligente alle posizioni
                // Aggiorna SOLO posizioni che hanno ancora il valore precedente del globale
                // (= non sono state personalizzate)
                if (project.positions && project.positions.length > 0) {
                    let syncCount = 0;
                    let createdCount = 0;
                    
                    project.positions.forEach(pos => {
                        // üÜï FIX: Se la posizione NON ha questo tipo di rilievo, CREALO con valori globali
                        if (!pos[rilievoKey]) {
                            pos[rilievoKey] = {
                                materiale: project[rilievoKey].materiale || '',
                                note: project[rilievoKey].note || '',
                                togliere: project[rilievoKey].togliere || false,
                                smaltimento: project[rilievoKey].smaltimento || false
                            };
                            
                            // Aggiungi coprifili solo per infissi
                            if (productType === 'infissi') {
                                pos[rilievoKey].coprifiliInt = project[rilievoKey].coprifiliInt || false;
                                pos[rilievoKey].coprifiliEst = project[rilievoKey].coprifiliEst || false;
                            }
                            
                            createdCount++;
                        } else {
                            // Se il campo esiste, controlla se sincronizzare
                            const posValue = pos[rilievoKey][field];
                            
                            // Se il valore della posizione corrisponde al vecchio valore globale
                            // significa che NON √® stato personalizzato ‚Üí AGGIORNA
                            if (posValue === previousValue) {
                                pos[rilievoKey][field] = project[rilievoKey][field];
                                syncCount++;
                            }
                            // Altrimenti skip: √® una personalizzazione dell'utente
                        }
                    });
                    
                    // Log per debug (opzionale - pu√≤ essere rimosso in produzione)
                    if (createdCount > 0) {
                        console.log(`üÜï INIT: ${createdCount} posizioni inizializzate con valori globali ${productType}`);
                    }
                    if (syncCount > 0) {
                        console.log(`‚úÖ SYNC: ${syncCount} posizioni aggiornate per ${productType}.${field}`);
                    }
                }
                
                saveState();
                render();
            }
        }

        // üÜï FASE 027 - toggleMaterialeMode e toggleMaterialePosMode RIMOSSE: usa renderSelectWithCustom standard

        // üÜï FASE 027 - toggleAmbienteMode RIMOSSA: usa renderSelectWithCustom standard

        function copiaRilievoDaGlobale(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                // Copia dal rilievo globale infissi (default)
                const rilievoGlobale = getRilievoGlobale(project, 'infissi');
                
                // Inizializza pos.rilievo se non esiste
                if (!pos.rilievo) {
                    pos.rilievo = {
                        togliere: false,
                        smaltimento: false,
                        materiale: '',
                        coprifiliInt: false,
                        coprifiliEst: false,
                        note: ''
                    };
                }
                
                // Copia i valori
                pos.rilievo.materiale = rilievoGlobale.materiale || '';
                pos.rilievo.note = rilievoGlobale.note || '';
                pos.rilievo.togliere = rilievoGlobale.togliere || false;
                pos.rilievo.smaltimento = rilievoGlobale.smaltimento || false;
                pos.rilievo.coprifiliInt = rilievoGlobale.coprifiliInt || false;
                pos.rilievo.coprifiliEst = rilievoGlobale.coprifiliEst || false;
                
                saveState();
                render();
                
                alert('‚úÖ Dati copiati dal rilievo globale!');
            }
        }

        function updateRilievoProdotto(projectId, posId, productType, field, value) {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                // üÜï FASE 014 - Inizializza rilievo con valori globali se non esiste
                if (!pos[rilievoKey]) {
                    const rilievoGlobale = getRilievoGlobale(project, productType);
                    
                    pos[rilievoKey] = {
                        materiale: rilievoGlobale.materiale || '',
                        note: rilievoGlobale.note || '',
                        togliere: rilievoGlobale.togliere || false,
                        smaltimento: rilievoGlobale.smaltimento || false
                    };
                    
                    // Aggiungi coprifili solo per infissi
                    if (productType === 'infissi') {
                        pos[rilievoKey].coprifiliInt = rilievoGlobale.coprifiliInt || false;
                        pos[rilievoKey].coprifiliEst = rilievoGlobale.coprifiliEst || false;
                    }
                }
                
                // Gestione checkbox (boolean)
                if (field === 'togliere' || field === 'smaltimento' || field === 'coprifiliInt' || field === 'coprifiliEst') {
                    pos[rilievoKey][field] = value === true || value === 'true';
                } else {
                    pos[rilievoKey][field] = value;
                }
                
                saveState();
                render();
            }
        }

        function copiaRilievoDaGlobaleProdotto(projectId, posId, productType) {
            const project = state.projects.find(p => p.id === projectId);
            const pos = project?.positions.find(p => p.id === posId);
            
            if (project && pos) {
                const rilievoGlobale = getRilievoGlobale(project, productType);
                const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                
                // Inizializza pos.rilievo se non esiste
                if (!pos[rilievoKey]) {
                    pos[rilievoKey] = {
                        materiale: '',
                        note: '',
                        togliere: false,
                        smaltimento: false
                    };
                    
                    if (productType === 'infissi') {
                        pos[rilievoKey].coprifiliInt = false;
                        pos[rilievoKey].coprifiliEst = false;
                    }
                }
                
                // Copia i valori
                pos[rilievoKey].materiale = rilievoGlobale.materiale || '';
                pos[rilievoKey].note = rilievoGlobale.note || '';
                pos[rilievoKey].togliere = rilievoGlobale.togliere || false;
                pos[rilievoKey].smaltimento = rilievoGlobale.smaltimento || false;
                
                if (productType === 'infissi') {
                    pos[rilievoKey].coprifiliInt = rilievoGlobale.coprifiliInt || false;
                    pos[rilievoKey].coprifiliEst = rilievoGlobale.coprifiliEst || false;
                }
                
                saveState();
                render();
                
                alert('‚úÖ Dati copiati dal rilievo globale!');
            }
        }

        // üÜï FASE 027 - toggleMaterialeProdottoMode RIMOSSA: usa renderSelectWithCustom standard

        function getRilievoGlobale(project, productType) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            return project[rilievoKey] || {};
        }

        function calculateRilievoGlobaleCompleteness(project, productType) {
            const rilievo = getRilievoGlobale(project, productType);
            let completed = 0;
            let total = 3; // materiale, togliere, smaltimento (campo "preesistente" ELIMINATO in FASE 13a)
            
            // Per infissi ci sono anche i coprifili
            if (productType === 'infissi') {
                total = 5; // + coprifiliInt, coprifiliEst
            }
            
            // Conta i campi compilati (campo "preesistente" ELIMINATO in FASE 13a)
            if (rilievo.materiale && rilievo.materiale.trim() !== '') completed++;
            if (rilievo.togliere !== undefined && rilievo.togliere !== null) completed++;
            if (rilievo.smaltimento !== undefined && rilievo.smaltimento !== null) completed++;
            
            if (productType === 'infissi') {
                if (rilievo.coprifiliInt !== undefined && rilievo.coprifiliInt !== null) completed++;
                if (rilievo.coprifiliEst !== undefined && rilievo.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            return { percentage, completed, total };
        }

        // BRM Calculator
        function calculateBRM(project, pos, misure, brmConfig, tipo = null) {
            if (!brmConfig) {
                return { L: null, H: null, C: null, B: null };
            }
            
            // Determina se √® portafinestra in base al tipo
            const isPortafinestra = tipo && (tipo.includes('PF') || tipo.toUpperCase().includes('PF'));
            
            // Funzione helper per calcolare formule composite
            const calcolaMisura = (formula, misure) => {
                if (!formula) return null;
                
                // Rimuovi tutti gli spazi dalla formula
                formula = formula.replace(/\s+/g, '');
                
                // Se la formula contiene "+" significa che √® una somma di pi√π misure
                if (formula.includes('+')) {
                    const parti = formula.split('+').map(p => p.trim());
                    let totale = 0;
                    for (const parte of parti) {
                        const valore = parseFloat(misure[parte]);
                        if (!isNaN(valore)) {
                            totale += valore;
                        }
                    }
                    return totale;
                }
                // Altrimenti √® una singola misura
                const valore = parseFloat(misure[formula]);
                return isNaN(valore) ? null : valore;
            };
            
            // Calcola L separatamente - usa _PF se √® portafinestra e disponibile
            let L = null;
            const misuraBaseLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'misuraBaseL_PF' : 'misuraBaseL';
            const operazioneLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'operazioneL_PF' : 'operazioneL';
            const valoreLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'valoreL_PF' : 'valoreL';
            
            if (brmConfig[misuraBaseLKey]) {
                const baseL = calcolaMisura(brmConfig[misuraBaseLKey], misure);
                if (baseL !== null) {
                    const valoreL = parseFloat(brmConfig[valoreLKey]) || 0;
                    if (brmConfig[operazioneLKey] === '+') {
                        L = baseL + valoreL;
                    } else {
                        L = baseL - valoreL;
                    }
                }
            }
            
            // Calcola H separatamente - usa _PF se √® portafinestra e disponibile
            let H = null;
            const misuraBaseHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'misuraBaseH_PF' : 'misuraBaseH';
            const operazioneHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'operazioneH_PF' : 'operazioneH';
            const valoreHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'valoreH_PF' : 'valoreH';
            
            if (brmConfig[misuraBaseHKey]) {
                const baseH = calcolaMisura(brmConfig[misuraBaseHKey], misure);
                if (baseH !== null) {
                    const valoreH = parseFloat(brmConfig[valoreHKey]) || 0;
                    if (brmConfig[operazioneHKey] === '+') {
                        H = baseH + valoreH;
                    } else {
                        H = baseH - valoreH;
                    }
                }
            }
            
            // Calcola C separatamente (per cassonetti)
            let C = null;
            if (brmConfig.misuraBaseC) {
                const baseC = calcolaMisura(brmConfig.misuraBaseC, misure);
                if (baseC !== null) {
                    const valoreC = parseFloat(brmConfig.valoreC) || 0;
                    if (brmConfig.operazioneC === '+') {
                        C = baseC + valoreC;
                    } else {
                        C = baseC - valoreC;
                    }
                }
            }
            
            // Calcola B separatamente (per cassonetti)
            let B = null;
            if (brmConfig.misuraBaseB) {
                const baseB = calcolaMisura(brmConfig.misuraBaseB, misure);
                if (baseB !== null) {
                    const valoreB = parseFloat(brmConfig.valoreB) || 0;
                    if (brmConfig.operazioneB === '+') {
                        B = baseB + valoreB;
                    } else {
                        B = baseB - valoreB;
                    }
                }
            }
            
            return { L, H, C, B };
        }

        // Project Management
        function createProject(name, client) {
            const project = {
                id: generateId(),
                name,
                client,
                clientData: {},
                prodotti: {},
                caratteristicheMuro: {},
                configInfissi: {},
                configPersiane: {},
                configCassonetti: {
                    tipo: '',
                    azienda: '',
                    colore: ''
                },
                configTapparelle: {},
                configZanzariere: {
                    azienda: '',
                    modelloPF: '',
                    modelloF: '',
                    colore: ''
                },
                brmConfigInfissi: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigPersiane: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigTapparelle: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigZanzariere: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    note: '' 
                },
                brmConfigCassonetti: { 
                    misuraBaseL: '', operazioneL: '-', valoreL: '0',
                    misuraBaseH: '', operazioneH: '-', valoreH: '0',
                    misuraBaseC: '', operazioneC: '-', valoreC: '0',
                    misuraBaseB: '', operazioneB: '-', valoreB: '0',
                    note: '',
                    SRSX: '0',
                    SRDX: '0',
                    ZSX: '0',
                    ZDX: '0'
                },
                positions: [],
                createdAt: new Date().toISOString(),
                // ‚úÖ SOLUZIONE C: Metadata per tracking e sincronizzazione
                metadata: initMetadata()
            };
            state.projects.push(project);
            state.currentProject = project.id;
            state.setupStep = 1;
            saveState();
            return project;
        }

        function deleteProject(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Chiedi conferma con il nome del progetto
            const confirmMessage = `Sei sicuro di voler eliminare il progetto "${project.name}" (Cliente: ${project.client})?\n\nQuesta azione √® IRREVERSIBILE e canceller√†:\n- Tutte le ${project.positions.length} posizioni\n- Tutti i dati e le configurazioni\n- Tutte le foto associate`;
            
            if (!confirm(confirmMessage)) {
                return; // Annullato dall'utente
            }
            
            // Rimuovi il progetto dall'array
            const index = state.projects.findIndex(p => p.id === projectId);
            if (index !== -1) {
                state.projects.splice(index, 1);
                
                // Se era il progetto corrente, resetta
                if (state.currentProject === projectId) {
                    state.currentProject = null;
                    state.screen = 'list';
                }
                
                saveState();
                showNotification('Progetto eliminato con successo', 'success');
                render();
            }
        }

        function addPosition(projectId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                // üÜï FASE 014 - Copia valori globali per nuova posizione
                const rilievoGlobaleInfissi = getRilievoGlobale(project, 'infissi');
                
                const pos = {
                    id: generateId(),
                    name: `Pos. ${project.positions.length + 1}`,
                    piano: project.clientData?.piano || '',
                    ambiente: '',
                    quantita: '1',
                    misure: {},
                    // üìã FASE 014: Inizializza con valori globali se esistono
                    rilievo: {
                        togliere: rilievoGlobaleInfissi.togliere || false,
                        smaltimento: rilievoGlobaleInfissi.smaltimento || false,
                        materiale: rilievoGlobaleInfissi.materiale || '',
                        coprifiliInt: rilievoGlobaleInfissi.coprifiliInt || false,
                        coprifiliEst: rilievoGlobaleInfissi.coprifiliEst || false,
                        note: rilievoGlobaleInfissi.note || ''
                    },
                    infissi: [],
                    persiane: [],
                    cassonetti: [],
                    tapparelle: [],
                    zanzariere: [],
                    foto: [],
                    note: '',
                    noteVisibilita: []
                };
                project.positions.push(pos);
                // ‚úÖ SOLUZIONE C: Track modifica
                updateProjectTimestamp(projectId, 'addPosition', `Aggiunta posizione: ${pos.name}`);
                saveState();
                state.currentPosition = pos.id;
                showNotification('Posizione aggiunta', 'success');
                render();
            }
        }

        // Product Management Functions
        function addInfisso(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // Verifica se la config √® vuota
                    const configVuota = !project.configInfissi || Object.keys(project.configInfissi).length === 0;
                    const configHaValori = project.configInfissi && (
                        project.configInfissi.azienda ||
                        project.configInfissi.telaio ||
                        project.configInfissi.coloreInt ||
                        (project.configInfissi.codTagli && project.configInfissi.codTagli.length > 0)
                    );
                    
                    if (configVuota || !configHaValori) {
                        console.warn('‚ö†Ô∏è CONFIG GLOBALE INFISSI VUOTA!');
                        console.log('üí° SUGGERIMENTO: Imposta prima la Config Globale, poi aggiungi le posizioni.');
                        console.log('   Oppure usa il pulsante SINCRONIZZA TUTTO dopo aver configurato.');
                    }
                    
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi);
                    // UN SOLO INFISSO per posizione
                    pos.infisso = {
                        id: generateId(),
                        qta: '1',
                        azienda: project.configInfissi?.azienda || '',
                        finituraInt: project.configInfissi?.finituraInt || '',
                        finituraEst: project.configInfissi?.finituraEst || '',
                        coloreInt: project.configInfissi?.coloreInt || '',
                        coloreEst: project.configInfissi?.coloreEst || '',
                        tipoAnta: project.configInfissi?.tipoAnta || '',
                        telaio: project.configInfissi?.telaio || '',
                        allarme: project.configInfissi?.allarme || '',
                        vetro: project.configInfissi?.vetro || '',
                        tagliTelaio: project.configInfissi?.tagliTelaio || '',
                        codTagli: project.configInfissi?.codTagli ? [...project.configInfissi.codTagli] : [],
                        motoreAzienda: project.configInfissi?.motoreAzienda || '',
                        motoreModello: project.configInfissi?.motoreModello || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    
                    // Log per debug
                    console.log('‚ûï Infisso aggiunto:', {
                        posId: pos.id,
                        azienda: pos.infisso.azienda || '(vuoto)',
                        telaio: pos.infisso.telaio || '(vuoto)',
                        codTagli: pos.infisso.codTagli.length > 0 ? pos.infisso.codTagli : '(vuoto)'
                    });
                    
                    saveState();
                    render();
                }
            }
        }

        function addPersiana(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigPersiane);
                    // UNA SOLA PERSIANA per posizione
                    pos.persiana = {
                        id: generateId(),
                        qta: '1',
                        tipo: project.configPersiane?.tipo || '',
                        materiale: project.configPersiane?.materiale || '',
                        colore: project.configPersiane?.colore || '',
                        apertura: project.configPersiane?.apertura || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addTapparella(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigTapparelle);
                    // UNA SOLA TAPPARELLA per posizione
                    pos.tapparella = {
                        id: generateId(),
                        tipo: project.configTapparelle?.tipo || '',
                        materiale: project.configTapparelle?.materiale || '',
                        colore: project.configTapparelle?.colore || '',
                        comando: project.configTapparelle?.comando || '',
                        motoreAzienda: project.configTapparelle?.motoreAzienda || '',
                        motoreModello: project.configTapparelle?.motoreModello || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addZanzariera(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // Determina il tipo in base all'infisso presente nella posizione
                    const tipoInfisso = pos.infisso?.tipo || '';
                    const brm = calculateBRM(project, pos, pos.misure, project.brmConfigZanzariere, tipoInfisso);
                    // UNA SOLA ZANZARIERA per posizione
                    pos.zanzariera = {
                        id: generateId(),
                        tipo: project.configZanzariere?.tipo || '',
                        coloreTelaio: project.configZanzariere?.coloreTelaio || '',
                        tipoRete: project.configZanzariere?.tipoRete || '',
                        coloreRete: project.configZanzariere?.coloreRete || '',
                        BRM_L: brm.L,
                        BRM_H: brm.H,
                        note: '',
                        foto: []
                    };
                    saveState();
                    render();
                }
            }
        }

        function addCassonetto(projectId, posId) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // Prendi caratteristiche muro (override o globali)
                    const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                        ? pos.caratteristicheMuroOverride 
                        : project.caratteristicheMuro || {};
                    
                    // üîß BSuperiore: Pre-compila con Battuta Superiore con Tapparella
                    const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
                    
                    // UN SOLO CASSONETTO per posizione
                    pos.cassonetto = {
                        id: generateId(),
                        tipo: project.configCassonetti?.tipo || '',
                        materiale: project.configCassonetti?.materiale || '',
                        finitura: project.configCassonetti?.finitura || '',
                        coibentazione: project.configCassonetti?.coibentazione || '',
                        // Inizializza le misure a 0
                        LS: '0',
                        SRSX: '0',
                        ZSX: '0',
                        SRDX: '0',
                        ZDX: '0',
                        HCASS: '0',
                        B: '0',
                        C: '0',
                        BSuperiore: bSuperioreDefault, // ‚úÖ Pre-compilato con battutaSuperioreTapparella
                        BRM_L: null,
                        BRM_H: null,
                        BRM_C: null,
                        BRM_B: null,
                        note: '',
                        foto: []
                    };
                    
                    // Calcola BRM iniziale (sar√† 0 perch√© le misure sono 0)
                    const brm = calculateBRM(project, pos, pos.cassonetto, project.brmConfigCassonetti);
                    pos.cassonetto.BRM_L = brm.L;
                    pos.cassonetto.BRM_H = brm.H;
                    pos.cassonetto.BRM_C = brm.C;
                    pos.cassonetto.BRM_B = brm.B;
                    
                    saveState();
                    render();
                }
            }
        }

        function deleteProduct(projectId, posId, productType) {
            if (confirm('Sei sicuro di voler eliminare questo elemento?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos[productType]) {
                        // Elimina il singolo prodotto
                        delete pos[productType];
                        saveState();
                        render();
                    }
                }
            }
        }

        function updateProduct(projectId, posId, productType, field, value) {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    // üÜï FASE 016: qta=0 √® VALIDO - prodotto rimane visibile e modificabile
                    pos[productType][field] = value;
                    
                    // INFISSI: Se cambia tagliTelaio, RESET dei codTagli per aggiornamento immediato
                    if (productType === 'infisso' && field === 'tagliTelaio') {
                        const tagliMap = {
                            'sopra': ['SOPRA'],
                            'sotto': ['SOTTO'],
                            'dx': ['DX'],
                            'sx': ['SX'],
                            'sopra-sotto': ['SOPRA', 'SOTTO'],
                            'dx-sx': ['SX', 'DX'],
                            '4-lati': ['SOPRA', 'SOTTO', 'SX', 'DX'],
                            'sopra-laterali': ['SOPRA', 'SX', 'DX'],
                            'sotto-laterali': ['SOTTO', 'SX', 'DX']
                        };
                        // Copia i valori dalla config globale se esistono, altrimenti usa default
                        const defaultTagli = tagliMap[value] || [];
                        pos[productType].codTagli = project.configInfissi?.codTagli?.length === defaultTagli.length
                            ? [...project.configInfissi.codTagli]
                            : [...defaultTagli];
                    }
                    
                    // INFISSI: Se cambia il tipo (F1->PF1 etc), ricalcola BRM di infisso E zanzariera
                    if (productType === 'infisso' && field === 'tipo') {
                        const inf = pos.infisso;
                        // Ricalcola BRM infisso
                        if (inf.brmPersonalizzato) {
                            const brm = calculateBRM(project, pos, pos.misure, inf.brmPersonalizzato, value);
                            inf.BRM_L = brm.L;
                            inf.BRM_H = brm.H;
                        } else {
                            const brm = calculateBRM(project, pos, pos.misure, project.brmConfigInfissi, value);
                            inf.BRM_L = brm.L;
                            inf.BRM_H = brm.H;
                        }
                        
                        // Ricalcola anche BRM zanzariera se presente
                        if (pos.zanzariera) {
                            const zan = pos.zanzariera;
                            if (zan.brmPersonalizzato) {
                                const brm = calculateBRM(project, pos, pos.misure, zan.brmPersonalizzato, value);
                                zan.BRM_L = brm.L;
                                zan.BRM_H = brm.H;
                            } else {
                                const brm = calculateBRM(project, pos, pos.misure, project.brmConfigZanzariere, value);
                                zan.BRM_L = brm.L;
                                zan.BRM_H = brm.H;
                            }
                        }
                    }
                    
                    // CASSONETTI: Se cambiano le misure, ricalcola il BRM
                    const misureCassonetto = ['LS', 'SRSX', 'ZSX', 'SRDX', 'ZDX', 'HCASS', 'B', 'C', 'BSuperiore'];
                    if (productType === 'cassonetto' && misureCassonetto.includes(field)) {
                        const cas = pos.cassonetto;
                        if (cas.brmPersonalizzato) {
                            // Usa formula personalizzata
                            const brm = calculateBRM(project, pos, cas, cas.brmPersonalizzato);
                            cas.BRM_L = brm.L;
                            cas.BRM_H = brm.H;
                        } else {
                            // Usa formula globale
                            const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                            cas.BRM_L = brm.L;
                            cas.BRM_H = brm.H;
                        }
                    }
                    
                    saveState();
                    
                    // RIMOSSO: render() per evitare reload pagina dopo ogni modifica
                    // I dati sono gi√† salvati, non serve ricaricare la pagina
                    // Solo in casi specifici dove cambia la struttura HTML servirebbe,
                    // ma anche l√¨ √® meglio aggiornare solo la parte necessaria
                }
            }
        }

        // Validazione B-C per cassonetti
        function validateCassonettoBC(projectId, posId) {
            // ‚ö° FASE 024B: NO render - validazione gi√† eseguita
            // I messaggi di validazione sono gi√† nel DOM tramite validateAltezzeRealTime
        }

        // Validazione in tempo reale per le altezze (mentre scrivi)
        function validateAltezzeRealTime(projectId, posId) {
            // Leggi i valori dai campi DOM
            const hsoffEl = document.getElementById(`hsoff-${posId}`);
            const hparapSoffEl = document.getElementById(`hparapsoff-${posId}`);
            const hpavParapEl = document.getElementById(`hpavparap-${posId}`);
            const validationMsgEl = document.getElementById(`validation-msg-${posId}`);
            
            if (!hsoffEl || !hparapSoffEl || !hpavParapEl || !validationMsgEl) return;
            
            const hsoff = parseFloat(hsoffEl.value) || 0;
            const hparapSoff = parseFloat(hparapSoffEl.value) || 0;
            const hpavParap = parseFloat(hpavParapEl.value) || 0;
            
            // Reset a grigio se mancano valori
            if (hsoff === 0 || hparapSoff === 0 || hpavParap === 0) {
                hsoffEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
                hparapSoffEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
                hpavParapEl.className = 'w-full px-3 py-2 border-2 border-gray-300 rounded font-semibold';
                validationMsgEl.innerHTML = '';
                return;
            }
            
            // Calcola validazione
            const somma = hpavParap + hparapSoff;
            const diff = Math.abs(somma - hsoff);
            
            if (diff <= 10) {
                // Verde - OK
                const borderClass = 'w-full px-3 py-2 border-2 border-green-500 rounded font-semibold';
                hsoffEl.className = borderClass;
                hparapSoffEl.className = borderClass;
                hpavParapEl.className = borderClass;
                validationMsgEl.innerHTML = `
                    <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-2">
                        <p class="text-xs text-green-800">
                            ‚úÖ <strong>OK:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm ‚úì
                        </p>
                    </div>
                `;
            } else {
                // Rosso - ERRORE
                const borderClass = 'w-full px-3 py-2 border-2 border-red-500 rounded font-semibold';
                hsoffEl.className = borderClass;
                hparapSoffEl.className = borderClass;
                hpavParapEl.className = borderClass;
                validationMsgEl.innerHTML = `
                    <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-2">
                        <p class="text-xs text-red-800">
                            ‚ö†Ô∏è <strong>ERRORE:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm (>10mm!)
                        </p>
                    </div>
                `;
            }
        }

        // Personalizza BRM per questa specifica posizione
        window.personalizzaBRM = (projectId, posId, productType) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    
                    const configMap = {
                        'infisso': 'brmConfigInfissi',
                        'persiana': 'brmConfigPersiane',
                        'tapparella': 'brmConfigTapparelle',
                        'zanzariera': 'brmConfigZanzariere',
                        'cassonetto': 'brmConfigCassonetti'
                    };
                    const configKey = configMap[productType];
                    
                    // Crea brmPersonalizzato copiando la config globale come base
                    if (configKey && project[configKey]) {
                        const globalConfig = project[configKey];
                        product.brmPersonalizzato = {
                            misuraBaseL: globalConfig.misuraBaseL || '',
                            operazioneL: globalConfig.operazioneL || '-',
                            valoreL: globalConfig.valoreL || '0',
                            misuraBaseH: globalConfig.misuraBaseH || '',
                            operazioneH: globalConfig.operazioneH || '-',
                            valoreH: globalConfig.valoreH || '0'
                        };
                        
                        // Se √® un cassonetto, aggiungi anche C e B
                        if (productType === 'cassonetto') {
                            product.brmPersonalizzato.misuraBaseC = globalConfig.misuraBaseC || '';
                            product.brmPersonalizzato.operazioneC = globalConfig.operazioneC || '-';
                            product.brmPersonalizzato.valoreC = globalConfig.valoreC || '0';
                            product.brmPersonalizzato.misuraBaseB = globalConfig.misuraBaseB || '';
                            product.brmPersonalizzato.operazioneB = globalConfig.operazioneB || '-';
                            product.brmPersonalizzato.valoreB = globalConfig.valoreB || '0';
                        }
                        
                        // Determina il tipo per infissi e zanzariere
                        let tipo = null;
                        if (productType === 'infisso') {
                            tipo = product.tipo;
                        } else if (productType === 'zanzariera') {
                            tipo = pos.infisso?.tipo || '';
                        }
                        
                        // Ricalcola BRM con la formula personalizzata
                        const misure = (productType === 'cassonetto') ? product : pos.misure;
                        const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
                        product.BRM_L = brm.L;
                        product.BRM_H = brm.H;
                        if (productType === 'cassonetto') {
                            product.BRM_C = brm.C;
                            product.BRM_B = brm.B;
                        }
                    }
                    
                    saveState();
                    render();
                }
            }
        }

        // ‚úÖ APPLICA MODIFICHE BRM - Conferma e salva le modifiche al BRM personalizzato
        window.applicaBRMPersonalizzato = (projectId, posId, productType) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType] && pos[productType].brmPersonalizzato) {
                    const product = pos[productType];
                    
                    // ‚úÖ FIX: LEGGI I VALORI CORRENTI DAL DOM prima di salvare!
                    const misuraBaseLSelect = document.querySelector(`#brm-misuraBaseL-${productType}-${posId}`);
                    const operazioneLSelect = document.querySelector(`#brm-operazioneL-${productType}-${posId}`);
                    const valoreLInput = document.querySelector(`#brm-valoreL-${productType}-${posId}`);
                    const misuraBaseHSelect = document.querySelector(`#brm-misuraBaseH-${productType}-${posId}`);
                    const operazioneHSelect = document.querySelector(`#brm-operazioneH-${productType}-${posId}`);
                    const valoreHInput = document.querySelector(`#brm-valoreH-${productType}-${posId}`);
                    
                    // Aggiorna lo state con i valori dal DOM
                    if (misuraBaseLSelect) product.brmPersonalizzato.misuraBaseL = misuraBaseLSelect.value;
                    if (operazioneLSelect) product.brmPersonalizzato.operazioneL = operazioneLSelect.value;
                    // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                    if (valoreLInput) product.brmPersonalizzato.valoreL = Math.abs(parseFloat(valoreLInput.value) || 0).toString();
                    if (misuraBaseHSelect) product.brmPersonalizzato.misuraBaseH = misuraBaseHSelect.value;
                    if (operazioneHSelect) product.brmPersonalizzato.operazioneH = operazioneHSelect.value;
                    // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                    if (valoreHInput) product.brmPersonalizzato.valoreH = Math.abs(parseFloat(valoreHInput.value) || 0).toString();
                    
                    // Se √® un cassonetto, gestisci anche C e B
                    if (productType === 'cassonetto') {
                        const misuraBaseCSelect = document.querySelector(`#brm-misuraBaseC-${productType}-${posId}`);
                        const operazioneCSelect = document.querySelector(`#brm-operazioneC-${productType}-${posId}`);
                        const valoreCInput = document.querySelector(`#brm-valoreC-${productType}-${posId}`);
                        const misuraBaseBSelect = document.querySelector(`#brm-misuraBaseB-${productType}-${posId}`);
                        const operazioneBSelect = document.querySelector(`#brm-operazioneB-${productType}-${posId}`);
                        const valoreBInput = document.querySelector(`#brm-valoreB-${productType}-${posId}`);
                        
                        if (misuraBaseCSelect) product.brmPersonalizzato.misuraBaseC = misuraBaseCSelect.value;
                        if (operazioneCSelect) product.brmPersonalizzato.operazioneC = operazioneCSelect.value;
                        // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                        if (valoreCInput) product.brmPersonalizzato.valoreC = Math.abs(parseFloat(valoreCInput.value) || 0).toString();
                        if (misuraBaseBSelect) product.brmPersonalizzato.misuraBaseB = misuraBaseBSelect.value;
                        if (operazioneBSelect) product.brmPersonalizzato.operazioneB = operazioneBSelect.value;
                        // ‚úÖ FIX: Converti il valore in positivo (valore assoluto)
                        if (valoreBInput) product.brmPersonalizzato.valoreB = Math.abs(parseFloat(valoreBInput.value) || 0).toString();
                    }
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Ricalcola BRM con i nuovi valori
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
                    product.BRM_L = brm.L;
                    product.BRM_H = brm.H;
                    if (productType === 'cassonetto') {
                        product.BRM_C = brm.C;
                        product.BRM_B = brm.B;
                    }
                    
                    // Salva lo stato
                    saveState();
                    
                    // Fai un render completo per consolidare le modifiche
                    render();
                    
                    // Mostra notifica di successo
                    if (productType === 'cassonetto') {
                        showNotification(`‚úÖ BRM salvato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm, C=${brm.C || '?'}mm, B=${brm.B || '?'}mm`, 'success');
                    } else {
                        showNotification(`‚úÖ BRM salvato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm`, 'success');
                    }
                }
            }
        }

        // Ripristina uso formula globale (elimina personalizzazione)
        window.ripristinaGlobale = (projectId, posId, productType) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    
                    // Elimina il brmPersonalizzato
                    delete product.brmPersonalizzato;
                    
                    const configMap = {
                        'infisso': 'brmConfigInfissi',
                        'persiana': 'brmConfigPersiane',
                        'tapparella': 'brmConfigTapparelle',
                        'zanzariera': 'brmConfigZanzariere',
                        'cassonetto': 'brmConfigCassonetti'
                    };
                    const configKey = configMap[productType];
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Ricalcola BRM con la config globale
                    if (configKey) {
                        const misure = (productType === 'cassonetto') ? product : pos.misure;
                        const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                        product.BRM_L = brm.L;
                        product.BRM_H = brm.H;
                        if (productType === 'cassonetto') {
                            product.BRM_C = brm.C;
                            product.BRM_B = brm.B;
                        }
                    }
                    
                    saveState();
                    render();
                }
            }
        }

        // Forza ricalcolo BRM per cassonetto (solo quando Usa Globale √® attivo)
        window.ricalcolaBRMCassonetto = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.cassonetto) {
                    const cas = pos.cassonetto;
                    
                    // Prendi caratteristiche muro (override o globali)
                    const cm = pos.overrideCaratteristiche && pos.caratteristicheMuroOverride 
                        ? pos.caratteristicheMuroOverride 
                        : project.caratteristicheMuro || {};
                    
                    // üîß BSuperiore: Pre-compila con Battuta Superiore con Tapparella
                    const bSuperioreDefault = cm.battutaSuperioreTapparella || '0';
                    
                    // Assicurati che tutte le misure esistano
                    if (!cas.LS) cas.LS = '0';
                    if (!cas.SRSX) cas.SRSX = '0';
                    if (!cas.ZSX) cas.ZSX = '0';
                    if (!cas.SRDX) cas.SRDX = '0';
                    if (!cas.ZDX) cas.ZDX = '0';
                    if (!cas.HCASS) cas.HCASS = '0';
                    if (!cas.B) cas.B = '0';
                    if (!cas.C) cas.C = '0';
                    // ‚úÖ FASE 015: Inizializza BSuperiore SOLO se mancante
                    // NON sovrascrivere '0' esplicito dell'utente!
                    if (cas.BSuperiore === undefined || cas.BSuperiore === null || cas.BSuperiore === '') {
                        // Pre-compila con battutaSuperioreTapparella se mancante
                        cas.BSuperiore = bSuperioreDefault;
                    }
                    
                    // Ricalcola BRM (solo con formula globale, non personalizzata)
                    if (!cas.brmPersonalizzato) {
                        const brm = calculateBRM(project, pos, cas, project.brmConfigCassonetti);
                        cas.BRM_L = brm.L;
                        cas.BRM_H = brm.H;
                        cas.BRM_C = brm.C;
                        cas.BRM_B = brm.B;
                        
                        saveState();
                        render();
                        showNotification('BRM ricalcolato! L=' + (cas.BRM_L || 'null') + 'mm, H=' + (cas.BRM_H || 'null') + 'mm, C=' + (cas.BRM_C || 'null') + 'mm, B=' + (cas.BRM_B || 'null') + 'mm', 'success');
                    } else {
                        showNotification('Non puoi ricalcolare BRM con formula personalizzata. Prima ripristina la formula globale.', 'error');
                    }
                }
            }
        };

        // Aggiorna formula BRM personalizzata per un prodotto
        function updateBRMPersonalizzato(projectId, posId, productType, field, value) {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos[productType]) {
                    const product = pos[productType];
                    if (!product.brmPersonalizzato) {
                        product.brmPersonalizzato = {
                            misuraBaseL: '', operazioneL: '+', valoreL: '0',
                            misuraBaseH: '', operazioneH: '+', valoreH: '0'
                        };
                    }
                    
                    // ‚úÖ FIX: Converti sempre i valori mm in positivi (valore assoluto)
                    if (field.startsWith('valore') && !isNaN(value)) {
                        value = Math.abs(parseFloat(value)).toString();
                    }
                    
                    // Salva il valore
                    product.brmPersonalizzato[field] = value;
                    
                    // Per i cassonetti, le misure sono nel cassonetto stesso
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Ricalcola BRM con la nuova formula
                    const brm = calculateBRM(project, pos, misure, product.brmPersonalizzato, tipo);
                    product.BRM_L = brm.L;
                    product.BRM_H = brm.H;
                    
                    // Salva PRIMA di aggiornare l'interfaccia
                    saveState();
                    
                    // ‚úÖ FIX: Aggiorna SOLO i valori BRM visualizzati, NON ricreare tutto il DOM
                    updateBRMDisplay(projectId, posId, productType, product);
                    
                    // Mostra una notifica con il nuovo valore BRM
                    showNotification(`BRM aggiornato! L=${brm.L || '?'}mm, H=${brm.H || '?'}mm`, 'success');
                }
            }
        }
        
        // ‚úÖ NUOVA FUNZIONE: Aggiorna solo i valori BRM visualizzati senza ricreare i dropdown
        function updateBRMDisplay(projectId, posId, productType, product) {
            // Aggiorna la formula visualizzata
            const formulaL = document.querySelector(`#formula-brm-l-${productType}-${posId}`);
            const formulaH = document.querySelector(`#formula-brm-h-${productType}-${posId}`);
            
            if (formulaL && product.brmPersonalizzato) {
                formulaL.textContent = `= ${product.brmPersonalizzato.misuraBaseL || '?'} ${product.brmPersonalizzato.operazioneL || '+'} ${product.brmPersonalizzato.valoreL || '0'}mm`;
            }
            
            if (formulaH && product.brmPersonalizzato) {
                formulaH.textContent = `= ${product.brmPersonalizzato.misuraBaseH || '?'} ${product.brmPersonalizzato.operazioneH || '+'} ${product.brmPersonalizzato.valoreH || '0'}mm`;
            }
            
            // Aggiorna i risultati BRM
            const brmLResult = document.querySelector(`#brm-l-result-${productType}-${posId}`);
            const brmHResult = document.querySelector(`#brm-h-result-${productType}-${posId}`);
            
            if (brmLResult) {
                // ‚úÖ FASE 015: Distingui 0 (valido) da mancante
                brmLResult.textContent = (product.BRM_L !== undefined && product.BRM_L !== null && product.BRM_L !== '') 
                    ? product.BRM_L 
                    : '-';
            }
            
            if (brmHResult) {
                // ‚úÖ FASE 015: Distingui 0 (valido) da mancante
                brmHResult.textContent = (product.BRM_H !== undefined && product.BRM_H !== null && product.BRM_H !== '') 
                    ? product.BRM_H 
                    : '-';
            }
        }

        // === FASE 23A: GESTIONE COD.TAGLI ===
        
        // Funzione per aggiornare la config globale degli infissi
        window.updateConfigInfissi = (projectId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi) {
                    project.configInfissi = {};
                }
                
                // Log per debug
                console.log('üîß Config Globale aggiornata:', field, '=', value);
                
                // Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configInfissi[field];
                console.log('   oldValue:', oldValue);
                
                project.configInfissi[field] = value;
                
                // Se cambia tagliTelaio, RESET immediato dei codTagli per forzare aggiornamento
                if (field === 'tagliTelaio') {
                    const tagliMap = {
                        'sopra': ['SOPRA'],
                        'sotto': ['SOTTO'],
                        'dx': ['DX'],
                        'sx': ['SX'],
                        'sopra-sotto': ['SOPRA', 'SOTTO'],
                        'dx-sx': ['SX', 'DX'],
                        '4-lati': ['SOPRA', 'SOTTO', 'SX', 'DX'],
                        'sopra-laterali': ['SOPRA', 'SX', 'DX'],
                        'sotto-laterali': ['SOTTO', 'SX', 'DX']
                    };
                    // RESET esplicito per forzare il render a mostrare i nuovi campi
                    project.configInfissi.codTagli = [...(tagliMap[value] || [])];
                    console.log('   codTagli auto-impostati:', project.configInfissi.codTagli);
                    
                    // Sincronizza codTagli con le posizioni
                    syncConfigToPositions(project, 'infisso', 'codTagli', project.configInfissi.codTagli, null);
                }
                
                // AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                console.log('   Chiamo syncConfigToPositions...');
                let posizioniAggiornate = syncConfigToPositions(project, 'infisso', field, value, oldValue);
                console.log(`   ‚úÖ ${posizioniAggiornate} posizioni sincronizzate`);
                
                saveState();
                // render(); ‚Üê RIMOSSO: Evita reload pagina, mantiene focus
            }
        };
        
        // Funzione per aggiornare un singolo COD.TAGLI globale
        window.updateCodTagliGlobale = (projectId, index, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configInfissi.codTagli) {
                    project.configInfissi.codTagli = [];
                }
                
                // üÜï Salva il vecchio array PRIMA di aggiornare
                const oldValue = [...project.configInfissi.codTagli];
                
                project.configInfissi.codTagli[index] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'infisso', 'codTagli', project.configInfissi.codTagli, oldValue);
                
                saveState();
                // Non fare render completo per mantenere il focus
            }
        };
        
        // FORZA SINCRONIZZAZIONE: Sincronizza TUTTI i campi config ‚Üí posizioni (anche array vuoti)
        window.forzaSincronizzazioneInfissi = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project || !project.configInfissi) {
                alert('‚ùå Nessuna configurazione infissi trovata!');
                return;
            }
            
            // Verifica se la config ha effettivamente valori
            const configHaValori = (
                project.configInfissi.azienda ||
                project.configInfissi.telaio ||
                project.configInfissi.coloreInt ||
                (project.configInfissi.codTagli && project.configInfissi.codTagli.length > 0)
            );
            
            if (!configHaValori) {
                alert('‚ö†Ô∏è CONFIG GLOBALE VUOTA!\n\nImposta prima i valori nella Config Globale, poi sincronizza.');
                return;
            }
            
            if (!confirm('üîÑ SINCRONIZZARE TUTTI GLI INFISSI?\n\nQuesto aggiorner√† TUTTE le posizioni con i valori della Config Globale, sovrascrivendo anche i campi vuoti.\n\nLe modifiche manuali nelle singole posizioni NON verranno sovrascritte.')) {
                return;
            }
            
            console.log('üîÑ FORZA SINCRONIZZAZIONE INFISSI');
            console.log('   Config:', project.configInfissi);
            
            let contatore = 0;
            const campiDaSincronizzare = [
                'azienda', 'tipoAnta', 'finituraInt', 'finituraEst', 
                'coloreInt', 'coloreEst', 'telaio', 'allarme', 'vetro', 
                'tagliTelaio', 'codTagli', 'motoreAzienda', 'motoreModello'
            ];
            
            project.positions.forEach(pos => {
                if (pos.infisso) {
                    console.log(`   Posizione ${pos.id}:`);
                    campiDaSincronizzare.forEach(field => {
                        const currentValue = pos.infisso[field];
                        const configValue = project.configInfissi[field];
                        
                        // Sincronizza se:
                        // 1. Campo vuoto/undefined/null
                        // 2. Array vuoto []
                        // 3. Stringa vuota ''
                        const isEmpty = (
                            currentValue === undefined ||
                            currentValue === null ||
                            currentValue === '' ||
                            (Array.isArray(currentValue) && currentValue.length === 0)
                        );
                        
                        // NON sincronizzare se la config ha array vuoti o valori vuoti
                        const configHasValue = configValue !== undefined && 
                                              configValue !== null && 
                                              configValue !== '' &&
                                              (!Array.isArray(configValue) || configValue.length > 0);
                        
                        console.log(`     ${field}: pos="${currentValue}" config="${configValue}" isEmpty=${isEmpty} configHasValue=${configHasValue}`);
                        
                        if (isEmpty && configHasValue) {
                            if (Array.isArray(configValue)) {
                                pos.infisso[field] = [...configValue];
                            } else {
                                pos.infisso[field] = configValue;
                            }
                            console.log(`     ‚úÖ Sincronizzato: ${field} = ${configValue}`);
                            contatore++;
                        } else if (!isEmpty) {
                            console.log(`     ‚è≠Ô∏è Skip (gi√† impostato)`);
                        } else if (!configHasValue) {
                            console.log(`     ‚è≠Ô∏è Skip (config vuota)`);
                        }
                    });
                }
            });
            
            saveState();
            render();
            
            alert(`‚úÖ SINCRONIZZAZIONE COMPLETATA!\n\nAggiornati ${contatore} campi nelle posizioni esistenti.`);
            console.log(`‚úÖ SINCRONIZZAZIONE COMPLETATA: ${contatore} campi aggiornati`);
        };
        
        // Funzione per aggiornare un singolo COD.TAGLI in una posizione
        window.updateCodTagliPosizione = (projectId, posId, index, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.infisso) {
                    if (!pos.infisso.codTagli) {
                        pos.infisso.codTagli = [];
                    }
                    pos.infisso.codTagli[index] = value;
                    saveState();
                    // Non fare render completo per mantenere il focus
                }
            }
        };

        // MAIN COMPONENTS
        function Header() {
            return `
                <header class="bg-white/95 backdrop-blur shadow-lg sticky top-0 z-40">
                    <div class="max-w-7xl mx-auto px-4 py-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3">
                                <!-- Hamburger Menu Button -->
                                <button onclick="toggleMainMenu()" class="p-2 hover:bg-gray-100 rounded-lg" title="Menu principale">
                                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
                                    </svg>
                                </button>
                                
                                ${state.screen !== 'list' ? `
                                    <button onclick="goBack()" class="p-2 hover:bg-gray-100 rounded-lg">
                                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                                        </svg>
                                    </button>
                                ` : ''}
                                <h1 class="text-xl font-bold bg-gradient-to-r from-purple-600 to-blue-600 bg-clip-text text-transparent">
                                    Open Porte v3.0 - Fase 023
                                </h1>
                            </div>
                            <div class="flex items-center gap-2">
                                ${state.screen === 'list' ? `
                                    <button onclick="importProjectsJSON()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-blue-500 to-cyan-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>üì•</span>
                                        <span>Importa</span>
                                    </button>
                                    <button onclick="exportAllProjects()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-green-500 to-emerald-600 text-white rounded-lg font-medium hover:shadow-lg transition-all flex items-center gap-2">
                                        <span>üíæ</span>
                                        <span>Esporta</span>
                                    </button>
                                    <button onclick="showNewProjectModal()" 
                                            class="px-4 py-1.5 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg transition-all">
                                        + Nuovo Progetto
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </header>
            `;
        }

        // Main Menu laterale dell'applicazione
        function MainMenu() {
            return `
                <!-- Main Menu Laterale -->
                <aside class="main-menu ${state.mainMenuOpen ? 'open' : ''}" id="mainSideMenu">
                    <!-- Header menu -->
                    <div class="main-menu-header">
                        <button class="main-menu-close" onclick="toggleMainMenu()">‚úï</button>
                        <span class="main-menu-title">MENU PRINCIPALE</span>
                    </div>
                    
                    <!-- Search Bar -->
                    <div class="main-menu-search">
                        <input type="text" id="mainSearch" placeholder="üîç Cerca progetto..." 
                               onkeyup="searchProjects(this.value)" 
                               class="search-input">
                    </div>
                    
                    <!-- Menu Items con Submenu -->
                    <div class="main-nav-section">
                        <!-- Progetti -->
                        <div class="main-nav-item expandable" onclick="toggleMainSubmenu('progetti')">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üìù</span>
                                <span>Progetti</span>
                                <span class="main-nav-arrow">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="main-submenu-progetti" class="main-submenu">
                            <div class="main-submenu-item" onclick="showNewProjectModal(); closeMainMenu();">
                                <span>‚ûï Nuovo Progetto</span>
                            </div>
                            <div class="main-submenu-item" onclick="showProjectsList(); closeMainMenu();">
                                <span>üìÇ Lista Progetti</span>
                            </div>
                            <div class="main-submenu-item" onclick="showRecentProjects(); closeMainMenu();">
                                <span>üïê Recenti</span>
                            </div>
                            <div class="main-submenu-item" onclick="showArchivedProjects(); closeMainMenu();">
                                <span>üì¶ Archiviati</span>
                            </div>
                        </div>
                        
                        <!-- Strumenti -->
                        <div class="main-nav-item expandable" onclick="toggleMainSubmenu('strumenti')">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üõ†Ô∏è</span>
                                <span>Strumenti</span>
                                <span class="main-nav-arrow">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="main-submenu-strumenti" class="main-submenu">
                            <div class="main-submenu-item" onclick="openBRMCalculator(); closeMainMenu();">
                                <span>üßÆ Calcolatore BRM</span>
                            </div>
                            <div class="main-submenu-item" onclick="openConversions(); closeMainMenu();">
                                <span>üîÑ Conversioni</span>
                            </div>
                            <div class="main-submenu-item" onclick="openNormative(); closeMainMenu();">
                                <span>üìã Normative</span>
                            </div>
                        </div>
                        
                        <!-- Impostazioni -->
                        <div class="main-nav-item expandable" onclick="toggleMainSubmenu('impostazioni')">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">‚öôÔ∏è</span>
                                <span>Impostazioni</span>
                                <span class="main-nav-arrow">‚ñ∂</span>
                            </div>
                        </div>
                        <div id="main-submenu-impostazioni" class="main-submenu">
                            <div class="main-submenu-item" onclick="openGeneralSettings(); closeMainMenu();">
                                <span>üé® Generali</span>
                            </div>
                            <div class="main-submenu-item" onclick="openProductSettings(); closeMainMenu();">
                                <span>üì¶ Config Prodotti</span>
                            </div>
                            <div class="main-submenu-item" onclick="openExportImport(); closeMainMenu();">
                                <span>üíæ Export/Import</span>
                            </div>
                        </div>
                        
                        <!-- Backup & Sync -->
                        <div class="main-nav-item" onclick="openBackupSettings(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üîí</span>
                                <span>Backup</span>
                            </div>
                        </div>
                        
                        <!-- OneDrive -->
                        <div class="main-nav-item" onclick="openSyncSettings(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">‚òÅÔ∏è</span>
                                <span>OneDrive</span>
                            </div>
                            <span class="sync-badge" id="mainSyncBadge">
                                ${renderSyncBadge()}
                            </span>
                        </div>
                        
                        <!-- Statistiche -->
                        <div class="main-nav-item" onclick="openStatistics(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">üìä</span>
                                <span>Statistiche</span>
                            </div>
                        </div>
                        
                        <!-- Info -->
                        <div class="main-nav-item" onclick="openAppInfo(); closeMainMenu();">
                            <div class="main-nav-label">
                                <span class="main-nav-icon">‚ÑπÔ∏è</span>
                                <span>Info</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Actions Bottom -->
                    <div class="main-menu-bottom">
                        <div class="quick-actions-title">Azioni Rapide</div>
                        <div class="quick-actions-grid">
                            <button onclick="quickNewProject()" title="Nuovo (Ctrl+N)" class="quick-action-btn">
                                ‚ûï
                            </button>
                            <button onclick="quickSave()" title="Salva (Ctrl+S)" class="quick-action-btn">
                                üíæ
                            </button>
                            <button onclick="quickExport()" title="Export (Ctrl+E)" class="quick-action-btn">
                                üìÑ
                            </button>
                            <button onclick="quickSync()" title="Sync (Ctrl+U)" class="quick-action-btn">
                                ‚òÅÔ∏è
                            </button>
                        </div>
                    </div>
                </aside>
                
                <!-- Overlay -->
                <div class="main-menu-overlay ${state.mainMenuOpen ? 'active' : ''}" 
                     id="mainMenuOverlay" 
                     onclick="closeMainMenu()"></div>
            `;
        }

        // Funzioni gestione menu principale
        function toggleMainMenu() {
            state.mainMenuOpen = !state.mainMenuOpen;
            render();
        }
        
        function closeMainMenu() {
            state.mainMenuOpen = false;
            render();
        }
        
        function toggleMainSubmenu(menuId) {
            const submenu = document.getElementById(`main-submenu-${menuId}`);
            if (submenu) {
                const menuItem = submenu.previousElementSibling;
                const isOpen = submenu.classList.contains('open');
                
                // Chiudi altri submenu
                document.querySelectorAll('.main-submenu.open').forEach(s => {
                    s.classList.remove('open');
                    const prevItem = s.previousElementSibling;
                    if (prevItem) prevItem.classList.remove('expanded');
                });
                
                // Toggle corrente
                if (!isOpen) {
                    submenu.classList.add('open');
                    menuItem.classList.add('expanded');
                }
            }
        }
        
        // Funzioni per le voci del menu
        function showProjectsList() {
            state.screen = 'list';
            render();
        }
        
        function showRecentProjects() {
            const recentProjects = state.projects.slice(-5).reverse();
            console.log('Progetti recenti:', recentProjects);
            // TODO: Implementare vista progetti recenti
        }
        
        function showArchivedProjects() {
            const archivedProjects = state.projects.filter(p => p.archived === true);
            console.log('Progetti archiviati:', archivedProjects);
            // TODO: Implementare vista progetti archiviati
        }
        
        // Quick Actions
        function quickNewProject() {
            closeMainMenu();
            showNewProjectModal();
        }
        
        function quickSave() {
            closeMainMenu();
            saveState();
            showNotification('üíæ Salvato', 'success');
        }
        
        function quickExport() {
            closeMainMenu();
            if (state.currentProject) {
                exportCurrentProjectJSON();
            } else {
                exportAllProjects();
            }
        }
        
        function quickSync() {
            closeMainMenu();
            if (state.onedrive.connected) {
                syncWithOneDrive();
            } else {
                openSyncSettings();
            }
        }
        
        // Funzioni placeholder per menu items
        function openBRMCalculator() {
            showNotification('üßÆ Calcolatore BRM in sviluppo', 'info');
        }
        
        function openConversions() {
            showNotification('üîÑ Conversioni in sviluppo', 'info');
        }
        
        function openNormative() {
            showNotification('üìã Normative in sviluppo', 'info');
        }
        
        function openGeneralSettings() {
            showNotification('üé® Impostazioni generali in sviluppo', 'info');
        }
        
        function openProductSettings() {
            showNotification('üì¶ Configurazione prodotti in sviluppo', 'info');
        }
        
        function openExportImport() {
            // Usa le funzioni esistenti
            if (state.screen === 'list') {
                exportAllProjects();
            } else {
                exportCurrentProjectJSON();
            }
        }
        
        function openBackupSettings() {
            showNotification('üîí Sistema backup in sviluppo', 'info');
        }
        
        function openStatistics() {
            const totalProjects = state.projects.length;
            const totalPositions = state.projects.reduce((sum, p) => sum + p.positions.length, 0);
            showNotification(`üìä Statistiche: ${totalProjects} progetti, ${totalPositions} posizioni`, 'success');
        }
        
        function openAppInfo() {
            showNotification('‚ÑπÔ∏è Open Porte v3.0 - Fase 023', 'info');
        }
        
        // Sistema notifiche migliorato
        function showNotification(message, type = 'info', duration = 3000) {
            // Rimuovi notifiche esistenti
            const existingNotifications = document.querySelectorAll('.notification-toast');
            existingNotifications.forEach(n => n.remove());
            
            // Crea nuova notifica
            const notification = document.createElement('div');
            notification.className = `notification-toast notification-${type}`;
            
            const icons = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notification.innerHTML = `
                <span class="notification-icon">${icons[type]}</span>
                <span class="notification-message">${message}</span>
            `;
            
            // Aggiungi stili inline
            notification.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#10b981' : 
                            type === 'error' ? '#ef4444' :
                            type === 'warning' ? '#f59e0b' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                display: flex;
                align-items: center;
                gap: 10px;
                z-index: 10000;
                animation: slideUp 0.3s ease;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            document.body.appendChild(notification);
            
            // Rimuovi dopo duration
            if (duration > 0) {
                setTimeout(() => {
                    notification.style.animation = 'slideDown 0.3s ease';
                    setTimeout(() => notification.remove(), 300);
                }, duration);
            }
        }
        
        // Funzione ricerca progetti
        function searchProjects(query) {
            if (!query || query.length < 2) {
                // Reset vista se query vuota
                return;
            }
            
            const results = [];
            const lowerQuery = query.toLowerCase();
            
            state.projects.forEach(project => {
                // Cerca nel nome progetto
                if (project.name && project.name.toLowerCase().includes(lowerQuery)) {
                    results.push({ type: 'project', data: project });
                }
                
                // Cerca nel nome cliente
                if (project.client && project.client.toLowerCase().includes(lowerQuery)) {
                    results.push({ type: 'project', data: project });
                }
                
                // Cerca nelle posizioni
                if (project.positions) {
                    project.positions.forEach(pos => {
                        if (pos.name && pos.name.toLowerCase().includes(lowerQuery)) {
                            results.push({ 
                                type: 'position', 
                                data: pos,
                                projectName: project.name 
                            });
                        }
                    });
                }
            });
            
            console.log(`Trovati ${results.length} risultati per "${query}"`);
            // TODO: Mostrare risultati in overlay dedicato
        }

        function ProjectsList() {
            if (state.projects.length === 0) {
                // Verifica se OneDrive √® connesso
                const isOneDriveConnected = state.onedrive && state.onedrive.connected;
                
                return `
                    ${Header()}
                    <div class="min-h-[70vh] flex items-center justify-center p-4">
                        <div class="max-w-2xl w-full space-y-4">
                            
                            <!-- Banner OneDrive -->
                            <div class="bg-gradient-to-r from-blue-50 to-cyan-50 border-2 border-blue-200 rounded-2xl p-6 shadow-lg">
                                <div class="flex items-start gap-4">
                                    <div class="text-5xl flex-shrink-0">‚òÅÔ∏è</div>
                                    <div class="flex-1">
                                        ${!isOneDriveConnected ? `
                                            <!-- Non connesso: invita a connettere -->
                                            <h3 class="text-xl font-bold text-blue-900 mb-2">
                                                Hai progetti su altri dispositivi?
                                            </h3>
                                            <p class="text-blue-700 mb-4">
                                                Connetti OneDrive per sincronizzare i tuoi progetti tra PC, tablet e smartphone. 
                                                I tuoi dati saranno sempre aggiornati e disponibili ovunque.
                                            </p>
                                            <div class="flex flex-wrap gap-3">
                                                <button onclick="connectOneDrive()" 
                                                        class="px-6 py-3 bg-gradient-to-r from-blue-600 to-cyan-600 text-white rounded-lg font-semibold hover:shadow-xl transition-all flex items-center gap-2">
                                                    <span>üîó</span>
                                                    <span>Connetti OneDrive</span>
                                                </button>
                                                <button onclick="openSyncSettings()" 
                                                        class="px-6 py-3 bg-white text-blue-600 border-2 border-blue-300 rounded-lg font-semibold hover:bg-blue-50 transition-all">
                                                    ‚ÑπÔ∏è Maggiori Info
                                                </button>
                                            </div>
                                        ` : `
                                            <!-- Connesso ma nessun progetto locale: scarica dal cloud -->
                                            <h3 class="text-xl font-bold text-blue-900 mb-2">
                                                üü¢ OneDrive Connesso
                                            </h3>
                                            <p class="text-blue-700 mb-4">
                                                Non ci sono progetti su questo dispositivo. Se hai progetti salvati su OneDrive, 
                                                scaricali ora per sincronizzare i tuoi dati.
                                            </p>
                                            <div class="flex flex-wrap gap-3">
                                                <button onclick="downloadFromOneDrive()" 
                                                        class="px-6 py-3 bg-gradient-to-r from-green-600 to-emerald-600 text-white rounded-lg font-semibold hover:shadow-xl transition-all flex items-center gap-2">
                                                    <span>‚¨áÔ∏è</span>
                                                    <span>Scarica da OneDrive</span>
                                                </button>
                                                <button onclick="openSyncSettings()" 
                                                        class="px-6 py-3 bg-white text-blue-600 border-2 border-blue-300 rounded-lg font-semibold hover:bg-blue-50 transition-all">
                                                    ‚öôÔ∏è Impostazioni Sync
                                                </button>
                                            </div>
                                        `}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Benvenuto -->
                            <div class="text-center bg-white rounded-2xl p-8 shadow-xl">
                                <div class="text-6xl mb-4">üìã</div>
                                <h2 class="text-2xl font-bold mb-2">Benvenuto in Open Porte</h2>
                                <p class="text-gray-600 mb-6">
                                    ${!isOneDriveConnected ? 
                                        'Inizia creando il tuo primo progetto oppure connetti OneDrive per sincronizzare' : 
                                        'Inizia creando il tuo primo progetto'}
                                </p>
                                <button onclick="showNewProjectModal()" 
                                        class="px-6 py-3 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-semibold hover:shadow-lg transition-all">
                                    + Crea Primo Progetto
                                </button>
                            </div>
                            
                        </div>
                    </div>
                `;
            }

            return `
                ${Header()}
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-4 p-4">
                    ${state.projects.map(p => `
                        <div class="section-card hover:transform hover:scale-105 transition-all cursor-pointer relative"
                             onclick="openProject('${p.id}')">
                            <div class="flex justify-between items-start mb-3">
                                <div>
                                    <h3 class="font-bold text-lg">${p.name}</h3>
                                    <p class="text-sm text-gray-600">${p.client}</p>
                                </div>
                                <div class="flex items-center gap-2">
                                    <button onclick="event.stopPropagation(); deleteProject('${p.id}')"
                                            class="text-red-600 hover:bg-red-100 p-2 rounded-lg transition-all"
                                            title="Elimina progetto">
                                        üóëÔ∏è
                                    </button>
                                    <span class="text-2xl">üóÇÔ∏è</span>
                                </div>
                            </div>
                            <div class="flex justify-between items-center text-sm">
                                <span class="text-gray-500">${p.positions.length} posizioni</span>
                                <span class="text-purple-600 font-medium">Apri ‚Üí</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function ProjectSetup() {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (!project) return '';

            return `
                ${renderTopNavbar()}
                
                <div class="max-w-7xl mx-auto p-4">
                    
                    <div class="flex justify-between items-center mb-6 bg-white rounded-lg p-4 shadow overflow-x-auto">
                        ${(() => {
                            // üéØ Genera dinamicamente gli step in base ai prodotti selezionati
                            const steps = [
                                {num: 1, label: 'Dati Cliente'},
                                {num: 2, label: 'Prodotti + Muro'}
                            ];
                            
                            // Aggiungi solo gli step dei prodotti selezionati
                            if (project.prodotti?.infissi) steps.push({num: 3, label: 'Config. Infissi'});
                            if (project.prodotti?.persiane) steps.push({num: 4, label: 'Config. Persiane'});
                            if (project.prodotti?.tapparelle) steps.push({num: 5, label: 'Config. Tapparelle'});
                            if (project.prodotti?.zanzariere) steps.push({num: 6, label: 'Config. Zanzariere'});
                            if (project.prodotti?.cassonetti) steps.push({num: 7, label: 'Config. Cassonetti'});
                            
                            // Step finale sempre presente
                            steps.push({num: 9, label: 'Posizioni'});
                            
                            return steps.map((step, idx) => `
                                <div class="flex flex-col items-center cursor-pointer flex-shrink-0" onclick="state.setupStep=${step.num}; render()">
                                    <div class="step-indicator ${state.setupStep === step.num ? 'active' : state.setupStep > step.num ? 'completed' : 'bg-gray-200'}">
                                        ${state.setupStep > step.num ? '‚úì' : (idx + 1)}
                                    </div>
                                    <span class="text-xs mt-1 ${state.setupStep === step.num ? 'font-bold' : ''} whitespace-nowrap">${step.label}</span>
                                </div>
                            `).join('<div class="flex-1 border-t-2 border-gray-200 -mt-4 mx-2"></div>');
                        })()}
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        ${state.setupStep === 1 ? renderStep1ClientData(project) :
                          state.setupStep === 2 ? renderStep2Products(project) :
                          state.setupStep === 3 ? renderStep3ConfigInfissi(project) :
                          state.setupStep === 4 ? renderStep4ConfigPersiane(project) :
                          state.setupStep === 5 ? renderStep5ConfigTapparelle(project) :
                          state.setupStep === 6 ? renderStep6ConfigZanzariere(project) :
                          state.setupStep === 7 ? renderStep7ConfigCassonetti(project) :
                          renderStep9Positions(project)}
                        
                        <div class="flex justify-between mt-6 pt-4 border-t">
                            <button onclick="goToPrevStep('${project.id}')" 
                                    class="px-4 py-2 border rounded-lg hover:bg-gray-50 ${state.setupStep === 1 ? 'invisible' : ''}">
                                ‚Üê Indietro
                            </button>
                            ${state.setupStep < 9 ? `
                                <button onclick="goToNextStep('${project.id}')" 
                                        class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium hover:shadow-lg">
                                    Avanti ‚Üí
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep1ClientData(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üë§</span> Dati Cliente e Progetto
                    </h2>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Nome Progetto</label>
                            <input type="text" value="${project.name}" 
                                   onchange="updateProject('${project.id}', 'name', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Cliente</label>
                            <input type="text" value="${project.client}" 
                                   onchange="updateProject('${project.id}', 'client', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Piano</label>
                            ${(() => {
                                const pianoOptions = ['Piano Seminterrato', 'Piano Terra', 'Piano Rialzato', 'Primo Piano', 'Secondo Piano', 'Terzo Piano', 'Quarto Piano', 'Quinto Piano', 'Attico', 'Mansarda'];
                                const currentPiano = project.clientData?.piano || '';
                                const isCustom = currentPiano && !pianoOptions.includes(currentPiano);
                                const selectId = `piano-select-${project.id}`;
                                const inputId = `piano-input-${project.id}`;
                                
                                return `
                                    <select id="${selectId}" 
                                            onchange="
                                                const input = document.getElementById('${inputId}');
                                                if (this.value === '__ALTRO__') {
                                                    input.style.display = 'block';
                                                    input.focus();
                                                } else if (this.value) {
                                                    input.style.display = 'none';
                                                    input.value = '';
                                                    updateClientData('${project.id}', 'piano', this.value);
                                                }
                                            "
                                            class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                                        <option value="">Seleziona piano...</option>
                                        ${pianoOptions.map(opt => `
                                            <option value="${opt}" ${currentPiano === opt ? 'selected' : ''}>${opt}</option>
                                        `).join('')}
                                        <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                    </select>
                                    <input type="text" 
                                           id="${inputId}"
                                           value="${isCustom ? currentPiano : ''}"
                                           onchange="updateClientData('${project.id}', 'piano', this.value)"
                                           placeholder="Inserisci piano personalizzato..."
                                           style="display: ${isCustom ? 'block' : 'none'};"
                                           class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500 mt-2">
                                `;
                            })()}
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Citt√†</label>
                            <input type="text" placeholder="Milano" 
                                   value="${project.clientData?.citta || ''}"
                                   onchange="updateClientData('${project.id}', 'citta', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Via/Indirizzo</label>
                            <input type="text" placeholder="Via Roma, 1" 
                                   value="${project.clientData?.via || ''}"
                                   onchange="updateClientData('${project.id}', 'via', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Telefono</label>
                            <input type="tel" placeholder="+39 333 1234567" 
                                   value="${project.clientData?.telefono || ''}"
                                   onchange="updateClientData('${project.id}', 'telefono', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" placeholder="cliente@email.com" 
                                   value="${project.clientData?.email || ''}"
                                   onchange="updateClientData('${project.id}', 'email', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">Note</label>
                            <input type="text" placeholder="Note aggiuntive..." 
                                   value="${project.clientData?.note || ''}"
                                   onchange="updateClientData('${project.id}', 'note', this.value)"
                                   class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                </div>
            `;
        }

        function renderStep2Products(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üõ†Ô∏è</span> Seleziona i Prodotti da Installare
                    </h2>
                    <p class="text-gray-600 mb-4">Seleziona quali prodotti verranno installati in questo progetto:</p>
                    
                    <div class="flex flex-wrap gap-4">
                        <label class="product-pill ${project.prodotti?.infissi ? 'selected bg-blue-50 border-blue-500 text-blue-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.infissi ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'infissi', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">ü™ü</span>
                            <div>
                                <div class="font-semibold">Infissi</div>
                                <div class="text-xs opacity-75">Finestre e porte</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.persiane ? 'selected bg-purple-50 border-purple-500 text-purple-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.persiane ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'persiane', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">üö™</span>
                            <div>
                                <div class="font-semibold">Persiane</div>
                                <div class="text-xs opacity-75">Persiane e scuri</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.tapparelle ? 'selected bg-amber-50 border-amber-500 text-amber-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.tapparelle ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'tapparelle', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">üéöÔ∏è</span>
                            <div>
                                <div class="font-semibold">Tapparelle</div>
                                <div class="text-xs opacity-75">Avvolgibili</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.zanzariere ? 'selected bg-green-50 border-green-500 text-green-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.zanzariere ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'zanzariere', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">ü¶ü</span>
                            <div>
                                <div class="font-semibold">Zanzariere</div>
                                <div class="text-xs opacity-75">Protezione insetti</div>
                            </div>
                        </label>

                        <label class="product-pill ${project.prodotti?.cassonetti ? 'selected bg-orange-50 border-orange-500 text-orange-700' : 'border-gray-300'}">
                            <input type="checkbox" 
                                   ${project.prodotti?.cassonetti ? 'checked' : ''}
                                   onchange="updateProdotti('${project.id}', 'cassonetti', this.checked)"
                                   onclick="event.stopPropagation()"
                                   class="sr-only">
                            <span class="text-xl">üì¶</span>
                            <div>
                                <div class="font-semibold">Cassonetti</div>
                                <div class="text-xs opacity-75">Cassonetti avvolgibili</div>
                            </div>
                        </label>
                    </div>

                    ${Object.values(project.prodotti || {}).some(v => v) ? `
                        <div class="mt-6 p-4 bg-green-50 border border-green-300 rounded-lg">
                            <p class="text-green-700 font-medium">
                                ‚úÖ Hai selezionato: ${Object.entries(project.prodotti || {})
                                    .filter(([k,v]) => v)
                                    .map(([k]) => k.charAt(0).toUpperCase() + k.slice(1))
                                    .join(', ')}
                            </p>
                        </div>
                    ` : `
                        <div class="mt-6 p-4 bg-yellow-50 border border-yellow-300 rounded-lg">
                            <p class="text-yellow-700">‚ö†Ô∏è Seleziona almeno un prodotto per continuare</p>
                        </div>
                    `}
                    
                    <!-- üóø SEZIONE MURO INTEGRATA -->
                    <div class="mt-8 pt-8 border-t-2 border-gray-200">
                        <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                            <span class="text-2xl">üóø</span> Caratteristiche Muro (Misure in mm)
                        </h2>
                        
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <div>
                                    <label class="text-xs font-medium">Prof. Muro Int</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Prof. Piana Sopra</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Prof. Piana Sotto</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Telaio Prof</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                                <div>
                                    <label class="text-xs font-medium">Telaio Largh</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                           class="w-full compact-input border rounded">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                                <select id="guida-select-${project.id}" 
                                        onchange="updateGuidaEsistente('${project.id}', this.value)"
                                        class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                    <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            
                            <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                                <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                                    <div>
                                        <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.profGuida || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                               class="w-full px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                           class="w-full px-3 py-2 border rounded-lg">
                                </div>
                                
                                <div>
                                    <label class="block text-sm font-medium mb-1">Battuta Superiore con Tapparella</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.battutaSuperioreTapparella || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'battutaSuperioreTapparella', this.value)"
                                           class="w-full px-3 py-2 border rounded-lg">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                                <select id="falso-select-${project.id}"
                                        onchange="updateFalsoEsistente('${project.id}', this.value)"
                                        class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                    <option value="">Seleziona...</option>
                                    <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                    <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                                </select>
                            </div>
                            
                            <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                                <div class="bg-orange-50 p-3 rounded space-y-3">
                                    <div>
                                        <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                               class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                        <input type="number" placeholder="0"
                                               value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                               onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                               class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                    </div>
                                </div>
                            </div>
                            
                            <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                                <div class="bg-purple-50 p-3 rounded">
                                    <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // üÜï FASE 13 - Render Rilievo Globale per Prodotto
        function renderRilievoGlobale(project, productType, productLabel, icon) {
            const rilievo = getRilievoGlobale(project, productType);
            const completeness = calculateRilievoGlobaleCompleteness(project, productType);
            const hasInfissi = productType === 'infissi';
            
            return `
                <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 border-purple-300 rounded-lg p-4 shadow-md mt-4">
                    <div class="flex justify-between items-center mb-4">
                        <div>
                            <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                ${icon} üìã RILIEVO PREESISTENTE - ${productLabel}
                            </h3>
                            <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center gap-2">
                                <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="bg-purple-500 h-full transition-all duration-500" 
                                         style="width: ${completeness.percentage}%"></div>
                                </div>
                                <span class="text-sm font-bold">${completeness.percentage}%</span>
                            </div>
                            <p class="text-xs text-gray-500 mt-1">${completeness.completed}/${completeness.total} campi</p>
                        </div>
                    </div>
                    
                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- 1. MATERIALE -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                üîß Materiale
                                ${!rilievo.materiale || rilievo.materiale.trim() === '' ? '<span class="text-red-600">‚óè</span>' : '<span class="text-green-600">‚úì</span>'}
                            </label>
                            
                            ${(() => {
                                const options = ['Legno', 'PVC', 'Alluminio', 'Ferro', 'Acciaio'];
                                const isCustom = rilievo.materiale && !options.includes(rilievo.materiale);
                                const isEmpty = !rilievo.materiale || rilievo.materiale.trim() === '';
                                
                                return `
                                    <!-- Select principale -->
                                    <select 
                                        class="w-full px-3 py-2 border-2 rounded-lg ${isEmpty ? 'border-red-300 bg-red-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500" 
                                        onchange="handleSelectCustomChange('materiale', this, '${project.id}', '', '${productType}')">
                                        <option value="">‚ñº Seleziona...</option>
                                        ${options.map(opt => `
                                            <option value="${opt}" ${rilievo.materiale === opt ? 'selected' : ''}>${opt}</option>
                                        `).join('')}
                                        <option value="__custom__" ${isCustom ? 'selected' : ''} class="text-blue-600 font-semibold">üñäÔ∏è Scrivi manualmente</option>
                                    </select>
                                    
                                    <!-- Input custom -->
                                    <input type="text" 
                                           class="w-full px-3 py-2 border-2 border-blue-400 rounded-lg mt-2 bg-blue-50 focus:ring-2 focus:ring-blue-500" 
                                           id="materiale_custom_${project.id}_config_${productType}"
                                           placeholder="‚úèÔ∏è Scrivi valore personalizzato..."
                                           value="${isCustom ? rilievo.materiale : ''}"
                                           style="display: ${isCustom ? 'block' : 'none'};"
                                           oninput="updateRilievoGlobale('${project.id}', '${productType}', 'materiale', this.value)">
                                `;
                            })()}
                        </div>
                        
                        <!-- 2. NOTE AGGIUNTIVE -->
                        <div>
                            <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                üìù Note
                            </label>
                            <input type="text" 
                                   value="${rilievo.note || ''}"
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'note', this.value)"
                                   placeholder="Note aggiuntive..."
                                   class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                    </div>
                    
                    <div class="grid ${hasInfissi ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                        <!-- CHECKBOX: TOGLIERE -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.togliere ? 'border-orange-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="togliere-${productType}-${project.id}"
                                   ${rilievo.togliere ? 'checked' : ''}
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'togliere', this.checked)"
                                   class="w-5 h-5 text-orange-600 rounded focus:ring-2 focus:ring-orange-500">
                            <label for="togliere-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                üî® Da togliere?
                                ${rilievo.togliere ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                            </label>
                        </div>
                        
                        <!-- CHECKBOX: SMALTIMENTO -->
                        <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.smaltimento ? 'border-red-300' : 'border-gray-200'}">
                            <input type="checkbox" 
                                   id="smaltimento-${productType}-${project.id}"
                                   ${rilievo.smaltimento ? 'checked' : ''}
                                   onchange="updateRilievoGlobale('${project.id}', '${productType}', 'smaltimento', this.checked)"
                                   class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                            <label for="smaltimento-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                üóëÔ∏è Da smaltire?
                                ${rilievo.smaltimento ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                            </label>
                        </div>
                        
                        ${hasInfissi ? `
                            <!-- CHECKBOX: COPRIFILI INT (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.coprifiliInt ? 'border-blue-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliInt-${productType}-${project.id}"
                                       ${rilievo.coprifiliInt ? 'checked' : ''}
                                       onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliInt', this.checked)"
                                       class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                <label for="coprifiliInt-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üìè Coprifili INT?
                                    ${rilievo.coprifiliInt ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                            
                            <!-- CHECKBOX: COPRIFILI EST (solo per Infissi) -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${rilievo.coprifiliEst ? 'border-purple-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="coprifiliEst-${productType}-${project.id}"
                                       ${rilievo.coprifiliEst ? 'checked' : ''}
                                       onchange="updateRilievoGlobale('${project.id}', '${productType}', 'coprifiliEst', this.checked)"
                                       class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                <label for="coprifiliEst-${productType}-${project.id}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üìê Coprifili EST?
                                    ${rilievo.coprifiliEst ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                        ` : ''}
                    </div>
                    
                    ${completeness.percentage < 100 ? `
                        <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                            ‚ö†Ô∏è <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                        </div>
                    ` : `
                        <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                            ‚úÖ <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                        </div>
                    `}
                </div>
            `;
        }

        function renderBRMConfig(project, productType, productLabel, icon) {
            const configKey = `brmConfig${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const config = project[configKey] || { 
                misuraBaseL: '', operazioneL: '-', valoreL: '0',
                misuraBaseH: '', operazioneH: '-', valoreH: '0',
                note: '' 
            };
            
            // Misure di larghezza specifiche per cassonetti o generiche
            let misureLarghezza = ['LF', 'LVT', 'LVAR', 'TMV', 'LS'];
            let misureAltezza = ['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
            let misureLarghezzaPF = ['LPF', 'LVT', 'LVAR', 'TMV', 'LS'];
            let misureAltezzaPF = ['HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'];
            
            if (productType === 'cassonetti') {
                // ‚úÖ MISURE SPECIFICHE PER CASSONETTI
                misureLarghezza = ['LARGH_CASS', 'SRDX', 'SRSX', 'LS', 'LVT', 'LF', 'TMV'];
                misureAltezza = ['ALT_CASS', 'HF', 'HVT', 'HMT', 'PROFONDITA'];
            }
            
            // Decide se mostrare campi aggiuntivi per portafinestra
            const showPortafinestra = (productType === 'infissi' || productType === 'zanzariere');
            
            return `
                <div class="brm-calculator mt-6 p-4">
                    <h3 class="font-bold text-amber-800 mb-3 flex items-center gap-2">
                        <span class="text-xl">${icon}</span>
                        üìè Calcolo BRM per ${productLabel}
                        ${productType === 'cassonetti' ? '<span class="ml-2 text-xs bg-green-500 text-white px-2 py-1 rounded">‚úÖ Misure Specifiche Cassonetti</span>' : ''}
                        ${showPortafinestra ? '<span class="ml-2 text-xs bg-blue-500 text-white px-2 py-1 rounded">ü™ü Finestra / Portafinestra</span>' : ''}
                    </h3>
                    
                    <!-- BRM FINESTRA -->
                    <div class="bg-green-50 border-2 border-green-300 rounded-lg p-3 mb-4">
                        <h4 class="font-bold text-green-800 mb-3">ü™ü BRM FINESTRA ${showPortafinestra && productType === 'zanzariere' ? '(F1, F2, F3, FISSO)' : productType === 'infissi' ? '(F1, F2, F3, FISSO)' : ''}</h4>
                        <div class="grid ${productType === 'zanzariere' ? 'md:grid-cols-2' : 'md:grid-cols-2'} gap-4">
                            ${productType === 'zanzariere' ? `
                                <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                                    <h5 class="font-semibold text-amber-800 mb-2 text-sm">üìê BRM Larghezza Finestra</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureLarghezza.map(m => `
                                                    <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreL || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                                   class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result text-xs">
                                        ${config.misuraBaseL ? `üìè BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                            ` : `
                                <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                                    <h5 class="font-semibold text-amber-800 mb-2">üìê BRM Larghezza</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureLarghezza.map(m => `
                                                    <option value="${m}" ${config.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL', this.value)"
                                                    class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${config.operazioneL === '-' ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreL || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL', this.value)"
                                                   class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result">
                                        ${config.misuraBaseL ? `üìè BRM L = ${config.misuraBaseL} ${config.operazioneL} ${config.valoreL}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                            `}
                            
                            <div class="bg-white p-3 rounded-lg border-2 border-amber-300">
                                <h5 class="font-semibold text-amber-800 mb-2 ${productType === 'zanzariere' ? 'text-sm' : ''}">üìê BRM Altezza ${showPortafinestra ? 'Finestra' : ''}</h5>
                                <div class="grid grid-cols-3 gap-2 mb-2">
                                    <div>
                                        <label class="text-xs font-medium text-amber-800 block mb-1">Misura</label>
                                        <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH', this.value)"
                                                class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                            <option value="">-</option>
                                            ${misureAltezza.map(m => `
                                                <option value="${m}" ${config.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-amber-800 block mb-1">Op.</label>
                                        <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH', this.value)"
                                                class="w-full px-2 py-1 border border-amber-500 rounded text-sm bg-white">
                                            <option value="+" ${config.operazioneH === '+' ? 'selected' : ''}>+</option>
                                            <option value="-" ${config.operazioneH === '-' ? 'selected' : ''}>-</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium text-amber-800 block mb-1">mm</label>
                                        <input type="number" value="${config.valoreH || '0'}"
                                               onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH', this.value)"
                                               class="w-full px-2 py-1 border border-amber-500 rounded text-sm">
                                    </div>
                                </div>
                                <div class="brm-result ${productType === 'zanzariere' ? 'text-xs' : ''}">
                                    ${config.misuraBaseH ? `üìè BRM H = ${config.misuraBaseH} ${config.operazioneH} ${config.valoreH}mm` : 'Seleziona misura'}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- BRM PORTAFINESTRA (solo per infissi e zanzariere) -->
                    ${showPortafinestra ? `
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-3 mb-4">
                            <h4 class="font-bold text-blue-800 mb-3">üö™ BRM PORTAFINESTRA (PF1, PF2, PF3)</h4>
                            <div class="grid ${productType === 'zanzariere' ? 'md:grid-cols-2' : 'md:grid-cols-1'} gap-4">
                                ${productType === 'zanzariere' ? `
                                    <div class="bg-white p-3 rounded-lg border-2 border-blue-400">
                                        <h5 class="font-semibold text-blue-800 mb-2 text-sm">üìê BRM Larghezza Portafinestra</h5>
                                        <div class="grid grid-cols-3 gap-2 mb-2">
                                            <div>
                                                <label class="text-xs font-medium text-blue-800 block mb-1">Misura</label>
                                                <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseL_PF', this.value)"
                                                        class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                    <option value="">-</option>
                                                    ${misureLarghezzaPF.map(m => `
                                                        <option value="${m}" ${config.misuraBaseL_PF === m ? 'selected' : ''}>${m}</option>
                                                    `).join('')}
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-xs font-medium text-blue-800 block mb-1">Op.</label>
                                                <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneL_PF', this.value)"
                                                        class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                    <option value="+" ${config.operazioneL_PF === '+' ? 'selected' : ''}>+</option>
                                                    <option value="-" ${(config.operazioneL_PF === '-' || !config.operazioneL_PF) ? 'selected' : ''}>-</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="text-xs font-medium text-blue-800 block mb-1">mm</label>
                                                <input type="number" value="${config.valoreL_PF || '0'}"
                                                       onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreL_PF', this.value)"
                                                       class="w-full px-2 py-1 border border-blue-500 rounded text-sm">
                                            </div>
                                        </div>
                                        <div class="brm-result text-xs">
                                            ${config.misuraBaseL_PF ? `üìè BRM L PF = ${config.misuraBaseL_PF} ${config.operazioneL_PF || '-'} ${config.valoreL_PF || '0'}mm` : 'Seleziona misura'}
                                        </div>
                                    </div>
                                ` : ''}
                                
                                <div class="bg-white p-3 rounded-lg border-2 border-blue-400">
                                    <h5 class="font-semibold text-blue-800 mb-2 ${productType === 'zanzariere' ? 'text-sm' : ''}">üìê BRM Altezza Portafinestra</h5>
                                    <div class="grid grid-cols-3 gap-2 mb-2">
                                        <div>
                                            <label class="text-xs font-medium text-blue-800 block mb-1">Misura</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'misuraBaseH_PF', this.value)"
                                                    class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                <option value="">-</option>
                                                ${misureAltezzaPF.map(m => `
                                                    <option value="${m}" ${config.misuraBaseH_PF === m ? 'selected' : ''}>${m}</option>
                                                `).join('')}
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-blue-800 block mb-1">Op.</label>
                                            <select onchange="updateBRMConfig('${project.id}', '${configKey}', 'operazioneH_PF', this.value)"
                                                    class="w-full px-2 py-1 border border-blue-500 rounded text-sm bg-white">
                                                <option value="+" ${config.operazioneH_PF === '+' ? 'selected' : ''}>+</option>
                                                <option value="-" ${(config.operazioneH_PF === '-' || !config.operazioneH_PF) ? 'selected' : ''}>-</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label class="text-xs font-medium text-blue-800 block mb-1">mm</label>
                                            <input type="number" value="${config.valoreH_PF || '0'}"
                                                   onchange="updateBRMConfig('${project.id}', '${configKey}', 'valoreH_PF', this.value)"
                                                   class="w-full px-2 py-1 border border-blue-500 rounded text-sm">
                                        </div>
                                    </div>
                                    <div class="brm-result ${productType === 'zanzariere' ? 'text-xs' : ''}">
                                        ${config.misuraBaseH_PF ? `üìè BRM H PF = ${config.misuraBaseH_PF} ${config.operazioneH_PF || '-'} ${config.valoreH_PF || '0'}mm` : 'Seleziona misura'}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div>
                        <label class="block text-xs font-medium text-amber-800 mb-1">üìù Note Formula</label>
                        <textarea onchange="updateBRMConfig('${project.id}', '${configKey}', 'note', this.value)"
                                  placeholder="Es: Tolleranza standard, considerazioni particolari..."
                                  class="w-full px-2 py-1 border border-amber-500 rounded text-sm"
                                  rows="2">${config.note || ''}</textarea>
                    </div>
                </div>
            `;
        }

        function renderStep3ConfigInfissi(project) {
            if (!project.prodotti?.infissi) {
                return `
                    <div class="text-center py-8">
                        <p class="text-gray-500">Gli infissi non sono stati selezionati. Salta questo step.</p>
                    </div>
                `;
            }

            return `
                <div>
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">ü™ü</span> Configurazione Infissi Default
                        </h2>
                        <button onclick="forzaSincronizzazioneInfissi('${project.id}')"
                                class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg font-medium transition flex items-center gap-2 shadow-lg">
                            üîÑ SINCRONIZZA TUTTO
                        </button>
                    </div>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti gli infissi:</p>
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4 text-sm text-blue-800">
                        üí° <strong>Sincronizzazione automatica:</strong> Quando modifichi un valore qui, tutte le posizioni si aggiornano automaticamente (tranne quelle modificate manualmente). 
                        Se hai dati vecchi, clicca <strong>"SINCRONIZZA TUTTO"</strong> per forzare l'aggiornamento.
                    </div>
                    
                    ${renderRilievoGlobale(project, 'infissi', 'Infissi', 'ü™ü')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <!-- 1. AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                project.configInfissi?.azienda || '',
                                ['finstral', 'essepi', 'schuco', 'oknoplast', 'internorm'],
                                project.id,
                                null,
                                'infisso',
                                '1. Azienda'
                            )}

                            <!-- 2. TIPO ANTA -->
                            ${renderSelectWithCustom(
                                'tipoAnta',
                                project.configInfissi?.tipoAnta || '',
                                ['step-line', 'nova-line', 'slim-line', 'classic-line', 'step-line-door'],
                                project.id,
                                null,
                                'infisso',
                                '2. Tipo Anta'
                            )}

                            <!-- 3. FINITURA INTERNA -->
                            ${renderSelectWithCustom(
                                'finituraInt',
                                project.configInfissi?.finituraInt || '',
                                ['pvc', 'legno', 'alluminio', 'ceramica'],
                                project.id,
                                null,
                                'infisso',
                                '3. Finitura Interna'
                            )}

                            <!-- 4. FINITURA ESTERNA -->
                            ${renderSelectWithCustom(
                                'finituraEst',
                                project.configInfissi?.finituraEst || '',
                                ['pvc', 'alluminio', 'ceramica'],
                                project.id,
                                null,
                                'infisso',
                                '4. Finitura Esterna'
                            )}

                            <!-- 5. COLORE INTERNO -->
                            <div>
                                <label class="block text-base font-bold mb-1 text-gray-800">5. Colore Interno</label>
                                <input type="text" 
                                       placeholder="‚úèÔ∏è Es: Bianco, RAL 9010..."
                                       value="${project.configInfissi?.coloreInt || ''}"
                                       onchange="updateConfigInfissi('${project.id}', 'coloreInt', this.value)"
                                       class="w-full px-3 py-2.5 border-2 rounded-lg text-base font-medium ${!project.configInfissi?.coloreInt ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>

                            <!-- 6. COLORE ESTERNO -->
                            <div>
                                <label class="block text-base font-bold mb-1 text-gray-800">6. Colore Esterno</label>
                                <input type="text" 
                                       placeholder="‚úèÔ∏è Es: Marrone, RAL 8014..."
                                       value="${project.configInfissi?.coloreEst || ''}"
                                       onchange="updateConfigInfissi('${project.id}', 'coloreEst', this.value)"
                                       class="w-full px-3 py-2.5 border-2 rounded-lg text-base font-medium ${!project.configInfissi?.coloreEst ? 'border-orange-400 bg-orange-50' : 'border-gray-300 bg-white'} focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
                            </div>

                            <!-- 7. TELAIO -->
                            ${renderSelectWithCustom(
                                'telaio',
                                project.configInfissi?.telaio || '',
                                ['961', '962', '966', '965'],
                                project.id,
                                null,
                                'infisso',
                                '7. Telaio'
                            )}

                            <!-- 8. ALLARME -->
                            ${renderSelectWithCustom(
                                'allarme',
                                project.configInfissi?.allarme || '',
                                ['si', 'no'],
                                project.id,
                                null,
                                'infisso',
                                '8. Allarme'
                            )}

                            <!-- 9. VETRO -->
                            ${renderSelectWithCustom(
                                'vetro',
                                project.configInfissi?.vetro || '',
                                ['doppio', 'doppio-sat', 'triplo', 'triplo-sat'],
                                project.id,
                                null,
                                'infisso',
                                '9. Vetro'
                            )}

                            <!-- 10. TAGLI TELAIO -->
                            ${renderSelectWithCustom(
                                'tagliTelaio',
                                project.configInfissi?.tagliTelaio || '',
                                ['sopra', 'sotto', 'sopra-sotto', 'dx', 'sx', 'dx-sx', '4-lati', 'sopra-laterali', 'sotto-laterali'],
                                project.id,
                                null,
                                'infisso',
                                '10. Tagli Telaio'
                            )}

                            <!-- 11. COD.TAGLI (Editabili - si sincronizzano con le posizioni) -->
                            <div>
                                <label class="block text-base font-bold mb-1 text-gray-800">11. COD.TAGLI</label>
                                <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));">
                                    ${(() => {
                                        const tagliTelaio = project.configInfissi?.tagliTelaio || '';
                                        const codTagli = project.configInfissi?.codTagli || [];
                                        
                                        if (codTagli.length === 0) {
                                            return '<input type="text" readonly placeholder="‚ñº Seleziona Tagli Telaio prima" class="w-full px-3 py-2.5 border-2 border-orange-400 bg-orange-50 rounded-lg text-gray-700 font-mono text-center font-medium">';
                                        }
                                        
                                        // Mostra direttamente i campi basati su codTagli (gi√† corretto da updateConfigInfissi)
                                        return codTagli.map((taglio, idx) => `
                                            <input type="text" 
                                                   value="${taglio}"
                                                   onchange="updateCodTagliGlobale('${project.id}', ${idx}, this.value)"
                                                   placeholder="${taglio}"
                                                   class="w-full px-2 py-2 border-2 border-purple-400 bg-purple-50 rounded-lg text-gray-800 font-mono text-center font-bold text-base focus:ring-2 focus:ring-purple-500 focus:border-purple-600">
                                        `).join('');
                                    })()}
                                </div>
                                <p class="text-sm text-gray-600 mt-1.5 font-medium">üí° Questi valori si copiano nelle posizioni (modificabili singolarmente)</p>
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'infissi', 'Infissi', 'ü™ü')}
                </div>
            `;
        }

        function renderStep4ConfigPersiane(project) {
            if (!project.prodotti?.persiane) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le persiane non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üö™</span> Configurazione Persiane Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le persiane:</p>
                    
                    ${renderRilievoGlobale(project, 'persiane', 'Persiane', 'üö™')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <!-- 1. AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                project.configPersiane?.azienda || '',
                                ['p-persiane'],
                                project.id,
                                null,
                                'persiana',
                                '1. Azienda'
                            )}
                            
                            <!-- 2. MODELLO -->
                            ${renderSelectWithCustom(
                                'modello',
                                project.configPersiane?.modello || '',
                                ['Aurora', 'Vanitosa', 'Oscura', 'Alto Adige'],
                                project.id,
                                null,
                                'persiana',
                                '2. Modello'
                            )}
                        </div>
                        
                        <!-- 3. FISSAGGIO -->
                        <div class="grid md:grid-cols-2 gap-4">
                            ${renderSelectWithCustom(
                                'fissaggio',
                                project.configPersiane?.fissaggio || '',
                                ['A MURO', 'TELAIO'],
                                project.id,
                                null,
                                'persiana',
                                '3. Fissaggio'
                            )}
                            
                            <!-- 4. TIPO TELAIO (condizionale se FISSAGGIO = TELAIO) -->
                            <div id="tipo-telaio-persiane-container-${project.id}" 
                                 style="display: ${project.configPersiane?.fissaggio === 'TELAIO' ? 'block' : 'none'}">
                                ${renderSelectWithCustom(
                                    'tipoTelaio',
                                    project.configPersiane?.tipoTelaio || '',
                                    ['TH 62', 'TH 40', 'TH 82'],
                                    project.id,
                                    null,
                                    'persiana',
                                    '4. Tipo Telaio'
                                )}
                            </div>
                        </div>
                        
                        <!-- 5. COLORE PERSIANA e 6. COLORE TELAIO -->
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Colore Persiana</label>
                                <input type="text" 
                                       placeholder="Es: Bianco, Verde"
                                       value="${project.configPersiane?.colorePersiana || ''}"
                                       onchange="updateConfigPersiane('${project.id}', 'colorePersiana', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <!-- COLORE TELAIO (condizionale se FISSAGGIO = TELAIO) -->
                            <div id="colore-telaio-persiane-container-${project.id}" 
                                 style="display: ${project.configPersiane?.fissaggio === 'TELAIO' ? 'block' : 'none'}">
                                <label class="block text-sm font-medium mb-1">6. Colore Telaio</label>
                                <input type="text" 
                                       placeholder="Es: Bianco, Marrone"
                                       value="${project.configPersiane?.coloreTelaio || ''}"
                                       onchange="updateConfigPersiane('${project.id}', 'coloreTelaio', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <!-- 7. BATTUTA -->
                        <div>
                            ${renderSelectWithCustom(
                                'battuta',
                                project.configPersiane?.battuta || '',
                                ['3 LATI', '4 LATI', '2 LATI LATERALI'],
                                project.id,
                                null,
                                'persiana',
                                '7. Battuta'
                            )}
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'persiane', 'Persiane', 'üö™')}
                </div>
            `;
        }

        function renderStep5ConfigTapparelle(project) {
            if (!project.prodotti?.tapparelle) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le tapparelle non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üéöÔ∏è</span> Configurazione Tapparelle Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le tapparelle:</p>
                    
                    ${renderRilievoGlobale(project, 'tapparelle', 'Tapparelle', 'üéöÔ∏è')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <!-- 1. AZIENDA -->
                            ${renderSelectWithCustom(
                                'azienda',
                                project.configTapparelle?.azienda || '',
                                ['Plasticino', 'New solar', 'Estella'],
                                project.id,
                                null,
                                'tapparella',
                                '1. Azienda'
                            )}
                            
                            <!-- 2. MODELLO -->
                            ${renderSelectWithCustom(
                                'modello',
                                project.configTapparelle?.modello || '',
                                ['Mini', 'Alluminio'],
                                project.id,
                                null,
                                'tapparella',
                                '2. Modello'
                            )}
                            
                            <!-- 3. COLORE -->
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Colore</label>
                                <input type="text" placeholder="Es: Bianco, Grigio"
                                       value="${project.configTapparelle?.colore || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'colore', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <!-- 4. MANUALE/MOTORIZZATO -->
                            ${renderSelectWithCustom(
                                'tipologia',
                                project.configTapparelle?.tipologia || '',
                                ['Manuale', 'Motorizzata'],
                                project.id,
                                null,
                                'tapparella',
                                '4. Manuale/Motorizzato'
                            )}
                            
                            <!-- 5. SOST. ESISTENTE -->
                            ${renderSelectWithCustom(
                                'sostEsistente',
                                project.configTapparelle?.sostEsistente || '',
                                ['Sost. Rullo S√¨', 'Sost. Rullo No', 'Sost. tutto', 'Non Sost. Niente'],
                                project.id,
                                null,
                                'tapparella',
                                '5. Sost. Esistente'
                            )}
                            
                            <!-- 6. GUIDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">6. Guida</label>
                                <input type="text" placeholder="Es: Standard, Rinforzata"
                                       value="${project.configTapparelle?.guida || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'guida', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <!-- 7. COLORE GUIDA -->
                            <div>
                                <label class="block text-sm font-medium mb-1">7. Colore Guida</label>
                                <input type="text" placeholder="Es: Bianco, Marrone"
                                       value="${project.configTapparelle?.coloreGuida || ''}"
                                       onchange="updateConfigTapparelle('${project.id}', 'coloreGuida', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'tapparelle', 'Tapparelle', 'üéöÔ∏è')}
                </div>
            `;
        }

        function renderStep6ConfigZanzariere(project) {
            if (!project.prodotti?.zanzariere) {
                return `<div class="text-center py-8"><p class="text-gray-500">Le zanzariere non sono state selezionate. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">ü¶ü</span> Configurazione Zanzariere Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutte le zanzariere:</p>
                    
                    <div class="space-y-2">
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Tipo Zanzariera</label>
                                ${(() => {
                                    const options = ['Avvolgibile', 'Pliss√©', 'Battente', 'Scorrevole', 'Fissa'];
                                    const current = project.configZanzariere?.tipo || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-tipo-${project.id}`;
                                    const inputId = `zanz-tipo-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona tipo...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'tipo', this.value)"
                                               placeholder="Inserisci tipo personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Colore Telaio</label>
                                <input type="text" value="${project.configZanzariere?.coloreTelaio || ''}"
                                       onchange="updateConfigZanzariere('${project.id}', 'coloreTelaio', this.value)"
                                       placeholder="Es: Bianco, Marrone, RAL 9010"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Tipo Rete</label>
                                ${(() => {
                                    const options = ['Standard', 'Anti-polline', 'Pet-resistant', 'Micro-forata'];
                                    const current = project.configZanzariere?.tipoRete || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-rete-${project.id}`;
                                    const inputId = `zanz-rete-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'tipoRete', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'tipoRete', this.value)"
                                               placeholder="Inserisci tipo rete personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Colore Rete</label>
                                ${(() => {
                                    const options = ['Nero', 'Grigio', 'Bianco'];
                                    const current = project.configZanzariere?.coloreRete || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `zanz-colore-${project.id}`;
                                    const inputId = `zanz-colore-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'zanzariere', 'coloreRete', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigZanzariere('${project.id}', 'coloreRete', this.value)"
                                               placeholder="Inserisci colore personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'zanzariere', 'Zanzariere', 'ü¶ü')}
                </div>
            `;
        }

        function renderStep7ConfigCassonetti(project) {
            if (!project.prodotti?.cassonetti) {
                return `<div class="text-center py-8"><p class="text-gray-500">I cassonetti non sono stati selezionati. Salta questo step.</p></div>`;
            }
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üì¶</span> Configurazione Cassonetti Default
                    </h2>
                    <p class="text-gray-600 mb-4">Imposta i valori di default per tutti i cassonetti:</p>
                    
                    ${renderRilievoGlobale(project, 'cassonetti', 'Cassonetti', 'üì¶')}
                    
                    <div class="space-y-2 mt-4">
                        <div class="grid md:grid-cols-2 gap-2">
                            <div>
                                <label class="block text-sm font-medium mb-1">1. Tipo Cassonetto</label>
                                ${(() => {
                                    const options = ['Esterno', 'Incasso', 'Sopra-finestra', 'Semi-incasso'];
                                    const current = project.configCassonetti?.tipo || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-tipo-${project.id}`;
                                    const inputId = `cass-tipo-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona tipo...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'tipo', this.value)"
                                               placeholder="Inserisci tipo personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">2. Materiale</label>
                                ${(() => {
                                    const options = ['PVC', 'Alluminio', 'Alluminio Coibentato', 'Legno'];
                                    const current = project.configCassonetti?.materiale || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-materiale-${project.id}`;
                                    const inputId = `cass-materiale-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'materiale', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona materiale...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'materiale', this.value)"
                                               placeholder="Inserisci materiale personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">3. Finitura/Colore</label>
                                <input type="text" value="${project.configCassonetti?.finitura || ''}"
                                       onchange="updateConfigCassonetti('${project.id}', 'finitura', this.value)"
                                       placeholder="Es: Bianco, RAL 9010, Legno"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">4. Coibentazione</label>
                                ${(() => {
                                    const options = ['Standard', 'Rinforzata', 'Acustica'];
                                    const current = project.configCassonetti?.coibentazione || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-coib-${project.id}`;
                                    const inputId = `cass-coib-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'coibentazione', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'coibentazione', this.value)"
                                               placeholder="Inserisci coibentazione personalizzata..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <!-- üÜï FASE 027E: ISOLAMENTO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">5. Isolamento</label>
                                ${(() => {
                                    const options = ['S√¨', 'No', 'Parziale', 'Standard', 'Rinforzato'];
                                    const current = project.configCassonetti?.isolamento || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-isol-${project.id}`;
                                    const inputId = `cass-isol-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'isolamento', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'isolamento', this.value)"
                                               placeholder="Inserisci isolamento personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                            
                            <!-- üÜï FASE 027E: MONOBLOCCO -->
                            <div>
                                <label class="block text-sm font-medium mb-1">6. Monoblocco</label>
                                ${(() => {
                                    const options = ['S√¨', 'No'];
                                    const current = project.configCassonetti?.monoblocco || '';
                                    const isCustom = current && !options.includes(current);
                                    const selectId = `cass-mono-${project.id}`;
                                    const inputId = `cass-mono-input-${project.id}`;
                                    
                                    return `
                                        <select id="${selectId}" 
                                                onchange="handleConfigSelectWithCustom('${project.id}', 'cassonetti', 'monoblocco', '${selectId}', '${inputId}', this.value)"
                                                class="w-full px-3 py-2 border rounded-lg">
                                            <option value="">Seleziona...</option>
                                            ${options.map(opt => `
                                                <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                            `).join('')}
                                            <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro e scrivo...</option>
                                        </select>
                                        <input type="text" 
                                               id="${inputId}"
                                               value="${isCustom ? current : ''}"
                                               onchange="updateConfigCassonetti('${project.id}', 'monoblocco', this.value)"
                                               placeholder="Inserisci valore personalizzato..."
                                               style="display: ${isCustom ? 'block' : 'none'};"
                                               class="w-full px-3 py-2 border rounded-lg mt-2">
                                    `;
                                })()}
                            </div>
                        </div>
                    </div>
                    
                    ${renderBRMConfig(project, 'cassonetti', 'Cassonetti', 'üì¶')}
                </div>
            `;
        }

        function renderStep8WallFeatures(project) {
            return `
                <div>
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="text-2xl">üóø</span> Caratteristiche Muro (Misure in mm)
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium">Prof. Muro Int</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profMuroInt || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profMuroInt', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sopra</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSopra || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSopra', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Prof. Piana Sotto</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profPianaSotto || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profPianaSotto', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Prof</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioProfondita || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioProfondita', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                            <div>
                                <label class="text-xs font-medium">Telaio Largh</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.telaioLarghezza || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'telaioLarghezza', this.value)"
                                       class="w-full compact-input border rounded">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Guida Esistente?</label>
                            <select id="guida-select-${project.id}" 
                                    onchange="updateGuidaEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${project.caratteristicheMuro?.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="guida-fields-${project.id}" style="display: ${project.caratteristicheMuro?.guidaEsistente === 'si' ? 'block' : 'none'}">
                            <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded">
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profDistanziale || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profDistanziale', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.profGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'profGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.larghezzaGuida || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'larghezzaGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">Prof. Muro Est.</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.profMuroEst || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'profMuroEst', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium mb-1">Battuta Superiore con Tapparella</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.battutaSuperioreTapparella || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'battutaSuperioreTapparella', this.value)"
                                       class="w-full px-3 py-2 border rounded-lg">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Falso Esistente?</label>
                            <select id="falso-select-${project.id}"
                                    onchange="updateFalsoEsistente('${project.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border rounded-lg">
                                <option value="">Seleziona...</option>
                                <option value="si" ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        <div id="falso-si-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'si' ? 'block' : 'none'}">
                            <div class="bg-orange-50 p-3 rounded space-y-3">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.spessoreFalso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'spessoreFalso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${project.caratteristicheMuro?.distanzaFalsoInfisso || ''}"
                                           onchange="updateCaratteristicheMuro('${project.id}', 'distanzaFalsoInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        </div>
                        
                        <div id="falso-no-fields-${project.id}" style="display: ${project.caratteristicheMuro?.falsoEsistente === 'no' ? 'block' : 'none'}">
                            <div class="bg-purple-50 p-3 rounded">
                                <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${project.caratteristicheMuro?.distanzaMuroInfisso || ''}"
                                       onchange="updateCaratteristicheMuro('${project.id}', 'distanzaMuroInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // üóø NUOVA FUNZIONE: Render caratteristiche muro OVERRIDE per posizione specifica
        function renderCaratteristicheMuroOverride(project, pos) {
            const cm = pos.caratteristicheMuroOverride || {};
            const posIdUnique = `pos-${pos.id}`;
            
            return `
                <div class="bg-gradient-to-br from-yellow-50 to-purple-50 border-3 border-yellow-500 rounded-lg p-4 mt-4 shadow-lg">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-bold text-purple-800 flex items-center gap-2">
                            <span class="text-2xl">üóø</span> Caratteristiche Muro PERSONALIZZATE (Misure in mm)
                        </h3>
                        <button onclick="disableOverride('${project.id}', '${pos.id}')"
                                class="px-4 py-2 bg-gray-600 text-white rounded-lg font-semibold hover:bg-gray-700 transition">
                            ‚Ü©Ô∏è Ripristina Globali
                        </button>
                    </div>
                    
                    <div class="bg-yellow-100 border-2 border-yellow-400 rounded-lg p-3 mb-4">
                        <p class="text-sm font-semibold text-yellow-900">
                            ‚ö†Ô∏è <strong>Attenzione:</strong> Stai modificando le caratteristiche del muro solo per questa posizione.
                            Le modifiche qui NON influenzano le altre posizioni n√© la configurazione globale.
                        </p>
                    </div>
                    
                    <div class="space-y-4 bg-white p-4 rounded-lg">
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            <div>
                                <label class="text-xs font-medium text-purple-700">Prof. Muro Int</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profMuroInt || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroInt', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Prof. Piana Sopra</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profPianaSopra || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSopra', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Prof. Piana Sotto</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profPianaSotto || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profPianaSotto', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Telaio Prof</label>
                                <input type="number" placeholder="0"
                                       value="${cm.telaioProfondita || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioProfondita', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                            <div>
                                <label class="text-xs font-medium text-purple-700">Telaio Largh</label>
                                <input type="number" placeholder="0"
                                       value="${cm.telaioLarghezza || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'telaioLarghezza', this.value)"
                                       class="w-full compact-input border-2 border-purple-300 rounded focus:border-purple-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-purple-700 mb-1">Guida Esistente?</label>
                            <select onchange="updateGuidaEsistenteOverride('${project.id}', '${pos.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                                <option value="">Seleziona...</option>
                                <option value="si" ${cm.guidaEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${cm.guidaEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        ${cm.guidaEsistente === 'si' ? `
                            <div class="grid grid-cols-3 gap-3 bg-green-50 p-3 rounded border-2 border-green-300">
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Distanziale</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.profDistanziale || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profDistanziale', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Prof. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.profGuida || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-green-700 mb-1">Largh. Guida</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.larghezzaGuida || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'larghezzaGuida', this.value)"
                                           class="w-full px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        ` : ''}
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-1">Prof. Muro Est.</label>
                                <input type="number" placeholder="0"
                                       value="${cm.profMuroEst || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'profMuroEst', this.value)"
                                       class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                            </div>
                            
                            <div>
                                <label class="block text-sm font-medium text-purple-700 mb-1">Battuta Superiore con Tapparella</label>
                                <input type="number" placeholder="0"
                                       value="${cm.battutaSuperioreTapparella || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'battutaSuperioreTapparella', this.value)"
                                       class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-purple-700 mb-1">Falso Esistente?</label>
                            <select onchange="updateFalsoEsistenteOverride('${project.id}', '${pos.id}', this.value)"
                                    class="w-full md:w-1/2 px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500">
                                <option value="">Seleziona...</option>
                                <option value="si" ${cm.falsoEsistente === 'si' ? 'selected' : ''}>S√¨</option>
                                <option value="no" ${cm.falsoEsistente === 'no' ? 'selected' : ''}>No</option>
                            </select>
                        </div>
                        
                        ${cm.falsoEsistente === 'si' ? `
                            <div class="bg-orange-50 p-3 rounded space-y-3 border-2 border-orange-300">
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">Spessore Falso</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.spessoreFalso || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'spessoreFalso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                                <div>
                                    <label class="block text-xs font-medium text-orange-700 mb-1">+ Distanza Falso/Infisso</label>
                                    <input type="number" placeholder="0"
                                           value="${cm.distanzaFalsoInfisso || ''}"
                                           onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaFalsoInfisso', this.value)"
                                           class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                                </div>
                            </div>
                        ` : ''}
                        
                        ${cm.falsoEsistente === 'no' ? `
                            <div class="bg-purple-50 p-3 rounded border-2 border-purple-300">
                                <label class="block text-xs font-medium text-purple-700 mb-1">Distanza Muro/Infisso</label>
                                <input type="number" placeholder="0"
                                       value="${cm.distanzaMuroInfisso || ''}"
                                       onchange="updateCaratteristicheMuroOverride('${project.id}', '${pos.id}', 'distanzaMuroInfisso', this.value)"
                                       class="w-full md:w-1/2 px-2 py-1 border rounded text-sm">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function renderStep9Positions(project) {
            // Mostra riepilogo se richiesto
            if (state.showRiepilogoRilievi) {
                return renderRiepilogoRilievi(project);
            }
            
            return `
                <div>
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">üìç</span> Posizioni (${project.positions.length})
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="state.showRiepilogoRilievi = true; render()"
                                    class="px-4 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700 flex items-center gap-2">
                                üìã Riepilogo Rilievi
                            </button>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-4 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                + Aggiungi Posizione
                            </button>
                        </div>
                    </div>

                    ${project.positions.length === 0 ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                            <button onclick="addPosition('${project.id}')"
                                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Aggiungi Prima Posizione
                            </button>
                        </div>
                    ` : `
                        <div class="space-y-3">
                            ${project.positions.map((pos, idx) => {
                                const validation = validateMisure(project, pos);
                                const statusIcon = validation.errors.length > 0 ? 'üî¥' : validation.warnings.length > 0 ? 'üü°' : '‚úÖ';
                                const statusText = validation.errors.length > 0 ? 'ERRORI' : validation.warnings.length > 0 ? 'WARNING' : 'OK';
                                
                                // Stato rilievo
                                const rilievoStatus = getRilievoStatus(pos);
                                const rilievoCompleteness = calculateRilievoCompleteness(pos);
                                
                                // üÜï FASE 013 - Completamento posizione base (nome, ambiente, prodotti, misure)
                                // üîß FASE 014 - Passa anche project
                                const posStatus = getPositionCompletenessStatus(pos, project);
                                
                                return `
                                <div class="section-card cursor-pointer hover:shadow-lg ${validation.errors.length > 0 ? 'pulse-error' : ''}" onclick="openPosition('${pos.id}')">
                                    <div class="flex justify-between items-center">
                                        <div class="flex items-center gap-3">
                                            <span class="text-2xl">üìç</span>
                                            <div>
                                                <h3 class="font-semibold">${pos.name}</h3>
                                                <p class="text-sm text-gray-600">
                                                    ${pos.piano || 'Piano'} ‚Ä¢ ${pos.ambiente || 'Ambiente'}
                                                    ${pos.infisso ? ` ‚Ä¢ ü™ü` : ''}
                                                    ${pos.persiana ? ` ‚Ä¢ üö™` : ''}
                                                    ${pos.tapparella ? ` ‚Ä¢ üéöÔ∏è` : ''}
                                                    ${pos.zanzariera ? ` ‚Ä¢ ü¶ü` : ''}
                                                    ${pos.cassonetto ? ` ‚Ä¢ üì¶` : ''}
                                                </p>
                                                <div class="flex items-center gap-3 mt-1">
                                                    <p class="text-xs font-semibold ${validation.errors.length > 0 ? 'text-red-600' : validation.warnings.length > 0 ? 'text-amber-600' : 'text-green-600'}">
                                                        ${statusIcon} Misure: ${statusText}
                                                    </p>
                                                    <p class="text-xs font-semibold text-${rilievoStatus.color}-600 flex items-center gap-1">
                                                        ${rilievoStatus.icon} Rilievo: ${rilievoCompleteness.percentage}%
                                                    </p>
                                                    <p class="text-xs font-semibold text-${posStatus.color}-600 flex items-center gap-1" title="${posStatus.comp.missing.length > 0 ? 'Mancanti: ' + posStatus.comp.missing.join(', ') : 'Posizione completa'}">
                                                        ${posStatus.icon} Completo: ${posStatus.text}
                                                    </p>
                                                </div>
                                            </div>
                                        </div>
                                        <span class="text-purple-600">‚Üí</span>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                    `}
                </div>
            `;
        }

        function renderRiepilogoRilievi(project) {
            // üÜï FASE 013: Calcola statistiche completamento dati essenziali (nome, ambiente, prodotti, misure)
            // üîß FASE 014: Passa project alla funzione
            const statsEssenziali = project.positions.map(pos => ({
                pos,
                comp: calculatePositionCompleteness(pos, project)
            }));
            
            const totalPosizioni = statsEssenziali.length;
            const posizioniComplete = statsEssenziali.filter(s => s.comp.isComplete).length;
            const posizioniParziali = statsEssenziali.filter(s => s.comp.percentage > 0 && !s.comp.isComplete).length;
            const posizioniVuote = statsEssenziali.filter(s => s.comp.percentage === 0).length;
            const percMediaEssenziali = totalPosizioni > 0
                ? Math.round(statsEssenziali.reduce((sum, s) => sum + s.comp.percentage, 0) / totalPosizioni)
                : 0;
            
            // Calcola statistiche generali RILIEVO (materiale, togliere, ecc.)
            const totalPos = project.positions.length;
            const completedPos = project.positions.filter(p => {
                const comp = calculateRilievoCompleteness(p);
                return comp.percentage === 100;
            }).length;
            const incompletePos = totalPos - completedPos;
            const avgCompleteness = totalPos > 0 
                ? Math.round(project.positions.reduce((sum, p) => sum + calculateRilievoCompleteness(p).percentage, 0) / totalPos)
                : 0;
            
            return `
                <div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold flex items-center gap-2">
                            <span class="text-2xl">üìã</span> Riepilogo Rilievi
                        </h2>
                        <div class="flex gap-2">
                            <button onclick="printChecklistRilievi('${project.id}')"
                                    class="px-4 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700 flex items-center gap-2">
                                üìÑ Stampa Checklist
                            </button>
                            <button onclick="state.showRiepilogoRilievi = false; render()"
                                    class="px-4 py-2 bg-gray-600 text-white rounded-lg font-medium hover:bg-gray-700">
                                ‚Üê Torna alle Posizioni
                            </button>
                        </div>
                    </div>
                    
                    <!-- üÜï FASE 013: Completamento Dati Essenziali (nome, ambiente, prodotti, misure) -->
                    <div class="mb-6 bg-gradient-to-r from-orange-50 to-amber-50 border-2 border-orange-300 rounded-lg p-4">
                        <h3 class="text-lg font-bold text-orange-800 mb-3 flex items-center gap-2">
                            ‚úÖ Completamento Dati Essenziali (Nome, Ambiente, Prodotti, Misure)
                        </h3>
                        <div class="grid md:grid-cols-5 gap-3">
                            <div class="bg-white border-2 border-blue-300 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-blue-700">${totalPosizioni}</div>
                                <div class="text-xs text-blue-600 font-medium">Posizioni Totali</div>
                            </div>
                            <div class="bg-white border-2 border-green-300 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-green-700">${posizioniComplete}</div>
                                <div class="text-xs text-green-600 font-medium">‚úÖ Complete (100%)</div>
                            </div>
                            <div class="bg-white border-2 border-amber-300 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-amber-700">${posizioniParziali}</div>
                                <div class="text-xs text-amber-600 font-medium">‚ö†Ô∏è Parziali (1-99%)</div>
                            </div>
                            <div class="bg-white border-2 border-red-300 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-red-700">${posizioniVuote}</div>
                                <div class="text-xs text-red-600 font-medium">‚ùå Vuote (0%)</div>
                            </div>
                            <div class="bg-white border-2 border-purple-300 rounded-lg p-3 text-center">
                                <div class="text-2xl font-bold text-purple-700">${percMediaEssenziali}%</div>
                                <div class="text-xs text-purple-600 font-medium">Media Completamento</div>
                            </div>
                        </div>
                        
                        <!-- Lista posizioni incomplete -->
                        ${posizioniComplete < totalPosizioni ? `
                            <div class="mt-4 bg-white rounded-lg p-3 border-2 border-orange-200">
                                <h4 class="text-sm font-bold text-orange-800 mb-2">‚ö†Ô∏è Posizioni da completare:</h4>
                                <div class="space-y-2 text-sm">
                                    ${statsEssenziali.filter(s => !s.comp.isComplete).map(s => `
                                        <div class="flex justify-between items-start p-2 bg-orange-50 rounded">
                                            <div>
                                                <span class="font-semibold">${s.pos.name || 'Senza nome'}</span>
                                                <span class="ml-2 text-xs ${s.comp.percentage >= 70 ? 'text-amber-600' : 'text-red-600'}">(${s.comp.percentage}%)</span>
                                                <div class="text-xs text-gray-600 mt-1">
                                                    Mancanti: ${s.comp.missing.join(', ')}
                                                </div>
                                            </div>
                                            <button onclick="state.showRiepilogoRilievi = false; openPosition('${s.pos.id}')"
                                                    class="px-2 py-1 bg-orange-600 text-white rounded text-xs hover:bg-orange-700">
                                                Completa
                                            </button>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : `
                            <div class="mt-4 bg-green-50 rounded-lg p-3 border-2 border-green-200 text-center">
                                <span class="text-green-700 font-semibold">üéâ Tutte le posizioni sono complete!</span>
                            </div>
                        `}
                    </div>
                    
                    <!-- Statistiche RILIEVO (materiale, togliere, smaltimento, coprifili) -->
                    <h3 class="text-md font-bold text-gray-700 mb-2">üìù Informazioni Rilievo Preesistente:</h3>
                    <div class="grid md:grid-cols-4 gap-4 mb-6">
                        <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-blue-700">${totalPos}</div>
                            <div class="text-sm text-blue-600">Posizioni Totali</div>
                        </div>
                        <div class="bg-green-50 border-2 border-green-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-green-700">${completedPos}</div>
                            <div class="text-sm text-green-600">Rilievi Completi</div>
                        </div>
                        <div class="bg-red-50 border-2 border-red-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-red-700">${incompletePos}</div>
                            <div class="text-sm text-red-600">Da Completare</div>
                        </div>
                        <div class="bg-purple-50 border-2 border-purple-300 rounded-lg p-4">
                            <div class="text-3xl font-bold text-purple-700">${avgCompleteness}%</div>
                            <div class="text-sm text-purple-600">Completezza Media</div>
                        </div>
                    </div>
                    
                    ${totalPos === 0 ? `
                        <div class="text-center py-12 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna posizione ancora</p>
                            <button onclick="state.showRiepilogoRilievi = false; addPosition('${project.id}')"
                                    class="px-6 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Aggiungi Prima Posizione
                            </button>
                        </div>
                    ` : `
                        <!-- Tabella riepilogo -->
                        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
                            <div class="overflow-x-auto">
                                <table class="w-full">
                                    <thead class="bg-gradient-to-r from-purple-600 to-blue-600 text-white">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Posizione</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Piano/Ambiente</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Preesistente</th>
                                            <th class="px-4 py-3 text-left text-sm font-semibold">Materiale</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Togliere</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Smaltire</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Cop.INT</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Cop.EST</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Completezza</th>
                                            <th class="px-4 py-3 text-center text-sm font-semibold">Azioni</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(() => {
                                            // Genera una riga per ogni combinazione posizione-prodotto
                                            const rows = [];
                                            const prodottiInfo = {
                                                infissi: { label: 'ü™ü Infissi', hasCoprifili: true },
                                                persiane: { label: 'üö™ Persiane', hasCoprifili: false },
                                                tapparelle: { label: 'üéöÔ∏è Tapparelle', hasCoprifili: false },
                                                zanzariere: { label: 'ü¶ü Zanzariere', hasCoprifili: false },
                                                cassonetti: { label: 'üì¶ Cassonetti', hasCoprifili: false }
                                            };
                                            
                                            project.positions.forEach((pos, posIdx) => {
                                                Object.keys(prodottiInfo).forEach((productType, prodIdx) => {
                                                    // Mostra solo i prodotti selezionati nel progetto
                                                    if (!project.prodotti?.[productType]) return;
                                                    
                                                    const info = prodottiInfo[productType];
                                                    const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
                                                    const r = pos[rilievoKey] || {};
                                                    
                                                    const status = getRilievoStatusForProduct(pos, productType);
                                                    const completeness = calculateRilievoCompletenessForProduct(pos, productType);
                                                    const bgColor = (posIdx + prodIdx) % 2 === 0 ? 'bg-gray-50' : 'bg-white';
                                                    
                                                    rows.push(`
                                                        <tr class="${bgColor} hover:bg-blue-50 transition-colors">
                                                            <td class="px-4 py-3">
                                                                <div class="font-semibold text-gray-800">${pos.name}</div>
                                                                <div class="text-xs text-purple-600 font-medium">${info.label}</div>
                                                            </td>
                                                            <td class="px-4 py-3 text-sm text-gray-600">
                                                                ${pos.piano || '-'} ‚Ä¢ ${pos.ambiente || '-'}
                                                            </td>
                                                            <td class="px-4 py-3">
                                                                <div class="text-sm font-medium text-purple-700">
                                                                    ${info.label}
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-3">
                                                                <div class="text-sm ${!r.materiale || r.materiale.trim() === '' ? 'text-red-600 font-semibold' : 'text-gray-700'}">
                                                                    ${r.materiale || '‚ùå Mancante'}
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-3 text-center">
                                                                <span class="text-lg">${r.togliere ? '‚úÖ' : '‚ùå'}</span>
                                                            </td>
                                                            <td class="px-4 py-3 text-center">
                                                                <span class="text-lg">${r.smaltimento ? '‚úÖ' : '‚ùå'}</span>
                                                            </td>
                                                            <td class="px-4 py-3 text-center">
                                                                <span class="text-lg">${info.hasCoprifili ? (r.coprifiliInt ? '‚úÖ' : '‚ùå') : '-'}</span>
                                                            </td>
                                                            <td class="px-4 py-3 text-center">
                                                                <span class="text-lg">${info.hasCoprifili ? (r.coprifiliEst ? '‚úÖ' : '‚ùå') : '-'}</span>
                                                            </td>
                                                            <td class="px-4 py-3 text-center">
                                                                <div class="flex flex-col items-center gap-1">
                                                                    <span class="text-xl">${status.icon}</span>
                                                                    <div class="w-full bg-gray-200 rounded-full h-2 overflow-hidden">
                                                                        <div class="${status.badge} h-full transition-all" style="width: ${completeness.percentage}%"></div>
                                                                    </div>
                                                                    <span class="text-xs font-bold text-${status.color}-700">${completeness.percentage}%</span>
                                                                </div>
                                                            </td>
                                                            <td class="px-4 py-3 text-center">
                                                                <button onclick="state.showRiepilogoRilievi = false; openPosition('${pos.id}')"
                                                                        class="px-3 py-1 bg-purple-600 text-white rounded text-sm hover:bg-purple-700">
                                                                    Apri
                                                                </button>
                                                            </td>
                                                        </tr>
                                                    `);
                                                });
                                            });
                                            
                                            return rows.join('');
                                        })()}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        
                        ${incompletePos > 0 ? `
                            <div class="mt-4 p-4 bg-amber-50 border-2 border-amber-300 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">‚ö†Ô∏è</span>
                                    <div>
                                        <h3 class="font-bold text-amber-800">Attenzione!</h3>
                                        <p class="text-sm text-amber-700">
                                            Hai ${incompletePos} posizion${incompletePos > 1 ? 'i' : 'e'} con informazioni di rilievo incomplete. 
                                            Completa tutti i campi prima del sopralluogo per evitare dimenticanze!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div class="mt-4 p-4 bg-green-50 border-2 border-green-300 rounded-lg">
                                <div class="flex items-center gap-3">
                                    <span class="text-3xl">‚úÖ</span>
                                    <div>
                                        <h3 class="font-bold text-green-800">Perfetto!</h3>
                                        <p class="text-sm text-green-700">
                                            Tutti i rilievi sono completi. Sei pronto per il sopralluogo!
                                        </p>
                                    </div>
                                </div>
                            </div>
                        `}
                    `}
                </div>
            `;
        }

        function PositionDetail() {
            const project = state.projects.find(p => p.id === state.currentProject);
            const pos = project?.positions.find(p => p.id === state.currentPosition);
            if (!pos) return '';

            return `
                ${renderTopNavbar()}
                
                <div class="max-w-7xl mx-auto p-4">
                    <div class="bg-white rounded-lg shadow p-4 mb-4">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-3 flex-1">
                                <input type="text" value="${pos.name}"
                                       onchange="updatePosition('${project.id}', '${pos.id}', 'name', this.value)"
                                       class="text-xl font-bold border-b-2 border-transparent focus:border-purple-500 outline-none">
                                <select onchange="switchPosition(this.value)"
                                        class="px-3 py-1 border rounded-lg">
                                    ${project.positions.map(p => `
                                        <option value="${p.id}" ${p.id === pos.id ? 'selected' : ''}>${p.name}</option>
                                    `).join('')}
                                </select>
                                
                                ${(() => {
                                    const tab = pos.activeTab || 'misure';
                                    const configMap = {
                                        'infissi': { step: 3, label: '‚öôÔ∏è Config Infissi', btnClass: 'bg-purple-600 hover:bg-purple-700' },
                                        'persiane': { step: 4, label: '‚öôÔ∏è Config Persiane', btnClass: 'bg-blue-600 hover:bg-blue-700' },
                                        'tapparelle': { step: 5, label: '‚öôÔ∏è Config Tapparelle', btnClass: 'bg-indigo-600 hover:bg-indigo-700' },
                                        'zanzariere': { step: 6, label: '‚öôÔ∏è Config Zanzariere', btnClass: 'bg-green-600 hover:bg-green-700' },
                                        'cassonetti': { step: 7, label: '‚öôÔ∏è Config Cassonetti', btnClass: 'bg-orange-600 hover:bg-orange-700' }
                                    };
                                    const config = configMap[tab];
                                    if (config && project.prodotti?.[tab]) {
                                        return `
                                            <button onclick="state.screen = 'project-detail'; state.setupStep = ${config.step}; render();"
                                                    class="px-3 py-1.5 ${config.btnClass} text-white rounded-lg font-medium text-sm transition">
                                                ${config.label}
                                            </button>
                                        `;
                                    }
                                    return '';
                                })()}
                            </div>
                            <div class="flex gap-2">
                                ${project.positions.length > 1 ? `
                                <button onclick="deletePosition('${project.id}', '${pos.id}')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm">
                                    üóëÔ∏è Elimina
                                </button>
                                ` : ''}
                                <button onclick="addPosition('${project.id}')"
                                        class="px-4 py-1.5 bg-green-600 text-white rounded-lg font-medium text-sm">
                                    + Nuova Posizione
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid md:grid-cols-3 gap-4 mb-4">
                        <div class="section-card">
                            <label class="text-xs font-medium">Piano</label>
                            <input type="text" value="${pos.piano || ''}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'piano', this.value)"
                                   placeholder="${project.clientData?.piano || 'Piano'}"
                                   class="w-full compact-input border rounded mt-1">
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">
                                Ambiente <span class="text-red-600 font-bold">*</span>
                            </label>
                            ${renderSelectWithCustom({
                                fieldId: `ambiente_${pos.id}`,
                                fieldName: 'ambiente',
                                currentValue: pos.ambiente || '',
                                options: ['Sala', 'Soggiorno', 'Cucina', 'Camera', 'Stanza', 'Cameretta', 'Matrimoniale', 'Disimpegno', 'Studio', 'Ufficio', 'Bagno1', 'Bagno2', 'Ripostiglio', 'Lavanderia', 'Scala', 'Cantina', 'Garage'],
                                placeholder: '‚ö†Ô∏è Seleziona ambiente...',
                                customPlaceholder: 'Scrivi ambiente...',
                                onChangeFn: `updatePosition('${project.id}', '${pos.id}', 'ambiente', value)`,
                                context: 'position',
                                isRequired: true,
                                showValidation: !pos.ambiente
                            })}
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Quantit√†</label>
                            <input type="number" min="1" value="${pos.quantita || '1'}"
                                   onchange="updatePosition('${project.id}', '${pos.id}', 'quantita', this.value)"
                                   placeholder="1"
                                   class="w-full compact-input border rounded mt-1 font-semibold text-purple-700">
                        </div>
                        <div class="section-card">
                            <label class="text-xs font-medium">Foto</label>
                            <div class="flex items-center gap-2 mt-1">
                                <input type="file" id="foto-${pos.id}" accept="image/*" class="hidden"
                                       onchange="addFoto('${project.id}', '${pos.id}', this)">
                                <button onclick="document.getElementById('foto-${pos.id}').click()"
                                        class="px-3 py-1 bg-blue-600 text-white rounded text-sm">
                                    üì∑ Carica
                                </button>
                                <span class="text-sm text-gray-600">${pos.foto?.length || 0} foto</span>
                            </div>
                        </div>
                    </div>

                    <div class="bg-white rounded-lg shadow">
                        <div class="flex border-b overflow-x-auto">
                            <button onclick="setPositionTab('${pos.id}', 'misure')"
                                    class="tab-btn ${(pos.activeTab || 'misure') === 'misure' ? 'active' : ''}">
                                üìè Misure
                            </button>
                            ${project.prodotti?.infissi ? `
                                <button onclick="setPositionTab('${pos.id}', 'infissi')"
                                        class="tab-btn ${pos.activeTab === 'infissi' ? 'active' : ''}">
                                    ü™ü Infissi
                                </button>
                            ` : ''}
                            ${project.prodotti?.persiane ? `
                                <button onclick="setPositionTab('${pos.id}', 'persiane')"
                                        class="tab-btn ${pos.activeTab === 'persiane' ? 'active' : ''}">
                                    üö™ Persiane
                                </button>
                            ` : ''}
                            ${project.prodotti?.tapparelle ? `
                                <button onclick="setPositionTab('${pos.id}', 'tapparelle')"
                                        class="tab-btn ${pos.activeTab === 'tapparelle' ? 'active' : ''}">
                                    üéöÔ∏è Tapparelle
                                </button>
                            ` : ''}
                            ${project.prodotti?.zanzariere ? `
                                <button onclick="setPositionTab('${pos.id}', 'zanzariere')"
                                        class="tab-btn ${pos.activeTab === 'zanzariere' ? 'active' : ''}">
                                    ü¶ü Zanzariere
                                </button>
                            ` : ''}
                            ${project.prodotti?.cassonetti ? `
                                <button onclick="setPositionTab('${pos.id}', 'cassonetti')"
                                        class="tab-btn ${pos.activeTab === 'cassonetti' ? 'active' : ''}">
                                    üì¶ Cassonetti
                                </button>
                            ` : ''}
                            <button onclick="setPositionTab('${pos.id}', 'foto')"
                                    class="tab-btn ${pos.activeTab === 'foto' ? 'active' : ''}">
                                üì∏ Foto (${pos.foto?.length || 0})
                            </button>
                        </div>

                        <div class="p-4">
                            ${renderPositionTabContent(project, pos)}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPositionTabContent(project, pos) {
            const tab = pos.activeTab || 'misure';

            if (tab === 'misure') return renderMisureTab(project, pos);
            if (tab === 'infissi') return renderInfissiTab(project, pos);
            if (tab === 'persiane') return renderPersianeTab(project, pos);
            if (tab === 'tapparelle') return renderTapparelleTab(project, pos);
            if (tab === 'zanzariere') return renderZanzariereTab(project, pos);
            if (tab === 'cassonetti') return renderCassonettiTab(project, pos);
            if (tab === 'foto') return renderFotoTab(project, pos);

            return '';
        }

        // üÜï FASE 014 - Helper per verificare se rilievo posizione √® diverso da globale
        function isRilievoPersonalizzato(project, pos, productType) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const rilievoPos = pos[rilievoKey];
            const rilievoGlobale = getRilievoGlobale(project, productType);
            
            // Se non esiste il rilievo posizione, non √® personalizzato
            if (!rilievoPos) return false;
            
            // Confronta tutti i campi
            const campiDiversi = [];
            
            if (rilievoPos.materiale !== rilievoGlobale.materiale) {
                campiDiversi.push('Materiale');
            }
            if (rilievoPos.note !== rilievoGlobale.note) {
                campiDiversi.push('Note');
            }
            if (rilievoPos.togliere !== rilievoGlobale.togliere) {
                campiDiversi.push('Togliere');
            }
            if (rilievoPos.smaltimento !== rilievoGlobale.smaltimento) {
                campiDiversi.push('Smaltimento');
            }
            if (productType === 'infissi') {
                if (rilievoPos.coprifiliInt !== rilievoGlobale.coprifiliInt) {
                    campiDiversi.push('Coprifili INT');
                }
                if (rilievoPos.coprifiliEst !== rilievoGlobale.coprifiliEst) {
                    campiDiversi.push('Coprifili EST');
                }
            }
            
            return {
                isPersonalizzato: campiDiversi.length > 0,
                campiDiversi: campiDiversi
            };
        }

        function renderRilievoPerProdotto(project, pos, productType, productLabel, hasCoprifili) {
            const rilievoKey = `rilievo${productType.charAt(0).toUpperCase() + productType.slice(1)}`;
            const r = pos[rilievoKey] || {};
            
            // üÜï FASE 014 - Controlla se rilievo √® personalizzato
            const personalizz = isRilievoPersonalizzato(project, pos, productType);
            
            // Calcola completezza specifica per questo prodotto
            let completed = 0;
            let total = 3; // materiale, togliere, smaltimento
            if (hasCoprifili) total = 5; // + coprifiliInt, coprifiliEst
            
            if (r.materiale && r.materiale.trim() !== '') completed++;
            if (r.togliere !== undefined && r.togliere !== null) completed++;
            if (r.smaltimento !== undefined && r.smaltimento !== null) completed++;
            if (hasCoprifili) {
                if (r.coprifiliInt !== undefined && r.coprifiliInt !== null) completed++;
                if (r.coprifiliEst !== undefined && r.coprifiliEst !== null) completed++;
            }
            
            const percentage = Math.round((completed / total) * 100);
            
            // Determina status
            let icon, color, statusText, badge;
            if (percentage === 0) {
                icon = '‚ö™'; color = 'gray'; statusText = 'NON INIZIATO'; badge = 'bg-gray-500';
            } else if (percentage < 50) {
                icon = 'üî¥'; color = 'red'; statusText = 'INCOMPLETO'; badge = 'bg-red-500';
            } else if (percentage < 100) {
                icon = 'üü°'; color = 'amber'; statusText = 'PARZIALE'; badge = 'bg-amber-500';
            } else {
                icon = 'üü¢'; color = 'green'; statusText = 'COMPLETO'; badge = 'bg-green-500';
            }
            
            const uniqueId = `${pos.id}-${productType}`;
            const collapseId = `rilievo-collapse-${uniqueId}`;
            
            return `
                <!-- üÜï FASE 014: Pulsante per mostrare/nascondere rilievo -->
                <div class="mb-4">
                    <button onclick="document.getElementById('${collapseId}').style.display = document.getElementById('${collapseId}').style.display === 'none' ? 'block' : 'none'; this.innerHTML = document.getElementById('${collapseId}').style.display === 'none' ? 'üìã Modifica Rilievo' : '‚úñ Nascondi Rilievo';"
                            class="w-full px-4 py-2 bg-gray-100 hover:bg-gray-200 border-2 ${personalizz.isPersonalizzato ? 'border-orange-400' : 'border-gray-300'} rounded-lg font-semibold text-sm transition flex items-center justify-between">
                        <span>üìã Modifica Rilievo</span>
                        ${personalizz.isPersonalizzato ? `
                            <span class="bg-orange-500 text-white text-xs px-2 py-1 rounded-full">
                                ‚ö†Ô∏è PERSONALIZZATO
                            </span>
                        ` : ''}
                    </button>
                </div>
                
                <!-- üÜï FASE 014: Sezione rilievo COLLASSATA per default -->
                <div id="${collapseId}" style="display: none;">
                    <div class="bg-gradient-to-r from-purple-50 to-blue-50 border-2 ${color === 'green' ? 'border-green-400' : color === 'amber' ? 'border-amber-400' : color === 'red' ? 'border-red-400' : 'border-gray-300'} rounded-lg p-4 shadow-md mb-4">
                        <div class="flex justify-between items-center mb-4">
                            <div>
                                <h3 class="text-lg font-bold text-gray-800 flex items-center gap-2">
                                    üìã RILIEVO PREESISTENTE - ${productLabel}
                                </h3>
                                <p class="text-xs text-gray-600 mt-1">Compila tutte le informazioni per evitare dimenticanze</p>
                                ${personalizz.isPersonalizzato ? `
                                    <p class="text-xs text-orange-700 font-semibold mt-1">
                                        ‚ö†Ô∏è Diverso dal globale: ${personalizz.campiDiversi.join(', ')}
                                    </p>
                                ` : ''}
                            </div>
                            <div class="flex flex-col items-end gap-2">
                                <button onclick="copiaRilievoDaGlobaleProdotto('${project.id}', '${pos.id}', '${productType}')"
                                        class="text-xs bg-indigo-600 hover:bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-semibold transition">
                                    üì• Copia da Globale
                                </button>
                                <div class="text-right">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-2xl">${icon}</span>
                                        <span class="text-sm font-bold text-${color}-700">${statusText}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <div class="w-32 h-2 bg-gray-200 rounded-full overflow-hidden">
                                            <div class="${badge} h-full transition-all duration-500" 
                                                 style="width: ${percentage}%"></div>
                                        </div>
                                        <span class="text-sm font-bold">${percentage}%</span>
                                    </div>
                                    <p class="text-xs text-gray-500 mt-1">${completed}/${total} campi</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid md:grid-cols-2 gap-4">
                            <!-- 1. MATERIALE -->
                            <div>
                                <label class="block text-sm font-semibold flex items-center gap-2 mb-2">
                                    üîß Materiale
                                    ${!r.materiale || r.materiale.trim() === '' ? '<span class="text-red-600">‚óè</span>' : '<span class="text-green-600">‚úì</span>'}
                                </label>
                                ${renderSelectWithCustom({
                                    fieldId: `materiale_prodotto_${uniqueId}`,
                                    fieldName: 'materiale',
                                    currentValue: r.materiale || '',
                                    options: ['Legno', 'PVC', 'Alluminio', 'Ferro'],
                                    placeholder: 'Seleziona...',
                                    customPlaceholder: 'Inserisci materiale...',
                                    onChangeFn: `updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'materiale', value)`,
                                    context: 'rilievo-prodotto',
                                    isRequired: true,
                                    showValidation: !r.materiale || r.materiale.trim() === ''
                                })}
                            </div>
                            
                            <!-- 2. NOTE AGGIUNTIVE -->
                            <div>
                                <label class="block text-sm font-semibold mb-2 flex items-center gap-2">
                                    üìù Note
                                </label>
                                <input type="text" 
                                       value="${r.note || ''}"
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'note', this.value)"
                                       placeholder="Note aggiuntive..."
                                       class="w-full px-3 py-2 border-2 border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        </div>
                        
                        <div class="grid ${hasCoprifili ? 'md:grid-cols-4' : 'md:grid-cols-2'} gap-4 mt-4 pt-4 border-t-2 border-gray-200">
                            <!-- CHECKBOX: TOGLIERE -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.togliere ? 'border-orange-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="togliere-${uniqueId}"
                                       ${r.togliere ? 'checked' : ''}
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'togliere', this.checked)"
                                       class="w-5 h-5 text-orange-600 rounded focus:ring-2 focus:ring-orange-500">
                                <label for="togliere-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üî® Da togliere?
                                    ${r.togliere ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                            
                            <!-- CHECKBOX: SMALTIMENTO -->
                            <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.smaltimento ? 'border-red-300' : 'border-gray-200'}">
                                <input type="checkbox" 
                                       id="smaltimento-${uniqueId}"
                                       ${r.smaltimento ? 'checked' : ''}
                                       onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'smaltimento', this.checked)"
                                       class="w-5 h-5 text-red-600 rounded focus:ring-2 focus:ring-red-500">
                                <label for="smaltimento-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                    üóëÔ∏è Da smaltire?
                                    ${r.smaltimento ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                </label>
                            </div>
                            
                            ${hasCoprifili ? `
                                <!-- CHECKBOX: COPRIFILI INT (solo per Infissi) -->
                                <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.coprifiliInt ? 'border-blue-300' : 'border-gray-200'}">
                                    <input type="checkbox" 
                                           id="coprifiliInt-${uniqueId}"
                                           ${r.coprifiliInt ? 'checked' : ''}
                                           onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliInt', this.checked)"
                                           class="w-5 h-5 text-blue-600 rounded focus:ring-2 focus:ring-blue-500">
                                    <label for="coprifiliInt-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                        üìè Coprifili INT?
                                        ${r.coprifiliInt ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                    </label>
                                </div>
                                
                                <!-- CHECKBOX: COPRIFILI EST (solo per Infissi) -->
                                <div class="flex items-center gap-3 bg-white p-3 rounded-lg border-2 ${r.coprifiliEst ? 'border-purple-300' : 'border-gray-200'}">
                                    <input type="checkbox" 
                                           id="coprifiliEst-${uniqueId}"
                                           ${r.coprifiliEst ? 'checked' : ''}
                                           onchange="updateRilievoProdotto('${project.id}', '${pos.id}', '${productType}', 'coprifiliEst', this.checked)"
                                           class="w-5 h-5 text-purple-600 rounded focus:ring-2 focus:ring-purple-500">
                                    <label for="coprifiliEst-${uniqueId}" class="text-sm font-semibold cursor-pointer flex items-center gap-2">
                                        üìê Coprifili EST?
                                        ${r.coprifiliEst ? '<span class="text-green-600">‚úì</span>' : '<span class="text-gray-400">‚óã</span>'}
                                    </label>
                                </div>
                            ` : ''}
                        </div>
                        
                        ${percentage < 100 ? `
                            <div class="mt-3 p-2 bg-amber-100 border border-amber-300 rounded text-sm text-amber-800">
                                ‚ö†Ô∏è <strong>Attenzione:</strong> Compila tutti i campi per evitare dimenticanze!
                            </div>
                        ` : `
                            <div class="mt-3 p-2 bg-green-100 border border-green-300 rounded text-sm text-green-800">
                                ‚úÖ <strong>Perfetto!</strong> Tutte le informazioni del rilievo sono complete.
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        function renderMisureTab(project, pos) {
            const validation = validateMisure(project, pos);
            // üÜï FASE 014 - Indicatore completamento real-time
            // üîß FASE 014 - Passa project alle funzioni
            const comp = calculatePositionCompleteness(pos, project);
            const status = getPositionCompletenessStatus(pos, project);
            
            return `
                <div class="space-y-4">
                    <!-- üÜï FASE 014: Badge Completamento Real-time -->
                    <div class="bg-gradient-to-r from-indigo-50 to-purple-50 border-2 ${
                        comp.percentage === 100 ? 'border-green-500' : 
                        comp.percentage >= 70 ? 'border-amber-500' : 
                        'border-orange-500'
                    } rounded-lg p-4">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-sm font-bold text-gray-700 mb-1">üìä Completamento Posizione</h3>
                                <p class="text-xs text-gray-600">Controlla i dati mentre inserisci le misure</p>
                            </div>
                            <div class="text-right">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-3xl">${status.icon}</span>
                                    <span class="text-lg font-bold ${
                                        comp.percentage === 100 ? 'text-green-700' : 
                                        comp.percentage >= 70 ? 'text-amber-700' : 
                                        'text-orange-700'
                                    }">${comp.percentage}%</span>
                                </div>
                                <div class="w-40 h-3 bg-gray-200 rounded-full overflow-hidden">
                                    <div class="${status.badge} h-full transition-all duration-500" 
                                         style="width: ${comp.percentage}%"></div>
                                </div>
                            </div>
                        </div>
                        ${comp.missing.length > 0 ? `
                            <div class="mt-3 pt-3 border-t border-gray-300">
                                <p class="text-xs font-semibold text-gray-700 mb-1">‚ö†Ô∏è Da completare:</p>
                                <ul class="text-xs text-gray-600 space-y-1">
                                    ${comp.missing.map(m => `<li>‚Ä¢ ${m}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- üÜï FASE 014: Selezione Prodotti Presenti/Assenti -->
                    ${(() => {
                        const mapProdotti = {
                            'infissi': { singolare: 'infisso', label: 'ü™ü Infisso', icon: 'ü™ü' },
                            'persiane': { singolare: 'persiana', label: 'üö™ Persiana', icon: 'üö™' },
                            'tapparelle': { singolare: 'tapparella', label: 'üéöÔ∏è Tapparella', icon: 'üéöÔ∏è' },
                            'zanzariere': { singolare: 'zanzariera', label: 'ü¶ü Zanzariera', icon: 'ü¶ü' },
                            'cassonetti': { singolare: 'cassonetto', label: 'üì¶ Cassonetto', icon: 'üì¶' }
                        };
                        
                        const prodottiProgetto = [];
                        if (project?.prodotti) {
                            Object.keys(project.prodotti).forEach(tipo => {
                                if (project.prodotti[tipo] === true) {
                                    prodottiProgetto.push({
                                        tipo: tipo,
                                        ...mapProdotti[tipo]
                                    });
                                }
                            });
                        }
                        
                        if (prodottiProgetto.length === 0) return '';
                        
                        const prodottiAssenti = pos.prodottiAssenti || [];
                        
                        return `
                            <div class="bg-white border-2 border-gray-300 rounded-lg p-4">
                                <h3 class="text-sm font-bold text-gray-700 mb-3">üéØ Prodotti in questa posizione</h3>
                                <p class="text-xs text-gray-600 mb-3">Seleziona i prodotti PRESENTI. Deseleziona quelli NON presenti (es. niente tapparella, niente zanzariera)</p>
                                
                                <div class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-2">
                                    ${prodottiProgetto.map(prod => {
                                        const hasProdotto = pos[prod.singolare] && typeof pos[prod.singolare] === 'object';
                                        const isDichiaratoAssente = prodottiAssenti.includes(prod.singolare);
                                        const isPresente = hasProdotto;
                                        const status = isPresente ? 'presente' : isDichiaratoAssente ? 'assente' : 'mancante';
                                        
                                        return `
                                            <label class="relative flex flex-col items-center p-3 border-2 rounded-lg cursor-pointer transition ${
                                                status === 'presente' ? 'border-green-500 bg-green-50' :
                                                status === 'assente' ? 'border-gray-400 bg-gray-50 opacity-60' :
                                                'border-red-400 bg-red-50'
                                            }">
                                                <input type="checkbox" 
                                                       ${isPresente || !isDichiaratoAssente ? 'checked' : ''}
                                                       onchange="toggleProdottoAssente('${project.id}', '${pos.id}', '${prod.tipo}')"
                                                       class="sr-only">
                                                <span class="text-2xl mb-1">${prod.icon}</span>
                                                <span class="text-xs font-semibold text-center ${
                                                    status === 'presente' ? 'text-green-700' :
                                                    status === 'assente' ? 'text-gray-600' :
                                                    'text-red-700'
                                                }">${prod.label.replace('ü™ü ', '').replace('üö™ ', '').replace('üéöÔ∏è ', '').replace('ü¶ü ', '').replace('üì¶ ', '')}</span>
                                                ${status === 'presente' ? '<span class="text-xs text-green-600 mt-1">‚úì Presente</span>' : ''}
                                                ${status === 'assente' ? '<span class="text-xs text-gray-600 mt-1">Non presente</span>' : ''}
                                                ${status === 'mancante' ? '<span class="text-xs text-red-600 mt-1">‚ö†Ô∏è Mancante</span>' : ''}
                                            </label>
                                        `;
                                    }).join('')}
                                </div>
                                
                                <div class="mt-3 p-2 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                                    <strong>üí° Come funziona:</strong> Spunta = Prodotto presente (devi compilare misure). Non spuntato = Prodotto assente in questa posizione (OK, nessuna misura necessaria).
                                </div>
                            </div>
                        `;
                    })()}
                    
                    ${validation.errors.length > 0 || validation.warnings.length > 0 ? `
                        <div class="validation-summary">
                            ${validation.errors.length > 0 ? `
                                <div class="bg-red-50 border-2 border-red-500 rounded-lg p-4 mb-3">
                                    <h3 class="font-bold text-red-800 mb-2 flex items-center gap-2">
                                        üî¥ ERRORI DI VALIDAZIONE (${validation.errors.length})
                                    </h3>
                                    <ul class="space-y-1">
                                        ${validation.errors.map(e => `
                                            <li class="text-sm text-red-700">‚Ä¢ ${e.message}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            
                            ${validation.warnings.length > 0 ? `
                                <div class="bg-amber-50 border-2 border-amber-500 rounded-lg p-4 mb-3">
                                    <h3 class="font-bold text-amber-800 mb-2 flex items-center gap-2">
                                        üü° ATTENZIONE (${validation.warnings.length})
                                    </h3>
                                    <ul class="space-y-1">
                                        ${validation.warnings.map(w => `
                                            <li class="text-sm text-amber-700">‚Ä¢ ${w.message}</li>
                                        `).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                        </div>
                    ` : `
                        <div class="bg-green-50 border-2 border-green-500 rounded-lg p-3 mb-3">
                            <p class="font-bold text-green-800 flex items-center gap-2">
                                ‚úÖ Tutte le misure sono corrette!
                            </p>
                        </div>
                    `}
                    
                    <div class="bg-gray-50 rounded-lg p-4">
                        <div class="flex justify-between items-center mb-3">
                            <p class="text-sm font-bold text-gray-700">Misure Principali (mm)</p>
                            <span class="text-xs text-gray-500 italic" title="Puoi inserire 0 se una misura √® zero o non applicabile">
                                üí° Anche 0 √® valido
                            </span>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                            ${['LVT', 'HVT', 'LF', 'HF', 'TMV', 'HMT', 'L4', 'H4'].map(field => `
                                <div>
                                    <label class="text-xs font-semibold">${field}</label>
                                    <input type="number" placeholder="0"
                                           value="${pos.misure?.[field] || ''}"
                                           onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', '${field}', this.value)"
                                           class="w-full compact-input border rounded mt-1 font-semibold ${getFieldValidationClass(project, pos, field)}">
                                    ${getFieldValidationMessage(project, pos, field)}
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-300">
                        <p class="text-sm font-bold text-blue-800 mb-3">üìê Delta (mm)</p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs font-semibold mb-1">Delta INT</label>
                                <input type="number" placeholder="0" value="${pos.misure?.DeltaINT || ''}"
                                       onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'DeltaINT', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                            <div>
                                <label class="block text-xs font-semibold mb-1">Delta EST</label>
                                <input type="number" placeholder="0" value="${pos.misure?.DeltaEST || ''}"
                                       onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'DeltaEST', this.value)"
                                       class="w-full px-3 py-2 border rounded font-semibold">
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 rounded-lg p-4">
                        <p class="text-sm font-bold text-gray-700 mb-3">Altezze (mm)</p>
                        ${(() => {
                            // Validazione iniziale per il colore di caricamento
                            const hsoff = parseFloat(pos.misure?.HSoffitto) || 0;
                            const hparapSoff = parseFloat(pos.misure?.HParapettoSoffitto) || 0;
                            const hpavParap = parseFloat(pos.misure?.HPavimentoParapetto) || 0;
                            
                            let borderColor = 'border-gray-300';
                            let validationMsg = '';
                            
                            if (hsoff > 0 && hparapSoff > 0 && hpavParap > 0) {
                                const somma = hpavParap + hparapSoff;
                                const diff = Math.abs(somma - hsoff);
                                
                                if (diff <= 10) {
                                    borderColor = 'border-green-500';
                                    validationMsg = `
                                        <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-2">
                                            <p class="text-xs text-green-800">
                                                ‚úÖ <strong>OK:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm ‚úì
                                            </p>
                                        </div>
                                    `;
                                } else {
                                    borderColor = 'border-red-500';
                                    validationMsg = `
                                        <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-2">
                                            <p class="text-xs text-red-800">
                                                ‚ö†Ô∏è <strong>ERRORE:</strong> ${hpavParap} + ${hparapSoff} = ${somma}mm vs ${hsoff}mm | Diff: ${diff.toFixed(1)}mm (>10mm!)
                                            </p>
                                        </div>
                                    `;
                                }
                            }
                            
                            return `
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="block text-xs font-semibold mb-1">H Soffitto</label>
                                        <input type="number" 
                                               id="hsoff-${pos.id}"
                                               placeholder="0" 
                                               value="${pos.misure?.HSoffitto || ''}"
                                               oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                               onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HSoffitto', this.value)"
                                               class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold mb-1">H Parapetto/Soffitto</label>
                                        <input type="number" 
                                               id="hparapsoff-${pos.id}"
                                               placeholder="0" 
                                               value="${pos.misure?.HParapettoSoffitto || ''}"
                                               oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                               onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HParapettoSoffitto', this.value)"
                                               class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold mb-1">H Pavimento/Parapetto</label>
                                        <input type="number" 
                                               id="hpavparap-${pos.id}"
                                               placeholder="0" 
                                               value="${pos.misure?.HPavimentoParapetto || ''}"
                                               oninput="validateAltezzeRealTime('${project.id}', '${pos.id}')"
                                               onchange="updateMisuraWithValidation('${project.id}', '${pos.id}', 'HPavimentoParapetto', this.value)"
                                               class="w-full px-3 py-2 border-2 ${borderColor} rounded font-semibold">
                                    </div>
                                </div>
                                <div id="validation-msg-${pos.id}">${validationMsg}</div>
                            `;
                        })()}
                    </div>
                    
                    <!-- üìã SEZIONI RILIEVO PREESISTENTE PER OGNI PRODOTTO -->
                    ${project.prodotti?.infissi ? renderRilievoPerProdotto(project, pos, 'infissi', 'ü™ü Infissi', true) : ''}
                    ${project.prodotti?.persiane ? renderRilievoPerProdotto(project, pos, 'persiane', 'üö™ Persiane', false) : ''}
                    ${project.prodotti?.tapparelle ? renderRilievoPerProdotto(project, pos, 'tapparelle', 'üéöÔ∏è Tapparelle', false) : ''}
                    ${project.prodotti?.cassonetti ? renderRilievoPerProdotto(project, pos, 'cassonetti', 'üì¶ Cassonetti', false) : ''}
                    
                    <!-- üóø CARATTERISTICHE MURO PERSONALIZZATE -->
                    ${pos.overrideCaratteristiche ? renderCaratteristicheMuroOverride(project, pos) : `
                        <button onclick="enableOverride('${project.id}', '${pos.id}')"
                                class="w-full text-sm bg-yellow-600 text-white px-4 py-3 rounded-lg hover:bg-yellow-700 font-semibold transition flex items-center justify-center gap-2">
                            ‚úèÔ∏è Personalizza caratteristiche muro per questa posizione
                        </button>
                    `}
                </div>
            `;
        }

        function renderInfissiTab(project, pos) {
            const inf = pos.infisso;
            
            return `
                <div class="space-y-4">
                    ${!inf ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessun infisso configurato</p>
                            <button onclick="addInfisso('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-blue-600 text-white rounded-lg font-medium hover:bg-blue-700">
                                + Aggiungi Infisso
                            </button>
                        </div>
                    ` : (parseInt(inf.qta) === 0 || inf.qta === '0' || inf.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-blue-700 text-lg">ü™ü Infisso</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'infisso')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(inf.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-blue-700 text-lg">ü™ü Infisso</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'infisso')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-blue-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(inf.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        ${(() => {
                                            const options = ['F1', 'PF1', 'F2', 'PF2', 'F3', 'PF3', 'HST', 'FISSO'];
                                            const current = inf.tipo || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `inf-tipo-${pos.id}`;
                                            const inputId = `inf-tipo-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'infisso', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipo', this.value)"
                                                       placeholder="Inserisci tipo personalizzato..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        ${(() => {
                                            const options = ['SX', 'DX', 'Fisso', 'Ribalta', 'Sp. SX', 'Sp. DX', 'SCORR.PARALL'];
                                            const current = inf.apertura || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `inf-apertura-${pos.id}`;
                                            const inputId = `inf-apertura-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'infisso', 'apertura', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'apertura', this.value)"
                                                       placeholder="Inserisci apertura personalizzata..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>

                            <!-- üîß TIPO INFISSO ASSOCIATO -->
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    üîß Tipo Infisso Associato
                                </h5>
                                <p class="text-sm text-gray-600 mb-3">Seleziona tipo:</p>
                                <div class="flex gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfissoAssociato-${project.id}-${pos.id}"
                                               value="F"
                                               ${(() => {
                                                   // Auto-selezione: se tipo contiene PF ‚Üí PF, altrimenti F
                                                   if (inf.tipoInfissoAssociato) {
                                                       return inf.tipoInfissoAssociato === 'F' ? 'checked' : '';
                                                   } else {
                                                       // Default: se tipo non contiene PF ‚Üí seleziona F
                                                       return (inf.tipo && !inf.tipo.includes('PF')) ? 'checked' : '';
                                                   }
                                               })()}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoInfissoAssociato', 'F')"
                                               class="w-4 h-4">
                                        <span class="font-medium">F (Finestra)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfissoAssociato-${project.id}-${pos.id}"
                                               value="PF"
                                               ${(() => {
                                                   // Auto-selezione: se tipo contiene PF ‚Üí PF
                                                   if (inf.tipoInfissoAssociato) {
                                                       return inf.tipoInfissoAssociato === 'PF' ? 'checked' : '';
                                                   } else {
                                                       // Default: se tipo contiene PF ‚Üí seleziona PF
                                                       return (inf.tipo && inf.tipo.includes('PF')) ? 'checked' : '';
                                                   }
                                               })()}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'tipoInfissoAssociato', 'PF')"
                                               class="w-4 h-4">
                                        <span class="font-medium">PF (Porta Finestra)</span>
                                    </label>
                                </div>
                                ${!inf.tipoInfissoAssociato && !inf.tipo ? `
                                    <div class="mt-3 bg-amber-100 border-l-4 border-amber-500 p-3">
                                        <p class="text-sm text-amber-800">‚ö†Ô∏è Seleziona prima se F o PF</p>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <!-- AZIENDA -->
                                    ${renderSelectWithCustom(
                                        'azienda',
                                        inf.azienda || '',
                                        ['finstral', 'essepi', 'schuco', 'oknoplast', 'internorm'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Azienda'
                                    )}

                                    <!-- TIPO ANTA -->
                                    ${renderSelectWithCustom(
                                        'tipoAnta',
                                        inf.tipoAnta || '',
                                        ['step-line', 'nova-line', 'slim-line', 'classic-line', 'step-line-door'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Tipo Anta'
                                    )}

                                    <!-- FINITURA INTERNA -->
                                    ${renderSelectWithCustom(
                                        'finituraInt',
                                        inf.finituraInt || '',
                                        ['pvc', 'legno', 'alluminio', 'ceramica'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Finitura Int'
                                    )}

                                    <!-- FINITURA ESTERNA -->
                                    ${renderSelectWithCustom(
                                        'finituraEst',
                                        inf.finituraEst || '',
                                        ['pvc', 'alluminio', 'ceramica'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Finitura Est'
                                    )}

                                    <!-- COLORE INTERNO -->
                                    <div>
                                        <label class="text-xs font-medium">Colore Int</label>
                                        <input type="text" value="${inf.coloreInt || ''}"
                                               placeholder="42"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'coloreInt', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>

                                    <!-- COLORE ESTERNO -->
                                    <div>
                                        <label class="text-xs font-medium">Colore Est</label>
                                        <input type="text" value="${inf.coloreEst || ''}"
                                               placeholder="L55"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'coloreEst', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>

                                    <!-- TELAIO -->
                                    ${renderSelectWithCustom(
                                        'telaio',
                                        inf.telaio || '',
                                        ['961', '962', '966', '965'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Telaio'
                                    )}

                                    <!-- ALLARME -->
                                    ${renderSelectWithCustom(
                                        'allarme',
                                        inf.allarme || '',
                                        ['si', 'no'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Allarme'
                                    )}

                                    <!-- VETRO -->
                                    ${renderSelectWithCustom(
                                        'vetro',
                                        inf.vetro || '',
                                        ['doppio', 'doppio-sat', 'triplo', 'triplo-sat'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Vetro'
                                    )}

                                    <!-- TAGLI TELAIO -->
                                    ${renderSelectWithCustom(
                                        'tagliTelaio',
                                        inf.tagliTelaio || '',
                                        ['sopra', 'sotto', 'sopra-sotto', 'dx', 'sx', 'dx-sx', '4-lati', 'sopra-laterali', 'sotto-laterali'],
                                        project.id,
                                        pos.id,
                                        'infisso',
                                        'Tagli Telaio'
                                    )}
                                </div>
                                
                                <!-- COD.TAGLI MULTIPLI (editabili, sincronizzati con config globale) -->
                                <div class="mt-3">
                                    <div class="flex items-center justify-between mb-2">
                                        <label class="text-xs font-medium">COD.TAGLI</label>
                                        <button onclick="state.screen = 'project-detail'; state.setupStep = 3; render();"
                                                class="px-2 py-1 bg-purple-600 hover:bg-purple-700 text-white text-xs rounded font-medium transition">
                                            ‚öôÔ∏è Config Globale
                                        </button>
                                    </div>
                                    <div class="grid gap-2" style="grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));">
                                        ${(() => {
                                            const codTagli = inf.codTagli || [];
                                            
                                            if (codTagli.length === 0) {
                                                return '<input type="text" readonly placeholder="Seleziona Tagli Telaio" class="w-full px-2 py-1 border rounded bg-gray-50 text-gray-700 text-xs">';
                                            }
                                            
                                            // Mostra direttamente i campi basati su codTagli (gi√† corretto da updateProduct)
                                            return codTagli.map((taglio, idx) => `
                                                <input type="text" 
                                                       value="${taglio}"
                                                       onchange="updateCodTagliPosizione('${project.id}', '${pos.id}', ${idx}, this.value)"
                                                       placeholder="${taglio}"
                                                       class="w-full px-2 py-1 border-2 border-blue-300 rounded text-gray-700 text-xs text-center font-bold focus:ring-2 focus:ring-blue-500">
                                            `).join('');
                                        })()}
                                    </div>
                                    <p class="text-xs text-gray-400 mt-1">üí° Valori copiati da Config Globale (modificabili qui)</p>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!inf.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'infisso')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'infisso')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!inf.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2">
                                            <strong>Formula Globale Attiva:</strong>
                                        </p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div>
                                                <span class="font-semibold">BRM L =</span>
                                                ${project.brmConfigInfissi?.misuraBaseL || '?'} 
                                                ${project.brmConfigInfissi?.operazioneL || '-'} 
                                                ${project.brmConfigInfissi?.valoreL || '0'}mm
                                            </div>
                                            <div>
                                                <span class="font-semibold">BRM H =</span>
                                                ${project.brmConfigInfissi?.misuraBaseH || '?'} 
                                                ${project.brmConfigInfissi?.operazioneH || '-'} 
                                                ${project.brmConfigInfissi?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${inf.BRM_L || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${inf.BRM_H || ''}" readonly
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${inf.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${inf.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-infisso-${pos.id}" value="${inf.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-infisso-${pos.id}">
                                                = ${inf.brmPersonalizzato?.misuraBaseL || '?'} ${inf.brmPersonalizzato?.operazioneL || '+'} ${inf.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${inf.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-infisso-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${inf.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${inf.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-infisso-${pos.id}" value="${inf.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-infisso-${pos.id}">
                                                = ${inf.brmPersonalizzato?.misuraBaseH || '?'} ${inf.brmPersonalizzato?.operazioneH || '+'} ${inf.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'infisso')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${inf.BRM_L || ''}" readonly id="brm-l-result-infisso-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${inf.BRM_H || ''}" readonly id="brm-h-result-infisso-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${inf.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'infisso', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${inf.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderPersianeTab(project, pos) {
            const per = pos.persiana;
            
            return `
                <div class="space-y-4">
                    ${!per ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna persiana configurata</p>
                            <button onclick="addPersiana('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-purple-600 text-white rounded-lg font-medium hover:bg-purple-700">
                                + Aggiungi Persiana
                            </button>
                        </div>
                    ` : (parseInt(per.qta) === 0 || per.qta === '0' || per.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-purple-700 text-lg">üö™ Persiana</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-purple-700 text-lg">üö™ Persiana</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'persiana')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-purple-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(per.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        ${(() => {
                                            const options = ['FA', 'PFA', 'F2', 'PF2', 'F3', 'PF3', 'SCORREVOLE'];
                                            const current = per.tipo || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `per-tipo-${pos.id}`;
                                            const inputId = `per-tipo-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'tipo', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è ALTRO - SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'tipo', this.value)"
                                                       placeholder="Inserisci tipo personalizzato..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        ${(() => {
                                            const options = ['SP SX', 'SP DX', 'LIB SX', 'LIB DX', 'SCORR SX', 'SCORR DX'];
                                            const current = per.apertura || '';
                                            const isCustom = current && !options.includes(current);
                                            const selectId = `per-apertura-${pos.id}`;
                                            const inputId = `per-apertura-input-${pos.id}`;
                                            
                                            return `
                                                <select id="${selectId}" 
                                                        onchange="handleProductSelectWithCustom('${project.id}', '${pos.id}', 'persiana', 'apertura', '${selectId}', '${inputId}', this.value)"
                                                        class="w-full compact-input border rounded mt-1">
                                                    <option value="">--</option>
                                                    ${options.map(opt => `
                                                        <option value="${opt}" ${current === opt ? 'selected' : ''}>${opt}</option>
                                                    `).join('')}
                                                    <option value="__ALTRO__" ${isCustom ? 'selected' : ''}>‚úèÔ∏è Altro SCRIVO</option>
                                                </select>
                                                <input type="text" 
                                                       id="${inputId}"
                                                       value="${isCustom ? current : ''}"
                                                       onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'apertura', this.value)"
                                                       placeholder="Inserisci apertura personalizzata..."
                                                       style="display: ${isCustom ? 'block' : 'none'};"
                                                       class="w-full compact-input border rounded mt-2">
                                            `;
                                        })()}
                                    </div>
                                </div>
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <!-- AZIENDA -->
                                    ${renderSelectWithCustom(
                                        'azienda',
                                        per.azienda || '',
                                        ['p-persiane'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Azienda'
                                    )}

                                    <!-- MODELLO -->
                                    ${renderSelectWithCustom(
                                        'modello',
                                        per.modello || '',
                                        ['Aurora', 'Vanitosa', 'Oscura', 'Alto Adige'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Modello'
                                    )}

                                    <!-- FISSAGGIO -->
                                    ${renderSelectWithCustom(
                                        'fissaggio',
                                        per.fissaggio || '',
                                        ['A MURO', 'TELAIO'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Fissaggio'
                                    )}

                                    <!-- TIPO TELAIO -->
                                    ${renderSelectWithCustom(
                                        'tipoTelaio',
                                        per.tipoTelaio || '',
                                        ['TH 62', 'TH 40', 'TH 82'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Tipo Telaio'
                                    )}

                                    <!-- COLORE PERSIANA -->
                                    <div>
                                        <label class="text-xs font-medium">Colore Persiana</label>
                                        <input type="text" value="${per.colorePersiana || ''}"
                                               placeholder="--"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'colorePersiana', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>

                                    <!-- COLORE TELAIO -->
                                    <div>
                                        <label class="text-xs font-medium">Colore Telaio</label>
                                        <input type="text" value="${per.coloreTelaio || ''}"
                                               placeholder="--"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'coloreTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>

                                    <!-- BATTUTA -->
                                    ${renderSelectWithCustom(
                                        'battuta',
                                        per.battuta || '',
                                        ['3 LATI', '4 LATI', '2 LATI LATERALI'],
                                        project.id,
                                        pos.id,
                                        'persiana',
                                        'Battuta'
                                    )}
                                </div>
                            </div>

                            <!-- üì∑ FOTO PERSIANA -->
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                        üì∑ Foto Persiana
                                    </h5>
                                    <button onclick="document.getElementById('foto-persiana-input-${project.id}-${pos.id}').click()"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                        üì∑ Carica Foto
                                    </button>
                                    <input type="file" 
                                           id="foto-persiana-input-${project.id}-${pos.id}"
                                           accept="image/*"
                                           style="display: none;"
                                           onchange="addFotoPersiana('${project.id}', '${pos.id}', event)">
                                </div>
                                ${per.foto && per.foto.length > 0 ? `
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                        ${per.foto.map((foto, idx) => `
                                            <div class="relative">
                                                <img src="${foto}" class="w-full h-32 object-cover rounded border-2 border-blue-300">
                                                <button onclick="removeFotoPersiana('${project.id}', '${pos.id}', ${idx})"
                                                        class="absolute top-1 right-1 bg-red-600 text-white rounded-full p-1 text-xs hover:bg-red-700">
                                                    ‚úï
                                                </button>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <p class="text-sm text-gray-500 italic text-center py-3">1 foto per persiana<br>Nessuna foto caricata</p>
                                `}
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!per.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'persiana')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'persiana')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!per.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigPersiane?.misuraBaseL || '?'} ${project.brmConfigPersiane?.operazioneL || '-'} ${project.brmConfigPersiane?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigPersiane?.misuraBaseH || '?'} ${project.brmConfigPersiane?.operazioneH || '-'} ${project.brmConfigPersiane?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${per.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${per.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${per.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${per.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${per.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-persiana-${pos.id}" value="${per.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-persiana-${pos.id}">
                                                = ${per.brmPersonalizzato?.misuraBaseL || '?'} ${per.brmPersonalizzato?.operazioneL || '+'} ${per.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${per.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-persiana-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${per.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${per.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-persiana-${pos.id}" value="${per.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-persiana-${pos.id}">
                                                = ${per.brmPersonalizzato?.misuraBaseH || '?'} ${per.brmPersonalizzato?.operazioneH || '+'} ${per.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'persiana')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${per.BRM_L || ''}" readonly id="brm-l-result-persiana-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${per.BRM_H || ''}" readonly id="brm-h-result-persiana-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${per.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'persiana', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${per.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderTapparelleTab(project, pos) {
            const tap = pos.tapparella;
            
            return `
                <div class="space-y-4">
                    ${!tap ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna tapparella configurata</p>
                            <button onclick="addTapparella('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-amber-600 text-white rounded-lg font-medium hover:bg-amber-700">
                                + Aggiungi Tapparella
                            </button>
                        </div>
                    ` : (parseInt(tap.qta) === 0 || tap.qta === '0' || tap.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-amber-700 text-lg">üéöÔ∏è Tapparella</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'tapparella')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(tap.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-amber-700 text-lg">üéöÔ∏è Tapparella</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'tapparella')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(tap.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-yellow-50 border-2 border-yellow-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Azienda</label>
                                        <input type="text" value="${tap.azienda || ''}"
                                               placeholder="plasticino"
                                               list="azienda-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'azienda', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="azienda-tap-list-${pos.id}">
                                            <option value="plasticino">
                                            <option value="cherubini">
                                            <option value="nice">
                                            <option value="somfy">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Modello</label>
                                        <input type="text" value="${tap.modello || ''}"
                                               placeholder="Mini"
                                               list="modello-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'modello', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="modello-tap-list-${pos.id}">
                                            <option value="Mini">
                                            <option value="Maxi">
                                            <option value="Standard">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore</label>
                                        <input type="text" value="${tap.colore || ''}"
                                               placeholder="marrone 79"
                                               list="colore-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'colore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="colore-tap-list-${pos.id}">
                                            <option value="marrone 79">
                                            <option value="bianco">
                                            <option value="grigio">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Manuale/Motorizzato</label>
                                        <input type="text" value="${tap.manualeMot || ''}"
                                               placeholder="Motorizzata"
                                               list="manualeMot-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'manualeMot', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="manualeMot-list-${pos.id}">
                                            <option value="Manuale">
                                            <option value="Motorizzata">
                                        </datalist>
                                    </div>
                                </div>

                                <!-- FASE 11a: TIPO SOSTITUZIONE -->
                                <div class="mt-4 bg-orange-100 border-2 border-orange-300 rounded-lg p-3">
                                    <label class="text-sm font-semibold text-orange-800 block mb-2">üîÑ Cosa si sostituisce?</label>
                                    <div class="flex gap-4 flex-wrap">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" 
                                                   name="tipoSost-${pos.id}" 
                                                   value="Entrambi"
                                                   ${!tap.tipoSostituzione || tap.tipoSostituzione === 'Entrambi' ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tipoSostituzione', this.value)"
                                                   class="w-4 h-4">
                                            <span class="text-sm font-medium">üîß Entrambi (Motore + Tapparella)</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" 
                                                   name="tipoSost-${pos.id}" 
                                                   value="Solo Motore"
                                                   ${tap.tipoSostituzione === 'Solo Motore' ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tipoSostituzione', this.value)"
                                                   class="w-4 h-4">
                                            <span class="text-sm font-medium">‚ö° Solo Motore</span>
                                        </label>
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="radio" 
                                                   name="tipoSost-${pos.id}" 
                                                   value="Solo Tapparella"
                                                   ${tap.tipoSostituzione === 'Solo Tapparella' ? 'checked' : ''}
                                                   onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'tipoSostituzione', this.value)"
                                                   class="w-4 h-4">
                                            <span class="text-sm font-medium">üéöÔ∏è Solo Tapparella</span>
                                        </label>
                                    </div>
                                </div>

                                <!-- CAMPI CONDIZIONALI -->
                                ${tap.tipoSostituzione !== 'Solo Motore' ? `
                                <div class="grid md:grid-cols-2 gap-3 mt-3">
                                    <div>
                                        <label class="text-xs font-medium">Guida</label>
                                        <input type="text" value="${tap.guida || ''}"
                                               placeholder="--"
                                               list="guida-tap-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'guida', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="guida-tap-list-${pos.id}">
                                            <option value="Standard">
                                            <option value="Rinforzata">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Guida</label>
                                        <input type="text" value="${tap.coloreGuida || ''}"
                                               placeholder="--"
                                               list="coloreGuida-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'coloreGuida', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreGuida-list-${pos.id}">
                                            <option value="bianco">
                                            <option value="marrone">
                                            <option value="grigio">
                                        </datalist>
                                    </div>
                                </div>
                                ` : ''}
                            </div>

                            <!-- üîå MOTORI (SISTEMA COMPLETO FASE 11a) - Solo se Motorizzata e non Solo Tapparella -->
                            ${tap.manualeMot === 'Motorizzata' && tap.tipoSostituzione !== 'Solo Tapparella' ? `
                            <div class="bg-blue-50 border-2 border-blue-200 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-semibold text-blue-800 flex items-center gap-2">
                                        üîå Motori
                                    </h5>
                                    <button onclick="addMotoreTapparella('${project.id}', '${pos.id}')"
                                            class="px-3 py-1.5 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700">
                                        + Aggiungi Motore
                                    </button>
                                </div>
                                ${tap.motori && tap.motori.length > 0 ? `
                                    ${tap.motori.map((motore, idx) => `
                                        <div class="bg-white p-4 rounded border-2 border-blue-300 mb-3">
                                            <div class="flex justify-between items-center mb-3">
                                                <h6 class="text-sm font-semibold text-blue-700">üîå Motore ${idx + 1}</h6>
                                                <button onclick="removeMotoreTapparella('${project.id}', '${pos.id}', ${idx})"
                                                        class="text-red-600 hover:text-red-800 text-sm font-semibold px-2 py-1 hover:bg-red-50 rounded">
                                                    ‚úï Rimuovi
                                                </button>
                                            </div>
                                            
                                            <!-- Marca Motore -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700">üè≠ Marca</label>
                                                <input type="text" 
                                                       value="${motore.marca || ''}"
                                                       placeholder="Es: Somfy, Nice..."
                                                       list="marca-motore-list-${idx}"
                                                       onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'marca', this.value)"
                                                       class="w-full px-3 py-2 border rounded text-sm mt-1">
                                                <datalist id="marca-motore-list-${idx}">
                                                    <option value="Somfy">
                                                    <option value="Nice">
                                                    <option value="Cherubini">
                                                    <option value="BTicino">
                                                    <option value="Came">
                                                    <option value="Faac">
                                                </datalist>
                                            </div>

                                            <!-- Modello/Trasmettitore -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700">üì° Modello / Trasmettitore</label>
                                                <input type="text" 
                                                       value="${motore.modello || ''}"
                                                       placeholder="Es: LT, Oximo, Hybrid..."
                                                       list="modello-motore-list-${idx}"
                                                       onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'modello', this.value)"
                                                       class="w-full px-3 py-2 border rounded text-sm mt-1">
                                                <datalist id="modello-motore-list-${idx}">
                                                    <option value="LT">
                                                    <option value="Oximo">
                                                    <option value="Hybrid">
                                                    <option value="Era">
                                                    <option value="Neo">
                                                    <option value="Spider">
                                                </datalist>
                                            </div>

                                            <!-- Tipo Alimentazione -->
                                            <div class="mb-3">
                                                <label class="text-xs font-medium text-gray-700 block mb-2">‚ö° Tipo Alimentazione</label>
                                                <div class="flex gap-4">
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" 
                                                               name="alimentazione-${idx}" 
                                                               value="Filare"
                                                               ${!motore.alimentazione || motore.alimentazione === 'Filare' ? 'checked' : ''}
                                                               onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'alimentazione', this.value)"
                                                               class="w-4 h-4">
                                                        <span class="text-sm">üîå Filare</span>
                                                    </label>
                                                    <label class="flex items-center gap-2 cursor-pointer">
                                                        <input type="radio" 
                                                               name="alimentazione-${idx}" 
                                                               value="Telecomando"
                                                               ${motore.alimentazione === 'Telecomando' ? 'checked' : ''}
                                                               onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'alimentazione', this.value)"
                                                               class="w-4 h-4">
                                                        <span class="text-sm">üìª Telecomando</span>
                                                    </label>
                                                </div>
                                            </div>

                                            <!-- Trasmettitore (solo se Telecomando) -->
                                            ${motore.alimentazione === 'Telecomando' ? `
                                                <div class="bg-purple-50 border-2 border-purple-200 rounded-lg p-3">
                                                    <label class="text-xs font-medium text-purple-800 block mb-2">üìª Trasmettitore</label>
                                                    <input type="text" 
                                                           value="${motore.trasmettitore || ''}"
                                                           placeholder="Es: RTS, IO, Telis..."
                                                           onchange="updateMotoreTapparellaField('${project.id}', '${pos.id}', ${idx}, 'trasmettitore', this.value)"
                                                           class="w-full px-3 py-2 border border-purple-300 rounded text-sm">
                                                </div>
                                            ` : ''}
                                        </div>
                                    `).join('')}
                                ` : `
                                    <p class="text-sm text-gray-500 italic text-center py-3">Nessun motore aggiunto</p>
                                `}
                            </div>
                            ` : ''}

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!tap.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'tapparella')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'tapparella')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!tap.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigTapparelle?.misuraBaseL || '?'} ${project.brmConfigTapparelle?.operazioneL || '-'} ${project.brmConfigTapparelle?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigTapparelle?.misuraBaseH || '?'} ${project.brmConfigTapparelle?.operazioneH || '-'} ${project.brmConfigTapparelle?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${tap.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${tap.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${tap.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${tap.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${tap.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-tapparella-${pos.id}" value="${tap.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-tapparella-${pos.id}">
                                                = ${tap.brmPersonalizzato?.misuraBaseL || '?'} ${tap.brmPersonalizzato?.operazioneL || '+'} ${tap.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${tap.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-tapparella-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${tap.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${tap.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-tapparella-${pos.id}" value="${tap.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-tapparella-${pos.id}">
                                                = ${tap.brmPersonalizzato?.misuraBaseH || '?'} ${tap.brmPersonalizzato?.operazioneH || '+'} ${tap.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'tapparella')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${tap.BRM_L || ''}" readonly id="brm-l-result-tapparella-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${tap.BRM_H || ''}" readonly id="brm-h-result-tapparella-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${tap.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'tapparella', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${tap.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderZanzariereTab(project, pos) {
            const zan = pos.zanzariera;
            
            return `
                <div class="space-y-4">
                    ${!zan ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessuna zanzariera configurata</p>
                            <button onclick="addZanzariera('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-green-600 text-white rounded-lg font-medium hover:bg-green-700">
                                + Aggiungi Zanzariera
                            </button>
                        </div>
                    ` : (parseInt(zan.qta) === 0 || zan.qta === '0' || zan.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-green-700 text-lg">ü¶ü Zanzariera</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'zanzariera')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(zan.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-green-700 text-lg">ü¶ü Zanzariera</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'zanzariera')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- ‚öôÔ∏è TIPO INFISSO ASSOCIATO -->
                            <div class="bg-yellow-50 border-2 border-yellow-300 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-yellow-800 mb-3 flex items-center gap-2">
                                    üîß Tipo Infisso Associato
                                </h5>
                                <p class="text-sm text-gray-600 mb-3">Seleziona tipo:</p>
                                <div class="flex gap-6">
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfisso-${project.id}-${pos.id}"
                                               value="F"
                                               ${zan.tipoInfissoAssociato === 'F' ? 'checked' : ''}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoInfissoAssociato', 'F')"
                                               class="w-4 h-4">
                                        <span class="font-medium">F (Finestra)</span>
                                    </label>
                                    <label class="flex items-center gap-2 cursor-pointer">
                                        <input type="radio" 
                                               name="tipoInfisso-${project.id}-${pos.id}"
                                               value="PF"
                                               ${zan.tipoInfissoAssociato === 'PF' ? 'checked' : ''}
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoInfissoAssociato', 'PF')"
                                               class="w-4 h-4">
                                        <span class="font-medium">PF (Porta Finestra)</span>
                                    </label>
                                </div>
                                ${!zan.tipoInfissoAssociato ? `
                                    <div class="mt-3 bg-amber-100 border-l-4 border-amber-500 p-3">
                                        <p class="text-sm text-amber-800">‚ö†Ô∏è Seleziona prima se F o PF</p>
                                    </div>
                                ` : ''}
                            </div>

                            <!-- üìã DATI SPECIFICI -->
                            <div class="bg-green-50 border-2 border-green-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-green-800 mb-3 flex items-center gap-2">
                                    üìã Dati Specifici
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(zan.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipo', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            <option value="Avvolgibile" ${zan.tipo === 'Avvolgibile' ? 'selected' : ''}>Avvolgibile</option>
                                            <option value="Pliss√©" ${zan.tipo === 'Pliss√©' ? 'selected' : ''}>Pliss√©</option>
                                            <option value="Battente" ${zan.tipo === 'Battente' ? 'selected' : ''}>Battente</option>
                                            <option value="Scorrevole" ${zan.tipo === 'Scorrevole' ? 'selected' : ''}>Scorrevole</option>
                                            <option value="Fissa" ${zan.tipo === 'Fissa' ? 'selected' : ''}>Fissa</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Apertura</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'apertura', this.value)"
                                                class="w-full compact-input border rounded mt-1">
                                            <option value="">--</option>
                                            <option value="SP SX" ${zan.apertura === 'SP SX' ? 'selected' : ''}>SP SX</option>
                                            <option value="SP DX" ${zan.apertura === 'SP DX' ? 'selected' : ''}>SP DX</option>
                                            <option value="SCORR SX" ${zan.apertura === 'SCORR SX' ? 'selected' : ''}>SCORR SX</option>
                                            <option value="SCORR DX" ${zan.apertura === 'SCORR DX' ? 'selected' : ''}>SCORR DX</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <!-- ‚öôÔ∏è CONFIGURAZIONE -->
                            <div class="bg-teal-50 border-2 border-teal-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-teal-800 mb-3 flex items-center gap-2">
                                    ‚öôÔ∏è Configurazione
                                </h5>
                                <div class="grid md:grid-cols-2 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Colore Telaio</label>
                                        <input type="text" value="${zan.coloreTelaio || ''}"
                                               placeholder="Es: Bianco, Marrone"
                                               list="coloreTel-zan-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'coloreTelaio', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreTel-zan-list-${pos.id}">
                                            <option value="Bianco">
                                            <option value="Marrone">
                                            <option value="Grigio">
                                            <option value="Nero">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Tipo Rete</label>
                                        <input type="text" value="${zan.tipoRete || ''}"
                                               placeholder="Es: Standard, Anti-polline"
                                               list="tipoRete-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'tipoRete', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tipoRete-list-${pos.id}">
                                            <option value="Standard">
                                            <option value="Anti-polline">
                                            <option value="Pet-resistant">
                                            <option value="Micro-forata">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore Rete</label>
                                        <input type="text" value="${zan.coloreRete || ''}"
                                               placeholder="Es: Nero, Grigio"
                                               list="coloreRete-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'coloreRete', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="coloreRete-list-${pos.id}">
                                            <option value="Nero">
                                            <option value="Grigio">
                                            <option value="Bianco">
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    ${!zan.brmPersonalizzato ? `
                                        <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'zanzariera')"
                                                class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                            üé® Personalizza BRM
                                        </button>
                                    ` : `
                                        <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'zanzariera')"
                                                class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                            ‚Ü©Ô∏è Usa Globale
                                        </button>
                                    `}
                                </div>
                                
                                ${!zan.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigZanzariere?.misuraBaseL || '?'} ${project.brmConfigZanzariere?.operazioneL || '-'} ${project.brmConfigZanzariere?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigZanzariere?.misuraBaseH || '?'} ${project.brmConfigZanzariere?.operazioneH || '-'} ${project.brmConfigZanzariere?.valoreH || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${zan.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${zan.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LF', 'LPF', 'LVT', 'LVAR', 'TMV', 'LS'].map(m => `
                                                            <option value="${m}" ${zan.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${zan.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${zan.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-zanzariera-${pos.id}" value="${zan.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-zanzariera-${pos.id}">
                                                = ${zan.brmPersonalizzato?.misuraBaseL || '?'} ${zan.brmPersonalizzato?.operazioneL || '+'} ${zan.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['HF', 'HPF', 'HVT', 'HVAR', 'HMT', 'HSoffitto', 'HParapettoSoffitto', 'HPavimentoParapetto'].map(m => `
                                                            <option value="${m}" ${zan.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-zanzariera-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${zan.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${zan.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-zanzariera-${pos.id}" value="${zan.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-zanzariera-${pos.id}">
                                                = ${zan.brmPersonalizzato?.misuraBaseH || '?'} ${zan.brmPersonalizzato?.operazioneH || '+'} ${zan.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'zanzariera')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${zan.BRM_L || ''}" readonly id="brm-l-result-zanzariera-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${zan.BRM_H || ''}" readonly id="brm-h-result-zanzariera-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${zan.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'zanzariera', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${zan.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

                function renderCassonettiTab(project, pos) {
            const cas = pos.cassonetto;
            
            return `
                <div class="space-y-4">
                    ${!cas ? `
                        <div class="text-center py-8 bg-gray-50 rounded-lg">
                            <p class="text-gray-600 mb-4">Nessun cassonetto configurato</p>
                            <button onclick="addCassonetto('${project.id}', '${pos.id}')"
                                    class="px-6 py-2 bg-orange-600 text-white rounded-lg font-medium hover:bg-orange-700">
                                + Aggiungi Cassonetto
                            </button>
                        </div>
                    ` : (parseInt(cas.qta) === 0 || cas.qta === '0' || cas.qta === 0) ? `
                        <!-- üÜï FASE 016: Visualizzazione minimale quando qta=0 -->
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-orange-700 text-lg">üì¶ Cassonetto</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'cassonetto')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <div class="bg-gray-50 border-2 border-gray-300 rounded-lg p-4">
                                <p class="text-sm text-gray-600 mb-3">
                                    üí° <strong>Quantit√† = 0</strong> ‚Üí Prodotto non presente in questa posizione. 
                                    <br>Aumenta la quantit√† per configurare il prodotto.
                                </p>
                                <div class="max-w-xs">
                                    <label class="text-xs font-medium block mb-1">Quantit√†</label>
                                    <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'qta', this.value)"
                                            class="w-full compact-input border rounded font-semibold">
                                        ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                            <option value="${n}" ${(cas.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                        `).join('')}
                                    </select>
                                </div>
                            </div>
                        </div>
                    ` : `
                        <div class="product-card">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="font-semibold text-orange-700 text-lg">üì¶ Cassonetto</h4>
                                <button onclick="deleteProduct('${project.id}', '${pos.id}', 'cassonetto')"
                                        class="px-3 py-1.5 bg-red-600 text-white rounded-lg font-medium text-sm hover:bg-red-700">
                                    üóëÔ∏è Elimina
                                </button>
                            </div>
                            
                            <!-- üìã DATI GENERALI -->
                            <div class="bg-orange-50 border-2 border-orange-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-orange-800 mb-3 flex items-center gap-2">
                                    üìã Dati Generali
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">Quantit√†</label>
                                        <select onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'qta', this.value)"
                                                class="w-full compact-input border rounded mt-1 font-semibold">
                                            ${[0,1,2,3,4,5,6,7,8,9,10].map(n => `
                                                <option value="${n}" ${(cas.qta || '1') == n ? 'selected' : ''}>${n}</option>
                                            `).join('')}
                                        </select>
                                    </div>

                                    <div>
                                        <label class="text-xs font-medium">Tipo</label>
                                        <input type="text" value="${cas.tipo || ''}"
                                               placeholder="Cassonetto"
                                               list="tipo-cas-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'tipo', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="tipo-cas-list-${pos.id}">
                                            <option value="Cassonetto">
                                            <option value="Cassonetto termico">
                                            <option value="Cassonetto ispezionabile">
                                        </datalist>
                                    </div>
                                </div>
                                
                                <!-- üÜï FASE 027E: Tipo Cassonetto con select+custom -->
                                <div class="mt-3">
                                    ${renderSelectWithCustom(
                                        'tipoCassonetto',
                                        cas.tipoCassonetto || '',
                                        ['LARGH_CASS', 'LS', 'LVT', 'TMV', 'LP', 'MIS_FIN_INF_L', 'LS+SRDX+SRSX'],
                                        project.id,
                                        pos.id,
                                        'cassonetto',
                                        'üìè Tipo Cassonetto'
                                    )}
                                </div>
                                
                                <!-- üÜï FASE 027E: ISOLAMENTO E MONOBLOCCO -->
                                <div class="grid md:grid-cols-2 gap-3 mt-3">
                                    <div>
                                        ${renderSelectWithCustom(
                                            'isolamento',
                                            cas.isolamento || project.configCassonetti?.isolamento || '',
                                            ['S√¨', 'No', 'Parziale', 'Standard', 'Rinforzato'],
                                            project.id,
                                            pos.id,
                                            'cassonetto',
                                            'üõ°Ô∏è Isolamento'
                                        )}
                                    </div>
                                    <div>
                                        ${renderSelectWithCustom(
                                            'monoblocco',
                                            cas.monoblocco || project.configCassonetti?.monoblocco || '',
                                            ['S√¨', 'No'],
                                            project.id,
                                            pos.id,
                                            'cassonetto',
                                            'üì¶ Monoblocco'
                                        )}
                                    </div>
                                </div>
                                
                                <div class="grid md:grid-cols-3 gap-3 mt-3">
                                    <div>
                                        <label class="text-xs font-medium">Azienda</label>
                                        <input type="text" value="${cas.azienda || ''}"
                                               placeholder="finstral"
                                               list="azienda-cas-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'azienda', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="azienda-cas-list-${pos.id}">
                                            <option value="finstral">
                                            <option value="essepi">
                                            <option value="schuco">
                                            <option value="internorm">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Colore</label>
                                        <input type="text" value="${cas.colore || ''}"
                                               placeholder="42"
                                               list="colore-cas-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'colore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="colore-cas-list-${pos.id}">
                                            <option value="42">
                                            <option value="Bianco">
                                            <option value="L55">
                                            <option value="RAL 9010">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">Sovrappi/Sostit</label>
                                        <input type="text" value="${cas.sovrappiSostit || ''}"
                                               placeholder="--"
                                               list="sovrappi-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'sovrappiSostit', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="sovrappi-list-${pos.id}">
                                            <option value="Sovrapposizione">
                                            <option value="Sostituzione">
                                            <option value="Nuova installazione">
                                        </datalist>
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">A Soffitto</label>
                                        <input type="text" value="${cas.aSoffitto || ''}"
                                               placeholder="--"
                                               list="aSoffitto-list-${pos.id}"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'aSoffitto', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                        <datalist id="aSoffitto-list-${pos.id}">
                                            <option value="S√¨">
                                            <option value="No">
                                        </datalist>
                                    </div>
                                </div>
                            </div>

                            <!-- üìè MISURE CASSONETTO (mm) -->
                            <div class="bg-amber-50 border-2 border-amber-200 rounded-lg p-4 mb-3">
                                <h5 class="font-semibold text-amber-800 mb-3 flex items-center gap-2">
                                    üìè Misure Cassonetto (mm)
                                </h5>
                                <div class="grid md:grid-cols-3 gap-3">
                                    <div>
                                        <label class="text-xs font-medium">LS</label>
                                        <input type="number" value="${cas.LS || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'LS', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">SRSX</label>
                                        <input type="number" value="${cas.SRSX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRSX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">ZSX</label>
                                        <input type="number" value="${cas.ZSX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'ZSX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">SRDX</label>
                                        <input type="number" value="${cas.SRDX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'SRDX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">ZDX</label>
                                        <input type="number" value="${cas.ZDX || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'ZDX', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">HCASS</label>
                                        <input type="number" value="${cas.HCASS || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'HCASS', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">B</label>
                                        <input type="number" value="${cas.B || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'B', this.value); validateCassonettoBC('${project.id}', '${pos.id}');"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">C</label>
                                        <input type="number" value="${cas.C || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'C', this.value); validateCassonettoBC('${project.id}', '${pos.id}');"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                    <div>
                                        <label class="text-xs font-medium">BSuperiore</label>
                                        <input type="number" value="${cas.BSuperiore || '0'}"
                                               placeholder="0"
                                               onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'BSuperiore', this.value)"
                                               class="w-full compact-input border rounded mt-1">
                                    </div>
                                </div>
                                
                                ${(() => {
                                    // Validazione B - C = Prof. Muro Int ¬± 10mm
                                    const b = parseFloat(cas.B) || 0;
                                    const c = parseFloat(cas.C) || 0;
                                    const diff = b - c;
                                    
                                    // Prendi Prof. Muro Int (override o globale)
                                    const profMuroInt = pos.caratteristicheMuroOverride?.profMuroInt 
                                        ? parseFloat(pos.caratteristicheMuroOverride.profMuroInt) 
                                        : parseFloat(project.caratteristicheMuro?.profMuroInt) || 0;
                                    
                                    if (b === 0 || c === 0 || profMuroInt === 0) {
                                        return `
                                            <div class="mt-3 bg-gray-100 border-l-4 border-gray-400 p-3">
                                                <p class="text-sm text-gray-600">
                                                    ‚ÑπÔ∏è Inserisci B, C e Prof. Muro Int per attivare il controllo
                                                </p>
                                            </div>
                                        `;
                                    }
                                    
                                    const differenza = Math.abs(diff - profMuroInt);
                                    const isValid = differenza <= 10;
                                    
                                    if (isValid) {
                                        return `
                                            <div class="mt-3 bg-green-100 border-l-4 border-green-500 p-3">
                                                <p class="text-sm text-green-800">
                                                    ‚úÖ <strong>Controllo OK:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm ‚úì
                                                </p>
                                            </div>
                                        `;
                                    } else {
                                        return `
                                            <div class="mt-3 bg-red-100 border-l-4 border-red-500 p-3">
                                                <p class="text-sm text-red-800">
                                                    ‚ö†Ô∏è <strong>ATTENZIONE:</strong> B - C = ${diff.toFixed(1)}mm | Prof. Muro Int = ${profMuroInt}mm | Differenza = ${differenza.toFixed(1)}mm (Tolleranza ¬±10mm superata!)
                                                </p>
                                            </div>
                                        `;
                                    }
                                })()}
                                
                                ${(() => {
                                    // ‚ö†Ô∏è CONTROLLI ALTEZZE CON CASSONETTO
                                    const hcass = parseFloat(cas.HCASS) || 0;
                                    const hmt = parseFloat(pos.misure?.HMT) || 0;
                                    const hsoffitto = parseFloat(pos.misure?.HSoffitto) || 0;
                                    const hPavParapetto = parseFloat(pos.misure?.HPavimentoParapetto) || 0;
                                    const hParapettoSoff = parseFloat(pos.misure?.HParapettoSoffitto) || 0;
                                    
                                    // Determina se √® PF o F dal tipo infisso
                                    const tipoInfisso = pos.infisso?.tipo || '';
                                    const isPF = tipoInfisso.includes('PF');
                                    const isF = tipoInfisso.includes('F') && !isPF;
                                    
                                    let warnings = [];
                                    
                                    // ‚úÖ CONTROLLO 1: PF ‚Üí HMT + HCASS < HSoffitto
                                    if (isPF && hmt > 0 && hcass > 0 && hsoffitto > 0) {
                                        const somma = hmt + hcass;
                                        if (somma < hsoffitto) {
                                            warnings.push({
                                                type: 'success',
                                                msg: `‚úÖ <strong>PF OK:</strong> HMT + HCASS (${hmt} + ${hcass} = ${somma}mm) < HSoffitto (${hsoffitto}mm) ‚úì`
                                            });
                                        } else {
                                            warnings.push({
                                                type: 'error',
                                                msg: `‚ö†Ô∏è <strong>PF ERRORE:</strong> HMT + HCASS (${hmt} + ${hcass} = ${somma}mm) >= HSoffitto (${hsoffitto}mm)!`
                                            });
                                        }
                                    }
                                    
                                    // ‚úÖ CONTROLLO 2: F ‚Üí HPavimentoParapetto + HMT + HCASS <= HSoffitto
                                    if (isF && hPavParapetto > 0 && hmt > 0 && hcass > 0 && hsoffitto > 0) {
                                        const somma = hPavParapetto + hmt + hcass;
                                        if (somma <= hsoffitto) {
                                            warnings.push({
                                                type: 'success',
                                                msg: `‚úÖ <strong>F OK:</strong> HPav/Parap + HMT + HCASS (${hPavParapetto} + ${hmt} + ${hcass} = ${somma}mm) <= HSoffitto (${hsoffitto}mm) ‚úì`
                                            });
                                        } else {
                                            warnings.push({
                                                type: 'error',
                                                msg: `‚ö†Ô∏è <strong>F ERRORE:</strong> HPav/Parap + HMT + HCASS (${hPavParapetto} + ${hmt} + ${hcass} = ${somma}mm) > HSoffitto (${hsoffitto}mm)!`
                                            });
                                        }
                                    }
                                    
                                    // ‚úÖ CONTROLLO 3: HPavimentoParapetto + HParapettoSoffitto = HSoffitto ¬± 10mm
                                    if (hPavParapetto > 0 && hParapettoSoff > 0 && hsoffitto > 0) {
                                        const somma = hPavParapetto + hParapettoSoff;
                                        const diff = Math.abs(somma - hsoffitto);
                                        if (diff <= 10) {
                                            warnings.push({
                                                type: 'success',
                                                msg: `‚úÖ <strong>ALTEZZE OK:</strong> HPav/Parap + HParap/Soff (${hPavParapetto} + ${hParapettoSoff} = ${somma}mm) = HSoffitto (${hsoffitto}mm) ¬± 10mm | Diff: ${diff.toFixed(1)}mm ‚úì`
                                            });
                                        } else {
                                            warnings.push({
                                                type: 'error',
                                                msg: `‚ö†Ô∏è <strong>ALTEZZE ERRORE:</strong> HPav/Parap + HParap/Soff (${hPavParapetto} + ${hParapettoSoff} = ${somma}mm) ‚â† HSoffitto (${hsoffitto}mm) | Diff: ${diff.toFixed(1)}mm (Tolleranza ¬±10mm superata!)`
                                            });
                                        }
                                    }
                                    
                                    // Genera HTML per i messaggi
                                    if (warnings.length === 0) {
                                        return ''; // Nessun controllo applicabile
                                    }
                                    
                                    return warnings.map(w => {
                                        const bgColor = w.type === 'success' ? 'bg-green-100' : 'bg-red-100';
                                        const borderColor = w.type === 'success' ? 'border-green-500' : 'border-red-500';
                                        const textColor = w.type === 'success' ? 'text-green-800' : 'text-red-800';
                                        
                                        return `
                                            <div class="mt-3 ${bgColor} border-l-4 ${borderColor} p-3">
                                                <p class="text-sm ${textColor}">${w.msg}</p>
                                            </div>
                                        `;
                                    }).join('');
                                })()}
                                
                                <div class="mt-3 bg-blue-100 border-l-4 border-blue-500 p-3">
                                    <p class="text-sm text-blue-800">
                                        üìù <strong>Note:</strong> Se SRSX = ZSX ‚Üí Muro a SX | Se SRDX = ZDX ‚Üí Muro a DX
                                    </p>
                                </div>
                            </div>

                            <div class="bg-amber-50 border-2 border-amber-300 rounded-lg p-4 mb-3">
                                <div class="flex justify-between items-center mb-3">
                                    <h5 class="font-bold text-amber-800 flex items-center gap-2">
                                        üìè BRM - Misura per Ordine
                                    </h5>
                                    <div class="flex gap-2">
                                        ${!cas.brmPersonalizzato ? `
                                            <button onclick="ricalcolaBRMCassonetto('${project.id}', '${pos.id}')"
                                                    class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-medium text-sm transition-all">
                                                üîÑ Ricalcola BRM
                                            </button>
                                            <button onclick="personalizzaBRM('${project.id}', '${pos.id}', 'cassonetto')"
                                                    class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-medium text-sm transition-all">
                                                üé® Personalizza BRM
                                            </button>
                                        ` : `
                                            <button onclick="ripristinaGlobale('${project.id}', '${pos.id}', 'cassonetto')"
                                                    class="px-3 py-1.5 bg-green-600 hover:bg-green-700 text-white rounded-lg font-medium text-sm transition-all">
                                                ‚Ü©Ô∏è Usa Globale
                                            </button>
                                        `}
                                    </div>
                                </div>
                                
                                ${!cas.brmPersonalizzato ? `
                                    <div class="bg-white p-3 rounded border-2 border-amber-400">
                                        <p class="text-sm text-amber-800 mb-2"><strong>Formula Globale Attiva:</strong></p>
                                        <div class="grid grid-cols-2 gap-3 text-sm">
                                            <div><span class="font-semibold">BRM L =</span> ${project.brmConfigCassonetti?.misuraBaseL || '?'} ${project.brmConfigCassonetti?.operazioneL || '-'} ${project.brmConfigCassonetti?.valoreL || '0'}mm</div>
                                            <div><span class="font-semibold">BRM H =</span> ${project.brmConfigCassonetti?.misuraBaseH || '?'} ${project.brmConfigCassonetti?.operazioneH || '-'} ${project.brmConfigCassonetti?.valoreH || '0'}mm</div>
                                            <div><span class="font-semibold">BRM C =</span> ${project.brmConfigCassonetti?.misuraBaseC || '?'} ${project.brmConfigCassonetti?.operazioneC || '-'} ${project.brmConfigCassonetti?.valoreC || '0'}mm</div>
                                            <div><span class="font-semibold">BRM B =</span> ${project.brmConfigCassonetti?.misuraBaseB || '?'} ${project.brmConfigCassonetti?.operazioneB || '-'} ${project.brmConfigCassonetti?.valoreB || '0'}mm</div>
                                        </div>
                                    </div>
                                    <div class="grid md:grid-cols-2 gap-3 mt-3">
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Larghezza</label>
                                            <input type="number" value="${cas.BRM_L || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM Altezza</label>
                                            <input type="number" value="${cas.BRM_H || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM C</label>
                                            <input type="number" value="${cas.BRM_C || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border">
                                            <label class="text-xs font-semibold text-amber-800 block">üìè BRM B</label>
                                            <input type="number" value="${cas.BRM_B || ''}" readonly class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                ` : `
                                    <div class="bg-white p-3 rounded border-2 border-purple-400 mb-3">
                                        <p class="text-sm font-semibold text-purple-800 mb-2">‚öôÔ∏è Formula Personalizzata:</p>
                                        
                                        <!-- BRM Larghezza -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Larghezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseL-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['LARGH_CASS', 'SRDX', 'SRSX', 'LS', 'LVT', 'LF', 'TMV'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseL === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneL-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneL', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneL === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneL === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreL-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreL || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreL', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-l-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseL || '?'} ${cas.brmPersonalizzato?.operazioneL || '+'} ${cas.brmPersonalizzato?.valoreL || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM Altezza -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM Altezza</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseH-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['ALT_CASS', 'HF', 'HVT', 'HMT', 'PROFONDITA'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseH === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneH-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneH', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneH === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneH === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreH-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreH || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreH', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-h-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseH || '?'} ${cas.brmPersonalizzato?.operazioneH || '+'} ${cas.brmPersonalizzato?.valoreH || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM C -->
                                        <div class="mb-3">
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM C</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseC-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseC', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['C', 'B', 'HCASS', 'BSuperiore'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseC === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneC-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneC', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneC === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneC === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreC-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreC || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreC', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-c-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseC || '?'} ${cas.brmPersonalizzato?.operazioneC || '+'} ${cas.brmPersonalizzato?.valoreC || '0'}mm
                                            </div>
                                        </div>
                                        
                                        <!-- BRM B -->
                                        <div>
                                            <label class="text-xs font-semibold text-purple-800 block mb-1">üìè BRM B</label>
                                            <div class="grid grid-cols-3 gap-2">
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Misura</label>
                                                    <select id="brm-misuraBaseB-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'misuraBaseB', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="">-</option>
                                                        ${['B', 'C', 'HCASS', 'BSuperiore'].map(m => `
                                                            <option value="${m}" ${cas.brmPersonalizzato?.misuraBaseB === m ? 'selected' : ''}>${m}</option>
                                                        `).join('')}
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">Op.</label>
                                                    <select id="brm-operazioneB-cassonetto-${pos.id}" onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'operazioneB', this.value)"
                                                            class="w-full px-2 py-1 border border-purple-500 rounded text-sm bg-white">
                                                        <option value="+" ${cas.brmPersonalizzato?.operazioneB === '+' ? 'selected' : ''}>+</option>
                                                        <option value="-" ${cas.brmPersonalizzato?.operazioneB === '-' ? 'selected' : ''}>-</option>
                                                    </select>
                                                </div>
                                                <div>
                                                    <label class="text-xs text-gray-600 block mb-1">mm</label>
                                                    <input type="number" id="brm-valoreB-cassonetto-${pos.id}" value="${cas.brmPersonalizzato?.valoreB || '0'}"
                                                           onchange="updateBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto', 'valoreB', this.value)"
                                                           class="w-full px-2 py-1 border border-purple-500 rounded text-sm">
                                                </div>
                                            </div>
                                            <div class="mt-1 text-xs text-purple-700 font-semibold" id="formula-brm-b-cassonetto-${pos.id}">
                                                = ${cas.brmPersonalizzato?.misuraBaseB || '?'} ${cas.brmPersonalizzato?.operazioneB || '+'} ${cas.brmPersonalizzato?.valoreB || '0'}mm
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- üíæ PULSANTE APPLICA MODIFICHE BRM -->
                                    <div class="mt-3 flex justify-center">
                                        <button onclick="applicaBRMPersonalizzato('${project.id}', '${pos.id}', 'cassonetto')"
                                                class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded text-xs transition-all">
                                            üíæ Salva
                                        </button>
                                    </div>
                                    
                                    <!-- Risultati BRM Calcolati -->
                                    <div class="grid md:grid-cols-2 gap-3">
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Larghezza</label>
                                            <input type="number" value="${cas.BRM_L || ''}" readonly id="brm-l-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM Altezza</label>
                                            <input type="number" value="${cas.BRM_H || ''}" readonly id="brm-h-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM C</label>
                                            <input type="number" value="${cas.BRM_C || ''}" readonly id="brm-c-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                        <div class="bg-white p-2 rounded border-2 border-green-500">
                                            <label class="text-xs font-semibold text-green-800 block">‚úÖ BRM B</label>
                                            <input type="number" value="${cas.BRM_B || ''}" readonly id="brm-b-result-cassonetto-${pos.id}"
                                                   class="w-full compact-input border rounded mt-1 font-bold text-lg bg-gray-50">
                                        </div>
                                    </div>
                                `}
                            </div>

                            <div class="mt-3">
                                <label class="text-xs font-medium">üìù Note</label>
                                <textarea value="${cas.note || ''}"
                                          onchange="updateProduct('${project.id}', '${pos.id}', 'cassonetto', 'note', this.value)"
                                          class="w-full compact-input border rounded mt-1"
                                          rows="2">${cas.note || ''}</textarea>
                            </div>
                        </div>
                    `}
                </div>
            `;
        }

        function renderFotoTab(project, pos) {
            return `
                <div class="bg-blue-50 border-2 border-blue-300 rounded-lg p-4">
                    <h4 class="font-semibold text-blue-700 mb-3">üì∏ Foto Posizione</h4>
                    
                    <div class="mb-3">
                        <input type="file" 
                               id="foto-input-${pos.id}" 
                               accept="image/*" 
                               onchange="addFoto('${project.id}', '${pos.id}', this)"
                               class="hidden">
                        <button onclick="document.getElementById('foto-input-${pos.id}').click()" 
                                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg font-semibold">
                            üì∑ Carica Foto
                        </button>
                        <p class="text-xs text-gray-600 mt-2">Click per selezionare un'immagine dal dispositivo</p>
                    </div>
                    
                    ${pos.foto && pos.foto.length > 0 ? `
                        <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                            ${pos.foto.map((foto, idx) => `
                                <div class="relative group">
                                    <img src="${foto.data}" 
                                         onclick="showFotoModal('${foto.data}')"
                                         class="w-full h-32 object-cover rounded-lg border-2 border-gray-300 cursor-pointer hover:border-blue-500 transition-all">
                                    <button onclick="removeFoto('${project.id}', '${pos.id}', ${idx})"
                                            class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                                        ‚úï
                                    </button>
                                    <p class="text-xs text-center mt-1 text-gray-600">Foto ${idx + 1}</p>
                                </div>
                            `).join('')}
                        </div>
                    ` : '<p class="text-sm text-gray-500 italic">Nessuna foto caricata</p>'}
                </div>
            `;
        }

        function NewProjectModal() {
            return `
                <div id="modal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
                    <div class="bg-white rounded-xl p-6 max-w-md w-full mx-4 shadow-2xl">
                        <h3 class="text-xl font-bold mb-4">Nuovo Progetto</h3>
                        <div class="mb-3">
                            <input type="text" id="projectClient" placeholder="Cliente" 
                                   required
                                   class="w-full px-3 py-2 border-2 border-purple-300 rounded-lg focus:border-purple-500 focus:outline-none">
                            <p class="text-xs text-gray-500 mt-1">* Obbligatorio - Identifica il progetto</p>
                        </div>
                        <div class="mb-4">
                            <input type="text" id="projectName" placeholder="Nome progetto (opzionale)" 
                                   class="w-full px-3 py-2 border rounded-lg focus:border-blue-400 focus:outline-none">
                        </div>
                        <div class="flex gap-3">
                            <button onclick="hideModal()" 
                                    class="flex-1 px-4 py-2 border rounded-lg hover:bg-gray-50">
                                Annulla
                            </button>
                            <button onclick="createNewProject()" 
                                    class="flex-1 px-4 py-2 bg-gradient-to-r from-purple-600 to-blue-600 text-white rounded-lg font-medium">
                                Crea
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        function FotoModal() {
            return `
                <div id="foto-modal" class="hidden fixed inset-0 bg-black/90 flex items-center justify-center z-50" onclick="hideFotoModal()">
                    <div class="relative max-w-4xl max-h-screen p-4">
                        <button onclick="hideFotoModal()" class="absolute top-2 right-2 bg-white text-black rounded-full w-10 h-10 flex items-center justify-center font-bold hover:bg-gray-200">
                            ‚úï
                        </button>
                        <img id="foto-modal-img" src="" class="max-w-full max-h-screen object-contain rounded-lg">
                    </div>
                </div>
            `;
        }

        // Window Functions
        window.showNewProjectModal = () => document.getElementById('modal').classList.remove('hidden');
        window.hideModal = () => document.getElementById('modal').classList.add('hidden');

        window.createNewProject = () => {
            const name = document.getElementById('projectName').value.trim();
            const client = document.getElementById('projectClient').value.trim();
            
            // Cliente obbligatorio, Nome progetto opzionale
            if (!client) {
                alert('Il campo Cliente √® obbligatorio!');
                return;
            }
            
            // Se nome progetto non √® inserito, usa il nome del cliente
            const projectName = name || client;
            
            createProject(projectName, client);
            hideModal();
            state.screen = 'project';
            render();
        };

        window.goBack = () => {
            if (state.screen === 'position') {
                state.screen = 'project';
            } else {
                state.screen = 'list';
            }
            render();
        };

        window.openProject = (id) => {
            state.currentProject = id;
            state.screen = 'project';
            render();
        };

        window.openPosition = (id) => {
            state.currentPosition = id;
            state.screen = 'position';
            state.showRiepilogoRilievi = false;  // Reset flag riepilogo
            render();
        };

        // üÜï FASE 014 - Controllo completamento prima cambio posizione
        window.switchPosition = (id) => {
            const project = state.projects.find(p => p.positions.some(pos => pos.id === state.currentPosition));
            const currentPos = project?.positions.find(p => p.id === state.currentPosition);
            
            // Se c'√® una posizione corrente, controlla completamento
            if (currentPos && currentPos.id !== id) {
                const comp = calculatePositionCompleteness(currentPos);
                
                // Se non √® completa al 100%, mostra warning
                if (comp.percentage < 100) {
                    const missingText = comp.missing.length > 0 
                        ? `\n\nMancanti:\n‚Ä¢ ${comp.missing.join('\n‚Ä¢ ')}` 
                        : '';
                    
                    const proceed = confirm(
                        `‚ö†Ô∏è ATTENZIONE: La posizione "${currentPos.name}" non √® completa al 100%!\n` +
                        `Completamento attuale: ${comp.percentage}%${missingText}\n\n` +
                        `Vuoi comunque cambiare posizione?`
                    );
                    
                    if (!proceed) {
                        // Utente ha annullato, rimane sulla posizione corrente
                        render(); // Ri-renderizza per resettare il dropdown
                        return;
                    }
                }
            }
            
            // Cambio posizione
            state.currentPosition = id;
            render();
        };

        window.printChecklistRilievi = (projectId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (!project) return;
            
            // Genera HTML per stampa
            const printHTML = `
                <!DOCTYPE html>
                <html>
                <head>
                    <meta charset="UTF-8">
                    <title>Checklist Rilievi - ${project.nome || 'Progetto'}</title>
                    <style>
                        @media print {
                            @page { margin: 1cm; }
                            body { margin: 0; }
                        }
                        body {
                            font-family: Arial, sans-serif;
                            padding: 20px;
                            max-width: 1200px;
                            margin: 0 auto;
                        }
                        h1 {
                            color: #6B46C1;
                            border-bottom: 3px solid #6B46C1;
                            padding-bottom: 10px;
                        }
                        h2 {
                            color: #4A5568;
                            margin-top: 30px;
                        }
                        table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 20px 0;
                            page-break-inside: avoid;
                        }
                        th {
                            background: #6B46C1;
                            color: white;
                            padding: 12px;
                            text-align: left;
                            font-size: 14px;
                        }
                        td {
                            padding: 10px;
                            border: 1px solid #E2E8F0;
                        }
                        tr:nth-child(even) {
                            background: #F7FAFC;
                        }
                        .header-info {
                            background: #EDF2F7;
                            padding: 15px;
                            border-radius: 8px;
                            margin-bottom: 20px;
                        }
                        .check-box {
                            display: inline-block;
                            width: 18px;
                            height: 18px;
                            border: 2px solid #4A5568;
                            margin: 0 5px;
                            vertical-align: middle;
                        }
                        .check-filled {
                            background: #48BB78;
                            border-color: #48BB78;
                        }
                        .missing {
                            color: #E53E3E;
                            font-weight: bold;
                        }
                        .status {
                            display: inline-block;
                            padding: 4px 8px;
                            border-radius: 4px;
                            font-size: 12px;
                            font-weight: bold;
                        }
                        .status-complete { background: #C6F6D5; color: #22543D; }
                        .status-partial { background: #FEEBC8; color: #744210; }
                        .status-empty { background: #FED7D7; color: #742A2A; }
                        .print-btn {
                            position: fixed;
                            top: 20px;
                            right: 20px;
                            padding: 10px 20px;
                            background: #6B46C1;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            cursor: pointer;
                            font-size: 16px;
                        }
                        @media print {
                            .print-btn { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <button class="print-btn" onclick="window.print()">üñ®Ô∏è Stampa</button>
                    
                    <h1>üìã CHECKLIST RILIEVI - SOPRALLUOGO</h1>
                    
                    <div class="header-info">
                        <h3>Informazioni Progetto</h3>
                        <p><strong>Progetto:</strong> ${project.nome || 'N/A'}</p>
                        <p><strong>Cliente:</strong> ${project.clientData?.nome || 'N/A'}</p>
                        <p><strong>Indirizzo:</strong> ${project.clientData?.indirizzo || 'N/A'}</p>
                        <p><strong>Piano:</strong> ${project.clientData?.piano || 'N/A'}</p>
                        <p><strong>Data stampa:</strong> ${new Date().toLocaleDateString('it-IT')}</p>
                    </div>
                    
                    <h2>üìç Posizioni da Rilevare (${project.positions.length})</h2>
                    
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 15%">Posizione</th>
                                <th style="width: 12%">Piano/Amb.</th>
                                <th style="width: 15%">Preesistente</th>
                                <th style="width: 12%">Materiale</th>
                                <th style="width: 8%">Togliere</th>
                                <th style="width: 8%">Smaltire</th>
                                <th style="width: 8%">Cop.INT</th>
                                <th style="width: 8%">Cop.EST</th>
                                <th style="width: 14%">Note</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${project.positions.map(pos => {
                                const r = pos.rilievo || {};
                                const completeness = calculateRilievoCompleteness(pos);
                                const statusClass = completeness.percentage === 100 ? 'status-complete' : 
                                                   completeness.percentage > 0 ? 'status-partial' : 'status-empty';
                                const statusText = completeness.percentage === 100 ? 'COMPLETO' : 
                                                  completeness.percentage > 0 ? 'PARZIALE' : 'DA FARE';
                                
                                return `
                                    <tr>
                                        <td>
                                            <strong>${pos.name}</strong><br>
                                            <span class="status ${statusClass}">${statusText}</span>
                                        </td>
                                        <td>${pos.piano || '-'}<br>${pos.ambiente || '-'}</td>
                                        <td class="${!r.preesistente || r.preesistente.trim() === '' ? 'missing' : ''}">
                                            ${r.preesistente || '‚ùå DA COMPILARE'}
                                        </td>
                                        <td class="${!r.materiale || r.materiale.trim() === '' ? 'missing' : ''}">
                                            ${r.materiale || '‚ùå DA COMPILARE'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.togliere ? 'check-filled' : ''}"></span>
                                            ${r.togliere ? 'SI' : 'NO'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.smaltimento ? 'check-filled' : ''}"></span>
                                            ${r.smaltimento ? 'SI' : 'NO'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.coprifiliInt ? 'check-filled' : ''}"></span>
                                            ${r.coprifiliInt ? 'SI' : 'NO'}
                                        </td>
                                        <td style="text-align: center;">
                                            <span class="check-box ${r.coprifiliEst ? 'check-filled' : ''}"></span>
                                            ${r.coprifiliEst ? 'SI' : 'NO'}
                                        </td>
                                        <td style="font-size: 12px;">${r.note || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    
                    <div style="margin-top: 40px; border-top: 2px solid #E2E8F0; padding-top: 20px;">
                        <h3>‚úÖ Istruzioni per il Sopralluogo</h3>
                        <ol style="line-height: 1.8;">
                            <li>Verifica per ogni posizione cosa √® presente (infisso, persiana, tapparella, etc.)</li>
                            <li>Annota il materiale del prodotto esistente</li>
                            <li>Indica se il prodotto va tolto e/o smaltito</li>
                            <li>Verifica se servono coprifili interni ed esterni per il nuovo montaggio</li>
                            <li>Aggiungi note aggiuntive se necessario</li>
                        </ol>
                    </div>
                    
                    <div style="margin-top: 30px; text-align: center; color: #A0AEC0; font-size: 12px;">
                        <p>Generato da Open Porte - Sistema di Rilievo Misure</p>
                    </div>
                </body>
                </html>
            `;
            
            // Apri in nuova finestra e stampa
            const printWindow = window.open('', '_blank');
            printWindow.document.write(printHTML);
            printWindow.document.close();
        };

        window.setPositionTab = (posId, tab) => {
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.activeTab = tab;
                    render();
                }
            }
        };

        // Update Functions
        window.updateProject = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                project[field] = value;
                saveState();
            }
        };

        window.updateClientData = (projectId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.clientData) project.clientData = {};
                project.clientData[field] = value;
                
                if (field === 'piano') {
                    project.positions.forEach(pos => {
                        if (!pos.piano) pos.piano = value;
                    });
                }
                saveState();
            }
        };

        window.updateProdotti = (projectId, product, checked) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.prodotti) project.prodotti = {};
                
                // Mappa prodotto -> step number
                const productStepMap = {
                    'infissi': 3,
                    'persiane': 4,
                    'tapparelle': 5,
                    'zanzariere': 6,
                    'cassonetti': 7
                };
                
                const productStep = productStepMap[product];
                
                // Se sto deselezionando un prodotto e sono sul suo step di config
                if (!checked && state.setupStep === productStep) {
                    // Aggiorna temporaneamente il prodotto per calcolare il prossimo step valido
                    project.prodotti[product] = checked;
                    // Salta allo step successivo valido
                    state.setupStep = getNextValidStep(state.setupStep, project);
                } else {
                    project.prodotti[product] = checked;
                }
                
                saveState();
                render();
            }
        };

        window.updateConfigPersiane = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configPersiane[field];
                
                project.configPersiane[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'persiana', field, value, oldValue);
                
                saveState();
            }
        };

        // Nuova funzione per gestire i campi condizionali delle persiane
        window.updateConfigPersianeConditional = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configPersiane[field];
                
                project.configPersiane[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'persiana', field, value, oldValue);
                
                saveState();
                
                // Gestione visibilit√† campi condizionali
                if (field === 'modello') {
                    const modelloAltro = document.getElementById(`modello-altro-${projectId}`);
                    if (modelloAltro) {
                        modelloAltro.style.display = value === 'altro' ? 'block' : 'none';
                    }
                } else if (field === 'tipoTelaio') {
                    const tipoTelaioAltro = document.getElementById(`tipo-telaio-altro-${projectId}`);
                    if (tipoTelaioAltro) {
                        tipoTelaioAltro.style.display = value === 'altro' ? 'block' : 'none';
                    }
                }
            }
        };

        // Nuova funzione per gestire il fissaggio e i campi telaio
        window.updateFissaggioPersiane = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configPersiane) project.configPersiane = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configPersiane.fissaggio;
                
                project.configPersiane.fissaggio = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'persiana', 'fissaggio', value, oldValue);
                
                saveState();
                
                const tipoTelaioContainer = document.getElementById(`tipo-telaio-persiane-container-${projectId}`);
                const coloreTelaioContainer = document.getElementById(`colore-telaio-persiane-container-${projectId}`);
                
                if (tipoTelaioContainer) {
                    tipoTelaioContainer.style.display = value === 'TELAIO' ? 'block' : 'none';
                }
                if (coloreTelaioContainer) {
                    coloreTelaioContainer.style.display = value === 'TELAIO' ? 'block' : 'none';
                }
            }
        };

        window.updateConfigTapparelle = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configTapparelle) project.configTapparelle = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configTapparelle[field];
                
                project.configTapparelle[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'tapparella', field, value, oldValue);
                
                saveState();
            }
        };

        window.updateConfigZanzariere = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configZanzariere) project.configZanzariere = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configZanzariere[field];
                
                project.configZanzariere[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'zanzariera', field, value, oldValue);
                
                saveState();
            }
        };

        window.updateConfigCassonetti = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.configCassonetti) project.configCassonetti = {};
                
                // üÜï Salva il vecchio valore PRIMA di aggiornare
                const oldValue = project.configCassonetti[field];
                
                project.configCassonetti[field] = value;
                
                // üÜï AUTO-SYNC: Aggiorna automaticamente le posizioni dove non √® stato modificato manualmente
                syncConfigToPositions(project, 'cassonetto', field, value, oldValue);
                
                saveState();
            }
        };

        // üÜï FUNZIONE AUTO-SYNC: Sincronizza config globale ‚Üí posizioni
        // Aggiorna automaticamente SOLO i campi che non sono stati modificati manualmente
        function syncConfigToPositions(project, productType, field, newValue, oldValue) {
            if (!project || !project.positions) return 0;
            
            let contatore = 0;
            console.log(`üîÑ syncConfigToPositions: ${productType}.${field}`);
            console.log(`   newValue:`, newValue);
            console.log(`   oldValue:`, oldValue);
            
            // Per ogni posizione del progetto
            project.positions.forEach(pos => {
                const product = pos[productType];
                
                // Se la posizione ha questo prodotto
                if (product) {
                    const currentValue = product[field];
                    
                    // üéØ LOGICA AUTO-SYNC:
                    // Aggiorna se:
                    // 1. Il campo √® vuoto/undefined/null (mai impostato)
                    // 2. Il campo √® un array vuoto [] (mai popolato)
                    // 3. Il campo ha lo stesso valore della vecchia config (non modificato manualmente)
                    const shouldSync = (
                        currentValue === undefined || 
                        currentValue === '' || 
                        currentValue === null ||
                        (Array.isArray(currentValue) && currentValue.length === 0) || // Array vuoto = mai impostato
                        currentValue === oldValue ||
                        (Array.isArray(currentValue) && Array.isArray(oldValue) && 
                         JSON.stringify(currentValue) === JSON.stringify(oldValue))
                    );
                    
                    console.log(`   Posizione ${pos.id}: currentValue=`, currentValue, ` shouldSync=${shouldSync}`);
                    
                    if (shouldSync) {
                        // Aggiorna con il nuovo valore globale
                        if (Array.isArray(newValue)) {
                            // Per array (es. codTagli), crea una copia
                            product[field] = [...newValue];
                        } else {
                            product[field] = newValue;
                        }
                        console.log(`   ‚úÖ SINCRONIZZATO: ${field} =`, newValue);
                        contatore++;
                    } else {
                        console.log(`   ‚è≠Ô∏è SKIP (modificato manualmente)`);
                    }
                    // ALTRIMENTI: L'utente ha modificato manualmente ‚Üí NON aggiornare
                }
            });
            
            console.log(`   üìä Totale sincronizzati: ${contatore}`);
            return contatore;
        }

        // Verifica sincronizzazione automatica
        function verificaSincronizzazioneNecessaria(project) {
            if (!project || !project.configInfissi) return false;
            
            // Verifica se la config ha valori
            const configHaValori = (
                project.configInfissi.azienda ||
                project.configInfissi.telaio ||
                project.configInfissi.coloreInt ||
                (project.configInfissi.codTagli && project.configInfissi.codTagli.length > 0)
            );
            
            if (!configHaValori) return false;
            
            // Conta campi vuoti nelle posizioni
            let campiVuoti = 0;
            project.positions.forEach(pos => {
                if (pos.infisso) {
                    ['azienda', 'telaio', 'coloreInt'].forEach(field => {
                        const posValue = pos.infisso[field];
                        const configValue = project.configInfissi[field];
                        
                        const posIsEmpty = !posValue || posValue === '';
                        const configHasValue = configValue && configValue !== '';
                        
                        if (posIsEmpty && configHasValue) {
                            campiVuoti++;
                        }
                    });
                    
                    // Check codTagli separatamente
                    const codTagliEmpty = !pos.infisso.codTagli || pos.infisso.codTagli.length === 0;
                    const codTagliHasValue = project.configInfissi.codTagli && project.configInfissi.codTagli.length > 0;
                    if (codTagliEmpty && codTagliHasValue) {
                        campiVuoti++;
                    }
                }
            });
            
            if (campiVuoti > 0) {
                console.warn(`‚ö†Ô∏è ATTENZIONE: ${campiVuoti} campi nelle posizioni sono vuoti ma la Config Globale ha valori!`);
                console.log('üí° SUGGERIMENTO: Usa il pulsante SINCRONIZZA TUTTO nella Config Globale.');
                return true;
            }
            
            return false;
        }

        // ‚úÖ NUOVO: Funzione per ricalcolare tutti i BRM globali quando cambia la configurazione
        function ricalcolaTuttiiBRMGlobali(project, configKey) {
            // Mappa tra configKey e productType
            const configToProductMap = {
                'brmConfigInfissi': 'infisso',
                'brmConfigPersiane': 'persiana',
                'brmConfigTapparelle': 'tapparella',
                'brmConfigZanzariere': 'zanzariera',
                'brmConfigCassonetti': 'cassonetto'
            };
            
            const productType = configToProductMap[configKey];
            if (!productType) return;
            
            // Ricalcola BRM per ogni posizione che ha questo prodotto
            project.positions.forEach(pos => {
                const product = pos[productType];
                
                // Ricalcola SOLO se il prodotto esiste E NON ha personalizzazione
                if (product && !product.brmPersonalizzato) {
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Usa le misure corrette in base al tipo di prodotto
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    // Ricalcola BRM con la config globale aggiornata
                    const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                    
                    // Aggiorna i valori BRM nel prodotto
                    product.BRM_L = brm.L;
                    product.BRM_H = brm.H;
                    
                    // Per cassonetti, gestisci anche C e B
                    if (productType === 'cassonetto') {
                        product.BRM_C = brm.C;
                        product.BRM_B = brm.B;
                    }
                }
            });
        }

        // ‚úÖ NUOVO: Funzione per ricalcolare tutti i BRM di una posizione quando cambiano le misure
        function ricalcolaBRMPerPosizione(project, pos) {
            const configMap = {
                'infisso': 'brmConfigInfissi',
                'persiana': 'brmConfigPersiane',
                'tapparella': 'brmConfigTapparelle',
                'zanzariera': 'brmConfigZanzariere',
                'cassonetto': 'brmConfigCassonetti'
            };
            
            // Ricalcola per ogni tipo di prodotto nella posizione
            ['infisso', 'persiana', 'tapparella', 'zanzariera', 'cassonetto'].forEach(productType => {
                const product = pos[productType];
                
                // Ricalcola SOLO se il prodotto esiste E NON ha personalizzazione
                if (product && !product.brmPersonalizzato) {
                    const configKey = configMap[productType];
                    
                    // Determina il tipo per infissi e zanzariere
                    let tipo = null;
                    if (productType === 'infisso') {
                        tipo = product.tipo;
                    } else if (productType === 'zanzariera') {
                        tipo = pos.infisso?.tipo || '';
                    }
                    
                    // Usa le misure corrette in base al tipo di prodotto
                    const misure = (productType === 'cassonetto') ? product : pos.misure;
                    
                    // Ricalcola BRM con la config globale
                    if (project[configKey]) {
                        const brm = calculateBRM(project, pos, misure, project[configKey], tipo);
                        
                        // Aggiorna i valori BRM nel prodotto
                        product.BRM_L = brm.L;
                        product.BRM_H = brm.H;
                        
                        // Per cassonetti, gestisci anche C e B
                        if (productType === 'cassonetto') {
                            product.BRM_C = brm.C;
                            product.BRM_B = brm.B;
                        }
                    }
                }
            });
        }

        window.updateBRMConfig = (projectId, configKey, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project[configKey]) project[configKey] = {};
                
                // ‚úÖ FIX: Converti sempre i valori mm in positivi (valore assoluto)
                // Se l'utente inserisce -10, lo convertiamo in 10
                // L'operazione (+ o -) viene gestita separatamente dal campo "operazione"
                if (field.startsWith('valore') && !isNaN(value)) {
                    value = Math.abs(parseFloat(value)).toString();
                }
                
                project[configKey][field] = value;
                
                // ‚úÖ NUOVO: Ricalcola automaticamente tutti i BRM che usano questa config globale
                ricalcolaTuttiiBRMGlobali(project, configKey);
                
                saveState();
                // ‚ö° FASE 024B: NO render - approccio cloud
                // I dati sono gi√† salvati, i BRM ricalcolati
                // L'utente vedr√† i cambiamenti al prossimo cambio naturale di vista
            }
        };

        window.updateBRMPersonalizzato = (projectId, posId, productType, field, value) => {
            updateBRMPersonalizzato(projectId, posId, productType, field, value);
        };

        window.updateCaratteristicheMuro = (projectId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro[field] = value;
                
                // üîß CORREZIONE: Se modifichi "Battuta Superiore con Tapparella", 
                // aggiorna automaticamente BSuperiore nei cassonetti che usano le caratteristiche globali
                if (field === 'battutaSuperioreTapparella') {
                    let cassUpdated = 0;
                    project.positions.forEach(pos => {
                        // Aggiorna solo se la posizione usa caratteristiche globali (non ha override)
                        if (pos.cassonetto && !pos.overrideCaratteristiche) {
                            pos.cassonetto.BSuperiore = value || '0';
                            cassUpdated++;
                        }
                    });
                    
                    if (cassUpdated > 0) {
                        // ‚ö° FASE 024B: NO render - dati gi√† salvati
                        // showNotification mostrer√† il risultato senza bisogno di render
                        showNotification(`‚úÖ Aggiornati ${cassUpdated} cassonetti con nuovo BSuperiore: ${value}mm`, 'success');
                    }
                }
                
                saveState();
            }
        };

        // üóø NUOVA FUNZIONE: Aggiorna caratteristiche muro OVERRIDE per una specifica posizione
        window.updateCaratteristicheMuroOverride = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.overrideCaratteristiche) {
                    if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
                    pos.caratteristicheMuroOverride[field] = value;
                    
                    // üîß CORREZIONE: Se modifichi "Battuta Superiore con Tapparella" nell'override,
                    // aggiorna automaticamente BSuperiore nel cassonetto di questa posizione
                    if (field === 'battutaSuperioreTapparella' && pos.cassonetto) {
                        pos.cassonetto.BSuperiore = value || '0';
                        // ‚ö° FASE 024B: Aggiorna DOM diretto invece di render
                        const bSupEl = document.getElementById(`bsup-${posId}`);
                        if (bSupEl) bSupEl.value = value || '0';
                        showNotification(`‚úÖ Aggiornato BSuperiore cassonetto: ${value}mm`, 'success');
                    }
                    
                    saveState();
                }
            }
        };

        window.updateGuidaEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.guidaEsistente = value;
                saveState();
                
                const guidaFields = document.getElementById(`guida-fields-${projectId}`);
                if (guidaFields) {
                    guidaFields.style.display = value === 'si' ? 'block' : 'none';
                }
            }
        };

        // üóø NUOVA FUNZIONE: Aggiorna guida esistente OVERRIDE per posizione
        window.updateGuidaEsistenteOverride = (projectId, posId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.overrideCaratteristiche) {
                    if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
                    pos.caratteristicheMuroOverride.guidaEsistente = value;
                    saveState();
                    
                    // ‚ö° FASE 024B: Manipolazione DOM diretta per mostrare/nascondere campi
                    const guidaFields = document.querySelector(`[id*="guida-fields-override-${posId}"]`);
                    if (guidaFields) {
                        guidaFields.style.display = value === 'si' ? 'block' : 'none';
                    }
                }
            }
        };

        window.updateFalsoEsistente = (projectId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.caratteristicheMuro) project.caratteristicheMuro = {};
                project.caratteristicheMuro.falsoEsistente = value;
                saveState();
                
                const falsoSiFields = document.getElementById(`falso-si-fields-${projectId}`);
                const falsoNoFields = document.getElementById(`falso-no-fields-${projectId}`);
                if (falsoSiFields && falsoNoFields) {
                    falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                    falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
                }
            }
        };

        // üóø NUOVA FUNZIONE: Aggiorna falso esistente OVERRIDE per posizione
        window.updateFalsoEsistenteOverride = (projectId, posId, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.overrideCaratteristiche) {
                    if (!pos.caratteristicheMuroOverride) pos.caratteristicheMuroOverride = {};
                    pos.caratteristicheMuroOverride.falsoEsistente = value;
                    saveState();
                    
                    // ‚ö° FASE 024B: Manipolazione DOM diretta per mostrare/nascondere campi
                    const falsoSiFields = document.querySelector(`[id*="falso-si-fields-override-${posId}"]`);
                    const falsoNoFields = document.querySelector(`[id*="falso-no-fields-override-${posId}"]`);
                    if (falsoSiFields && falsoNoFields) {
                        falsoSiFields.style.display = value === 'si' ? 'block' : 'none';
                        falsoNoFields.style.display = value === 'no' ? 'block' : 'none';
                    }
                }
            }
        };

        // üÜï FASE 15: Update Misure Globali Infissi
        window.updateMisureGlobaliInfissi = (projectId, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                if (!project.misureGlobaliInfissi) {
                    project.misureGlobaliInfissi = {
                        LVT: '', HVT: '', LF: '', HF: '', 
                        TMV: '', HMT: '', LVAR: '', HVAR: '',
                        DeltaINT: '', DeltaEST: '',
                        HSoffitto: '', HParapettoSoffitto: '', HPavimentoParapetto: ''
                    };
                }
                project.misureGlobaliInfissi[field] = value;
                saveState();
            }
        };

        window.updatePosition = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos[field] = value;
                    saveState();
                }
            }
        };

        window.updateMisura = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    if (!pos.misure) pos.misure = {};
                    pos.misure[field] = value;
                    saveState();
                }
            }
        };

        window.updateMisuraWithValidation = (projectId, posId, field, value) => {
            markUserTyping(); // ‚ö° FASE 024B: Track digitazione per sync silenzioso
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    // üõ°Ô∏è Se l'utente modifica una misura che aveva un override, rimuovi l'override
                    // perch√© il valore √® cambiato e deve essere rivalidato
                    if (pos.validationOverrides && pos.validationOverrides[field]) {
                        delete pos.validationOverrides[field];
                        
                        // Se non ci sono pi√π override, rimuovi l'oggetto intero
                        if (Object.keys(pos.validationOverrides).length === 0) {
                            delete pos.validationOverrides;
                        }
                    }
                }
            }
            
            updateMisura(projectId, posId, field, value);
            
            // ‚úÖ NUOVO: Ricalcola automaticamente tutti i BRM di questa posizione quando cambiano le misure
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    ricalcolaBRMPerPosizione(project, pos);
                }
            }
            
            render();
        };

        window.enableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = true;
                    pos.caratteristicheMuroOverride = {...project.caratteristicheMuro};
                    saveState();
                    render();
                }
            }
        };

        window.disableOverride = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos) {
                    pos.overrideCaratteristiche = false;
                    pos.caratteristicheMuroOverride = null;
                    
                    // üîß CORREZIONE: Quando disabiliti l'override, aggiorna BSuperiore con il valore globale
                    if (pos.cassonetto) {
                        const bSuperioreGlobale = project.caratteristicheMuro?.battutaSuperioreTapparella || '0';
                        pos.cassonetto.BSuperiore = bSuperioreGlobale;
                        showNotification(`‚úÖ Cassonetto aggiornato con valore globale BSuperiore: ${bSuperioreGlobale}mm`, 'success');
                    }
                    
                    saveState();
                    render();
                }
            }
        };

        window.deletePosition = (projectId, posId) => {
            if (confirm('Sei sicuro di voler eliminare questa posizione? Tutti i dati verranno persi.')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    project.positions = project.positions.filter(p => p.id !== posId);
                    saveState();
                    
                    if (project.positions.length > 0) {
                        state.currentPosition = project.positions[0].id;
                        state.screen = 'position';
                    } else {
                        state.screen = 'project';
                    }
                    render();
                }
            }
        };

        // Motor Functions for Tapparelle
        window.addMotoreTapparella = (projectId, posId) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparella) {
                    if (!pos.tapparella.motori) {
                        pos.tapparella.motori = [];
                    }
                    // FASE 11a: Inizializza motore con tutti i campi
                    pos.tapparella.motori.push({ 
                        marca: '',
                        modello: '',
                        alimentazione: 'Filare',
                        trasmettitore: ''
                    });
                    saveState();
                    render();
                }
            }
        };

        window.updateMotoreTapparella = (projectId, posId, tappIdx, motoreIdx, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparelle && pos.tapparelle[tappIdx] && pos.tapparelle[tappIdx].motori) {
                    pos.tapparelle[tappIdx].motori[motoreIdx].modello = value;
                    saveState();
                }
            }
        };

        // FASE 11a: Nuova funzione per aggiornare singoli campi del motore
        window.updateMotoreTapparellaField = (projectId, posId, motoreIdx, field, value) => {
            const project = state.projects.find(p => p.id === projectId);
            if (project) {
                const pos = project.positions.find(p => p.id === posId);
                if (pos && pos.tapparella && pos.tapparella.motori && pos.tapparella.motori[motoreIdx]) {
                    pos.tapparella.motori[motoreIdx][field] = value;
                    saveState();
                    // ‚ö° FASE 024: Se cambia alimentazione, ri-renderizza con debounce per mostrare/nascondere trasmettitore
                    if (field === 'alimentazione') {
                        deferredRender();
                    }
                }
            }
        };

        window.removeMotoreTapparella = (projectId, posId, motoreIdx) => {
            if (confirm('Eliminare questo motore?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.tapparella && pos.tapparella.motori) {
                        pos.tapparella.motori.splice(motoreIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        // Foto Functions
        window.addFoto = (projectId, posId, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos) {
                            if (!pos.foto) pos.foto = [];
                            pos.foto.push({
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            });
                            saveState();
                            showNotification('Foto aggiunta', 'success');
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
        };

        window.removeFoto = (projectId, posId, fotoIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.foto) {
                        pos.foto.splice(fotoIdx, 1);
                        saveState();
                        render();
                    }
                }
            }
        };

        window.addFotoPersiana = (projectId, posId, persianaIdx, input) => {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const project = state.projects.find(p => p.id === projectId);
                    if (project) {
                        const pos = project.positions.find(p => p.id === posId);
                        if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                            pos.persiane[persianaIdx].foto = {
                                data: e.target.result,
                                timestamp: new Date().toISOString()
                            };
                            saveState();
                            render();
                        }
                    }
                };
                reader.readAsDataURL(file);
            }
            input.value = '';
        };

        window.removeFotoPersiana = (projectId, posId, persianaIdx) => {
            if (confirm('Sei sicuro di voler eliminare questa foto?')) {
                const project = state.projects.find(p => p.id === projectId);
                if (project) {
                    const pos = project.positions.find(p => p.id === posId);
                    if (pos && pos.persiane && pos.persiane[persianaIdx]) {
                        pos.persiane[persianaIdx].foto = null;
                        saveState();
                        render();
                    }
                }
            }
        };

        window.showFotoModal = (fotoData) => {
            const modal = document.getElementById('foto-modal');
            const img = document.getElementById('foto-modal-img');
            if (modal && img) {
                img.src = fotoData;
                modal.classList.remove('hidden');
            }
        };

        window.hideFotoModal = () => {
            const modal = document.getElementById('foto-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        };

        // Export/Import Functions
        window.exportAllProjects = () => {
            try {
                const data = {
                    projects: state.projects,
                    exportDate: new Date().toISOString(),
                    version: '3.5-FASE006-JSON-COMPLETO',
                    totalProjects: state.projects.length
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `open-porte-progetti-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`Export completato! ${data.totalProjects} progetti`, 'success');
                
            } catch (error) {
                console.error('Errore export:', error);
                showNotification(`Errore durante export: ${error.message}`, 'error');
            }
        };

        // üÜï FASE 027E: Salvataggio forzato immediato
        window.forceSave = async () => {
            try {
                showNotification('üíæ Salvataggio forzato in corso...', 'info');
                
                // 1. Salva localStorage immediato
                saveState();
                
                // 2. Se OneDrive connesso, carica subito
                if (state.onedrive?.connected) {
                    const uploaded = await uploadToOneDrive();
                    if (uploaded) {
                        showNotification('‚úÖ Salvato su localStorage + OneDrive!', 'success', 4000);
                    } else {
                        showNotification('‚úÖ Salvato su localStorage (OneDrive: errore)', 'warning', 4000);
                    }
                } else {
                    showNotification('‚úÖ Salvato su localStorage (OneDrive non connesso)', 'success', 3000);
                }
            } catch (error) {
                console.error('Errore salvataggio forzato:', error);
                showNotification('‚ùå Errore durante salvataggio', 'error');
            }
        };

        // NUOVE FUNZIONI PER ODOO - Export Singolo Progetto
        window.exportCurrentProjectJSON = () => {
            try {
                const project = state.projects.find(p => p.id === state.currentProject);
                if (!project) {
                    showNotification('Nessun progetto selezionato', 'error');
                    return;
                }
                
                // üÜï FASE 013: Controllo completamento posizioni (nome, ambiente, prodotti, misure)
                // üîß FASE 014: Passa project alla funzione
                const posizioniIncomplete = project.positions.map(pos => {
                    const comp = calculatePositionCompleteness(pos, project);
                    return { pos, comp };
                }).filter(item => !item.comp.isComplete);
                
                if (posizioniIncomplete.length > 0) {
                    let dettagli = posizioniIncomplete.map(item => {
                        const nome = item.pos.name || 'Senza nome';
                        const perc = item.comp.percentage;
                        const mancanti = item.comp.missing.join(', ');
                        return `‚Ä¢ ${nome} (${perc}%): ${mancanti}`;
                    }).join('\n');
                    
                    const conferma = confirm(
                        `‚ö†Ô∏è ATTENZIONE: ${posizioniIncomplete.length} posizioni non sono complete al 100%:\n\n${dettagli}\n\n` +
                        `Vuoi procedere comunque con l'export?\n\n` +
                        `[OK] = Esporta lo stesso | [Annulla] = Torna a completare`
                    );
                    
                    if (!conferma) {
                        showNotification('Export annullato. Completa le posizioni mancanti.', 'info');
                        return;
                    }
                }
                
                // üÜï VALIDAZIONE: Verifica che tutte le posizioni abbiano Ambiente compilato
                const posizioniSenzaAmbiente = project.positions.filter(pos => !pos.ambiente || pos.ambiente.trim() === '');
                if (posizioniSenzaAmbiente.length > 0) {
                    const nomiPosizioni = posizioniSenzaAmbiente.map(pos => pos.name || 'Senza nome').join(', ');
                    showNotification(
                        `‚ö†Ô∏è Ambiente obbligatorio! Le seguenti posizioni non hanno l'ambiente compilato: ${nomiPosizioni}`,
                        'error',
                        8000
                    );
                    return;
                }
                
                const data = {
                    commessa_id: project.id,
                    versione: "1.0-FASE007",
                    data_rilievo: new Date().toISOString(),
                    // üîç RICERCA: Campo per ricerca facile nel JSON
                    nome_ricerca: `${project.client || ''} ${project.name || ''}`.trim(),
                    cliente: {
                        nome: project.client || '',
                        progetto: project.name || '',
                        piano: project.clientData?.piano || '',
                        indirizzo: project.clientData?.indirizzo || '',
                        telefono: project.clientData?.telefono || ''
                    },
                    note_progetto: project.clientData?.note || '',
                    // üß± CARATTERISTICHE MURO GLOBALI
                    caratteristiche_muro_globali: {
                        telaio_larghezza: project.caratteristicheMuro?.telaioLarghezza || 0,
                        telaio_altezza: project.caratteristicheMuro?.telaioAltezza || 0,
                        falso_esistente: project.caratteristicheMuro?.falsoEsistente || 'no',
                        spessore_falso: project.caratteristicheMuro?.spessoreFalso || 0,
                        distanza_falso_infisso: project.caratteristicheMuro?.distanzaFalsoInfisso || 0,
                        distanza_muro_infisso: project.caratteristicheMuro?.distanzaMuroInfisso || 0,
                        guida_tipo: project.caratteristicheMuro?.guidaTipo || '',
                        guida_larghezza: project.caratteristicheMuro?.guidaLarghezza || 0,
                        guida_altezza: project.caratteristicheMuro?.guidaAltezza || 0,
                        guida_profondita: project.caratteristicheMuro?.guidaProfondita || 0,
                        coprifilo_larghezza: project.caratteristicheMuro?.coprifiloLarghezza || 0,
                        prof_muro_int: project.caratteristicheMuro?.profMuroInt || 0,
                        prof_muro_est: project.caratteristicheMuro?.profMuroEst || 0,
                        battuta_superiore_tapparella: project.caratteristicheMuro?.battutaSuperioreTapparella || 0
                    },
                    posizioni: project.positions.map(pos => {
                        // üìä TEMPLATE COMPLETO MISURE - Include tutti i campi anche se = 0
                        const misureComplete = {
                            // Misure principali
                            LVT: pos.misure?.LVT ?? 0,
                            HVT: pos.misure?.HVT ?? 0,
                            LF: pos.misure?.LF ?? 0,
                            HF: pos.misure?.HF ?? 0,
                            TMV: pos.misure?.TMV ?? 0,
                            HMT: pos.misure?.HMT ?? 0,
                            L4: pos.misure?.L4 ?? 0,
                            H4: pos.misure?.H4 ?? 0,
                            // Delta
                            DeltaINT: pos.misure?.DeltaINT ?? 0,
                            DeltaEST: pos.misure?.DeltaEST ?? 0,
                            // Altezze
                            HSoffitto: pos.misure?.HSoffitto ?? 0,
                            HParapettoSoffitto: pos.misure?.HParapettoSoffitto ?? 0,
                            HPavimentoParapetto: pos.misure?.HPavimentoParapetto ?? 0
                        };
                        
                        const posData = {
                            id: pos.id,
                            nome: pos.nome || pos.id,
                            piano: pos.piano || '',
                            stanza: pos.stanza || '',
                            ambiente: pos.ambiente || '',
                            quantita: pos.quantita || 1,
                            misure: misureComplete
                        };
                        
                        // üß± CARATTERISTICHE MURO OVERRIDE (se presenti per questa posizione)
                        if (pos.overrideCaratteristiche && pos.caratteristicheMuroOverride) {
                            posData.caratteristiche_muro_override = {
                                telaio_larghezza: pos.caratteristicheMuroOverride.telaioLarghezza || 0,
                                telaio_altezza: pos.caratteristicheMuroOverride.telaioAltezza || 0,
                                falso_esistente: pos.caratteristicheMuroOverride.falsoEsistente || 'no',
                                spessore_falso: pos.caratteristicheMuroOverride.spessoreFalso || 0,
                                distanza_falso_infisso: pos.caratteristicheMuroOverride.distanzaFalsoInfisso || 0,
                                distanza_muro_infisso: pos.caratteristicheMuroOverride.distanzaMuroInfisso || 0,
                                guida_tipo: pos.caratteristicheMuroOverride.guidaTipo || '',
                                guida_larghezza: pos.caratteristicheMuroOverride.guidaLarghezza || 0,
                                guida_altezza: pos.caratteristicheMuroOverride.guidaAltezza || 0,
                                guida_profondita: pos.caratteristicheMuroOverride.guidaProfondita || 0,
                                coprifilo_larghezza: pos.caratteristicheMuroOverride.coprifiloLarghezza || 0,
                                prof_muro_int: pos.caratteristicheMuroOverride.profMuroInt || 0,
                                prof_muro_est: pos.caratteristicheMuroOverride.profMuroEst || 0,
                                battuta_superiore_tapparella: pos.caratteristicheMuroOverride.battutaSuperioreTapparella || 0
                            };
                        }
                        
                        // Aggiungi infisso se presente
                        if (pos.infisso) {
                            posData.infisso = {
                                quantita: pos.infisso.quantita || 1,
                                tipo: pos.infisso.tipo || '',
                                apertura: pos.infisso.apertura || '',
                                azienda: pos.infisso.azienda || '',
                                misure: misureComplete,  // üìä Usa template completo
                                brm: {  // üìä Template completo BRM
                                    L: pos.infisso.brm?.L ?? null,
                                    H: pos.infisso.brm?.H ?? null,
                                    C: pos.infisso.brm?.C ?? null,
                                    B: pos.infisso.brm?.B ?? null
                                },
                                finitura_int: pos.infisso.finituraInt || '',
                                finitura_est: pos.infisso.finituraEst || '',
                                colore_int: pos.infisso.coloreInt || '',
                                colore_est: pos.infisso.coloreEst || '',
                                tipo_anta: pos.infisso.tipoAnta || '',
                                telaio: pos.infisso.telaio || '',
                                allarme: pos.infisso.allarme || '',
                                vetro: pos.infisso.vetro || '',
                                tagli_telaio: pos.infisso.tagliTelaio || '',
                                cod_tagli: pos.infisso.codTagli || {}
                            };
                        }
                        
                        // Aggiungi persiana se presente
                        if (pos.persiana) {
                            posData.persiana = {
                                quantita: pos.persiana.quantita || 1,
                                tipo: pos.persiana.tipo || '',
                                apertura: pos.persiana.apertura || '',
                                modello: pos.persiana.modello || '',
                                fissaggio: pos.persiana.fissaggio || '',
                                tipo_telaio: pos.persiana.tipoTelaio || '',
                                colore_persiana: pos.persiana.colorePersiana || '',
                                colore_telaio: pos.persiana.coloreTelaio || '',
                                battuta: pos.persiana.battuta || '',
                                brm: {  // üìä Template completo BRM
                                    L: pos.persiana.brm?.L ?? null,
                                    H: pos.persiana.brm?.H ?? null,
                                    C: pos.persiana.brm?.C ?? null,
                                    B: pos.persiana.brm?.B ?? null
                                },
                                foto: pos.persiana.foto ? 'presente' : 'no'
                            };
                        }
                        
                        // Aggiungi tapparella se presente
                        if (pos.tapparella) {
                            posData.tapparella = {
                                quantita: pos.tapparella.quantita || 1,
                                azienda: pos.tapparella.azienda || '',
                                modello: pos.tapparella.modello || '',
                                colore: pos.tapparella.colore || '',
                                manuale_motorizzato: pos.tapparella.manualeMotoriz || '',
                                sost_esistente: pos.tapparella.sostEsistente || '',
                                guida: pos.tapparella.guida || '',
                                colore_guida: pos.tapparella.coloreGuida || '',
                                brm: {  // üìä Template completo BRM
                                    L: pos.tapparella.brm?.L ?? null,
                                    H: pos.tapparella.brm?.H ?? null,
                                    C: pos.tapparella.brm?.C ?? null,
                                    B: pos.tapparella.brm?.B ?? null
                                },
                                motori: pos.tapparella.motori || []
                            };
                        }
                        
                        // Aggiungi zanzariera se presente
                        if (pos.zanzariera) {
                            posData.zanzariera = {
                                quantita: pos.zanzariera.quantita || 1,
                                tipo: pos.zanzariera.tipo || '',
                                apertura: pos.zanzariera.apertura || '',
                                tipo_infisso_associato: pos.zanzariera.tipoInfissoAssociato || '',
                                colore_telaio: pos.zanzariera.coloreTelaio || '',
                                tipo_rete: pos.zanzariera.tipoRete || '',
                                colore_rete: pos.zanzariera.coloreRete || '',
                                brm: {  // üìä Template completo BRM
                                    L: pos.zanzariera.brm?.L ?? null,
                                    H: pos.zanzariera.brm?.H ?? null,
                                    C: pos.zanzariera.brm?.C ?? null,
                                    B: pos.zanzariera.brm?.B ?? null
                                }
                            };
                        }
                        
                        // Aggiungi cassonetto se presente
                        if (pos.cassonetto) {
                            posData.cassonetto = {
                                quantita: pos.cassonetto.quantita || 1,
                                tipo: pos.cassonetto.tipo || '',
                                tipo_cassonetto: pos.cassonetto.tipoCassonetto || '',
                                azienda: pos.cassonetto.azienda || '',
                                colore: pos.cassonetto.colore || '',
                                sovrappi_sostit: pos.cassonetto.sovrappiSostit || '',
                                a_soffitto: pos.cassonetto.aSoffitto || '',
                                misure: {  // üìä Template completo con ?? operator
                                    LS: pos.cassonetto.LS ?? 0,
                                    SRSX: pos.cassonetto.SRSX ?? 0,
                                    ZSX: pos.cassonetto.ZSX ?? 0,
                                    SRDX: pos.cassonetto.SRDX ?? 0,
                                    ZDX: pos.cassonetto.ZDX ?? 0,
                                    HCASS: pos.cassonetto.HCASS ?? 0,
                                    B: pos.cassonetto.B ?? 0,
                                    C: pos.cassonetto.C ?? 0,
                                    BSuperiore: pos.cassonetto.BSuperiore ?? 0
                                },
                                brm: {  // üìä Template completo BRM
                                    L: pos.cassonetto.brm?.L ?? null,
                                    H: pos.cassonetto.brm?.H ?? null,
                                    C: pos.cassonetto.brm?.C ?? null,
                                    B: pos.cassonetto.brm?.B ?? null
                                }
                            };
                        }
                        
                        // üìã RILIEVO PREESISTENTE (se presente)
                        if (pos.rilievo) {
                            posData.rilievo_preesistente = {
                                da_togliere: pos.rilievo.togliere || false,
                                smaltimento: pos.rilievo.smaltimento || false,
                                materiale: pos.rilievo.materiale || '',
                                coprifili_int: pos.rilievo.coprifiliInt || false,
                                coprifili_est: pos.rilievo.coprifiliEst || false,
                                note: pos.rilievo.note || ''
                            };
                        }
                        
                        return posData;
                    }),
                    totali: {
                        n_posizioni: project.positions.length,
                        n_infissi: project.positions.filter(p => p.infisso).length,
                        n_persiane: project.positions.filter(p => p.persiana).length,
                        n_tapparelle: project.positions.filter(p => p.tapparella).length,
                        n_zanzariere: project.positions.filter(p => p.zanzariera).length,
                        n_cassonetti: project.positions.filter(p => p.cassonetto).length
                    }
                };
                
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `RILIEVO-${project.client || 'Cliente'}-${project.name || 'Progetto'}-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                showNotification(`‚úÖ JSON esportato per Odoo!`, 'success');
                
            } catch (error) {
                console.error('Errore export JSON:', error);
                showNotification(`Errore durante export: ${error.message}`, 'error');
            }
        };

        // Funzione per stampare PDF del rilievo
        window.printCurrentProjectPDF = () => {
            try {
                const project = state.projects.find(p => p.id === state.currentProject);
                if (!project) {
                    showNotification('Nessun progetto selezionato', 'error');
                    return;
                }
                
                // üÜï FASE 013: Controllo completamento posizioni (nome, ambiente, prodotti, misure)
                // üîß FASE 014: Passa project alla funzione
                const posizioniIncomplete = project.positions.map(pos => {
                    const comp = calculatePositionCompleteness(pos, project);
                    return { pos, comp };
                }).filter(item => !item.comp.isComplete);
                
                if (posizioniIncomplete.length > 0) {
                    let dettagli = posizioniIncomplete.map(item => {
                        const nome = item.pos.name || 'Senza nome';
                        const perc = item.comp.percentage;
                        const mancanti = item.comp.missing.join(', ');
                        return `‚Ä¢ ${nome} (${perc}%): ${mancanti}`;
                    }).join('\n');
                    
                    const conferma = confirm(
                        `‚ö†Ô∏è ATTENZIONE: ${posizioniIncomplete.length} posizioni non sono complete al 100%:\n\n${dettagli}\n\n` +
                        `Vuoi procedere comunque con la stampa PDF?\n\n` +
                        `[OK] = Stampa lo stesso | [Annulla] = Torna a completare`
                    );
                    
                    if (!conferma) {
                        showNotification('Stampa annullata. Completa le posizioni mancanti.', 'info');
                        return;
                    }
                }
                
                // Genera HTML per stampa - continua nel prossimo file
                const printHTML = generatePrintHTML(project);
                
                // Apri finestra di stampa
                const printWindow = window.open('', '', 'width=900,height=700');
                printWindow.document.write(printHTML);
                printWindow.document.close();
                
                // Aspetta che il contenuto sia caricato prima di stampare
                printWindow.onload = () => {
                    printWindow.focus();
                    setTimeout(() => {
                        printWindow.print();
                    }, 250);
                };
                
                showNotification('üìÑ Finestra di stampa aperta!', 'success');
                
            } catch (error) {
                console.error('Errore stampa PDF:', error);
                showNotification(`Errore durante stampa: ${error.message}`, 'error');
            }
        };

        // Funzione helper per generare HTML di stampa
        function generatePrintHTML(project) {
            return `<!DOCTYPE html>
<html><head>
<meta charset="UTF-8">
<title>Rilievo - ${project.client || 'Cliente'}</title>
<style>
@media print { @page { margin: 1cm; } body { margin: 0; } .page-break { page-break-after: always; } }
body { font-family: Arial, sans-serif; padding: 20px; max-width: 800px; margin: 0 auto; }
h1 { color: #1e293b; border-bottom: 3px solid #6366f1; padding-bottom: 10px; margin-bottom: 20px; }
h2 { color: #475569; background: #f1f5f9; padding: 10px; margin-top: 30px; border-left: 4px solid #6366f1; }
h3 { color: #334155; margin-top: 20px; background: #e2e8f0; padding: 8px; }
h4 { color: #475569; margin-top: 15px; margin-bottom: 10px; border-bottom: 1px solid #cbd5e1; padding-bottom: 5px; }
table { width: 100%; border-collapse: collapse; margin: 15px 0; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
th, td { border: 1px solid #e2e8f0; padding: 10px; text-align: left; }
th { background-color: #6366f1; color: white; font-weight: bold; }
tr:nth-child(even) { background-color: #f8fafc; }
.header-info { background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 20px; border: 1px solid #e2e8f0; }
.header-info p { margin: 5px 0; }
.totali { background: #fef3c7; padding: 15px; border-radius: 8px; margin: 20px 0; border: 2px solid #fbbf24; }
.nota { background: #dbeafe; padding: 10px; border-left: 4px solid #3b82f6; margin: 10px 0; font-size: 0.9em; }
.logo { text-align: center; margin-bottom: 20px; color: #6366f1; font-size: 1.2em; font-weight: bold; }
</style></head><body>
<div class="logo">OPEN PORTE & FINESTRE SRL</div>
<h1>üìã RILIEVO MISURE</h1>
<div class="header-info">
<p><strong>üè¢ Cliente:</strong> ${project.client || 'N/D'}</p>
<p><strong>üìÅ Progetto:</strong> ${project.name || 'N/D'}</p>
<p><strong>üìç Piano:</strong> ${project.clientData?.piano || 'N/D'}</p>
<p><strong>üè† Indirizzo:</strong> ${project.clientData?.indirizzo || 'N/D'}</p>
<p><strong>üìû Telefono:</strong> ${project.clientData?.telefono || 'N/D'}</p>
<p><strong>üìÖ Data Rilievo:</strong> ${new Date().toLocaleDateString('it-IT')} ${new Date().toLocaleTimeString('it-IT')}</p>
${project.clientData?.note ? `<p><strong>üìù Note:</strong> ${project.clientData.note}</p>` : ''}
</div>
<div class="totali">
<strong>üìä RIEPILOGO TOTALI:</strong><br>
‚Ä¢ Posizioni: ${project.positions.length}<br>
‚Ä¢ Infissi: ${project.positions.filter(p => p.infisso).length}<br>
‚Ä¢ Persiane: ${project.positions.filter(p => p.persiana).length}<br>
‚Ä¢ Tapparelle: ${project.positions.filter(p => p.tapparella).length}<br>
‚Ä¢ Zanzariere: ${project.positions.filter(p => p.zanzariera).length}<br>
‚Ä¢ Cassonetti: ${project.positions.filter(p => p.cassonetto).length}
</div>
<h2>üìê DETTAGLIO POSIZIONI</h2>
${project.positions.map((pos, idx) => generatePositionHTML(pos, idx, project.positions.length, project)).join('')}
<div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #e2e8f0; text-align: center; color: #64748b; font-size: 0.9em;">
<p>Documento generato automaticamente da Open Porte App</p>
<p>OPEN PORTE & FINESTRE SRL - Capitale Sociale ‚Ç¨20.000</p>
</div>
</body></html>`;
        }

        // Helper per generare la spiegazione del calcolo BRM
        function generateBRMExplanation(pos, product, productType, project) {
            if (!product) return '';
            
            // Determina quale brmConfig usare
            let brmConfig = null;
            let tipo = null;
            
            if (productType === 'infisso') {
                brmConfig = project.brmConfigInfissi;
                tipo = product.tipo;
            } else if (productType === 'persiana') {
                brmConfig = project.brmConfigPersiane;
            } else if (productType === 'tapparella') {
                brmConfig = project.brmConfigTapparelle;
            } else if (productType === 'zanzariera') {
                brmConfig = project.brmConfigZanzariere;
                tipo = pos.infisso?.tipo || '';
            } else if (productType === 'cassonetto') {
                brmConfig = project.brmConfigCassonetti;
            }
            
            if (!brmConfig) return '';
            
            // Determina se √® portafinestra
            const isPortafinestra = tipo && (tipo.includes('PF') || tipo.toUpperCase().includes('PF'));
            
            // Helper per calcolare e formattare una formula
            const spiegaMisura = (misuraBase, misure) => {
                if (!misuraBase) return null;
                
                misuraBase = misuraBase.replace(/\s+/g, '');
                
                // Se contiene +, √® una somma
                if (misuraBase.includes('+')) {
                    const parti = misuraBase.split('+').map(p => p.trim());
                    const valori = [];
                    let totale = 0;
                    
                    for (const parte of parti) {
                        const valore = parseFloat(misure[parte]);
                        if (!isNaN(valore)) {
                            valori.push(`${parte}(${valore})`);
                            totale += valore;
                        }
                    }
                    
                    return {
                        formula: valori.join(' + '),
                        base: totale
                    };
                }
                
                // Singola misura
                const valore = parseFloat(misure[misuraBase]);
                return isNaN(valore) ? null : {
                    formula: misuraBase,
                    base: valore
                };
            };
            
            // Usa le misure corrette in base al tipo di prodotto
            const misure = (productType === 'cassonetto') ? product : pos.misure;
            
            let result = '<tr><td colspan="2" style="background:#e0f2fe;padding:8px;font-size:0.85em;"><strong>üìê Calcolo BRM:</strong><br>';
            const explanations = [];
            
            // Calcola L
            const misuraBaseLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'misuraBaseL_PF' : 'misuraBaseL';
            const operazioneLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'operazioneL_PF' : 'operazioneL';
            const valoreLKey = (isPortafinestra && brmConfig.misuraBaseL_PF) ? 'valoreL_PF' : 'valoreL';
            
            if (brmConfig[misuraBaseLKey] && product.BRM_L !== undefined && product.BRM_L !== null) {
                const infoL = spiegaMisura(brmConfig[misuraBaseLKey], misure);
                if (infoL) {
                    const valoreL = parseFloat(brmConfig[valoreLKey]) || 0;
                    const operazioneL = brmConfig[operazioneLKey] || '-';
                    const segno = operazioneL === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_L</strong> = ${infoL.formula} ${segno} ${Math.abs(valoreL)} = <strong>${product.BRM_L} mm</strong>`);
                }
            }
            
            // Calcola H
            const misuraBaseHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'misuraBaseH_PF' : 'misuraBaseH';
            const operazioneHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'operazioneH_PF' : 'operazioneH';
            const valoreHKey = (isPortafinestra && brmConfig.misuraBaseH_PF) ? 'valoreH_PF' : 'valoreH';
            
            if (brmConfig[misuraBaseHKey] && product.BRM_H !== undefined && product.BRM_H !== null) {
                const infoH = spiegaMisura(brmConfig[misuraBaseHKey], misure);
                if (infoH) {
                    const valoreH = parseFloat(brmConfig[valoreHKey]) || 0;
                    const operazioneH = brmConfig[operazioneHKey] || '-';
                    const segno = operazioneH === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_H</strong> = ${infoH.formula} ${segno} ${Math.abs(valoreH)} = <strong>${product.BRM_H} mm</strong>`);
                }
            }
            
            // Calcola C (cassonetti)
            if (brmConfig.misuraBaseC && product.BRM_C !== undefined && product.BRM_C !== null) {
                const infoC = spiegaMisura(brmConfig.misuraBaseC, misure);
                if (infoC) {
                    const valoreC = parseFloat(brmConfig.valoreC) || 0;
                    const operazioneC = brmConfig.operazioneC || '-';
                    const segno = operazioneC === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_C</strong> = ${infoC.formula} ${segno} ${Math.abs(valoreC)} = <strong>${product.BRM_C} mm</strong>`);
                }
            }
            
            // Calcola B (cassonetti)
            if (brmConfig.misuraBaseB && product.BRM_B !== undefined && product.BRM_B !== null) {
                const infoB = spiegaMisura(brmConfig.misuraBaseB, misure);
                if (infoB) {
                    const valoreB = parseFloat(brmConfig.valoreB) || 0;
                    const operazioneB = brmConfig.operazioneB || '-';
                    const segno = operazioneB === '+' ? '+' : '‚àí';
                    explanations.push(`<strong>BRM_B</strong> = ${infoB.formula} ${segno} ${Math.abs(valoreB)} = <strong>${product.BRM_B} mm</strong>`);
                }
            }
            
            if (explanations.length === 0) return '';
            
            result += explanations.join('<br>');
            result += '</td></tr>';
            
            return result;
        }

        // Helper per generare HTML singola posizione
        function generatePositionHTML(pos, idx, total, project) {
            return `${idx > 0 ? '<div class="page-break"></div>' : ''}<div class="page-break-avoid">
<h3>Posizione ${idx + 1}: ${pos.nome || pos.id}${pos.piano ? ' - ' + pos.piano : ''}</h3>
${pos.ambiente ? `<p><strong>Ambiente:</strong> ${pos.ambiente}</p>` : ''}
<p><strong>üìè Misure Vano:</strong></p>
<table><tr><th>LVT</th><th>HVT</th><th>LF</th><th>HF</th><th>TMV</th><th>HMT</th></tr>
<tr><td>${pos.misure?.LVT || '-'}</td><td>${pos.misure?.HVT || '-'}</td><td>${pos.misure?.LF || '-'}</td><td>${pos.misure?.HF || '-'}</td><td>${pos.misure?.TMV || '-'}</td><td>${pos.misure?.HMT || '-'}</td></tr></table>
${pos.infisso ? `<h4>ü™ü INFISSO</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.infisso.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.infisso.tipo || '-'}</td></tr>
<tr><td>Apertura</td><td>${pos.infisso.apertura || '-'}</td></tr>
<tr><td>Azienda</td><td>${pos.infisso.azienda || '-'}</td></tr>
<tr><td>Finitura Int</td><td>${pos.infisso.finituraInt || '-'}</td></tr>
<tr><td>Finitura Est</td><td>${pos.infisso.finituraEst || '-'}</td></tr>
<tr><td>Colore Int</td><td>${pos.infisso.coloreInt || '-'}</td></tr>
<tr><td>Colore Est</td><td>${pos.infisso.coloreEst || '-'}</td></tr>
<tr><td>Vetro</td><td>${pos.infisso.vetro || '-'}</td></tr>
${pos.infisso.BRM_L !== undefined || pos.infisso.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.infisso.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.infisso.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.infisso, 'infisso', project)}` : ''}</table>` : ''}
${pos.persiana ? `<h4>üö™ PERSIANA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.persiana.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.persiana.tipo || '-'}</td></tr>
<tr><td>Colore Persiana</td><td>${pos.persiana.colorePersiana || '-'}</td></tr>
${pos.persiana.BRM_L !== undefined || pos.persiana.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.persiana.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.persiana.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.persiana, 'persiana', project)}` : ''}</table>` : ''}
${pos.tapparella ? `<h4>üéöÔ∏è TAPPARELLA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.tapparella.quantita || 1}</td></tr>
<tr><td>Azienda</td><td>${pos.tapparella.azienda || '-'}</td></tr>
<tr><td>Modello</td><td>${pos.tapparella.modello || '-'}</td></tr>
${pos.tapparella.BRM_L !== undefined || pos.tapparella.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.tapparella.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.tapparella.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.tapparella, 'tapparella', project)}` : ''}</table>` : ''}
${pos.zanzariera ? `<h4>ü¶ü ZANZARIERA</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Quantit√†</td><td>${pos.zanzariera.quantita || 1}</td></tr>
<tr><td>Tipo</td><td>${pos.zanzariera.tipo || '-'}</td></tr>
${pos.zanzariera.BRM_L !== undefined || pos.zanzariera.BRM_H !== undefined ? `<tr><td><strong>BRM L</strong></td><td><strong>${pos.zanzariera.BRM_L ?? '-'} mm</strong></td></tr>
<tr><td><strong>BRM H</strong></td><td><strong>${pos.zanzariera.BRM_H ?? '-'} mm</strong></td></tr>
${generateBRMExplanation(pos, pos.zanzariera, 'zanzariera', project)}` : ''}</table>` : ''}
${pos.cassonetto ? `<h4>üì¶ CASSONETTO</h4><table><tr><th>Campo</th><th>Valore</th></tr>
<tr><td>Tipo</td><td>${pos.cassonetto.tipo || '-'}</td></tr>
<tr><td>LS</td><td>${pos.cassonetto.LS || 0} mm</td></tr>
<tr><td>HCASS</td><td>${pos.cassonetto.HCASS || 0} mm</td></tr>
${pos.cassonetto.BRM_C !== undefined && pos.cassonetto.BRM_C !== null ? `<tr><td><strong>BRM_C</strong></td><td><strong>${pos.cassonetto.BRM_C ?? '-'} mm</strong></td></tr>` : ''}
${pos.cassonetto.BRM_B !== undefined && pos.cassonetto.BRM_B !== null ? `<tr><td><strong>BRM_B</strong></td><td><strong>${pos.cassonetto.BRM_B ?? '-'} mm</strong></td></tr>` : ''}
${generateBRMExplanation(pos, pos.cassonetto, 'cassonetto', project)}</table>` : ''}
</div>`;
        }

        // ‚ö° FASE 024: Render differito con debounce
        // Permette all'utente di fare pi√π modifiche consecutive senza interruzioni
        // Il render viene eseguito solo dopo 300ms di "silenzio"
        function deferredRender() {
            // Cancella il timer precedente se esiste
            if (renderTimeout) {
                clearTimeout(renderTimeout);
            }
            
            // Schedula un nuovo render tra 300ms
            renderTimeout = setTimeout(() => {
                render();
                renderTimeout = null;
            }, RENDER_DEBOUNCE_MS);
        }

        // Main Render Function
        function render() {
            const app = document.getElementById('app');
            app.innerHTML = `
                ${MainMenu()}
                <main class="min-h-screen">
                    ${state.screen === 'list' ? ProjectsList() :
                      state.screen === 'position' ? PositionDetail() :
                      ProjectSetup()}
                </main>
                ${NewProjectModal()}
                ${FotoModal()}
            `;
        }

        // Navigation function for setup steps - MANCAVA QUESTA!
        window.navigateToStep = (step) => {
            state.setupStep = step;
            render();
        };

        // Error handler per debug
        window.onerror = function(msg, url, lineNo, columnNo, error) {
            console.error('Errore JavaScript:', {
                message: msg,
                source: url,
                lineno: lineNo,
                colno: columnNo,
                error: error
            });
            return false;
        };

        // Initialize App con gestione errori
        try {
            console.log('Inizializzazione app...');
            loadState();
            render();
            console.log('App inizializzata correttamente');
            
            // Verifica se serve sincronizzazione (solo 1 volta per sessione)
            const project = state.projects.find(p => p.id === state.currentProject);
            if (project && !state.sincronizzazioneVerificata) {
                if (verificaSincronizzazioneNecessaria(project)) {
                    // Mostra avviso solo 1 volta
                    state.sincronizzazioneVerificata = true;
                }
            }
            
        } catch (error) {
            console.error('Errore durante inizializzazione:', error);
            alert('Si √® verificato un errore. Controlla la console per i dettagli.');
        }
    </script>

    <!-- üéØ OTTIMIZZAZIONE NAVIGAZIONE TAB: Solo campi dati, no pulsanti -->
    <script>
        // Esegui dopo ogni render per mantenere la configurazione TAB
        const originalRender = window.render;
        window.render = function() {
            originalRender();
            // Applica tabindex dopo il render
            setTimeout(() => {
                // Escludi TUTTI i button dalla navigazione TAB
                document.querySelectorAll('button').forEach(btn => {
                    btn.setAttribute('tabindex', '-1');
                });
                
                // Escludi anche i link dalla navigazione TAB
                document.querySelectorAll('a').forEach(link => {
                    link.setAttribute('tabindex', '-1');
                });
                
                // Mantieni SOLO input, select, textarea navigabili con TAB
                // (Questi elementi hanno gi√† tabindex=0 di default, non serve modificarli)
            }, 10);
        };
        
        console.log('‚úÖ Navigazione TAB ottimizzata: Ora TAB passa solo tra i campi dati!');
        console.log('‚úÖ FASE 021: Menu laterale hamburger attivato!');

        // ============================================
        // üçî MENU SISTEMA - FASE 020
        // ============================================

        window.toggleMenu = function() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu && overlay) {
                menu.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        };

        window.closeMenu = function() {
            const menu = document.getElementById('sideMenu');
            const overlay = document.getElementById('menuOverlay');
            
            if (menu && overlay) {
                menu.classList.remove('open');
                overlay.classList.remove('active');
            }
        };

        window.navigateTo = function(section) {
            // Chiudi menu su mobile
            if (window.innerWidth < 768) {
                closeMenu();
            }
            
            // Rimuovi active da tutti i link
            document.querySelectorAll('.menu-list a').forEach(link => {
                link.classList.remove('active');
            });
            
            // Aggiungi active al link corrente
            const currentLink = document.querySelector(`.menu-list a[href="#${section}"]`);
            if (currentLink) {
                currentLink.classList.add('active');
            }
            
            // Per ora gestiamo solo la sezione "progetti" che √® l'app principale
            // Le altre sezioni verranno implementate successivamente
            if (section === 'progetti') {
                // L'app principale √® gi√† visibile
                console.log('üìÅ Sezione progetti');
            } else if (section === 'config') {
                // TODO: Implementare pagina config globali
                showNotification('‚öôÔ∏è Config Globali - In sviluppo', 'info');
            } else if (section === 'backup') {
                // TODO: Implementare pagina backup
                showNotification('üíæ Backup - In sviluppo', 'info');
            } else if (section === 'sync') {
                // TODO: Implementare pagina sync
                showNotification('üîÑ Sincronizzazione - In sviluppo', 'info');
            } else if (section === 'info') {
                // TODO: Implementare pagina info
                showNotification('‚ÑπÔ∏è Info & Guida - In sviluppo', 'info');
            }
            
            // Salva sezione corrente
            try {
                localStorage.setItem('currentMenuSection', section);
            } catch (e) {
                console.warn('Impossibile salvare sezione corrente:', e);
            }
            
            // Scroll top
            window.scrollTo(0, 0);
        };

        // Inizializza menu al caricamento
        setTimeout(() => {
            let lastSection = 'progetti'; // Default
            
            try {
                lastSection = localStorage.getItem('currentMenuSection') || 'progetti';
            } catch (e) {
                console.warn('Impossibile recuperare ultima sezione:', e);
            }
            
            navigateTo(lastSection);
            console.log('‚úÖ FASE 020: Menu sistema inizializzato!');
        }, 100);

        // Chiudi menu con tasto ESC
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeMenu();
            }
        });

        // ‚òÅÔ∏è FASE 022a: Inizializzazione OneDrive Sync
        // Gestisci callback OAuth se presente nell'URL
        handleAuthCallback();
        
        // Avvia auto-sync se connesso
        if (state.onedrive.connected && state.onedrive.autoSyncEnabled) {
            startAutoSync();
            console.log('‚úÖ OneDrive auto-sync attivata');
        }
        
        // Keyboard shortcuts
        document.addEventListener('keydown', (e) => {
            // Ctrl/Cmd + K per ricerca
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                toggleMainMenu();
                setTimeout(() => {
                    const searchInput = document.getElementById('mainSearch');
                    if (searchInput) searchInput.focus();
                }, 300);
            }
            
            // Ctrl/Cmd + N per nuovo progetto
            if ((e.ctrlKey || e.metaKey) && e.key === 'n') {
                e.preventDefault();
                showNewProjectModal();
            }
            
            // Ctrl/Cmd + S per salvare
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveState();
                showNotification('üíæ Salvato', 'success');
            }
            
            // Ctrl/Cmd + E per export
            if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                e.preventDefault();
                if (state.currentProject) {
                    exportCurrentProjectJSON();
                } else {
                    exportAllProjects();
                }
            }
            
            // Esc per chiudere menu/modal
            if (e.key === 'Escape') {
                if (state.mainMenuOpen) {
                    closeMainMenu();
                }
                if (state.projectMenuOpen) {
                    closeProjectMenu();
                }
                // Chiudi anche eventuali modal
                const modals = document.querySelectorAll('.modal-overlay');
                modals.forEach(modal => {
                    if (modal.style.display === 'flex') {
                        modal.style.display = 'none';
                    }
                });
            }
        });
        
        // Aggiungi animazioni CSS
        const style = document.createElement('style');
        style.textContent = `
            @keyframes slideUp {
                from { transform: translate(-50%, 100%); opacity: 0; }
                to { transform: translate(-50%, 0); opacity: 1; }
            }
            @keyframes slideDown {
                from { transform: translate(-50%, 0); opacity: 1; }
                to { transform: translate(-50%, 100%); opacity: 0; }
            }
        `;
        document.head.appendChild(style);
    </script>
</body>
</html>
