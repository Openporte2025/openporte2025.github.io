<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <!--
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    DASHBOARD RILIEVI v7.41 - CHANGELOG
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.41 (20 NOV 2025):
    
    ğŸ” SICUREZZA TOKEN GITHUB - FIX CRITICO
    - âŒ RIMOSSO: Token hardcoded dal codice (VULNERABILITÃ€ DI SICUREZZA)
    - âœ… Token ora caricato SOLO da localStorage (sicuro)
    - ğŸ”’ Nessun token committato nel repository
    - âš ï¸ Se token non trovato: Overlay nascosto + Form inserimento token
    - ğŸ”„ Dopo inserimento token: Auto-reload progetti da GitHub
    - ğŸ¯ Form token appare SOTTO overlay (non piÃ¹ coperto)
    - ğŸ“ Gestione corretta flusso: Token missing â†’ Form â†’ Salva â†’ Reload
    
    PROBLEMA RISOLTO:
    - Token GitHub era esposto nel codice sorgente
    - GitHub ha revocato automaticamente il token per sicurezza
    - Ora token Ã¨ gestito solo via localStorage (mai hardcoded)
    
    FUNZIONI MODIFICATE:
    - GITHUB_DASHBOARD_CONFIG.token: ora '' invece di token hardcoded
    - initGitHubSync(): Aggiunto check token â†’ mostra form se mancante
    - Overlay nascosto PRIMA di mostrare form token
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.40 (20 NOV 2025):
    
    âœ… CARICAMENTO INIZIALE AUTOMATICO DA GITHUB
    - ğŸ”„ AGGIUNTO: Overlay "Caricamento progetti..." all'avvio app
    - ğŸ“¡ Sync automatico da GitHub prima di mostrare interfaccia
    - â±ï¸ Assicura dati sempre aggiornati all'apertura dashboard
    - ğŸ¨ Spinner animato con testo informativo
    - âœ… Nasconde overlay dopo caricamento completato (500ms fade)
    - ğŸ”§ Gestione errori: overlay si nasconde anche in caso di fallimento
    - ğŸ’¾ Mantiene auto-refresh ogni 60 secondi per aggiornamenti continui
    - ğŸ¯ UX migliorata: utente vede sempre ultimi dati sincronizzati
    
    FUNZIONI MODIFICATE:
    - initGitHubSync(): Aggiunto try/finally per gestione overlay
    - CSS: Nuovi stili per overlay caricamento con animazione spinner
    - HTML: Overlay con spinner, testo principale e sottotesto
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.39 (20 NOV 2025):
    
    âœ… LISTINO PREZZI TAPPARELLE PLASTICINO
    - ğŸ“‹ AGGIUNTO: Sistema completo calcolo prezzi tapparelle Plasticino/New Solar/Estella
    - ğŸ’° Listino componenti completo: Rullo (â‚¬13.20/m), Componenti fissi (â‚¬66.40), Supplemento H (â‚¬0.50/m)
    - ğŸ§® Funzione calcolaPrezzoPLASTICINO(L_cm, H_cm) con calcolo automatico
    - ğŸ“Š Integrazione Vista Preventivo: tapparelle appaiono automaticamente in tabella prezzi
    - ğŸ”¢ Calcolo dettagliato: Rullo + 10 componenti fissi + supplemento doppia altezza (se H>300cm)
    - ğŸ¯ Compatibile con struttura esistente: aziende plasticino, new solar, estella
    - ğŸ“‚ Database: LISTINO_PLASTICINO con tutti i codici componenti (COMP-01 a COMP-10)
    - âœ… Test: Calcoli verificati con esempi 120Ã—250cm, 150Ã—400cm, 200Ã—250cm
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.38 (20 NOV 2025):
    
    âœ… GESTIONE GUIDE TAPPARELLE
    - ğŸ“œ AGGIUNTO: Campo "Guida Tapparella" nelle configurazioni colonne
    - ğŸ”§ Integrato con sistema esistente tapparelle (azienda, tipo, colore, automazione)
    - âœ… Visualizzazione guida in sezione tapparella Vista Posizioni
    - ğŸ“Š Checkbox controllo visibilitÃ  colonna nelle impostazioni
    - ğŸ“‹ Database guide preparatorio creato (guide-tapparelle-prezzi.js) con listino Plasticino
    - ğŸ’° Pronto per calcoli costi guide in future versioni
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.36 (19 NOV 2025):
    
    âœ… SEMPLIFICAZIONE MENU PRINCIPALE
    - âŒ RIMOSSO: Bottone "Dettaglio Costi" dal menu principale
    - ğŸ¯ Accesso: Dettaglio Costi ora disponibile solo da Ufficio â†’ Preventivo â†’ Toolbar
    - ğŸ“Š Menu: [Generale] [Ufficio] [Apri App Posa] [Conferma Cliente]
    - âš¡ Dashboard piÃ¹ pulita e intuitiva
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.35 (19 NOV 2025):
    
    âœ… RIORGANIZZAZIONE PREVENTIVO E LISTINI
    - ğŸ“Š Vista Preventivo: aggiunto bottone "ğŸ“š Listini"
    - ğŸ“ˆ Vista Preventivo: aggiunto bottone "ğŸ’° Dettaglio Costi"
    - ğŸ”— Bottoni nel toolbar sotto la tabella Excel
    - ğŸ“š Modal "Gestione Listini" separato giÃ  esistente
    - ğŸ¯ Struttura: Ufficio â†’ Preventivo â†’ [Listini] [Dettaglio Costi] [Excel]
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.34 (19 NOV 2025):
    
    âœ… SNELLIMENTO DASHBOARD - ELIMINATO BLOCCO POSA INTERNO
    - âŒ RIMOSSO: Intero blocco-posa dalla dashboard (HTML + funzioni)
    - âœ… SOSTITUITO: Bottone "Posa" â†’ "Apri App Posa"
    - ğŸ”— Click diretto su bottone â†’ apre posa-app-v1_6.html in nuova tab
    - ğŸ¯ Dashboard piÃ¹ leggera: -700+ righe HTML eliminate
    - âš¡ Funzione apriPosaApp() giÃ  esistente e funzionante
    - ğŸ“± Separazione totale: Dashboard (gestione) vs App Posa (campo)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.33 (19 NOV 2025):
    
    âœ… RISTRUTTURAZIONE "DETTAGLIO COSTI" - NUOVA ORGANIZZAZIONE TAB
    - ğŸ“Š Tab 1: "Riepilogo" (ex "Dettaglio Costi") - Tabella Excel-style con tutti i totali
    - ğŸšª Tab 2: "Persiane" - Listino Punto Persiane + Test Calcolo integrato
    - ğŸ¦Ÿ Tab 3: "Zanzariere" - Listino Palagina completo
    - ğŸªŸ Tab 4: "Infissi" - Placeholder (da implementare con listino Finstral)
    - ğŸ“¦ Tab 5: "Tapparelle" - Placeholder (da implementare)
    - ğŸ“ Tab 6: "Cassonetti" - Placeholder (da implementare)
    - ğŸ¯ Organizzazione logica: prima riepilogo generale, poi dettagli per prodotto
    - âœ… Test Calcolo integrato dentro ogni tab prodotto
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.32 (19 NOV 2025):
    
    âœ… IMPLEMENTATO SISTEMA CALCOLO PERSIANE - STEP 1
    - ğŸ“Š Nuovo listino persiane con griglie dimensionali (Punto Persiane)
    - ğŸ—ï¸ Modelli implementati: NERINA, OSCURA, VANITOSA
    - ğŸ“ Prezzi base da preventivi reali per dimensioni specifiche
    - ğŸ¨ **Sistema colori COMPLETO: 41 colori in 8 categorie (0%-30% maggiorazione)**
    - ğŸ› ï¸ Telai: TH62 (â‚¬136), TH40 (â‚¬167), TH45 (â‚¬187)
    - ğŸ’° Supplementi automatici: Contributo gestione â‚¬57 + Imballo 3%
    - âš™ï¸ Formula calcolo: Base + Telaio + Colore% + Contributo + Imballo
    - ğŸ”„ Sostituito vecchio sistema a prezzo/mq con griglie dimensionali
    - ğŸ“ Fonte dati: Listino Ottobre 2025 + Preventivi P2520726, P2520434
    
    âœ… ğŸ¨ COLORI PERSIANE COMPLETI (41 COLORI)
    - Cat.01 (0%): 7 colori standard (CPF910L, CPF113L, CPF701L, CPF716L, CPF605L, CPF609T, CPF817L)
    - Cat.02A (+3%): 6 colori opachi speciali (CPF735L, CPF609L, CPF621L, CPF119L, CPF524L, CPF811L)
    - Cat.02B (+5%): 6 colori textured (CPF910T, CPF113T, CPF701T, CPF305T, CPF605T, CPF817T)
    - Cat.03 (+20%): 7 colori legno Ezy (CPF820H, CPF818H, CPF813H, CPFR811, CPF812H, CPFN630, CPFN632)
    - Cat.04 (+25%): 3 colori legno Ã‰lite (HD303, HD360, HD366)
    - Cat.05 (+25%): 3 colori sublimato Electo (CPF90RC, CPF91RS, CPF51CR)
    - Cat.06 (+30%): 5 colori sublimato (CPF358R, CPF127R, CPF375R, CPF378R, CPF317R)
    - Cat.07 (+30%): 1 colore speciale (CPF70KA Winchester)
    - Cat.08 (A preventivo): 3 colori speciali (CPFSLV7, CPFRGG4, CPF744L + cambio cabina â‚¬237)
    - ğŸ“‹ Estratti da Listino Punto Persiane 45/52 Ottobre 2025 (pag.124-125)
    
    âœ… ğŸ†• SISTEMA GESTIONE LISTINI
    - ğŸ“š Bottone "Listini" nel menu principale (arancione)
    - ğŸ—ï¸ Tab Persiane: Visualizzazione modelli, dimensioni, telai, colori, supplementi
    - ğŸ¦Ÿ Tab Zanzariere: Listino Palagina completo
    - ğŸ§ª Tab Test Calcolo: Calcolo prezzi in tempo reale con breakdown dettagliato
    - ğŸ¨ Card interattive con hover effects
    - ğŸ“Š Grid responsive per dimensioni/prezzi
    - âš¡ Anteprima calcolo istantanea
    
    âœ… ğŸ†• INSERIMENTO MANUALE PREZZI PERSIANE
    - âš ï¸ Quando dimensione NON trovata in listino â†’ Modale inserimento manuale
    - âœï¸ Form inserimento: Prezzo base, Telaio, Colore%, Note
    - ğŸ§® Anteprima calcolo automatica con breakdown completo
    - ğŸ’¾ Salvataggio in progetto con timestamp e tracciabilitÃ 
    - ğŸ”„ Sync automatico su GitHub
    - ğŸ·ï¸ Badge "(MANUALE)" per prezzi inseriti manualmente
    - ğŸ“ Formula calcolo consistente: Base + Telaio + Colore% + Contributo + Imballo
    - âœ… PrioritÃ : Prezzo Manuale â†’ Listino â†’ Errore con bottone inserimento
    
    FUNZIONI MODIFICATE:
    - calcolaPersiana(): Nuovo sistema con griglia dimensioni + tipologie (F1, F2, PF2)
    - Listino persiane: Struttura gerarchica modelli â†’ prezzi â†’ tipologie â†’ dimensioni
    - Supporto parametro "tipologia" per selezione corretta griglia prezzi
    - Gestione prezzi manuali con oggetto completo (base, telaio, colore, supplementi)
    
    FUNZIONI AGGIUNTE:
    - apriGestioneListini(): Apre modale gestione listini
    - switchTabListini(): Switch tra tab persiane/zanzariere/test
    - eseguiTestCalcolo(): Test calcolo prezzi in tempo reale
    - apriModalPrezzoManuale(): Apre modale inserimento manuale
    - calcolaAnteprimaManuale(): Calcola anteprima con valori manuali
    - salvaPrezzoManuale(): Salva prezzo manuale nel progetto + sync GitHub
    
    â³ PROSSIMI STEP:
    - [ ] STEP 2: Estrazione griglie complete da PDF per NERINA, OSCURA, VANITOSA
    - [ ] STEP 3: Aggiunta altri modelli (ANGELA, GIULIA, LUNA, AURORA)
    - [ ] STEP 4: Lista completa colori categorie 1-8
    - [ ] STEP 5: Integrazione in App rilievo v4.33
    - [ ] Badge "MANUALE" visivo in preventivi PDF
    - [ ] Pagina gestione prezzi manuali (modifica/elimina)
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.31 (19 NOV 2025):
    
    âœ… INTEGRAZIONE POSA APP v1.6 - TOKEN PERSONALI & DEPLOYMENT
    - ğŸ”— AGGIORNATO: Collegamento a posa-app-v1_6.html (era v1_5.html)
    - ğŸ”‘ Posa App ora usa token GitHub personali (no hardcoded)
    - ğŸ‘¤ Sistema multi-utente sicuro con autenticazione
    - ğŸ“± Ottimizzazione smartphone completa (touch targets 48px)
    - ğŸšª Logout button integrato per cambio utente
    - ğŸ¯ Pronto per deployment GitHub Pages multi-repository
    - ğŸ“š Documentazione completa deployment inclusa
    - âœ… Testing locale completato
    - ğŸš€ Production-ready per squadra campo
    
    NOVITÃ€ POSA APP v1.6:
    - Token personali salvati in localStorage (sicurezza)
    - Schermata login elegante con istruzioni integrate
    - Validazione formato token (ghp_/github_pat_)
    - Pulsante logout con conferma
    - Media query responsive smartphone (320px-480px)
    - Font 16px per prevenire zoom iOS
    - Touch targets conformi Apple HIG
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.30 (19 NOV 2025):
    
    âœ… SEMPLIFICAZIONE BLOCCO POSA - COLLEGAMENTO APP DEDICATA
    - âŒ RIMOSSO: Intero blocco Posa dalla dashboard (Vista Generale, Posizioni, Dettaglio)
    - âœ… SOSTITUITO: Card informativa con collegamento diretto alla Posa App
    - ğŸ”— Bottone centrale "Apri Posa App" per accesso immediato
    - ğŸ“± Mostra funzionalitÃ  disponibili nell'app (4 viste principali)
    - ğŸ¯ Dashboard focalizzata su: Generale, Ufficio, Analisi Costi, Conferma Cliente
    - ğŸ”§ Posa App gestisce: Vista Posizione, Prodotto, Azienda, Editing
    - ğŸš€ Migliore separazione responsabilitÃ : Dashboard (gestione) vs App (campo)
    - âš¡ Dashboard piÃ¹ leggera: -77 righe HTML eliminato codice obsoleto
    - ğŸ“Š Layout responsive con grid 4 funzionalitÃ 
    - ğŸ¨ Styling coordinato arancione
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.29 (19 NOV 2025):
    
    âœ… INTEGRAZIONE POSA APP SEPARATA
    - Nuovo bottone nel Blocco Posa: "ğŸ”— Apri App Separata"
    - Header dedicato con styling arancione coordinato
    - Funzione apriPosaApp(): apre posa-app-v1_6.html in nuova finestra
    - Passaggio automatico project ID via localStorage
    - Verifica progetto caricato prima apertura
    - Gestione popup bloccati con messaggio utente
    - Finestra ottimizzata: 1400Ã—900px
    - CSS responsive con hover/active states
    - Console log per debugging
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.28 (18 NOV 2025):
    
    âœ… RINOMINA "PREVENTIVO" â†’ "ANALISI COSTI"
    - Bottone menu: ğŸ’° Preventivo â†’ ğŸ“ˆ Analisi Costi
    - Modale: "Preventivo Commessa" â†’ "Analisi Costi Commessa"
    - Scopo: uso interno operatore per calcoli dettagliati
    
    âœ… SISTEMA CONFERMA CLIENTE (in sviluppo)
    - Nuovo documento separato da Analisi Costi
    - Layout 1 pagina per posizione
    - Colonne selezionabili (infissi, persiane, prezzi, ecc)
    - Prezzi opzionali/editabili (integrazione Odoo)
    - Export PDF professionale
    - Menu impostazioni colonne + quick toggles
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.27 (18 NOV 2025):
    
    âœ… MENU DINAMICO CON INDICATORI COMPLETAMENTO
    - Indicatori colorati per ogni sezione: ğŸŸ¢ 100%, ğŸŸ¡ 50-99%, ğŸ”´ 1-49%, âšª 0%
    - Calcolo automatico completamento Generale (6 campi)
    - Calcolo automatico completamento Ufficio (configurazioni prodotti)
    - Calcolo automatico completamento Posa (posizioni con prodotti)
    - Calcolo automatico completamento Preventivo (presenza prezzi)
    - Aggiornamento real-time al caricamento progetto
    - Aggiornamento dopo import JSON e sync GitHub
    
    âœ… FUNZIONI AGGIUNTE
    - calcolaCompletamentoGenerale(): verifica dati cliente/progetto
    - calcolaCompletamentoUfficio(): verifica config prodotti (infissi, persiane, ecc)
    - calcolaCompletamentoPosa(): verifica posizioni con quantitÃ  prodotti
    - calcolaCompletamentoPreventivo(): verifica presenza prezzi
    - aggiornaMenuIndicatori(): aggiorna tutti gli indicatori menu
    - getColoreIndicatore(): restituisce colore in base a percentuale
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    ğŸ”§ VERSIONE 7.26 (18 NOV 2025):
    
    âœ… INTEGRATO DATABASE MANIGLIE FINSTRAL COMPLETO
    - Database completo da catalogo EUR 2025/3 Finstral (1075 righe)
    - 67 maniglie complete (Serie 1-4, 11-16)
    - 13 colori ufficiali con codici
    - Funzioni helper: getManigliaByCode(), getSupplemento(), getColoreDescrizione()
    
    âœ… FUNZIONI PARSING MANIGLIE (CompatibilitÃ  App v4.31-v4.32)
    - estraiCodiceManiglia(): estrae "6010" da "6010 - Finestra alluminio"
    - estraiCodiceColore(): estrae "07" da "07 - Bianco perla"
    - calcolaSupplementoManigliaFinstral(): calcolo supplementi con database
    - calcolaSupplementoManigliaVecchio(): fallback per progetti vecchi
    
    âœ… CALCOLO SUPPLEMENTI MANIGLIE
    - Supporta formato nuovo App v4.31+: "6010 - Finestra alluminio" + "07 - Bianco perla"
    - Supporta formato vecchio App v4.30-: "standard", "inox", "design", ecc.
    - Calcolo automatico supplementi base + supplementi extra per colori speciali
    - Esempi: 6010+07 = â‚¬19.6, 6020+56 = â‚¬64.4, 1901+M01 = â‚¬31.3
    
    âœ… MODIFICHE TECNICHE
    - Riga ~3900: Database MANIGLIE_FINSTRAL incluso (dopo <script>)
    - Riga ~8560: Funzioni parsing maniglie/colori
    - Riga ~8818: Lettura infisso.maniglia + infisso.coloreManiglia
    - Riga ~8730: Vecchia funzione calcolaSupplementoManiglia() deprecata
    - Riga ~8560: SUPPLEMENTI_MANIGLIE vecchio commentato
    
    âœ… COMPATIBILITÃ€
    - Progetti vecchi (pre-v4.31): funzionano con supplementi fissi
    - Progetti nuovi (v4.31+): calcolo supplementi preciso da database
    - Colori custom (es: RAL speciali): riconosciuti e visualizzati
    - Dashboard riconosce automaticamente formato vecchio vs nuovo
    
    â³ PROSSIMI SVILUPPI
    - [ ] Aggiungere colonne "Maniglia" e "Colore" nella tabella (se richiesto)
    - [ ] Visualizzare descrizioni complete maniglie/colori (non solo supplemento)
    - [ ] Export Excel con dettagli maniglie complete
    
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    -->
    
    <title>Dashboard Rilievi v7.39 - Gestione Generale e Ufficio</title>
    <style>
        /* ================================================================================
           RESET E BASE
           ================================================================================ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        /* FIX iPad/Touch - Tutti elementi cliccabili */
        button,
        a,
        label,
        input[type="checkbox"],
        input[type="radio"],
        select,
        [onclick],
        [role="button"] {
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            cursor: pointer;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2d3748;
            line-height: 1.6;
        }

        /* ================================================================================
           OVERLAY CARICAMENTO INIZIALE
           ================================================================================ */
        #initial-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: opacity 0.5s ease;
        }

        #initial-loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top: 4px solid #ff8c42;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 1.25rem;
            color: #2d3748;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-subtext {
            font-size: 0.9rem;
            color: #718096;
        }

        /* ================================================================================
           HEADER E NAVIGAZIONE PRINCIPALE
           ================================================================================ */
        .header {
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #2d3748;
        }

        .logo-version {
            font-size: 0.75rem;
            color: #718096;
            font-weight: 400;
        }

        .main-nav {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            background: #e2e8f0;
            color: #4a5568;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
            /* FIX iPad/Touch */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        
        /* Spazio extra dopo Ufficio */
        .nav-btn.blocco-ufficio {
            margin-right: 1rem;
        }
        
        /* Spazio extra dopo Posa */
        .nav-btn.blocco-posa {
            margin-right: 0.5rem;
        }

        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-btn.active {
            color: white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.15);
        }

        .nav-btn.active.blocco-generale {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .nav-btn.active.blocco-ufficio {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .nav-btn.active.blocco-posa {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        /* Bottone Analisi Costi (ex Preventivo) */
        .nav-btn#btn-preventivo:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-btn#btn-preventivo:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        /* Bottone Conferma Cliente */
        .nav-btn#btn-conferma-cliente:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .nav-btn#btn-conferma-cliente:not(:disabled):hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(59, 130, 246, 0.4);
        }

        /* Completion badges sui bottoni top nav */
        .nav-btn .completion-badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 8px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 10px;
            font-size: 0.7rem;
            font-weight: 700;
            transition: all 0.2s;
        }

        .nav-btn:hover .completion-badge {
            background: rgba(255, 255, 255, 0.5);
            transform: scale(1.05);
        }

        .nav-btn.active .completion-badge {
            background: rgba(255, 255, 255, 0.4);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* âœ… INDICATORI PERCENTUALE MENU DINAMICO v7.27 */
        .indicator-percentage {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.85em;
            font-weight: bold;
            background: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }

        .nav-btn:hover .indicator-percentage {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }

        .nav-btn.active .indicator-percentage {
            background: rgba(255, 255, 255, 0.25);
        }

        /* ================================================================================
           MENU AVANZATO - SIDEBAR E BREADCRUMB
           ================================================================================ */
        
        /* Toggle button hamburger menu - SEMPRE VISIBILE */
        .menu-toggle {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            padding: 0.5rem;
            font-size: 1.8rem;
            cursor: pointer;
            color: #4a5568;
            transition: all 0.2s;
            margin-right: 1rem;
        }

        .menu-toggle:hover {
            color: #667eea;
            transform: scale(1.1);
        }


        /* ================================================================================
           CONTAINER PRINCIPALE
           ================================================================================ */
        .container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 0 1rem;
            }
        }

        /* ================================================================================
           BLOCCHI CONTENUTO (nascosti di default)
           ================================================================================ */
        .blocco {
            display: none;
            animation: fadeIn 0.3s ease-in;
        }

        .blocco.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ================================================================================
           CARD GENERICHE
           ================================================================================ */
        .card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            color: #1a202c;
        }

        .card-subtitle {
            font-size: 1rem;
            color: #718096;
            margin-bottom: 1.5rem;
        }

        /* ================================================================================
           ZONA IMPORT JSON
           ================================================================================ */
        .import-zone {
            border: 3px dashed #cbd5e0;
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            background: #f7fafc;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .import-zone:hover {
            border-color: #667eea;
            background: #edf2f7;
        }

        .import-zone.drag-over {
            border-color: #667eea;
            background: #e6f2ff;
            transform: scale(1.02);
        }

        .import-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .import-title {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #2d3748;
        }

        .import-subtitle {
            color: #718096;
            margin-bottom: 1.5rem;
        }

        .btn {
            padding: 0.75rem 2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
        }

        /* Input file nascosto */
        #jsonFileInput {
            display: none;
        }

        /* ================================================================================
           STATO DATI
           ================================================================================ */
        .data-status {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            margin-top: 2rem;
        }

        .status-badge {
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .status-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .status-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .status-badge.error {
            background: #fee2e2;
            color: #991b1b;
        }

        .status-badge.info {
            background: #dbeafe;
            color: #1e40af;
        }

        /* ================================================================================
           VISTA POSIZIONI UFFICIO - LAYOUT
           ================================================================================ */
        .positions-layout {
            display: flex;
            gap: 1.5rem;
            min-height: 600px;
        }

        /* Sidebar Posizioni */
        .positions-sidebar {
            width: 280px;
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            max-height: calc(100vh - 200px);
            overflow-y: auto;
            position: sticky;
            top: 100px;
        }

        .positions-sidebar-title {
            font-size: 1rem;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Filtri sidebar */
        .positions-filters {
            margin-bottom: 1.5rem;
        }

        .filter-group {
            margin-bottom: 1rem;
        }

        .filter-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            display: block;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .filter-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 0.9rem;
            background: white;
            cursor: pointer;
        }

        .filter-select:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        /* Lista posizioni */
        .positions-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .position-list-item {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: white;
        }

        .position-list-item:hover {
            border-color: #10b981;
            transform: translateX(4px);
        }

        .position-list-item.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            box-shadow: 0 2px 4px rgba(16, 185, 129, 0.2);
        }

        .position-item-id {
            font-size: 0.85rem;
            font-weight: 700;
            color: #10b981;
        }

        .position-item-details {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Card Dettaglio Posizione */
        .position-detail {
            flex: 1;
            min-width: 0;
        }

        .position-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            border-left: 4px solid #10b981;
        }

        /* Header Posizione */
        .position-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 2rem;
            border-radius: 12px 12px 0 0;
        }

        .position-id-large {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .position-location {
            font-size: 1.1rem;
            opacity: 0.95;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .position-location-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .position-qty {
            margin-top: 0.5rem;
            font-size: 0.95rem;
            opacity: 0.9;
        }

        /* Sezioni Posizione */
        .position-section {
            padding: 2rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .position-section:last-child {
            border-bottom: none;
        }

        .position-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .position-section-icon {
            color: #10b981;
            font-size: 1.3rem;
        }

        /* Tabella Misure */
        .measures-table {
            width: 100%;
            border-collapse: collapse;
        }

        .measures-table th {
            background: #f9fafb;
            padding: 0.75rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            border-bottom: 2px solid #e5e7eb;
        }

        .measures-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
            font-size: 0.95rem;
        }

        .measure-label {
            font-weight: 600;
            color: #4b5563;
        }

        .measure-value {
            color: #10b981;
            font-weight: 600;
            font-size: 1.05rem;
        }

        .measure-highlight {
            background: #ecfdf5;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
        }

        /* Grid caratteristiche muro */
        .wall-chars-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .wall-char-item {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .wall-char-label {
            font-size: 0.8rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .wall-char-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }

        .override-badge {
            display: inline-block;
            background: #fef3c7;
            color: #92400e;
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        /* Prodotti tabs */
        .products-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .product-tab {
            padding: 0.75rem 1.25rem;
            border: none;
            background: transparent;
            color: #6b7280;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: all 0.2s;
        }

        .product-tab:hover {
            color: #10b981;
        }

        .product-tab.active {
            color: #10b981;
            border-bottom-color: #10b981;
        }

        .product-content {
            display: none;
        }

        .product-content.active {
            display: block;
        }

        /* BRM Box */
        .brm-box {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            border-radius: 12px;
            padding: 1.5rem;
            margin: 1rem 0;
        }

        .brm-title {
            font-size: 1rem;
            font-weight: 700;
            color: #10b981;
            margin-bottom: 1rem;
            text-align: center;
        }

        .brm-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        .brm-item {
            text-align: center;
        }

        .brm-label {
            font-size: 0.85rem;
            color: #6b7280;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .brm-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }

        /* Tag notes */
        .notes-tags {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .note-tag {
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .note-tag.urgente {
            background: #fee2e2;
            color: #991b1b;
        }

        .note-tag.verificare {
            background: #fef3c7;
            color: #92400e;
        }

        .note-tag.richiesta {
            background: #dbeafe;
            color: #1e40af;
        }

        .note-tag.problema {
            background: #fce7f3;
            color: #831843;
        }

        .notes-content {
            background: #f9fafb;
            padding: 1rem;
            border-radius: 8px;
            border-left: 3px solid #10b981;
        }

        /* Navigazione Posizioni */
        .position-navigation {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.5rem;
            background: #f9fafb;
            border-radius: 0 0 12px 12px;
        }

        .nav-btn-position {
            flex: 1;
            padding: 1rem;
            border: 2px solid #10b981;
            background: white;
            color: #10b981;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .nav-btn-position:hover:not(:disabled) {
            background: #10b981;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.25);
        }

        .nav-btn-position:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .positions-layout {
                flex-direction: column;
            }

            .positions-sidebar {
                width: 100%;
                max-height: none;
                position: relative;
                top: 0;
            }

            .brm-grid {
                grid-template-columns: 1fr;
            }

            .wall-chars-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ================================================================================
           PLACEHOLDER CONTENUTO BLOCCHI
           ================================================================================ */
        .placeholder {
            text-align: center;
            padding: 4rem 2rem;
            color: #718096;
        }

        .placeholder-icon {
            font-size: 5rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #4a5568;
        }

        .placeholder-text {
            font-size: 1rem;
            color: #718096;
        }

        /* ================================================================================
           SUBMENU BLOCCO UFFICIO
           ================================================================================ */
        .submenu-ufficio {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
            border-radius: 12px;
            border: 2px solid #d1fae5;
            position: sticky;
            top: 80px;
            z-index: 900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        /* Header Blocco Posa con bottone App - v7.29 */
        .blocco-posa-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
            border-radius: 12px;
            border: 2px solid #fb923c;
            margin-bottom: 1.5rem;
        }

        .blocco-posa-header h2 {
            margin: 0;
            color: #9a3412;
            font-size: 1.75rem;
            font-weight: 700;
        }

        .btn-posa-app {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.3);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-posa-app:hover {
            background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
        }

        .btn-posa-app:active {
            transform: translateY(0);
        }

        /* Submenu Posa - v7.20 */
        .submenu-posa {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            padding: 1rem;
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-radius: 12px;
            border: 2px solid #fbbf24;
            position: sticky;
            top: 80px;
            z-index: 900;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .submenu-btn-posa {
            padding: 1rem 1.75rem;
            border: 2px solid #fbbf24;
            background: white;
            color: #d97706;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }

        .submenu-btn-posa:hover {
            border-color: #f59e0b;
            color: #f59e0b;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(245, 158, 11, 0.2);
        }

        .submenu-btn-posa.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #f59e0b;
            box-shadow: 0 6px 16px rgba(245, 158, 11, 0.4);
            transform: scale(1.05);
        }

        .submenu-btn {
            padding: 1rem 1.75rem;
            border: 2px solid #d1fae5;
            background: white;
            color: #059669;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            flex: 1;
            min-width: 180px;
            text-align: center;
        }

        .submenu-btn:hover {
            border-color: #10b981;
            color: #10b981;
            transform: translateY(-3px);
            box-shadow: 0 6px 12px rgba(16, 185, 129, 0.2);
        }

        .submenu-btn.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
            transform: scale(1.05);
        }

        /* Vista Ufficio - Contenitori */
        .vista-ufficio {
            display: none !important;
        }

        .vista-ufficio.active {
            display: block !important;
            animation: fadeIn 0.3s ease-in;
        }

        /* Contenuto nascosto - v7.20 */
        .content-hidden {
            display: none !important;
        }

        /* ================================================================================
           SEZIONI VISTA GENERALE UFFICIO
           ================================================================================ */
        
        /* Card Ufficio con tema verde */
        .card-ufficio {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 1.5rem;
            border-left: 4px solid #10b981;
        }

        .card-ufficio-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            color: #1a202c;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .card-ufficio-icon {
            color: #10b981;
            font-size: 1.5rem;
        }

        /* Grid info cliente */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }

        .info-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .info-label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-value {
            font-size: 1rem;
            color: #1f2937;
            font-weight: 500;
        }

        .info-value-large {
            font-size: 1.1rem;
            font-weight: 600;
            color: #10b981;
        }

        /* Note progetto */
        .note-box {
            background: #f3f4f6;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 1rem;
            border-left: 3px solid #10b981;
        }

        .note-box-title {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
        }

        .note-box-content {
            font-size: 0.95rem;
            color: #4b5563;
            line-height: 1.6;
        }

        /* Totali commessa */
        .totali-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .totale-item {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-radius: 10px;
            padding: 1.25rem 1rem;
            text-align: center;
            border: 1px solid #a7f3d0;
        }

        .totale-numero {
            font-size: 2rem;
            font-weight: 700;
            color: #065f46;
            line-height: 1;
        }

        .totale-label {
            font-size: 0.85rem;
            color: #047857;
            margin-top: 0.5rem;
            font-weight: 600;
        }

        /* Riepilogo economico lista */
        .economico-list {
            background: #f9fafb;
            border-radius: 8px;
            padding: 1rem;
            border: 1px solid #e5e7eb;
        }
        
        .economico-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .economico-item:last-child {
            border-bottom: none;
        }
        
        .economico-item.totale {
            border-top: 2px solid #10b981;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-weight: 700;
            font-size: 1.1rem;
        }
        
        .economico-label {
            color: #4b5563;
            font-weight: 500;
        }
        
        .economico-item.totale .economico-label {
            color: #059669;
        }
        
        .economico-value {
            color: #1f2937;
            font-weight: 600;
            font-size: 1.05rem;
        }
        
        .economico-item.totale .economico-value {
            color: #059669;
            font-size: 1.25rem;
        }

        /* Timeline stato avanzamento */
        .timeline {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 3px solid #d1d5db;
        }

        .timeline-item.completed {
            background: #ecfdf5;
            border-left-color: #10b981;
        }

        .timeline-icon {
            font-size: 1.5rem;
            min-width: 40px;
            text-align: center;
        }

        .timeline-content {
            flex: 1;
        }

        .timeline-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .timeline-subtitle {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .timeline-percentage {
            font-size: 1.25rem;
            font-weight: 700;
            color: #10b981;
        }

        /* ================================================================================
           ALERT/NOTIFICHE
           ================================================================================ */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border-left: 4px solid #10b981;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border-left: 4px solid #ef4444;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }

        .alert-info {
            background: #dbeafe;
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }

        /* ================================================================================
           RESPONSIVE
           ================================================================================ */
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }

            .main-nav {
                width: 100%;
                flex-direction: column;
            }

            .nav-btn {
                width: 100%;
            }

            .container {
                padding: 0 1rem;
            }

            .card {
                padding: 1.5rem;
            }
        }

        /* ================================================================================
           LOADING SPINNER
           ================================================================================ */
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* ================================================================================
           KPI CARDS
           ================================================================================ */
        .kpi-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .kpi-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .kpi-card.green {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        .kpi-card.orange {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }

        .kpi-card.teal {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
        }

        .kpi-label {
            font-size: 0.85rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
        }

        .kpi-value {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .kpi-subtitle {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        /* ================================================================================
           FILTRI
           ================================================================================ */
        .filters-container {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            min-width: 150px;
        }

        .filter-group.search-group {
            flex: 1;
            min-width: 200px;
        }

        .filter-group label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #4a5568;
        }

        .filter-group select,
        .filter-group input {
            padding: 0.5rem;
            border: 1px solid #cbd5e0;
            border-radius: 6px;
            font-size: 0.95rem;
            background: white;
        }

        .filter-group select:focus,
        .filter-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* ================================================================================
           TABELLA
           ================================================================================ */
        .table-container {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .data-table thead {
            background: #f7fafc;
            border-bottom: 2px solid #e2e8f0;
        }

        .data-table th {
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .data-table th:hover {
            background: #edf2f7;
        }

        .data-table th.sortable::after {
            content: 'â‡…';
            margin-left: 0.5rem;
            opacity: 0.3;
        }

        .data-table th.sorted-asc::after {
            content: 'â†‘';
            opacity: 1;
        }

        .data-table th.sorted-desc::after {
            content: 'â†“';
            opacity: 1;
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e2e8f0;
        }

        .data-table tbody tr:hover {
            background: #f7fafc;
        }

        .product-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 0.25rem;
            margin-bottom: 0.25rem;
        }

        .product-badge.infisso {
            background: #dbeafe;
            color: #1e40af;
        }

        .product-badge.persiana {
            background: #d1fae5;
            color: #065f46;
        }

        .product-badge.tapparella {
            background: #fef3c7;
            color: #92400e;
        }

        .product-badge.zanzariera {
            background: #e0e7ff;
            color: #3730a3;
        }

        .product-badge.cassonetto {
            background: #fed7aa;
            color: #92400e;
        }

        .empty-state {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        /* ================================================================================
           VISTA AZIENDE - STILI
           ================================================================================ */
        .aziende-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .azienda-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 2px solid transparent;
            transition: all 0.2s;
        }

        .azienda-card:hover {
            box-shadow: 0 4px 16px rgba(0,0,0,0.12);
            border-color: #10b981;
        }

        .azienda-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb;
        }

        .azienda-header-left {
            flex: 1;
        }

        .azienda-name {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .azienda-name-icon {
            font-size: 1.75rem;
        }

        .azienda-stats {
            display: flex;
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .azienda-stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #6b7280;
            font-size: 0.95rem;
        }

        .azienda-stat-value {
            font-weight: 600;
            color: #10b981;
        }

        .azienda-badges {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .azienda-badge {
            display: inline-block;
            padding: 0.4rem 0.8rem;
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            background: #ecfdf5;
            color: #059669;
        }

        .azienda-badge.infissi { background: #dbeafe; color: #1e40af; }
        .azienda-badge.tapparelle { background: #fef3c7; color: #92400e; }
        .azienda-badge.persiane { background: #f3e8ff; color: #6b21a8; }
        .azienda-badge.cassonetti { background: #fce7f3; color: #9f1239; }
        .azienda-badge.zanzariere { background: #ecfccb; color: #3f6212; }

        /* ===================================== */
        /* NUOVI STILI: TAB ORIZZONTALI AZIENDE */
        /* ===================================== */
        
        .aziende-tabs-container {
            margin-bottom: 2rem;
            background: white;
            border-radius: 12px;
            padding: 1rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }

        .aziende-tabs {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .azienda-tab {
            flex: 1;
            min-width: 180px;
            max-width: 250px;
            background: linear-gradient(135deg, #f9fafb 0%, #f3f4f6 100%);
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 1.25rem 1rem;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: flex;
            align-items: center;
            gap: 1rem;
            position: relative;
            overflow: hidden;
        }

        .azienda-tab:before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #10b981, #059669);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .azienda-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: #10b981;
        }

        .azienda-tab.active {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border-color: #10b981;
            box-shadow: 0 4px 16px rgba(16, 185, 129, 0.2);
            transform: translateY(-2px);
        }

        .azienda-tab.active:before {
            transform: scaleX(1);
        }

        .azienda-tab-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }

        .azienda-tab-content {
            flex: 1;
            min-width: 0;
        }

        .azienda-tab-name {
            font-size: 1rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.25rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .azienda-tab.active .azienda-tab-name {
            color: #059669;
        }

        .azienda-tab-count {
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
        }

        .azienda-tab.active .azienda-tab-count {
            color: #047857;
        }

        .aziende-details-container {
            position: relative;
        }

        .azienda-details {
            display: none;
            animation: fadeInUp 0.4s ease;
        }

        .azienda-details.active {
            display: block;
        }

        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Responsive: Stack tabs verticalmente su mobile */
        @media (max-width: 768px) {
            .aziende-tabs {
                flex-direction: column;
            }
            
            .azienda-tab {
                max-width: 100%;
            }
        }

        /* Tabella prodotti azienda */
        .azienda-prodotti-table {
            width: 100%;
            border-collapse: collapse;
            margin: 1.5rem 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .azienda-prodotti-table thead {
            background: #f9fafb;
        }

        .azienda-prodotti-table th {
            padding: 1rem;
            text-align: left;
            font-size: 0.85rem;
            font-weight: 600;
            color: #6b7280;
            text-transform: uppercase;
            border-bottom: 2px solid #e5e7eb;
        }

        .azienda-prodotti-table td {
            padding: 1rem;
            color: #374151;
            border-bottom: 1px solid #f3f4f6;
        }

        .azienda-prodotti-table tbody tr:hover {
            background: #f9fafb;
        }

        .azienda-prodotti-table tbody tr:last-child td {
            border-bottom: none;
        }

        .product-type-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 4px;
            font-size: 0.85rem;
            font-weight: 600;
            white-space: nowrap;
        }

        .product-type-badge.infisso { background: #dbeafe; color: #1e40af; }
        .product-type-badge.tapparella { background: #fef3c7; color: #92400e; }
        .product-type-badge.persiana { background: #f3e8ff; color: #6b21a8; }
        .product-type-badge.cassonetto { background: #fce7f3; color: #9f1239; }
        .product-type-badge.zanzariera { background: #ecfccb; color: #3f6212; }

        .product-positions {
            display: flex;
            gap: 0.4rem;
            flex-wrap: wrap;
        }

        .position-tag {
            display: inline-block;
            background: #e5e7eb;
            color: #4b5563;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        /* âŒ RIMOSSO v7.20: CSS Totali azienda (non piÃ¹ utilizzati) */

        /* Azioni azienda */
        .azienda-actions {
            display: flex;
            gap: 0.75rem;
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #e5e7eb;
        }

        .azienda-action-btn {
            padding: 0.75rem 1.5rem;
            border: 2px solid #10b981;
            background: white;
            color: #10b981;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .azienda-action-btn:hover {
            background: #10b981;
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(16,185,129,0.2);
        }

        .azienda-action-btn.primary {
            background: #10b981;
            color: white;
        }

        .azienda-action-btn.primary:hover {
            background: #059669;
        }

        /* Note fornitore */
        .azienda-note {
            background: #fffbeb;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .azienda-note-title {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .azienda-note-content {
            color: #78350f;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .azienda-note textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            font-family: inherit;
            font-size: 0.9rem;
            resize: vertical;
            min-height: 80px;
        }

        .azienda-note textarea:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16,185,129,0.1);
        }

        /* ================================================================================
           VISTA PREVENTIVO - TABELLA STILE EXCEL
           ================================================================================ */
        
        .excel-container {
            width: 100%;
            overflow-x: auto;
            background: white;
        }

        .excel-table {
            width: 100%;
            border-collapse: collapse;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.875rem;
            background: white;
        }

        .excel-table thead {
            background: #1e3a8a;
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .excel-table th {
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-weight: 600;
            border: 1px solid #dbeafe;
            white-space: nowrap;
        }

        .excel-table td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid #e5e7eb;
            background: white;
        }

        .excel-table tbody tr:hover {
            background: #f0f9ff;
        }

        .excel-table tbody tr:nth-child(even) {
            background: #f9fafb;
        }

        .excel-table tbody tr:nth-child(even):hover {
            background: #f0f9ff;
        }

        /* Colonne specifiche */
        .excel-col-narrow {
            min-width: 60px;
            max-width: 80px;
        }

        .excel-col-medium {
            min-width: 100px;
            max-width: 150px;
        }

        .excel-col-wide {
            min-width: 120px;
        }

        /* Righe totali */
        .excel-total-row {
            background: #dbeafe !important;
            font-weight: 700;
        }

        .excel-total-row:hover {
            background: #bfdbfe !important;
        }

        .excel-total-value {
            background: #dbeafe !important;
            color: #1e40af;
            font-weight: 700;
            font-size: 1rem;
        }

        .excel-subtotal-row {
            background: #fef3c7 !important;
            font-weight: 700;
        }

        .excel-subtotal-row:hover {
            background: #fde68a !important;
        }

        .excel-subtotal-value {
            background: #fef3c7 !important;
            color: #92400e;
            font-weight: 700;
            font-size: 1rem;
        }

        .excel-grand-total-row {
            background: #10b981 !important;
            color: white !important;
        }

        .excel-grand-total-row:hover {
            background: #059669 !important;
        }

        .excel-grand-total-value {
            background: #10b981 !important;
            color: white !important;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .excel-row {
            background: white;
        }

        .excel-value {
            font-weight: 600;
            color: #374151;
        }

        /* Pulsanti azioni */
        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            background: #e5e7eb;
            color: #374151;
        }

        .btn:hover {
            background: #d1d5db;
            transform: translateY(-1px);
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1);
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        /* ================================================================================
           BLOCCO POSA - VISTA GENERALE CANTIERE
           ================================================================================ */
        
        .cantiere-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .cantiere-section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #f59e0b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .materials-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .material-category {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            border-radius: 8px;
            padding: 1rem;
        }

        .material-category-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .material-item {
            background: white;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 6px;
            font-size: 0.95rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .material-item strong {
            color: #92400e;
            display: block;
            margin-bottom: 0.25rem;
        }

        .tools-checklist {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .tool-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem;
            background: #fef3c7;
            border-radius: 6px;
            font-size: 0.95rem;
        }

        .tool-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .mounting-order {
            margin-top: 1rem;
        }

        .order-step {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .order-step-number {
            display: inline-block;
            width: 32px;
            height: 32px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 32px;
            font-weight: 700;
            margin-right: 0.75rem;
        }

        .preparation-checklist {
            margin-top: 1rem;
        }

        .checklist-group {
            margin: 1rem 0;
        }

        .checklist-group-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.75rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: white;
            margin: 0.5rem 0;
            border-radius: 6px;
            border: 2px solid #fde68a;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .checklist-item:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }

        .checklist-item input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
        }

        .checklist-item.checked {
            background: #d1fae5;
            border-color: #10b981;
            opacity: 0.7;
        }

        .logistics-info {
            background: #fef3c7;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .logistics-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem 0;
            border-bottom: 1px solid #fde68a;
        }

        .logistics-item:last-child {
            border-bottom: none;
        }

        .logistics-label {
            font-weight: 600;
            color: #92400e;
            min-width: 150px;
        }

        .logistics-value {
            color: #1f2937;
        }

        /* ================================================================================
           BLOCCO POSA - VISTA POSIZIONI CANTIERE
           ================================================================================ */
        
        .posa-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .posa-header {
            background: white;
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .posa-position-info {
            flex: 1;
        }

        .posa-position-id {
            font-size: 1.8rem;
            font-weight: 700;
            color: #f59e0b;
            margin-bottom: 0.25rem;
        }

        .posa-position-location {
            font-size: 1.1rem;
            color: #6b7280;
        }

        .posa-navigation {
            display: flex;
            gap: 0.75rem;
        }

        .nav-btn-large {
            padding: 1rem 2rem;
            font-size: 1.2rem;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            min-width: 120px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .nav-btn-large.prev {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }

        .nav-btn-large.next {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .nav-btn-large:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }

        .nav-btn-large:active {
            transform: translateY(0);
        }

        .nav-btn-large:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* MISURE BRM GRANDI E CHIARE */
        .brm-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .brm-box-large {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 4px solid #f59e0b;
            border-radius: 12px;
            padding: 2rem;
            margin: 1rem 0;
            text-align: center;
        }

        .brm-product-title {
            font-size: 1.4rem;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 1.5rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .brm-measurements {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            margin-top: 1rem;
        }

        .brm-measure {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .brm-label {
            font-size: 1.2rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 0.5rem;
        }

        .brm-value {
            font-size: 2.5rem;
            font-weight: 700;
            color: #f59e0b;
            font-family: 'Courier New', monospace;
        }

        .brm-unit {
            font-size: 1.5rem;
            color: #9ca3af;
            margin-left: 0.5rem;
        }

        /* CARATTERISTICHE MURO */
        .muro-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .muro-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .muro-item {
            background: #fef3c7;
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .muro-label {
            font-size: 0.95rem;
            font-weight: 600;
            color: #92400e;
            margin-bottom: 0.5rem;
        }

        .muro-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1f2937;
        }

        /* ISTRUZIONI MONTAGGIO */
        .instructions-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .instruction-step {
            background: linear-gradient(135deg, #ffffff 0%, #fef3c7 100%);
            border-left: 5px solid #f59e0b;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            transition: all 0.2s;
        }

        .instruction-step:hover {
            box-shadow: 0 4px 12px rgba(245,158,11,0.2);
            transform: translateX(4px);
        }

        .step-number {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 48px;
            height: 48px;
            background: #f59e0b;
            color: white;
            border-radius: 50%;
            font-size: 1.5rem;
            font-weight: 700;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }

        .step-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #92400e;
            margin-bottom: 1rem;
        }

        .step-tasks {
            list-style: none;
            margin-left: 1rem;
        }

        .step-task {
            padding: 0.5rem 0;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            font-size: 1rem;
        }

        .step-task input[type="checkbox"] {
            margin-top: 0.25rem;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        /* MATERIALI SPECIFICI POSIZIONE */
        .materials-list {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .material-list-item {
            background: #fef3c7;
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
            font-size: 1rem;
        }

        /* NOTE E ALERT */
        .notes-alerts-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .alert-item {
            padding: 1rem;
            margin: 0.75rem 0;
            border-radius: 8px;
            border-left: 4px solid;
            font-size: 1rem;
        }

        .alert-item.warning {
            background: #fef3c7;
            border-color: #f59e0b;
            color: #92400e;
        }

        .alert-item.info {
            background: #dbeafe;
            border-color: #3b82f6;
            color: #1e40af;
        }

        .alert-item.tip {
            background: #d1fae5;
            border-color: #10b981;
            color: #065f46;
        }

        /* CHECKLIST OPERAZIONI FINALI */
        .final-checklist-section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .final-checklist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: #fef3c7;
            margin: 0.75rem 0;
            border-radius: 8px;
            border: 2px solid #fde68a;
            font-size: 1.1rem;
            transition: all 0.2s;
        }

        .final-checklist-item:hover {
            border-color: #f59e0b;
            background: #fef3c7;
        }

        .final-checklist-item input[type="checkbox"] {
            width: 28px;
            height: 28px;
            cursor: pointer;
        }

        .final-checklist-item.checked {
            background: #d1fae5;
            border-color: #10b981;
        }

        /* FULLSCREEN MODE */
        .fullscreen-toggle {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            padding: 1rem;
            background: #f59e0b;
            color: white;
            border: none;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            transition: all 0.2s;
            z-index: 999;
        }

        .fullscreen-toggle:hover {
            background: #d97706;
            transform: scale(1.1);
        }

        /* RESPONSIVE - MOBILE FIRST */
        @media (max-width: 768px) {
            .brm-measurements {
                grid-template-columns: 1fr;
            }

            .brm-value {
                font-size: 2rem;
            }

            .nav-btn-large {
                padding: 0.75rem 1.5rem;
                font-size: 1rem;
                min-width: 100px;
            }

            .posa-position-id {
                font-size: 1.5rem;
            }

            .materials-grid {
                grid-template-columns: 1fr;
            }

            .muro-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* ================================================================================
           MODAL PREVENTIVO - STILI
           ================================================================================ */
        .preventivo-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }
        
        .preventivo-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .preventivo-modal {
            background: white;
            border-radius: 16px;
            max-width: 900px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        
        .preventivo-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preventivo-modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .preventivo-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preventivo-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .preventivo-modal-body {
            padding: 2rem;
        }
        
        .preventivo-info-progetto {
            background: #f8fafc;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid #667eea;
        }
        
        .preventivo-info-progetto h3 {
            margin: 0 0 0.5rem 0;
            color: #1e293b;
            font-size: 1.25rem;
        }
        
        .preventivo-info-progetto p {
            margin: 0.25rem 0;
            color: #64748b;
        }
        
        .preventivo-prodotti-lista {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .preventivo-prodotto-card {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.2s;
        }
        
        .preventivo-prodotto-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }
        
        .preventivo-prodotto-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .preventivo-prodotto-info h4 {
            margin: 0 0 0.25rem 0;
            color: #1e293b;
            font-size: 1.1rem;
        }
        
        .preventivo-prodotto-info p {
            margin: 0;
            color: #64748b;
            font-size: 0.9rem;
        }
        
        .preventivo-prodotto-prezzo {
            text-align: right;
        }
        
        .preventivo-prezzo-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .preventivo-prezzo-valore {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .preventivo-prodotto-dettagli {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }
        
        .preventivo-dettaglio-item {
            background: #f8fafc;
            padding: 0.75rem;
            border-radius: 8px;
        }
        
        .preventivo-dettaglio-label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.25rem;
        }
        
        .preventivo-dettaglio-valore {
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .preventivo-totale-section {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 1.5rem;
        }
        
        .preventivo-totale-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0;
        }
        
        .preventivo-totale-row.finale {
            border-top: 2px solid #cbd5e1;
            padding-top: 1rem;
            margin-top: 0.5rem;
        }
        
        .preventivo-totale-label {
            font-size: 1rem;
            color: #475569;
        }
        
        .preventivo-totale-label.finale {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }
        
        .preventivo-totale-valore {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .preventivo-totale-valore.finale {
            font-size: 1.75rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .preventivo-modal-actions {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 2px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }
        
        .preventivo-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .preventivo-btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .preventivo-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .preventivo-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .preventivo-btn-secondary:hover {
            background: #cbd5e1;
        }
        
        .preventivo-placeholder {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .preventivo-placeholder-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }
        
        .preventivo-placeholder-text {
            color: #64748b;
            font-size: 1.1rem;
            line-height: 1.6;
        }
        
        .preventivo-loading {
            text-align: center;
            padding: 3rem 2rem;
        }
        
        .preventivo-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid #e2e8f0;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Modal Preventivo Overlay */
        .preventivo-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s;
        }
        
        .preventivo-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }
        
        .preventivo-modal-large {
            max-width: 1200px;
        }
        
        .preventivo-modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .preventivo-modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .preventivo-modal-subtitle {
            font-size: 1rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .preventivo-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .preventivo-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .preventivo-warning {
            margin: 2rem;
            padding: 2rem;
            background: #fef3c7;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            display: flex;
            gap: 1.5rem;
            align-items: flex-start;
        }
        
        .preventivo-warning-icon {
            font-size: 3rem;
            flex-shrink: 0;
        }
        
        .preventivo-warning-text {
            flex: 1;
        }
        
        .preventivo-warning-text p {
            margin: 0.5rem 0;
            color: #78350f;
            line-height: 1.6;
        }
        
        .preventivo-cliente-info {
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .preventivo-info-item {
            display: flex;
            gap: 0.5rem;
        }
        
        .preventivo-info-label {
            font-weight: 600;
            color: #64748b;
        }
        
        .preventivo-info-value {
            color: #1e293b;
        }
        
        .preventivo-warnings-list {
            margin: 1.5rem 2rem;
            padding: 1rem;
            background: #fef3c7;
            border-left: 4px solid #fbbf24;
            border-radius: 8px;
        }
        
        .preventivo-warnings-title {
            font-weight: 700;
            color: #78350f;
            margin-bottom: 0.5rem;
        }
        
        .preventivo-warning-item {
            color: #78350f;
            font-size: 0.9rem;
            padding: 0.25rem 0;
        }
        
        .preventivo-table-container {
            padding: 2rem;
            overflow-x: auto;
        }
        
        .preventivo-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preventivo-table th {
            background: #f1f5f9;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #475569;
            border-bottom: 2px solid #cbd5e1;
            font-size: 0.9rem;
        }
        
        .preventivo-table td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
            color: #1e293b;
        }
        
        .preventivo-table tbody tr:hover {
            background: #f8fafc;
        }
        
        .voce-tipo-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.85rem;
            font-weight: 600;
            display: inline-block;
        }
        
        .voce-tipo-badge.infisso {
            background: #dbeafe;
            color: #1e40af;
        }
        
        .voce-tipo-badge.zanzariera {
            background: #d1fae5;
            color: #065f46;
        }
        
        .voce-tipo-badge.persiana {
            background: #fef3c7;
            color: #78350f;
        }
        
        .voce-tipo-badge.tapparella {
            background: #fce7f3;
            color: #9f1239;
        }
        
        .voce-tipo-badge.cassonetto {
            background: #e0e7ff;
            color: #3730a3;
        }
        
        .preventivo-totali {
            margin: 0 2rem 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border-radius: 12px;
        }
        
        .preventivo-totale-row {
            display: flex;
            justify-content: space-between;
            padding: 0.75rem 0;
            font-size: 1rem;
            color: #475569;
        }
        
        .preventivo-totale-row.subtotale {
            border-top: 1px solid #cbd5e1;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .preventivo-totale-row.finale {
            border-top: 2px solid #10b981;
            margin-top: 0.5rem;
            padding-top: 1rem;
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }
        
        .btn-preventivo {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-preventivo.btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-preventivo.btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }
        
        .btn-preventivo.btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .btn-preventivo.btn-secondary:hover {
            background: #cbd5e1;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ================================================================================
           WIZARD COMPLETAMENTO DATI
           ================================================================================ */
        .wizard-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10001;
            backdrop-filter: blur(4px);
            animation: fadeIn 0.2s;
        }
        
        .wizard-container {
            background: white;
            border-radius: 16px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s;
        }
        
        .wizard-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            position: relative;
        }
        
        .wizard-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .wizard-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin-top: 0.5rem;
        }
        
        .wizard-close {
            position: absolute;
            top: 1.5rem;
            right: 1.5rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wizard-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        .wizard-body {
            padding: 2rem;
        }
        
        .wizard-info-box {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .wizard-info-row {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
        }
        
        .wizard-info-label {
            font-weight: 600;
            color: #64748b;
        }
        
        .wizard-info-value {
            font-weight: 700;
            color: #1e293b;
        }
        
        .wizard-analysis {
            margin: 2rem 0;
        }
        
        .wizard-stat {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .wizard-stat.success {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        
        .wizard-stat.warning {
            background: #fef3c7;
            border: 2px solid #f59e0b;
        }
        
        .wizard-stat-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .wizard-stat-text {
            flex: 1;
            font-size: 1rem;
            font-weight: 600;
            color: #1e293b;
        }
        
        .wizard-message {
            background: #e0e7ff;
            border-left: 4px solid #6366f1;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
        }
        
        .wizard-message p {
            margin: 0.5rem 0;
            line-height: 1.6;
        }
        
        .wizard-section {
            margin: 2rem 0;
        }
        
        .wizard-section-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 1rem;
        }
        
        .wizard-list {
            list-style: none;
            padding: 0;
            background: #f8fafc;
            border-radius: 8px;
            padding: 1rem 1.5rem;
        }
        
        .wizard-list li {
            padding: 0.5rem 0;
            color: #475569;
        }
        
        .wizard-misure-disponibili {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        
        .wizard-misura-badge {
            background: #d1fae5;
            color: #065f46;
            padding: 0.5rem 1rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
        }
        
        .wizard-warning-text {
            color: #ef4444;
            font-style: italic;
        }
        
        .wizard-radio-group {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .wizard-radio {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wizard-radio:hover {
            background: #f1f5f9;
            border-color: #cbd5e1;
        }
        
        .wizard-radio input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
        
        .wizard-radio input[type="radio"]:checked + .wizard-radio-label {
            font-weight: 700;
            color: #6366f1;
        }
        
        .wizard-radio-label {
            flex: 1;
            font-size: 1rem;
        }
        
        .wizard-corrections {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .wizard-correction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .wizard-label {
            font-weight: 600;
            min-width: 100px;
        }
        
        .wizard-input-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .wizard-input-group input[type="number"],
        .wizard-input-group input[type="text"] {
            padding: 0.5rem;
            border: 2px solid #e2e8f0;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .wizard-btn-mini {
            padding: 0.5rem 1rem;
            background: #e2e8f0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .wizard-btn-mini:hover {
            background: #cbd5e1;
        }
        
        .wizard-unit {
            color: #64748b;
            font-weight: 600;
        }
        
        .wizard-example {
            background: #fef3c7;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
            font-size: 0.95rem;
        }
        
        .wizard-preview {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 1.5rem;
            min-height: 100px;
        }
        
        .wizard-loading {
            text-align: center;
            color: #64748b;
            font-style: italic;
        }
        
        .wizard-summary {
            margin: 2rem 0;
        }
        
        .wizard-summary-item {
            display: flex;
            gap: 1rem;
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .wizard-summary-item.success {
            background: #d1fae5;
            border: 2px solid #10b981;
        }
        
        .wizard-summary-icon {
            font-size: 2rem;
            flex-shrink: 0;
        }
        
        .wizard-summary-text {
            flex: 1;
        }
        
        .wizard-summary-text strong {
            display: block;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }
        
        .wizard-summary-section {
            background: #f8fafc;
            padding: 1rem;
            border-radius: 8px;
            margin-top: 1rem;
        }
        
        .wizard-summary-section h4 {
            margin: 0 0 0.75rem 0;
            color: #1e293b;
        }
        
        .wizard-summary-section ul {
            list-style: none;
            padding: 0;
        }
        
        .wizard-summary-section li {
            padding: 0.25rem 0;
            color: #475569;
        }
        
        .wizard-footer {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 2px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }
        
        .wizard-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .wizard-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .wizard-btn-secondary:hover {
            background: #cbd5e1;
        }
        
        .wizard-btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .wizard-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        /* ================================================================================
           MODAL SCELTA BRM
           ================================================================================ */
        .brm-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 10001;
            animation: fadeIn 0.3s ease;
        }
        
        .brm-modal-overlay.active {
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 2rem;
        }
        
        .brm-modal {
            background: white;
            border-radius: 16px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }
        
        .brm-modal-header {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            padding: 1.5rem 2rem;
            border-radius: 16px 16px 0 0;
        }
        
        .brm-modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin: 0 0 0.5rem 0;
        }
        
        .brm-modal-subtitle {
            font-size: 0.95rem;
            opacity: 0.9;
            margin: 0;
        }
        
        .brm-modal-body {
            padding: 2rem;
        }
        
        .brm-alert {
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
        }
        
        .brm-alert-text {
            color: #92400e;
            font-size: 0.95rem;
            line-height: 1.6;
        }
        
        .brm-section {
            margin-bottom: 2rem;
        }
        
        .brm-section-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .brm-section-icon {
            font-size: 1.3rem;
        }
        
        .brm-options {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .brm-option {
            display: flex;
            align-items: center;
            padding: 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .brm-option:hover {
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .brm-option.selected {
            border-color: #f59e0b;
            background: #fef3c7;
        }
        
        .brm-option-radio {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #cbd5e1;
            margin-right: 1rem;
            position: relative;
            transition: all 0.2s;
        }
        
        .brm-option.selected .brm-option-radio {
            border-color: #f59e0b;
        }
        
        .brm-option.selected .brm-option-radio::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #f59e0b;
        }
        
        .brm-option-content {
            flex: 1;
        }
        
        .brm-option-label {
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 0.25rem;
        }
        
        .brm-option-value {
            font-size: 1.1rem;
            color: #f59e0b;
            font-weight: 700;
        }
        
        .brm-option-unit {
            font-size: 0.9rem;
            color: #64748b;
            margin-left: 0.25rem;
        }
        
        .brm-option-input {
            display: none;
            margin-top: 0.75rem;
        }
        
        .brm-option-input.active {
            display: block;
        }
        
        .brm-input-label {
            display: block;
            font-size: 0.9rem;
            color: #64748b;
            margin-bottom: 0.5rem;
        }
        
        .brm-input-field {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.2s;
        }
        
        .brm-input-field:focus {
            outline: none;
            border-color: #f59e0b;
            background: #fffbeb;
        }
        
        .brm-modal-actions {
            display: flex;
            gap: 1rem;
            padding: 1.5rem 2rem;
            border-top: 2px solid #f1f5f9;
            background: #f8fafc;
            border-radius: 0 0 16px 16px;
        }
        
        .brm-btn {
            flex: 1;
            padding: 1rem 2rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .brm-btn-primary {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .brm-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 158, 11, 0.4);
        }
        
        .brm-btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .brm-btn-secondary {
            background: #e2e8f0;
            color: #475569;
        }
        
        .brm-btn-secondary:hover {
            background: #cbd5e1;
        }
        
        
        /* ================================================================
           SIDEBAR MENU LATERALE
           ================================================================ */
        .sidebar-menu {
            position: fixed;
            top: 0;
            left: -320px;
            width: 320px;
            height: 100vh;
            background: white;
            box-shadow: 2px 0 12px rgba(0,0,0,0.15);
            transition: left 0.3s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        
        .sidebar-menu.open {
            left: 0;
        }
        
        .sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .sidebar-header h3 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 700;
        }
        
        .close-btn {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
            line-height: 1;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .close-btn:hover {
            background: rgba(255,255,255,0.2);
        }
        
        .sidebar-content {
            padding: 1rem 0;
        }
        
        .sidebar-item {
            display: flex;
            align-items: center;
            padding: 0.875rem 1.5rem;
            color: #374151;
            text-decoration: none;
            transition: all 0.2s;
            cursor: pointer;
            font-weight: 500;
        }
        
        .sidebar-item:hover {
            background: #f3f4f6;
            color: #667eea;
        }
        
        .sidebar-item span:first-child {
            margin-right: 0.75rem;
            font-size: 1.25rem;
        }
        
        .sidebar-expandable {
            cursor: pointer;
        }
        
        .sidebar-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
        }
        
        .expand-icon {
            transition: transform 0.3s;
            font-size: 0.875rem;
            color: #9ca3af;
        }
        
        .sidebar-expandable.expanded .expand-icon {
            transform: rotate(180deg);
        }
        
        .sidebar-submenu {
            background: #f9fafb;
            border-left: 3px solid #667eea;
            margin-left: 1.5rem;
        }
        
        .sidebar-submenu a {
            display: block;
            padding: 0.75rem 1.5rem;
            color: #6b7280;
            text-decoration: none;
            font-size: 0.9375rem;
            transition: all 0.2s;
        }
        
        .sidebar-submenu a:hover {
            background: white;
            color: #667eea;
            padding-left: 2rem;
        }
        
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sidebar-overlay.active {
            display: block;
            opacity: 1;
        }
        
        /* Bottoni action nel menu laterale */
        .sidebar-action-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            margin: 0.5rem 1rem;
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 600;
            font-size: 0.9375rem;
            cursor: pointer;
            transition: all 0.2s;
            text-decoration: none;
        }
        
        .sidebar-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }
        
        .sidebar-action-btn.import {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .sidebar-action-btn.github {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }
        
        .sidebar-action-btn.settings {
            background: #718096;
        }
        
        .sidebar-action-btn span:first-child {
            margin-right: 0.5rem;
        }
        
        /* ================================================================================
           âœ… CONFERMA CLIENTE v7.28 - CSS
           ================================================================================ */
        
        /* Modal Conferma Cliente Overlay */
        #conferma-modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            overflow-y: auto;
            padding: 2rem 0;
        }
        
        #conferma-modal-overlay.active {
            display: block;
        }
        
        .conferma-modal-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }
        
        .conferma-modal-header {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .conferma-modal-title {
            font-size: 1.75rem;
            font-weight: 700;
            margin: 0;
        }
        
        .conferma-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 2rem;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .conferma-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: rotate(90deg);
        }
        
        /* Toolbar Quick Actions */
        .conferma-toolbar {
            display: flex;
            gap: 15px;
            align-items: center;
            flex-wrap: wrap;
            padding: 20px;
            background: #f8fafc;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .conferma-toolbar button {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.95rem;
            /* FIX iPad/Touch */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        
        .conferma-toolbar .btn-settings {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
        }
        
        .conferma-toolbar .btn-settings:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.4);
        }
        
        .conferma-toolbar .btn-export {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .conferma-toolbar .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .quick-toggle {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 0.6rem 1rem;
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 500;
        }
        
        .quick-toggle:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }
        
        .quick-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Documento Conferma */
        .conferma-content {
            padding: 30px;
        }
        
        .conferma-page {
            background: white;
            padding: 30px;
            margin-bottom: 30px;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }
        
        .conferma-page h2 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 12px;
            margin: 20px 0;
            font-size: 1.5rem;
        }
        
        .conferma-page h3 {
            color: #1e40af;
            margin: 20px 0 12px 0;
            font-size: 1.2rem;
        }
        
        .sezione-misure,
        .sezione-infisso,
        .sezione-persiana,
        .sezione-tapparella,
        .sezione-zanzariera,
        .sezione-cassonetto,
        .sezione-prezzi,
        .sezione-note {
            margin: 20px 0;
            padding: 18px;
            background: #f9fafb;
            border-left: 4px solid #3b82f6;
            border-radius: 4px;
        }
        
        .sezione-prezzi {
            border-left-color: #10b981;
            background: #f0fdf4;
        }
        
        .sezione-note {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .sezione-misure p,
        .sezione-infisso p,
        .sezione-persiana p,
        .sezione-tapparella p,
        .sezione-zanzariera p,
        .sezione-cassonetto p,
        .sezione-prezzi p,
        .sezione-note p {
            margin: 8px 0;
            color: #1e293b;
            line-height: 1.6;
        }
        
        .sezione-misure strong,
        .sezione-infisso strong,
        .sezione-persiana strong,
        .sezione-tapparella strong,
        .sezione-zanzariera strong,
        .sezione-cassonetto strong,
        .sezione-prezzi strong {
            color: #0f172a;
            font-weight: 600;
        }
        
        .campo-prezzo-editabile {
            margin-top: 12px;
            padding: 12px;
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            min-height: 50px;
            color: #64748b;
            font-style: italic;
        }
        
        /* Modal Impostazioni Colonne */
        #modal-impostazioni-conferma {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10001;
            align-items: center;
            justify-content: center;
        }
        
        #modal-impostazioni-conferma.active {
            display: flex;
        }
        
        .modal-impostazioni-content {
            background: white;
            border-radius: 16px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
        }
        
        .modal-impostazioni-header {
            background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            color: white;
            padding: 2rem;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-impostazioni-header h2 {
            margin: 0;
            font-size: 1.5rem;
        }
        
        .modal-impostazioni-body {
            padding: 2rem;
        }
        
        .settings-section {
            margin: 25px 0;
            padding: 20px;
            background: #f9fafb;
            border-radius: 12px;
            border: 1px solid #e5e7eb;
        }
        
        .settings-section h3 {
            color: #1e40af;
            margin: 0 0 15px 0;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .settings-section label {
            display: block;
            margin: 10px 0;
            cursor: pointer;
            padding: 8px 12px;
            background: white;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .settings-section label:hover {
            background: #eff6ff;
            transform: translateX(4px);
        }
        
        .settings-section label input {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .modal-impostazioni-actions {
            display: flex;
            gap: 15px;
            padding: 1.5rem 2rem;
            background: #f8fafc;
            border-top: 2px solid #e2e8f0;
            border-radius: 0 0 16px 16px;
        }
        
        .modal-impostazioni-actions button {
            flex: 1;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 1rem;
            /* FIX iPad/Touch */
            touch-action: manipulation;
            -webkit-tap-highlight-color: rgba(0, 0, 0, 0.1);
            user-select: none;
            -webkit-user-select: none;
        }
        
        .btn-salva {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .btn-salva:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }
        
        .btn-reset {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
        }
        
        .btn-reset:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 158, 11, 0.4);
        }
        
        .btn-chiudi {
            background: #e5e7eb;
            color: #374151;
        }
        
        .btn-chiudi:hover {
            background: #d1d5db;
        }
        
        /* Page break per stampa PDF */
        @media print {
            .conferma-toolbar {
                display: none !important;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            .conferma-page {
                border: none;
                margin: 0;
                padding: 20px;
            }
            
            @page {
                size: A4;
                margin: 2cm;
            }
        }
        
        /* === TAB ANALISI COSTI === */
        .tab-analisi {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-analisi:hover {
            background: #f3f4f6;
            color: #374151;
            transform: translateY(-2px);
        }
        
        .tab-analisi.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border-color: #10b981;
            box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3);
        }
        
        .tab-content-analisi {
            animation: fadeIn 0.3s ease-in;
        }
        
        /* === TAB LISTINI === */
        .tab-listini {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab-listini:hover {
            background: #f3f4f6;
            color: #374151;
            transform: translateY(-2px);
        }
        
        .tab-listini.active {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
            color: white;
            border-color: #f59e0b;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.3);
        }
        
        .tab-content-listini {
            animation: fadeIn 0.3s ease-in;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .modello-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
            transition: all 0.2s;
        }
        
        .modello-card:hover {
            border-color: #f59e0b;
            box-shadow: 0 4px 6px rgba(245, 158, 11, 0.1);
            transform: translateX(4px);
        }
        
        .modello-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
        }
        
        .modello-nome {
            font-weight: 700;
            font-size: 1.125rem;
            color: #1f2937;
        }
        
        .modello-badge {
            background: #fef3c7;
            color: #92400e;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .dimensioni-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 0.5rem;
            margin-top: 0.75rem;
        }
        
        .dimensione-item {
            background: #f9fafb;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            display: flex;
            justify-content: space-between;
        }
        
        .dimensione-size {
            color: #4b5563;
            font-weight: 500;
        }
        
        .dimensione-price {
            color: #059669;
            font-weight: 700;
        }
    </style>
    
    <!-- ================================================================================
         SISTEMA PREVENTIVAZIONE - Moduli JS
         ================================================================================ -->
    <script>

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ DATABASE MANIGLIE FINSTRAL - v7.26
        // Integrato da MANIGLIE-FINSTRAL-DB.js
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ğŸ”§ DATABASE MANIGLIE FINSTRAL - Estratto da catalogo EUR 2025/3
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

const MANIGLIE_FINSTRAL = {
    
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // COLORI DISPONIBILI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    colori: {
        "01": "bianco",
        "07": "bianco perla",
        "56": "neutro anodizzato",
        "79": "colore titanio",
        "74": "colore bronzo",
        "40": "ottone lucido",
        "0156": "interno bianco",
        "0174": "esterno neutro / colore bronzo",
        "M01": "bianco opaco",
        "M03": "nero opaco",
        "M07": "bianco crema",
        "43": "acciaio inox",
        "E03": "nero anodizzato"
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 1 - Maniglie Classic-line, Slim-line, Step-line, Nova-line
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie1: {
        // FINESTRE
        "6010": {
            codice: "6010",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56", "79", "74", "40", "0156", "0174"],
            supplemento: 19.6
        },
        "6011": {
            codice: "6011",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56", "79", "74", "40", "0156", "0174"],
            supplemento: 19.6
        },
        "6012": {
            codice: "6012",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56", "79", "74", "40", "0156", "0174"],
            supplemento: 19.6
        },
        
        "6020": {
            codice: "6020",
            descrizione: "maniglia per finestra in alluminio con pulsante",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 15.4,
            supplementoExtra: {
                "56": 64.4
            }
        },
        "6021": {
            codice: "6021",
            descrizione: "maniglia per finestra in alluminio con pulsante",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 15.4,
            supplementoExtra: {
                "56": 64.4
            }
        },
        
        "6030": {
            codice: "6030",
            descrizione: "maniglia per finestra in alluminio con chiusura inclusa placca antiperforazione",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 30.1,
            supplementoExtra: {
                "56": 83.5
            }
        },
        "6031": {
            codice: "6031",
            descrizione: "maniglia per finestra in alluminio con chiusura inclusa placca antiperforazione",
            tipo: "finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 30.1,
            supplementoExtra: {
                "56": 83.5
            }
        },
        
        // APERTURA SCORREVOLE PARALLELA
        "6470": {
            codice: "6470",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        },
        "6471": {
            codice: "6471",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        },
        
        // PORTA-FINESTRA
        "6710": {
            codice: "6710",
            descrizione: "doppia maniglia in alluminio cilindro incluso (per anta 935, 947 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 51.4,
            supplementoExtra: {
                "56": 18.9
            }
        },
        
        "6700": {
            codice: "6700",
            descrizione: "doppia maniglia in alluminio con collo esterno ribassato (36 mm) cilindro incluso (per anta 935, 947 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        },
        
        "6750": {
            codice: "6750",
            descrizione: "doppia maniglia in alluminio anta/ribalta cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 68.4
        },
        
        "6740": {
            codice: "6740",
            descrizione: "doppia maniglia in alluminio anta/ribalta con collo esterno ribassato (36 mm) cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "1",
            colori: ["01", "07", "56"],
            supplemento: 0
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 2 - Maniglie moderne
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie2: {
        // FINESTRE
        "7040": {
            codice: "7040",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 9.12
        },
        "7041": {
            codice: "7041",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 9.12
        },
        "7042": {
            codice: "7042",
            descrizione: "maniglia per finestra in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 9.12
        },
        
        "7120": {
            codice: "7120",
            descrizione: "maniglia a pressione in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 11.6
        },
        "7121": {
            codice: "7121",
            descrizione: "maniglia a pressione in alluminio",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 11.6
        },
        
        "7130": {
            codice: "7130",
            descrizione: "maniglia a pressione in alluminio con chiusura incluso placca antiperforazione",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 63.2
        },
        "7131": {
            codice: "7131",
            descrizione: "maniglia a pressione in alluminio con chiusura incluso placca antiperforazione",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 63.2
        },
        
        "7070": {
            codice: "7070",
            descrizione: "maniglia per apertura a ribalta e ad anta (TBT) - apertura ad anta deve essere sbloccata mediante la chiave",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 47.0
        },
        "7071": {
            codice: "7071",
            descrizione: "maniglia per apertura a ribalta e ad anta (TBT) - apertura ad anta deve essere sbloccata mediante la chiave",
            tipo: "finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 47.0
        },
        
        // PORTA-FINESTRA
        "7720": {
            codice: "7720",
            descrizione: "doppia maniglia in alluminio apertura ad anta cilindro incluso (per anta 935, 947 e 953)",
            tipo: "porta-finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 24.4
        },
        
        "7730": {
            codice: "7730",
            descrizione: "doppia maniglia in alluminio anta/ribalta cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 24.4
        },
        
        "7740": {
            codice: "7740",
            descrizione: "doppia maniglia in alluminio anta/ribalta con collo esterno ribassato cilindro incluso (per anta 935 e 953)",
            tipo: "porta-finestra",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 30.6
        },
        
        // APERTURA SCORREVOLE
        "7500": {
            codice: "7500",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 23.5
        },
        "7501": {
            codice: "7501",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 23.5
        },
        
        "7510": {
            codice: "7510",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio con chiusura incluso placca antiperforazione",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 49.5
        },
        "7511": {
            codice: "7511",
            descrizione: "maniglia per porta-finestra scorrevole in alluminio con chiusura incluso placca antiperforazione",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 49.5
        },
        
        "7520": {
            codice: "7520",
            descrizione: "doppia maniglia per porta-finestra scorrevole in alluminio cilindro incluso (per anta 935 e 953)",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 53.4
        },
        
        "7530": {
            codice: "7530",
            descrizione: "doppia maniglia per porta-finestra scorrevole in alluminio con collo esterno ribassato cilindro incluso (per anta 935 e 953)",
            tipo: "scorrevole",
            serie: "2",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 70.4
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 3 - Acciaio inox
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie3: {
        "8010": {
            codice: "8010",
            descrizione: "maniglia per finestra in acciaio inox",
            tipo: "finestra",
            serie: "3",
            colori: ["43"],
            supplemento: 18.4
        },
        "8011": {
            codice: "8011",
            descrizione: "maniglia per finestra in acciaio inox",
            tipo: "finestra",
            serie: "3",
            colori: ["43"],
            supplemento: 18.4
        },
        
        "8020": {
            codice: "8020",
            descrizione: "maniglia per porta-finestra scorrevole in acciaio inox",
            tipo: "scorrevole",
            serie: "3",
            colori: ["43"],
            supplemento: 50.8
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 4
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie4: {
        "1040": {
            codice: "1040",
            descrizione: "maniglia senza rosetta",
            tipo: "finestra",
            serie: "4",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 19.6,
            supplementoExtra: {
                "M07": 63.1
            }
        },
        "1041": {
            codice: "1041",
            descrizione: "maniglia senza rosetta",
            tipo: "finestra",
            serie: "4",
            colori: ["M01", "79", "M03", "M07"],
            supplemento: 19.6,
            supplementoExtra: {
                "M07": 63.1
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 11
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie11: {
        // FINESTRE
        "1901": {
            codice: "1901",
            descrizione: "maniglia per finestra serie 11 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 31.3,
            supplementoExtra: {
                "E03": 35.2,
                "extra": 75.1
            }
        },
        
        "19110": {
            codice: "19110",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 26.2,
            supplementoExtra: {
                "E03": 28.8,
                "extra": 70.0
            }
        },
        "19111": {
            codice: "19111",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 26.2,
            supplementoExtra: {
                "E03": 28.8,
                "extra": 70.0
            }
        },
        "19112": {
            codice: "19112",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 26.2,
            supplementoExtra: {
                "E03": 28.8,
                "extra": 70.0
            }
        },
        
        "49110": {
            codice: "49110",
            descrizione: "maniglia a pressione serie 11 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 59.9,
            supplementoExtra: {
                "E03": 68.6,
                "extra": 104
            }
        },
        "49111": {
            codice: "49111",
            descrizione: "maniglia a pressione serie 11 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 59.9,
            supplementoExtra: {
                "E03": 68.6,
                "extra": 104
            }
        },
        
        // PORTA-FINESTRA
        "29110": {
            codice: "29110",
            descrizione: "doppia maniglia serie 11 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "11",
            colori: ["56", "43", "E03"],
            supplemento: 67.6,
            supplementoExtra: {
                "E03": 71.6,
                "extra": 155
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 12
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie12: {
        "1902": {
            codice: "1902",
            descrizione: "maniglia per finestra serie 12 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 36.5,
            supplementoExtra: {
                "43": 58.7,
                "E03": 40.4,
                "extra": 80.3
            }
        },
        
        "19120": {
            codice: "19120",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 53.9,
                "E03": 34.6,
                "extra": 74.6
            }
        },
        "19122": {
            codice: "19122",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 53.9,
                "E03": 34.6,
                "extra": 74.6
            }
        },
        
        "49120": {
            codice: "49120",
            descrizione: "maniglia a pressione serie 12 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 64.4,
            supplementoExtra: {
                "43": 96.8,
                "E03": 74.4,
                "extra": 108
            }
        },
        
        "29120": {
            codice: "29120",
            descrizione: "doppia maniglia serie 12 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "12",
            colori: ["56", "43", "E03"],
            supplemento: 77.4,
            supplementoExtra: {
                "43": 134,
                "E03": 82.6,
                "extra": 165
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 13
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie13: {
        "1903": {
            codice: "1903",
            descrizione: "maniglia per finestra serie 13 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 60.0,
            supplementoExtra: {
                "43": 89.9,
                "E03": 70.4,
                "extra": 104
            }
        },
        
        "19130": {
            codice: "19130",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 56.5,
            supplementoExtra: {
                "43": 86.2,
                "E03": 65.6,
                "extra": 100
            }
        },
        "19131": {
            codice: "19131",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 56.5,
            supplementoExtra: {
                "43": 86.2,
                "E03": 65.6,
                "extra": 100
            }
        },
        "19132": {
            codice: "19132",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 56.5,
            supplementoExtra: {
                "43": 86.2,
                "E03": 65.6,
                "extra": 100
            }
        },
        
        "49130": {
            codice: "49130",
            descrizione: "maniglia a pressione serie 13 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 90.2,
            supplementoExtra: {
                "43": 129,
                "E03": 105,
                "extra": 134
            }
        },
        "49131": {
            codice: "49131",
            descrizione: "maniglia a pressione serie 13 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 90.2,
            supplementoExtra: {
                "43": 129,
                "E03": 105,
                "extra": 134
            }
        },
        
        "29130": {
            codice: "29130",
            descrizione: "doppia maniglia serie 13 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "13",
            colori: ["56", "43", "E03"],
            supplemento: 127,
            supplementoExtra: {
                "43": 199,
                "E03": 144,
                "extra": 214
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 14
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie14: {
        "1904": {
            codice: "1904",
            descrizione: "maniglia per finestra serie 14 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 41.3,
            supplementoExtra: {
                "E03": 52.9,
                "extra": 85.1
            }
        },
        
        "19140": {
            codice: "19140",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 34.6,
            supplementoExtra: {
                "E03": 38.5,
                "extra": 78.4
            }
        },
        "19141": {
            codice: "19141",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 34.6,
            supplementoExtra: {
                "E03": 38.5,
                "extra": 78.4
            }
        },
        "19142": {
            codice: "19142",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 34.6,
            supplementoExtra: {
                "E03": 38.5,
                "extra": 78.4
            }
        },
        
        "49140": {
            codice: "49140",
            descrizione: "maniglia a pressione serie 14 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 68.2,
            supplementoExtra: {
                "E03": 78.2,
                "extra": 112
            }
        },
        "49141": {
            codice: "49141",
            descrizione: "maniglia a pressione serie 14 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 68.2,
            supplementoExtra: {
                "E03": 78.2,
                "extra": 112
            }
        },
        
        "29140": {
            codice: "29140",
            descrizione: "doppia maniglia serie 14 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "14",
            colori: ["56", "43", "E03"],
            supplemento: 83.9,
            supplementoExtra: {
                "E03": 90.3,
                "extra": 172
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 15
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie15: {
        "1905": {
            codice: "1905",
            descrizione: "maniglia per finestra serie 15 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 37.2,
            supplementoExtra: {
                "43": 59.1,
                "E03": 46.2,
                "extra": 81.0
            }
        },
        
        "19150": {
            codice: "19150",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 52.7,
                "E03": 38.5,
                "extra": 74.6
            }
        },
        "19151": {
            codice: "19151",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 52.7,
                "E03": 38.5,
                "extra": 74.6
            }
        },
        "19152": {
            codice: "19152",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 30.7,
            supplementoExtra: {
                "43": 52.7,
                "E03": 38.5,
                "extra": 74.6
            }
        },
        
        "49150": {
            codice: "49150",
            descrizione: "maniglia a pressione serie 15 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 64.4,
            supplementoExtra: {
                "43": 95.5,
                "E03": 78.2,
                "extra": 108
            }
        },
        "49151": {
            codice: "49151",
            descrizione: "maniglia a pressione serie 15 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 64.4,
            supplementoExtra: {
                "43": 95.5,
                "E03": 78.2,
                "extra": 108
            }
        },
        
        "29150": {
            codice: "29150",
            descrizione: "doppia maniglia serie 15 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "15",
            colori: ["56", "43", "E03"],
            supplemento: 76.1,
            supplementoExtra: {
                "43": 132,
                "E03": 89.0,
                "extra": 164
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // SERIE 16
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    serie16: {
        "1906": {
            codice: "1906",
            descrizione: "maniglia per finestra serie 16 con fissaggio a scomparsa e rosetta rotonda",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 53.7,
            supplementoExtra: {
                "43": 103,
                "E03": 61.3,
                "extra": 97.5
            }
        },
        
        "19160": {
            codice: "19160",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 47.3,
            supplementoExtra: {
                "43": 95.8,
                "E03": 53.7,
                "extra": 91.1
            }
        },
        "19161": {
            codice: "19161",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 47.3,
            supplementoExtra: {
                "43": 95.8,
                "E03": 53.7,
                "extra": 91.1
            }
        },
        "19162": {
            codice: "19162",
            descrizione: "maniglia con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 47.3,
            supplementoExtra: {
                "43": 95.8,
                "E03": 53.7,
                "extra": 91.1
            }
        },
        
        "49160": {
            codice: "49160",
            descrizione: "maniglia a pressione serie 16 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 80.9,
            supplementoExtra: {
                "43": 139,
                "E03": 93.4,
                "extra": 125
            }
        },
        "49161": {
            codice: "49161",
            descrizione: "maniglia a pressione serie 16 con fissaggio a scomparsa e rosetta ovale",
            tipo: "finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 80.9,
            supplementoExtra: {
                "43": 139,
                "E03": 93.4,
                "extra": 125
            }
        },
        
        "29160": {
            codice: "29160",
            descrizione: "doppia maniglia serie 16 apertura ad anta - rosetta inferiore fissata dall'esterno",
            tipo: "porta-finestra",
            serie: "16",
            colori: ["56", "43", "E03"],
            supplemento: 110,
            supplementoExtra: {
                "43": 218,
                "E03": 120,
                "extra": 198
            }
        }
    },

    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // ACCESSORI
    // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    accessori: {
        "690": {
            codice: "690",
            descrizione: "rosetta per maniglia estraibile",
            tipo: "accessorio",
            colori: ["01", "56"],
            supplemento: 1.63
        },
        "691": {
            codice: "691",
            descrizione: "maniglia estraibile",
            tipo: "accessorio",
            colori: ["01", "56"],
            supplemento: 4.09
        },
        "100": {
            codice: "100",
            descrizione: "senza maniglia solo foro maniglia (per finestra)",
            tipo: "accessorio",
            colori: [],
            supplemento: -5.34
        },
        "100HY": {
            codice: "100HY",
            descrizione: "senza maniglia solo foro maniglia (per finestra)",
            tipo: "accessorio",
            colori: [],
            supplemento: -5.34
        },
        "1900": {
            codice: "1900",
            descrizione: "senza maniglia, foro per fissaggio a scomparsa della maniglia estraibile per finestre del produttore FSB",
            tipo: "accessorio",
            colori: [],
            supplemento: -5.34
        },
        "97": {
            codice: "97",
            descrizione: "senza maniglia solo foro maniglia (per porta-finestra con chiave)",
            tipo: "accessorio",
            colori: [],
            supplemento: -14.1
        },
        "99": {
            codice: "99",
            descrizione: "senza maniglia solo foro maniglia (con placca per porta-finestra con chiave)",
            tipo: "accessorio",
            colori: [],
            supplemento: -25.4
        },
        "96": {
            codice: "96",
            descrizione: "senza maniglia solo foro maniglia (con rosetta per porta-finestra con chiave)",
            tipo: "accessorio",
            colori: [],
            supplemento: -25.4
        },
        "70": {
            codice: "70",
            descrizione: "accessorio anta per protezione antiperforazione",
            tipo: "accessorio",
            colori: [],
            supplemento: 4.41
        }
    }
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FUNZIONI HELPER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Ottiene maniglia per codice
function getManigliaByCode(codice) {
    for (const serie in MANIGLIE_FINSTRAL) {
        if (serie === 'colori' || serie === 'accessori') continue;
        if (MANIGLIE_FINSTRAL[serie][codice]) {
            return MANIGLIE_FINSTRAL[serie][codice];
        }
    }
    return null;
}

// Ottiene supplemento per maniglia+colore
function getSupplemento(codiceManiglia, codiceColore) {
    const maniglia = getManigliaByCode(codiceManiglia);
    if (!maniglia) return 0;
    
    // Supplemento base
    let supplemento = maniglia.supplemento || 0;
    
    // Supplemento extra per colore specifico
    if (maniglia.supplementoExtra && maniglia.supplementoExtra[codiceColore]) {
        supplemento = maniglia.supplementoExtra[codiceColore];
    }
    
    return supplemento;
}

// Ottiene descrizione colore
function getColoreDescrizione(codiceColore) {
    return MANIGLIE_FINSTRAL.colori[codiceColore] || codiceColore;
}

// Ottiene lista maniglie per tipo
function getManiglieByTipo(tipo) {
    const risultato = [];
    for (const serie in MANIGLIE_FINSTRAL) {
        if (serie === 'colori' || serie === 'accessori') continue;
        for (const codice in MANIGLIE_FINSTRAL[serie]) {
            const maniglia = MANIGLIE_FINSTRAL[serie][codice];
            if (maniglia.tipo === tipo) {
                risultato.push(maniglia);
            }
        }
    }
    return risultato;
}

// Export per uso in altri file
if (typeof module !== 'undefined' && module.exports) {
    module.exports = {
        MANIGLIE_FINSTRAL,
        getManigliaByCode,
        getSupplemento,
        getColoreDescrizione,
        getManiglieByTipo
    };
}
        // Modulo Calcolatore Preventivi - EMBEDDED
        const PreventivoCalculator = {
            listini: {
                zanzariere: {
                    modelli: [
                        { modello: "EXTREMA", fascia_1: 164.0, fascia_2: 189.6, fascia_3: 199.8, fascia_4: 210.0 },
                        { modello: "FUTURA", fascia_1: 137.0, fascia_2: 158.2, fascia_3: 166.7, fascia_4: 175.3 },
                        { modello: "ORIZZ SCORR", fascia_1: 173.0, fascia_2: 199.8, fascia_3: 210.6, fascia_4: 221.4 },
                        { modello: "PANN SCORR VERT", fascia_1: 212.0, fascia_2: 244.8, fascia_3: 258.0, fascia_4: 271.2 },
                        { modello: "VERT SCORR", fascia_1: 102.0, fascia_2: 117.8, fascia_3: 124.2, fascia_4: 130.6 },
                        { modello: "PLISS+CONT MANUALE", fascia_1: 108.0, fascia_2: 124.7, fascia_3: 131.4, fascia_4: 138.2 },
                        { modello: "PLISS+CONT MOLLA", fascia_1: 115.0, fascia_2: 132.8, fascia_3: 140.0, fascia_4: 147.2 },
                        { modello: "PLISS ORIZZ", fascia_1: 245.0, fascia_2: 283.0, fascia_3: 298.2, fascia_4: 313.4 },
                        { modello: "SOTTO FINESTRA", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "1 ANTA", fascia_1: 45.0, fascia_2: 52.0, fascia_3: 54.8, fascia_4: 57.6 },
                        { modello: "2 ANTE", fascia_1: 75.0, fascia_2: 86.6, fascia_3: 91.3, fascia_4: 96.0 },
                        { modello: "1 ANTA+CONT MANUALE", fascia_1: 59.0, fascia_2: 68.1, fascia_3: 71.8, fascia_4: 75.5 },
                        { modello: "2 ANTE+CONT MANUALE", fascia_1: 100.0, fascia_2: 115.5, fascia_3: 121.7, fascia_4: 128.0 },
                        { modello: "1 ANTA+CONT MOLLA", fascia_1: 66.0, fascia_2: 76.2, fascia_3: 80.3, fascia_4: 84.5 },
                        { modello: "2 ANTE+CONT MOLLA", fascia_1: 111.0, fascia_2: 128.2, fascia_3: 135.1, fascia_4: 142.1 },
                        { modello: "ROBY SCORREVOLE", fascia_1: 112.0, fascia_2: 129.4, fascia_3: 136.3, fascia_4: 143.4 },
                        { modello: "AVVOLG MINI", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "AVVOLG SMART", fascia_1: 90.0, fascia_2: 104.0, fascia_3: 109.6, fascia_4: 115.2 },
                        { modello: "AVVOLG ORIZZ", fascia_1: 186.0, fascia_2: 214.9, fascia_3: 226.5, fascia_4: 238.1 },
                        { modello: "PLISS+CONT MANUALE COL", fascia_1: 108.0, fascia_2: 124.7, fascia_3: 131.4, fascia_4: 138.2 },
                        { modello: "PLISS+CONT MOLLA COL", fascia_1: 115.0, fascia_2: 132.8, fascia_3: 140.0, fascia_4: 147.2 },
                        { modello: "PLISS ORIZZ COLORE", fascia_1: 245.0, fascia_2: 283.0, fascia_3: 298.2, fascia_4: 313.4 },
                        { modello: "SOTTO FINESTRA COLORE", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "1 ANTA COLORE", fascia_1: 45.0, fascia_2: 52.0, fascia_3: 54.8, fascia_4: 57.6 },
                        { modello: "2 ANTE COLORE", fascia_1: 75.0, fascia_2: 86.6, fascia_3: 91.3, fascia_4: 96.0 },
                        { modello: "1 ANTA+CONT MANUALE COL", fascia_1: 59.0, fascia_2: 68.1, fascia_3: 71.8, fascia_4: 75.5 },
                        { modello: "2 ANTE+CONT MANUALE COL", fascia_1: 100.0, fascia_2: 115.5, fascia_3: 121.7, fascia_4: 128.0 },
                        { modello: "1 ANTA+CONT MOLLA COL", fascia_1: 66.0, fascia_2: 76.2, fascia_3: 80.3, fascia_4: 84.5 },
                        { modello: "2 ANTE+CONT MOLLA COL", fascia_1: 111.0, fascia_2: 128.2, fascia_3: 135.1, fascia_4: 142.1 },
                        { modello: "AVVOLG MINI COLORE", fascia_1: 84.0, fascia_2: 97.0, fascia_3: 102.2, fascia_4: 107.5 },
                        { modello: "AVVOLG SMART COLORE", fascia_1: 90.0, fascia_2: 104.0, fascia_3: 109.6, fascia_4: 115.2 }
                    ],
                    fasce: [
                        { fascia: 1, min: 0, max: 1.0 },
                        { fascia: 2, min: 1.01, max: 1.5 },
                        { fascia: 3, min: 1.51, max: 2.0 },
                        { fascia: 4, min: 2.01, max: 999 }
                    ]
                },
                persiane: {
                    versione: "1.0 - STEP 1",
                    dataAggiornamento: "2025-11-19",
                    fonte: "Listino Punto Persiane 45/52 Ottobre 2025 + Preventivi Reali",
                    
                    modelli: {
                        "NERINA": {
                            descrizione: "Scuro in alluminio con doghe verticali a passo di 80mm",
                            categoria: "Persiane cieche e a doghe",
                            spessore_anta: "45mm",
                            struttura_esterna: "80mm",
                            prezzi: {
                                "F2": {
                                    "1400x1300": 842.40,
                                    "1000x1300": 762.84
                                },
                                "F1": {
                                    "600x1300": 496.08
                                },
                                "PF2": {
                                    "1000x2200": 1117.35
                                }
                            }
                        },
                        "OSCURA": {
                            descrizione: "Scuro in alluminio con doghe verticali da 80mm con struttura portante a scomparsa",
                            categoria: "Scuri a doghe",
                            spessore_anta: "53mm",
                            struttura_esterna: "58mm (a scomparsa)",
                            prezzi: {
                                "F2": {
                                    "1000x1300": 815.85,
                                    "1200x1270": 864.85
                                },
                                "F1": {
                                    "700x1275": 498.58
                                }
                            }
                        },
                        "VANITOSA": {
                            descrizione: "Persiana con lamelle orientabili a goccia da 55mm - Tecnologia Ultratech",
                            categoria: "Persiane a stecche orientabili ULTRATECH",
                            spessore_anta: "45mm",
                            struttura_esterna: "80mm",
                            prezzi: {
                                "PF2": {
                                    "1330x2350": 1533.87
                                }
                            }
                        }
                    },
                    
                    telai: {
                        "TH62": { prezzo: 136.00, descrizione: "Telaio standard TH62" },
                        "TH40": { prezzo: 167.00, descrizione: "Telaio standard TH40" },
                        "TH45": { prezzo: 187.00, descrizione: "Telaio standard TH45" }
                    },
                    
                    colori: {
                        categorie: {
                            "1": { maggiorazione: 0, descrizione: "Colori standard" },
                            "2A": { maggiorazione: 3, descrizione: "Colori opachi speciali" },
                            "2B": { maggiorazione: 5, descrizione: "Colori textured" },
                            "3": { maggiorazione: 20, descrizione: "Colori legno polvere su polvere" },
                            "4": { maggiorazione: 25, descrizione: "Colori legno Ã‰lite" },
                            "5": { maggiorazione: 25, descrizione: "Colori legno sublimato Electo" },
                            "6": { maggiorazione: 30, descrizione: "Colori legno sublimato" },
                            "7": { maggiorazione: 30, descrizione: "Colori legno sublimato speciali" },
                            "8": { maggiorazione: null, descrizione: "Colori speciali (a preventivo)" }
                        },
                        colori_specifici: {
                            // CATEGORIA 01 - Nessun supplemento (0%)
                            "CPF910L": { nome: "Bianco puro tipo Ral 9010 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF113L": { nome: "Bianco perla tipo Ral 1013 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF701L": { nome: "Grigio argento tipo Ral 7001 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF716L": { nome: "Antracite tipo Ral 7016 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF605L": { nome: "Verde muschio tipo Ral 6005 opaco", categoria: "1", maggiorazione: 0 },
                            "CPF609T": { nome: "Verde abete textured tipo Ral 6009 ruvido", categoria: "1", maggiorazione: 0 },
                            "CPF817L": { nome: "Marrone cioccolato tipo Ral 8017 opaco", categoria: "1", maggiorazione: 0 },
                            
                            // CATEGORIA 02A - +3%
                            "CPF735L": { nome: "Grigio luce tipo Ral 7035 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF609L": { nome: "Verde abete tipo Ral 6009 semiopaco", categoria: "2A", maggiorazione: 3 },
                            "CPF621L": { nome: "Verde pallido tipo Ral 6021 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF119L": { nome: "Beige tipo Ral 1019 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF524L": { nome: "Azzurro pastello tipo Ral 5024 opaco", categoria: "2A", maggiorazione: 3 },
                            "CPF811L": { nome: "Marrone Nuss tipo Ral 8011 opaco", categoria: "2A", maggiorazione: 3 },
                            
                            // CATEGORIA 02B - +5%
                            "CPF910T": { nome: "Bianco puro textured tipo Ral 9010 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF113T": { nome: "Bianco perla textured tipo Ral 1013 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF701T": { nome: "Grigio argento textured tipo Ral 7001 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF305T": { nome: "Rosso vino textured tipo Ral 3005 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF605T": { nome: "Verde foglia textured tipo Ral 6005 ruvido", categoria: "2B", maggiorazione: 5 },
                            "CPF817T": { nome: "Marrone cioccolato textured tipo Ral 8017 ruvido", categoria: "2B", maggiorazione: 5 },
                            
                            // CATEGORIA 03 - +20% (Colori legno polvere su polvere Ezy)
                            "CPF820H": { nome: "Grey Oak", categoria: "3", maggiorazione: 20 },
                            "CPF818H": { nome: "Renolit Vulcano", categoria: "3", maggiorazione: 20 },
                            "CPF813H": { nome: "Renolit Gold", categoria: "3", maggiorazione: 20 },
                            "CPFR811": { nome: "Marrone Renolit scuro", categoria: "3", maggiorazione: 20 },
                            "CPF812H": { nome: "Marrone Renolit dorato", categoria: "3", maggiorazione: 20 },
                            "CPFN630": { nome: "Acacia - effetto rigato", categoria: "3", maggiorazione: 20 },
                            "CPFN632": { nome: "Noce Reale - effetto rigato", categoria: "3", maggiorazione: 20 },
                            
                            // CATEGORIA 04 - +25% (Colori legno Ã‰lite)
                            "HD303": { nome: "Polar Ash", categoria: "4", maggiorazione: 25 },
                            "HD360": { nome: "Silver Ash", categoria: "4", maggiorazione: 25 },
                            "HD366": { nome: "Dark Ash", categoria: "4", maggiorazione: 25 },
                            
                            // CATEGORIA 05 - +25% (Colori legno / sublimato Electo)
                            "CPF90RC": { nome: "Marrone RENOLIT CHIARO ruvido", categoria: "5", maggiorazione: 25 },
                            "CPF91RS": { nome: "Marrone RENOLIT SCURO ruvido", categoria: "5", maggiorazione: 25 },
                            "CPF51CR": { nome: "Marrone ciliegio Renoir ruvido", categoria: "5", maggiorazione: 25 },
                            
                            // CATEGORIA 06 - +30% (Colori legno / sublimato)
                            "CPF358R": { nome: "Douglas tipo 335-80R", categoria: "6", maggiorazione: 30 },
                            "CPF127R": { nome: "Noce scuro ruvido tipo 102-70R", categoria: "6", maggiorazione: 30 },
                            "CPF375R": { nome: "Castagno chiaro ruvido tipo 375-80R", categoria: "6", maggiorazione: 30 },
                            "CPF378R": { nome: "Castagno scuro ruvido tipo 378-70R", categoria: "6", maggiorazione: 30 },
                            "CPF317R": { nome: "Ciliegio chiaro ruvido tipo 317-70R", categoria: "6", maggiorazione: 30 },
                            
                            // CATEGORIA 07 - +30%
                            "CPF70KA": { nome: "Winchester", categoria: "7", maggiorazione: 30 },
                            
                            // CATEGORIA 08 - A PREVENTIVO (Colori speciali)
                            "CPFSLV7": { nome: "Verde Salvia", categoria: "8", maggiorazione: null },
                            "CPFRGG4": { nome: "Ruggine EVO", categoria: "8", maggiorazione: null },
                            "CPF744L": { nome: "Grigio seta tipo RAL 7044 opaco", categoria: "8", maggiorazione: null }
                        }
                    },
                    
                    supplementi: {
                        contributo_gestione: 57.00,
                        imballo_percentuale: 3.0
                    }
                }
            },
            
            calcolaZanzariera(datiRilievo) {
                try {
                    const { larghezza, altezza, modello } = datiRilievo;
                    if (!larghezza || !altezza) throw new Error("Misure mancanti");
                    
                    const superficie_mq = (larghezza * altezza) / 10000;
                    const modelloData = this.listini.zanzariere.modelli.find(
                        m => m.modello.toUpperCase() === (modello || "").toUpperCase()
                    );
                    
                    if (!modelloData) throw new Error(`Modello "${modello}" non trovato`);
                    
                    let fasciaPrezzo = 1;
                    for (const fascia of this.listini.zanzariere.fasce) {
                        if (superficie_mq >= fascia.min && superficie_mq <= fascia.max) {
                            fasciaPrezzo = fascia.fascia;
                            break;
                        }
                    }
                    
                    const prezzoCampo = `fascia_${fasciaPrezzo}`;
                    const prezzoUnitario = modelloData[prezzoCampo];
                    const prezzoTotale = prezzoUnitario;
                    
                    return {
                        successo: true,
                        prodotto: "Zanzariera",
                        modello: modelloData.modello,
                        misure: {
                            larghezza: larghezza,
                            altezza: altezza,
                            superficie_mq: superficie_mq.toFixed(2)
                        },
                        fascia: fasciaPrezzo,
                        prezzi: {
                            unitario: prezzoUnitario.toFixed(2),
                            totale: prezzoTotale.toFixed(2),
                            iva: (prezzoTotale * 0.22).toFixed(2),
                            totale_iva: (prezzoTotale * 1.22).toFixed(2)
                        }
                    };
                } catch (error) {
                    return { successo: false, errore: error.message };
                }
            },
            
            calcolaPersiana(datiRilievo) {
                try {
                    const { larghezza, altezza, modello, telaio, colore, tipologia } = datiRilievo;
                    
                    // Validazione base
                    if (!larghezza || !altezza) throw new Error("Misure mancanti");
                    if (!modello) throw new Error("Modello mancante");
                    
                    // Verifica modello esiste
                    if (!this.listini.persiane.modelli[modello]) {
                        throw new Error(`Modello "${modello}" non trovato nel listino STEP 1`);
                    }
                    
                    const mod = this.listini.persiane.modelli[modello];
                    
                    // Cerca prezzo base nella griglia per tipologia
                    const key = `${larghezza}x${altezza}`;
                    const tip = tipologia || "F2"; // Default F2 se non specificato
                    
                    let prezzoBase = 0;
                    
                    if (mod.prezzi[tip] && mod.prezzi[tip][key]) {
                        // Trovato prezzo esatto
                        prezzoBase = mod.prezzi[tip][key];
                    } else {
                        // Cerca dimensione disponibile piÃ¹ vicina come fallback
                        const dimensioniDisponibili = mod.prezzi[tip] ? Object.keys(mod.prezzi[tip]) : [];
                        if (dimensioniDisponibili.length > 0) {
                            // Usa prima dimensione disponibile
                            prezzoBase = mod.prezzi[tip][dimensioniDisponibili[0]];
                            console.warn(`âš ï¸ Persiana ${modello}: dimensione ${key} non trovata, uso ${dimensioniDisponibili[0]}`);
                        } else {
                            throw new Error(`Nessuna dimensione disponibile per ${modello} ${tip}`);
                        }
                    }
                    
                    // Aggiungi telaio se presente
                    let prezzoTelaio = 0;
                    if (telaio && this.listini.persiane.telai[telaio]) {
                        prezzoTelaio = this.listini.persiane.telai[telaio].prezzo;
                    }
                    
                    const subtotale = prezzoBase + prezzoTelaio;
                    
                    // Applica maggiorazione colore
                    let maggiorazioneColore = 0;
                    let percColore = 0;
                    let nomeColore = "N/D";
                    
                    if (colore && this.listini.persiane.colori.colori_specifici[colore]) {
                        const colData = this.listini.persiane.colori.colori_specifici[colore];
                        percColore = colData.maggiorazione;
                        nomeColore = colData.nome;
                        maggiorazioneColore = subtotale * (percColore / 100);
                    }
                    
                    const totaleProdotto = subtotale + maggiorazioneColore;
                    
                    // Aggiungi supplementi
                    const contributo = this.listini.persiane.supplementi.contributo_gestione;
                    const conContributo = totaleProdotto + contributo;
                    
                    // Aggiungi imballo
                    const percImballo = this.listini.persiane.supplementi.imballo_percentuale;
                    const imballo = conContributo * (percImballo / 100);
                    const prezzoFinale = conContributo + imballo;
                    
                    return {
                        successo: true,
                        prodotto: "Persiana",
                        modello: `${modello} - ${mod.descrizione}`,
                        tipologia: tip,
                        misure: {
                            larghezza: larghezza,
                            altezza: altezza,
                            dimensione: key
                        },
                        dettaglio: {
                            prezzo_base: prezzoBase.toFixed(2),
                            telaio: prezzoTelaio.toFixed(2),
                            subtotale: subtotale.toFixed(2),
                            colore_perc: percColore,
                            colore_nome: nomeColore,
                            maggiorazione_colore: maggiorazioneColore.toFixed(2),
                            totale_prodotto: totaleProdotto.toFixed(2),
                            contributo_gestione: contributo.toFixed(2),
                            imballo: imballo.toFixed(2)
                        },
                        prezzi: {
                            totale: prezzoFinale.toFixed(2),
                            iva: (prezzoFinale * 0.22).toFixed(2),
                            totale_iva: (prezzoFinale * 1.22).toFixed(2)
                        }
                    };
                    
                } catch (error) {
                    console.error("âŒ Errore calcolo persiana:", error);
                    return { successo: false, errore: error.message };
                }
            },
            
            calcolaProgetto(datiProgetto) {
                const risultati = {
                    successo: true,
                    progetto: datiProgetto.nome || datiProgetto.projectName || "Progetto",
                    cliente: datiProgetto.cliente || datiProgetto.clientData || {},
                    timestamp: new Date().toISOString(),
                    prodotti: [],
                    totale: 0,
                    totale_iva: 0
                };
                
                if (datiProgetto.posizioni && Array.isArray(datiProgetto.posizioni)) {
                    datiProgetto.posizioni.forEach((pos, idx) => {
                        if (pos.zanzariera && pos.zanzariera.modello) {
                            const calc = this.calcolaZanzariera({
                                larghezza: pos.zanzariera.brm?.L || 0,
                                altezza: pos.zanzariera.brm?.H || 0,
                                modello: pos.zanzariera.modello
                            });
                            
                            if (calc.successo) {
                                risultati.prodotti.push({
                                    posizione: pos.nome || `Posizione ${idx + 1}`,
                                    ...calc
                                });
                                risultati.totale += parseFloat(calc.prezzi.totale);
                                risultati.totale_iva += parseFloat(calc.prezzi.totale_iva);
                            }
                        }
                        
                        if (pos.persiana && pos.persiana.modello) {
                            // Controlla se esiste prezzo manuale
                            if (pos.persiana.prezzoManuale && pos.persiana.prezzoManuale.totaleFinale) {
                                // Usa prezzo manuale
                                const pm = pos.persiana.prezzoManuale;
                                risultati.prodotti.push({
                                    posizione: pos.nome || `Posizione ${idx + 1}`,
                                    successo: true,
                                    prodotto: "Persiana",
                                    modello: `${pos.persiana.modello} - ${pm.dimensione} (MANUALE)`,
                                    tipologia: pos.persiana.tipologia || 'N/D',
                                    misure: {
                                        larghezza: pos.persiana.brm?.L || 0,
                                        altezza: pos.persiana.brm?.H || 0,
                                        dimensione: pm.dimensione
                                    },
                                    dettaglio: {
                                        prezzo_base: pm.prezzoBase.toFixed(2),
                                        telaio: pm.prezzoTelaio.toFixed(2),
                                        subtotale: (pm.prezzoBase + pm.prezzoTelaio).toFixed(2),
                                        colore_perc: pm.colorePercentuale,
                                        colore_nome: 'Manuale',
                                        maggiorazione_colore: pm.maggiorazioneColore.toFixed(2),
                                        totale_prodotto: pm.totaleProdotto.toFixed(2),
                                        contributo_gestione: pm.contributo.toFixed(2),
                                        imballo: pm.imballo.toFixed(2)
                                    },
                                    prezzi: {
                                        totale: pm.totaleFinale.toFixed(2),
                                        iva: (pm.totaleFinale * 0.22).toFixed(2),
                                        totale_iva: (pm.totaleFinale * 1.22).toFixed(2)
                                    },
                                    manuale: true,
                                    note_manuale: pm.note || ''
                                });
                                risultati.totale += parseFloat(pm.totaleFinale);
                                risultati.totale_iva += parseFloat((pm.totaleFinale * 1.22).toFixed(2));
                                console.log(`âœ… Persiana ${idx + 1}: Prezzo MANUALE â‚¬${pm.totaleFinale.toFixed(2)}`);
                            } else {
                                // Prova calcolo automatico
                                const calc = this.calcolaPersiana({
                                    larghezza: pos.persiana.brm?.L || 0,
                                    altezza: pos.persiana.brm?.H || 0,
                                    modello: pos.persiana.modello,
                                    tipologia: pos.persiana.tipologia || "F2",
                                    telaio: pos.persiana.telaio || "",
                                    colore: pos.persiana.colore || ""
                                });
                                
                                if (calc.successo) {
                                    risultati.prodotti.push({
                                        posizione: pos.nome || `Posizione ${idx + 1}`,
                                        ...calc
                                    });
                                    risultati.totale += parseFloat(calc.prezzi.totale);
                                    risultati.totale_iva += parseFloat(calc.prezzi.totale_iva);
                                } else {
                                    // Calcolo fallito - Log warning
                                    console.warn(`âš ï¸ Persiana posizione ${idx + 1}: ${calc.errore}. Richiede inserimento manuale.`);
                                    risultati.prodotti.push({
                                        posizione: pos.nome || `Posizione ${idx + 1}`,
                                        successo: false,
                                        prodotto: "Persiana",
                                        errore: calc.errore,
                                        richiede_inserimento_manuale: true,
                                        dati_persiana: {
                                            modello: pos.persiana.modello,
                                            tipologia: pos.persiana.tipologia || "F2",
                                            larghezza: pos.persiana.brm?.L || 0,
                                            altezza: pos.persiana.brm?.H || 0,
                                            telaio: pos.persiana.telaio || "",
                                            colore: pos.persiana.colore || "",
                                            posizioneIndex: idx
                                        }
                                    });
                                }
                            }
                        }
                    });
                }
                
                risultati.totale = risultati.totale.toFixed(2);
                risultati.totale_iva = risultati.totale_iva.toFixed(2);
                
                return risultati;
            }
        };
        
        console.log('âœ… PreventivoCalculator caricato');
    </script>
    
    <script>
        // ================================================================================
        // FUNZIONI UI PREVENTIVO
        // ================================================================================
        
        let currentPreventivo = null;
        
        /**
         * Apri modal preventivo
         */
        function apriPreventivo() {
            if (!appState.rilievoData) {
                alert('âš ï¸ Nessun progetto caricato!\n\nCarica prima un file JSON dal Blocco Generale.');
                return;
            }
            
            console.log('ğŸ’° Apertura modal preventivo...');
            
            // Crea modal se non esiste
            let overlay = document.getElementById('preventivo-modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'preventivo-modal-overlay';
                overlay.className = 'preventivo-modal-overlay';
                overlay.innerHTML = `
                    <div class="preventivo-modal" onclick="event.stopPropagation()" style="max-width: 1400px; max-height: 95vh;">
                        <div class="preventivo-modal-header">
                            <h2 class="preventivo-modal-title">ğŸ“ˆ Dettaglio Costi</h2>
                            <button class="preventivo-modal-close" onclick="chiudiPreventivo()">Ã—</button>
                        </div>
                        
                        <!-- Tab Navigation -->
                        <div style="display: flex; gap: 0.5rem; padding: 1rem; border-bottom: 2px solid #e5e7eb; background: #f9fafb; overflow-x: auto;">
                            <button class="tab-analisi active" onclick="switchTabAnalisi('riepilogo')" style="white-space: nowrap;">
                                ğŸ“Š Riepilogo
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('persiane')" style="white-space: nowrap;">
                                ğŸšª Persiane
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('zanzariere')" style="white-space: nowrap;">
                                ğŸ¦Ÿ Zanzariere
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('infissi')" style="white-space: nowrap; opacity: 0.5;" disabled>
                                ğŸªŸ Infissi
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('tapparelle')" style="white-space: nowrap; opacity: 0.5;" disabled>
                                ğŸ“¦ Tapparelle
                            </button>
                            <button class="tab-analisi" onclick="switchTabAnalisi('cassonetti')" style="white-space: nowrap; opacity: 0.5;" disabled>
                                ğŸ“ Cassonetti
                            </button>
                        </div>
                        
                        <!-- Tab Content: Riepilogo -->
                        <div id="tab-content-riepilogo" class="tab-content-analisi" style="overflow-y: auto; max-height: calc(95vh - 200px);">
                            <div class="preventivo-modal-body" id="preventivo-modal-content">
                                <div class="preventivo-loading">
                                    <div class="preventivo-spinner"></div>
                                    <p style="color: #64748b;">Calcolo in corso...</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Persiane -->
                        <div id="tab-content-persiane" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <!-- Listino Persiane -->
                            <div id="tab-listini-persiane">
                                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Persiane - STEP 1</h3>
                                
                                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                                    <p style="margin: 0; font-weight: 600; color: #065f46;">
                                        â„¹ï¸ Versione: <span id="listino-persiane-versione-2"></span> | 
                                        Aggiornamento: <span id="listino-persiane-data-2"></span>
                                    </p>
                                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #047857;">
                                        ğŸ“„ Fonte: <span id="listino-persiane-fonte-2"></span>
                                    </p>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ—ï¸ Modelli Disponibili</h4>
                                    <div id="listino-persiane-modelli-2"></div>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ› ï¸ Telai</h4>
                                    <div id="listino-persiane-telai-2"></div>
                                </div>
                                
                                <div style="margin-bottom: 1.5rem;">
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ¨ Colori (41 totali)</h4>
                                    <div id="listino-persiane-colori-2"></div>
                                </div>
                                
                                <div>
                                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ’° Supplementi</h4>
                                    <div id="listino-persiane-supplementi-2"></div>
                                </div>
                                
                                <!-- Separatore -->
                                <div style="border-top: 3px solid #e5e7eb; margin: 2rem 0; position: relative;">
                                    <div style="position: absolute; top: -12px; left: 50%; transform: translateX(-50%); background: white; padding: 0 1rem; color: #6b7280; font-weight: 600;">
                                        ğŸ§ª Test Calcolo
                                    </div>
                                </div>
                                
                                <!-- Test Calcolo Persiane -->
                                <div>
                                    <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ§ª Test Calcolo Rapido</h3>
                                    
                                    <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                                        <h4 style="margin-bottom: 1rem; color: #374151;">Persiana</h4>
                                        
                                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Modello:</label>
                                                <select id="test-modello-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Seleziona...</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Tipologia:</label>
                                                <select id="test-tipologia-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Seleziona...</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Larghezza (mm):</label>
                                                <input type="number" id="test-larghezza-2" placeholder="es. 1400" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Altezza (mm):</label>
                                                <input type="number" id="test-altezza-2" placeholder="es. 1300" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Telaio:</label>
                                                <select id="test-telaio-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Nessuno</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Colore:</label>
                                                <select id="test-colore-2" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                                    <option value="">Nessuno</option>
                                                </select>
                                            </div>
                                        </div>
                                        
                                        <button onclick="eseguiTestCalcolo2()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                                            ğŸ§® Calcola Prezzo
                                        </button>
                                        
                                        <div id="test-risultato-2" style="margin-top: 1rem;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Zanzariere -->
                        <!-- Tab Content: Zanzariere -->
                        <div id="tab-content-zanzariere" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Zanzariere</h3>
                            
                            <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                                <p style="margin: 0; font-weight: 600; color: #065f46;">
                                    â„¹ï¸ Fornitore: Palagina
                                </p>
                                <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #047857;">
                                    ğŸ“„ Listino completo con fasce di prezzo per superficie
                                </p>
                            </div>
                            
                            <div id="listino-zanzariere-content-dettaglio">
                                <!-- Popolato dinamicamente dalla funzione caricaDatiListinoZanzariereDettaglio() -->
                            </div>
                        </div>
                        
                        <!-- Tab Content: Infissi (Placeholder) -->
                        <div id="tab-content-infissi" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <div style="text-align: center; padding: 3rem 1rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸªŸ</div>
                                <h3 style="color: #6b7280; margin-bottom: 0.5rem;">Listino Infissi</h3>
                                <p style="color: #9ca3af;">In fase di implementazione - Listino Finstral completo</p>
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; text-align: left;">
                                    <p style="margin: 0.5rem 0; color: #6b7280;"><strong>Prossimi step:</strong></p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Prezzi base per tipologie 101-401</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Supplementi telai (Step-line, Nova-line)</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Database maniglie Finstral (67 modelli)</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Test calcolo integrato</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Tapparelle (Placeholder) -->
                        <div id="tab-content-tapparelle" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <div style="text-align: center; padding: 3rem 1rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“¦</div>
                                <h3 style="color: #6b7280; margin-bottom: 0.5rem;">Listino Tapparelle</h3>
                                <p style="color: #9ca3af;">In fase di implementazione</p>
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; text-align: left;">
                                    <p style="margin: 0.5rem 0; color: #6b7280;"><strong>Fornitori da integrare:</strong></p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Plasticino</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ New Solar</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Estella</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tab Content: Cassonetti (Placeholder) -->
                        <div id="tab-content-cassonetti" class="tab-content-analisi" style="display: none; padding: 1.5rem; overflow-y: auto; max-height: calc(95vh - 200px);">
                            <div style="text-align: center; padding: 3rem 1rem;">
                                <div style="font-size: 4rem; margin-bottom: 1rem;">ğŸ“</div>
                                <h3 style="color: #6b7280; margin-bottom: 0.5rem;">Listino Cassonetti</h3>
                                <p style="color: #9ca3af;">In fase di implementazione</p>
                                <div style="margin-top: 1.5rem; padding: 1rem; background: #f9fafb; border-radius: 0.5rem; text-align: left;">
                                    <p style="margin: 0.5rem 0; color: #6b7280;"><strong>Fornitori da integrare:</strong></p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Finstral</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ MagÃ²</p>
                                    <p style="margin: 0.5rem 0; color: #6b7280;">â€¢ Alpac</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="preventivo-modal-actions">
                            <button class="preventivo-btn preventivo-btn-secondary" onclick="chiudiPreventivo()">
                                â† Chiudi
                            </button>
                            <button id="btn-export-pdf" class="preventivo-btn preventivo-btn-primary" onclick="esportaPreventiPDF()">
                                ğŸ“„ Esporta PDF
                            </button>
                        </div>
                    </div>
                `;
                overlay.addEventListener('click', chiudiPreventivo);
                document.body.appendChild(overlay);
            }
            
            // Mostra modal
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Calcola preventivo tab Dettaglio
            setTimeout(() => {
                const preventivo = PreventivoCalculator.calcolaProgetto(appState.rilievoData);
                renderPreventivo(preventivo);
            }, 500);
            
            // Popola listini e test
            setTimeout(() => {
                caricaDatiListinoPersiane2();
                popolaSelectTest2();
            }, 600);
        }
        
        /**
         * Chiudi modal
         */
        function chiudiPreventivo() {
            const overlay = document.getElementById('preventivo-modal-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // ============================================================================
        // âœ… CONFERMA CLIENTE v7.28
        // ============================================================================
        
        /**
         * Configurazione colonne Conferma Cliente
         * Definisce quali informazioni mostrare nel documento per il cliente
         */
        const CONFERMA_CONFIG = {
            // Colonne sempre presenti (non disattivabili)
            colonneBase: {
                nomePosizione: { label: 'Nome Posizione', sempre: true },
                misure: { label: 'Misure (LxH)', sempre: true },
                quantita: { label: 'QuantitÃ ', sempre: true }
            },
            
            // Colonne opzionali (utente puÃ² scegliere)
            colonneOpzionali: {
                // ===== INFISSI =====
                infisso_azienda: { 
                    label: 'Azienda Infisso', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_telaio: { 
                    label: 'Telaio', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_materiale: { 
                    label: 'Materiale', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_vetro: { 
                    label: 'Vetro', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_coloreInterno: { 
                    label: 'Colore Interno', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_coloreEsterno: { 
                    label: 'Colore Esterno', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                infisso_maniglia: { 
                    label: 'Maniglia', 
                    default: true, 
                    gruppo: 'infisso',
                    emoji: 'ğŸªŸ'
                },
                
                // ===== PERSIANE =====
                persiana_azienda: { 
                    label: 'Azienda Persiana', 
                    default: true, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                persiana_tipo: { 
                    label: 'Tipo Persiana', 
                    default: true, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                persiana_colore: { 
                    label: 'Colore Persiana', 
                    default: true, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                persiana_oscurante: { 
                    label: 'Oscurante', 
                    default: false, 
                    gruppo: 'persiana',
                    emoji: 'ğŸšª'
                },
                
                // ===== TAPPARELLE =====
                tapparella_azienda: { 
                    label: 'Azienda Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_tipo: { 
                    label: 'Tipo Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_colore: { 
                    label: 'Colore Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_automazione: { 
                    label: 'Automazione', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                tapparella_guida: { 
                    label: 'Guida Tapparella', 
                    default: false, 
                    gruppo: 'tapparella',
                    emoji: 'ğŸ“œ'
                },
                
                // ===== ZANZARIERE =====
                zanzariera_azienda: { 
                    label: 'Azienda Zanzariera', 
                    default: false, 
                    gruppo: 'zanzariera',
                    emoji: 'ğŸ¦Ÿ'
                },
                zanzariera_tipo: { 
                    label: 'Tipo Zanzariera', 
                    default: false, 
                    gruppo: 'zanzariera',
                    emoji: 'ğŸ¦Ÿ'
                },
                zanzariera_colore: { 
                    label: 'Colore Zanzariera', 
                    default: false, 
                    gruppo: 'zanzariera',
                    emoji: 'ğŸ¦Ÿ'
                },
                
                // ===== CASSONETTI =====
                cassonetto_azienda: { 
                    label: 'Azienda Cassonetto', 
                    default: false, 
                    gruppo: 'cassonetto',
                    emoji: 'ğŸ“¦'
                },
                cassonetto_tipo: { 
                    label: 'Tipo Cassonetto', 
                    default: false, 
                    gruppo: 'cassonetto',
                    emoji: 'ğŸ“¦'
                },
                cassonetto_isolamento: { 
                    label: 'Isolamento', 
                    default: false, 
                    gruppo: 'cassonetto',
                    emoji: 'ğŸ“¦'
                },
                
                // ===== PREZZI =====
                prezzo_calcolato: { 
                    label: 'Prezzo Calcolato', 
                    default: false, 
                    gruppo: 'prezzi',
                    emoji: 'ğŸ’°',
                    descrizione: 'Mostra prezzo da calcolo automatico'
                },
                prezzo_editabile: { 
                    label: 'Campo Prezzo Vuoto', 
                    default: true, 
                    gruppo: 'prezzi',
                    emoji: 'ğŸ’°',
                    descrizione: 'Lascia spazio vuoto per compilare manualmente'
                },
                
                // ===== ALTRO =====
                note: { 
                    label: 'Note', 
                    default: false, 
                    gruppo: 'altro',
                    emoji: 'ğŸ“'
                }
            }
        };
        
        /**
         * Carica configurazione colonne salvata in localStorage
         * Se non esiste, usa default da CONFERMA_CONFIG
         */
        function caricaConfigurazioneConferma() {
            const saved = localStorage.getItem('conferma_colonne_config');
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    console.warn('âš ï¸ Configurazione salvata corrotta, uso default');
                }
            }
            
            // Default: attiva colonne con default:true
            const config = {};
            Object.keys(CONFERMA_CONFIG.colonneOpzionali).forEach(key => {
                config[key] = CONFERMA_CONFIG.colonneOpzionali[key].default;
            });
            
            console.log('ğŸ“‹ Configurazione colonne (default):', config);
            return config;
        }
        
        /**
         * Salva configurazione colonne in localStorage
         */
        function salvaConfigurazioneConferma(config) {
            localStorage.setItem('conferma_colonne_config', JSON.stringify(config));
            console.log('ğŸ’¾ Configurazione colonne salvata');
        }
        
        /**
         * Reset configurazione a valori default
         */
        function resetConfigurazioneConferma() {
            localStorage.removeItem('conferma_colonne_config');
            const config = caricaConfigurazioneConferma();
            console.log('ğŸ”„ Configurazione resettata a default');
            return config;
        }
        
        /**
         * Toggle singola colonna on/off
         */
        function toggleColonnaConferma(colonnaKey) {
            const config = caricaConfigurazioneConferma();
            config[colonnaKey] = !config[colonnaKey];
            salvaConfigurazioneConferma(config);
            
            console.log(`ğŸ”„ Toggle colonna: ${colonnaKey} = ${config[colonnaKey]}`);
            
            // Rigenera documento se giÃ  aperto
            if (document.getElementById('conferma-modal-overlay')?.classList.contains('active')) {
                generaConfermaCliente();
            }
        }
        
        /**
         * Toggle gruppo colonne (es: tutti prezzi, tutti infissi)
         */
        function toggleGruppoColonne(gruppo, isEnabled) {
            const config = caricaConfigurazioneConferma();
            
            Object.keys(CONFERMA_CONFIG.colonneOpzionali).forEach(key => {
                if (CONFERMA_CONFIG.colonneOpzionali[key].gruppo === gruppo) {
                    config[key] = isEnabled;
                }
            });
            
            salvaConfigurazioneConferma(config);
            console.log(`ğŸ”„ Toggle gruppo ${gruppo}: ${isEnabled}`);
            
            // Rigenera documento se giÃ  aperto
            if (document.getElementById('conferma-modal-overlay')?.classList.contains('active')) {
                generaConfermaCliente();
            }
        }
        
        /**
         * Apre modale Conferma Cliente
         * Documento professionale per il cliente (1 pagina per posizione)
         */
        function apriConfermaCliente() {
            if (!appState.rilievoData) {
                alert('âš ï¸ Nessun progetto caricato!\n\nCarica prima un file JSON dal Blocco Generale.');
                return;
            }
            
            console.log('ğŸ“‹ Apertura Conferma Cliente...');
            
            // Crea modal se non esiste
            let overlay = document.getElementById('conferma-modal-overlay');
            if (!overlay) {
                overlay = document.createElement('div');
                overlay.id = 'conferma-modal-overlay';
                overlay.innerHTML = `
                    <div class="conferma-modal-container">
                        <div class="conferma-modal-header">
                            <h2 class="conferma-modal-title">ğŸ“‹ Conferma Cliente</h2>
                            <button class="conferma-modal-close" onclick="chiudiConfermaCliente()">Ã—</button>
                        </div>
                        
                        <div class="conferma-toolbar">
                            <button class="btn-settings" onclick="apriImpostazioniConferma()">
                                âš™ï¸ Impostazioni Colonne
                            </button>
                            
                            <label class="quick-toggle">
                                <input type="checkbox" id="toggle-prezzi" onchange="toggleQuickPrezzi()">
                                ğŸ’° Mostra Prezzi
                            </label>
                            
                            <label class="quick-toggle">
                                <input type="checkbox" id="toggle-note" onchange="toggleQuickNote()">
                                ğŸ“ Mostra Note
                            </label>
                            
                            <button class="btn-export" onclick="esportaConfermaClientePDF()">
                                ğŸ“„ Esporta PDF
                            </button>
                        </div>
                        
                        <div class="conferma-content" id="conferma-content">
                            <p style="text-align: center; padding: 40px; color: #64748b;">
                                Generazione documento in corso...
                            </p>
                        </div>
                    </div>
                `;
                overlay.addEventListener('click', function(e) {
                    if (e.target === overlay) {
                        chiudiConfermaCliente();
                    }
                });
                document.body.appendChild(overlay);
            }
            
            // Mostra modal
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Genera documento
            setTimeout(() => {
                generaDocumentoConferma();
            }, 100);
        }
        
        /**
         * Chiude modale Conferma Cliente
         */
        function chiudiConfermaCliente() {
            const overlay = document.getElementById('conferma-modal-overlay');
            if (overlay) {
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }
        
        // ============================================================================
        // TAB ANALISI COSTI INTEGRATI
        // ============================================================================
        
        /**
         * Switch tra tab Analisi Costi
         */
        function switchTabAnalisi(tabName) {
            // Aggiorna bottoni
            document.querySelectorAll('.tab-analisi').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Nascondi tutti i contenuti
            document.querySelectorAll('.tab-content-analisi').forEach(content => {
                content.style.display = 'none';
            });
            
            // Mostra contenuto selezionato
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            
            // Carica dati specifici per tab
            if (tabName === 'persiane') {
                // Dati giÃ  caricati all'apertura modal
            } else if (tabName === 'zanzariere') {
                caricaDatiListinoZanzariereDettaglio();
            }
            
            // Gestisci bottone export PDF (solo per riepilogo)
            const btnExport = document.getElementById('btn-export-pdf');
            if (btnExport) {
                btnExport.style.display = tabName === 'riepilogo' ? 'inline-block' : 'none';
            }
            
            console.log(`âœ… Tab Dettaglio Costi: ${tabName}`);
        }
        
        /**
         * Carica dati listino persiane (versione 2 per tab integrato)
         */
        function caricaDatiListinoPersiane2() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Info generale
            document.getElementById('listino-persiane-versione-2').textContent = listino.versione || 'N/D';
            document.getElementById('listino-persiane-data-2').textContent = listino.dataAggiornamento || 'N/D';
            document.getElementById('listino-persiane-fonte-2').textContent = listino.fonte || 'N/D';
            
            // Modelli
            const modelliHTML = Object.entries(listino.modelli).map(([nome, dati]) => {
                const tipologie = Object.keys(dati.prezzi);
                const totDimensioni = tipologie.reduce((sum, tip) => sum + Object.keys(dati.prezzi[tip]).length, 0);
                
                let dimensioniHTML = '';
                tipologie.forEach(tip => {
                    const dimensioni = Object.entries(dati.prezzi[tip]);
                    dimensioniHTML += `
                        <div style="margin-top: 0.75rem;">
                            <div style="font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">${tip}:</div>
                            <div class="dimensioni-grid">
                                ${dimensioni.map(([dim, prezzo]) => `
                                    <div class="dimensione-item">
                                        <span class="dimensione-size">${dim}</span>
                                        <span class="dimensione-price">â‚¬${prezzo.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                return `
                    <div class="modello-card">
                        <div class="modello-header">
                            <span class="modello-nome">${nome}</span>
                            <span class="modello-badge">${totDimensioni} dimensioni</span>
                        </div>
                        <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">${dati.descrizione}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: #9ca3af;">
                            <span>ğŸ“ Spessore: ${dati.spessore_anta}</span>
                            <span>ğŸ”§ Struttura: ${dati.struttura_esterna}</span>
                        </div>
                        ${dimensioniHTML}
                    </div>
                `;
            }).join('');
            document.getElementById('listino-persiane-modelli-2').innerHTML = modelliHTML;
            
            // Telai
            const telaiHTML = Object.entries(listino.telai).map(([codice, dati]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                    <div>
                        <span style="font-weight: 600; color: #1f2937;">${codice}</span>
                        <span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.875rem;">${dati.descrizione}</span>
                    </div>
                    <span style="font-weight: 700; color: #059669;">â‚¬${dati.prezzo.toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('listino-persiane-telai-2').innerHTML = telaiHTML;
            
            // Colori (mostra solo totale per categoria per non occupare troppo spazio)
            const coloriHTML = `
                <div style="margin-bottom: 1rem;">
                    <h5 style="margin-bottom: 0.5rem; color: #4b5563;">Categorie:</h5>
                    ${Object.entries(listino.colori.categorie).map(([cat, dati]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: #1f2937;">Cat. ${cat}</span>
                            <span style="color: #6b7280; flex: 1; margin: 0 1rem;">${dati.descrizione}</span>
                            <span style="font-weight: 700; color: ${dati.maggiorazione === 0 ? '#10b981' : '#f59e0b'};">
                                ${dati.maggiorazione !== null ? `+${dati.maggiorazione}%` : 'A preventivo'}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <p style="margin: 0; color: #6b7280; font-size: 0.875rem;">
                    ğŸ“ Totale: ${Object.keys(listino.colori.colori_specifici).length} colori disponibili
                </p>
            `;
            document.getElementById('listino-persiane-colori-2').innerHTML = coloriHTML;
            
            // Supplementi
            const supplementiHTML = `
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.375rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ’° Contributo Gestione:</span>
                        <span style="font-weight: 700; color: #92400e;">â‚¬${listino.supplementi.contributo_gestione.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ“¦ Imballo:</span>
                        <span style="font-weight: 700; color: #92400e;">+${listino.supplementi.imballo_percentuale}%</span>
                    </div>
                </div>
            `;
            document.getElementById('listino-persiane-supplementi-2').innerHTML = supplementiHTML;
        }
        
        /**
         * Popola select per test calcolo (versione 2 per tab integrato)
         */
        function popolaSelectTest2() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Modelli
            const selectModello = document.getElementById('test-modello-2');
            selectModello.innerHTML = '<option value="">Seleziona...</option>' + 
                Object.keys(listino.modelli).map(nome => 
                    `<option value="${nome}">${nome}</option>`
                ).join('');
            
            // Telai
            const selectTelaio = document.getElementById('test-telaio-2');
            selectTelaio.innerHTML = '<option value="">Nessuno</option>' +
                Object.keys(listino.telai).map(codice =>
                    `<option value="${codice}">${codice} - â‚¬${listino.telai[codice].prezzo}</option>`
                ).join('');
            
            // Colori
            const selectColore = document.getElementById('test-colore-2');
            selectColore.innerHTML = '<option value="">Nessuno</option>' +
                Object.entries(listino.colori.colori_specifici).map(([codice, dati]) =>
                    `<option value="${codice}">${codice} - ${dati.nome} (+${dati.maggiorazione}%)</option>`
                ).join('');
            
            // Event listener per modello â†’ aggiorna tipologie
            selectModello.addEventListener('change', function() {
                const modello = this.value;
                const selectTipologia = document.getElementById('test-tipologia-2');
                
                if (modello && listino.modelli[modello]) {
                    const tipologie = Object.keys(listino.modelli[modello].prezzi);
                    selectTipologia.innerHTML = '<option value="">Seleziona...</option>' +
                        tipologie.map(tip => `<option value="${tip}">${tip}</option>`).join('');
                    selectTipologia.disabled = false;
                } else {
                    selectTipologia.innerHTML = '<option value="">Seleziona modello prima</option>';
                    selectTipologia.disabled = true;
                }
            });
        }
        
        /**
         * Esegue test calcolo persiana (versione 2 per tab integrato)
         */
        function eseguiTestCalcolo2() {
            const modello = document.getElementById('test-modello-2').value;
            const tipologia = document.getElementById('test-tipologia-2').value;
            const larghezza = parseInt(document.getElementById('test-larghezza-2').value);
            const altezza = parseInt(document.getElementById('test-altezza-2').value);
            const telaio = document.getElementById('test-telaio-2').value;
            const colore = document.getElementById('test-colore-2').value;
            
            const risultatoDiv = document.getElementById('test-risultato-2');
            
            // Validazione
            if (!modello || !tipologia || !larghezza || !altezza) {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âš ï¸ Compilare tutti i campi obbligatori</p>
                    </div>
                `;
                return;
            }
            
            // Esegui calcolo
            const risultato = PreventivoCalculator.calcolaPersiana({
                modello: modello,
                tipologia: tipologia,
                larghezza: larghezza,
                altezza: altezza,
                telaio: telaio,
                colore: colore
            });
            
            if (risultato.successo) {
                const det = risultato.dettaglio;
                risultatoDiv.innerHTML = `
                    <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.375rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #065f46;">âœ… Calcolo Completato</h4>
                        
                        <div style="background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.875rem;">
                                <div style="color: #6b7280;">Prezzo Base (${tipologia} ${larghezza}x${altezza}):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.prezzo_base}</div>
                                
                                <div style="color: #6b7280;">Telaio ${telaio || '-'}:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.telaio}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Subtotale:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">â‚¬${det.subtotale}</div>
                                
                                <div style="color: #6b7280;">Colore ${colore || '-'} (+${det.colore_perc}%):</div>
                                <div style="font-weight: 600; color: #f59e0b;">â‚¬${det.maggiorazione_colore}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Totale Prodotto:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 700; color: #059669;">â‚¬${det.totale_prodotto}</div>
                                
                                <div style="color: #6b7280;">Contributo Gestione:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.contributo_gestione}</div>
                                
                                <div style="color: #6b7280;">Imballo (3%):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.imballo}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; color: #065f46; font-weight: 700; font-size: 1rem;">TOTALE FINALE:</div>
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; font-weight: 700; color: #059669; font-size: 1.25rem;">â‚¬${risultato.prezzi.totale}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">IVA 22%:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">â‚¬${risultato.prezzi.iva}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">Totale IVA inclusa:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem; font-weight: 600;">â‚¬${risultato.prezzi.totale_iva}</div>
                            </div>
                        </div>
                        
                        <p style="margin: 0; color: #047857; font-size: 0.875rem;">
                            ğŸ’¡ Formula: Base + Telaio + Colore% + Contributo + Imballo 3%
                        </p>
                    </div>
                `;
            } else {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âŒ Errore Calcolo</p>
                        <p style="margin: 0.5rem 0 0 0; color: #7f1d1d;">${risultato.errore}</p>
                        
                        <button onclick="apriModalPrezzoManuale({
                            modello: '${modello}',
                            tipologia: '${tipologia}',
                            larghezza: ${larghezza},
                            altezza: ${altezza},
                            telaio: '${telaio}',
                            colore: '${colore}',
                            posizioneIndex: -1
                        })" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; width: 100%;">
                            âœï¸ Inserisci Prezzo Manuale
                        </button>
                    </div>
                `;
            }
        }
        
        // ============================================================================
        // GESTIONE LISTINI (VECCHIA MODALE SEPARATA - DA RIMUOVERE)
        // ============================================================================
        
        /**
         * Apre modal gestione listini
         */
        function apriGestioneListini() {
            console.log('ğŸ“š Apertura gestione listini...');
            
            const modal = document.getElementById('listini-modal');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Carica dati listino persiane
                caricaDatiListinoPersiane();
                
                // Popola select test
                popolaSelectTest();
            }
        }
        
        /**
         * Chiude modal gestione listini
         */
        function chiudiGestioneListini() {
            const modal = document.getElementById('listini-modal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
            }
        }
        
        /**
         * Switch tra tab listini
         */
        function switchTabListini(tabName) {
            // Aggiorna bottoni
            document.querySelectorAll('.tab-listini').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Mostra content corretto
            document.querySelectorAll('.tab-content-listini').forEach(content => {
                content.style.display = 'none';
            });
            document.getElementById(`tab-content-${tabName}`).style.display = 'block';
            
            // Carica dati specifici
            if (tabName === 'persiane') {
                caricaDatiListinoPersiane();
            } else if (tabName === 'zanzariere') {
                caricaDatiListinoZanzariere();
            }
        }
        
        /**
         * Carica e visualizza dati listino persiane
         */
        function caricaDatiListinoPersiane() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Info generale
            document.getElementById('listino-persiane-versione').textContent = listino.versione || 'N/D';
            document.getElementById('listino-persiane-data').textContent = listino.dataAggiornamento || 'N/D';
            document.getElementById('listino-persiane-fonte').textContent = listino.fonte || 'N/D';
            
            // Modelli
            const modelliHTML = Object.entries(listino.modelli).map(([nome, dati]) => {
                const tipologie = Object.keys(dati.prezzi);
                const totDimensioni = tipologie.reduce((sum, tip) => sum + Object.keys(dati.prezzi[tip]).length, 0);
                
                let dimensioniHTML = '';
                tipologie.forEach(tip => {
                    const dimensioni = Object.entries(dati.prezzi[tip]);
                    dimensioniHTML += `
                        <div style="margin-top: 0.75rem;">
                            <div style="font-weight: 600; color: #6b7280; margin-bottom: 0.5rem;">${tip}:</div>
                            <div class="dimensioni-grid">
                                ${dimensioni.map(([dim, prezzo]) => `
                                    <div class="dimensione-item">
                                        <span class="dimensione-size">${dim}</span>
                                        <span class="dimensione-price">â‚¬${prezzo.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });
                
                return `
                    <div class="modello-card">
                        <div class="modello-header">
                            <span class="modello-nome">${nome}</span>
                            <span class="modello-badge">${totDimensioni} dimensioni</span>
                        </div>
                        <p style="margin: 0 0 0.5rem 0; color: #6b7280; font-size: 0.875rem;">${dati.descrizione}</p>
                        <div style="display: flex; gap: 1rem; font-size: 0.75rem; color: #9ca3af;">
                            <span>ğŸ“ Spessore: ${dati.spessore_anta}</span>
                            <span>ğŸ”§ Struttura: ${dati.struttura_esterna}</span>
                        </div>
                        ${dimensioniHTML}
                    </div>
                `;
            }).join('');
            document.getElementById('listino-persiane-modelli').innerHTML = modelliHTML;
            
            // Telai
            const telaiHTML = Object.entries(listino.telai).map(([codice, dati]) => `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.5rem;">
                    <div>
                        <span style="font-weight: 600; color: #1f2937;">${codice}</span>
                        <span style="color: #6b7280; margin-left: 0.5rem; font-size: 0.875rem;">${dati.descrizione}</span>
                    </div>
                    <span style="font-weight: 700; color: #059669;">â‚¬${dati.prezzo.toFixed(2)}</span>
                </div>
            `).join('');
            document.getElementById('listino-persiane-telai').innerHTML = telaiHTML;
            
            // Colori
            const coloriHTML = `
                <div style="margin-bottom: 1rem;">
                    <h5 style="margin-bottom: 0.5rem; color: #4b5563;">Categorie:</h5>
                    ${Object.entries(listino.colori.categorie).map(([cat, dati]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: #f9fafb; border-radius: 0.375rem; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: #1f2937;">Cat. ${cat}</span>
                            <span style="color: #6b7280; flex: 1; margin: 0 1rem;">${dati.descrizione}</span>
                            <span style="font-weight: 700; color: ${dati.maggiorazione === 0 ? '#10b981' : '#f59e0b'};">
                                ${dati.maggiorazione !== null ? `+${dati.maggiorazione}%` : 'A preventivo'}
                            </span>
                        </div>
                    `).join('')}
                </div>
                <div>
                    <h5 style="margin-bottom: 0.5rem; color: #4b5563;">Colori Specifici:</h5>
                    ${Object.entries(listino.colori.colori_specifici).map(([codice, dati]) => `
                        <div style="display: flex; justify-content: space-between; padding: 0.5rem; background: white; border: 1px solid #e5e7eb; border-radius: 0.375rem; margin-bottom: 0.25rem;">
                            <span style="font-weight: 600; color: #1f2937;">${codice}</span>
                            <span style="color: #6b7280; flex: 1; margin: 0 1rem; font-size: 0.875rem;">${dati.nome}</span>
                            <span style="background: #fef3c7; color: #92400e; padding: 0.125rem 0.5rem; border-radius: 9999px; font-size: 0.75rem; font-weight: 600;">Cat. ${dati.categoria}</span>
                            <span style="font-weight: 700; color: #f59e0b; margin-left: 0.5rem;">+${dati.maggiorazione}%</span>
                        </div>
                    `).join('')}
                </div>
            `;
            document.getElementById('listino-persiane-colori').innerHTML = coloriHTML;
            
            // Supplementi
            const supplementiHTML = `
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.375rem;">
                    <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ’° Contributo Gestione:</span>
                        <span style="font-weight: 700; color: #92400e;">â‚¬${listino.supplementi.contributo_gestione.toFixed(2)}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between;">
                        <span style="font-weight: 600; color: #92400e;">ğŸ“¦ Imballo:</span>
                        <span style="font-weight: 700; color: #92400e;">+${listino.supplementi.imballo_percentuale}%</span>
                    </div>
                </div>
            `;
            document.getElementById('listino-persiane-supplementi').innerHTML = supplementiHTML;
        }
        
        /**
         * Carica dati listino zanzariere
         */
        function caricaDatiListinoZanzariere() {
            const listino = PreventivoCalculator.listini.zanzariere;
            
            const html = `
                <h4 style="margin-bottom: 1rem; color: #374151;">Modelli Disponibili: ${listino.modelli.length}</h4>
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1rem;">
                    ${listino.modelli.map(mod => `
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1rem;">
                            <div style="font-weight: 700; color: #1f2937; margin-bottom: 0.5rem;">${mod.modello}</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem; font-size: 0.875rem;">
                                <div>Fascia 1: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_1}</span></div>
                                <div>Fascia 2: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_2}</span></div>
                                <div>Fascia 3: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_3}</span></div>
                                <div>Fascia 4: <span style="color: #059669; font-weight: 600;">â‚¬${mod.fascia_4}</span></div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('listino-zanzariere-content').innerHTML = html;
        }
        
        /**
         * Carica dati listino zanzariere per tab Dettaglio Costi
         */
        function caricaDatiListinoZanzariereDettaglio() {
            const listino = PreventivoCalculator.listini.zanzariere;
            
            const html = `
                <h4 style="margin-bottom: 1rem; color: #374151;">ğŸ“‹ Modelli Disponibili: ${listino.modelli.length}</h4>
                
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                    <p style="margin: 0; font-weight: 600; color: #92400e;">â„¹ï¸ Fasce di Prezzo per Superficie</p>
                    <div style="margin-top: 0.5rem; font-size: 0.875rem; color: #78350f;">
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 1: fino a 0.50 mÂ²</p>
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 2: da 0.51 a 1.50 mÂ²</p>
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 3: da 1.51 a 3.00 mÂ²</p>
                        <p style="margin: 0.25rem 0;">â€¢ Fascia 4: oltre 3.00 mÂ²</p>
                    </div>
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1rem;">
                    ${listino.modelli.map(mod => `
                        <div style="background: white; border: 2px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem; transition: all 0.2s;" 
                             onmouseenter="this.style.borderColor='#10b981'; this.style.boxShadow='0 4px 12px rgba(16,185,129,0.15)'"
                             onmouseleave="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none'">
                            <div style="font-weight: 700; font-size: 1.125rem; color: #1f2937; margin-bottom: 1rem; border-bottom: 2px solid #10b981; padding-bottom: 0.5rem;">
                                ${mod.modello}
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem;">
                                <div style="background: #f0fdf4; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 1</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_1}</div>
                                </div>
                                <div style="background: #ecfdf5; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 2</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_2}</div>
                                </div>
                                <div style="background: #d1fae5; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 3</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_3}</div>
                                </div>
                                <div style="background: #a7f3d0; padding: 0.5rem; border-radius: 0.375rem;">
                                    <div style="font-size: 0.75rem; color: #047857; font-weight: 600; margin-bottom: 0.25rem;">FASCIA 4</div>
                                    <div style="font-size: 1.25rem; color: #059669; font-weight: 700;">â‚¬${mod.fascia_4}</div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
            
            document.getElementById('listino-zanzariere-content-dettaglio').innerHTML = html;
        }
        
        /**
         * Popola select per test calcolo
         */
        function popolaSelectTest() {
            const listino = PreventivoCalculator.listini.persiane;
            
            // Modelli
            const selectModello = document.getElementById('test-modello');
            selectModello.innerHTML = '<option value="">Seleziona...</option>' + 
                Object.keys(listino.modelli).map(nome => 
                    `<option value="${nome}">${nome}</option>`
                ).join('');
            
            // Telai
            const selectTelaio = document.getElementById('test-telaio');
            selectTelaio.innerHTML = '<option value="">Nessuno</option>' +
                Object.keys(listino.telai).map(codice =>
                    `<option value="${codice}">${codice} - â‚¬${listino.telai[codice].prezzo}</option>`
                ).join('');
            
            // Colori
            const selectColore = document.getElementById('test-colore');
            selectColore.innerHTML = '<option value="">Nessuno</option>' +
                Object.entries(listino.colori.colori_specifici).map(([codice, dati]) =>
                    `<option value="${codice}">${codice} - ${dati.nome} (+${dati.maggiorazione}%)</option>`
                ).join('');
            
            // Event listener per modello â†’ aggiorna tipologie
            selectModello.addEventListener('change', function() {
                const modello = this.value;
                const selectTipologia = document.getElementById('test-tipologia');
                
                if (modello && listino.modelli[modello]) {
                    const tipologie = Object.keys(listino.modelli[modello].prezzi);
                    selectTipologia.innerHTML = '<option value="">Seleziona...</option>' +
                        tipologie.map(tip => `<option value="${tip}">${tip}</option>`).join('');
                    selectTipologia.disabled = false;
                } else {
                    selectTipologia.innerHTML = '<option value="">Seleziona modello prima</option>';
                    selectTipologia.disabled = true;
                }
            });
        }
        
        /**
         * Esegue test calcolo persiana
         */
        function eseguiTestCalcolo() {
            const modello = document.getElementById('test-modello').value;
            const tipologia = document.getElementById('test-tipologia').value;
            const larghezza = parseInt(document.getElementById('test-larghezza').value);
            const altezza = parseInt(document.getElementById('test-altezza').value);
            const telaio = document.getElementById('test-telaio').value;
            const colore = document.getElementById('test-colore').value;
            
            const risultatoDiv = document.getElementById('test-risultato');
            
            // Validazione
            if (!modello || !tipologia || !larghezza || !altezza) {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âš ï¸ Compilare tutti i campi obbligatori</p>
                    </div>
                `;
                return;
            }
            
            // Esegui calcolo
            const risultato = PreventivoCalculator.calcolaPersiana({
                modello: modello,
                tipologia: tipologia,
                larghezza: larghezza,
                altezza: altezza,
                telaio: telaio,
                colore: colore
            });
            
            if (risultato.successo) {
                const det = risultato.dettaglio;
                risultatoDiv.innerHTML = `
                    <div style="background: #d1fae5; border-left: 4px solid #10b981; padding: 1rem; border-radius: 0.375rem;">
                        <h4 style="margin: 0 0 1rem 0; color: #065f46;">âœ… Calcolo Completato</h4>
                        
                        <div style="background: white; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem;">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.875rem;">
                                <div style="color: #6b7280;">Prezzo Base (${tipologia} ${larghezza}x${altezza}):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.prezzo_base}</div>
                                
                                <div style="color: #6b7280;">Telaio ${telaio || '-'}:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.telaio}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Subtotale:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;">â‚¬${det.subtotale}</div>
                                
                                <div style="color: #6b7280;">Colore ${colore || '-'} (+${det.colore_perc}%):</div>
                                <div style="font-weight: 600; color: #f59e0b;">â‚¬${det.maggiorazione_colore}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Totale Prodotto:</div>
                                <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 700; color: #059669;">â‚¬${det.totale_prodotto}</div>
                                
                                <div style="color: #6b7280;">Contributo Gestione:</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.contributo_gestione}</div>
                                
                                <div style="color: #6b7280;">Imballo (3%):</div>
                                <div style="font-weight: 600; color: #1f2937;">â‚¬${det.imballo}</div>
                                
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; color: #065f46; font-weight: 700; font-size: 1rem;">TOTALE FINALE:</div>
                                <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; font-weight: 700; color: #059669; font-size: 1.25rem;">â‚¬${risultato.prezzi.totale}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">IVA 22%:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem;">â‚¬${risultato.prezzi.iva}</div>
                                
                                <div style="color: #9ca3af; font-size: 0.75rem;">Totale IVA inclusa:</div>
                                <div style="color: #9ca3af; font-size: 0.75rem; font-weight: 600;">â‚¬${risultato.prezzi.totale_iva}</div>
                            </div>
                        </div>
                        
                        <p style="margin: 0; color: #047857; font-size: 0.875rem;">
                            ğŸ’¡ Formula: Base + Telaio + Colore% + Contributo + Imballo 3%
                        </p>
                    </div>
                `;
            } else {
                risultatoDiv.innerHTML = `
                    <div style="background: #fee2e2; border-left: 4px solid #ef4444; padding: 1rem; border-radius: 0.375rem;">
                        <p style="margin: 0; color: #991b1b; font-weight: 600;">âŒ Errore Calcolo</p>
                        <p style="margin: 0.5rem 0 0 0; color: #7f1d1d;">${risultato.errore}</p>
                        
                        <button onclick="apriModalPrezzoManuale({
                            modello: '${modello}',
                            tipologia: '${tipologia}',
                            larghezza: ${larghezza},
                            altezza: ${altezza},
                            telaio: '${telaio}',
                            colore: '${colore}',
                            posizioneIndex: -1
                        })" style="margin-top: 1rem; padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer; width: 100%;">
                            âœï¸ Inserisci Prezzo Manuale
                        </button>
                    </div>
                `;
            }
        }
        
        // ============================================================================
        // INSERIMENTO MANUALE PREZZI PERSIANE
        // ============================================================================
        
        let datiModalPrezzoManuale = null;
        
        /**
         * Apre modal inserimento manuale prezzo persiana
         */
        function apriModalPrezzoManuale(datiPersiana) {
            console.log('âš ï¸ Apertura modal prezzo manuale...', datiPersiana);
            
            // Salva dati per uso successivo
            datiModalPrezzoManuale = datiPersiana;
            
            // Mostra info dimensione
            const infoText = `Modello: ${datiPersiana.modello} | Tipologia: ${datiPersiana.tipologia || 'N/D'} | Dimensioni: ${datiPersiana.larghezza}x${datiPersiana.altezza} mm`;
            document.getElementById('dimensione-mancante-info').textContent = infoText;
            
            // Reset form
            document.getElementById('input-prezzo-base-manuale').value = '';
            document.getElementById('input-telaio-manuale').value = '';
            document.getElementById('input-colore-perc-manuale').value = '';
            document.getElementById('input-note-manuale').value = '';
            document.getElementById('anteprima-calcolo-manuale').style.display = 'none';
            document.getElementById('btn-salva-prezzo-manuale').disabled = true;
            document.getElementById('btn-salva-prezzo-manuale').style.opacity = '0.5';
            
            // Mostra modal
            const modal = document.getElementById('modal-prezzo-manuale');
            if (modal) {
                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
                
                // Focus su input prezzo base
                setTimeout(() => {
                    document.getElementById('input-prezzo-base-manuale').focus();
                }, 100);
            }
        }
        
        /**
         * Chiude modal inserimento manuale
         */
        function chiudiModalPrezzoManuale() {
            const modal = document.getElementById('modal-prezzo-manuale');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = '';
                datiModalPrezzoManuale = null;
            }
        }
        
        /**
         * Calcola anteprima con valori manuali
         */
        function calcolaAnteprimaManuale() {
            const prezzoBase = parseFloat(document.getElementById('input-prezzo-base-manuale').value) || 0;
            const prezzoTelaio = parseFloat(document.getElementById('input-telaio-manuale').value) || 0;
            const colorePerc = parseFloat(document.getElementById('input-colore-perc-manuale').value) || 0;
            
            if (prezzoBase <= 0) {
                alert('âš ï¸ Inserire un prezzo base valido');
                return;
            }
            
            // Calcolo
            const subtotale = prezzoBase + prezzoTelaio;
            const maggiorazioneColore = subtotale * (colorePerc / 100);
            const totaleProdotto = subtotale + maggiorazioneColore;
            const contributo = 57.00;
            const conContributo = totaleProdotto + contributo;
            const imballo = conContributo * 0.03;
            const totaleFinale = conContributo + imballo;
            
            // Mostra anteprima
            document.getElementById('preview-base').textContent = `â‚¬${prezzoBase.toFixed(2)}`;
            document.getElementById('preview-telaio').textContent = `â‚¬${prezzoTelaio.toFixed(2)}`;
            document.getElementById('preview-subtotale').textContent = `â‚¬${subtotale.toFixed(2)}`;
            document.getElementById('preview-colore').textContent = `â‚¬${maggiorazioneColore.toFixed(2)} (+${colorePerc}%)`;
            document.getElementById('preview-totale-prodotto').textContent = `â‚¬${totaleProdotto.toFixed(2)}`;
            document.getElementById('preview-imballo').textContent = `â‚¬${imballo.toFixed(2)}`;
            document.getElementById('preview-finale').textContent = `â‚¬${totaleFinale.toFixed(2)}`;
            
            document.getElementById('anteprima-calcolo-manuale').style.display = 'block';
            
            // Abilita bottone salva
            document.getElementById('btn-salva-prezzo-manuale').disabled = false;
            document.getElementById('btn-salva-prezzo-manuale').style.opacity = '1';
            
            console.log('âœ… Anteprima calcolata:', {
                base: prezzoBase,
                telaio: prezzoTelaio,
                colore: maggiorazioneColore,
                totale: totaleFinale
            });
        }
        
        /**
         * Salva prezzo manuale nel progetto
         */
        function salvaPrezzoManuale() {
            if (!datiModalPrezzoManuale) {
                alert('âŒ Errore: dati persiana non disponibili');
                return;
            }
            
            const prezzoBase = parseFloat(document.getElementById('input-prezzo-base-manuale').value) || 0;
            const prezzoTelaio = parseFloat(document.getElementById('input-telaio-manuale').value) || 0;
            const colorePerc = parseFloat(document.getElementById('input-colore-perc-manuale').value) || 0;
            const note = document.getElementById('input-note-manuale').value.trim();
            
            if (prezzoBase <= 0) {
                alert('âš ï¸ Inserire un prezzo base valido');
                return;
            }
            
            // Calcolo totale
            const subtotale = prezzoBase + prezzoTelaio;
            const maggiorazioneColore = subtotale * (colorePerc / 100);
            const totaleProdotto = subtotale + maggiorazioneColore;
            const contributo = 57.00;
            const conContributo = totaleProdotto + contributo;
            const imballo = conContributo * 0.03;
            const totaleFinale = conContributo + imballo;
            
            // Crea oggetto prezzo manuale
            const prezzoManuale = {
                tipo: 'manuale',
                data: new Date().toISOString(),
                prezzoBase: prezzoBase,
                prezzoTelaio: prezzoTelaio,
                colorePercentuale: colorePerc,
                maggiorazioneColore: maggiorazioneColore,
                totaleProdotto: totaleProdotto,
                contributo: contributo,
                imballo: imballo,
                totaleFinale: totaleFinale,
                note: note,
                dimensione: `${datiModalPrezzoManuale.larghezza}x${datiModalPrezzoManuale.altezza}`
            };
            
            // Salva in currentProject
            if (!currentProject || !currentProject.posizioni) {
                alert('âŒ Errore: nessun progetto caricato');
                return;
            }
            
            // Trova posizione con questa persiana
            const posIndex = datiModalPrezzoManuale.posizioneIndex;
            if (posIndex !== undefined && currentProject.posizioni[posIndex]) {
                if (!currentProject.posizioni[posIndex].persiana) {
                    currentProject.posizioni[posIndex].persiana = {};
                }
                currentProject.posizioni[posIndex].persiana.prezzoManuale = prezzoManuale;
                
                console.log('âœ… Prezzo manuale salvato:', prezzoManuale);
                
                // Sync su GitHub
                if (window.projectManager) {
                    window.projectManager.syncToGitHub(currentProject).then(() => {
                        console.log('âœ… Progetto sincronizzato su GitHub');
                        alert(`âœ… Prezzo manuale salvato!\n\nTotale: â‚¬${totaleFinale.toFixed(2)}\n\n${note ? 'Note: ' + note : ''}`);
                        chiudiModalPrezzoManuale();
                        
                        // Refresh visualizzazione se necessario
                        if (currentBlocco === 'ufficio' || currentBlocco === 'preventivo') {
                            loadProjectData(currentProject);
                        }
                    }).catch(err => {
                        console.error('âŒ Errore sync GitHub:', err);
                        alert('âš ï¸ Prezzo salvato localmente, ma sync GitHub fallito.\nRiprova piÃ¹ tardi.');
                        chiudiModalPrezzoManuale();
                    });
                } else {
                    alert(`âœ… Prezzo manuale salvato!\n\nTotale: â‚¬${totaleFinale.toFixed(2)}\n\nâš ï¸ Sync GitHub non disponibile`);
                    chiudiModalPrezzoManuale();
                }
            } else {
                alert('âŒ Errore: posizione non trovata');
            }
        }
        
        // Event listeners per calcolo automatico anteprima
        document.addEventListener('DOMContentLoaded', function() {
            ['input-prezzo-base-manuale', 'input-telaio-manuale', 'input-colore-perc-manuale'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', function() {
                        // Auto-calcola se prezzo base presente
                        const prezzoBase = parseFloat(document.getElementById('input-prezzo-base-manuale').value);
                        if (prezzoBase > 0) {
                            // Non auto-calcolare, utente deve cliccare bottone
                            // Questo evita calcoli continui durante la digitazione
                        }
                    });
                }
            });
        });
        
        // ============================================================================
        
        /**
         * Apre modal impostazioni colonne
         */
        function apriImpostazioniConferma() {
            console.log('âš™ï¸ Apertura impostazioni colonne...');
            
            // Crea modal impostazioni se non esiste
            let modal = document.getElementById('modal-impostazioni-conferma');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'modal-impostazioni-conferma';
                modal.innerHTML = generaHTMLImpostazioni();
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        chiudiImpostazioniConferma();
                    }
                });
                document.body.appendChild(modal);
            }
            
            // Popola checkbox con configurazione corrente
            aggiornaUIImpostazioni();
            
            // Mostra modal
            modal.classList.add('active');
        }
        
        /**
         * Chiude modal impostazioni
         */
        function chiudiImpostazioniConferma() {
            const modal = document.getElementById('modal-impostazioni-conferma');
            if (modal) {
                modal.classList.remove('active');
            }
        }
        
        /**
         * Genera HTML modal impostazioni
         */
        function generaHTMLImpostazioni() {
            return `
                <div class="modal-impostazioni-content" onclick="event.stopPropagation()">
                    <div class="modal-impostazioni-header">
                        <h2>âš™ï¸ Impostazioni Colonne</h2>
                        <button class="conferma-modal-close" onclick="chiudiImpostazioniConferma()">Ã—</button>
                    </div>
                    
                    <div class="modal-impostazioni-body">
                        <div class="settings-section">
                            <h3>ğŸªŸ Infissi</h3>
                            <label><input type="checkbox" data-col="infisso_azienda"> Azienda Infisso</label>
                            <label><input type="checkbox" data-col="infisso_telaio"> Telaio</label>
                            <label><input type="checkbox" data-col="infisso_materiale"> Materiale</label>
                            <label><input type="checkbox" data-col="infisso_vetro"> Vetro</label>
                            <label><input type="checkbox" data-col="infisso_coloreInterno"> Colore Interno</label>
                            <label><input type="checkbox" data-col="infisso_coloreEsterno"> Colore Esterno</label>
                            <label><input type="checkbox" data-col="infisso_maniglia"> Maniglia</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸšª Persiane</h3>
                            <label><input type="checkbox" data-col="persiana_azienda"> Azienda Persiana</label>
                            <label><input type="checkbox" data-col="persiana_tipo"> Tipo Persiana</label>
                            <label><input type="checkbox" data-col="persiana_colore"> Colore Persiana</label>
                            <label><input type="checkbox" data-col="persiana_oscurante"> Oscurante</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ“œ Tapparelle</h3>
                            <label><input type="checkbox" data-col="tapparella_azienda"> Azienda Tapparella</label>
                            <label><input type="checkbox" data-col="tapparella_tipo"> Tipo Tapparella</label>
                            <label><input type="checkbox" data-col="tapparella_colore"> Colore Tapparella</label>
                            <label><input type="checkbox" data-col="tapparella_automazione"> Automazione</label>
                            <label><input type="checkbox" data-col="tapparella_guida"> Guida Tapparella</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ¦Ÿ Zanzariere</h3>
                            <label><input type="checkbox" data-col="zanzariera_azienda"> Azienda Zanzariera</label>
                            <label><input type="checkbox" data-col="zanzariera_tipo"> Tipo Zanzariera</label>
                            <label><input type="checkbox" data-col="zanzariera_colore"> Colore Zanzariera</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ“¦ Cassonetti</h3>
                            <label><input type="checkbox" data-col="cassonetto_azienda"> Azienda Cassonetto</label>
                            <label><input type="checkbox" data-col="cassonetto_tipo"> Tipo Cassonetto</label>
                            <label><input type="checkbox" data-col="cassonetto_isolamento"> Isolamento</label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ’° Prezzi</h3>
                            <label>
                                <input type="checkbox" data-col="prezzo_calcolato"> 
                                Prezzo Calcolato <small>(da analisi costi)</small>
                            </label>
                            <label>
                                <input type="checkbox" data-col="prezzo_editabile"> 
                                Campo Prezzo Vuoto <small>(per compilazione manuale)</small>
                            </label>
                        </div>
                        
                        <div class="settings-section">
                            <h3>ğŸ“ Altro</h3>
                            <label><input type="checkbox" data-col="note"> Note</label>
                        </div>
                    </div>
                    
                    <div class="modal-impostazioni-actions">
                        <button class="btn-salva" onclick="salvaImpostazioniConferma()">ğŸ’¾ Salva</button>
                        <button class="btn-reset" onclick="resetImpostazioniConfermaUI()">ğŸ”„ Reset Default</button>
                        <button class="btn-chiudi" onclick="chiudiImpostazioniConferma()">âœ–ï¸ Chiudi</button>
                    </div>
                </div>
            `;
        }
        
        /**
         * Aggiorna UI impostazioni con configurazione corrente
         */
        function aggiornaUIImpostazioni() {
            const config = caricaConfigurazioneConferma();
            
            // Aggiorna tutti i checkbox
            document.querySelectorAll('#modal-impostazioni-conferma [data-col]').forEach(checkbox => {
                const col = checkbox.getAttribute('data-col');
                checkbox.checked = config[col] || false;
            });
        }
        
        /**
         * Salva impostazioni da UI
         */
        function salvaImpostazioniConferma() {
            const config = {};
            
            // Leggi tutti i checkbox
            document.querySelectorAll('#modal-impostazioni-conferma [data-col]').forEach(checkbox => {
                const col = checkbox.getAttribute('data-col');
                config[col] = checkbox.checked;
            });
            
            // Salva configurazione
            salvaConfigurazioneConferma(config);
            
            // Rigenera documento
            generaDocumentoConferma();
            
            // Chiudi modal
            chiudiImpostazioniConferma();
            
            showAlert('success', 'âœ… Impostazioni salvate!');
        }
        
        /**
         * Reset impostazioni a default da UI
         */
        function resetImpostazioniConfermaUI() {
            if (confirm('ğŸ”„ Reset configurazione colonne ai valori di default?')) {
                resetConfigurazioneConferma();
                aggiornaUIImpostazioni();
                showAlert('success', 'ğŸ”„ Configurazione resettata!');
            }
        }
        
        /**
         * Quick toggle prezzi dalla toolbar
         */
        function toggleQuickPrezzi() {
            const isChecked = document.getElementById('toggle-prezzi').checked;
            toggleGruppoColonne('prezzi', isChecked);
        }
        
        /**
         * Quick toggle note dalla toolbar
         */
        function toggleQuickNote() {
            const isChecked = document.getElementById('toggle-note').checked;
            toggleColonnaConferma('note');
        }
        
        /**
         * Genera documento conferma (placeholder Step 6)
         */
        // ============================================================================
        // âœ… GENERAZIONE DOCUMENTO CONFERMA - STEP 6
        // ============================================================================
        
        /**
         * Genera sezione Infisso per una posizione
         */
        function generaSezioneInfisso(infisso, config) {
            if (!infisso || !infisso.quantita || infisso.quantita === 0) return '';
            
            let html = '<div class="sezione-infisso"><h3>ğŸªŸ INFISSO</h3>';
            
            if (config.infisso_azienda && infisso.azienda) {
                html += `<p><strong>Azienda:</strong> ${infisso.azienda}</p>`;
            }
            if (config.infisso_telaio && infisso.telaio) {
                html += `<p><strong>Telaio:</strong> ${infisso.telaio}</p>`;
            }
            if (config.infisso_materiale && infisso.materialeTelaio) {
                html += `<p><strong>Materiale:</strong> ${infisso.materialeTelaio}</p>`;
            }
            if (config.infisso_vetro && infisso.vetro) {
                html += `<p><strong>Vetro:</strong> ${infisso.vetro}</p>`;
            }
            if (config.infisso_coloreInterno && infisso.coloreInterno) {
                html += `<p><strong>Colore Interno:</strong> ${infisso.coloreInterno}</p>`;
            }
            if (config.infisso_coloreEsterno && infisso.coloreEsterno) {
                html += `<p><strong>Colore Esterno:</strong> ${infisso.coloreEsterno}</p>`;
            }
            if (config.infisso_maniglia && infisso.maniglia) {
                let manigliaText = infisso.maniglia;
                if (infisso.coloreManiglia) {
                    manigliaText += ` (${infisso.coloreManiglia})`;
                }
                html += `<p><strong>Maniglia:</strong> ${manigliaText}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${infisso.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Persiana per una posizione
         */
        function generaSezionePersiana(persiana, config) {
            if (!persiana || !persiana.quantita || persiana.quantita === 0) return '';
            
            let html = '<div class="sezione-persiana"><h3>ğŸšª PERSIANA</h3>';
            
            if (config.persiana_azienda && persiana.azienda) {
                html += `<p><strong>Azienda:</strong> ${persiana.azienda}</p>`;
            }
            if (config.persiana_tipo && persiana.tipo) {
                html += `<p><strong>Tipo:</strong> ${persiana.tipo}</p>`;
            }
            if (config.persiana_colore && persiana.colore) {
                html += `<p><strong>Colore:</strong> ${persiana.colore}</p>`;
            }
            if (config.persiana_oscurante && persiana.oscurante) {
                html += `<p><strong>Oscurante:</strong> ${persiana.oscurante}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${persiana.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Tapparella per una posizione
         */
        function generaSezioneTapparella(tapparella, config) {
            if (!tapparella || !tapparella.quantita || tapparella.quantita === 0) return '';
            
            let html = '<div class="sezione-tapparella"><h3>ğŸ“œ TAPPARELLA</h3>';
            
            if (config.tapparella_azienda && tapparella.azienda) {
                html += `<p><strong>Azienda:</strong> ${tapparella.azienda}</p>`;
            }
            if (config.tapparella_tipo && tapparella.tipo) {
                html += `<p><strong>Tipo:</strong> ${tapparella.tipo}</p>`;
            }
            if (config.tapparella_colore && tapparella.colore) {
                html += `<p><strong>Colore:</strong> ${tapparella.colore}</p>`;
            }
            if (config.tapparella_automazione && tapparella.automazione) {
                html += `<p><strong>Automazione:</strong> ${tapparella.automazione}</p>`;
            }
            if (config.tapparella_guida && tapparella.guida) {
                html += `<p><strong>Guida:</strong> ${tapparella.guida}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${tapparella.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Zanzariera per una posizione
         */
        function generaSezioneZanzariera(zanzariera, config) {
            if (!zanzariera || !zanzariera.quantita || zanzariera.quantita === 0) return '';
            
            let html = '<div class="sezione-zanzariera"><h3>ğŸ¦Ÿ ZANZARIERA</h3>';
            
            if (config.zanzariera_azienda && zanzariera.azienda) {
                html += `<p><strong>Azienda:</strong> ${zanzariera.azienda}</p>`;
            }
            if (config.zanzariera_tipo && zanzariera.tipo) {
                html += `<p><strong>Tipo:</strong> ${zanzariera.tipo}</p>`;
            }
            if (config.zanzariera_colore && zanzariera.colore) {
                html += `<p><strong>Colore:</strong> ${zanzariera.colore}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${zanzariera.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Cassonetto per una posizione
         */
        function generaSezioneCassonetto(cassonetto, config) {
            if (!cassonetto || !cassonetto.quantita || cassonetto.quantita === 0) return '';
            
            let html = '<div class="sezione-cassonetto"><h3>ğŸ“¦ CASSONETTO</h3>';
            
            if (config.cassonetto_azienda && cassonetto.azienda) {
                html += `<p><strong>Azienda:</strong> ${cassonetto.azienda}</p>`;
            }
            if (config.cassonetto_tipo && cassonetto.tipo) {
                html += `<p><strong>Tipo:</strong> ${cassonetto.tipo}</p>`;
            }
            if (config.cassonetto_isolamento && cassonetto.isolamento) {
                html += `<p><strong>Isolamento:</strong> ${cassonetto.isolamento}</p>`;
            }
            
            html += `<p><strong>QuantitÃ :</strong> ${cassonetto.quantita}</p>`;
            html += '</div>';
            
            return html;
        }
        
        /**
         * Genera sezione Prezzi per una posizione
         */
        function generaSezionePrezzi(posizione, config) {
            if (!config.prezzo_calcolato && !config.prezzo_editabile) return '';
            
            let html = '<div class="sezione-prezzi"><h3>ğŸ’° PREZZO</h3>';
            
            if (config.prezzo_calcolato) {
                // Calcola prezzo totale posizione
                let totale = 0;
                if (posizione.infisso && posizione.infisso.prezzo) {
                    totale += parseFloat(posizione.infisso.prezzo) || 0;
                }
                if (posizione.persiana && posizione.persiana.prezzo) {
                    totale += parseFloat(posizione.persiana.prezzo) || 0;
                }
                if (posizione.tapparella && posizione.tapparella.prezzo) {
                    totale += parseFloat(posizione.tapparella.prezzo) || 0;
                }
                if (posizione.zanzariera && posizione.zanzariera.prezzo) {
                    totale += parseFloat(posizione.zanzariera.prezzo) || 0;
                }
                if (posizione.cassonetto && posizione.cassonetto.prezzo) {
                    totale += parseFloat(posizione.cassonetto.prezzo) || 0;
                }
                
                html += `<p><strong>Prezzo Totale Calcolato:</strong> â‚¬ ${totale.toFixed(2)}</p>`;
            }
            
            if (config.prezzo_editabile) {
                html += `
                    <div class="campo-prezzo-editabile">
                        <p><em>Campo prezzo da compilare manualmente in Odoo</em></p>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }
        
        /**
         * Genera documento Conferma Cliente completo
         */
        function generaDocumentoConferma() {
            const content = document.getElementById('conferma-content');
            if (!content) return;
            
            const data = appState.rilievoData;
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                content.innerHTML = `
                    <div style="padding: 40px; text-align: center; color: #64748b;">
                        <p>âš ï¸ Nessuna posizione disponibile nel progetto</p>
                    </div>
                `;
                return;
            }
            
            console.log('ğŸ“‹ Generazione documento conferma...');
            console.log(`   Posizioni: ${data.posizioni.length}`);
            
            // Carica configurazione colonne
            const config = caricaConfigurazioneConferma();
            console.log('   Configurazione colonne:', config);
            
            // Aggiorna stato quick toggles
            const hasPrezzi = config.prezzo_calcolato || config.prezzo_editabile;
            const togglePrezzi = document.getElementById('toggle-prezzi');
            const toggleNote = document.getElementById('toggle-note');
            if (togglePrezzi) togglePrezzi.checked = hasPrezzi;
            if (toggleNote) toggleNote.checked = config.note || false;
            
            // Genera HTML documento
            let html = `
                <div style="text-align: center; margin-bottom: 40px; padding: 30px; background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-radius: 12px;">
                    <h1 style="color: #2563eb; margin: 0 0 10px 0;">ğŸ“‹ Conferma Cliente</h1>
                    <p style="color: #1e40af; font-size: 1.1rem; margin: 0;">
                        <strong>${data.cliente_nome || 'Cliente'}</strong>
                    </p>
                    <p style="color: #64748b; margin: 5px 0 0 0;">
                        ${data.cliente_indirizzo || ''} ${data.cliente_citta ? '- ' + data.cliente_citta : ''}
                    </p>
                    <p style="color: #64748b; margin: 5px 0 0 0;">
                        Data: ${data.data_rilievo || new Date().toLocaleDateString('it-IT')}
                    </p>
                </div>
            `;
            
            // Genera pagina per ogni posizione
            data.posizioni.forEach((pos, index) => {
                html += '<div class="conferma-page">';
                
                // Header posizione
                html += `
                    <h2>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</h2>
                    <h2>POSIZIONE ${index + 1}: ${pos.nome || 'Senza nome'}</h2>
                    <h2>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”</h2>
                `;
                
                // Sezione Misure (sempre presente)
                html += `
                    <div class="sezione-misure">
                        <h3>ğŸ“ MISURE</h3>
                        <p><strong>Larghezza:</strong> ${pos.larghezza || 'N/D'} cm</p>
                        <p><strong>Altezza:</strong> ${pos.altezza || 'N/D'} cm</p>
                    </div>
                `;
                
                // Sezioni prodotti (solo se presenti e colonne attive)
                html += generaSezioneInfisso(pos.infisso, config);
                html += generaSezionePersiana(pos.persiana, config);
                html += generaSezioneTapparella(pos.tapparella, config);
                html += generaSezioneZanzariera(pos.zanzariera, config);
                html += generaSezioneCassonetto(pos.cassonetto, config);
                
                // Sezione Prezzi (se attivata)
                html += generaSezionePrezzi(pos, config);
                
                // Sezione Note (se attivata e presenti)
                if (config.note && pos.note) {
                    html += `
                        <div class="sezione-note">
                            <h3>ğŸ“ NOTE</h3>
                            <p>${pos.note}</p>
                        </div>
                    `;
                }
                
                html += '</div>'; // chiudi conferma-page
                
                // Page break (tranne ultima posizione)
                if (index < data.posizioni.length - 1) {
                    html += '<div class="page-break"></div>';
                }
            });
            
            // Inserisci nel DOM
            content.innerHTML = html;
            
            console.log('âœ… Documento generato con successo!');
            console.log(`   Pagine: ${data.posizioni.length}`);
        }
        
        /**
         * Esporta PDF (placeholder Step 7)
         */
        /**
         * Esporta Conferma Cliente come PDF
         * Usa window.print() con CSS ottimizzato per stampa
         */
        function esportaConfermaClientePDF() {
            const content = document.getElementById('conferma-content');
            if (!content || !content.innerHTML.trim()) {
                alert('âš ï¸ Nessun documento da esportare!\n\nGenera prima il documento Conferma Cliente.');
                return;
            }
            
            const data = appState.rilievoData;
            if (!data) {
                alert('âš ï¸ Dati progetto non disponibili!');
                return;
            }
            
            console.log('ğŸ“„ Preparazione export PDF...');
            
            // Prepara nome file suggerito
            const nomeCliente = (data.cliente_nome || 'Cliente').replace(/[^a-z0-9]/gi, '-');
            const dataOggi = new Date().toLocaleDateString('it-IT').replace(/\//g, '-');
            const nomeFile = `Conferma-Cliente-${nomeCliente}-${dataOggi}`;
            
            // Crea finestra stampa
            const printWindow = window.open('', '_blank', 'width=1000,height=800');
            if (!printWindow) {
                alert('âš ï¸ Impossibile aprire finestra di stampa!\n\nVerifica che il browser consenta i popup.');
                return;
            }
            
            // Genera HTML per stampa
            const htmlContent = `
<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${nomeFile}</title>
    <style>
        /* Reset e Base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            font-size: 11pt;
            line-height: 1.5;
            color: #1e293b;
            background: white;
            padding: 0;
            margin: 0;
        }
        
        /* Configurazione pagina */
        @page {
            size: A4;
            margin: 2cm;
        }
        
        /* Header documento */
        .document-header {
            text-align: center;
            margin-bottom: 30px;
            padding: 25px;
            background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%);
            border-radius: 12px;
            border: 2px solid #3b82f6;
        }
        
        .document-header h1 {
            color: #2563eb;
            font-size: 24pt;
            margin-bottom: 10px;
        }
        
        .document-header .cliente-nome {
            font-size: 14pt;
            font-weight: 600;
            color: #1e40af;
            margin: 5px 0;
        }
        
        .document-header .cliente-info {
            font-size: 10pt;
            color: #64748b;
            margin: 3px 0;
        }
        
        /* Pagina posizione */
        .conferma-page {
            page-break-after: always;
            padding: 20px 0;
        }
        
        .conferma-page:last-child {
            page-break-after: auto;
        }
        
        /* Header posizione */
        .conferma-page h2 {
            color: #2563eb;
            border-bottom: 3px solid #2563eb;
            padding-bottom: 8px;
            margin: 15px 0;
            font-size: 16pt;
        }
        
        .conferma-page h3 {
            color: #1e40af;
            font-size: 13pt;
            margin: 15px 0 8px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Sezioni prodotti */
        .sezione-misure,
        .sezione-infisso,
        .sezione-persiana,
        .sezione-tapparella,
        .sezione-zanzariera,
        .sezione-cassonetto,
        .sezione-prezzi,
        .sezione-note {
            margin: 15px 0;
            padding: 12px 15px;
            border-left: 4px solid #3b82f6;
            background: #f9fafb;
            border-radius: 4px;
        }
        
        .sezione-infisso {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        
        .sezione-persiana {
            border-left-color: #8b5cf6;
            background: #f5f3ff;
        }
        
        .sezione-tapparella {
            border-left-color: #ec4899;
            background: #fdf2f8;
        }
        
        .sezione-zanzariera {
            border-left-color: #06b6d4;
            background: #ecfeff;
        }
        
        .sezione-cassonetto {
            border-left-color: #f59e0b;
            background: #fffbeb;
        }
        
        .sezione-prezzi {
            border-left-color: #10b981;
            background: #f0fdf4;
            font-weight: 600;
        }
        
        .sezione-note {
            border-left-color: #f59e0b;
            background: #fffbeb;
            font-style: italic;
        }
        
        /* Paragrafi */
        .conferma-page p {
            margin: 6px 0;
            line-height: 1.6;
        }
        
        .conferma-page strong {
            color: #0f172a;
            font-weight: 600;
        }
        
        /* Campo prezzo editabile */
        .campo-prezzo-editabile {
            margin-top: 10px;
            padding: 10px;
            background: white;
            border: 2px dashed #cbd5e1;
            border-radius: 6px;
            min-height: 40px;
            color: #64748b;
            font-style: italic;
        }
        
        /* Page breaks */
        .page-break {
            page-break-after: always;
            height: 0;
            margin: 0;
            padding: 0;
        }
        
        /* Stampa ottimizzata */
        @media print {
            body {
                print-color-adjust: exact;
                -webkit-print-color-adjust: exact;
            }
            
            .page-break {
                page-break-after: always;
            }
            
            .conferma-page {
                page-break-inside: avoid;
            }
            
            /* Evita rottura sezioni */
            .sezione-misure,
            .sezione-infisso,
            .sezione-persiana,
            .sezione-tapparella,
            .sezione-zanzariera,
            .sezione-cassonetto,
            .sezione-prezzi,
            .sezione-note {
                page-break-inside: avoid;
            }
        }
    </style>
</head>
<body>
    ${content.innerHTML}
    
    <script>
        // Auto-stampa dopo caricamento
        window.onload = function() {
            console.log('ğŸ“„ Finestra stampa pronta');
            
            // Breve delay per rendering completo
            setTimeout(function() {
                window.print();
                
                // Chiudi finestra dopo stampa (opzionale)
                // window.onafterprint = function() {
                //     window.close();
                // };
            }, 500);
        };
    <\/script>
</body>
</html>
            `;
            
            // Scrivi contenuto nella finestra
            printWindow.document.write(htmlContent);
            printWindow.document.close();
            
            console.log('âœ… Finestra stampa aperta!');
            console.log(`   Nome file suggerito: ${nomeFile}.pdf`);
            
            // Alert informativo
            showAlert('success', `ğŸ“„ Finestra stampa aperta!\n\nNome file: ${nomeFile}.pdf`);
        }
        
        /**
         * ============================================================================
         * MODAL SCELTA BRM
         * ============================================================================
         */
        
        let brmModalCallback = null;
        let brmSceltaLarghezza = null;
        let brmSceltaAltezza = null;
        
        /**
         * Mostra modal per scegliere misure BRM
         */
        function mostraModalBRM(options) {
            const {
                posizione,
                misureDisponibili,
                needLarghezza,
                needAltezza,
                callback
            } = options;
            
            // Salva callback
            brmModalCallback = callback;
            brmSceltaLarghezza = null;
            brmSceltaAltezza = null;
            
            // Imposta nome posizione
            document.getElementById('brm-posizione-nome').textContent = 
                `${posizione.nome || 'Posizione'} - ${posizione.locale || posizione.ambiente || ''}`;
            
            // Mostra sezioni necessarie
            const sectionLarghezza = document.getElementById('brm-section-larghezza');
            const sectionAltezza = document.getElementById('brm-section-altezza');
            
            sectionLarghezza.style.display = needLarghezza ? 'block' : 'none';
            sectionAltezza.style.display = needAltezza ? 'block' : 'none';
            
            // Popola opzioni larghezza
            if (needLarghezza) {
                const optionsL = document.getElementById('brm-options-larghezza');
                optionsL.innerHTML = '';
                
                if (misureDisponibili.LVT) {
                    optionsL.innerHTML += createBRMOption('L', 'LVT', 'LVT - Luce Vano Telaio', misureDisponibili.LVT);
                }
                if (misureDisponibili.LF) {
                    optionsL.innerHTML += createBRMOption('L', 'LF', 'LF - Larghezza Foro', misureDisponibili.LF);
                }
                optionsL.innerHTML += createBRMOption('L', 'MANUALE', 'Inserisci manuale', null, true);
            }
            
            // Popola opzioni altezza
            if (needAltezza) {
                const optionsH = document.getElementById('brm-options-altezza');
                optionsH.innerHTML = '';
                
                if (misureDisponibili.HVT) {
                    optionsH.innerHTML += createBRMOption('H', 'HVT', 'HVT - Altezza Vano Telaio', misureDisponibili.HVT);
                }
                if (misureDisponibili.HF) {
                    optionsH.innerHTML += createBRMOption('H', 'HF', 'Altezza Foro', misureDisponibili.HF);
                }
                optionsH.innerHTML += createBRMOption('H', 'MANUALE', 'Inserisci manuale', null, true);
            }
            
            // Mostra modal
            const overlay = document.getElementById('brm-modal-overlay');
            overlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // Disabilita bottone conferma
            document.getElementById('brm-btn-conferma').disabled = true;
        }
        
        /**
         * Crea HTML per un'opzione BRM
         */
        function createBRMOption(tipo, key, label, valore, isManuale = false) {
            const id = `brm-option-${tipo}-${key}`;
            const inputId = `brm-input-${tipo}-${key}`;
            
            return `
                <div class="brm-option" id="${id}" onclick="selezionaBRMOption('${tipo}', '${key}', ${isManuale})">
                    <div class="brm-option-radio"></div>
                    <div class="brm-option-content">
                        <div class="brm-option-label">${label}</div>
                        ${!isManuale && valore ? `
                            <div class="brm-option-value">${valore}<span class="brm-option-unit">mm</span></div>
                        ` : ''}
                        ${isManuale ? `
                            <div class="brm-option-input" id="${inputId}">
                                <label class="brm-input-label">Inserisci valore in mm:</label>
                                <input type="number" class="brm-input-field" 
                                       placeholder="es. 1200" 
                                       min="100" max="5000"
                                       onchange="aggiornaBRMManuale('${tipo}', this.value)"
                                       onclick="event.stopPropagation()">
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }
        
        /**
         * Seleziona un'opzione BRM
         */
        function selezionaBRMOption(tipo, key, isManuale) {
            // Rimuovi selezione precedente
            const options = document.querySelectorAll(`.brm-option[id^="brm-option-${tipo}-"]`);
            options.forEach(opt => opt.classList.remove('selected'));
            
            // Aggiungi selezione
            const selected = document.getElementById(`brm-option-${tipo}-${key}`);
            selected.classList.add('selected');
            
            // Mostra/nascondi input manuale
            const inputs = document.querySelectorAll(`[id^="brm-input-${tipo}-"]`);
            inputs.forEach(inp => inp.classList.remove('active'));
            
            if (isManuale) {
                const inputDiv = document.getElementById(`brm-input-${tipo}-${key}`);
                inputDiv.classList.add('active');
                const inputField = inputDiv.querySelector('input');
                setTimeout(() => inputField.focus(), 100);
            } else {
                // Salva valore dalla label
                const valueEl = selected.querySelector('.brm-option-value');
                if (valueEl) {
                    const valore = parseInt(valueEl.textContent);
                    if (tipo === 'L') {
                        brmSceltaLarghezza = valore;
                    } else {
                        brmSceltaAltezza = valore;
                    }
                }
            }
            
            // Verifica se puÃ² abilitare conferma
            verificaBRMCompleto();
        }
        
        /**
         * Aggiorna valore BRM manuale
         */
        function aggiornaBRMManuale(tipo, valore) {
            const val = parseInt(valore);
            if (!isNaN(val) && val >= 100 && val <= 5000) {
                if (tipo === 'L') {
                    brmSceltaLarghezza = val;
                } else {
                    brmSceltaAltezza = val;
                }
                verificaBRMCompleto();
            }
        }
        
        /**
         * Verifica se tutte le misure necessarie sono state selezionate
         */
        function verificaBRMCompleto() {
            const needL = document.getElementById('brm-section-larghezza').style.display !== 'none';
            const needH = document.getElementById('brm-section-altezza').style.display !== 'none';
            
            const completo = (!needL || brmSceltaLarghezza !== null) && 
                           (!needH || brmSceltaAltezza !== null);
            
            document.getElementById('brm-btn-conferma').disabled = !completo;
        }
        
        /**
         * Conferma scelta BRM e chiama callback
         */
        function confermaBRM() {
            if (brmModalCallback) {
                brmModalCallback({
                    larghezza: brmSceltaLarghezza,
                    altezza: brmSceltaAltezza
                });
            }
            chiudiModalBRM();
        }
        
        /**
         * Chiudi modal BRM
         */
        function chiudiModalBRM() {
            const overlay = document.getElementById('brm-modal-overlay');
            overlay.classList.remove('active');
            document.body.style.overflow = '';
            
            // Reset
            brmModalCallback = null;
            brmSceltaLarghezza = null;
            brmSceltaAltezza = null;
        }
        
        /**
         * ============================================================================
         */
        
        /**
         * Render preventivo nel modal
         */
        function renderPreventivo(preventivo) {
            const content = document.getElementById('preventivo-modal-content');
            
            if (!preventivo.successo || preventivo.prodotti.length === 0) {
                content.innerHTML = `
                    <div class="preventivo-placeholder">
                        <div class="preventivo-placeholder-icon">âš ï¸</div>
                        <div class="preventivo-placeholder-text">
                            Nessun prodotto con dati sufficienti per calcolare il preventivo.<br>
                            Verifica che siano presenti <strong>modelli</strong> e <strong>misure BRM</strong> nei rilievi.
                        </div>
                    </div>
                `;
                return;
            }
            
            let html = `
                <div class="preventivo-info-progetto">
                    <h3>ğŸ“‹ ${preventivo.progetto}</h3>
                    ${preventivo.cliente.nome ? `<p><strong>Cliente:</strong> ${preventivo.cliente.nome} ${preventivo.cliente.cognome || ''}</p>` : ''}
                    <p><strong>Data:</strong> ${new Date(preventivo.timestamp).toLocaleDateString('it-IT')}</p>
                    <p><strong>Prodotti:</strong> ${preventivo.prodotti.length}</p>
                </div>
                
                <div class="preventivo-prodotti-lista">
            `;
            
            preventivo.prodotti.forEach((prod, idx) => {
                html += `
                    <div class="preventivo-prodotto-card">
                        <div class="preventivo-prodotto-header">
                            <div class="preventivo-prodotto-info">
                                <h4>${prod.posizione}</h4>
                                <p>${prod.prodotto} - ${prod.modello}</p>
                            </div>
                            <div class="preventivo-prodotto-prezzo">
                                <div class="preventivo-prezzo-label">Prezzo</div>
                                <div class="preventivo-prezzo-valore">â‚¬ ${prod.prezzi.totale}</div>
                            </div>
                        </div>
                        
                        <div class="preventivo-prodotto-dettagli">
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Larghezza</div>
                                <div class="preventivo-dettaglio-valore">${prod.misure.larghezza} mm</div>
                            </div>
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Altezza</div>
                                <div class="preventivo-dettaglio-valore">${prod.misure.altezza} mm</div>
                            </div>
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Superficie</div>
                                <div class="preventivo-dettaglio-valore">${prod.misure.superficie_mq} mÂ²</div>
                            </div>
                            ${prod.fascia ? `
                            <div class="preventivo-dettaglio-item">
                                <div class="preventivo-dettaglio-label">Fascia Prezzo</div>
                                <div class="preventivo-dettaglio-valore">Fascia ${prod.fascia}</div>
                            </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            });
            
            html += `
                </div>
                
                <div class="preventivo-totale-section">
                    <div class="preventivo-totale-row">
                        <span class="preventivo-totale-label">Subtotale</span>
                        <span class="preventivo-totale-valore">â‚¬ ${preventivo.totale}</span>
                    </div>
                    <div class="preventivo-totale-row">
                        <span class="preventivo-totale-label">IVA 22%</span>
                        <span class="preventivo-totale-valore">â‚¬ ${(preventivo.totale_iva - preventivo.totale).toFixed(2)}</span>
                    </div>
                    <div class="preventivo-totale-row finale">
                        <span class="preventivo-totale-label finale">TOTALE</span>
                        <span class="preventivo-totale-valore finale">â‚¬ ${preventivo.totale_iva}</span>
                    </div>
                </div>
            `;
            
            content.innerHTML = html;
            currentPreventivo = preventivo;
            
            console.log('âœ… Preventivo renderizzato:', preventivo);
        }
        
        /**
         * Esporta PDF
         */
        function esportaPreventiPDF() {
            if (!currentPreventivo) {
                alert('Nessun preventivo disponibile per l\'export');
                return;
            }
            
            console.log('ğŸ“„ Export PDF:', currentPreventivo);
            alert('ğŸ“„ Funzione export PDF in fase di implementazione\n\nSarÃ  disponibile nella prossima versione con libreria jsPDF.');
        }
        
        console.log('âœ… Funzioni UI Preventivo caricate');
    </script>
    
</head>
<body>
    <!-- OVERLAY CARICAMENTO INIZIALE -->
    <div id="initial-loading-overlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text">Caricamento progetti...</div>
            <div class="loading-subtext">Sincronizzazione da GitHub in corso</div>
        </div>
    </div>

    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <!-- MENU TOGGLE HAMBURGER -->
            <button class="menu-toggle" onclick="toggleMenu()" aria-label="Toggle Menu">
                â˜°
            </button>
            
            <div class="logo">
                Dashboard Rilievi 
                <span class="logo-version">v7.41 - Secure Token</span>
            </div>
            <nav class="main-nav">
                <button class="nav-btn active blocco-generale" onclick="switchBlocco('generale')">
                    ğŸ“Š Generale
                </button>
                <button class="nav-btn blocco-ufficio" onclick="switchBlocco('ufficio')">
                    ğŸ’¼ Ufficio
                </button>
                <button class="nav-btn blocco-posa" onclick="apriPosaApp()" title="Apri App Posa in nuova finestra">
                    ğŸ”§ Apri App Posa
                </button>
                
                <!-- PULSANTE CONFERMA CLIENTE -->
                <button class="nav-btn blocco-conferma" id="btn-conferma-cliente" onclick="apriConfermaCliente()" 
                        style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%); color: white; font-weight: 700;" 
                        title="Genera documento conferma per il cliente"
                        disabled>
                    ğŸ“‹ Conferma Cliente
                </button>
            </nav>
        </div>
        
    </header>

    <!-- MENU LATERALE -->
    <div id="sidebarMenu" class="sidebar-menu">
        <div class="sidebar-header">
            <h3>Menu</h3>
            <button onclick="closeSidebar()" class="close-btn">&times;</button>
        </div>
        <div class="sidebar-content">
            <a href="#" onclick="switchBlocco('generale'); closeSidebar();" class="sidebar-item">
                <span>ğŸ“Š</span> Generale
            </a>
            
            <div class="sidebar-item sidebar-expandable" onclick="toggleGithubProjects(event)">
                <div class="sidebar-item-header">
                    <span>ğŸ”„</span> GitHub Projects
                    <span class="expand-icon">â–¼</span>
                </div>
            </div>
            <div id="githubProjectsList" class="sidebar-submenu" style="display: none;">
                <!-- Popolato dinamicamente -->
            </div>
            
            <div class="sidebar-item sidebar-expandable" onclick="toggleImpostazioni(event)">
                <div class="sidebar-item-header">
                    <span>âš™ï¸</span> Impostazioni
                    <span class="expand-icon">â–¼</span>
                </div>
            </div>
            <div id="impostazioniMenu" class="sidebar-submenu" style="display: none;">
                <button class="sidebar-action-btn import" onclick="document.getElementById('jsonFileInput').click(); closeSidebar();" title="Importa file JSON di rilievo">
                    <span>ğŸ“</span> Importa JSON
                </button>
                <button class="sidebar-action-btn github" onclick="loadProjectsFromGitHub(); closeSidebar();" title="Ricarica progetti da GitHub">
                    <span>ğŸ”„</span> GitHub
                </button>
                <button class="sidebar-action-btn settings" onclick="showGitHubTokenForm(); closeSidebar();" title="Configura GitHub">
                    <span>âš™ï¸</span> Configura
                </button>
            </div>
        </div>
    </div>
    
    <!-- Overlay per chiudere sidebar -->
    <div id="sidebarOverlay" class="sidebar-overlay" onclick="closeSidebar()"></div>

    <!-- CONTAINER PRINCIPALE -->
    <div class="container">
        
        <!-- ====================================================================
             BLOCCO 1: GENERALE
             ==================================================================== -->
        <div id="blocco-generale" class="blocco active">
            <div class="card">
                <div style="margin-bottom: 1.5rem;">
                    <h1 class="card-title" style="margin-bottom: 0.5rem;">ğŸ“Š Dashboard Generale</h1>
                </div>
                <input type="file" id="jsonFileInput" accept=".json" onchange="handleFileSelect(event)" style="display: none;">

                <!-- STATO DATI -->
                <div id="dataStatus" class="data-status" style="display: none;">
                    <!-- Popolato dinamicamente -->
                </div>
            </div>

            <!-- PLACEHOLDER (nascosto dopo import) -->
            <div id="generalePlaceholder" class="card">
                <div class="placeholder">
                    <div class="placeholder-icon">ğŸ“‹</div>
                    <div class="placeholder-title">Nessun rilievo caricato</div>
                    <div class="placeholder-text">
                        Carica un file JSON per visualizzare dashboard, KPI e tabella posizioni
                    </div>
                </div>
            </div>

            <!-- CONTENUTO (mostrato dopo import) -->
            <div id="generaleContent" style="display: none;">
                
                <!-- DASHBOARD KPI -->
                <div class="card">
                    <h2 class="card-title">ğŸ“Š Dashboard KPI</h2>
                    <div id="kpiCards" class="kpi-grid">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

                <!-- FILTRI E RICERCA -->
                <div class="card">
                    <h2 class="card-title">ğŸ” Filtra Posizioni</h2>
                    <div class="filters-container">
                        <div class="filter-group">
                            <label>Piano:</label>
                            <select id="filterPiano" onchange="applyFilters()">
                                <option value="">Tutti i piani</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Stanza:</label>
                            <select id="filterStanza" onchange="applyFilters()">
                                <option value="">Tutte le stanze</option>
                            </select>
                        </div>
                        <div class="filter-group">
                            <label>Prodotto:</label>
                            <select id="filterProdotto" onchange="applyFilters()">
                                <option value="">Tutti i prodotti</option>
                            </select>
                        </div>
                        <div class="filter-group search-group">
                            <label>Cerca:</label>
                            <input type="text" id="searchInput" placeholder="Cerca per ID, ambiente..." oninput="applyFilters()">
                        </div>
                        <button class="btn btn-secondary" onclick="resetFilters()">ğŸ”„ Reset</button>
                    </div>
                </div>

                <!-- TABELLA POSIZIONI -->
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 class="card-title" style="margin: 0;">ğŸ“‹ Tabella Posizioni</h2>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="btn btn-secondary" onclick="exportToJSON()">ğŸ’¾ JSON</button>
                            <button class="btn btn-primary" onclick="exportToCSV()">ğŸ“Š Excel/CSV</button>
                        </div>
                    </div>
                    <div id="tableContainer" class="table-container">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>

            </div>
        </div>

        <!-- ====================================================================
             BLOCCO 2: UFFICIO
             ==================================================================== -->
        <div id="blocco-ufficio" class="blocco">
            
            <!-- Submenu Blocco Ufficio -->
            <div class="submenu-ufficio">
                <button class="submenu-btn active" onclick="switchVistaUfficio('generale', event)">
                    ğŸ“Š Vista Generale
                </button>
                <button class="submenu-btn" onclick="switchVistaUfficio('posizioni', event)">
                    ğŸ“‹ Vista Posizioni
                </button>
                <button class="submenu-btn" onclick="switchVistaUfficio('aziende', event)">
                    ğŸ¢ Vista Aziende
                </button>
                <button class="submenu-btn" onclick="switchVistaUfficio('preventivo', event)">
                    ğŸ’° Preventivo
                </button>
            </div>

            <!-- ============================================================
                 VISTA GENERALE UFFICIO
                 ============================================================ -->
            <div id="vista-generale-ufficio" class="vista-ufficio active">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="ufficioPlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ“Š</div>
                            <div class="placeholder-title">Vista Generale Ufficio</div>
                            <div class="placeholder-text">
                                Carica un file JSON dal Blocco Generale per visualizzare<br>
                                le informazioni del progetto, totali commessa e stato avanzamento
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto Vista Generale (nascosto inizialmente) -->
                <div id="ufficioContent" class="content-hidden">
                    
                    <!-- SEZIONE A: Info Cliente -->
                    <div class="card-ufficio">
                        <h2 class="card-ufficio-title">
                            <span class="card-ufficio-icon">ğŸ‘¤</span>
                            Informazioni Cliente e Progetto
                        </h2>
                        <div id="infoCliente" class="info-grid">
                            <!-- Popolato dinamicamente -->
                        </div>
                        <div id="noteProgetto">
                            <!-- Note progetto (se presenti) -->
                        </div>
                    </div>

                    <!-- SEZIONE B2: Configurazione Infissi Globale - RIMOSSA (spostata in Vista Aziende) -->
                    <!-- 
                    <div class="card-ufficio">
                        <h2 class="card-ufficio-title">
                            <span class="card-ufficio-icon">ğŸªŸ</span>
                            Configurazione Infissi Globale
                        </h2>
                        <div id="configInfissiContent" class="info-grid">
                            <!-- Popolato dinamicamente -->
                        </div>
                    </div>
                    -->

                    <!-- SEZIONE C: Totali Commessa - Creata dinamicamente v7.21 -->
                    <div id="totaliCommessaContainer"></div>

                </div>
            </div>

            <!-- ============================================================
                 VISTA POSIZIONI - Implementata in Chat 100011
                 ============================================================ -->
            <div id="vista-posizioni-ufficio" class="vista-ufficio">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="posizioniPlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ“‹</div>
                            <div class="placeholder-title">Vista Posizione per Posizione</div>
                            <div class="placeholder-text">
                                Carica un file JSON dal Blocco Generale per visualizzare<br>
                                il dettaglio completo di ogni posizione rilevata
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto Vista Posizioni (nascosto inizialmente) -->
                <div id="posizioniContent" class="content-hidden">
                    
                    <!-- Header Progetto -->
                    <div id="projectHeaderPosizioni" class="card" style="margin-bottom: 1.5rem;">
                        <div style="padding: 1.5rem;">
                            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                                <div>
                                    <h2 id="projectNameDisplay" style="font-size: 1.5rem; color: #1e293b; margin: 0 0 0.5rem 0; font-weight: 700;">
                                        Nome Progetto
                                    </h2>
                                    <div id="projectClientDisplay" style="color: #475569; font-size: 1.1rem; font-weight: 500;">
                                        ğŸ‘¤ Cliente
                                    </div>
                                </div>
                                <div style="text-align: right; color: #6b7280; font-size: 0.9rem;">
                                    <div id="projectDateDisplay" style="margin-bottom: 0.25rem;">
                                        ğŸ“… Data
                                    </div>
                                    <div id="projectPositionsCountDisplay">
                                        ğŸ“ Posizioni
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="positions-layout">
                        
                        <!-- Sidebar Lista Posizioni -->
                        <aside class="positions-sidebar">
                            <div class="positions-sidebar-title">
                                ğŸ“‹ Posizioni
                                <span id="positionsCount" style="font-size: 0.9rem; color: #6b7280; font-weight: 400;"></span>
                            </div>

                            <!-- Lista posizioni -->
                            <div id="positionsList" class="positions-list">
                                <!-- Popolata dinamicamente -->
                            </div>
                        </aside>

                        <!-- Card Dettaglio Posizione -->
                        <div class="position-detail">
                            <div id="positionDetailCard" class="position-card">
                                <!-- Popolata dinamicamente -->
                            </div>
                        </div>

                    </div>

                </div>

            </div>

            <!-- ============================================================
                 VISTA AZIENDE (placeholder per prossima chat)
                 ============================================================ -->
            <!-- ============================================================
                 VISTA AZIENDE - Implementata in Chat 10012
                 ============================================================ -->
            <div id="vista-aziende-ufficio" class="vista-ufficio">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="aziendePlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ¢</div>
                            <div class="placeholder-title">Vista Prodotti per Azienda</div>
                            <div class="placeholder-text">
                                Carica un file JSON dal Blocco Generale per visualizzare<br>
                                il riepilogo prodotti raggruppati per fornitore/azienda
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto vista aziende -->
                <div id="aziendeContent" class="content-hidden">
                    
                    <!-- Header vista -->
                    <div class="card" style="margin-bottom: 1.5rem;">
                        <h2 style="font-size: 1.5rem; font-weight: 700; color: #10b981; margin-bottom: 0.5rem;">
                            ğŸ¢ Vista Prodotti per Azienda
                        </h2>
                        <p style="color: #6b7280; margin: 0;">
                            Riepilogo prodotti raggruppati per fornitore
                        </p>
                    </div>

                    <!-- Contenitore card aziende -->
                    <div id="aziendeCards" class="aziende-container">
                        <!-- Popolato dinamicamente da renderVistaAziende() -->
                    </div>

                </div>
            </div>

            <!-- ============================================================
                 VISTA PREVENTIVO - Foglio Calcolo con Listino Finstral
                 Implementata in Chat v7.22
                 ============================================================ -->
            <div id="vista-preventivo-ufficio" class="vista-ufficio">
                
                <!-- Placeholder quando nessun dato caricato -->
                <div id="preventivoPlaceholder">
                    <div class="card">
                        <div class="placeholder">
                            <div class="placeholder-icon">ğŸ’°</div>
                            <div class="placeholder-title">Vista Preventivo</div>
                            <div class="placeholder-text">
                                Carica un file JSON per calcolare il preventivo con listino Finstral
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contenuto Vista Preventivo (nascosto inizialmente) -->
                <div id="preventivoContent" class="content-hidden">
                    
                    <!-- HEADER PREVENTIVO -->
                    <div class="card">
                        <h2 class="card-title">ğŸ’° Preventivo - Calcolo Dettagliato</h2>
                        <p class="card-subtitle">
                            Calcolo prezzi con listino Finstral EUR 2025/3 - Sistema supplementi al metro lineare BRM
                        </p>
                    </div>

                    <!-- TOOLBAR AZIONI -->
                    <div class="card" style="padding: 1rem;">
                        <div style="display: flex; gap: 1rem; flex-wrap: wrap; align-items: center;">
                            <button class="btn btn-primary" onclick="ricalcolaPreventivo()">
                                ğŸ”„ Ricalcola Preventivo
                            </button>
                            <button class="btn btn-success" onclick="exportPreventivoExcel()">
                                ğŸ“Š Export Excel
                            </button>
                            <button class="btn" onclick="window.print()">
                                ğŸ–¨ï¸ Stampa PDF
                            </button>
                            
                            <!-- Separatore -->
                            <div style="width: 2px; height: 30px; background: #d1d5db;"></div>
                            
                            <!-- NUOVI BOTTONI -->
                            <button class="btn" onclick="apriGestioneListini()" 
                                    style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; font-weight: 600;"
                                    title="Gestione listini fornitori">
                                ğŸ“š Listini
                            </button>
                            <button class="btn" onclick="apriPreventivo()" 
                                    style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; font-weight: 600;"
                                    title="Apri dettaglio costi completo">
                                ğŸ’° Dettaglio Costi
                            </button>
                            
                            <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
                                <label style="font-weight: 600;">IVA:</label>
                                <select id="ivaSelect" onchange="ricalcolaPreventivo()" style="padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                    <option value="0" selected>Senza IVA</option>
                                    <option value="22">IVA 22%</option>
                                    <option value="10">IVA 10%</option>
                                    <option value="4">IVA 4%</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- TABELLA FOGLIO CALCOLO STILE EXCEL -->
                    <div class="card" style="padding: 0; overflow: auto;">
                        <div class="excel-container">
                            <table class="excel-table" id="preventivoTable">
                                <thead>
                                    <tr>
                                        <th class="excel-col-narrow">Pos.</th>
                                        <th class="excel-col-medium">Ambiente</th>
                                        <th class="excel-col-narrow">Tipo</th>
                                        <th class="excel-col-medium">Azienda</th>
                                        <th class="excel-col-narrow">Telaio</th>
                                        <th class="excel-col-narrow">L(mm)</th>
                                        <th class="excel-col-narrow">H(mm)</th>
                                        <th class="excel-col-narrow">Sup(mÂ²)</th>
                                        <th class="excel-col-narrow">Perim(ml)</th>
                                        <th class="excel-col-medium">Base â‚¬</th>
                                        <th class="excel-col-narrow">Telaio â‚¬</th>
                                        <th class="excel-col-narrow">Anta â‚¬</th>
                                        <th class="excel-col-narrow">Vetro â‚¬</th>
                                        <th class="excel-col-narrow">Maniglia â‚¬</th>
                                        <th class="excel-col-medium">Unit. â‚¬</th>
                                        <th class="excel-col-narrow">QtÃ </th>
                                        <th class="excel-col-wide">Totale â‚¬</th>
                                    </tr>
                                </thead>
                                <tbody id="preventivoTableBody">
                                    <!-- Popolato dinamicamente -->
                                </tbody>
                                <tfoot>
                                    <tr class="excel-total-row">
                                        <td colspan="16" style="text-align: right; font-weight: 700;">TOTALE MATERIALI:</td>
                                        <td class="excel-total-value" id="totaleMateriali">â‚¬ 0.00</td>
                                    </tr>
                                    <tr class="excel-row">
                                        <td colspan="16" style="text-align: right; font-weight: 600;">Posa (â‚¬/pezzo):</td>
                                        <td class="excel-value" id="totalePosa">â‚¬ 0.00</td>
                                    </tr>
                                    <tr class="excel-row">
                                        <td colspan="16" style="text-align: right; font-weight: 600;">Smontaggio (â‚¬/pezzo):</td>
                                        <td class="excel-value" id="totaleSmontaggio">â‚¬ 0.00</td>
                                    </tr>
                                    <tr class="excel-subtotal-row">
                                        <td colspan="16" style="text-align: right; font-weight: 700;">SUBTOTALE:</td>
                                        <td class="excel-subtotal-value" id="subtotale">â‚¬ 0.00</td>
                                    </tr>
                                    <tr class="excel-row" id="rowIVA" style="display: none;">
                                        <td colspan="16" style="text-align: right; font-weight: 600;">IVA (<span id="ivaPercent">22</span>%):</td>
                                        <td class="excel-value" id="totaleIVA">â‚¬ 0.00</td>
                                    </tr>
                                    <tr class="excel-grand-total-row">
                                        <td colspan="16" style="text-align: right; font-weight: 700; font-size: 1.1rem;">TOTALE PREVENTIVO:</td>
                                        <td class="excel-grand-total-value" id="grandTotal">â‚¬ 0.00</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- LEGENDA CALCOLO -->
                    <div class="card">
                        <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">
                            ğŸ“‹ Legenda Calcolo Finstral
                        </h3>
                        <div style="background: #f9fafb; padding: 1rem; border-radius: 0.5rem; font-size: 0.875rem; line-height: 1.6;">
                            <p><strong>Sistema Finstral EUR 2025/3:</strong></p>
                            <ul style="margin: 0.5rem 0 0 1.5rem;">
                                <li><strong>Perimetro BRM (ml):</strong> 2 Ã— (Larghezza + Altezza) / 1000</li>
                                <li><strong>Base â‚¬:</strong> Prezzo base per tipologia infisso (MOCK: â‚¬ 350-600)</li>
                                <li><strong>Suppl. â‚¬:</strong> Supplemento telaio al metro lineare Ã— Perimetro BRM</li>
                                <li><strong>Unit. â‚¬:</strong> Base + Supplementi</li>
                                <li><strong>Totale â‚¬:</strong> Prezzo Unitario Ã— QuantitÃ </li>
                            </ul>
                            <p style="margin-top: 0.5rem;"><em>Note: Prezzi base MOCK per testing. Integrare listino completo Finstral.</em></p>
                        </div>
                    </div>

                </div>
            </div>

        </div>

    </div>

    <!-- ================================================================================
         JAVASCRIPT
         ================================================================================ -->
    <script>
        // ============================================================================
        // STATO APPLICAZIONE
        // ============================================================================
        let appState = {
            currentBlocco: 'generale',
            rilievoData: null,
            lastImport: null
        };

        // ============================================================================
        // NAVIGAZIONE TRA BLOCCHI
        // ============================================================================
        function switchBlocco(bloccoName) {
            // âœ… FIX: Chiudi modale preventivo se aperta
            chiudiPreventivo();
            
            // Aggiorna stato
            appState.currentBlocco = bloccoName;

            // Nascondi tutti i blocchi
            document.querySelectorAll('.blocco').forEach(b => b.classList.remove('active'));
            // Mostra blocco selezionato
            document.getElementById(`blocco-${bloccoName}`).classList.add('active');

            // Aggiorna pulsanti nav
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            
            // âœ… CORRETTO: Trova il bottone corretto in base al bloccoName
            const targetButton = document.querySelector(`.nav-btn.blocco-${bloccoName}`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            console.log(`âœ… Switched to: ${bloccoName}`);
        }

        // ============================================================================
        // FILE SELECTION
        // ============================================================================
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file) {
                handleFile(file);
            }
        }

        // ============================================================================
        // PROCESSAMENTO FILE JSON
        // ============================================================================
        function handleFile(file) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ”¥ HANDLE FILE CALLED!');
            console.log(`ğŸ“ Name: ${file.name}`);
            console.log(`ğŸ“Š Size: ${file.size} bytes`);
            console.log(`ğŸ“‹ Type: ${file.type}`);
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

            // Verifica sia JSON
            if (!file.name.endsWith('.json')) {
                console.error('âŒ Not a JSON file');
                showAlert('error', 'âŒ Errore: Seleziona un file JSON valido');
                return;
            }

            console.log('âœ… File is JSON');
            showAlert('info', `ğŸ“‚ Caricamento: ${file.name}...`);

            const reader = new FileReader();

            reader.onload = function(e) {
                console.log('ğŸ“– FileReader onload triggered');
                console.log(`ğŸ“ Content length: ${e.target.result.length} chars`);
                
                try {
                    const jsonData = JSON.parse(e.target.result);
                    console.log('âœ… JSON parsed successfully');
                    console.log('ğŸ“‹ JSON keys:', Object.keys(jsonData));
                    
                    // âš ï¸ FIX: Carica i dati SEMPRE, anche se validazione fallisce
                    // Il wizard si occuperÃ  di completare i dati mancanti
                    console.log('âš™ï¸ Caricamento dati (validazione permissiva)...');
                    processRilievoData(jsonData, file.name);
                    
                    // Valida per warnings (non bloccante)
                    if (!validateRilievoJSON(jsonData)) {
                        console.warn('âš ï¸ Validazione ha trovato problemi (non bloccanti)');
                    }
                } catch (error) {
                    console.error('âŒ Parse error:', error);
                    showAlert('error', `âŒ Errore parsing JSON: ${error.message}`);
                }
            };

            reader.onerror = function() {
                console.error('âŒ FileReader error');
                showAlert('error', 'âŒ Errore lettura file');
            };

            console.log('ğŸ“– Starting FileReader...');
            reader.readAsText(file);
        }

        // ============================================================================
        // CONVERSIONE AUTOMATICA FORMATI JSON
        // ============================================================================
        function convertProjectsFormat(data) {
            console.log('ğŸ”„ AUTO-CONVERSION: Checking JSON format...');
            
            // FORMATO 0: JSON da GitHub (formato app-rilievo-027K-FIXED con project.rilievoInfissi)
            if (data.project && data.project.rilievoInfissi) {
                console.log('â˜ï¸ Detected: GITHUB format (app-rilievo-027K sync)');
                console.log(`   Found ${data.project.rilievoInfissi.length} posizioni in rilievoInfissi`);
                
                // Converti project.rilievoInfissi -> positions per processarlo come singolo progetto
                const githubProject = {
                    id: data.id,
                    name: data.projectName,
                    client: data.customerName || data.projectName,
                    positions: data.project.rilievoInfissi || [],
                    clientData: {
                        telefono: data.customerPhone || '',
                        email: data.customerEmail || '',
                        via: data.customerAddress || ''
                    },
                    createdAt: data.metadata?.createdAt || new Date().toISOString()
                };
                
                console.log(`   Converting GitHub format to standard...`);
                console.log(`   Project: "${githubProject.name}" with ${githubProject.positions.length} positions`);
                
                // Riusa la conversione formato singolo progetto
                return convertProjectsFormat({ projects: [githubProject] });
            }
            
            // FORMATO 1: JSON con "projects" array (formato app-rilievo multi-progetto)
            if (data.projects && Array.isArray(data.projects)) {
                console.log('ğŸ“¦ Detected: PROJECTS format (multi-project export)');
                console.log(`   Found ${data.projects.length} projects in file`);
                
                // Trova il primo progetto con posizioni non vuote
                const project = data.projects.find(p => p.positions && p.positions.length > 0);
                
                if (!project) {
                    console.error('âŒ No projects with positions found!');
                    console.error('   All projects have empty positions arrays');
                    return null;
                }
                
                console.log(`   Using project: "${project.name || project.client}" (${project.positions.length} positions)`);
                
                // Converti nel formato atteso dal dashboard
                const converted = {
                    commessa_id: project.id || 'unknown',
                    versione: data.version || '1.0',
                    data_rilievo: project.createdAt || new Date().toISOString(),
                    nome_ricerca: project.name || project.client,
                    
                    // âœ… FALLBACK: Preserva campi root per compatibilitÃ  v4.17
                    name: project.name || '',
                    client: project.client || '',
                    clientData: project.clientData || {},
                    
                    // CLIENTE: converti da clientData (per retrocompatibilitÃ )
                    cliente: {
                        nome: project.client || 'Cliente Sconosciuto',
                        progetto: project.name || '',
                        piano: project.clientData?.piano || '',
                        indirizzo: project.clientData?.via || '',
                        citta: project.clientData?.citta || '',
                        telefono: project.clientData?.telefono || '',
                        email: project.clientData?.email || ''
                    },
                    
                    // NOTE PROGETTO
                    note_progetto: project.note || '',
                    
                    // CARATTERISTICHE MURO GLOBALI
                    caratteristiche_muro_globali: {
                        telaio_larghezza: project.caratteristicheMuro?.telaioLarghezza || 0,
                        telaio_altezza: project.caratteristicheMuro?.telaioProfondita || 0,
                        falso_esistente: project.caratteristicheMuro?.falsoEsistente || 'no',
                        spessore_falso: project.caratteristicheMuro?.spessoreFalso || 0,
                        guida_tipo: project.caratteristicheMuro?.guidaEsistente === 'si' ? 'guida' : 'no',
                        prof_muro_int: project.caratteristicheMuro?.profMuroInt || 0,
                        prof_muro_est: project.caratteristicheMuro?.profMuroEst || 0,
                        battuta_superiore_tapparella: project.caratteristicheMuro?.battutaSuperioreTapparella || 0
                    },
                    
                    // POSIZIONI: converti da positions
                    posizioni: (project.positions || []).map((pos, index) => {
                        const converted_pos = {
                            id: pos.id || `P${String(index + 1).padStart(3, '0')}`,
                            nome: pos.name || `Posizione ${index + 1}`,
                            piano: pos.piano || '',
                            stanza: pos.ambiente || '',
                            ambiente: pos.ambiente || '',
                            quantita: pos.quantita || 1,
                            
                            // MISURE
                            misure: pos.misure || {},
                            
                            // PRODOTTI (converti da singular a oggetto con quantitÃ )
                            infisso: pos.infisso ? {
                                quantita: pos.infisso.qta || 1,
                                tipo: pos.infisso.tipo || '',
                                apertura: pos.infisso.apertura || '',
                                azienda: pos.infisso.azienda || '',
                                brm: {
                                    // ğŸ”§ COMPATIBILITÃ€: Supporta sia brm.L che BRM_L
                                    L: pos.infisso.brm?.L || pos.infisso.BRM_L || 0,
                                    H: pos.infisso.brm?.H || pos.infisso.BRM_H || 0
                                },
                                finitura_int: pos.infisso.finituraInt || '',
                                finitura_est: pos.infisso.finituraEst || '',
                                colore_int: pos.infisso.coloreInt || '',
                                colore_est: pos.infisso.coloreEst || ''
                            } : null,
                            
                            tapparella: pos.tapparella ? {
                                quantita: pos.tapparella.qta || 1,
                                azienda: pos.tapparella.azienda || '',
                                modello: pos.tapparella.modello || '',
                                tipologia: pos.tapparella.tipologia || '',
                                brm: {
                                    L: pos.tapparella.BRM_L || 0,
                                    H: pos.tapparella.BRM_H || 0
                                }
                            } : null,
                            
                            cassonetto: pos.cassonetto ? {
                                quantita: pos.cassonetto.qta || 1,
                                tipo: pos.cassonetto.tipo || '',
                                azienda: pos.cassonetto.azienda || '',
                                brm: {
                                    L: pos.cassonetto.BRM_L || 0,
                                    H: pos.cassonetto.BRM_H || pos.cassonetto.HCASS || 0,
                                    C: pos.cassonetto.C || 0,
                                    B: pos.cassonetto.B || 0
                                }
                            } : null,
                            
                            persiana: pos.persiana && pos.persiana.qta ? {
                                quantita: pos.persiana.qta || 1
                            } : null,
                            
                            zanzariera: pos.zanzariera && pos.zanzariera.qta ? {
                                quantita: pos.zanzariera.qta || 1
                            } : null,
                            
                            // NOTE E RILIEVI - TUTTI I PRODOTTI
                            note: pos.note || '',
                            rilievo_preesistente: pos.rilievo || {},
                            rilievo_persiane: pos.rilievoPersiane || {},
                            rilievo_tapparelle: pos.rilievoTapparelle || {},
                            rilievo_zanzariere: pos.rilievoZanzariere || {},
                            rilievo_cassonetti: pos.rilievoCassonetti || {}
                        };
                        
                        return converted_pos;
                    }),
                    
                    // TOTALI
                    totali: {
                        n_posizioni: project.positions?.length || 0,
                        n_infissi: (project.positions || []).filter(p => p.infisso && p.infisso.qta).length,
                        n_tapparelle: (project.positions || []).filter(p => p.tapparella && p.tapparella.qta).length,
                        n_cassonetti: (project.positions || []).filter(p => p.cassonetto && p.cassonetto.qta).length,
                        n_persiane: (project.positions || []).filter(p => p.persiana && p.persiana.qta).length,
                        n_zanzariere: (project.positions || []).filter(p => p.zanzariera && p.zanzariera.qta).length
                    }
                };
                
                console.log('âœ… Conversion completed:');
                console.log(`   Cliente: ${converted.cliente.nome}`);
                console.log(`   Posizioni: ${converted.posizioni.length}`);
                console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
                
                return converted;
            }
            
            // FORMATO 2: JSON giÃ  nel formato corretto (con "posizioni")
            if (data.posizioni) {
                console.log('âœ… Detected: STANDARD format (already compatible)');
                return data;
            }
            
            // FORMATO 3: JSON singolo progetto diretto (senza wrapper)
            if (data.positions && !data.projects) {
                console.log('ğŸ“¦ Detected: SINGLE PROJECT format');
                console.log('   Converting single project...');
                
                // Converti come se fosse projects[0]
                return convertProjectsFormat({ projects: [data] });
            }
            
            // FORMATO NON RICONOSCIUTO
            console.error('âŒ Unknown JSON format');
            console.error('   Expected: "projects" array OR "posizioni" array OR "positions" array');
            console.error('   Found keys:', Object.keys(data));
            return null;
        }

        // ============================================================================
        // VALIDAZIONE JSON
        // ============================================================================
        function validateRilievoJSON(data) {
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            console.log('ğŸ” VALIDATION STARTED');
            console.log('ğŸ“‹ JSON keys found:', Object.keys(data));
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            
            // STEP 1: Prova conversione automatica
            const convertedData = convertProjectsFormat(data);
            if (!convertedData) {
                showAlert('error', 'âŒ Formato JSON non riconosciuto');
                return false;
            }
            
            // Sostituisci i dati con quelli convertiti
            Object.keys(data).forEach(key => delete data[key]);
            Object.assign(data, convertedData);

            // VALIDAZIONE MINIMA: serve solo "posizioni"
            if (!data.posizioni) {
                console.error('âŒ Missing required field: "posizioni"');
                showAlert('error', 'âŒ Manca il campo "posizioni" nel JSON');
                return false;
            }

            if (!Array.isArray(data.posizioni)) {
                console.error('âŒ Field "posizioni" must be an array');
                showAlert('error', 'âŒ Il campo "posizioni" deve essere un array');
                return false;
            }

            console.log(`âœ… Found ${data.posizioni.length} posizioni`);

            // Cliente opzionale - usa default se manca
            if (!data.cliente) {
                console.warn('âš ï¸ Missing "cliente" - using default');
                data.cliente = { nome: 'Cliente Sconosciuto' };
            } else if (!data.cliente.nome) {
                console.warn('âš ï¸ Missing "cliente.nome" - using default');
                data.cliente.nome = 'Cliente Sconosciuto';
            }

            console.log('âœ… VALIDATION PASSED!');
            console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
            return true;
        }

        // ============================================================================
        // PROCESSAMENTO DATI RILIEVO
        // ============================================================================
        function processRilievoData(data, filename) {
            console.log('âš™ï¸ Processing rilievo data...');
            
            // âœ… CONTROLLO SICUREZZA: Garantisci che posizioni sia un array
            if (!data.posizioni || !Array.isArray(data.posizioni)) {
                console.warn('âš ï¸ Dati senza campo posizioni valido, inizializzo array vuoto');
                data.posizioni = [];
            }

            // âš ï¸ FIX CRITICO: Salva SEMPRE in currentData, indipendentemente dalla validazione
            // Questo permette al wizard di analizzare i dati e completarli
            window.currentData = data;
            console.log('âœ… currentData salvato:', window.currentData);
            
            // Salva nello stato
            appState.rilievoData = data;
            
            // Update menu status con nuovi dati
            if (window.CompletionTracker && menuStructure) {
                console.log('ğŸ”„ Updating menu status...');
                CompletionTracker.updateMenuStatus(menuStructure, data);
                // renderAdvancedMenu(); // Sidebar rimossa
                
                // Update badge completamento sui bottoni top nav
                updateTopNavBadges();
            }
            
            appState.lastImport = {
                filename: filename,
                timestamp: new Date().toISOString(),
                posizioni: data.posizioni.length
            };

            // Salva in localStorage
            saveToLocalStorage(data, filename);

            // Mostra successo
            showDataStatus(data);
            showAlert('success', `âœ… Rilievo caricato con successo: ${data.posizioni.length} posizioni`);

            // Mostra contenuto
            document.getElementById('generalePlaceholder').style.display = 'none';
            document.getElementById('generaleContent').style.display = 'block';

            // Genera dashboard Blocco Generale
            generateKPIDashboard(data);
            populateFilters(data);
            generateTable(data);

            // Genera Vista Generale Blocco Ufficio
            renderVistaGeneraleUfficio(data);
            
            // Prepara dati per Vista Posizioni (renderizzata quando attivata)
            // I dati sono giÃ  in currentData, la vista si popolerÃ  al click del submenu

            // âœ… NUOVO: Prepara viste Blocco Posa
            // Le viste si popoleranno quando l'utente passerÃ  al Blocco Posa
            
            // âœ… SISTEMA PREVENTIVAZIONE: Abilita pulsanti
            const btnPreventivo = document.getElementById('btn-preventivo');
            if (btnPreventivo) {
                btnPreventivo.disabled = false;
                btnPreventivo.style.opacity = '1';
                btnPreventivo.style.cursor = 'pointer';
                console.log('âœ… Pulsante Analisi Costi abilitato');
            }
            
            const btnConferma = document.getElementById('btn-conferma-cliente');
            if (btnConferma) {
                btnConferma.disabled = false;
                btnConferma.style.opacity = '1';
                btnConferma.style.cursor = 'pointer';
                console.log('âœ… Pulsante Conferma Cliente abilitato');
            }

            // âœ… MENU DINAMICO v7.27: Aggiorna indicatori completamento
            aggiornaMenuIndicatori();

            console.log('âœ… Data processed and stored');
        }

        // ============================================================================
        // âœ… MENU DINAMICO CON INDICATORI v7.27
        // ============================================================================
        
        /**
         * Calcola completamento Blocco GENERALE
         * Campi: cliente, telefono, indirizzo, citta, dataRilievo, tecnico
         */
        function calcolaCompletamentoGenerale(data) {
            if (!data) return 0;
            
            let completati = 0;
            const totali = 6;
            
            if (data.cliente_nome && data.cliente_nome.trim()) completati++;
            if (data.cliente_telefono && data.cliente_telefono.trim()) completati++;
            if (data.cliente_indirizzo && data.cliente_indirizzo.trim()) completati++;
            if (data.cliente_citta && data.cliente_citta.trim()) completati++;
            if (data.data_rilievo && data.data_rilievo.trim()) completati++;
            if (data.tecnico_nome && data.tecnico_nome.trim()) completati++;
            
            return Math.round((completati / totali) * 100);
        }
        
        /**
         * Calcola completamento Blocco UFFICIO
         * Somma di tutti i campi configurazione prodotti
         */
        function calcolaCompletamentoUfficio(data) {
            if (!data || !data.configurazioni) return 0;
            
            let completati = 0;
            let totali = 0;
            const config = data.configurazioni;
            
            // Configurazione Infissi (8 campi)
            if (config.infissi) {
                totali += 8;
                if (config.infissi.azienda) completati++;
                if (config.infissi.telaio) completati++;
                if (config.infissi.materialeTelaio) completati++;
                if (config.infissi.tipoAnta) completati++;
                if (config.infissi.vetro) completati++;
                if (config.infissi.coloreInterno) completati++;
                if (config.infissi.coloreEsterno) completati++;
                if (config.infissi.maniglia) completati++;
            }
            
            // Configurazione Persiane (5 campi)
            if (config.persiane) {
                totali += 5;
                if (config.persiane.azienda) completati++;
                if (config.persiane.tipo) completati++;
                if (config.persiane.colore) completati++;
                if (config.persiane.oscurante) completati++;
                if (config.persiane.automazione) completati++;
            }
            
            // Configurazione Tapparelle (4 campi)
            if (config.tapparelle) {
                totali += 4;
                if (config.tapparelle.azienda) completati++;
                if (config.tapparelle.tipo) completati++;
                if (config.tapparelle.colore) completati++;
                if (config.tapparelle.automazione) completati++;
            }
            
            // Configurazione Zanzariere (4 campi)
            if (config.zanzariere) {
                totali += 4;
                if (config.zanzariere.azienda) completati++;
                if (config.zanzariere.tipo) completati++;
                if (config.zanzariere.colore) completati++;
                if (config.zanzariere.rete) completati++;
            }
            
            // Configurazione Cassonetti (3 campi)
            if (config.cassonetti) {
                totali += 3;
                if (config.cassonetti.azienda) completati++;
                if (config.cassonetti.tipo) completati++;
                if (config.cassonetti.isolamento) completati++;
            }
            
            if (totali === 0) return 0;
            return Math.round((completati / totali) * 100);
        }
        
        /**
         * Calcola completamento Blocco POSA
         * Media completamento posizioni (5 prodotti per posizione)
         */
        function calcolaCompletamentoPosa(data) {
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                return 0;
            }
            
            let totaleCompletamento = 0;
            
            data.posizioni.forEach(pos => {
                let completatiPos = 0;
                const totaliPos = 5; // 5 prodotti
                
                // Infisso
                if (pos.infisso && pos.infisso.quantita > 0) completatiPos++;
                
                // Persiana
                if (pos.persiana && pos.persiana.quantita > 0) completatiPos++;
                
                // Tapparella
                if (pos.tapparella && pos.tapparella.quantita > 0) completatiPos++;
                
                // Zanzariera
                if (pos.zanzariera && pos.zanzariera.quantita > 0) completatiPos++;
                
                // Cassonetto
                if (pos.cassonetto && pos.cassonetto.quantita > 0) completatiPos++;
                
                totaleCompletamento += (completatiPos / totaliPos) * 100;
            });
            
            return Math.round(totaleCompletamento / data.posizioni.length);
        }
        
        /**
         * Calcola completamento Blocco PREVENTIVO
         * 100% se ha almeno 1 posizione con prezzi, altrimenti 0%
         */
        function calcolaCompletamentoPreventivo(data) {
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                return 0;
            }
            
            let hasPrezzi = false;
            
            data.posizioni.forEach(pos => {
                // Verifica se almeno 1 prodotto ha prezzo > 0
                if (pos.infisso && pos.infisso.prezzo > 0) hasPrezzi = true;
                if (pos.persiana && pos.persiana.prezzo > 0) hasPrezzi = true;
                if (pos.tapparella && pos.tapparella.prezzo > 0) hasPrezzi = true;
                if (pos.zanzariera && pos.zanzariera.prezzo > 0) hasPrezzi = true;
                if (pos.cassonetto && pos.cassonetto.prezzo > 0) hasPrezzi = true;
            });
            
            return hasPrezzi ? 100 : 0;
        }
        
        /**
         * Restituisce colore in base a percentuale completamento
         */
        function getColoreIndicatore(percentuale) {
            if (percentuale === 100) return '#4CAF50'; // Verde
            if (percentuale >= 50) return '#FFC107';   // Giallo
            if (percentuale > 0) return '#F44336';     // Rosso
            return '#9E9E9E';                           // Grigio
        }
        
        /**
         * Aggiorna indicatore percentuale su singolo bottone menu
         */
        function aggiornaIndicatoreMenu(blocco, percentuale) {
            const btn = document.querySelector(`.nav-btn.blocco-${blocco}`);
            if (!btn) {
                console.warn(`âš ï¸ Bottone menu non trovato: blocco-${blocco}`);
                return;
            }
            
            // Trova/crea span indicatore
            let indicator = btn.querySelector('.indicator-percentage');
            if (!indicator) {
                indicator = document.createElement('span');
                indicator.className = 'indicator-percentage';
                btn.appendChild(indicator);
            }
            
            // Aggiorna testo e colore
            indicator.textContent = `${percentuale}%`;
            indicator.style.color = getColoreIndicatore(percentuale);
        }
        
        /**
         * Aggiorna TUTTI gli indicatori menu
         */
        function aggiornaMenuIndicatori() {
            const data = window.currentData || appState.rilievoData;
            
            if (!data) {
                console.warn('âš ï¸ Nessun dato disponibile per aggiornare indicatori');
                return;
            }
            
            console.log('ğŸ”„ Aggiornamento indicatori menu...');
            
            // Calcola percentuali
            const percGenerale = calcolaCompletamentoGenerale(data);
            const percUfficio = calcolaCompletamentoUfficio(data);
            const percPreventivo = calcolaCompletamentoPreventivo(data);
            
            console.log(`   Generale: ${percGenerale}%`);
            console.log(`   Ufficio: ${percUfficio}%`);
            console.log(`   Preventivo: ${percPreventivo}%`);
            
            // Aggiorna UI
            aggiornaIndicatoreMenu('generale', percGenerale);
            aggiornaIndicatoreMenu('ufficio', percUfficio);
            aggiornaIndicatoreMenu('preventivo', percPreventivo);
            
            console.log('âœ… Indicatori menu aggiornati');
        }

        /**
         * Calcola percentuale completamento di un blocco (media delle sottosezioni)
         */
        function calcolaCompletamentoBlocco(bloccoKey) {
            if (!menuStructure || !menuStructure[bloccoKey]) {
                return 0;
            }
            
            const items = menuStructure[bloccoKey].items;
            if (!items || items.length === 0) {
                return 0;
            }
            
            // Somma percentuali di tutte le sottosezioni
            let somma = 0;
            let count = 0;
            
            items.forEach(item => {
                if (item.completamento !== undefined) {
                    somma += item.completamento;
                    count++;
                }
            });
            
            // Calcola media e arrotonda
            return count > 0 ? Math.round(somma / count) : 0;
        }

        /**
         * Aggiorna badge completamento sui bottoni top navigation
         */
        function updateTopNavBadges() {
            if (!menuStructure) {
                console.warn('âš ï¸ menuStructure non disponibile per top nav badges');
                return;
            }
            
            // Array dei blocchi da processare
            const blocchi = [
                { key: 'generale', selector: '.nav-btn.blocco-generale' },
                { key: 'ufficio', selector: '.nav-btn.blocco-ufficio' }
            ];
            
            blocchi.forEach(blocco => {
                // Calcola percentuale completamento blocco
                const percent = calcolaCompletamentoBlocco(blocco.key);
                
                // Trova bottone
                const btn = document.querySelector(blocco.selector);
                if (!btn) {
                    console.warn(`âš ï¸ Bottone non trovato: ${blocco.selector}`);
                    return;
                }
                
                // Rimuovi badge esistente se presente
                const oldBadge = btn.querySelector('.completion-badge');
                if (oldBadge) {
                    oldBadge.remove();
                }
                
                // Crea e aggiungi nuovo badge
                const badge = document.createElement('span');
                badge.className = 'completion-badge';
                badge.textContent = `${percent}%`;
                
                // Aggiungi tooltip
                badge.title = `Completamento ${blocco.key}: ${percent}%`;
                
                btn.appendChild(badge);
                
                console.log(`âœ… Badge aggiunto a ${blocco.key}: ${percent}%`);
            });
        }

        // ============================================================================
        // GENERA KPI DASHBOARD
        // ============================================================================
        function generateKPIDashboard(data) {
            console.log('ğŸ“Š Generating KPI dashboard...');

            const stats = calculateStatistics(data);
            
            const kpiHTML = `
                <div class="kpi-card">
                    <div class="kpi-label">Posizioni Totali</div>
                    <div class="kpi-value">${stats.totalePosizioni}</div>
                    <div class="kpi-subtitle">nel progetto</div>
                </div>

                <div class="kpi-card green">
                    <div class="kpi-label">Infissi</div>
                    <div class="kpi-value">${stats.totaleInfissi}</div>
                    <div class="kpi-subtitle">${stats.percentualeInfissi}% del totale</div>
                </div>

                <div class="kpi-card orange">
                    <div class="kpi-label">Tapparelle</div>
                    <div class="kpi-value">${stats.totaleTapparelle}</div>
                    <div class="kpi-subtitle">${stats.percentualeTapparelle}% del totale</div>
                </div>

                <div class="kpi-card teal">
                    <div class="kpi-label">Altri Prodotti</div>
                    <div class="kpi-value">${stats.totaleAltri}</div>
                    <div class="kpi-subtitle">Persiane, zanzariere, etc.</div>
                </div>

                <div class="kpi-card">
                    <div class="kpi-label">Piani</div>
                    <div class="kpi-value">${stats.numeroPiani}</div>
                    <div class="kpi-subtitle">${stats.numeroStanze} stanze totali</div>
                </div>

                <div class="kpi-card green">
                    <div class="kpi-label">Completamento</div>
                    <div class="kpi-value">${stats.completamento}%</div>
                    <div class="kpi-subtitle">Rilievo completo</div>
                </div>
            `;

            document.getElementById('kpiCards').innerHTML = kpiHTML;
            console.log('âœ… KPI dashboard generated');
        }

        // ============================================================================
        // CALCOLA STATISTICHE
        // ============================================================================
        function calculateStatistics(data) {
            const posizioni = data.posizioni || [];
            
            let totaleInfissi = 0;
            let totaleTapparelle = 0;
            let totalePersiane = 0;
            let totaleZanzariere = 0;
            let totaleCassonetti = 0;

            const pianiSet = new Set();
            const stanzeSet = new Set();

            posizioni.forEach(pos => {
                // Conta prodotti
                if (pos.infisso && pos.infisso.quantita > 0) {
                    totaleInfissi += pos.infisso.quantita;
                }
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    totaleTapparelle += pos.tapparella.quantita;
                }
                if (pos.persiana && pos.persiana.quantita > 0) {
                    totalePersiane += pos.persiana.quantita;
                }
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    totaleZanzariere += pos.zanzariera.quantita;
                }
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    totaleCassonetti += pos.cassonetto.quantita;
                }

                // Raccogli piani e stanze
                if (pos.piano) pianiSet.add(pos.piano);
                if (pos.stanza) stanzeSet.add(pos.stanza);
            });

            const totaleAltri = totalePersiane + totaleZanzariere + totaleCassonetti;
            const totaleProdotti = totaleInfissi + totaleTapparelle + totaleAltri;

            return {
                totalePosizioni: posizioni.length,
                totaleInfissi,
                totaleTapparelle,
                totalePersiane,
                totaleZanzariere,
                totaleCassonetti,
                totaleAltri,
                totaleProdotti,
                percentualeInfissi: totaleProdotti > 0 ? Math.round((totaleInfissi / totaleProdotti) * 100) : 0,
                percentualeTapparelle: totaleProdotti > 0 ? Math.round((totaleTapparelle / totaleProdotti) * 100) : 0,
                numeroPiani: pianiSet.size,
                numeroStanze: stanzeSet.size,
                completamento: 100 // TODO: calcolare in base a campi compilati
            };
        }

        // ============================================================================
        // POPOLA FILTRI
        // ============================================================================
        function populateFilters(data) {
            console.log('ğŸ” Populating filters...');

            const posizioni = data.posizioni || [];
            const pianiSet = new Set();
            const stanzeSet = new Set();
            const prodottiSet = new Set();

            posizioni.forEach(pos => {
                if (pos.piano) pianiSet.add(pos.piano);
                if (pos.stanza) stanzeSet.add(pos.stanza);

                // Raccogli tipi prodotti presenti
                if (pos.infisso && pos.infisso.quantita > 0) prodottiSet.add('Infisso');
                if (pos.tapparella && pos.tapparella.quantita > 0) prodottiSet.add('Tapparella');
                if (pos.persiana && pos.persiana.quantita > 0) prodottiSet.add('Persiana');
                if (pos.zanzariera && pos.zanzariera.quantita > 0) prodottiSet.add('Zanzariera');
                if (pos.cassonetto && pos.cassonetto.quantita > 0) prodottiSet.add('Cassonetto');
            });

            // Popola select piano
            const filterPiano = document.getElementById('filterPiano');
            filterPiano.innerHTML = '<option value="">Tutti i piani</option>';
            Array.from(pianiSet).sort().forEach(piano => {
                filterPiano.innerHTML += `<option value="${piano}">${piano}</option>`;
            });

            // Popola select stanza
            const filterStanza = document.getElementById('filterStanza');
            filterStanza.innerHTML = '<option value="">Tutte le stanze</option>';
            Array.from(stanzeSet).sort().forEach(stanza => {
                filterStanza.innerHTML += `<option value="${stanza}">${stanza}</option>`;
            });

            // Popola select prodotto
            const filterProdotto = document.getElementById('filterProdotto');
            filterProdotto.innerHTML = '<option value="">Tutti i prodotti</option>';
            Array.from(prodottiSet).sort().forEach(prodotto => {
                filterProdotto.innerHTML += `<option value="${prodotto}">${prodotto}</option>`;
            });

            console.log('âœ… Filters populated');
        }

        // ============================================================================
        // GENERA TABELLA
        // ============================================================================
        let currentSortColumn = null;
        let currentSortDirection = 'asc';

        function generateTable(data, filteredPositions = null) {
            console.log('ğŸ“‹ Generating table...');

            const posizioni = filteredPositions || data.posizioni || [];

            if (posizioni.length === 0) {
                document.getElementById('tableContainer').innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ”</div>
                        <div>Nessuna posizione trovata con i filtri selezionati</div>
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable" onclick="sortTable('id')">ID</th>
                            <th class="sortable" onclick="sortTable('piano')">Piano</th>
                            <th class="sortable" onclick="sortTable('stanza')">Stanza</th>
                            <th>Ambiente</th>
                            <th>Prodotti</th>
                            <th class="sortable" onclick="sortTable('dimensioni')">Dimensioni</th>
                            <th class="sortable" onclick="sortTable('quantita')">Qta</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            posizioni.forEach(pos => {
                // Raccogli prodotti
                const prodotti = [];
                if (pos.infisso && pos.infisso.quantita > 0) {
                    prodotti.push(`<span class="product-badge infisso">Infisso x${pos.infisso.quantita}</span>`);
                }
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    prodotti.push(`<span class="product-badge tapparella">Tapparella x${pos.tapparella.quantita}</span>`);
                }
                if (pos.persiana && pos.persiana.quantita > 0) {
                    prodotti.push(`<span class="product-badge persiana">Persiana x${pos.persiana.quantita}</span>`);
                }
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    prodotti.push(`<span class="product-badge zanzariera">Zanzariera x${pos.zanzariera.quantita}</span>`);
                }
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    prodotti.push(`<span class="product-badge cassonetto">Cassonetto x${pos.cassonetto.quantita}</span>`);
                }

                // Dimensioni
                const lvt = pos.misure?.LVT || '-';
                const hvt = pos.misure?.HVT || '-';
                const dimensioni = `${lvt} Ã— ${hvt}`;

                tableHTML += `
                    <tr>
                        <td><strong>${pos.id || '-'}</strong></td>
                        <td>${pos.piano || '-'}</td>
                        <td>${pos.stanza || '-'}</td>
                        <td>${pos.ambiente || pos.nome || '-'}</td>
                        <td>${prodotti.join(' ')}</td>
                        <td>${dimensioni}</td>
                        <td>${pos.quantita || 1}</td>
                    </tr>
                `;
            });

            tableHTML += `
                    </tbody>
                </table>
            `;

            document.getElementById('tableContainer').innerHTML = tableHTML;
            console.log(`âœ… Table generated with ${posizioni.length} rows`);
        }

        // ============================================================================
        // ORDINAMENTO TABELLA
        // ============================================================================
        function sortTable(column) {
            if (!appState.rilievoData) return;

            console.log(`ğŸ”„ Sorting by: ${column}`);

            // Toggle direction se stessa colonna
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'asc';
            }

            // Copia array per non modificare originale
            const sortedPositions = [...(appState.rilievoData.posizioni || [])];

            // Sort
            sortedPositions.sort((a, b) => {
                let valA, valB;

                switch (column) {
                    case 'id':
                        valA = a.id || '';
                        valB = b.id || '';
                        break;
                    case 'piano':
                        valA = a.piano || '';
                        valB = b.piano || '';
                        break;
                    case 'stanza':
                        valA = a.stanza || '';
                        valB = b.stanza || '';
                        break;
                    case 'dimensioni':
                        valA = (a.misure?.LVT || 0) * (a.misure?.HVT || 0);
                        valB = (b.misure?.LVT || 0) * (b.misure?.HVT || 0);
                        break;
                    case 'quantita':
                        valA = a.quantita || 1;
                        valB = b.quantita || 1;
                        break;
                    default:
                        return 0;
                }

                if (typeof valA === 'string') {
                    return currentSortDirection === 'asc' 
                        ? valA.localeCompare(valB)
                        : valB.localeCompare(valA);
                } else {
                    return currentSortDirection === 'asc'
                        ? valA - valB
                        : valB - valA;
                }
            });

            // Rigenera tabella con posizioni ordinate
            generateTable(appState.rilievoData, sortedPositions);

            // Aggiorna UI header
            document.querySelectorAll('.data-table th').forEach(th => {
                th.classList.remove('sorted-asc', 'sorted-desc');
            });
            const sortedTh = document.querySelector(`.data-table th[onclick="sortTable('${column}')"]`);
            if (sortedTh) {
                sortedTh.classList.add(`sorted-${currentSortDirection}`);
            }
        }

        // ============================================================================
        // APPLICA FILTRI
        // ============================================================================
        function applyFilters() {
            if (!appState.rilievoData) return;

            console.log('ğŸ” Applying filters...');

            const filterPiano = document.getElementById('filterPiano').value;
            const filterStanza = document.getElementById('filterStanza').value;
            const filterProdotto = document.getElementById('filterProdotto').value;
            const searchText = document.getElementById('searchInput').value.toLowerCase();

            let filteredPositions = appState.rilievoData.posizioni || [];

            // Filtro piano
            if (filterPiano) {
                filteredPositions = filteredPositions.filter(pos => pos.piano === filterPiano);
            }

            // Filtro stanza
            if (filterStanza) {
                filteredPositions = filteredPositions.filter(pos => pos.stanza === filterStanza);
            }

            // Filtro prodotto
            if (filterProdotto) {
                filteredPositions = filteredPositions.filter(pos => {
                    const hasProdotto = 
                        (filterProdotto === 'Infisso' && pos.infisso && pos.infisso.quantita > 0) ||
                        (filterProdotto === 'Tapparella' && pos.tapparella && pos.tapparella.quantita > 0) ||
                        (filterProdotto === 'Persiana' && pos.persiana && pos.persiana.quantita > 0) ||
                        (filterProdotto === 'Zanzariera' && pos.zanzariera && pos.zanzariera.quantita > 0) ||
                        (filterProdotto === 'Cassonetto' && pos.cassonetto && pos.cassonetto.quantita > 0);
                    return hasProdotto;
                });
            }

            // Ricerca testuale
            if (searchText) {
                filteredPositions = filteredPositions.filter(pos => {
                    const searchableText = [
                        pos.id,
                        pos.nome,
                        pos.piano,
                        pos.stanza,
                        pos.ambiente
                    ].join(' ').toLowerCase();
                    
                    return searchableText.includes(searchText);
                });
            }

            console.log(`âœ… Filtered: ${filteredPositions.length}/${appState.rilievoData.posizioni.length} posizioni`);
            generateTable(appState.rilievoData, filteredPositions);
        }

        // ============================================================================
        // RESET FILTRI
        // ============================================================================
        function resetFilters() {
            document.getElementById('filterPiano').value = '';
            document.getElementById('filterStanza').value = '';
            document.getElementById('filterProdotto').value = '';
            document.getElementById('searchInput').value = '';
            
            if (appState.rilievoData) {
                generateTable(appState.rilievoData);
            }
            
            showAlert('info', 'ğŸ”„ Filtri resettati');
        }
        function saveToLocalStorage(data, filename) {
            try {
                const storageData = {
                    rilievo: data,
                    metadata: {
                        filename: filename,
                        importDate: new Date().toISOString(),
                        version: '6.1'
                    }
                };

                localStorage.setItem('dashboard_rilievo_current', JSON.stringify(storageData));
                console.log('ğŸ’¾ Data saved to localStorage');
            } catch (error) {
                console.error('âŒ localStorage save error:', error);
                showAlert('warning', 'âš ï¸ Impossibile salvare in localStorage');
            }
        }

        function loadFromLocalStorage() {
            try {
                const stored = localStorage.getItem('dashboard_rilievo_current');
                if (stored) {
                    const storageData = JSON.parse(stored);
                    console.log('ğŸ“‚ Found data in localStorage');
                    
                    // Ripristina stato
                    appState.rilievoData = storageData.rilievo;
                    appState.lastImport = {
                        filename: storageData.metadata.filename,
                        timestamp: storageData.metadata.importDate,
                        posizioni: storageData.rilievo.posizioni.length
                    };

                    // Mostra dati
                    showDataStatus(storageData.rilievo);
                    document.getElementById('generalePlaceholder').style.display = 'none';
                    document.getElementById('generaleContent').style.display = 'block';

                    // Rigenera dashboard
                    generateKPIDashboard(storageData.rilievo);
                    populateFilters(storageData.rilievo);
                    generateTable(storageData.rilievo);

                    showAlert('info', 'ğŸ“‚ Rilievo precedente ripristinato da memoria');
                }
            } catch (error) {
                console.error('âŒ localStorage load error:', error);
            }
        }

        // ============================================================================
        // EXPORT CSV/EXCEL
        // ============================================================================
        function exportToCSV() {
            if (!appState.rilievoData) {
                showAlert('warning', 'âš ï¸ Nessun dato da esportare');
                return;
            }

            console.log('ğŸ“Š Exporting to CSV...');

            const posizioni = appState.rilievoData.posizioni || [];
            
            // Header CSV - AGGIUNTO RILIEVI
            let csv = 'ID,Piano,Stanza,Ambiente,Quantita,LVT,HVT,Infisso,Tapparella,Persiana,Zanzariera,Cassonetto,';
            csv += 'Rilievo_Infissi_Materiale,Rilievo_Infissi_Togliere,Rilievo_Infissi_Smaltimento,';
            csv += 'Rilievo_Persiane_Materiale,Rilievo_Persiane_Togliere,Rilievo_Persiane_Smaltimento,';
            csv += 'Rilievo_Tapparelle_Materiale,Rilievo_Tapparelle_Togliere,Rilievo_Tapparelle_Smaltimento,';
            csv += 'Rilievo_Zanzariere_Materiale,Rilievo_Zanzariere_Togliere,Rilievo_Zanzariere_Smaltimento,';
            csv += 'Rilievo_Cassonetti_Materiale,Rilievo_Cassonetti_Togliere,Rilievo_Cassonetti_Smaltimento\n';

            // Righe dati
            posizioni.forEach(pos => {
                const row = [
                    pos.id || '',
                    pos.piano || '',
                    pos.stanza || '',
                    pos.ambiente || pos.nome || '',
                    pos.quantita || 1,
                    pos.misure?.LVT || '',
                    pos.misure?.HVT || '',
                    (pos.infisso && pos.infisso.quantita > 0) ? 'SI' : 'NO',
                    (pos.tapparella && pos.tapparella.quantita > 0) ? 'SI' : 'NO',
                    (pos.persiana && pos.persiana.quantita > 0) ? 'SI' : 'NO',
                    (pos.zanzariera && pos.zanzariera.quantita > 0) ? 'SI' : 'NO',
                    (pos.cassonetto && pos.cassonetto.quantita > 0) ? 'SI' : 'NO',
                    // Rilievi Infissi
                    pos.rilievo_preesistente?.materiale || '',
                    pos.rilievo_preesistente?.togliere ? 'SI' : 'NO',
                    pos.rilievo_preesistente?.smaltimento ? 'SI' : 'NO',
                    // Rilievi Persiane
                    pos.rilievo_persiane?.materiale || '',
                    pos.rilievo_persiane?.togliere ? 'SI' : 'NO',
                    pos.rilievo_persiane?.smaltimento ? 'SI' : 'NO',
                    // Rilievi Tapparelle
                    pos.rilievo_tapparelle?.materiale || '',
                    pos.rilievo_tapparelle?.togliere ? 'SI' : 'NO',
                    pos.rilievo_tapparelle?.smaltimento ? 'SI' : 'NO',
                    // Rilievi Zanzariere
                    pos.rilievo_zanzariere?.materiale || '',
                    pos.rilievo_zanzariere?.togliere ? 'SI' : 'NO',
                    pos.rilievo_zanzariere?.smaltimento ? 'SI' : 'NO',
                    // Rilievi Cassonetti
                    pos.rilievo_cassonetti?.materiale || '',
                    pos.rilievo_cassonetti?.togliere ? 'SI' : 'NO',
                    pos.rilievo_cassonetti?.smaltimento ? 'SI' : 'NO'
                ];

                csv += row.join(',') + '\n';
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `rilievo-export-${Date.now()}.csv`;
            link.click();
            URL.revokeObjectURL(url);

            showAlert('success', 'âœ… CSV esportato con successo');
            console.log('âœ… CSV exported');
        }

        // ============================================================================
        // EXPORT JSON
        // ============================================================================
        function exportToJSON() {
            if (!appState.rilievoData) {
                showAlert('warning', 'âš ï¸ Nessun dato da esportare');
                return;
            }

            console.log('ğŸ’¾ Exporting to JSON...');

            const dataStr = JSON.stringify(appState.rilievoData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            const filename = appState.lastImport?.filename || `rilievo-${Date.now()}.json`;
            link.download = `backup-${filename}`;
            link.click();
            
            URL.revokeObjectURL(url);
            showAlert('success', 'âœ… JSON esportato con successo');
            console.log('âœ… JSON exported');
        }

        // ============================================================================
        // UI: MOSTRA STATO DATI
        // ============================================================================
        function showDataStatus(data) {
            const statusDiv = document.getElementById('dataStatus');
            
            // Estrai informazioni in modo sicuro da formati diversi
            const numPosizioni = data.posizioni?.length || 0;
            const nomeCliente = data.cliente?.nome || 
                               data.rilievo?.cliente?.nome || 
                               data.customerName || 
                               'N/D';
            const nomeProgetto = data.cliente?.progetto || 
                                data.rilievo?.meta?.id_rilievo || 
                                data.projectName || 
                                'Progetto';
            const dataRilievo = data.data_rilievo || 
                               data.rilievo?.meta?.data_creazione || 
                               data.metadata?.created || 
                               Date.now();
            
            const html = `
                <div class="status-badge success">
                    âœ… ${numPosizioni} Posizioni
                </div>
                <div class="status-badge info">
                    ğŸ‘¤ ${nomeCliente}
                </div>
                <div class="status-badge info">
                    ğŸ“‹ ${nomeProgetto}
                </div>
                <div class="status-badge info">
                    ğŸ“… ${new Date(dataRilievo).toLocaleDateString('it-IT')}
                </div>
            `;

            statusDiv.innerHTML = html;
            statusDiv.style.display = 'flex';
        }

        // ============================================================================
        // UI: ALERT/NOTIFICHE
        // ============================================================================
        function showAlert(type, message) {
            // Rimuovi alert precedenti
            const existingAlerts = document.querySelectorAll('.alert');
            existingAlerts.forEach(alert => alert.remove());

            // Crea nuovo alert
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;

            // Inserisci dopo header
            const container = document.querySelector('.container');
            container.insertBefore(alert, container.firstChild);

            // Rimuovi dopo 5 secondi
            setTimeout(() => {
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 300);
            }, 5000);
        }

        // ============================================================================
        // INIZIALIZZAZIONE
        // ============================================================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸš€ Dashboard Rilievi v7.39 - LISTINO: Implementato sistema calcolo prezzi tapparelle Plasticino/New Solar/Estella');
            console.log('ğŸ“Š Initializing...');

            // Carica dati se presenti in localStorage
            loadFromLocalStorage();

            console.log('âœ… App ready');
        });

        // ============================================================================
        // RESET DATI
        // ============================================================================
        function resetData() {
            if (confirm('âš ï¸ Cancellare tutti i dati caricati?')) {
                localStorage.removeItem('dashboard_rilievo_current');
                appState.rilievoData = null;
                appState.lastImport = null;
                
                document.getElementById('dataStatus').style.display = 'none';
                document.getElementById('generalePlaceholder').style.display = 'block';
                document.getElementById('generaleContent').style.display = 'none';
                
                // âœ… v7.20: Uso classList invece di style.display per ufficio
                document.getElementById('ufficioPlaceholder').classList.remove('content-hidden');
                document.getElementById('ufficioContent').classList.add('content-hidden');
                
                // Reset filtri
                document.getElementById('filterPiano').value = '';
                document.getElementById('filterStanza').value = '';
                document.getElementById('filterProdotto').value = '';
                document.getElementById('searchInput').value = '';
                
                showAlert('info', 'ğŸ”„ Dati cancellati');
                console.log('ğŸ”„ Data reset');
            }
        }

        // ============================================================================
        // BLOCCO UFFICIO - NAVIGAZIONE VISTE
        // ============================================================================
        function switchVistaUfficio(vistaName, evt) {
            console.log(`ğŸ”„ Switching to vista: ${vistaName}`);
            
            // âœ… v7.20 FIX: RESET tutte le viste prima di cambiare
            // Ripristina stato iniziale (placeholder visibile, content nascosto)
            const allContentIds = ['ufficioContent', 'posizioniContent', 'aziendeContent', 'preventivoContent'];
            const allPlaceholderIds = ['ufficioPlaceholder', 'posizioniPlaceholder', 'aziendePlaceholder', 'preventivoPlaceholder'];
            
            allContentIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.add('content-hidden');
            });
            
            allPlaceholderIds.forEach(id => {
                const el = document.getElementById(id);
                if (el) el.classList.remove('content-hidden');
            });
            
            // âœ… v7.21: Pulisci container totali quando non in Vista Generale
            if (vistaName !== 'generale') {
                const totaliContainer = document.getElementById('totaliCommessaContainer');
                if (totaliContainer) {
                    totaliContainer.innerHTML = '';
                    console.log('ğŸ§¹ Totali Commessa rimossi (non in Vista Generale)');
                }
            }
            
            // Nascondi tutte le viste
            document.querySelectorAll('.vista-ufficio').forEach(v => v.classList.remove('active'));
            // Mostra vista selezionata
            document.getElementById(`vista-${vistaName}-ufficio`).classList.add('active');
            
            // Aggiorna pulsanti submenu
            document.querySelectorAll('.submenu-btn').forEach(btn => btn.classList.remove('active'));
            
            // Trova e attiva il pulsante corretto
            if (evt && evt.target) {
                evt.target.closest('.submenu-btn').classList.add('active');
            } else {
                // Fallback: cerca pulsante per nome vista
                document.querySelectorAll('.submenu-btn').forEach(btn => {
                    if (btn.onclick && btn.onclick.toString().includes(`'${vistaName}'`)) {
                        btn.classList.add('active');
                    }
                });
            }
            
            // Se vista posizioni, renderizza se ci sono dati
            if (vistaName === 'posizioni' && currentData && currentData.posizioni) {
                console.log(`ğŸ“‹ Rendering Vista Posizioni con ${currentData.posizioni.length} posizioni...`);
                renderVistaPosizioniUfficio(currentData);
            } else if (vistaName === 'posizioni') {
                console.warn('âš ï¸ Vista Posizioni richiesta ma nessun dato disponibile');
            }
            
            // Se vista aziende, renderizza se ci sono dati
            if (vistaName === 'aziende' && currentData && currentData.posizioni) {
                console.log(`ğŸ¢ Rendering Vista Aziende con ${currentData.posizioni.length} posizioni...`);
                renderVistaAziende(currentData);
            } else if (vistaName === 'aziende') {
                console.warn('âš ï¸ Vista Aziende richiesta ma nessun dato disponibile');
            }
            
            // âœ… v7.22: Se vista preventivo, renderizza se ci sono dati
            if (vistaName === 'preventivo' && currentData && currentData.posizioni) {
                console.log(`ğŸ’° Rendering Vista Preventivo con ${currentData.posizioni.length} posizioni...`);
                renderVistaPreventivo(currentData);
            } else if (vistaName === 'preventivo') {
                console.warn('âš ï¸ Vista Preventivo richiesta ma nessun dato disponibile');
            }
            
            console.log(`âœ… Vista ${vistaName} attivata`);
        }

        // ============================================================================
        // BLOCCO UFFICIO - RENDER VISTA GENERALE
        // ============================================================================
        function renderVistaGeneraleUfficio(data) {
            console.log('ğŸ“Š Rendering Vista Generale Ufficio...');
            
            // Nascondi placeholder, mostra contenuto (usando classList invece di style.display)
            document.getElementById('ufficioPlaceholder').classList.add('content-hidden');
            document.getElementById('ufficioContent').classList.remove('content-hidden');
            
            // âœ… v7.21: CREA sezione totali dinamicamente
            createTotaliCommessaSection();
            
            // Popola tutte le sezioni
            renderInfoCliente(data);
            // renderCaratteristicheMuro(data); // âŒ ELIMINATO
            // âŒ RIMOSSO: renderConfigurazioneInfissi(data) - Spostato in Vista Aziende
            renderTotaliCommessa(data);
            renderRiepilogoEconomico(data); // âœ… NUOVO: Riepilogo economico con totale
            
            console.log('âœ… Vista Generale Ufficio rendered');
        }

        // ============================================================================
        // SEZIONE A: INFO CLIENTE
        // ============================================================================
        function renderInfoCliente(data) {
            const cliente = data.cliente || {};
            const clientData = data.clientData || {};
            
            // âœ… FALLBACK INTELLIGENTE per compatibilitÃ  con formato app v4.17
            // Nome Cliente: usa client (root) se clientData.nome vuoto
            const nomeCliente = clientData.nome || cliente.nome || data.client || 'N/D';
            
            // Nome Progetto: usa name (root) come fallback principale
            const nomeProgetto = clientData.progetto || cliente.progetto || data.name || data.nome_ricerca || 'N/D';
            
            // Piano: usa clientData.piano o cliente.piano
            const piano = clientData.piano || cliente.piano || 'N/D';
            
            // Indirizzo: costruisce intelligentemente da indirizzo + cittÃ 
            let indirizzo = 'N/D';
            const via = clientData.indirizzo || cliente.indirizzo || cliente.via || '';
            const citta = clientData.citta || cliente.citta || '';
            
            if (via && citta) {
                indirizzo = `${via}, ${citta}`;
            } else if (via) {
                indirizzo = via;
            } else if (citta) {
                indirizzo = citta;
            }
            
            // Telefono e Email
            const telefono = clientData.telefono || cliente.telefono || 'N/D';
            const email = clientData.email || cliente.email || 'N/D';
            
            const html = `
                <div class="info-item">
                    <div class="info-label">Nome Cliente</div>
                    <div class="info-value-large">${nomeCliente}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Nome Progetto</div>
                    <div class="info-value">${nomeProgetto}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Piano</div>
                    <div class="info-value">${piano}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Indirizzo</div>
                    <div class="info-value">${indirizzo}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Telefono</div>
                    <div class="info-value">${telefono}</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Email</div>
                    <div class="info-value">${email}</div>
                </div>
            `;
            
            document.getElementById('infoCliente').innerHTML = html;
            
            // Note progetto (se presenti)
            if (data.note_progetto || data.notes) {
                const noteHtml = `
                    <div class="note-box">
                        <div class="note-box-title">ğŸ“ Note Progetto</div>
                        <div class="note-box-content">${data.note_progetto || data.notes}</div>
                    </div>
                `;
                document.getElementById('noteProgetto').innerHTML = noteHtml;
            } else {
                document.getElementById('noteProgetto').innerHTML = '';
            }
        }

        // ============================================================================
        // SEZIONE B: CARATTERISTICHE MURO GLOBALI
        // ============================================================================

        // ============================================================================
        // SEZIONE CONFIG INFISSI - CONFIGURAZIONE GLOBALE PRODOTTI
        // ============================================================================
        function renderConfigurazioneInfissi(data) {
            const config = data.configInfissi || {};
            
            // Verifica se ci sono dati
            const hasConfig = Object.keys(config).length > 0;
            
            if (!hasConfig) {
                document.getElementById('configInfissiContent').innerHTML = `
                    <p style="color: #6b7280; font-style: italic; text-align: center; padding: 2rem;">
                        Nessuna configurazione infissi presente
                    </p>
                `;
                return;
            }
            
            const configItems = [
                { label: 'Azienda', value: config.azienda, icon: 'ğŸ¢' },
                { label: 'Tipo Anta', value: config.tipoAnta, icon: 'ğŸšª' },
                { label: 'Telaio', value: config.telaio, icon: 'â¬œ' },
                { label: 'Finitura Interna', value: config.finituraInt, icon: 'ğŸ¨' },
                { label: 'Finitura Esterna', value: config.finituraEst, icon: 'ğŸ¨' },
                { label: 'Colore Interno', value: config.coloreInt, icon: 'ğŸŒˆ' },
                { label: 'Colore Esterno', value: config.coloreEst, icon: 'ğŸŒˆ' },
                { label: 'Allarme', value: config.allarme, icon: 'ğŸ””' },
                { label: 'Vetro', value: config.vetro, icon: 'ğŸ’' },
                { label: 'Maniglia', value: config.maniglia, icon: 'ğŸ”§' },
                { label: 'Colore Maniglia', value: config.coloreManiglia, icon: 'ğŸ¨' }
            ].filter(item => item.value); // Mostra solo campi compilati
            
            const html = `
                <div class="wall-chars-grid">
                    ${configItems.map(item => `
                        <div class="wall-char-item">
                            <div class="wall-char-label">${item.icon} ${item.label}</div>
                            <div class="wall-char-value">${item.value}</div>
                        </div>
                    `).join('')}
                </div>
                ${configItems.length === 0 ? `
                    <p style="color: #6b7280; font-style: italic; text-align: center; padding: 1rem;">
                        Configurazione non completa
                    </p>
                ` : ''}
            `;
            
            document.getElementById('configInfissiContent').innerHTML = html;
        }

        // ============================================================================
        // CREAZIONE DINAMICA SEZIONE TOTALI COMMESSA - v7.21
        // ============================================================================
        function createTotaliCommessaSection() {
            const container = document.getElementById('totaliCommessaContainer');
            if (!container) return;
            
            // Crea HTML completo
            container.innerHTML = `
                <div class="card-ufficio">
                    <h2 class="card-ufficio-title">
                        <span class="card-ufficio-icon">ğŸ“¦</span>
                        Totali Commessa
                    </h2>
                    
                    <h3 style="font-size: 1rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem;">
                        Riepilogo QuantitÃ 
                    </h3>
                    <div id="totaliQuantita" class="totali-grid">
                        <!-- Popolato dinamicamente -->
                    </div>

                    <h3 style="font-size: 1rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem; margin-top: 2rem;">
                        Riepilogo Economico
                    </h3>
                    <div id="riepilogoEconomico" class="economico-list">
                        <!-- Popolato dinamicamente -->
                    </div>
                </div>
            `;
            
            console.log('âœ… Sezione Totali Commessa creata dinamicamente');
        }

        // ============================================================================
        // SEZIONE C: TOTALI COMMESSA
        // ============================================================================
        function renderTotaliCommessa(data) {
            const stats = calculateTotaliCommessa(data);
            
            const html = `
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_posizioni}</div>
                    <div class="totale-label">Posizioni</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_infissi}</div>
                    <div class="totale-label">Infissi</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_tapparelle}</div>
                    <div class="totale-label">Tapparelle</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_persiane}</div>
                    <div class="totale-label">Persiane</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_zanzariere}</div>
                    <div class="totale-label">Zanzariere</div>
                </div>
                <div class="totale-item">
                    <div class="totale-numero">${stats.n_cassonetti}</div>
                    <div class="totale-label">Cassonetti</div>
                </div>
            `;
            
            document.getElementById('totaliQuantita').innerHTML = html;
        }

        // Helper: calcola totali commessa
        function calculateTotaliCommessa(data) {
            const posizioni = data.posizioni || [];
            
            let n_infissi = 0;
            let n_tapparelle = 0;
            let n_persiane = 0;
            let n_zanzariere = 0;
            let n_cassonetti = 0;
            
            posizioni.forEach(pos => {
                // Infissi
                if (pos.infisso && pos.infisso.quantita > 0) {
                    n_infissi += parseInt(pos.infisso.quantita) || 0;
                }
                
                // Tapparelle
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    n_tapparelle += parseInt(pos.tapparella.quantita) || 0;
                }
                
                // Persiane
                if (pos.persiana && pos.persiana.quantita > 0) {
                    n_persiane += parseInt(pos.persiana.quantita) || 0;
                }
                
                // Zanzariere
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    n_zanzariere += parseInt(pos.zanzariera.quantita) || 0;
                }
                
                // Cassonetti
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    n_cassonetti += parseInt(pos.cassonetto.quantita) || 0;
                }
            });
            
            return {
                n_posizioni: posizioni.length,
                n_infissi,
                n_tapparelle,
                n_persiane,
                n_zanzariere,
                n_cassonetti
            };
        }

        // ============================================================================
        // NUOVO: RIEPILOGO ECONOMICO CON TOTALE
        // ============================================================================
        function renderRiepilogoEconomico(data) {
            console.log('ğŸ’° Calcolo riepilogo economico...');
            
            try {
                // Calcola preventivo usando PreventivoCalculator
                const preventivo = window.PreventivoCalculator.calcolaPreventivo(data);
                
                if (!preventivo.successo || !preventivo.voci) {
                    console.warn('âš ï¸ Preventivo non calcolabile, mostro placeholder');
                    document.getElementById('riepilogoEconomico').innerHTML = `
                        <div style="text-align: center; padding: 2rem; color: #6b7280; font-style: italic;">
                            Configura i prodotti per calcolare i costi
                        </div>
                    `;
                    return;
                }
                
                // Raggruppa totali per categoria
                const totali = {
                    infissi: 0,
                    persiane: 0,
                    tapparelle: 0,
                    zanzariere: 0,
                    cassonetti: 0
                };
                
                preventivo.voci.forEach(voce => {
                    const importo = parseFloat(voce.importo) || 0;
                    const tipo = voce.tipo.toLowerCase();
                    
                    if (tipo.includes('infisso')) {
                        totali.infissi += importo;
                    } else if (tipo.includes('persiana')) {
                        totali.persiane += importo;
                    } else if (tipo.includes('tapparella')) {
                        totali.tapparelle += importo;
                    } else if (tipo.includes('zanzariera')) {
                        totali.zanzariere += importo;
                    } else if (tipo.includes('cassonetto')) {
                        totali.cassonetti += importo;
                    }
                });
                
                const totaleGenerale = Object.values(totali).reduce((sum, val) => sum + val, 0);
                
                // Genera HTML (OPZIONE A: Lista con totale evidenziato)
                let html = '';
                
                if (totali.infissi > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Infissi</span>
                            <span class="economico-value">â‚¬ ${totali.infissi.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.persiane > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Persiane</span>
                            <span class="economico-value">â‚¬ ${totali.persiane.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.tapparelle > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Tapparelle</span>
                            <span class="economico-value">â‚¬ ${totali.tapparelle.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.zanzariere > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Zanzariere</span>
                            <span class="economico-value">â‚¬ ${totali.zanzariere.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                if (totali.cassonetti > 0) {
                    html += `
                        <div class="economico-item">
                            <span class="economico-label">Cassonetti</span>
                            <span class="economico-value">â‚¬ ${totali.cassonetti.toFixed(2)}</span>
                        </div>
                    `;
                }
                
                // TOTALE FINALE (evidenziato)
                html += `
                    <div class="economico-item totale">
                        <span class="economico-label">ğŸ’° TOTALE</span>
                        <span class="economico-value">â‚¬ ${totaleGenerale.toFixed(2)}</span>
                    </div>
                `;
                
                document.getElementById('riepilogoEconomico').innerHTML = html;
                console.log('âœ… Riepilogo economico renderizzato:', totaleGenerale.toFixed(2));
                
            } catch (error) {
                console.error('âŒ Errore calcolo riepilogo economico:', error);
                document.getElementById('riepilogoEconomico').innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #ef4444;">
                        Errore nel calcolo dei costi
                    </div>
                `;
            }
        }

        // ============================================================================
        // MENU AVANZATO - GESTIONE SIDEBAR E BREADCRUMB
        // ============================================================================
        
        // Struttura menu completa
        const menuStructure = {
            generale: {
                icon: 'ğŸ“Š',
                label: 'Generale',
                color: '#667eea',
                items: [
                    { id: 'dashboard', label: 'Dashboard', icon: 'ğŸ“Š', status: 'completed' },
                    { id: 'import', label: 'Import JSON', icon: 'ğŸ“¥', status: 'completed' },
                    { id: 'tabella', label: 'Tabella Completa', icon: 'ğŸ“‹', status: 'completed' },
                    { id: 'statistiche', label: 'Statistiche', icon: 'ğŸ“ˆ', status: 'completed' },
                    { id: 'export', label: 'Export', icon: 'ğŸ’¾', status: 'completed' }
                ]
            },
            ufficio: {
                icon: 'ğŸ’¼',
                label: 'Ufficio',
                color: '#10b981',
                items: [
                    { id: 'generale', label: 'Vista Generale', icon: 'ğŸ“Š', status: 'completed' },
                    { id: 'posizioni', label: 'Vista Posizioni', icon: 'ğŸ“‹', status: 'completed' },
                    { id: 'aziende', label: 'Vista Aziende', icon: 'ğŸ¢', status: 'completed' }
                ]
            },
            posa: {
                icon: 'ğŸ”§',
                label: 'Posa',
                color: '#f59e0b',
                items: [
                    { id: 'generale-cantiere', label: 'Vista Generale Cantiere', icon: 'ğŸ“¦', status: 'completed' },
                    { id: 'posizioni-cantiere', label: 'Vista Posizioni Cantiere', icon: 'ğŸ”¨', status: 'completed' }
                ]
            }
        };

        // Stato corrente menu
        let currentMenuState = {
            blocco: 'generale',
            sottosezione: 'dashboard'
        };

        // Render menu sidebar completo
        function renderAdvancedMenu() {
            const sidebar = document.getElementById('menuSidebar');
            if (!sidebar) return;

            let html = '';

            // Per ogni blocco
            Object.keys(menuStructure).forEach(bloccoKey => {
                const blocco = menuStructure[bloccoKey];
                
                html += `
                    <div class="sidebar-section">
                        <div class="sidebar-section-title">
                            <span>${blocco.icon}</span>
                            <span>${blocco.label.toUpperCase()}</span>
                        </div>
                `;

                // Items del blocco
                blocco.items.forEach(item => {
                    const isActive = currentMenuState.blocco === bloccoKey && 
                                   currentMenuState.sottosezione === item.id;
                    const isDisabled = item.status === 'disabled';
                    
                    html += `
                        <div class="menu-item ${isActive ? 'active blocco-'+bloccoKey : ''} ${isDisabled ? 'disabled' : ''} submenu-item"
                             onclick="${isDisabled ? '' : `navigateToSection('${bloccoKey}', '${item.id}')`}">
                            <span class="menu-item-icon">${item.icon}</span>
                            <span class="menu-item-text">${item.label}</span>
                            <span class="menu-item-badge badge-${item.status}">
                                ${window.BadgeRenderer ? 
                                    BadgeRenderer.getBadgeHTML(item) : 
                                    getStatusIcon(item.status)
                                }
                            </span>
                        </div>
                        ${item.completamento !== undefined && item.completamento < 100 && window.BadgeRenderer ? 
                            `<div style="padding: 0 12px;">${BadgeRenderer.renderMiniProgressBar(item.completamento)}</div>` : 
                            ''
                        }
                    `;
                });

                html += `</div>`;
            });

            // Keyboard shortcuts hint
            html += `
                <div class="keyboard-hint">
                    <strong>âŒ¨ï¸ Shortcuts:</strong><br>
                    <kbd>G</kbd> Generale â€¢ <kbd>U</kbd> Ufficio â€¢ <kbd>P</kbd> Posa<br>
                    <kbd>â†</kbd> <kbd>â†’</kbd> Naviga sezioni
                </div>
            `;

            sidebar.innerHTML = html;
        }

        // Get status icon
        function getStatusIcon(status) {
            switch(status) {
                case 'completed': return 'âœ…';
                case 'in-progress': return 'â³';
                case 'disabled': return 'âŒ';
                default: return '';
            }
        }

        // Toggle menu (mobile)
        function toggleMenu() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.toggle('open');
                overlay.classList.toggle('active');
            }
        }
        
        // Chiudi sidebar
        function closeSidebar() {
            const sidebar = document.getElementById('sidebarMenu');
            const overlay = document.getElementById('sidebarOverlay');
            
            if (sidebar && overlay) {
                sidebar.classList.remove('open');
                overlay.classList.remove('active');
            }
        }
        
        // Toggle GitHub Projects cascata
        function toggleGithubProjects(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const expandable = event.currentTarget;
            const submenu = document.getElementById('githubProjectsList');
            
            if (expandable && submenu) {
                expandable.classList.toggle('expanded');
                
                if (submenu.style.display === 'none') {
                    submenu.style.display = 'block';
                } else {
                    submenu.style.display = 'none';
                }
            }
        }
        
        // Toggle Impostazioni nel menu laterale
        function toggleImpostazioni(event) {
            event.preventDefault();
            event.stopPropagation();
            
            const expandable = event.currentTarget;
            const submenu = document.getElementById('impostazioniMenu');
            
            if (expandable && submenu) {
                expandable.classList.toggle('expanded');
                
                if (submenu.style.display === 'none') {
                    submenu.style.display = 'block';
                } else {
                    submenu.style.display = 'none';
                }
            }
        }
        
        // Popola menu laterale con progetti GitHub
        function updateSidebarMenu(projects) {
            const submenu = document.getElementById('githubProjectsList');
            if (!submenu) return;
            
            if (projects.length === 0) {
                submenu.innerHTML = '<div style="padding: 1rem; text-align: center; color: #9ca3af; font-size: 0.875rem;">Nessun progetto trovato</div>';
                return;
            }
            
            submenu.innerHTML = projects.map(proj => `
                <a href="#" onclick="loadGitHubProject('${proj.id}'); closeSidebar(); return false;">
                    ğŸ‘¤ ${proj.cliente || proj.nome}
                </a>
            `).join('');
            
            console.log(`âœ… Menu laterale aggiornato con ${projects.length} progetti`);
        }
        
        // Carica progetto GitHub specifico
        function loadGitHubProject(projectId) {
            const project = window.githubProjects?.find(p => p.id === projectId);
            if (!project || !project.rawData) {
                console.error('âŒ Progetto non trovato:', projectId);
                return;
            }
            
            console.log('ğŸ“‚ Caricamento progetto:', project.cliente);
            
            // Carica i dati del progetto nella dashboard
            appState.rilievoData = project.rawData;
            processData(project.rawData, project.nome + '.json');
            
            // âœ… MENU DINAMICO v7.27: Aggiorna indicatori dopo caricamento GitHub
            setTimeout(() => aggiornaMenuIndicatori(), 100);
            
            // Switch a vista generale per vedere i dati
            switchBlocco('generale');
        }

        // Navigate to section
        function navigateToSection(blocco, sottosezione) {
            console.log(`Navigate to: ${blocco} > ${sottosezione}`);
            
            // Update state
            currentMenuState.blocco = blocco;
            currentMenuState.sottosezione = sottosezione;
            
            // Switch blocco if different
            if (currentBlocco !== blocco) {
                switchBlocco(blocco);
            }
            
            // Update breadcrumb
            updateBreadcrumb(blocco, sottosezione);
            
            // Re-render menu to update active state
            renderAdvancedMenu();
            
            // Close mobile menu
            const sidebar = document.getElementById('menuSidebar');
            if (sidebar && window.innerWidth <= 768) {
                sidebar.classList.remove('open');
            }
            
            // Handle specific actions based on section
            handleSectionAction(blocco, sottosezione);
        }

        // Handle section-specific actions
        function handleSectionAction(blocco, sottosezione) {
            switch(blocco) {
                case 'generale':
                    // Scroll to relevant section
                    switch(sottosezione) {
                        case 'dashboard':
                            window.scrollTo({ top: 0, behavior: 'smooth' });
                            break;
                        case 'tabella':
                            const tableSection = document.getElementById('kpiCardsContainer');
                            if (tableSection) {
                                tableSection.scrollIntoView({ behavior: 'smooth' });
                            }
                            break;
                    }
                    break;
                    
                case 'ufficio':
                    switch(sottosezione) {
                        case 'generale':
                            switchVistaUfficio('generale');
                            break;
                        case 'posizioni':
                            switchVistaUfficio('posizioni');
                            break;
                        case 'aziende':
                            switchVistaUfficio('aziende');
                            break;
                    }
                    break;
            }
        }

        // Update breadcrumb
        function updateBreadcrumb(blocco, sottosezione) {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!breadcrumb) return;

            const bloccoLabel = menuStructure[blocco]?.label || blocco;
            const sottosezioneItem = menuStructure[blocco]?.items.find(i => i.id === sottosezione);
            const sottosezioneLabel = sottosezioneItem?.label || sottosezione;

            breadcrumb.innerHTML = `
                <div class="breadcrumb-content">
                    <a href="#" class="breadcrumb-item" onclick="navigateToSection('generale', 'dashboard'); return false;">Dashboard</a>
                    <span class="breadcrumb-separator">â€º</span>
                    <span class="breadcrumb-item">${bloccoLabel}</span>
                    <span class="breadcrumb-separator">â€º</span>
                    <span class="breadcrumb-item current">${sottosezioneLabel}</span>
                </div>
            `;
        }

        // Setup keyboard shortcuts
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if typing in input
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                    return;
                }

                switch(e.key.toLowerCase()) {
                    case 'g':
                        navigateToSection('generale', 'dashboard');
                        break;
                    case 'u':
                        navigateToSection('ufficio', 'generale');
                        break;
                }
            });
        }

        // Modify existing switchBlocco to update menu state
        const originalSwitchBlocco = switchBlocco;
        switchBlocco = function(blocco) {
            originalSwitchBlocco(blocco);
            currentMenuState.blocco = blocco;
            
            // Set default sottosezione
            const defaultSottosezione = menuStructure[blocco]?.items[0]?.id || 'dashboard';
            currentMenuState.sottosezione = defaultSottosezione;
            
            updateBreadcrumb(blocco, defaultSottosezione);
            renderAdvancedMenu();
        };

        // ============================================================================
        // VISTA POSIZIONI UFFICIO - Variabili Globali
        // ============================================================================
        let currentPositionIndex = 0;
        let filteredPositions = [];
        let allPositionsData = [];

        // ============================================================================
        // VISTA POSIZIONI - RENDER PRINCIPALE
        // ============================================================================
        function renderVistaPosizioniUfficio(data) {
            console.log('ğŸ“‹ Rendering Vista Posizioni Ufficio...');
            
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                console.warn('âš ï¸ Nessuna posizione trovata');
                return;
            }

            // Nascondi placeholder, mostra contenuto (usando classList invece di style.display)
            document.getElementById('posizioniPlaceholder').classList.add('content-hidden');
            document.getElementById('posizioniContent').classList.remove('content-hidden');
            
            // âœ… Popola header progetto
            const nomeProgetto = data.nome || data.projectName || 'Progetto Senza Nome';
            const nomeCliente = data.cliente?.nome || data.cliente?.ragione_sociale || 
                              data.customerName || 'Cliente Non Specificato';
            const cognomeCliente = data.cliente?.cognome || '';
            const dataRilievo = data.data_rilievo || data.metadata?.created || Date.now();
            const numPosizioni = data.posizioni.length;
            
            // Formatta data
            const dataFormatted = new Date(dataRilievo).toLocaleDateString('it-IT', {
                day: '2-digit',
                month: 'long',
                year: 'numeric'
            });
            
            // Aggiorna elementi header
            document.getElementById('projectNameDisplay').textContent = nomeProgetto;
            document.getElementById('projectClientDisplay').textContent = 
                `ğŸ‘¤ ${nomeCliente}${cognomeCliente ? ' ' + cognomeCliente : ''}`;
            document.getElementById('projectDateDisplay').textContent = `ğŸ“… ${dataFormatted}`;
            document.getElementById('projectPositionsCountDisplay').textContent = 
                `ğŸ“ ${numPosizioni} posizion${numPosizioni !== 1 ? 'i' : 'e'}`;
            
            console.log(`â„¹ï¸ Header progetto popolato: ${nomeProgetto} - ${nomeCliente}`);
            
            // Salva dati posizioni
            allPositionsData = data.posizioni;
            filteredPositions = [...allPositionsData];
            currentPositionIndex = 0;
            
            // Popola filtri
            populateFilters();
            
            // Rende lista e dettaglio
            renderPositionsList();
            renderPositionDetail(0);
            
            console.log(`âœ… Vista Posizioni rendered: ${allPositionsData.length} posizioni`);
        }

        // ============================================================================
        // BLOCCO UFFICIO - RENDER VISTA AZIENDE
        // ============================================================================
        function renderVistaAziende(data) {
            console.log('ğŸ¢ Rendering Vista Aziende...');
            
            // Nascondi placeholder, mostra contenuto (usando classList invece di style.display)
            document.getElementById('aziendePlaceholder').classList.add('content-hidden');
            document.getElementById('aziendeContent').classList.remove('content-hidden');
            
            // Raggruppa prodotti per azienda
            const aziendeMap = groupProductsByAzienda(data.posizioni);
            
            // NUOVO LAYOUT: Tab orizzontali + contenuto espandibile
            const aziendeArray = Array.from(aziendeMap.entries());
            
            // Genera HTML per tab orizzontali
            const tabsHTML = `
                <div class="aziende-tabs-container">
                    <div class="aziende-tabs">
                        ${aziendeArray.map(([aziendaKey, aziendaData], index) => {
                            const totaleProdotti = aziendaData.prodotti.reduce((sum, p) => sum + p.quantita, 0);
                            const displayName = aziendaData.displayName || aziendaKey;
                            return `
                                <div class="azienda-tab ${index === 0 ? 'active' : ''}" 
                                     onclick="showAziendaDetails('${displayName}', ${index})"
                                     id="azienda-tab-${index}">
                                    <div class="azienda-tab-icon">ğŸ¢</div>
                                    <div class="azienda-tab-content">
                                        <div class="azienda-tab-name">${displayName}</div>
                                        <div class="azienda-tab-count">${totaleProdotti} pz</div>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
            
            // Genera HTML per contenuti espandibili
            const contentsHTML = `
                <div class="aziende-details-container">
                    ${aziendeArray.map(([aziendaKey, aziendaData], index) => {
                        const displayName = aziendaData.displayName || aziendaKey;
                        return `
                            <div class="azienda-details ${index === 0 ? 'active' : ''}" 
                                 id="azienda-details-${index}">
                                ${renderAziendaCard(displayName, aziendaData, data)}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            // Inserisci nel DOM
            document.getElementById('aziendeCards').innerHTML = tabsHTML + contentsHTML;
            
            console.log(`âœ… Vista Aziende rendered: ${aziendeMap.size} aziende`);
        }

        // NUOVA FUNZIONE: Mostra dettagli azienda selezionata
        function showAziendaDetails(aziendaName, index) {
            // Rimuovi classe active da tutti i tab
            document.querySelectorAll('.azienda-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Rimuovi classe active da tutti i contenuti
            document.querySelectorAll('.azienda-details').forEach(details => {
                details.classList.remove('active');
            });
            
            // Aggiungi classe active al tab selezionato
            document.getElementById(`azienda-tab-${index}`).classList.add('active');
            
            // Aggiungi classe active al contenuto selezionato
            document.getElementById(`azienda-details-${index}`).classList.add('active');
            
            console.log(`ğŸ“‚ Azienda selezionata: ${aziendaName}`);
        }

        // ============================================================================
        // LISTINO FINSTRAL - EUR 2025/3
        // ============================================================================

        // CAMPIONI PREZZI BASE TIPO 101 (Battente 1 anta)
        const CAMPIONI_TIPO_101 = [
            // [L_min, L_max, A_min, A_max, prezzo_eur]
            // Larghezza 605-730 (piccole)
            [605, 665, 605, 665, 221],
            [605, 665, 730, 790, 235],
            [605, 665, 855, 915, 248],
            [605, 665, 1040, 1105, 285],
            [605, 665, 1230, 1290, 320],
            [605, 665, 1415, 1480, 350],
            // Larghezza 800-865 (medie-piccole)
            [800, 865, 605, 665, 248],
            [800, 865, 790, 855, 277],
            [800, 865, 1040, 1105, 337],
            [800, 865, 1230, 1290, 370],
            [800, 865, 1415, 1480, 393],
            [800, 865, 1615, 1675, 423],
            // Larghezza 1050-1115 (medie)
            [1050, 1115, 605, 665, 300],
            [1050, 1115, 790, 855, 337],
            [1050, 1115, 1040, 1105, 414],
            [1050, 1115, 1230, 1290, 451],
            [1050, 1115, 1415, 1480, 480],
            [1050, 1115, 1615, 1675, 518],
            // Larghezza 1300-1365 (medie-grandi)
            [1300, 1365, 605, 665, 340],
            [1300, 1365, 790, 855, 382],
            [1300, 1365, 1040, 1105, 466],
            [1300, 1365, 1230, 1290, 511],
            [1300, 1365, 1415, 1480, 541],
            [1300, 1365, 1615, 1675, 586],
            // Larghezza 1550-1615 (grandi)
            [1550, 1615, 605, 665, 367],
            [1550, 1615, 790, 855, 412],
            [1550, 1615, 1040, 1105, 505],
            [1550, 1615, 1230, 1290, 551],
            [1550, 1615, 1415, 1480, 585],
            [1550, 1615, 1615, 1675, 628],
            // Larghezza 1800-1865 (molto grandi)
            [1800, 1865, 605, 665, 392],
            [1800, 1865, 790, 855, 437],
            [1800, 1865, 1040, 1105, 535],
            [1800, 1865, 1230, 1290, 586],
            [1800, 1865, 1415, 1480, 618],
            [1800, 1865, 1615, 1675, 653],
            // Larghezza 2050+ (extra large)
            [2050, 2115, 605, 665, 422],
            [2050, 2115, 790, 855, 474],
            [2050, 2115, 1040, 1105, 581],
            [2050, 2115, 1230, 1290, 636],
            [2050, 2115, 1415, 1480, 672],
            // Larghezza max
            [2790, 2855, 605, 665, 541],
            [2790, 2855, 790, 855, 650],
            [2790, 2855, 1040, 1105, 833],
            [2790, 2855, 1230, 1290, 872],
            [2915, 2980, 605, 665, 552],
            [2915, 2980, 790, 855, 661],
            [2915, 2980, 1040, 1105, 856],
            [2915, 2980, 1230, 1290, 891],
            [2915, 2980, 1415, 1480, 884],
            [2915, 2980, 1615, 1675, 907]
        ];

        // CAMPIONI PREZZI BASE TIPO 401 (Battente 2 ante)
        const CAMPIONI_TIPO_401 = [
            // [L_min, L_max, A_min, A_max, prezzo_eur]
            // Larghezza 990-1115 (piccole 2 ante)
            [990, 1050, 605, 665, 378],
            [990, 1050, 730, 790, 403],
            [990, 1050, 855, 915, 423],
            [990, 1050, 1040, 1105, 514],
            [990, 1050, 1230, 1290, 566],
            [990, 1050, 1415, 1480, 613],
            [1115, 1175, 605, 665, 400],
            [1115, 1175, 730, 790, 429],
            [1115, 1175, 855, 915, 450],
            [1115, 1175, 1040, 1105, 541],
            [1115, 1175, 1230, 1290, 601],
            [1115, 1175, 1415, 1480, 658],
            // Larghezza 1300-1425 (medie 2 ante)
            [1300, 1365, 605, 665, 432],
            [1300, 1365, 730, 790, 457],
            [1300, 1365, 855, 915, 488],
            [1300, 1365, 1040, 1105, 588],
            [1300, 1365, 1230, 1290, 653],
            [1300, 1365, 1415, 1480, 712],
            [1425, 1490, 605, 665, 441],
            [1425, 1490, 730, 790, 472],
            [1425, 1490, 855, 915, 498],
            [1425, 1490, 1040, 1105, 604],
            [1425, 1490, 1230, 1290, 664],
            [1425, 1490, 1415, 1480, 725],
            // Larghezza 1550-1675 (grandi 2 ante)
            [1550, 1615, 605, 665, 458],
            [1550, 1615, 730, 790, 492],
            [1550, 1615, 855, 915, 523],
            [1550, 1615, 1040, 1105, 633],
            [1550, 1615, 1230, 1290, 698],
            [1550, 1615, 1415, 1480, 762],
            [1740, 1800, 605, 665, 487],
            [1740, 1800, 730, 790, 526],
            [1740, 1800, 855, 915, 560],
            [1740, 1800, 1040, 1105, 678],
            [1740, 1800, 1230, 1290, 744],
            [1740, 1800, 1415, 1480, 805],
            // Larghezza 1990-2050 (molto grandi)
            [1990, 2050, 605, 665, 509],
            [1990, 2050, 730, 790, 554],
            [1990, 2050, 855, 915, 594],
            [1990, 2050, 1040, 1105, 725],
            [1990, 2050, 1230, 1290, 793],
            [1990, 2050, 1415, 1480, 848],
            // Larghezza max
            [2790, 2855, 605, 665, 741],
            [2790, 2855, 730, 790, 808],
            [2790, 2855, 1040, 1105, 1016],
            [2790, 2855, 1230, 1290, 1116],
            [2915, 2980, 605, 665, 758],
            [2915, 2980, 730, 790, 825],
            [2915, 2980, 855, 915, 878],
            [2915, 2980, 1040, 1105, 1047],
            [2915, 2980, 1230, 1290, 1146],
            [2915, 2980, 1415, 1480, 1233]
        ];

        // TELAI PVC-PVC
        const TELAI_PVC = {
            "961": { base_incluso: true, supplemento_ml: 5.20 },
            "962": { base_incluso: true, supplemento_ml: 5.61 },
            "963": { supplemento_ml_chiaro: 2.89, supplemento_ml_scuro: 9.31 },
            "967": { base_incluso: true, supplemento_ml: 5.20 }  // Alias 961
        };

        // TELAI ALLUMINIO-PVC
        const TELAI_ALLUMINIO = {
            "961X": { supplemento_ml_chiaro: 23.6, supplemento_ml_scuro: 25.4 },
            "962X": { supplemento_ml_chiaro: 23.6, supplemento_ml_scuro: 25.4 },
            "963X": { supplemento_ml_chiaro: 23.6, supplemento_ml_scuro: 25.4 },
            "961N5": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 19.3 },
            "962N5": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 19.3 },
            "963N5": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 19.3 },
            "961N": { supplemento_ml_chiaro: 17.2, supplemento_ml_scuro: 20.4 },
            "962N": { supplemento_ml_chiaro: 17.2, supplemento_ml_scuro: 22.4 },
            "963N": { supplemento_ml_chiaro: 18.0, supplemento_ml_scuro: 24.9 }
        };

        // TELAI INTERNI
        const TELAI_INTERNI = {
            "F961": { supplemento_ml_chiaro: 16.9, supplemento_ml_scuro: 18.2 },
            "F962": { supplemento_ml_chiaro: 16.9, supplemento_ml_scuro: 18.2 }
        };

        // SUPPLEMENTI ANTE (al metro lineare)
        const SUPPLEMENTI_ANTE = {
            "classic-line": 0,        // Inclusa (standard)
            "classicline": 0,
            "step-line": 0,           // Inclusa (standard)
            "stepline": 0,
            "nova-line": 10,          // â‚¬ 10/ml
            "novaline": 10,
            "nova-line-plus": 10,     // â‚¬ 10/ml
            "novalineplus": 10,
            "nova-line-twin": 12,     // â‚¬ 12/ml
            "novalinetwin": 12
        };

        // SUPPLEMENTI VETRI (al mÂ² - solo se superficie > 2.5 mÂ²)
        const SUPPLEMENTI_VETRI = {
            "doppio": 0,              // Incluso (standard)
            "triplo": 35,             // â‚¬ 35/mÂ²
            "triplo-sat": 50,         // â‚¬ 50/mÂ²
            "triplo-satinato": 50,
            "triplo-selettivo": 60    // â‚¬ 60/mÂ²
        };


        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ğŸ”§ FUNZIONI PARSING MANIGLIE FINSTRAL - v7.26
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

        /**
         * Estrae codice maniglia da stringa tipo "6010 - Finestra alluminio"
         * @param {string} manigliaValue - Valore salvato (es: "6010 - Finestra alluminio" o "standard")
         * @returns {string} - Codice maniglia (es: "6010") o stringa originale se non parsabile
         */
        function estraiCodiceManiglia(manigliaValue) {
            if (!manigliaValue || manigliaValue === '') return '';
            
            // Se contiene " - " Ã¨ formato nuovo: "6010 - Finestra alluminio"
            if (manigliaValue.includes(' - ')) {
                const match = manigliaValue.match(/^(\S+)/);
                return match ? match[1] : '';
            }
            
            // Altrimenti Ã¨ valore vecchio: "standard", "inox", ecc.
            return manigliaValue;
        }

        /**
         * Estrae codice colore da stringa tipo "07 - Bianco perla"
         * @param {string} coloreValue - Valore salvato (es: "07 - Bianco perla" o "bianco")
         * @returns {string} - Codice colore (es: "07") o stringa originale se non parsabile
         */
        function estraiCodiceColore(coloreValue) {
            if (!coloreValue || coloreValue === '') return '';
            
            // Se contiene " - " Ã¨ formato nuovo: "07 - Bianco perla"
            if (coloreValue.includes(' - ')) {
                const match = coloreValue.match(/^(\S+)/);
                return match ? match[1] : '';
            }
            
            // Altrimenti Ã¨ valore vecchio: "bianco", "bronzo", ecc.
            return coloreValue;
        }

        /**
         * Calcola supplemento maniglia usando database Finstral
         * Supporta sia formato nuovo (6010 - Finestra) che vecchio (standard, inox)
         * @param {string} manigliaValue - Valore maniglia salvato
         * @param {string} coloreValue - Valore colore salvato
         * @returns {number} - Supplemento in â‚¬ (0 se non trovato o valori vecchi)
         */
        function calcolaSupplementoManigliaFinstral(manigliaValue, coloreValue) {
            const codiceManiglia = estraiCodiceManiglia(manigliaValue);
            const codiceColore = estraiCodiceColore(coloreValue);
            
            // Se Ã¨ formato vecchio (no codici Finstral), usa vecchia logica
            if (!manigliaValue || !manigliaValue.includes(' - ')) {
                // Valori vecchi: "standard", "inox", "design", ecc.
                return calcolaSupplementoManigliaVecchio(manigliaValue);
            }
            
            // Formato nuovo: usa database Finstral
            if (!codiceManiglia || !codiceColore) {
                return 0; // Campi vuoti
            }
            
            // Usa funzione del database
            return getSupplemento(codiceManiglia, codiceColore);
        }

        /**
         * Fallback per valori vecchi (pre-v4.31)
         * @param {string} tipoManiglia - "standard", "inox", "design", ecc.
         * @returns {number} - Supplemento in â‚¬
         */
        function calcolaSupplementoManigliaVecchio(tipoManiglia) {
            if (!tipoManiglia) return 0;
            const maniglia = tipoManiglia.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            
            // Supplementi vecchi (compatibilitÃ )
            const SUPPLEMENTI_VECCHI = {
                "standard": 0,
                "bianco": 0,
                "satinato": 0,
                "inox": 20,
                "design": 40,
                "con-chiave": 50
            };
            
            return SUPPLEMENTI_VECCHI[maniglia] || 0;
        }

        // SUPPLEMENTI MANIGLIE (DEPRECATO v7.26)
        // SOSTITUITO da database MANIGLIE_FINSTRAL
        // Mantenuto per riferimento storico
        /*
        const SUPPLEMENTI_MANIGLIE = {
            "standard": 0,            // Inclusa
            "bianco": 0,              // Inclusa
            "satinato": 0,            // Inclusa (variante standard)
            "inox": 20,               // â‚¬ 20/pezzo
            "design": 40,             // â‚¬ 40/pezzo
            "con-chiave": 50          // â‚¬ 50/pezzo
        };
        */

        // MAPPING APERTURE â†’ TIPI
        const MAPPING_APERTURE_TIPI = {
            // Battenti standard
            'battente_1_anta': 'tipo_101',
            'battente': 'tipo_101',
            'vasistas': 'tipo_101',
            'ribalta': 'tipo_101',
            // Aperture direzionali
            'dx': 'tipo_101',
            'sx': 'tipo_101',
            'destra': 'tipo_101',
            'sinistra': 'tipo_101',
            // Fissi
            'fisso': 'tipo_102',
            'f1': 'tipo_102',  // App usa F1 per fisso 1 campo
            // 2 Ante
            'battente_2_ante': 'tipo_401',
            'due_ante': 'tipo_401',
            'f2': 'tipo_401',  // App usa F2 per fisso 2 campi (o 2 ante)
            '2_ante': 'tipo_401',
            // Scorrevoli
            'scorrevole': 'tipo_501',
            'scorrevole_parallela': 'tipo_501',
            // Fallback
            'default': 'tipo_101'
        };

        // COSTI EXTRA
        const COSTI_EXTRA = {
            posa_per_pezzo: 50,         // â‚¬ per pezzo
            smontaggio_per_pezzo: 30    // â‚¬ per pezzo
        };

        // Funzione: Calcola perimetro BRM in metri lineari
        function calcolaPerimetroBRM(larghezza_mm, altezza_mm) {
            return 2 * (larghezza_mm + altezza_mm) / 1000;
        }

        // Funzione: Trova campione prezzo base
        function trovaCampionePrezzoBase(tipo, L_mm, A_mm) {
            let campioni;
            
            if (tipo === 'tipo_101') {
                campioni = CAMPIONI_TIPO_101;
            } else if (tipo === 'tipo_401') {
                campioni = CAMPIONI_TIPO_401;
            } else if (tipo === 'tipo_102') {
                // Fisso: usa tipo 101 con sconto 5%
                campioni = CAMPIONI_TIPO_101;
                const prezzo = trovaCampionePrezzoBase('tipo_101', L_mm, A_mm);
                return prezzo ? prezzo * 0.95 : null;
            } else {
                console.warn(`Tipo ${tipo} non trovato`);
                return null;
            }
            
            // Cerca campione esatto o piÃ¹ vicino
            for (const [L_min, L_max, A_min, A_max, prezzo] of campioni) {
                if (L_mm >= L_min && L_mm <= L_max && 
                    A_mm >= A_min && A_mm <= A_max) {
                    return prezzo;
                }
            }
            
            // Nessun campione trovato: usa piÃ¹ vicino per sicurezza
            let minDistanza = Infinity;
            let prezzoVicino = null;
            
            for (const [L_min, L_max, A_min, A_max, prezzo] of campioni) {
                const L_centro = (L_min + L_max) / 2;
                const A_centro = (A_min + A_max) / 2;
                const distanza = Math.sqrt(
                    Math.pow(L_mm - L_centro, 2) + 
                    Math.pow(A_mm - A_centro, 2)
                );
                
                if (distanza < minDistanza) {
                    minDistanza = distanza;
                    prezzoVicino = prezzo;
                }
            }
            
            console.warn(`âš ï¸ Prezzo per L=${L_mm}, A=${A_mm} non trovato, uso piÃ¹ vicino: â‚¬${prezzoVicino}`);
            return prezzoVicino;
        }

        // Funzione: Calcola supplemento telaio
        function calcolaSupplementoTelaio(codiceTelaio, perimetro_ml, coloreScuro = false) {
            let supplemento = 0;
            
            // Cerca in telai PVC
            if (TELAI_PVC[codiceTelaio]) {
                const telaio = TELAI_PVC[codiceTelaio];
                if (telaio.supplemento_ml) {
                    supplemento = telaio.supplemento_ml * perimetro_ml;
                } else {
                    const sup_ml = coloreScuro ? telaio.supplemento_ml_scuro : telaio.supplemento_ml_chiaro;
                    supplemento = sup_ml * perimetro_ml;
                }
            }
            // Cerca in telai Alluminio
            else if (TELAI_ALLUMINIO[codiceTelaio]) {
                const telaio = TELAI_ALLUMINIO[codiceTelaio];
                const sup_ml = coloreScuro ? telaio.supplemento_ml_scuro : telaio.supplemento_ml_chiaro;
                supplemento = sup_ml * perimetro_ml;
            }
            // Cerca in telai Interni
            else if (TELAI_INTERNI[codiceTelaio]) {
                const telaio = TELAI_INTERNI[codiceTelaio];
                const sup_ml = coloreScuro ? telaio.supplemento_ml_scuro : telaio.supplemento_ml_chiaro;
                supplemento = sup_ml * perimetro_ml;
            }
            
            return supplemento;
        }

        // Funzione: Determina se colore Ã¨ scuro (gruppo B)
        function isColoreScuro(colore) {
            if (!colore) return false;
            const coloreLC = colore.toLowerCase();
            
            // Gruppo A (chiari): bianco, bianco perla, bianco satinato, bianco goffrato
            const coloriChiari = ['bianco', 'white', 'ral 9010', 'ral 9016', 'perla', 'satinato', 'goffrato'];
            
            // Se contiene una parola chiara, Ã¨ chiaro
            if (coloriChiari.some(c => coloreLC.includes(c))) {
                return false;
            }
            
            // Altrimenti consideralo scuro (gruppo B)
            return true;
        }

        // Funzione: Ottieni tipo da apertura
        function getTipoDaApertura(apertura) {
            const aperturaLC = (apertura || '').toLowerCase().trim();
            return MAPPING_APERTURE_TIPI[aperturaLC] || MAPPING_APERTURE_TIPI['default'];
        }

        // Funzione: Calcola supplemento anta
        function calcolaSupplementoAnta(tipoAnta, perimetro_ml) {
            if (!tipoAnta) return 0;
            const anta = tipoAnta.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            const suppl_ml = SUPPLEMENTI_ANTE[anta] || 0;
            return suppl_ml * perimetro_ml;
        }

        // Funzione: Calcola supplemento vetro
        function calcolaSupplementoVetro(tipoVetro, superficie_mq) {
            if (!tipoVetro) return 0;
            const vetro = tipoVetro.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            const suppl_mq = SUPPLEMENTI_VETRI[vetro] || 0;
            
            // Applica supplemento solo se superficie > 2.5 mÂ²
            if (superficie_mq > 2.5) {
                return suppl_mq * superficie_mq;
            }
            return 0;
        }

        // Funzione: Calcola supplemento maniglia (DEPRECATA v7.26)
        // SOSTITUITA da calcolaSupplementoManigliaFinstral()
        // Mantenuta per debug e compatibilitÃ  temporanea
        /*
        function calcolaSupplementoManiglia(tipoManiglia) {
            if (!tipoManiglia) return 0;
            const maniglia = tipoManiglia.toLowerCase().replace(/\s+/g, '-').replace(/_/g, '-');
            return SUPPLEMENTI_MANIGLIE[maniglia] || 0;
        }
        */

        // ============================================================================
        // LISTINO PLASTICINO TAPPARELLE - 2025
        // ============================================================================
        
        const LISTINO_PLASTICINO = {
            // Componenti base tapparella
            componenti: {
                rullo: {
                    codice: "COMP-01",
                    nome: "Rullo Ottagonale 60mm",
                    prezzo_al_metro: 13.20,
                    calcolo: "larghezza_luce_m Ã— 13.20"
                },
                fissi: {
                    calotta: 15.00,              // COMP-02
                    avvolgitore: 10.00,          // COMP-03
                    cuscinetto: 3.50,            // COMP-04
                    supporti_coppia: 6.00,       // COMP-05 (2 pz)
                    ganci_coppia: 7.20,          // COMP-06 (2 pz)
                    placca: 5.00,                // COMP-08
                    passacinghia: 1.70,          // COMP-09
                    macchinetta: 18.00           // COMP-10
                },
                totale_fissi: 66.40  // Somma componenti fissi
            },
            
            // Supplementi opzionali
            supplementi: {
                doppia_altezza: {
                    codice: "COMP-07",
                    soglia_cm: 300,              // Applica supplemento se H > 300cm
                    prezzo_al_metro: 0.50,
                    calcolo: "(altezza - 300) / 100 Ã— 0.50"
                }
            },
            
            // Aziende che usano questo listino
            aziende: ['plasticino', 'new solar', 'estella']
        };
        
        /**
         * Calcola prezzo tapparella Plasticino completo
         * @param {number} L_cm - Larghezza luce in cm
         * @param {number} H_cm - Altezza in cm
         * @returns {object} Dettaglio calcolo con rullo, fissi, supplemento, totale
         */
        function calcolaPrezzoPLASTICINO(L_cm, H_cm) {
            const L_m = L_cm / 100;
            
            // COMP-01: Rullo (al metro sulla larghezza luce)
            const prezzoRullo = L_m * LISTINO_PLASTICINO.componenti.rullo.prezzo_al_metro;
            
            // COMP-02 a COMP-10: Componenti fissi (totale â‚¬66.40)
            const fissi = LISTINO_PLASTICINO.componenti.totale_fissi;
            
            // COMP-07: Supplemento doppia altezza (se H > 300cm)
            let suppAltezza = 0;
            if (H_cm > LISTINO_PLASTICINO.supplementi.doppia_altezza.soglia_cm) {
                const H_extra_m = (H_cm - LISTINO_PLASTICINO.supplementi.doppia_altezza.soglia_cm) / 100;
                suppAltezza = H_extra_m * LISTINO_PLASTICINO.supplementi.doppia_altezza.prezzo_al_metro;
            }
            
            // Totale tapparella
            const totale = prezzoRullo + fissi + suppAltezza;
            
            return {
                rullo: prezzoRullo,
                fissi: fissi,
                supplemento_altezza: suppAltezza,
                totale: totale,
                dettaglio: {
                    larghezza_cm: L_cm,
                    altezza_cm: H_cm,
                    larghezza_m: L_m.toFixed(2),
                    sopra_soglia: H_cm > LISTINO_PLASTICINO.supplementi.doppia_altezza.soglia_cm
                }
            };
        }

        // ============================================================================
        // RENDER VISTA PREVENTIVO - v7.24
        // ============================================================================

        function renderVistaPreventivo(data) {
            console.log('ğŸ’° Rendering Vista Preventivo...');
            
            // Nascondi placeholder, mostra contenuto
            document.getElementById('preventivoPlaceholder').classList.add('content-hidden');
            document.getElementById('preventivoContent').classList.remove('content-hidden');
            
            // Calcola preventivo
            const preventivo = calcolaPreventivo(data);
            
            // Popola tabella
            popolaTabellaPreventivo(preventivo);
            
            console.log('âœ… Vista Preventivo rendered');
        }

        function calcolaPreventivo(data) {
            console.log('ğŸ’° calcolaPreventivo() chiamata con data:', data);
            console.log('ğŸ“Š Numero posizioni:', (data.positions || data.posizioni || []).length);
            
            const righe = [];
            let totaleMateriali = 0;
            let numeroPezzi = 0;
            
            // GESTISCI ENTRAMBE LE STRUTTURE: positions (app) e posizioni (vecchio)
            const posizioni = data.positions || data.posizioni || [];
            
            console.log('ğŸ” Struttura posizioni:', posizioni.length > 0 ? 'OK' : 'VUOTA');
            
            // Processa ogni posizione
            posizioni.forEach((pos, index) => {
                // Processa INFISSI
                if (pos.infisso && pos.infisso.qta > 0) {
                    const infisso = pos.infisso;
                    
                    // LEGGI MISURE BRM (con fallback a misure LVT/HVT)
                    let L_mm = infisso.BRM_L || infisso.brm?.L;
                    let H_mm = infisso.BRM_H || infisso.brm?.H;
                    
                    // FALLBACK: Se BRM null, usa misure LVT/HVT
                    if (!L_mm && pos.misure?.LVT) {
                        L_mm = parseInt(pos.misure.LVT);
                        console.warn(`âš ï¸ Pos ${index + 1}: BRM_L null, uso LVT=${L_mm}`);
                    }
                    if (!H_mm && pos.misure?.HVT) {
                        H_mm = parseInt(pos.misure.HVT);
                        console.warn(`âš ï¸ Pos ${index + 1}: BRM_H null, uso HVT=${H_mm}`);
                    }
                    
                    if (L_mm && H_mm) {
                        // Calcola perimetro BRM
                        const perimetro_ml = calcolaPerimetroBRM(L_mm, H_mm);
                        const superficie_mq = (L_mm * H_mm) / 1000000;
                        
                        // Ottieni telaio (da configurazione o da infisso)
                        const telaio = infisso.telaio || 
                                       data.configInfissi?.telaio || 
                                       '961';
                        
                        // Determina colore (per supplemento)
                        const coloreEsterno = infisso.coloreEst || 
                                             infisso.coloreEsterno || 
                                             data.configInfissi?.coloreEst ||
                                             data.configInfissi?.coloreEsterno || 
                                             '';
                        const coloreScuro = isColoreScuro(coloreEsterno);
                        
                        // Ottieni tipo apertura e prezzo base
                        const apertura = infisso.apertura || infisso.tipo || 'battente';
                        const tipo = getTipoDaApertura(apertura);
                        const prezzoBase = trovaCampionePrezzoBase(tipo, L_mm, H_mm) || 400;
                        
                        // Calcola supplemento telaio
                        const supplementoTelaio = calcolaSupplementoTelaio(telaio, perimetro_ml, coloreScuro);
                        
                        // Calcola supplemento anta
                        const tipoAnta = infisso.tipoAnta || data.configInfissi?.tipoAnta || 'step-line';
                        const supplementoAnta = calcolaSupplementoAnta(tipoAnta, perimetro_ml);
                        
                        // Calcola supplemento vetro
                        const tipoVetro = infisso.vetro || data.configInfissi?.vetro || 'doppio';
                        const supplementoVetro = calcolaSupplementoVetro(tipoVetro, superficie_mq);
                        
                        // Calcola supplemento maniglia (v7.26: supporta database Finstral)
                        const manigliaValue = infisso.maniglia || data.configInfissi?.maniglia || '';
                        const coloreValue = infisso.coloreManiglia || data.configInfissi?.coloreManiglia || '';
                        const supplementoManiglia = calcolaSupplementoManigliaFinstral(manigliaValue, coloreValue);
                        
                        // Prezzo unitario (con tutti i supplementi)
                        const supplementoTotale = supplementoTelaio + supplementoAnta + supplementoVetro + supplementoManiglia;
                        const prezzoUnitario = prezzoBase + supplementoTotale;
                        
                        // QuantitÃ  (prioritÃ : pos.quantita > infisso.qta > 1)
                        const quantita = parseInt(pos.quantita) || parseInt(infisso.qta) || 1;
                        
                        // Totale riga
                        const totaleRiga = prezzoUnitario * quantita;
                        
                        righe.push({
                            posizione: index + 1,
                            ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                            tipo: 'Infisso',
                            azienda: infisso.azienda || data.configInfissi?.azienda || 'Finstral',
                            telaio: telaio,
                            larghezza: L_mm,
                            altezza: H_mm,
                            superficie: superficie_mq.toFixed(2),
                            perimetro: perimetro_ml.toFixed(2),
                            prezzoBase: prezzoBase.toFixed(2),
                            supplemento: supplementoTotale.toFixed(2),
                            supplementoTelaio: supplementoTelaio.toFixed(2),
                            supplementoAnta: supplementoAnta.toFixed(2),
                            supplementoVetro: supplementoVetro.toFixed(2),
                            supplementoManiglia: supplementoManiglia.toFixed(2),
                            prezzoUnitario: prezzoUnitario.toFixed(2),
                            quantita: quantita,
                            totale: totaleRiga.toFixed(2)
                        });
                        
                        totaleMateriali += totaleRiga;
                        numeroPezzi += quantita;
                    } else {
                        console.warn(`âš ï¸ Pos ${index + 1}: Misure BRM non trovate, salto calcolo`);
                    }
                }
                
                // ============================================================================
                // TAPPARELLE - PLASTICINO/NEW SOLAR/ESTELLA
                // ============================================================================
                
                // ğŸ” DEBUG: Log completo posizione
                console.log(`ğŸ” DEBUG Pos ${index + 1}:`, {
                    ha_tapparella: !!pos.tapparella,
                    tapparella_completo: pos.tapparella,
                    quantita: pos.tapparella?.quantita,
                    azienda: pos.tapparella?.azienda
                });
                
                // âœ… FIX: Accetta anche quantita undefined/null (tratta come 1)
                if (pos.tapparella && (pos.tapparella.quantita === undefined || pos.tapparella.quantita === null || pos.tapparella.quantita > 0)) {
                    const tapp = pos.tapparella;
                    const azienda = (tapp.azienda || '').toLowerCase();
                    
                    // FIX: Se quantita undefined, usa 1
                    const quantita = parseInt(tapp.quantita) || 1;
                    
                    console.log(`âœ… Pos ${index + 1} ha tapparella con quantitÃ  ${quantita}, azienda: "${azienda}"`);
                    
                    // ğŸ” DEBUG: Accetta TUTTE le aziende per test
                    const usaListinoPlasticino = LISTINO_PLASTICINO.aziende.includes(azienda);
                    console.log(`ğŸ” Azienda "${azienda}" usa listino Plasticino? ${usaListinoPlasticino}`);
                    console.log(`ğŸ” DEBUG: PROCEDO COMUNQUE con il calcolo (versione debug)`);
                    
                    // if (LISTINO_PLASTICINO.aziende.includes(azienda)) {  // â† RIMOSSO PER DEBUG
                    if (true) {  // â† DEBUG: Accetta TUTTE le aziende
                        // Leggi misure tapparella (prioritÃ : tapparella > posizione)
                        const L_cm = parseInt(tapp.larghezza) || parseInt(pos.L) || 0;
                        const H_cm = parseInt(tapp.altezza) || parseInt(pos.H) || 0;
                        
                        console.log(`ğŸ” Misure Pos ${index + 1}: L=${L_cm}cm, H=${H_cm}cm (da tapp.larghezza=${tapp.larghezza}, pos.L=${pos.L})`);
                        
                        if (L_cm > 0 && H_cm > 0) {
                            // Calcola prezzo usando listino Plasticino
                            const calcolo = calcolaPrezzoPLASTICINO(L_cm, H_cm);
                            // quantita giÃ  definita sopra (riga 12350)
                            const totaleRiga = calcolo.totale * quantita;
                            
                            righe.push({
                                posizione: index + 1,
                                ambiente: pos.ambiente || pos.nome || pos.stanza || `Pos ${index + 1}`,
                                tipo: 'Tapparella',
                                azienda: tapp.azienda || 'Plasticino',
                                telaio: '-',
                                larghezza: L_cm,
                                altezza: H_cm,
                                superficie: '-',
                                perimetro: '-',
                                prezzoBase: calcolo.rullo.toFixed(2),
                                supplementoTelaio: calcolo.fissi.toFixed(2),
                                supplementoAnta: calcolo.supplemento_altezza.toFixed(2),
                                supplementoVetro: '0.00',
                                supplementoManiglia: '0.00',
                                prezzoUnitario: calcolo.totale.toFixed(2),
                                quantita: quantita,
                                totale: totaleRiga.toFixed(2)
                            });
                            
                            totaleMateriali += totaleRiga;
                            numeroPezzi += quantita;
                            
                            console.log(`âœ… Tapparella ${azienda} Pos ${index + 1}: ${L_cm}Ã—${H_cm} = â‚¬${calcolo.totale.toFixed(2)}`);
                        } else {
                            console.warn(`âš ï¸ Pos ${index + 1}: Tapparella ${azienda} senza misure, salto calcolo`);
                        }
                    } else {
                        console.warn(`âš ï¸ Pos ${index + 1}: Azienda tapparelle "${tapp.azienda}" non ha listino prezzi`);
                    }
                }
                
                // TODO: Processa altri prodotti (persiane, zanzariere, cassonetti)
            });
            
            // Calcola posa e smontaggio
            const posa = numeroPezzi * COSTI_EXTRA.posa_per_pezzo;
            const smontaggio = numeroPezzi * COSTI_EXTRA.smontaggio_per_pezzo;
            const subtotale = totaleMateriali + posa + smontaggio;
            
            // IVA (se selezionata)
            const ivaPercent = parseInt(document.getElementById('ivaSelect')?.value || 0);
            const iva = subtotale * (ivaPercent / 100);
            const totale = subtotale + iva;
            
            return {
                righe: righe,
                totaleMateriali: totaleMateriali,
                posa: posa,
                smontaggio: smontaggio,
                subtotale: subtotale,
                ivaPercent: ivaPercent,
                iva: iva,
                totale: totale
            };
        }

        function popolaTabellaPreventivo(preventivo) {
            const tbody = document.getElementById('preventivoTableBody');
            if (!tbody) {
                console.error('âŒ Tabella preventivo non trovata');
                return;
            }
            
            tbody.innerHTML = '';
            
            // Popola righe
            preventivo.righe.forEach(riga => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${riga.posizione}</td>
                    <td style="text-align: left;">${riga.ambiente}</td>
                    <td>${riga.tipo}</td>
                    <td>${riga.azienda}</td>
                    <td>${riga.telaio}</td>
                    <td>${riga.larghezza}</td>
                    <td>${riga.altezza}</td>
                    <td>${riga.superficie}</td>
                    <td>${riga.perimetro}</td>
                    <td>â‚¬ ${riga.prezzoBase}</td>
                    <td>â‚¬ ${riga.supplementoTelaio}</td>
                    <td>â‚¬ ${riga.supplementoAnta}</td>
                    <td>â‚¬ ${riga.supplementoVetro}</td>
                    <td>â‚¬ ${riga.supplementoManiglia}</td>
                    <td style="font-weight: 600;">â‚¬ ${riga.prezzoUnitario}</td>
                    <td>${riga.quantita}</td>
                    <td style="font-weight: 700; color: #10b981;">â‚¬ ${riga.totale}</td>
                `;
                tbody.appendChild(tr);
            });
            
            // Aggiorna totali
            document.getElementById('totaleMateriali').textContent = `â‚¬ ${preventivo.totaleMateriali.toFixed(2)}`;
            document.getElementById('totalePosa').textContent = `â‚¬ ${preventivo.posa.toFixed(2)}`;
            document.getElementById('totaleSmontaggio').textContent = `â‚¬ ${preventivo.smontaggio.toFixed(2)}`;
            document.getElementById('subtotale').textContent = `â‚¬ ${preventivo.subtotale.toFixed(2)}`;
            
            // Gestisci IVA
            const rowIVA = document.getElementById('rowIVA');
            if (preventivo.ivaPercent > 0) {
                rowIVA.style.display = 'table-row';
                document.getElementById('ivaPercent').textContent = preventivo.ivaPercent;
                document.getElementById('totaleIVA').textContent = `â‚¬ ${preventivo.iva.toFixed(2)}`;
            } else {
                rowIVA.style.display = 'none';
            }
            
            document.getElementById('grandTotal').textContent = `â‚¬ ${preventivo.totale.toFixed(2)}`;
            
            console.log(`âœ… Tabella preventivo popolata: ${preventivo.righe.length} righe, Totale: â‚¬${preventivo.totale.toFixed(2)}`);
        }

        // Funzione: Ricalcola preventivo (chiamata da select IVA)
        function ricalcolaPreventivo() {
            if (currentData && currentData.posizioni) {
                renderVistaPreventivo(currentData);
                console.log('ğŸ”„ Preventivo ricalcolato');
            }
        }

        // Funzione: Export Excel preventivo (TODO)
        function exportPreventivoExcel() {
            console.log('ğŸ“Š Export Excel preventivo...');
            alert('Funzione Export Excel da implementare con libreria XLSX');
            // TODO: Implementare export con SheetJS
        }

        // Helper: Normalizza nome azienda (case-insensitive)
        function normalizeAziendaName(azienda) {
            // Gestisci casi speciali
            if (!azienda || azienda.trim() === '') {
                return {
                    key: 'azienda non specificata',
                    display: 'Azienda Non Specificata'
                };
            }
            
            // Converti in lowercase per normalizzazione
            const normalized = azienda.toLowerCase().trim();
            
            // Capitalizza prima lettera di ogni parola per display
            const displayName = normalized
                .split(' ')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
            
            return {
                key: normalized,      // Per raggruppamento (es: "finstral")
                display: displayName  // Per visualizzazione (es: "Finstral")
            };
        }

        // Helper: Raggruppa prodotti per azienda
        function groupProductsByAzienda(posizioni) {
            const aziendeMap = new Map();
            
            posizioni.forEach(pos => {
                // Processa ogni tipo di prodotto
                ['infisso', 'tapparella', 'persiana', 'cassonetto', 'zanzariera'].forEach(tipoProdotto => {
                    const prodotto = pos[tipoProdotto];
                    
                    // âœ… FIX: Accetta anche quantita undefined/null (tratta come 1)
                    const quantitaProdotto = prodotto ? (parseInt(prodotto.quantita) || 1) : 0;
                    const hasProdotto = prodotto && (prodotto.quantita === undefined || prodotto.quantita === null || prodotto.quantita > 0 || quantitaProdotto > 0);
                    
                    if (hasProdotto) {
                        const aziendaRaw = prodotto.azienda || 'Azienda Non Specificata';
                        
                        // âœ… FIX CASE-INSENSITIVE: Normalizza nome azienda
                        const { key: aziendaKey, display: aziendaDisplay } = normalizeAziendaName(aziendaRaw);
                        
                        // Inizializza azienda se non esiste
                        if (!aziendeMap.has(aziendaKey)) {
                            aziendeMap.set(aziendaKey, {
                                displayName: aziendaDisplay,  // Nome per visualizzazione
                                prodotti: [],
                                totali: {
                                    infissi: 0,
                                    tapparelle: 0,
                                    persiane: 0,
                                    cassonetti: 0,
                                    zanzariere: 0
                                },
                                posizioniCoinvolte: new Set()
                            });
                        }
                        
                        const aziendaData = aziendeMap.get(aziendaKey);
                        
                        // âœ… CALCOLA PREZZO per tapparelle con listino Plasticino
                        let prezzoUnitario = null;
                        let prezzoTotale = null;
                        
                        if (tipoProdotto === 'tapparella') {
                            const aziendaLower = (prodotto.azienda || '').toLowerCase();
                            if (LISTINO_PLASTICINO.aziende.includes(aziendaLower) || aziendaLower.includes('plasticino') || aziendaLower.includes('solar') || aziendaLower.includes('estella')) {
                                const L_cm = parseInt(prodotto.larghezza) || parseInt(pos.L) || 0;
                                const H_cm = parseInt(prodotto.altezza) || parseInt(pos.H) || 0;
                                
                                if (L_cm > 0 && H_cm > 0) {
                                    const calcolo = calcolaPrezzoPLASTICINO(L_cm, H_cm);
                                    prezzoUnitario = calcolo.totale;
                                    prezzoTotale = calcolo.totale * quantitaProdotto;
                                    
                                    console.log(`ğŸ’° Tapparella ${aziendaLower}: ${L_cm}Ã—${H_cm} = â‚¬${prezzoUnitario.toFixed(2)} (qtÃ  ${quantitaProdotto}) = Tot â‚¬${prezzoTotale.toFixed(2)}`);
                                }
                            }
                        }
                        
                        // Aggiungi prodotto
                        aziendaData.prodotti.push({
                            tipo: tipoProdotto,
                            posizione: pos.ambiente || pos.nome || pos.stanza || pos.id,
                            quantita: quantitaProdotto,  // Usa quantitÃ  fixata
                            brm: prodotto.brm || {},
                            modello: prodotto.tipo || 'N/D',
                            configurazione: getProdottoConfigString(prodotto),
                            colore: prodotto.finitura_int || prodotto.colore || 'N/D',
                            note: prodotto.note || '',
                            prezzoUnitario: prezzoUnitario,  // âœ… NUOVO
                            prezzoTotale: prezzoTotale,      // âœ… NUOVO
                            larghezza: prodotto.larghezza || pos.L,  // âœ… NUOVO
                            altezza: prodotto.altezza || pos.H       // âœ… NUOVO
                        });
                        
                        // Aggiorna totali
                        if (tipoProdotto === 'infisso') aziendaData.totali.infissi += quantitaProdotto;
                        else if (tipoProdotto === 'tapparella') aziendaData.totali.tapparelle += quantitaProdotto;
                        else if (tipoProdotto === 'persiana') aziendaData.totali.persiane += quantitaProdotto;
                        else if (tipoProdotto === 'cassonetto') aziendaData.totali.cassonetti += quantitaProdotto;
                        else if (tipoProdotto === 'zanzariera') aziendaData.totali.zanzariere += quantitaProdotto;
                        
                        // Aggiungi posizione coinvolta
                        aziendaData.posizioniCoinvolte.add(pos.id);
                    }
                });
            });
            
            return aziendeMap;
        }

        // Helper: Ottieni stringa configurazione prodotto
        function getProdottoConfigString(prodotto) {
            const parts = [];
            
            if (prodotto.apertura) parts.push(formatAperturaLabel(prodotto.apertura));
            if (prodotto.motorizzazione === 'si') parts.push('Motorizzata');
            if (prodotto.allarme === 'si') parts.push('Con Allarme');
            if (prodotto.materiale) parts.push(prodotto.materiale);
            
            return parts.length > 0 ? parts.join(' | ') : 'Standard';
        }

        // Helper: Format apertura label
        function formatAperturaLabel(apertura) {
            const labels = {
                'battente_1_anta': '1 Anta',
                'battente_2_ante': '2 Ante',
                'scorrevole': 'Scorrevole',
                'vasistas': 'Vasistas',
                'ribalta': 'Ribalta',
                'basculante': 'Basculante'
            };
            return labels[apertura] || apertura;
        }

        // ğŸ†• Render configurazioni prodotti per specifica azienda
        function renderConfigurazioniProdottiAzienda(aziendaData, projectData) {
            if (!projectData) return '';
            
            const configurazioni = [];
            
            // INFISSI
            if (aziendaData.totali.infissi > 0 && projectData.configInfissi) {
                const cfg = projectData.configInfissi;
                configurazioni.push({
                    tipo: 'Infissi',
                    icon: 'ğŸªŸ',
                    fields: [
                        { label: 'Tipo Anta', value: cfg.tipoAnta },
                        { label: 'Telaio', value: cfg.telaio },
                        { label: 'Vetro', value: cfg.vetro },
                        { label: 'Colore Interno', value: cfg.coloreInterno },
                        { label: 'Colore Esterno', value: cfg.coloreEsterno }
                    ].filter(f => f.value)
                });
            }
            
            // PERSIANE
            if (aziendaData.totali.persiane > 0 && projectData.configPersiane) {
                const cfg = projectData.configPersiane;
                configurazioni.push({
                    tipo: 'Persiane',
                    icon: 'ğŸšª',
                    fields: [
                        { label: 'Modello', value: cfg.modello },
                        { label: 'Colore', value: cfg.colore }
                    ].filter(f => f.value)
                });
            }
            
            // TAPPARELLE
            if (aziendaData.totali.tapparelle > 0 && projectData.configTapparelle) {
                const cfg = projectData.configTapparelle;
                configurazioni.push({
                    tipo: 'Tapparelle',
                    icon: 'ğŸ¯',
                    fields: [
                        { label: 'Modello', value: cfg.modello },
                        { label: 'Colore', value: cfg.colore }
                    ].filter(f => f.value)
                });
            }
            
            // CASSONETTI
            if (aziendaData.totali.cassonetti > 0 && projectData.configCassonetti) {
                const cfg = projectData.configCassonetti;
                configurazioni.push({
                    tipo: 'Cassonetti',
                    icon: 'ğŸ“¦',
                    fields: [
                        { label: 'Tipo', value: cfg.tipo },
                        { label: 'Materiale', value: cfg.materiale },
                        { label: 'Finitura', value: cfg.finitura },
                        { label: 'Coibentazione', value: cfg.coibentazione },
                        { label: 'A Soffitto', value: cfg.aSoffitto }
                    ].filter(f => f.value)
                });
            }
            
            // ZANZARIERE
            if (aziendaData.totali.zanzariere > 0 && projectData.configZanzariere) {
                const cfg = projectData.configZanzariere;
                configurazioni.push({
                    tipo: 'Zanzariere',
                    icon: 'ğŸ¦Ÿ',
                    fields: [
                        { label: 'Modello PF', value: cfg.modelloPF },
                        { label: 'Modello F', value: cfg.modelloF },
                        { label: 'Colore', value: cfg.colore }
                    ].filter(f => f.value)
                });
            }
            
            // Se non ci sono configurazioni, non mostrare nulla
            if (configurazioni.length === 0) return '';
            
            // Genera HTML
            return `
                <div style="background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%); border-left: 4px solid #0ea5e9; border-radius: 12px; padding: 1.5rem; margin-bottom: 1.5rem;">
                    <h3 style="font-size: 1.1rem; font-weight: 700; color: #0c4a6e; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.5rem;">
                        âš™ï¸ Configurazione Prodotti Globale
                    </h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem;">
                        ${configurazioni.map(config => `
                            <div style="background: white; border-radius: 8px; padding: 1rem; box-shadow: 0 1px 3px rgba(0,0,0,0.1);">
                                <div style="font-weight: 600; color: #1e40af; margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.5rem;">
                                    <span>${config.icon}</span> ${config.tipo}
                                </div>
                                <div style="display: grid; gap: 0.5rem; font-size: 0.9rem;">
                                    ${config.fields.map(field => `
                                        <div style="display: grid; grid-template-columns: 120px 1fr; gap: 0.5rem;">
                                            <span style="color: #6b7280; font-weight: 500;">${field.label}:</span>
                                            <span style="color: #1f2937; font-weight: 600;">${field.value}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Render singola card azienda
        function renderAziendaCard(aziendaName, aziendaData, projectData) {
            const totaleProdotti = aziendaData.prodotti.length;
            const totaleQuantita = aziendaData.prodotti.reduce((sum, p) => sum + p.quantita, 0);
            const posizioniCount = aziendaData.posizioniCoinvolte.size;
            
            // Determina quali badge mostrare
            const badges = [];
            if (aziendaData.totali.infissi > 0) badges.push({ label: 'Infissi', class: 'infissi' });
            if (aziendaData.totali.tapparelle > 0) badges.push({ label: 'Tapparelle', class: 'tapparelle' });
            if (aziendaData.totali.persiane > 0) badges.push({ label: 'Persiane', class: 'persiane' });
            if (aziendaData.totali.cassonetti > 0) badges.push({ label: 'Cassonetti', class: 'cassonetti' });
            if (aziendaData.totali.zanzariere > 0) badges.push({ label: 'Zanzariere', class: 'zanzariere' });
            
            // ğŸ†• Estrai configurazioni prodotti per questa azienda
            const configHTML = renderConfigurazioniProdottiAzienda(aziendaData, projectData);
            
            return `
                <div class="azienda-card">
                    <!-- Header -->
                    <div class="azienda-header">
                        <div class="azienda-header-left">
                            <div class="azienda-name">
                                <span class="azienda-name-icon">ğŸ¢</span>
                                ${aziendaName}
                            </div>
                            <div class="azienda-stats">
                                <div class="azienda-stat">
                                    ğŸ“¦ <span class="azienda-stat-value">${totaleProdotti}</span> prodotti
                                </div>
                                <div class="azienda-stat">
                                    ğŸ”¢ <span class="azienda-stat-value">${totaleQuantita}</span> quantitÃ  totale
                                </div>
                                <div class="azienda-stat">
                                    ğŸ“ <span class="azienda-stat-value">${posizioniCount}</span> posizioni
                                </div>
                            </div>
                        </div>
                        <div class="azienda-badges">
                            ${badges.map(badge => `
                                <span class="azienda-badge ${badge.class}">${badge.label}</span>
                            `).join('')}
                        </div>
                    </div>

                    <!-- ğŸ†• Configurazione Prodotti Azienda -->
                    ${configHTML}

                    <!-- Tabella Prodotti -->
                    <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 1rem;">
                        ğŸ“‹ Lista Prodotti
                    </h3>
                    <table class="azienda-prodotti-table">
                        <thead>
                            <tr>
                                <th>Tipo</th>
                                <th>Modello/Config</th>
                                <th>Misure BRM</th>
                                <th>LÃ—H (cm)</th>
                                <th>QtÃ </th>
                                <th>Prezzo Unit.</th>
                                <th>Totale</th>
                                <th>Colore</th>
                                <th>Posizioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${aziendaData.prodotti.map(prod => `
                                <tr>
                                    <td>
                                        <span class="product-type-badge ${prod.tipo}">
                                            ${prod.tipo.charAt(0).toUpperCase() + prod.tipo.slice(1)}
                                        </span>
                                    </td>
                                    <td>
                                        <div style="font-weight: 600;">${prod.modello}</div>
                                        <div style="font-size: 0.85rem; color: #6b7280;">${prod.configurazione}</div>
                                    </td>
                                    <td style="font-family: monospace; font-size: 0.9rem;">
                                        ${prod.brm.L && prod.brm.H ? 
                                            `L:${prod.brm.L} Ã— H:${prod.brm.H}` : 
                                            'N/D'}
                                    </td>
                                    <td style="font-family: monospace; font-size: 0.9rem;">
                                        ${prod.larghezza && prod.altezza ? 
                                            `${prod.larghezza}Ã—${prod.altezza}` : 
                                            '-'}
                                    </td>
                                    <td style="font-weight: 600; color: #10b981;">${prod.quantita}</td>
                                    <td style="font-weight: 600; color: #2563eb;">
                                        ${prod.prezzoUnitario !== null ? 
                                            `â‚¬${prod.prezzoUnitario.toFixed(2)}` : 
                                            '-'}
                                    </td>
                                    <td style="font-weight: 700; color: #059669;">
                                        ${prod.prezzoTotale !== null ? 
                                            `â‚¬${prod.prezzoTotale.toFixed(2)}` : 
                                            '-'}
                                    </td>
                                    <td>${prod.colore}</td>
                                    <td>
                                        <span class="position-tag">${prod.posizione}</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                        <tfoot>
                            <tr style="background: #f3f4f6; border-top: 2px solid #d1d5db;">
                                <td colspan="6" style="text-align: right; font-weight: 700; padding: 12px;">
                                    TOTALE ${aziendaName.toUpperCase()}:
                                </td>
                                <td style="font-weight: 700; font-size: 1.1rem; color: #059669;">
                                    ${(() => {
                                        const totale = aziendaData.prodotti.reduce((sum, p) => sum + (p.prezzoTotale || 0), 0);
                                        return totale > 0 ? `â‚¬${totale.toFixed(2)}` : '-';
                                    })()}
                                </td>
                                <td colspan="2"></td>
                            </tr>
                        </tfoot>
                    </table>

                    <!-- âŒ RIMOSSO v7.20: Totali Azienda (visibili solo in Vista Generale) -->

                    <!-- Azioni Export -->
                    <div class="azienda-actions">
                        <button class="azienda-action-btn primary" onclick="exportAziendaExcel('${aziendaName}')">
                            ğŸ“Š Export Excel
                        </button>
                        <button class="azienda-action-btn" onclick="copyAziendaText('${aziendaName}')">
                            ğŸ“‹ Copia Testo
                        </button>
                        <button class="azienda-action-btn" onclick="window.print()">
                            ğŸ–¨ï¸ Stampa
                        </button>
                    </div>

                    <!-- Note Fornitore -->
                    <div class="azienda-note">
                        <div class="azienda-note-title">
                            ğŸ“ Note Fornitore
                        </div>
                        <textarea 
                            placeholder="Aggiungi note per questo fornitore (tempi consegna, condizioni, referente, numero ordine Odoo...)"
                            id="note-${aziendaName.replace(/\s+/g, '-')}"
                            onchange="saveAziendaNote('${aziendaName}', this.value)"
                        ></textarea>
                    </div>
                </div>
            `;
        }

        // Funzioni export (stub - da implementare completamente se necessario)
        function exportAziendaExcel(aziendaName) {
            console.log(`ğŸ“Š Export Excel per ${aziendaName} - Da implementare`);
            alert(`Funzione Export Excel per ${aziendaName}\nDa implementare con libreria XLSX`);
        }

        function copyAziendaText(aziendaName) {
            console.log(`ğŸ“‹ Copia testo per ${aziendaName}`);
            alert(`Testo copiato per ${aziendaName}!\n(Implementare copia negli appunti)`);
        }

        function saveAziendaNote(aziendaName, note) {
            console.log(`ğŸ’¾ Salvataggio note per ${aziendaName}:`, note);
            // Salva in localStorage
            const notesKey = `azienda-notes-${aziendaName}`;
            localStorage.setItem(notesKey, note);
        }

        // ============================================================================
        // POPOLA FILTRI PIANO E STANZA
        // ============================================================================
        function populateFilters() {
            const pianiSet = new Set();
            const stanzeSet = new Set();
            
            allPositionsData.forEach(pos => {
                if (pos.piano) pianiSet.add(pos.piano);
                if (pos.stanza) stanzeSet.add(pos.stanza);
            });
            
            // Popola select piano
            const filterPiano = document.getElementById('filterPiano');
            filterPiano.innerHTML = '<option value="">Tutti i piani</option>';
            Array.from(pianiSet).sort().forEach(piano => {
                filterPiano.innerHTML += `<option value="${piano}">${piano}</option>`;
            });
            
            // Popola select stanza
            const filterStanza = document.getElementById('filterStanza');
            filterStanza.innerHTML = '<option value="">Tutte le stanze</option>';
            Array.from(stanzeSet).sort().forEach(stanza => {
                filterStanza.innerHTML += `<option value="${stanza}">${stanza}</option>`;
            });
        }

        // ============================================================================
        // FILTRA POSIZIONI
        // ============================================================================
        function filterPositions() {
            const piano = document.getElementById('filterPiano').value;
            const stanza = document.getElementById('filterStanza').value;
            
            filteredPositions = allPositionsData.filter(pos => {
                const matchPiano = !piano || pos.piano === piano;
                const matchStanza = !stanza || pos.stanza === stanza;
                return matchPiano && matchStanza;
            });
            
            // Reset index
            currentPositionIndex = 0;
            
            // Re-render
            renderPositionsList();
            if (filteredPositions.length > 0) {
                renderPositionDetail(0);
            }
        }

        // ============================================================================
        // RENDER LISTA POSIZIONI SIDEBAR
        // ============================================================================
        function renderPositionsList() {
            const container = document.getElementById('positionsList');
            const countSpan = document.getElementById('positionsCount');
            
            countSpan.textContent = `(${filteredPositions.length})`;
            
            container.innerHTML = filteredPositions.map((pos, index) => `
                <div class="position-list-item ${index === currentPositionIndex ? 'active' : ''}" 
                     onclick="selectPosition(${index})">
                    <div class="position-item-details" style="padding: 0.75rem;">
                        <strong>${pos.ambiente || pos.nome || pos.stanza || 'Posizione ' + (index + 1)}</strong>
                    </div>
                </div>
            `).join('');
        }

        // ============================================================================
        // SELEZIONA POSIZIONE
        // ============================================================================
        function selectPosition(index) {
            currentPositionIndex = index;
            renderPositionsList();
            renderPositionDetail(index);
            
            // Scroll to top della card
            document.querySelector('.position-card').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        // ============================================================================
        // RENDER DETTAGLIO POSIZIONE
        // ============================================================================
        function renderPositionDetail(index) {
            if (index < 0 || index >= filteredPositions.length) return;
            
            const pos = filteredPositions[index];
            const container = document.getElementById('positionDetailCard');
            
            container.innerHTML = `
                ${renderPositionHeader(pos)}
                ${renderPositionMeasures(pos)}
                ${renderPositionWallChars(pos)}
                ${renderPositionProducts(pos)}
                ${renderPositionPreexisting(pos)}
                ${renderPositionNotes(pos)}
                ${renderPositionNavigation(index)}
            `;
            
            // Setup tabs prodotti
            setupProductTabs();
        }

        // ============================================================================
        // SEZIONE A: HEADER POSIZIONE
        // ============================================================================
        function renderPositionHeader(pos) {
            return `
                <div class="position-header">
                    <div class="position-id-large">${pos.ambiente || pos.nome || pos.stanza || 'Posizione'}</div>
                    <div class="position-location">
                        <span class="position-location-item">ğŸ“ Piano: ${pos.piano || 'N/D'}</span>
                        <span class="position-location-item">|</span>
                        <span class="position-location-item">ğŸšª N/D</span>
                    </div>
                    <div class="position-qty">QuantitÃ : ${pos.quantita || 1}</div>
                </div>
            `;
        }

        // ============================================================================
        // SEZIONE B: MISURE COMPLETE
        // ============================================================================
        function renderPositionMeasures(pos) {
            const m = pos.misure || {};
            
            // ğŸ”§ Helper per convertire valore (evita [object Object])
            const getVal = (val) => {
                if (val === null || val === undefined) return null;
                if (typeof val === 'object') return null; // Salta oggetti
                return val;
            };
            
            const mainMeasures = [
                { label: 'Larghezza Vecchio Telaio (LVT)', value: getVal(m.LVT) },
                { label: 'Altezza Vecchio Telaio (HVT)', value: getVal(m.HVT) },
                { label: 'Larghezza Foro (LF)', value: getVal(m.LF) },
                { label: 'Altezza Foro (HF)', value: getVal(m.HF) },
                { label: 'Larghezza Massima Muro Int (TMV)', value: getVal(m.TMV) },
                { label: 'Altezza Massima Muro Int (HMT)', value: getVal(m.HMT) }
            ];
            
            const additionalMeasures = [
                { label: 'Larghezza Variabile (LVAR)', value: getVal(m.LVAR) },
                { label: 'Altezza Variabile (HVAR)', value: getVal(m.HVAR) },
                { label: 'Altezza Soffitto (HSoffitto)', value: getVal(m.HSoffitto) },
                { label: 'H Parapetto-Soffitto', value: getVal(m.HParapettoSoffitto) },
                { label: 'H Pavimento-Parapetto', value: getVal(m.HPavimentoParapetto) },
                { label: 'Dislivello Piana Sopra', value: getVal(m.profPianaSopra) },
                { label: 'Dislivello Piana Sotto', value: getVal(m.profPianaSotto) }
            ];
            
            return `
                <div class="position-section">
                    <h3 class="position-section-title">
                        <span class="position-section-icon">ğŸ“</span>
                        Misure Complete
                    </h3>
                    
                    <h4 style="font-size: 0.95rem; font-weight: 600; color: #6b7280; margin-bottom: 1rem;">
                        Misure Principali
                    </h4>
                    <table class="measures-table">
                        <tbody>
                            ${mainMeasures.filter(m => m.value != null).map(m => `
                                <tr>
                                    <td class="measure-label">${m.label}</td>
                                    <td class="measure-value">
                                        <span class="measure-highlight">${m.value} mm</span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    <h4 style="font-size: 0.95rem; font-weight: 600; color: #6b7280; margin: 1.5rem 0 1rem;">
                        Misure Aggiuntive
                    </h4>
                    <table class="measures-table">
                        <tbody>
                            ${additionalMeasures.filter(m => m.value != null).map(m => `
                                <tr>
                                    <td class="measure-label">${m.label}</td>
                                    <td class="measure-value">${m.value} mm</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        // ============================================================================
        // SEZIONE C: CARATTERISTICHE MURO
        // ============================================================================
        function renderPositionWallChars(pos) {
            const override = pos.caratteristiche_muro_override || {};
            const global = currentData.caratteristiche_muro_globali || {};
            const hasOverride = Object.keys(override).length > 0;
            
            // Usa override se presente, altrimenti globale
            const chars = hasOverride ? override : global;
            
            const items = [
                { label: 'Telaio', value: chars.telaio_larghezza && chars.telaio_altezza ? 
                    `${chars.telaio_larghezza} Ã— ${chars.telaio_altezza} mm` : 'N/D' },
                { label: 'Falso Esistente', value: chars.falso_esistente || 'N/D' },
                { label: 'Spessore Falso', value: chars.spessore_falso ? `${chars.spessore_falso} mm` : 'N/D' },
                { label: 'ProfonditÃ  Muro INT', value: chars.prof_muro_int ? `${chars.prof_muro_int} mm` : 'N/D' },
                { label: 'ProfonditÃ  Muro EST', value: chars.prof_muro_est ? `${chars.prof_muro_est} mm` : 'N/D' },
                { label: 'Guida Tipo', value: chars.guida_tipo || 'N/D' },
                { label: 'Coprifilo', value: chars.coprifilo_larghezza ? `${chars.coprifilo_larghezza} mm` : 'N/D' },
                { label: 'Battuta Sup. Tapparella', value: chars.battuta_superiore_tapparella ? 
                    `${chars.battuta_superiore_tapparella} mm` : 'N/D' }
            ];
            
            return `
                <div class="position-section">
                    <h3 class="position-section-title">
                        <span class="position-section-icon">ğŸ§±</span>
                        Caratteristiche Muro
                        ${hasOverride ? '<span class="override-badge">OVERRIDE</span>' : ''}
                    </h3>
                    <div class="wall-chars-grid">
                        ${items.map(item => `
                            <div class="wall-char-item">
                                <div class="wall-char-label">${item.label}</div>
                                <div class="wall-char-value">${item.value}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // SEZIONE D: PRODOTTI E CONFIGURAZIONI
        // ============================================================================
        function renderPositionProducts(pos) {
            const hasProdotti = (pos.infisso && pos.infisso.quantita > 0) ||
                              (pos.tapparella && pos.tapparella.quantita > 0) ||
                              (pos.cassonetto && pos.cassonetto.quantita > 0) ||
                              (pos.persiana && pos.persiana.quantita > 0) ||
                              (pos.zanzariera && pos.zanzariera.quantita > 0);
            
            if (!hasProdotti) {
                return `
                    <div class="position-section">
                        <h3 class="position-section-title">
                            <span class="position-section-icon">ğŸ“¦</span>
                            Prodotti e Configurazioni
                        </h3>
                        <p style="color: #6b7280; font-style: italic;">Nessun prodotto configurato</p>
                    </div>
                `;
            }
            
            return `
                <div class="position-section">
                    <h3 class="position-section-title">
                        <span class="position-section-icon">ğŸ“¦</span>
                        Prodotti e Configurazioni
                    </h3>
                    
                    <div class="products-tabs">
                        ${pos.infisso && pos.infisso.quantita > 0 ? 
                            '<button class="product-tab active" onclick="switchProductTab(\'infisso\')">ğŸªŸ Infisso</button>' : ''}
                        ${pos.tapparella && pos.tapparella.quantita > 0 ? 
                            '<button class="product-tab" onclick="switchProductTab(\'tapparella\')">ğŸ”½ Tapparella</button>' : ''}
                        ${pos.cassonetto && pos.cassonetto.quantita > 0 ? 
                            '<button class="product-tab" onclick="switchProductTab(\'cassonetto\')">ğŸ“¦ Cassonetto</button>' : ''}
                        ${pos.persiana && pos.persiana.quantita > 0 ? 
                            '<button class="product-tab" onclick="switchProductTab(\'persiana\')">ğŸªŸ Persiana</button>' : ''}
                        ${pos.zanzariera && pos.zanzariera.quantita > 0 ? 
                            '<button class="product-tab" onclick="switchProductTab(\'zanzariera\')">ğŸ¦Ÿ Zanzariera</button>' : ''}
                    </div>
                    
                    ${renderProductContent('infisso', pos.infisso, pos.infisso && pos.infisso.quantita > 0)}
                    ${renderProductContent('tapparella', pos.tapparella, pos.tapparella && pos.tapparella.quantita > 0)}
                    ${renderProductContent('cassonetto', pos.cassonetto, pos.cassonetto && pos.cassonetto.quantita > 0)}
                    ${renderProductContent('persiana', pos.persiana, pos.persiana && pos.persiana.quantita > 0)}
                    ${renderProductContent('zanzariera', pos.zanzariera, pos.zanzariera && pos.zanzariera.quantita > 0)}
                </div>
            `;
        }

        function renderProductContent(tipo, prodotto, isActive) {
            if (!prodotto || prodotto.quantita === 0) return '';
            
            const brm = prodotto.brm || {};
            
            return `
                <div class="product-content ${isActive ? 'active' : ''}" data-product="${tipo}">
                    
                    ${brm.L || brm.H ? `
                        <div class="brm-box">
                            <div class="brm-title">ğŸ“ Misure BRM ${tipo.toUpperCase()}</div>
                            <div class="brm-grid">
                                ${brm.L ? `
                                    <div class="brm-item">
                                        <div class="brm-label">L (Larghezza)</div>
                                        <div class="brm-value">${brm.L} mm</div>
                                    </div>
                                ` : ''}
                                ${brm.H ? `
                                    <div class="brm-item">
                                        <div class="brm-label">H (Altezza)</div>
                                        <div class="brm-value">${brm.H} mm</div>
                                    </div>
                                ` : ''}
                                ${brm.C ? `
                                    <div class="brm-item">
                                        <div class="brm-label">C (ProfonditÃ )</div>
                                        <div class="brm-value">${brm.C} mm</div>
                                    </div>
                                ` : ''}
                                ${brm.B ? `
                                    <div class="brm-item">
                                        <div class="brm-label">B (Base)</div>
                                        <div class="brm-value">${brm.B} mm</div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    
                    <div class="wall-chars-grid" style="margin-top: 1.5rem;">
                        ${prodotto.quantita ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">QuantitÃ </div>
                                <div class="wall-char-value">${prodotto.quantita}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tipo ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">${
                                    tipo === 'persiana' ? 'Tipo Persiana' :
                                    tipo === 'infisso' ? 'Cassonetto/Monoblocco' :
                                    tipo === 'tapparella' ? 'Tipo Tapparella' :
                                    tipo === 'zanzariera' ? 'Tipo Zanzariera' :
                                    tipo === 'cassonetto' ? 'Tipo Cassonetto' : 'Tipo'
                                }</div>
                                <div class="wall-char-value">${prodotto.tipo}</div>
                            </div>
                        ` : ''}
                        ${prodotto.azienda ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Azienda</div>
                                <div class="wall-char-value">${prodotto.azienda}</div>
                            </div>
                        ` : ''}
                        ${prodotto.apertura ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Apertura</div>
                                <div class="wall-char-value">${prodotto.apertura}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finitura_int ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura INT</div>
                                <div class="wall-char-value">${prodotto.finitura_int}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finitura_est ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura EST</div>
                                <div class="wall-char-value">${prodotto.finitura_est}</div>
                            </div>
                        ` : ''}
                        ${prodotto.colore ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore</div>
                                <div class="wall-char-value">${prodotto.colore}</div>
                            </div>
                        ` : ''}
                        ${prodotto.motorizzazione ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Motorizzazione</div>
                                <div class="wall-char-value">${prodotto.motorizzazione}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tipoInfissoAssociato ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">${tipo === 'persiana' ? 'Tipo Infisso Associato' : 'Tipo Infisso'}</div>
                                <div class="wall-char-value">${prodotto.tipoInfissoAssociato === 'F' ? 'Finestra' : 'Porta Finestra'}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tagliTelaio ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Tagli Telaio</div>
                                <div class="wall-char-value">${prodotto.tagliTelaio}</div>
                            </div>
                        ` : ''}
                        ${prodotto.codTagli && prodotto.codTagli.length > 0 ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Codici Taglio</div>
                                <div class="wall-char-value">${prodotto.codTagli.join(', ')}</div>
                            </div>
                        ` : ''}
                        ${prodotto.vetro ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Vetro</div>
                                <div class="wall-char-value">${prodotto.vetro}</div>
                            </div>
                        ` : ''}
                        ${prodotto.tipoAnta ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Tipo Anta</div>
                                <div class="wall-char-value">${prodotto.tipoAnta}</div>
                            </div>
                        ` : ''}
                        ${prodotto.telaio ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Telaio</div>
                                <div class="wall-char-value">${prodotto.telaio}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finituraInt ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura Interna</div>
                                <div class="wall-char-value">${prodotto.finituraInt}</div>
                            </div>
                        ` : ''}
                        ${prodotto.finituraEst ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Finitura Esterna</div>
                                <div class="wall-char-value">${prodotto.finituraEst}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coloreInt ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore Interno</div>
                                <div class="wall-char-value">${prodotto.coloreInt}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coloreEst ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore Esterno</div>
                                <div class="wall-char-value">${prodotto.coloreEst}</div>
                            </div>
                        ` : ''}
                        ${prodotto.maniglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Maniglia</div>
                                <div class="wall-char-value">${prodotto.maniglia}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coloreManiglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Colore Maniglia</div>
                                <div class="wall-char-value">${prodotto.coloreManiglia}</div>
                            </div>
                        ` : ''}
                        ${prodotto.allarme ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Allarme</div>
                                <div class="wall-char-value">${prodotto.allarme}</div>
                            </div>
                        ` : ''}
                        ${prodotto.materiale ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Ispezione</div>
                                <div class="wall-char-value">${prodotto.materiale}</div>
                            </div>
                        ` : ''}
                        ${prodotto.modello ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Modello</div>
                                <div class="wall-char-value">${prodotto.modello}</div>
                            </div>
                        ` : ''}
                        ${prodotto.sistema ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Sistema</div>
                                <div class="wall-char-value">${prodotto.sistema}</div>
                            </div>
                        ` : ''}
                        ${prodotto.coibentazione ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Isolamento Posaclima</div>
                                <div class="wall-char-value">${prodotto.coibentazione}</div>
                            </div>
                        ` : ''}
                        ${prodotto.maglia ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Maglia</div>
                                <div class="wall-char-value">${prodotto.maglia}</div>
                            </div>
                        ` : ''}
                        ${prodotto.guida ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Guida</div>
                                <div class="wall-char-value">${prodotto.guida}</div>
                            </div>
                        ` : ''}
                        ${prodotto.profilo ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Profilo</div>
                                <div class="wall-char-value">${prodotto.profilo}</div>
                            </div>
                        ` : ''}
                        ${prodotto.accessori ? `
                            <div class="wall-char-item">
                                <div class="wall-char-label">Accessori</div>
                                <div class="wall-char-value">${prodotto.accessori}</div>
                            </div>
                        ` : ''}
                        ${prodotto.note ? `
                            <div class="wall-char-item" style="grid-column: 1 / -1;">
                                <div class="wall-char-label">ğŸ“ Note</div>
                                <div class="wall-char-value">${prodotto.note}</div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        function setupProductTabs() {
            // GiÃ  gestito con onclick inline
        }

        function switchProductTab(tipo) {
            // Rimuovi active da tutti i tab
            document.querySelectorAll('.product-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.product-content').forEach(content => content.classList.remove('active'));
            
            // Attiva tab selezionato
            event.target.classList.add('active');
            document.querySelector(`.product-content[data-product="${tipo}"]`).classList.add('active');
        }

        // ============================================================================
        // SEZIONE E: SITUAZIONE PREESISTENTE - TUTTI I PRODOTTI
        // ============================================================================
        function renderPositionPreexisting(pos) {
            const rilievi = {
                infissi: pos.rilievo_preesistente || {},
                persiane: pos.rilievo_persiane || {},
                tapparelle: pos.rilievo_tapparelle || {},
                zanzariere: pos.rilievo_zanzariere || {},
                cassonetti: pos.rilievo_cassonetti || {}
            };
            
            // Verifica se c'Ã¨ almeno un rilievo compilato
            const hasData = Object.values(rilievi).some(r => 
                r.materiale || r.togliere || r.smaltimento || r.tipologia || r.stato
            );
            
            if (!hasData) return '';
            
            let html = `<div class="position-section">
                <h3 class="position-section-title">
                    <span class="position-section-icon">ğŸ”„</span>
                    Situazione Preesistente
                </h3>`;
            
            // INFISSI
            if (rilievi.infissi.materiale || rilievi.infissi.togliere || rilievi.infissi.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸªŸ Infissi</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.infissi.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.infissi.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.coprifiliInt ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Coprifili Int</div>
                                    <div class="wall-char-value">âœ… Presente</div>
                                </div>
                            ` : ''}
                            ${rilievi.infissi.coprifiliEst ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Coprifili Est</div>
                                    <div class="wall-char-value">âœ… Presente</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // PERSIANE
            if (rilievi.persiane.materiale || rilievi.persiane.togliere || rilievi.persiane.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸšª Persiane</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.persiane.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.persiane.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.persiane.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.persiane.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // TAPPARELLE
            if (rilievi.tapparelle.materiale || rilievi.tapparelle.togliere || rilievi.tapparelle.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸ“¦ Tapparelle</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.tapparelle.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.tapparelle.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.tapparelle.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.tapparelle.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // ZANZARIERE
            if (rilievi.zanzariere.materiale || rilievi.zanzariere.togliere || rilievi.zanzariere.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸª° Zanzariere</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.zanzariere.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.zanzariere.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.zanzariere.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.zanzariere.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            // CASSONETTI
            if (rilievi.cassonetti.materiale || rilievi.cassonetti.togliere || rilievi.cassonetti.smaltimento) {
                html += `
                    <div style="margin-bottom: 15px;">
                        <h4 style="font-weight: 600; color: #4b5563; margin-bottom: 8px;">ğŸ“¦ Cassonetti</h4>
                        <div class="wall-chars-grid">
                            ${rilievi.cassonetti.materiale ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Materiale</div>
                                    <div class="wall-char-value">${rilievi.cassonetti.materiale}</div>
                                </div>
                            ` : ''}
                            ${rilievi.cassonetti.togliere ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Da Togliere</div>
                                    <div class="wall-char-value">âœ… SÃ¬</div>
                                </div>
                            ` : ''}
                            ${rilievi.cassonetti.smaltimento ? `
                                <div class="wall-char-item">
                                    <div class="wall-char-label">Smaltimento</div>
                                    <div class="wall-char-value">âœ… Necessario</div>
                                </div>
                            ` : ''}
                        </div>
                    </div>
                `;
            }
            
            html += `</div>`;
            return html;
        }

        // ============================================================================
        // SEZIONE F: NOTE TECNICHE
        // ============================================================================
        function renderPositionNotes(pos) {
            const hasNotes = pos.note || pos.note_tecniche || pos.note_montaggio;
            
            if (!hasNotes) return '';
            
            return `
                <div class="position-section">
                    <h3 class="position-section-title">
                        <span class="position-section-icon">ğŸ“</span>
                        Note Tecniche e CriticitÃ 
                    </h3>
                    
                    <div class="notes-tags">
                        ${pos.urgente ? '<span class="note-tag urgente">âš ï¸ URGENTE</span>' : ''}
                        ${pos.da_verificare ? '<span class="note-tag verificare">ğŸ” Da Verificare</span>' : ''}
                        ${pos.richiesta_cliente ? '<span class="note-tag richiesta">ğŸ’¬ Richiesta Cliente</span>' : ''}
                        ${pos.problema_accesso ? '<span class="note-tag problema">ğŸš§ Problema Accesso</span>' : ''}
                    </div>
                    
                    <div class="notes-content">
                        ${pos.note || pos.note_tecniche || pos.note_montaggio || 'Nessuna nota'}
                    </div>
                </div>
            `;
        }

        // ============================================================================
        // NAVIGAZIONE POSIZIONI
        // ============================================================================
        function renderPositionNavigation(index) {
            const hasPrev = index > 0;
            const hasNext = index < filteredPositions.length - 1;
            
            return `
                <div class="position-navigation">
                    <button class="nav-btn-position" 
                            onclick="navigatePosition(-1)" 
                            ${!hasPrev ? 'disabled' : ''}>
                        â† Posizione Precedente
                    </button>
                    <button class="nav-btn-position" 
                            onclick="navigatePosition(1)" 
                            ${!hasNext ? 'disabled' : ''}>
                        Posizione Successiva â†’
                    </button>
                </div>
            `;
        }

        function navigatePosition(direction) {
            const newIndex = currentPositionIndex + direction;
            if (newIndex >= 0 && newIndex < filteredPositions.length) {
                selectPosition(newIndex);
            }
        }

        // Keyboard shortcuts per navigazione posizioni
        document.addEventListener('keydown', (e) => {
            // Solo se Vista Posizioni Ã¨ attiva
            const vistaActive = document.getElementById('vista-posizioni-ufficio').classList.contains('active');
            if (!vistaActive) return;
            
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                navigatePosition(-1);
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                navigatePosition(1);
            }
        });

        // ============================================================================
        // MODIFICHE FUNZIONE LOAD DATA PER ATTIVARE VISTA POSIZIONI
        // ============================================================================
        // Modifichiamo la funzione handleDataLoad esistente per popolare anche Vista Posizioni

        // ============================================================================
        // BLOCCO POSA - STATO E NAVIGAZIONE
        // ============================================================================
        let posaState = {
            currentView: 'generale', // 'generale' o 'posizioni'
            currentPositionIndex: 0,
            totalPositions: 0,
            positions: []
        };

        /**
         * Apri Posa App separata in nuova finestra
         * v7.29
         */
        function apriPosaApp() {
            // Verifica che ci sia un progetto caricato
            if (!appState.rilievoData) {
                alert('âš ï¸ Carica prima un progetto per aprire la Posa App!');
                return;
            }
            
            // Ottieni ID progetto
            const projectId = appState.rilievoData.id || appState.rilievoData.codiceCommessa || 'progetto';
            
            // Salva ID in localStorage per la Posa App
            localStorage.setItem('posa_app_project_id', projectId);
            
            console.log('ğŸ”— Apertura Posa App per progetto:', projectId);
            
            // Apri Posa App in nuova finestra
            const posaWindow = window.open(
                'posa-app-v1_6.html',
                'PosaApp',
                'width=1400,height=900,menubar=no,toolbar=no,location=no,status=yes,scrollbars=yes,resizable=yes'
            );
            
            if (!posaWindow) {
                alert('âš ï¸ Popup bloccato!\n\nAbilita i popup per questo sito nelle impostazioni del browser.');
            } else {
                console.log('âœ… Posa App aperta in nuova finestra');
            }
        }

        // Switch tra viste Posa
        function switchVistaPosa(vista, event) {
            console.log(`Switching Posa vista to: ${vista}`);
            posaState.currentView = vista;
            
            // v7.20: Gestisci stati bottoni submenu
            if (event) {
                document.querySelectorAll('.submenu-btn-posa').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }
            
            // Nascondi tutte le viste posa
            document.querySelectorAll('.posa-view').forEach(v => v.style.display = 'none');
            
            // Mostra vista selezionata
            if (vista === 'generale') {
                document.getElementById('posa-generale').style.display = 'block';
                if (appState.rilievoData) {
                    renderVistaGeneraleCantiere(appState.rilievoData);
                }
            } else if (vista === 'posizioni') {
                document.getElementById('posa-posizioni').style.display = 'block';
                if (appState.rilievoData) {
                    renderVistaPosizioneCantiere(appState.rilievoData);
                }
            } else if (vista === 'dettaglio') {
                // v7.20: Vista dettaglio posa
                document.getElementById('posa-dettaglio').style.display = 'block';
                if (appState.rilievoData) {
                    document.getElementById('posaDettaglioPlaceholder').style.display = 'none';
                    document.getElementById('posaDettaglioContent').style.display = 'block';
                    renderDettaglioPosa();
                } else {
                    document.getElementById('posaDettaglioPlaceholder').style.display = 'block';
                    document.getElementById('posaDettaglioContent').style.display = 'none';
                }
            }
        }

        // ============================================================================
        // VISTA 3.1 - GENERALE CANTIERE
        // ============================================================================
        function renderVistaGeneraleCantiere(data) {
            console.log('ğŸ—ï¸ Rendering Vista Generale Cantiere...');
            
            const placeholder = document.getElementById('posaCantierePlaceholder');
            const content = document.getElementById('posaCantiereContent');
            
            if (!data || !data.posizioni) {
                placeholder.style.display = 'block';
                content.style.display = 'none';
                return;
            }
            
            placeholder.style.display = 'none';
            content.style.display = 'block';
            
            let html = '';
            
            // SEZIONE A - MATERIALI DA PORTARE
            html += renderMaterialiDaPortare(data.posizioni);
            
            // SEZIONE B - STRUMENTI NECESSARI
            html += renderStrumentiNecessari(data.posizioni);
            
            // SEZIONE C - ORDINE MONTAGGIO
            html += renderOrdineMontaggio(data.posizioni);
            
            // SEZIONE D - CHECKLIST PREPARAZIONE
            html += renderChecklistPreparazione();
            
            // SEZIONE E - INFO LOGISTICHE
            html += renderInfoLogistiche(data);
            
            content.innerHTML = html;
            
            // Setup event listeners per checklist
            setupChecklistListeners();
        }

        function renderMaterialiDaPortare(posizioni) {
            // Raggruppa materiali per tipo
            const materiali = {
                infissi: [],
                persiane: [],
                tapparelle: [],
                zanzariere: [],
                cassonetti: [],
                accessori: []
            };
            
            posizioni.forEach(pos => {
                if (pos.infisso && pos.infisso.quantita > 0) {
                    materiali.infissi.push({
                        tipo: pos.infisso.tipo || 'N/D',
                        azienda: pos.infisso.azienda || 'N/D',
                        quantita: pos.infisso.quantita,
                        brm: pos.infisso.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.persiana && pos.persiana.quantita > 0) {
                    materiali.persiane.push({
                        tipo: pos.persiana.tipo || 'Persiana',
                        azienda: pos.persiana.azienda || 'N/D',
                        quantita: pos.persiana.quantita,
                        brm: pos.persiana.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.tapparella && pos.tapparella.quantita > 0) {
                    materiali.tapparelle.push({
                        tipo: pos.tapparella.tipo || 'Tapparella',
                        motorizzata: pos.tapparella.motorizzazione !== 'manuale',
                        azienda: pos.tapparella.azienda || 'N/D',
                        quantita: pos.tapparella.quantita,
                        brm: pos.tapparella.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                    materiali.zanzariere.push({
                        tipo: pos.zanzariera.tipo || 'Zanzariera',
                        quantita: pos.zanzariera.quantita,
                        brm: pos.zanzariera.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
                
                if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                    materiali.cassonetti.push({
                        tipo: pos.cassonetto.tipo || 'Cassonetto',
                        quantita: pos.cassonetto.quantita,
                        brm: pos.cassonetto.brm || {},
                        posizione: pos.ambiente || pos.nome || pos.stanza || pos.id
                    });
                }
            });
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ“¦ Materiali da Portare</h2>
                    <div class="materials-grid">
            `;
            
            // INFISSI
            if (materiali.infissi.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸªŸ INFISSI</div>
                `;
                materiali.infissi.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.azienda} - ${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // PERSIANE
            if (materiali.persiane.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸªŸ PERSIANE</div>
                `;
                materiali.persiane.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.azienda} - ${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // TAPPARELLE
            if (materiali.tapparelle.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸªŸ TAPPARELLE</div>
                `;
                materiali.tapparelle.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.azienda} - ${item.tipo} (x${item.quantita})</strong>
                            ${item.motorizzata ? 'âš¡ Motorizzata' : 'Manuale'}
                            ${item.brm.L ? `<br>L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // ZANZARIERE
            if (materiali.zanzariere.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸ¦Ÿ ZANZARIERE</div>
                `;
                materiali.zanzariere.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // CASSONETTI
            if (materiali.cassonetti.length > 0) {
                html += `
                    <div class="material-category">
                        <div class="material-category-title">ğŸ“¦ CASSONETTI</div>
                `;
                materiali.cassonetti.forEach(item => {
                    html += `
                        <div class="material-item">
                            <strong>${item.tipo} (x${item.quantita})</strong>
                            ${item.brm.L ? `L: ${item.brm.L}mm Ã— H: ${item.brm.H}mm` : ''}
                            <br><small>Posizione: ${item.posizione}</small>
                        </div>
                    `;
                });
                html += `</div>`;
            }
            
            // ACCESSORI
            html += `
                <div class="material-category">
                    <div class="material-category-title">ğŸ”§ ACCESSORI</div>
                    <div class="material-item"><strong>Viti e tasselli</strong></div>
                    <div class="material-item"><strong>Silicone</strong></div>
                    <div class="material-item"><strong>Guarnizioni</strong></div>
                    <div class="material-item"><strong>Coprifili</strong></div>
                </div>
            `;
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderStrumentiNecessari(posizioni) {
            const strumenti = [
                'Trapano elettrico',
                'Livella laser',
                'Metro a nastro (5m)',
                'Seghetto alternativo',
                'Cacciaviti (set completo)',
                'Chiavi inglesi',
                'Martello',
                'Pistola silicone',
                'Aspiratore/Soffiatore',
                'Scala telescopica',
                'Protezioni (occhiali, guanti)',
                'Materiale imballaggio vecchi infissi'
            ];
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ› ï¸ Strumenti Necessari</h2>
                    <div class="tools-checklist">
            `;
            
            strumenti.forEach((strumento, index) => {
                html += `
                    <div class="tool-item">
                        <input type="checkbox" class="tool-checkbox" id="tool-${index}" 
                               onchange="saveToolCheck(${index}, this.checked)">
                        <label for="tool-${index}">${strumento}</label>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderOrdineMontaggio(posizioni) {
            // Raggruppa per piano
            const perPiano = {};
            posizioni.forEach(pos => {
                const piano = pos.piano || 'Non specificato';
                if (!perPiano[piano]) {
                    perPiano[piano] = [];
                }
                perPiano[piano].push(pos);
            });
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ“‹ Ordine Montaggio Suggerito</h2>
                    <div class="mounting-order">
            `;
            
            let stepNum = 1;
            Object.keys(perPiano).sort().forEach(piano => {
                html += `
                    <div class="order-step">
                        <span class="order-step-number">${stepNum}</span>
                        <strong>${piano}</strong>
                        <div style="margin-left: 3rem; margin-top: 0.5rem;">
                `;
                
                // Raggruppa per stanza in questo piano
                const perStanza = {};
                perPiano[piano].forEach(pos => {
                    const stanza = pos.stanza || 'Non specificata';
                    if (!perStanza[stanza]) {
                        perStanza[stanza] = [];
                    }
                    perStanza[stanza].push(pos);
                });
                
                Object.keys(perStanza).forEach((stanza, idx) => {
                    html += `${idx > 0 ? ' â†’ ' : ''}${stanza} (${perStanza[stanza].length} pos.)`;
                });
                
                html += `
                        </div>
                    </div>
                `;
                stepNum++;
            });
            
            html += `
                    </div>
                    <div style="margin-top: 1rem; padding: 1rem; background: #fef3c7; border-radius: 8px;">
                        ğŸ’¡ <strong>Suggerimento:</strong> Procedere dal basso verso l'alto per ottimizzare i tempi e ridurre i trasporti di materiale.
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderChecklistPreparazione() {
            const checklist = {
                'Pre-cantiere': [
                    'Materiali caricati su furgone',
                    'Strumenti verificati e funzionanti',
                    'Squadra informata e briefing fatto',
                    'Cliente avvisato orario arrivo',
                    'Accessi e parcheggio verificati'
                ],
                'Durante lavori': [
                    'Protezioni pavimenti/mobili posizionate',
                    'Aspiratore/soffiatore pronto',
                    'Area lavoro delimitata',
                    'Contenitori per smaltimento predisposti'
                ],
                'Fine lavori': [
                    'Pulizia completa area lavoro',
                    'Smaltimento rifiuti organizzato',
                    'Verifica con cliente',
                    'Documenti firmati'
                ]
            };
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">âœ… Checklist Preparazione</h2>
                    <div class="preparation-checklist">
            `;
            
            Object.keys(checklist).forEach(gruppo => {
                html += `
                    <div class="checklist-group">
                        <div class="checklist-group-title">${gruppo}</div>
                `;
                
                checklist[gruppo].forEach((item, index) => {
                    const itemId = `prep-${gruppo.replace(/\s+/g, '-')}-${index}`;
                    html += `
                        <div class="checklist-item" id="item-${itemId}">
                            <input type="checkbox" id="${itemId}" 
                                   onchange="toggleChecklistItem('${itemId}', this.checked)">
                            <label for="${itemId}">${item}</label>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderInfoLogistiche(data) {
            const cliente = data.cliente || {};
            
            let html = `
                <div class="cantiere-section">
                    <h2 class="cantiere-section-title">ğŸ“ Informazioni Logistiche</h2>
                    <div class="logistics-info">
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ  Indirizzo cantiere:</span>
                            <span class="logistics-value">${cliente.indirizzo || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ“… Piano:</span>
                            <span class="logistics-value">${cliente.piano || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ‘¤ Referente:</span>
                            <span class="logistics-value">${cliente.nome || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ“ Telefono:</span>
                            <span class="logistics-value">${cliente.telefono || 'Non specificato'}</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">â° Orari accesso:</span>
                            <span class="logistics-value">Da concordare</span>
                        </div>
                        <div class="logistics-item">
                            <span class="logistics-label">ğŸ…¿ï¸ Parcheggio:</span>
                            <span class="logistics-value">Da verificare</span>
                        </div>
                        ${data.note_progetto ? `
                        <div class="logistics-item" style="border-top: 2px solid #f59e0b; margin-top: 1rem; padding-top: 1rem;">
                            <span class="logistics-label">ğŸ“ Note progetto:</span>
                            <span class="logistics-value">${data.note_progetto}</span>
                        </div>
                        ` : ''}
                    </div>
                </div>
            `;
            
            return html;
        }

        // ============================================================================
        // VISTA 3.2 - POSIZIONI CANTIERE
        // ============================================================================
        function renderVistaPosizioneCantiere(data) {
            console.log('ğŸ”¨ Rendering Vista Posizioni Cantiere...');
            
            if (!data || !data.posizioni || data.posizioni.length === 0) {
                return;
            }
            
            posaState.positions = data.posizioni;
            posaState.totalPositions = data.posizioni.length;
            posaState.currentPositionIndex = 0;
            
            renderSchedaMontaggio();
        }

        function renderSchedaMontaggio() {
            const pos = posaState.positions[posaState.currentPositionIndex];
            if (!pos) return;
            
            const content = document.getElementById('posaPositionContent');
            if (!content) return;
            
            // Update header info
            document.getElementById('posaCurrentPositionId').textContent = pos.id || 'N/D';
            document.getElementById('posaCurrentLocation').textContent = 
                `${pos.piano || 'N/D'} | ${pos.stanza || 'N/D'} | ${pos.ambiente || 'N/D'}`;
            
            // Update navigation buttons
            document.getElementById('posaPrevBtn').disabled = (posaState.currentPositionIndex === 0);
            document.getElementById('posaNextBtn').disabled = (posaState.currentPositionIndex === posaState.totalPositions - 1);
            
            let html = '';
            
            // MISURE BRM GRANDI
            html += renderMisureBRMGrandi(pos);
            
            // CARATTERISTICHE MURO
            html += renderCaratteristicheMuro(pos);
            
            // ISTRUZIONI MONTAGGIO
            html += renderIstruzioniMontaggio(pos);
            
            // MATERIALI SPECIFICI
            html += renderMaterialiPosizione(pos);
            
            // NOTE E ALERT
            html += renderNoteAlert(pos);
            
            // CHECKLIST OPERAZIONI
            html += renderChecklistOperazioni(pos);
            
            content.innerHTML = html;
            
            // Restore checklist state
            restoreChecklistState(pos.id);
        }

        function renderMisureBRMGrandi(pos) {
            let html = '<div class="brm-section">';
            html += '<h2 class="cantiere-section-title">ğŸ“ Misure BRM</h2>';
            
            // INFISSO
            if (pos.infisso && pos.infisso.quantita > 0) {
                // ğŸ”§ COMPATIBILITÃ€: Legge sia brm.L che BRM_L
                const L = pos.infisso.brm?.L || pos.infisso.BRM_L || 0;
                const H = pos.infisso.brm?.H || pos.infisso.BRM_H || 0;
                const C = pos.infisso.brm?.C || pos.infisso.BRM_C || 0;
                const B = pos.infisso.brm?.B || pos.infisso.BRM_B || 0;
                
                if (L || H) {  // Mostra solo se ha misure
                    html += `
                        <div class="brm-box-large">
                            <div class="brm-product-title">ğŸªŸ INFISSO ${pos.infisso.tipo || ''}</div>
                            <div class="brm-measurements">
                                <div class="brm-measure">
                                    <div class="brm-label">Larghezza (L)</div>
                                    <div class="brm-value">${L}<span class="brm-unit">mm</span></div>
                                </div>
                                <div class="brm-measure">
                                    <div class="brm-label">Altezza (H)</div>
                                    <div class="brm-value">${H}<span class="brm-unit">mm</span></div>
                                </div>
                                <div class="brm-measure">
                                    <div class="brm-label">Cassettone (C)</div>
                                    <div class="brm-value">${C}<span class="brm-unit">mm</span></div>
                                </div>
                                <div class="brm-measure">
                                    <div class="brm-label">Base (B)</div>
                                    <div class="brm-value">${B}<span class="brm-unit">mm</span></div>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // TAPPARELLA
            if (pos.tapparella && pos.tapparella.quantita > 0 && pos.tapparella.brm) {
                const brm = pos.tapparella.brm;
                html += `
                    <div class="brm-box-large">
                        <div class="brm-product-title">ğŸªŸ TAPPARELLA</div>
                        <div class="brm-measurements">
                            <div class="brm-measure">
                                <div class="brm-label">Larghezza (L)</div>
                                <div class="brm-value">${brm.L || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Altezza (H)</div>
                                <div class="brm-value">${brm.H || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Cassettone (C)</div>
                                <div class="brm-value">${brm.C || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Base (B)</div>
                                <div class="brm-value">${brm.B || 0}<span class="brm-unit">mm</span></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // CASSONETTO
            if (pos.cassonetto && pos.cassonetto.quantita > 0 && pos.cassonetto.brm) {
                const brm = pos.cassonetto.brm;
                html += `
                    <div class="brm-box-large">
                        <div class="brm-product-title">ğŸ“¦ CASSONETTO</div>
                        <div class="brm-measurements">
                            <div class="brm-measure">
                                <div class="brm-label">Larghezza (L)</div>
                                <div class="brm-value">${brm.L || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Altezza (H)</div>
                                <div class="brm-value">${brm.H || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Cassettone (C)</div>
                                <div class="brm-value">${brm.C || 0}<span class="brm-unit">mm</span></div>
                            </div>
                            <div class="brm-measure">
                                <div class="brm-label">Base (B)</div>
                                <div class="brm-value">${brm.B || 0}<span class="brm-unit">mm</span></div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function renderCaratteristicheMuro(pos) {
            const muro = pos.caratteristiche_muro_override || appState.rilievoData?.caratteristiche_muro_globali || {};
            
            let html = `
                <div class="muro-section">
                    <h2 class="cantiere-section-title">ğŸ§± Caratteristiche Muro</h2>
                    <div class="muro-grid">
                        <div class="muro-item">
                            <div class="muro-label">Telaio</div>
                            <div class="muro-value">${muro.telaio_larghezza || 0} Ã— ${muro.telaio_altezza || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">ProfonditÃ  Muro INT</div>
                            <div class="muro-value">${muro.prof_muro_int || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">ProfonditÃ  Muro EST</div>
                            <div class="muro-value">${muro.prof_muro_est || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">Falso Esistente</div>
                            <div class="muro-value">${muro.falso_esistente === 'si' ? `SÃ¬ (${muro.spessore_falso || 0}mm)` : 'No'}</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">Coprifilo</div>
                            <div class="muro-value">${muro.coprifilo_larghezza || 0} mm</div>
                        </div>
                        <div class="muro-item">
                            <div class="muro-label">Battuta Sup. Tapparella</div>
                            <div class="muro-value">${muro.battuta_superiore_tapparella || 0} mm</div>
                        </div>
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderIstruzioniMontaggio(pos) {
            const steps = [
                {
                    title: 'PREPARAZIONE',
                    tasks: [
                        'Rimuovere vecchio infisso/telaio',
                        'Pulire vano da polvere e detriti',
                        `Verificare misure vano: LVT ${pos.misure?.LVT || 'N/D'} Ã— HVT ${pos.misure?.HVT || 'N/D'} mm`,
                        'Controllare planaritÃ  muro'
                    ]
                },
                {
                    title: 'MONTAGGIO TELAIO',
                    tasks: [
                        `Posizionare telaio (BRM: L=${pos.infisso?.brm?.L || 'N/D'} H=${pos.infisso?.brm?.H || 'N/D'})`,
                        'Centrare e mettere in bolla',
                        'Fissare con viti/tasselli (min. 4 punti)',
                        'Verificare apertura/chiusura'
                    ]
                },
                {
                    title: 'MONTAGGIO ANTA',
                    tasks: [
                        'Inserire anta nei cardini',
                        'Regolare cerniere',
                        'Verificare chiusura ermetica',
                        'Testare movimenti'
                    ]
                }
            ];
            
            // Add tapparella step if present
            if (pos.tapparella && pos.tapparella.quantita > 0) {
                steps.push({
                    title: 'MONTAGGIO TAPPARELLA',
                    tasks: [
                        `Installare guide (BRM: L=${pos.tapparella?.brm?.L || 'N/D'})`,
                        'Inserire telo tapparella',
                        pos.tapparella.motorizzazione !== 'manuale' ? 'Collegare motore e testare' : 'Installare cinghia',
                        'Verificare scorrimento fluido'
                    ]
                });
            }
            
            // Add cassonetto step if present
            if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                steps.push({
                    title: 'MONTAGGIO CASSONETTO',
                    tasks: [
                        `Posizionare cassonetto (BRM: L=${pos.cassonetto?.brm?.L || 'N/D'})`,
                        'Fissare al muro',
                        'Chiudere sportelli',
                        'Verificare allineamento'
                    ]
                });
            }
            
            steps.push({
                title: 'RIFINITURA',
                tasks: [
                    'Applicare silicone perimetrale',
                    'Montare coprifili INT/EST',
                    'Pulizia finale area lavoro',
                    'Verifica con cliente'
                ]
            });
            
            let html = `
                <div class="instructions-section">
                    <h2 class="cantiere-section-title">ğŸ“‹ Istruzioni Montaggio</h2>
            `;
            
            steps.forEach((step, index) => {
                html += `
                    <div class="instruction-step">
                        <span class="step-number">${index + 1}</span>
                        <div class="step-title">${step.title}</div>
                        <ul class="step-tasks">
                `;
                
                step.tasks.forEach((task, taskIndex) => {
                    const taskId = `step-${index}-task-${taskIndex}`;
                    html += `
                        <li class="step-task">
                            <input type="checkbox" id="${taskId}">
                            <label for="${taskId}">${task}</label>
                        </li>
                    `;
                });
                
                html += `
                        </ul>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function renderMaterialiPosizione(pos) {
            let html = `
                <div class="materials-list">
                    <h2 class="cantiere-section-title">ğŸ“¦ Materiali Specifici Posizione</h2>
            `;
            
            if (pos.infisso && pos.infisso.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸªŸ <strong>Infisso ${pos.infisso.tipo || 'N/D'}</strong> - ${pos.infisso.azienda || 'N/D'}
                        <br>Finitura: ${pos.infisso.finitura_int || 'N/D'} / ${pos.infisso.finitura_est || 'N/D'}
                        <br>QuantitÃ : ${pos.infisso.quantita}
                    </div>
                `;
            }
            
            if (pos.tapparella && pos.tapparella.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸªŸ <strong>Tapparella</strong> ${pos.tapparella.motorizzazione !== 'manuale' ? 'âš¡ Motorizzata' : 'Manuale'}
                        <br>Azienda: ${pos.tapparella.azienda || 'N/D'}
                        <br>QuantitÃ : ${pos.tapparella.quantita}
                    </div>
                `;
            }
            
            if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸ“¦ <strong>Cassonetto ${pos.cassonetto.tipo || 'N/D'}</strong>
                        <br>QuantitÃ : ${pos.cassonetto.quantita}
                    </div>
                `;
            }
            
            if (pos.persiana && pos.persiana.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸªŸ <strong>Persiana ${pos.persiana.tipo || 'N/D'}</strong>
                        <br>Azienda: ${pos.persiana.azienda || 'N/D'}
                        <br>QuantitÃ : ${pos.persiana.quantita}
                    </div>
                `;
            }
            
            if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸ¦Ÿ <strong>Zanzariera ${pos.zanzariera.tipo || 'N/D'}</strong>
                        <br>QuantitÃ : ${pos.zanzariera.quantita}
                    </div>
                `;
            }
            
            // Coprifili
            const coprifilo = pos.caratteristiche_muro_override?.coprifilo_larghezza || 
                            appState.rilievoData?.caratteristiche_muro_globali?.coprifilo_larghezza || 0;
            if (coprifilo > 0) {
                html += `
                    <div class="material-list-item">
                        ğŸ“ <strong>Coprifili ${coprifilo}mm</strong> - circa 6m
                    </div>
                `;
            }
            
            html += `
                    <div class="material-list-item">
                        ğŸ”§ <strong>Accessori:</strong> Viti, tasselli, silicone, guarnizioni
                    </div>
                </div>
            `;
            
            return html;
        }

        function renderNoteAlert(pos) {
            let html = `
                <div class="notes-alerts-section">
                    <h2 class="cantiere-section-title">âš ï¸ Note e Attenzioni</h2>
            `;
            
            // Note posizione
            if (pos.note_posizione) {
                html += `
                    <div class="alert-item info">
                        ğŸ“ <strong>Nota:</strong> ${pos.note_posizione}
                    </div>
                `;
            }
            
            // Falso telaio presente
            const muro = pos.caratteristiche_muro_override || appState.rilievoData?.caratteristiche_muro_globali || {};
            if (muro.falso_esistente === 'si') {
                html += `
                    <div class="alert-item warning">
                        âš ï¸ <strong>Attenzione:</strong> Falso telaio presente (${muro.spessore_falso || 0}mm)!
                    </div>
                `;
            }
            
            // Suggerimenti
            html += `
                <div class="alert-item tip">
                    ğŸ’¡ <strong>Suggerimento:</strong> Verificare sempre le misure in opera prima del montaggio
                </div>
            `;
            
            // Delta INT/EST diverso
            if (pos.misure && Math.abs((pos.misure.DeltaINT || 0) - (pos.misure.DeltaEST || 0)) > 5) {
                html += `
                    <div class="alert-item warning">
                        âš ï¸ <strong>Attenzione:</strong> Spessore muro variabile (INT: ${pos.misure.DeltaINT || 0}mm, EST: ${pos.misure.DeltaEST || 0}mm)
                    </div>
                `;
            }
            
            html += '</div>';
            return html;
        }

        function renderChecklistOperazioni(pos) {
            const operations = [
                'Vano preparato e pulito',
                'Telaio montato e fissato',
                'Anta installata e funzionante',
                'Tapparella installata (se presente)',
                'Cassonetto montato (se presente)',
                'Silicone applicato',
                'Coprifili montati',
                'Pulizia effettuata',
                'Cliente soddisfatto e ha firmato'
            ];
            
            let html = `
                <div class="final-checklist-section">
                    <h2 class="cantiere-section-title">âœ… Checklist Operazioni Finali</h2>
            `;
            
            operations.forEach((op, index) => {
                const opId = `final-op-${pos.id}-${index}`;
                html += `
                    <div class="final-checklist-item" id="item-${opId}">
                        <input type="checkbox" id="${opId}" 
                               onchange="toggleFinalCheckItem('${opId}', this.checked, '${pos.id}')">
                        <label for="${opId}">${op}</label>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        // ============================================================================
        // VISTA 3.3 - DETTAGLIO POSA (v7.20)
        // ============================================================================
        
        /**
         * Configurazione campi prodotti - MODULABILE
         * Modifica qui per cambiare quali campi visualizzare
         */
        const CAMPI_PRODOTTI_POSA = {
            infisso: {
                label: 'ğŸªŸ Infisso',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'telaio', label: 'Telaio' },
                    { key: 'tipoAnta', label: 'Tipo Anta' },
                    { key: 'finituraInt', label: 'Fin. Int', combineWith: 'coloreInt' },
                    { key: 'finituraEst', label: 'Fin. Est', combineWith: 'coloreEst' },
                    { key: 'allarme', label: 'Allarme', separate: true }
                ]
            },
            persiana: {
                label: 'ğŸšª Persiana',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'apertura', label: 'Apertura' },
                    { key: 'fissaggio', label: 'Fissaggio' },
                    { key: 'brm_l', label: 'BRM L', source: 'brm.larghezza' },
                    { key: 'brm_h', label: 'BRM H', source: 'brm.altezza' }
                ]
            },
            zanzariera: {
                label: 'ğŸ¦Ÿ Zanzariera',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'montaggio', label: 'Montaggio' },
                    { key: 'brm_l', label: 'BRM L', source: 'brm.larghezza' },
                    { key: 'brm_h', label: 'BRM H', source: 'brm.altezza' }
                ]
            },
            cassonetto: {
                label: 'ğŸ“¦ Cassonetto',
                campi: [
                    { key: 'modello', label: 'Modello' },
                    { key: 'brm_l', label: 'BRM L', source: 'brm.larghezza' },
                    { key: 'brm_h', label: 'BRM H', source: 'brm.altezza' },
                    { key: 'brm_c', label: 'BRM C', source: 'brm.profondita' },
                    { key: 'brm_b', label: 'BRM B', source: 'brm.spessore' }
                ]
            },
            tapparella: {
                label: 'ğŸšï¸ Tapparella',
                campi: [
                    { key: 'tipo', label: 'Tipo' },
                    { key: 'montaggio', label: 'Montaggio' },
                    { key: 'sistema', label: 'Sistema' },
                    { key: 'azionamento', label: 'Azionamento' }
                ]
            }
        };

        /**
         * Ottiene valore campo da prodotto navigando percorso (es: 'brm.larghezza')
         */
        function getValoreCampo(prodotto, source) {
            if (!source) return '-';
            
            const path = source.split('.');
            let value = prodotto;
            
            for (const key of path) {
                if (value && typeof value === 'object' && key in value) {
                    value = value[key];
                } else {
                    return '-';
                }
            }
            
            return value || '-';
        }

        /**
         * Combina due campi in un valore (es: "pvc 42" o "alluminio L19")
         */
        function combineFields(prodotto, field1, field2) {
            const val1 = prodotto[field1] || '';
            const val2 = prodotto[field2] || '';
            
            if (!val1 && !val2) return '-';
            if (!val1) return val2;
            if (!val2) return val1;
            
            return `${val1} ${val2}`;
        }

        /**
         * Renderizza tabella dettaglio posa
         */
        function renderDettaglioPosa() {
            if (!appState.rilievoData || !appState.rilievoData.posizioni) {
                console.log('âŒ Nessun dato rilievo disponibile');
                return;
            }

            const posizioni = appState.rilievoData.posizioni;
            const container = document.getElementById('dettaglioPosaContainer');
            
            if (!container) {
                console.error('âŒ Container dettaglio posa non trovato');
                return;
            }

            let html = '';

            // Per ogni posizione
            posizioni.forEach((pos, idx) => {
                const posNum = idx + 1;
                const nomePos = pos.nome || pos.ambiente || `Posizione ${posNum}`;
                const piano = pos.piano || '-';
                
                // Raccogli tutti i prodotti della posizione
                const prodottiPosizione = [];
                
                // Controlla ogni tipo di prodotto
                ['infisso', 'persiana', 'zanzariera', 'cassonetto', 'tapparella'].forEach(tipoProdotto => {
                    const prodotto = pos[tipoProdotto];
                    
                    // Se prodotto esiste e ha quantitÃ  > 0
                    if (prodotto && (prodotto.quantita > 0 || prodotto.qta > 0)) {
                        const qta = prodotto.quantita || prodotto.qta || 1;
                        prodottiPosizione.push({
                            tipo: tipoProdotto,
                            dati: prodotto,
                            quantita: qta
                        });
                    }
                });

                // Se posizione ha prodotti, crea sezione
                if (prodottiPosizione.length > 0) {
                    html += `
                        <div class="card" style="margin-bottom: 1.5rem;">
                            <!-- Header Posizione -->
                            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; padding: 1rem; border-radius: 8px 8px 0 0; margin: -1.5rem -1.5rem 1rem -1.5rem;">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <h3 style="margin: 0; font-size: 1.1rem;">ğŸ“ ${nomePos}</h3>
                                        <p style="margin: 0.25rem 0 0 0; font-size: 0.85rem; opacity: 0.9;">Piano: ${piano} â€¢ ${prodottiPosizione.length} prodott${prodottiPosizione.length > 1 ? 'i' : 'o'}</p>
                                    </div>
                                    <div style="font-size: 1.5rem; font-weight: bold; opacity: 0.8;">#${posNum}</div>
                                </div>
                            </div>
                    `;

                    // Per ogni prodotto, genera tabella specifica
                    prodottiPosizione.forEach(prodInfo => {
                        const config = CAMPI_PRODOTTI_POSA[prodInfo.tipo];
                        if (!config) return;

                        html += `
                            <!-- Tabella ${config.label} -->
                            <div style="overflow-x: auto; margin-bottom: 1.5rem;">
                                <table class="data-table" style="font-size: 0.9rem;">
                                    <thead>
                                        <tr>
                                            <th colspan="10" style="background: #f3f4f6; text-align: left; padding: 0.75rem;">
                                                <strong>${config.label}</strong>
                                            </th>
                                        </tr>
                                        <tr style="background: #fafafa;">
                                            <th style="width: 60px; text-align: center;">QtÃ </th>
                        `;

                        // Header colonne (escludi campi separati)
                        const campiPrincipali = config.campi.filter(c => !c.separate);
                        campiPrincipali.forEach(campo => {
                            html += `<th style="min-width: 100px;">${campo.label}</th>`;
                        });

                        html += `
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr>
                                            <td style="text-align: center;"><strong>${prodInfo.quantita}</strong></td>
                        `;

                        // Valori campi principali
                        campiPrincipali.forEach(campo => {
                            let valore;
                            
                            if (campo.combineWith) {
                                // Combina due campi (es: finitura + colore)
                                valore = combineFields(prodInfo.dati, campo.key, campo.combineWith);
                            } else if (campo.source) {
                                valore = getValoreCampo(prodInfo.dati, campo.source);
                            } else {
                                valore = prodInfo.dati[campo.key] || '-';
                            }
                            
                            html += `<td><strong>${valore}</strong></td>`;
                        });

                        html += `</tr>`;

                        // Riga separata per campi speciali (es: allarme)
                        const campiSeparati = config.campi.filter(c => c.separate);
                        if (campiSeparati.length > 0) {
                            html += `<tr style="background: #fffbeb;">`;
                            html += `<td></td>`; // Cella vuota sotto QtÃ 
                            
                            let html_campi_separati = '';
                            campiSeparati.forEach(campo => {
                                const valore = prodInfo.dati[campo.key] || '-';
                                html_campi_separati += `<span style="font-size: 0.85rem; color: #92400e;"><strong>${campo.label}:</strong> ${valore}</span> `;
                            });
                            
                            html += `<td colspan="${campiPrincipali.length}" style="padding: 0.5rem 1rem;">${html_campi_separati}</td>`;
                            html += `</tr>`;
                        }

                        html += `
                                    </tbody>
                                </table>
                            </div>
                        `;
                    });

                    html += `</div>`; // Chiudi card
                }
            });

            // Se nessuna posizione con prodotti
            if (html === '') {
                html = `
                    <div class="card">
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ“‹</div>
                            <div>Nessun prodotto trovato nelle posizioni</div>
                        </div>
                    </div>
                `;
            }

            container.innerHTML = html;
            console.log(`âœ… Dettaglio posa renderizzato per ${posizioni.length} posizioni`);
        }

        /**
         * Export CSV dettaglio posa
         */
        function exportDettaglioPosaCSV() {
            if (!appState.rilievoData || !appState.rilievoData.posizioni) {
                alert('âš ï¸ Nessun dato da esportare');
                return;
            }

            const posizioni = appState.rilievoData.posizioni;
            
            // Header CSV
            let csv = 'Posizione,Piano,Ambiente,Prodotto,Quantita,';
            
            // Trova numero massimo colonne
            let maxColonne = 0;
            Object.values(CAMPI_PRODOTTI_POSA).forEach(config => {
                maxColonne = Math.max(maxColonne, config.campi.length);
            });
            
            for (let i = 1; i <= maxColonne; i++) {
                csv += `Campo${i}_Nome,Campo${i}_Valore,`;
            }
            csv = csv.slice(0, -1) + '\n'; // Rimuovi ultima virgola

            // Righe dati
            posizioni.forEach((pos, idx) => {
                const posNum = idx + 1;
                const nomePos = pos.nome || pos.ambiente || `Pos${posNum}`;
                const piano = pos.piano || '';

                ['infisso', 'persiana', 'zanzariera', 'cassonetto', 'tapparella'].forEach(tipoProdotto => {
                    const prodotto = pos[tipoProdotto];
                    
                    if (prodotto && (prodotto.quantita > 0 || prodotto.qta > 0)) {
                        const config = CAMPI_PRODOTTI_POSA[tipoProdotto];
                        if (!config) return;

                        const qta = prodotto.quantita || prodotto.qta || 1;
                        
                        let row = [
                            posNum,
                            piano,
                            nomePos,
                            config.label.replace(/[ğŸªŸğŸšªğŸ¦ŸğŸ“¦ğŸšï¸]/g, '').trim(),
                            qta
                        ];

                        // Aggiungi coppie nome-valore
                        config.campi.forEach(campo => {
                            const valore = campo.source 
                                ? getValoreCampo(prodotto, campo.source)
                                : (prodotto[campo.key] || '-');
                            
                            row.push(campo.label);
                            row.push(valore);
                        });

                        // Riempi colonne vuote
                        const colonneUsate = config.campi.length;
                        for (let i = colonneUsate; i < maxColonne; i++) {
                            row.push('');
                            row.push('');
                        }

                        csv += row.join(',') + '\n';
                    }
                });
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const cliente = appState.rilievoData.clientData?.clientName || 'Cliente';
            const filename = `${cliente}_DettaglioPosa_${new Date().toISOString().split('T')[0]}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            console.log(`âœ… Export CSV dettaglio posa: ${filename}`);
        }

        // ============================================================================
        // NAVIGAZIONE POSIZIONI CANTIERE
        // ============================================================================
        function navigatePosaPosition(direction) {
            if (direction === 'prev' && posaState.currentPositionIndex > 0) {
                posaState.currentPositionIndex--;
                renderSchedaMontaggio();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } else if (direction === 'next' && posaState.currentPositionIndex < posaState.totalPositions - 1) {
                posaState.currentPositionIndex++;
                renderSchedaMontaggio();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        // ============================================================================
        // CHECKLIST PERSISTENCE (localStorage)
        // ============================================================================
        function toggleChecklistItem(itemId, checked) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                if (checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            }
            
            // Save state
            const checklistState = JSON.parse(localStorage.getItem('posa_checklist_state') || '{}');
            checklistState[itemId] = checked;
            localStorage.setItem('posa_checklist_state', JSON.stringify(checklistState));
        }

        function toggleFinalCheckItem(itemId, checked, positionId) {
            const item = document.getElementById(`item-${itemId}`);
            if (item) {
                if (checked) {
                    item.classList.add('checked');
                } else {
                    item.classList.remove('checked');
                }
            }
            
            // Save state
            const finalCheckState = JSON.parse(localStorage.getItem('posa_final_check_state') || '{}');
            if (!finalCheckState[positionId]) {
                finalCheckState[positionId] = {};
            }
            finalCheckState[positionId][itemId] = checked;
            localStorage.setItem('posa_final_check_state', JSON.stringify(finalCheckState));
        }

        function saveToolCheck(toolIndex, checked) {
            const toolsState = JSON.parse(localStorage.getItem('posa_tools_state') || '{}');
            toolsState[toolIndex] = checked;
            localStorage.setItem('posa_tools_state', JSON.stringify(toolsState));
        }

        function restoreChecklistState(positionId) {
            // Restore general checklist
            const checklistState = JSON.parse(localStorage.getItem('posa_checklist_state') || '{}');
            Object.keys(checklistState).forEach(itemId => {
                const checkbox = document.getElementById(itemId);
                const item = document.getElementById(`item-${itemId}`);
                if (checkbox) {
                    checkbox.checked = checklistState[itemId];
                    if (checklistState[itemId] && item) {
                        item.classList.add('checked');
                    }
                }
            });
            
            // Restore final checks for this position
            const finalCheckState = JSON.parse(localStorage.getItem('posa_final_check_state') || '{}');
            if (finalCheckState[positionId]) {
                Object.keys(finalCheckState[positionId]).forEach(itemId => {
                    const checkbox = document.getElementById(itemId);
                    const item = document.getElementById(`item-${itemId}`);
                    if (checkbox) {
                        checkbox.checked = finalCheckState[positionId][itemId];
                        if (finalCheckState[positionId][itemId] && item) {
                            item.classList.add('checked');
                        }
                    }
                });
            }
            
            // Restore tools
            const toolsState = JSON.parse(localStorage.getItem('posa_tools_state') || '{}');
            Object.keys(toolsState).forEach(toolIndex => {
                const checkbox = document.getElementById(`tool-${toolIndex}`);
                if (checkbox) {
                    checkbox.checked = toolsState[toolIndex];
                }
            });
        }

        function setupChecklistListeners() {
            // Restore checklist state on page load
            const checklistState = JSON.parse(localStorage.getItem('posa_checklist_state') || '{}');
            Object.keys(checklistState).forEach(itemId => {
                const checkbox = document.getElementById(itemId);
                const item = document.getElementById(`item-${itemId}`);
                if (checkbox) {
                    checkbox.checked = checklistState[itemId];
                    if (checklistState[itemId] && item) {
                        item.classList.add('checked');
                    }
                }
            });
            
            // Restore tools state
            const toolsState = JSON.parse(localStorage.getItem('posa_tools_state') || '{}');
            Object.keys(toolsState).forEach(toolIndex => {
                const checkbox = document.getElementById(`tool-${toolIndex}`);
                if (checkbox) {
                    checkbox.checked = toolsState[toolIndex];
                }
            });
        }

        // ============================================================================
        // FULLSCREEN TOGGLE
        // ============================================================================
        function togglePosaFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.log(`Error attempting to enable fullscreen: ${err.message}`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        // Initialize menu on load
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ¯ Initializing Advanced Menu...');
            renderAdvancedMenu();
            updateBreadcrumb('generale', 'dashboard');
            setupKeyboardShortcuts();
            console.log('âœ… Advanced Menu initialized');
            
            // ğŸ”„ FASE 027E: Auto-load progetti da GitHub
            initGitHubSync();
        });

        // ============================================
        // ğŸ”„ GITHUB READER MODULE - Dashboard v1.0
        // ============================================
        // Legge automaticamente progetti sincronizzati da GitHub
        
        const GITHUB_DASHBOARD_CONFIG = {
            enabled: true, // Abilita lettura automatica
            owner: 'Openporte2025',
            repo: 'dati-cantieri',
            branch: 'main',
            token: '', // âš ï¸ NON HARDCODARE MAI TOKEN QUI - Viene caricato da localStorage
            autoRefreshInterval: 60000, // 60 secondi
            lastSync: null
        };

        /**
         * Carica configurazione salvata
         */
        function loadGitHubConfig() {
            try {
                const saved = localStorage.getItem('github_dashboard_config');
                if (saved) {
                    const config = JSON.parse(saved);
                    GITHUB_DASHBOARD_CONFIG.owner = config.owner || GITHUB_DASHBOARD_CONFIG.owner;
                    GITHUB_DASHBOARD_CONFIG.repo = config.repo || GITHUB_DASHBOARD_CONFIG.repo;
                    GITHUB_DASHBOARD_CONFIG.branch = config.branch || GITHUB_DASHBOARD_CONFIG.branch;
                    console.log(`ğŸ“ Config caricata: ${GITHUB_DASHBOARD_CONFIG.owner}/${GITHUB_DASHBOARD_CONFIG.repo}`);
                }
            } catch (e) {
                console.log('â„¹ï¸ Nessuna config salvata, uso default');
            }
        }

        /**
         * Salva configurazione
         */
        function saveGitHubConfig() {
            const config = {
                owner: GITHUB_DASHBOARD_CONFIG.owner,
                repo: GITHUB_DASHBOARD_CONFIG.repo,
                branch: GITHUB_DASHBOARD_CONFIG.branch
            };
            localStorage.setItem('github_dashboard_config', JSON.stringify(config));
            console.log('ğŸ’¾ Config salvata');
        }

        /**
         * Inizializza sincronizzazione GitHub
         */
        async function initGitHubSync() {
            console.log('ğŸ”„ GitHub Reader Module - Initializing...');
            
            // Overlay Ã¨ giÃ  visibile all'avvio (HTML)
            const overlay = document.getElementById('initial-loading-overlay');
            
            try {
                // Carica configurazione salvata (owner/repo)
                loadGitHubConfig();
                
                // Carica token da localStorage (salvato in questa dashboard)
                try {
                    const savedToken = localStorage.getItem('github_dashboard_token');
                    if (savedToken) {
                        GITHUB_DASHBOARD_CONFIG.token = savedToken;
                        console.log('âœ… Token GitHub caricato da localStorage dashboard');
                    }
                } catch (e) {
                    console.log('â„¹ï¸ Nessun token salvato');
                }
                
                // Se non trovato, prova da app-rilievo
                if (!GITHUB_DASHBOARD_CONFIG.token) {
                    try {
                        const appData = localStorage.getItem('openPorteData');
                        if (appData) {
                            const parsed = JSON.parse(appData);
                            if (parsed.github?.token) {
                                GITHUB_DASHBOARD_CONFIG.token = parsed.github.token;
                                console.log('âœ… Token GitHub trovato da app-rilievo');
                            }
                        }
                    } catch (e) {
                        console.log('â„¹ï¸ Token non trovato in app-rilievo');
                    }
                }
                
                // âš ï¸ SE TOKEN NON TROVATO: Nascondi overlay e mostra form
                if (!GITHUB_DASHBOARD_CONFIG.token) {
                    console.log('âš ï¸ Token GitHub non trovato - Richiesta inserimento');
                    // Nascondi overlay immediatamente
                    if (overlay) {
                        overlay.classList.add('hidden');
                    }
                    // Mostra form inserimento token
                    showGitHubTokenForm();
                    return; // Esci - utente deve inserire token
                }
                
                // Carica progetti da GitHub (token presente)
                if (GITHUB_DASHBOARD_CONFIG.enabled) {
                    await loadProjectsFromGitHub();
                    
                    // Auto-refresh ogni minuto (solo se caricamento ha successo)
                    if (GITHUB_DASHBOARD_CONFIG.lastSync) {
                        setInterval(async () => {
                            console.log('ğŸ”„ Auto-refresh progetti da GitHub...');
                            await loadProjectsFromGitHub();
                        }, GITHUB_DASHBOARD_CONFIG.autoRefreshInterval);
                    }
                }
            } catch (error) {
                console.error('âŒ Errore inizializzazione GitHub:', error);
            } finally {
                // Nascondi overlay dopo caricamento (successo o errore)
                setTimeout(() => {
                    if (overlay) {
                        overlay.classList.add('hidden');
                        console.log('âœ… Overlay caricamento nascosto');
                    }
                }, 500); // Piccolo delay per UX migliore
            }
        }

        /**
         * Carica tutti i progetti dal repository GitHub
         */
        async function loadProjectsFromGitHub() {
            try {
                console.log('ğŸ“¡ Caricamento progetti da GitHub...');
                
                // Usa Git Tree API per ricerca ricorsiva in tutte le cartelle
                const url = `https://api.github.com/repos/${GITHUB_DASHBOARD_CONFIG.owner}/${GITHUB_DASHBOARD_CONFIG.repo}/git/trees/${GITHUB_DASHBOARD_CONFIG.branch}?recursive=1`;
                
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                // Aggiungi token se disponibile
                if (GITHUB_DASHBOARD_CONFIG.token) {
                    headers['Authorization'] = `token ${GITHUB_DASHBOARD_CONFIG.token}`;
                    console.log('ğŸ”‘ Token GitHub presente');
                } else {
                    console.log('âš ï¸ Nessun token - tentativo accesso pubblico');
                }
                
                const response = await fetch(url, { headers });
                
                // Gestione errori specifici
                if (response.status === 404) {
                    throw new Error('Repository non trovato. Verifica owner/repo.');
                }
                
                if (response.status === 401 || response.status === 403) {
                    console.error('âŒ Accesso negato - Repository privato o token non valido');
                    showGitHubTokenForm();
                    throw new Error('Repository privato - Inserisci token GitHub');
                }
                
                if (!response.ok) {
                    throw new Error(`GitHub API error: ${response.status} ${response.statusText}`);
                }
                
                const tree = await response.json();
                
                // Filtra file JSON progetto da TUTTE le sottocartelle
                const projectFiles = tree.tree
                    .filter(f => 
                        f.path.endsWith('.json') && 
                        f.type === 'blob' &&
                        f.path.includes('progetto-')
                    )
                    .map(f => ({
                        name: f.path.split('/').pop(),
                        path: f.path,
                        sha: f.sha,
                        download_url: `https://api.github.com/repos/${GITHUB_DASHBOARD_CONFIG.owner}/${GITHUB_DASHBOARD_CONFIG.repo}/contents/${f.path}?ref=${GITHUB_DASHBOARD_CONFIG.branch}`
                    }));
                
                console.log(`ğŸ“‚ Trovati ${projectFiles.length} progetti su GitHub`);
                console.log(`ğŸ“„ Path file trovati:`, projectFiles.map(f => f.path));
                
                if (projectFiles.length === 0) {
                    showGitHubStatus('info', 'Nessun progetto sincronizzato trovato');
                    return;
                }
                
                // Carica contenuto di ogni progetto
                const allProjects = [];
                for (const file of projectFiles) {
                    try {
                        const projectData = await loadGitHubFile(file.download_url);
                        if (projectData) {
                            allProjects.push({
                                filename: file.name,
                                data: projectData,
                                lastModified: file.sha
                            });
                        }
                    } catch (e) {
                        console.error(`âŒ Errore caricamento ${file.name}:`, e);
                    }
                }
                
                console.log(`âœ… Caricati ${allProjects.length} progetti con successo`);
                console.log(`ğŸ“Š Dati progetti:`, allProjects.map(p => ({
                    filename: p.filename,
                    id: p.data?.id,
                    projectName: p.data?.projectName,
                    customerName: p.data?.customerName
                })));
                
                // Aggiorna UI con progetti
                updateDashboardWithGitHubProjects(allProjects);
                
                GITHUB_DASHBOARD_CONFIG.lastSync = new Date().toISOString();
                showGitHubStatus('success', `${allProjects.length} progetti caricati da GitHub`);
                
            } catch (error) {
                console.error('âŒ Errore caricamento da GitHub:', error);
                showGitHubStatus('error', error.message || 'Errore connessione GitHub');
            }
        }

        /**
         * Mostra form per inserire token GitHub
         */
        function showGitHubTokenForm() {
            const existingForm = document.getElementById('github-token-modal');
            if (existingForm) return; // Form giÃ  presente
            
            const modal = document.createElement('div');
            modal.id = 'github-token-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
            `;
            
            modal.innerHTML = `
                <div style="background: white; border-radius: 16px; padding: 2rem; max-width: 600px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-height: 90vh; overflow-y: auto;">
                    <h2 style="margin: 0 0 1rem 0; color: #2d3748; font-size: 1.5rem;">
                        âš™ï¸ Configurazione GitHub
                    </h2>
                    
                    <p style="color: #718096; margin-bottom: 1.5rem; line-height: 1.6;">
                        Configura l'accesso al repository GitHub dove sono salvati i progetti sincronizzati.
                    </p>
                    
                    <!-- Repository Config -->
                    <div style="background: #f7fafc; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem;">
                        <h3 style="margin: 0 0 1rem 0; color: #4a5568; font-size: 1rem;">
                            ğŸ“¦ Repository
                        </h3>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600; font-size: 0.9rem;">
                                Owner (username o organization):
                            </label>
                            <input type="text" id="github-owner-input" 
                                   value="${GITHUB_DASHBOARD_CONFIG.owner}"
                                   placeholder="Openporte2025"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                        </div>
                        
                        <div style="margin-bottom: 1rem;">
                            <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600; font-size: 0.9rem;">
                                Repository name:
                            </label>
                            <input type="text" id="github-repo-input" 
                                   value="${GITHUB_DASHBOARD_CONFIG.repo}"
                                   placeholder="dati-cantieri"
                                   style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem;">
                        </div>
                        
                        <div style="color: #718096; font-size: 0.85rem; margin-top: 0.5rem;">
                            ğŸ’¡ URL completo: github.com/<span id="preview-owner">${GITHUB_DASHBOARD_CONFIG.owner}</span>/<span id="preview-repo">${GITHUB_DASHBOARD_CONFIG.repo}</span>
                        </div>
                    </div>
                    
                    <!-- Token Config -->
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; color: #4a5568; font-weight: 600;">
                            ğŸ”‘ Token GitHub (opzionale se repo pubblico):
                        </label>
                        <input type="password" id="github-token-input" 
                               placeholder="ghp_xxxxxxxxxxxxxxxxxxxx"
                               value="${GITHUB_DASHBOARD_CONFIG.token || ''}"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #e2e8f0; border-radius: 8px; font-size: 0.95rem; font-family: monospace;"
                               onkeypress="if(event.key==='Enter') saveGitHubConfigAndToken()">
                    </div>
                    
                    <div style="margin-bottom: 1.5rem;">
                        <a href="https://github.com/settings/tokens/new?scopes=repo&description=OpenPorte%20Dashboard" 
                           target="_blank"
                           style="color: #6366f1; text-decoration: none; font-size: 0.9rem;">
                            ğŸ“ Crea nuovo token su GitHub â†’
                        </a>
                    </div>
                    
                    <div style="display: flex; gap: 1rem; justify-content: flex-end;">
                        <button onclick="closeGitHubTokenForm()" 
                                style="padding: 0.75rem 1.5rem; background: #e2e8f0; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: #4a5568;">
                            Annulla
                        </button>
                        <button onclick="saveGitHubConfigAndToken()" 
                                style="padding: 0.75rem 1.5rem; background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); border: none; border-radius: 8px; cursor: pointer; font-weight: 600; color: white;">
                            ğŸ’¾ Salva e Carica
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Update preview on input
            const ownerInput = document.getElementById('github-owner-input');
            const repoInput = document.getElementById('github-repo-input');
            
            ownerInput.addEventListener('input', () => {
                document.getElementById('preview-owner').textContent = ownerInput.value || 'owner';
            });
            
            repoInput.addEventListener('input', () => {
                document.getElementById('preview-repo').textContent = repoInput.value || 'repo';
            });
            
            ownerInput.focus();
        }

        /**
         * Salva configurazione GitHub completa
         */
        function saveGitHubConfigAndToken() {
            const owner = document.getElementById('github-owner-input')?.value.trim();
            const repo = document.getElementById('github-repo-input')?.value.trim();
            const token = document.getElementById('github-token-input')?.value.trim();
            
            if (!owner || !repo) {
                showGitHubStatus('warning', 'Owner e Repository sono obbligatori');
                return;
            }
            
            // Aggiorna config
            GITHUB_DASHBOARD_CONFIG.owner = owner;
            GITHUB_DASHBOARD_CONFIG.repo = repo;
            if (token) {
                GITHUB_DASHBOARD_CONFIG.token = token;
            }
            
            // Salva in localStorage
            saveGitHubConfig();
            if (token) {
                localStorage.setItem('github_dashboard_token', token);
            }
            
            console.log(`âœ… Config salvata: ${owner}/${repo}`);
            
            // Chiudi form
            closeGitHubTokenForm();
            
            // Ricarica progetti
            showGitHubStatus('info', 'Caricamento progetti...');
            loadProjectsFromGitHub();
        }

        /**
         * Chiude form token
         */
        function closeGitHubTokenForm() {
            const modal = document.getElementById('github-token-modal');
            if (modal) {
                modal.remove();
            }
        }

        /**
         * Carica un singolo file da GitHub
         */
        async function loadGitHubFile(downloadUrl) {
            try {
                const headers = {
                    'Accept': 'application/vnd.github.v3+json'
                };
                
                // Aggiungi token se disponibile per repo privati
                if (GITHUB_DASHBOARD_CONFIG.token) {
                    headers['Authorization'] = `token ${GITHUB_DASHBOARD_CONFIG.token}`;
                }
                
                const response = await fetch(downloadUrl, { headers });
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                
                const data = await response.json();
                
                // L'API GitHub restituisce il contenuto in base64
                // Decodifica e parsifica JSON
                const content = atob(data.content.replace(/\n/g, ''));
                return JSON.parse(content);
            } catch (error) {
                console.error('Errore caricamento file:', error);
                return null;
            }
        }

        /**
         * Aggiorna dashboard con progetti da GitHub
         */
        function updateDashboardWithGitHubProjects(githubProjects) {
            if (githubProjects.length === 0) return;
            
            console.log('ğŸ”„ Aggiornamento dashboard con progetti GitHub...');
            console.log('ğŸ“Š Progetti ricevuti:', githubProjects);
            
            // Converte progetti GitHub nel formato della dashboard
            const projectsList = githubProjects.map(gp => {
                const data = gp.data;
                
                // Supporta sia formato vecchio che nuovo
                let id, projectName, customerName, ambiente, posizioni, metadata;
                
                if (data.rilievo) {
                    // NUOVO FORMATO (con struttura "rilievo")
                    id = data.rilievo.meta?.id_rilievo;
                    customerName = data.rilievo.cliente?.nome || data.rilievo.cliente?.ragione_sociale || 'Cliente Senza Nome';
                    projectName = customerName; // Usa sempre il nome cliente
                    ambiente = data.rilievo.cantiere?.indirizzo || data.rilievo.cantiere?.cittÃ  || 'N/D';
                    posizioni = data.rilievo.misure?.length || 0;
                    metadata = {
                        lastModified: data.rilievo.meta?.data_modifica || data.rilievo.meta?.data_creazione
                    };
                } else {
                    // VECCHIO FORMATO (formato app-rilievo)
                    id = data.id;
                    customerName = data.name || data.client || data.customerName || data.cliente?.nome || data.clientData?.nome || 'Cliente Senza Nome';
                    projectName = customerName;
                    ambiente = data.currentEnvironment || 'N/D';
                    posizioni = data.positions?.length || data.project?.rilievoInfissi?.length || 0;
                    metadata = data.metadata;
                }
                
                console.log('ğŸ” Mapping progetto:', {
                    filename: gp.filename,
                    formato: data.rilievo ? 'NUOVO' : 'VECCHIO',
                    id: id,
                    projectName: projectName,
                    customerName: customerName,
                    posizioni: posizioni
                });
                
                // Estrai informazioni progetto
                return {
                    id: id || gp.filename,
                    nome: customerName || projectName || 'Progetto Senza Nome',
                    cliente: customerName,
                    ambiente: ambiente,
                    dataModifica: new Date(metadata?.lastModified || Date.now()).toLocaleDateString('it-IT'),
                    posizioni: posizioni,
                    completamento: calcolaCompletamentoProgetto(data),
                    source: 'github',
                    rawData: data
                };
            });
            
            // Salva in una variabile globale per accesso rapido
            window.githubProjects = projectsList;
            
            // ğŸ†• Popola menu laterale con progetti
            updateSidebarMenu(projectsList);
            
            // Se siamo nella vista lista progetti, aggiorna
            if (window.location.hash === '#progetti' || !window.location.hash) {
                renderProjectsList(projectsList);
            }
            
            console.log(`âœ… Dashboard aggiornata con ${projectsList.length} progetti`);
        }

        /**
         * Calcola completamento progetto
         */
        function calcolaCompletamentoProgetto(data) {
            let score = 0;
            let total = 0;
            
            // Cliente (25%)
            total += 25;
            if (data.customerName) score += 10;
            if (data.customerPhone) score += 5;
            if (data.customerEmail) score += 5;
            if (data.customerAddress) score += 5;
            
            // Setup (25%)
            total += 25;
            const hasProdotti = data.project?.hasInfissi || data.project?.hasPersiane || 
                               data.project?.hasTapparelle || data.project?.hasZanzariere;
            if (hasProdotti) score += 25;
            
            // Posizioni (50%)
            total += 50;
            const posizioni = data.project?.rilievoInfissi?.length || 0;
            if (posizioni > 0) {
                score += Math.min(50, posizioni * 10);
            }
            
            return Math.round((score / total) * 100);
        }

        /**
         * Renderizza lista progetti
         */
        function renderProjectsList(projects) {
            const container = document.getElementById('progetti-list-container');
            const card = document.getElementById('githubProjectsCard');
            
            if (!container) return;
            
            // Mostra card se ci sono progetti
            if (card) {
                card.style.display = projects.length > 0 ? 'block' : 'none';
            }
            
            if (projects.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; color: #718096;">
                        Nessun progetto sincronizzato trovato su GitHub
                    </div>
                `;
                return;
            }
            
            let html = `
                <div style="padding: 1rem 0;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;">
            `;
            
            projects.forEach(p => {
                const completamentoColor = p.completamento >= 80 ? '#10b981' : 
                                          p.completamento >= 50 ? '#f59e0b' : '#ef4444';
                
                html += `
                    <div style="background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%); border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 8px rgba(0,0,0,0.1); cursor: pointer; transition: all 0.2s; border: 2px solid transparent;" 
                         onclick="loadGitHubProject('${p.id}')"
                         onmouseover="this.style.transform='translateY(-4px)'; this.style.borderColor='#6366f1'; this.style.boxShadow='0 8px 16px rgba(99, 102, 241, 0.2)'"
                         onmouseout="this.style.transform='translateY(0)'; this.style.borderColor='transparent'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                        
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                            <h3 style="font-size: 1.1rem; color: #2d3748; margin: 0; font-weight: 700;">${p.nome}</h3>
                            <span style="background: ${completamentoColor}; color: white; padding: 0.25rem 0.75rem; border-radius: 20px; font-size: 0.85rem; font-weight: 700;">
                                ${p.completamento}%
                            </span>
                        </div>
                        
                        <div style="color: #4a5568; font-size: 0.95rem; margin-bottom: 0.5rem; font-weight: 500;">
                            ğŸ‘¤ ${p.cliente}
                        </div>
                        
                        <div style="color: #718096; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            ğŸ  ${p.ambiente}
                        </div>
                        
                        <div style="color: #718096; font-size: 0.9rem; margin-bottom: 0.5rem;">
                            ğŸ“ ${p.posizioni} posizion${p.posizioni !== 1 ? 'i' : 'e'}
                        </div>
                        
                        <div style="color: #a0aec0; font-size: 0.85rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                            <span>ğŸ“… ${p.dataModifica}</span>
                            <span style="background: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%); color: white; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.75rem; font-weight: 600;">GitHub</span>
                        </div>
                    </div>
                `;
            });
            
            html += `
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }

        /**
         * Carica progetto specifico da GitHub
         */
        /**
         * Converte formato GitHub nel formato compatibile con la dashboard
         */
        function convertGitHubToDashboardFormat(githubData) {
            console.log('ğŸ”„ Conversione formato GitHub â†’ Dashboard');
            console.log('ğŸ“¦ Dati ricevuti:', githubData);
            console.log('ğŸ” Campi disponibili:', Object.keys(githubData));
            
            // Se giÃ  ha il campo "posizioni", ritorna cosÃ¬ com'Ã¨
            if (githubData.posizioni && Array.isArray(githubData.posizioni)) {
                console.log('âœ… Formato giÃ  corretto con posizioni array');
                return githubData;
            }
            
            // FORMATO 1: data.rilievo.misure â†’ data.posizioni
            if (githubData.rilievo?.misure) {
                console.log('âœ… Formato NUOVO riconosciuto (rilievo.misure)');
                console.log('ğŸ“Š Numero posizioni:', githubData.rilievo.misure.length);
                return {
                    ...githubData,
                    posizioni: githubData.rilievo.misure,
                    nome: githubData.rilievo.cliente?.nome || githubData.rilievo.cliente?.ragione_sociale || 'Progetto',
                    nome_ricerca: githubData.rilievo.meta?.nome_progetto || githubData.rilievo.cliente?.nome || 'N/D',
                    cliente: {
                        nome: githubData.rilievo.cliente?.nome || githubData.rilievo.cliente?.ragione_sociale || 'N/D',
                        cognome: githubData.rilievo.cliente?.cognome || '',
                        progetto: githubData.rilievo.meta?.nome_progetto || githubData.rilievo.cliente?.nome || 'N/D',
                        piano: githubData.rilievo.cantiere?.piano || '',
                        indirizzo: githubData.rilievo.cantiere?.indirizzo || '',
                        via: githubData.rilievo.cantiere?.via || '',
                        citta: githubData.rilievo.cantiere?.cittÃ  || githubData.rilievo.cantiere?.citta || '',
                        telefono: githubData.rilievo.cliente?.telefono || '',
                        email: githubData.rilievo.cliente?.email || ''
                    },
                    data_rilievo: githubData.rilievo.meta?.data_creazione || Date.now(),
                    project: githubData.rilievo
                };
            }
            
            // FORMATO 2: data.project.rilievoInfissi â†’ data.posizioni
            if (githubData.project?.rilievoInfissi && Array.isArray(githubData.project.rilievoInfissi)) {
                console.log('âœ… Formato VECCHIO riconosciuto (project.rilievoInfissi)');
                console.log('ğŸ“Š Numero posizioni:', githubData.project.rilievoInfissi.length);
                
                // Normalizza ogni posizione
                const posizioniNormalizzate = githubData.project.rilievoInfissi.map(pos => {
                    const normalized = { ...pos };
                    
                    // Normalizza infisso
                    if (pos.infisso) {
                        normalized.infisso = {
                            ...pos.infisso,
                            quantita: parseInt(pos.infisso.qta) || 0,
                            azienda: pos.infisso.azienda || 'Non specificata',
                            brm: {
                                L: pos.infisso.BRM_L || 0,
                                H: pos.infisso.BRM_H || 0
                            },
                            finitura_int: pos.infisso.finituraInt,
                            finitura_est: pos.infisso.finituraEst,
                            colore_int: pos.infisso.coloreInt,
                            colore_est: pos.infisso.coloreEst
                        };
                    }
                    
                    // Normalizza persiana
                    if (pos.persiana) {
                        normalized.persiana = {
                            ...pos.persiana,
                            quantita: parseInt(pos.persiana.qta) || 0,
                            azienda: pos.persiana.azienda || 'Non specificata',
                            modello: pos.persiana.modello || pos.persiana.tipo,
                            brm: {
                                L: pos.persiana.BRM_L || 0,
                                H: pos.persiana.BRM_H || 0
                            },
                            colore: pos.persiana.colorePersiana || pos.persiana.colore
                        };
                    }
                    
                    // Normalizza zanzariera
                    if (pos.zanzariera) {
                        normalized.zanzariera = {
                            ...pos.zanzariera,
                            quantita: parseInt(pos.zanzariera.qta) || 0,
                            azienda: pos.zanzariera.azienda || 'Non specificata',
                            modello: pos.zanzariera.modello || pos.zanzariera.tipo,
                            brm: {
                                L: pos.zanzariera.BRM_L || 0,
                                H: pos.zanzariera.BRM_H || 0
                            },
                            colore: pos.zanzariera.coloreTelaio
                        };
                    }
                    
                    // Normalizza tapparella
                    if (pos.tapparella) {
                        normalized.tapparella = {
                            ...pos.tapparella,
                            quantita: parseInt(pos.tapparella.qta) || 0,
                            azienda: pos.tapparella.azienda || 'Non specificata',
                            brm: {
                                L: pos.tapparella.BRM_L || 0,
                                H: pos.tapparella.BRM_H || 0
                            }
                        };
                    }
                    
                    // Normalizza cassonetto
                    if (pos.cassonetto) {
                        normalized.cassonetto = {
                            ...pos.cassonetto,
                            quantita: parseInt(pos.cassonetto.qta) || 0,
                            azienda: pos.cassonetto.azienda || 'Non specificata',
                            brm: {
                                L: pos.cassonetto.BRM_L || 0,
                                H: pos.cassonetto.BRM_H || 0
                            }
                        };
                    }
                    
                    return normalized;
                });
                
                return {
                    ...githubData,
                    posizioni: posizioniNormalizzate,
                    nome: githubData.projectName || githubData.customerName || 'Progetto',
                    nome_ricerca: githubData.projectName || githubData.customerName || 'N/D',
                    cliente: githubData.clientData || {
                        nome: githubData.customerName || 'N/D',
                        cognome: '',
                        progetto: githubData.projectName || githubData.customerName || 'N/D',
                        piano: githubData.piano || '',
                        indirizzo: githubData.indirizzo || '',
                        via: githubData.via || '',
                        citta: githubData.citta || '',
                        telefono: githubData.customerPhone || '',
                        email: githubData.customerEmail || ''
                    },
                    data_rilievo: githubData.metadata?.created || Date.now()
                };
            }
            
            // FORMATO 3: Formato openporte-v4_5 (positions array)
            if (githubData.positions && Array.isArray(githubData.positions)) {
                console.log('âœ… Formato OPENPORTE riconosciuto (positions)');
                console.log('ğŸ“Š Numero posizioni:', githubData.positions.length);
                
                // âœ… Normalizza ogni posizione con conversione prodotti
                const posizioniNormalizzate = githubData.positions.map((posGitHub, index) => {
                    const posDash = {
                        id: posGitHub.id || `pos-${index}`,
                        nome: posGitHub.name || `Posizione ${index + 1}`,
                        ambiente: posGitHub.ambiente || '',
                        quantita: parseInt(posGitHub.quantita || 1),
                        misure: {}
                    };
                    
                    // âœ… Converti misure (mantieni valori semplici!)
                    // Copia direttamente le misure senza trasformarle in oggetti
                    if (posGitHub.misure) {
                        posDash.misure = { ...posGitHub.misure };
                    }
                    
                    // âš ï¸ FIX CRITICO: Converti prodotti con qtaâ†’quantita e BRM
                    ['infisso', 'tapparella', 'persiana', 'zanzariera', 'cassonetto'].forEach(tipoProdotto => {
                        if (posGitHub[tipoProdotto]) {
                            const prodGitHub = posGitHub[tipoProdotto];
                            
                            // Inizializza prodotto copiando tutti i campi
                            posDash[tipoProdotto] = { ...prodGitHub };
                            
                            // âœ… FIX 1: Converti qta â†’ quantita (numero)
                            posDash[tipoProdotto].quantita = parseInt(prodGitHub.qta || prodGitHub.quantita || 0);
                            
                            // âœ… FIX 2: Gestione BRM intelligente
                            const hasBRM = prodGitHub.BRM_L && prodGitHub.BRM_H && 
                                          prodGitHub.BRM_L !== null && prodGitHub.BRM_H !== null &&
                                          parseInt(prodGitHub.BRM_L) > 0 && parseInt(prodGitHub.BRM_H) > 0;
                            
                            if (hasBRM) {
                                // BRM presente: converti formato BRM_L/BRM_H â†’ brm.L/brm.H
                                posDash[tipoProdotto].brm = {
                                    L: parseInt(prodGitHub.BRM_L),
                                    H: parseInt(prodGitHub.BRM_H)
                                };
                                console.log(`âœ… ${tipoProdotto} Pos ${index + 1}: BRM da GitHub ${posDash[tipoProdotto].brm.L}Ã—${posDash[tipoProdotto].brm.H}`);
                            } else {
                                // BRM mancante: usa LF o default
                                if (posDash.misure && posDash.misure.LF && posDash.misure.LF.L > 0) {
                                    posDash[tipoProdotto].brm = {
                                        L: posDash.misure.LF.L,
                                        H: posDash.misure.LF.H
                                    };
                                    console.log(`âœ… ${tipoProdotto} Pos ${index + 1}: BRM calcolato da LF ${posDash[tipoProdotto].brm.L}Ã—${posDash[tipoProdotto].brm.H}`);
                                } else {
                                    // Default ragionevole
                                    posDash[tipoProdotto].brm = {
                                        L: 1000,
                                        H: 1200
                                    };
                                    console.warn(`âš ï¸ ${tipoProdotto} Pos ${index + 1}: BRM default usato 1000Ã—1200`);
                                }
                            }
                            
                            // Rimuovi campi obsoleti
                            delete posDash[tipoProdotto].qta;
                            delete posDash[tipoProdotto].BRM_L;
                            delete posDash[tipoProdotto].BRM_H;
                        }
                    });
                    
                    return posDash;
                });
                
                return {
                    ...githubData,
                    posizioni: posizioniNormalizzate,
                    nome: githubData.name || githubData.projectName || 'Progetto',
                    nome_ricerca: githubData.projectName || githubData.name || 'N/D',
                    cliente: githubData.clientData || {
                        nome: githubData.client || githubData.customerName || 'N/D',
                        cognome: '',
                        progetto: githubData.projectName || githubData.name || 'N/D',
                        piano: githubData.piano || '',
                        indirizzo: githubData.indirizzo || '',
                        via: githubData.via || '',
                        citta: githubData.citta || '',
                        telefono: githubData.customerPhone || '',
                        email: githubData.customerEmail || ''
                    },
                    data_rilievo: githubData.created || Date.now()
                };
            }
            
            // Formato sconosciuto - crea struttura minima con posizioni vuoto
            console.error('âš ï¸ Formato dati non riconosciuto:', githubData);
            console.error('ğŸ“‹ Campi root disponibili:', Object.keys(githubData));
            console.error('ğŸ’¡ Suggerimento: controlla la struttura del JSON salvato su GitHub');
            
            return {
                ...githubData,
                posizioni: [], // âœ… Garantisci array vuoto invece di undefined
                nome: githubData.name || githubData.projectName || githubData.customerName || 'Progetto Sconosciuto',
                nome_ricerca: githubData.projectName || githubData.name || 'N/D',
                cliente: githubData.clientData || githubData.cliente || { 
                    nome: githubData.customerName || githubData.client || 'N/D',
                    cognome: '',
                    progetto: githubData.projectName || githubData.name || 'N/D',
                    piano: githubData.piano || '',
                    indirizzo: githubData.indirizzo || '',
                    via: githubData.via || '',
                    citta: githubData.citta || '',
                    telefono: githubData.customerPhone || '',
                    email: githubData.customerEmail || ''
                },
                data_rilievo: Date.now()
            };
        }

        function loadGitHubProject(projectId) {
            const project = window.githubProjects?.find(p => p.id === projectId);
            if (!project) {
                showAlert('error', 'Progetto non trovato');
                return;
            }
            
            console.log('ğŸ“‚ Caricamento progetto:', project.nome);
            
            // âœ… CONVERTI formato GitHub â†’ formato Dashboard
            const dashboardData = convertGitHubToDashboardFormat(project.rawData);
            
            // Usa la funzione esistente della dashboard per caricare i dati
            processRilievoData(dashboardData, `${project.nome}.json`);
            
            // âœ… PASSA AUTOMATICAMENTE AL BLOCCO UFFICIO
            switchBlocco('ufficio');
            
            showAlert('success', `Progetto "${project.nome}" caricato da GitHub!`);
        }

        /**
         * Mostra stato sincronizzazione GitHub
         */
        function showGitHubStatus(type, message) {
            // Crea badge di stato se non esiste
            let badge = document.getElementById('github-status-badge');
            if (!badge) {
                badge = document.createElement('div');
                badge.id = 'github-status-badge';
                badge.style.cssText = `
                    position: fixed;
                    top: 80px;
                    right: 20px;
                    padding: 0.75rem 1rem;
                    border-radius: 8px;
                    font-size: 0.9rem;
                    font-weight: 600;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                    z-index: 9999;
                    transition: all 0.3s;
                    opacity: 0;
                `;
                document.body.appendChild(badge);
            }
            
            // Colori per tipo
            const colors = {
                success: 'linear-gradient(135deg, #10b981 0%, #059669 100%)',
                error: 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)',
                info: 'linear-gradient(135deg, #3b82f6 0%, #2563eb 100%)',
                warning: 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)'
            };
            
            const icons = {
                success: 'âœ…',
                error: 'âŒ',
                info: 'â„¹ï¸',
                warning: 'âš ï¸'
            };
            
            badge.style.background = colors[type] || colors.info;
            badge.style.color = 'white';
            badge.innerHTML = `${icons[type] || 'â„¹ï¸'} ${message}`;
            badge.style.opacity = '1';
            
            // Nascondi dopo 5 secondi
            setTimeout(() => {
                badge.style.opacity = '0';
            }, 5000);
        }

        console.log('ğŸ”„ GitHub Reader Module loaded');

        // ============================================================================
        // SISTEMA PREVENTIVAZIONE
        // ============================================================================
        
        /**
         * Apre il wizard preventivo con analisi intelligente
         */
        function apriPreventivo() {
            console.log('ğŸ’° Apertura preventivo...');
            
            if (!window.PreventivoUI) {
                console.error('âŒ PreventivoUI non caricato!');
                alert('Errore: modulo preventivo non disponibile');
                return;
            }
            
            if (!window.currentData) {
                alert('âš ï¸ Nessun progetto caricato. Carica prima un rilievo.');
                return;
            }
            
            // Analizza dati e apre wizard se necessario
            window.WizardCompletamento.avviaAnalisi();
        }
        
        console.log('âœ… Sistema Preventivazione initialized');

    </script>

    <!-- Moduli Sistema Menu Avanzato (opzionali) -->
    <!-- <script src="completion-tracker.js"></script> -->
    <!-- <script src="badge-renderer.js"></script> -->
    
    <!-- Stub per compatibilitÃ  se moduli esterni non disponibili -->
    <script>
        if (!window.CompletionTracker) {
            window.CompletionTracker = {
                updateMenuStatus: function() {
                    console.log('âš ï¸ CompletionTracker stub - funzione non implementata');
                }
            };
        }
        
        if (!window.BadgeRenderer) {
            window.BadgeRenderer = {
                getBadgeHTML: function() { return ''; },
                renderMiniProgressBar: function() { return ''; }
            };
        }
    </script>
    
    <!-- SISTEMA PREVENTIVI - INLINE -->
    <script>
        // ============================================================================
        // PREVENTIVO CALCULATOR - Sistema di calcolo preventivi
        // ============================================================================
        window.PreventivoCalculator = {
            
            // Listini fornitori (caricati dinamicamente)
            listini: {
                finstral: null,
                palagina: null,
                persiane: null
            },
            
            // LISTINO FINSTRAL PREZZI MEDI
            listino_finstral: {
                telai: {
                    "961": { nome: "Base 961", pvc_pvc: 0, pvc_alluminio: 25.0 },
                    "965": { nome: "965 Ribassato", pvc_pvc: 8.0, pvc_alluminio: 30.0 },
                    "967": { nome: "967 Forma Z", pvc_pvc: 10.9, pvc_alluminio: 35.0 },
                    "Z62": { nome: "Z62 Compatto", pvc_pvc: 5.21, pvc_alluminio: 28.0 },
                    "Z91": { nome: "Z91 Rinforzato", pvc_pvc: 16.1, pvc_alluminio: 38.0 },
                    "962": { nome: "962 Intermedio", pvc_pvc: 17.0, pvc_alluminio: 32.0 },
                    "924": { nome: "924 Leggero", pvc_pvc: 18.0, pvc_alluminio: 33.0 },
                    "951": { nome: "951 Rinforzato", pvc_pvc: 22.5, pvc_alluminio: 40.0 }
                },
                ante: {
                    "classic-line": { nome: "Classic-line", codice: "973", pvc_pvc: 180, pvc_alluminio: 220 },
                    "step-line": { nome: "Step-line", codice: "974", pvc_pvc: 190, pvc_alluminio: 230 },
                    "nova-line": { nome: "Nova-line", pvc_pvc: 200, pvc_alluminio: 250 },
                    "slim-line": { nome: "Slim-line", pvc_pvc: 195, pvc_alluminio: 240 }
                },
                vetri: {
                    "doppio": { nome: "Doppio", prezzo: 45 },
                    "doppio-sat": { nome: "Doppio Satinato", prezzo: 55 },
                    "triplo": { nome: "Triplo", prezzo: 65 },
                    "triplo-sat": { nome: "Triplo Satinato", prezzo: 75 }
                }
            },
            
            // Configurazione prezzi base
            config: {
                iva: 0.22,
                margine_default: 1.30,
                costo_posa_mq: 85.00,
                costo_smontaggio: 45.00
            },
            
            /**
             * Calcola preventivo completo per un progetto
             */
            calcolaPreventivo(datiProgetto) {
                console.log('ğŸ’° Calcolo preventivo per:', datiProgetto.nome);
                
                const risultato = {
                    successo: true,
                    progetto: datiProgetto.nome || 'Progetto',
                    cliente: datiProgetto.cliente || {},
                    timestamp: new Date().toISOString(),
                    voci: [],
                    totali: {
                        materiali: 0,
                        posa: 0,
                        smontaggio: 0,
                        subtotale: 0,
                        iva: 0,
                        totale: 0
                    },
                    warnings: []
                };
                
                // Analizza ogni posizione
                const posizioni = datiProgetto.posizioni || [];
                
                posizioni.forEach((pos, idx) => {
                    // INFISSI
                    if (pos.infisso && pos.infisso.quantita > 0) {
                        const voce = this.calcolaVoceInfisso(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                            risultato.totali.posa += parseFloat(voce.costo_posa || 0);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // ZANZARIERE
                    if (pos.zanzariera && pos.zanzariera.quantita > 0) {
                        const voce = this.calcolaVoceZanzariera(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // PERSIANE
                    if (pos.persiana && pos.persiana.quantita > 0) {
                        const voce = this.calcolaVocePersiana(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                            risultato.totali.posa += parseFloat(voce.costo_posa || 0);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // TAPPARELLE
                    if (pos.tapparella && pos.tapparella.quantita > 0) {
                        const voce = this.calcolaVoceTapparella(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                    
                    // CASSONETTI
                    if (pos.cassonetto && pos.cassonetto.quantita > 0) {
                        const voce = this.calcolaVoceCassonetto(pos, idx + 1);
                        if (voce.successo) {
                            risultato.voci.push(voce);
                            risultato.totali.materiali += parseFloat(voce.importo);
                        } else {
                            risultato.warnings.push(voce.errore);
                        }
                    }
                });
                
                // Calcola totali
                risultato.totali.smontaggio = posizioni.length * this.config.costo_smontaggio;
                risultato.totali.subtotale = risultato.totali.materiali + 
                                             risultato.totali.posa + 
                                             risultato.totali.smontaggio;
                risultato.totali.iva = risultato.totali.subtotale * this.config.iva;
                risultato.totali.totale = risultato.totali.subtotale + risultato.totali.iva;
                
                // Arrotonda tutti i totali
                Object.keys(risultato.totali).forEach(key => {
                    risultato.totali[key] = parseFloat(risultato.totali[key].toFixed(2));
                });
                
                console.log('âœ… Preventivo calcolato:', risultato.totali);
                
                return risultato;
            },
            
            /**
             * Calcola voce infisso
             */
            calcolaVoceInfisso(posizione, numero) {
                const infisso = posizione.infisso;
                
                // ğŸ”§ COMPATIBILITÃ€ RETROATTIVA: Supporta sia brm.L che BRM_L
                const L = infisso.brm?.L || infisso.BRM_L || 0;
                const H = infisso.brm?.H || infisso.BRM_H || 0;
                
                // Validazione dati base
                if (!L || !H) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per infisso`
                    };
                }
                
                // Calcoli base (L e H giÃ  definiti sopra)
                const perimetro = 2 * (L + H) / 1000; // metri lineari
                const superficie = (L * H) / 1000000; // mq
                
                let prezzo_totale = 0;
                let dettaglio = [];
                
                // CALCOLO FINSTRAL CON FORMULA AVANZATA
                if (infisso.azienda && infisso.azienda.toLowerCase().includes('finstral')) {
                    
                    // DETERMINA MATERIALE da finituraEst (o finituraInt come fallback)
                    const finitura = infisso.finituraEst || infisso.finituraInt || '';
                    const isMaterialePVC = !finitura.toLowerCase().includes('alluminio');
                    
                    // 1. PREZZO BASE (tipo 101 finestra o tipo 401 porta-finestra)
                    const isPortaFinestra = infisso.tipo && (
                        infisso.tipo.toLowerCase().includes('pf') || 
                        infisso.tipo.toLowerCase().includes('porta') ||
                        H > 1800
                    );
                    
                    let prezzo_base = 0;
                    if (isPortaFinestra) {
                        // Tipo 401: ~220â‚¬/mq + 200â‚¬ fisso
                        prezzo_base = (superficie * 220) + 200;
                        dettaglio.push(`Base Porta-finestra (tipo 401): ${prezzo_base.toFixed(0)}â‚¬`);
                    } else {
                        // Tipo 101: ~180â‚¬/mq + 100â‚¬ fisso
                        prezzo_base = (superficie * 180) + 100;
                        dettaglio.push(`Base Finestra (tipo 101): ${prezzo_base.toFixed(0)}â‚¬`);
                    }
                    
                    prezzo_totale += prezzo_base;
                    
                    // 2. SUPPLEMENTO TELAIO (se diverso da 961 base)
                    if (infisso.telaio && infisso.telaio !== '961') {
                        const supplementi_telaio = {
                            '965': { pvc_pvc: 8.0, pvc_alluminio: 30.0 },
                            '967': { pvc_pvc: 10.9, pvc_alluminio: 35.0 },
                            'Z62': { pvc_pvc: 5.21, pvc_alluminio: 28.0 },
                            'Z91': { pvc_pvc: 16.1, pvc_alluminio: 38.0 },
                            '962': { pvc_pvc: 17.0, pvc_alluminio: 32.0 },
                            '924': { pvc_pvc: 18.0, pvc_alluminio: 33.0 },
                            '951': { pvc_pvc: 22.5, pvc_alluminio: 40.0 }
                        };
                        
                        const supp_telaio = supplementi_telaio[infisso.telaio];
                        if (supp_telaio) {
                            const prezzo_ml = isMaterialePVC ? supp_telaio.pvc_pvc : supp_telaio.pvc_alluminio;
                            const costo = perimetro * prezzo_ml;
                            
                            prezzo_totale += costo;
                            const materiale_label = isMaterialePVC ? 'PVC/PVC' : 'PVC/Alu';
                            dettaglio.push(`Supp.Tel.${infisso.telaio}(${materiale_label}): +${costo.toFixed(0)}â‚¬`);
                        }
                    }
                    
                    // 3. SUPPLEMENTO MATERIALE (Alluminio su telaio base 961)
                    if (!isMaterialePVC && (!infisso.telaio || infisso.telaio === '961')) {
                        const costo = perimetro * 25;
                        prezzo_totale += costo;
                        dettaglio.push(`Rivestimento Alluminio: +${costo.toFixed(0)}â‚¬`);
                    }
                    
                    // 4. SUPPLEMENTO ANTA (se diversa da Classic/Step-line base)
                    if (infisso.tipoAnta && 
                        !['classic-line', 'step-line'].includes(infisso.tipoAnta.toLowerCase())) {
                        const supplementi_anta = {
                            'nova-line': { pvc_pvc: 20, pvc_alluminio: 30 },
                            'slim-line': { pvc_pvc: 15, pvc_alluminio: 20 }
                        };
                        
                        const supp_anta = supplementi_anta[infisso.tipoAnta.toLowerCase()];
                        if (supp_anta) {
                            const prezzo_mq = isMaterialePVC ? supp_anta.pvc_pvc : supp_anta.pvc_alluminio;
                            const costo = superficie * prezzo_mq;
                            
                            prezzo_totale += costo;
                            dettaglio.push(`Supp.Anta ${infisso.tipoAnta}: +${costo.toFixed(0)}â‚¬`);
                        }
                    }
                    
                    // 5. SUPPLEMENTO VETRO (se diverso da doppio standard)
                    if (infisso.vetro && infisso.vetro !== 'doppio') {
                        const supplementi_vetro = {
                            'doppio-sat': 10,
                            'triplo': 20,
                            'triplo-sat': 30
                        };
                        
                        const supp_vetro_mq = supplementi_vetro[infisso.vetro.toLowerCase()];
                        if (supp_vetro_mq) {
                            const costo = superficie * supp_vetro_mq;
                            prezzo_totale += costo;
                            dettaglio.push(`Supp.Vetro ${infisso.vetro}: +${costo.toFixed(0)}â‚¬`);
                        }
                    }
                    
                } else {
                    // CALCOLO STANDARD NON-FINSTRAL
                    prezzo_totale = superficie * 450;
                    dettaglio.push('Calcolo standard');
                }
                
                // POSA
                const costo_posa = superficie * this.config.costo_posa_mq * infisso.quantita;
                const importo_totale = prezzo_totale * infisso.quantita;
                
                return {
                    successo: true,
                    tipo: 'Infisso',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: `${infisso.azienda || 'Infisso'} - ${infisso.tipo || ''} ${infisso.telaio || ''}`,
                    quantita: infisso.quantita,
                    misure: `${L}Ã—${H} mm`,  // Usa variabili uniformate
                    perimetro_ml: perimetro.toFixed(2),
                    superficie_mq: superficie.toFixed(2),
                    prezzo_unitario: prezzo_totale.toFixed(2),
                    importo: importo_totale.toFixed(2),
                    costo_posa: costo_posa.toFixed(2),
                    dettaglio_calcolo: dettaglio.join(' | '),
                    note: infisso.note || ''
                };
            },
            
            /**
             * Calcola voce zanzariera
             */
            calcolaVoceZanzariera(posizione, numero) {
                const zanzariera = posizione.zanzariera;
                
                if (!zanzariera.brm || !zanzariera.brm.L || !zanzariera.brm.H) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per zanzariera`
                    };
                }
                
                const superficie_mq = (zanzariera.brm.L * zanzariera.brm.H) / 1000000;
                
                const prezzi_base = {
                    'plisse': 120,
                    'avvolgibile': 95,
                    'battente': 85,
                    'scorrevole': 110
                };
                
                const tipo_lower = (zanzariera.tipo || zanzariera.modello || '').toLowerCase();
                let prezzo_mq = 100;
                
                for (const [key, value] of Object.entries(prezzi_base)) {
                    if (tipo_lower.includes(key)) {
                        prezzo_mq = value;
                        break;
                    }
                }
                
                const prezzo_unitario = superficie_mq * prezzo_mq;
                const importo = prezzo_unitario * zanzariera.quantita;
                
                return {
                    successo: true,
                    tipo: 'Zanzariera',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: zanzariera.tipo || zanzariera.modello || 'Zanzariera',
                    quantita: zanzariera.quantita,
                    misure: `${zanzariera.brm.L}Ã—${zanzariera.brm.H} mm`,
                    superficie_mq: superficie_mq.toFixed(2),
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2)
                };
            },
            
            /**
             * Calcola voce persiana
             */
            calcolaVocePersiana(posizione, numero) {
                const persiana = posizione.persiana;
                
                if (!persiana.brm || !persiana.brm.L || !persiana.brm.H) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per persiana`
                    };
                }
                
                const superficie_mq = (persiana.brm.L * persiana.brm.H) / 1000000;
                const prezzo_mq = 180;
                const prezzo_unitario = superficie_mq * prezzo_mq;
                const costo_posa = superficie_mq * 45 * persiana.quantita;
                const importo = prezzo_unitario * persiana.quantita;
                
                return {
                    successo: true,
                    tipo: 'Persiana',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: persiana.tipo || 'Persiana',
                    quantita: persiana.quantita,
                    misure: `${persiana.brm.L}Ã—${persiana.brm.H} mm`,
                    superficie_mq: superficie_mq.toFixed(2),
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2),
                    costo_posa: costo_posa.toFixed(2)
                };
            },
            
            /**
             * Calcola voce tapparella
             */
            calcolaVoceTapparella(posizione, numero) {
                const tapparella = posizione.tapparella;
                
                if (!tapparella.brm || !tapparella.brm.L || !tapparella.brm.H) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure BRM per tapparella`
                    };
                }
                
                const superficie_mq = (tapparella.brm.L * tapparella.brm.H) / 1000000;
                const prezzo_base = tapparella.motorizzazione === 'si' ? 250 : 120;
                const prezzo_unitario = superficie_mq * prezzo_base;
                const importo = prezzo_unitario * tapparella.quantita;
                
                return {
                    successo: true,
                    tipo: 'Tapparella',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: tapparella.motorizzazione === 'si' ? 'Tapparella Motorizzata' : 'Tapparella Manuale',
                    quantita: tapparella.quantita,
                    misure: `${tapparella.brm.L}Ã—${tapparella.brm.H} mm`,
                    superficie_mq: superficie_mq.toFixed(2),
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2)
                };
            },
            
            /**
             * Calcola voce cassonetto
             */
            calcolaVoceCassonetto(posizione, numero) {
                const cassonetto = posizione.cassonetto;
                
                if (!cassonetto.brm || !cassonetto.brm.L) {
                    return {
                        successo: false,
                        errore: `Posizione ${numero}: Mancano misure per cassonetto`
                    };
                }
                
                const lunghezza_m = cassonetto.brm.L / 1000;
                const prezzo_ml = 65;
                const prezzo_unitario = lunghezza_m * prezzo_ml;
                const importo = prezzo_unitario * cassonetto.quantita;
                
                return {
                    successo: true,
                    tipo: 'Cassonetto',
                    posizione: posizione.nome || posizione.ambiente || `Pos. ${numero}`,
                    descrizione: cassonetto.tipo || 'Cassonetto',
                    quantita: cassonetto.quantita,
                    misure: `L: ${cassonetto.brm.L} mm`,
                    prezzo_unitario: prezzo_unitario.toFixed(2),
                    importo: importo.toFixed(2)
                };
            }
        };

        console.log('ğŸ’° PreventivoCalculator loaded');
    </script>
    
    <script>
        // ============================================================================
        // PREVENTIVO UI - Interfaccia utente per preventivi
        // ============================================================================
        window.PreventivoUI = {
            
            preventivoCorrente: null,
            
            apriModalPreventivo() {
                console.log('ğŸ“Š Apertura modal preventivo...');
                
                if (!window.currentData || !window.currentData.posizioni) {
                    this.mostraErrore('Nessun progetto caricato');
                    return;
                }
                
                const preventivo = window.PreventivoCalculator.calcolaPreventivo(window.currentData);
                this.preventivoCorrente = preventivo;
                
                // RIMOSSA VALIDAZIONE - ora gestita dal Wizard
                // Il wizard si occupa di completare i dati mancanti prima di arrivare qui
                
                this.renderPreventivo(preventivo);
            },
            
            mostraNoData() {
                const html = `
                    <div class="preventivo-modal-overlay" id="preventivo-modal" onclick="if(event.target===this) PreventivoUI.chiudiModal()">
                        <div class="preventivo-modal">
                            <div class="preventivo-modal-header">
                                <h2 class="preventivo-modal-title">ğŸ’° Preventivo Commessa</h2>
                                <button class="preventivo-modal-close" onclick="PreventivoUI.chiudiModal()">âœ•</button>
                            </div>
                            
                            <div class="preventivo-warning">
                                <div class="preventivo-warning-icon">âš ï¸</div>
                                <div class="preventivo-warning-text">
                                    <p>Nessun prodotto con dati sufficienti per calcolare il preventivo.</p>
                                    <p>Verifica che siano presenti <strong>modelli</strong> e <strong>misure BRM</strong> nei rilievi.</p>
                                </div>
                            </div>
                            
                            <div class="preventivo-modal-actions">
                                <button class="btn-preventivo btn-secondary" onclick="PreventivoUI.chiudiModal()">
                                    â† Chiudi
                                </button>
                                <button class="btn-preventivo btn-primary" disabled style="opacity: 0.5; cursor: not-allowed;">
                                    ğŸ“„ Esporta PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.innerHTML = html;
                document.body.appendChild(container.firstElementChild);
            },
            
            renderPreventivo(preventivo) {
                console.log('ğŸ¨ Rendering preventivo...', preventivo);
                
                // Se davvero non ci sono voci (dopo wizard), mostra messaggio
                if (preventivo.voci.length === 0) {
                    const html = `
                        <div class="preventivo-modal-overlay" id="preventivo-modal" onclick="if(event.target===this) PreventivoUI.chiudiModal()">
                            <div class="preventivo-modal">
                                <div class="preventivo-modal-header">
                                    <h2 class="preventivo-modal-title">ğŸ’° Preventivo Commessa</h2>
                                    <button class="preventivo-modal-close" onclick="PreventivoUI.chiudiModal()">âœ•</button>
                                </div>
                                
                                <div class="preventivo-warning">
                                    <div class="preventivo-warning-icon">âš ï¸</div>
                                    <div class="preventivo-warning-text">
                                        <p>Nessun prodotto trovato nel progetto.</p>
                                        <p>Verifica che ci siano prodotti con <strong>quantitÃ  > 0</strong> nelle posizioni.</p>
                                    </div>
                                </div>
                                
                                <div class="preventivo-modal-actions">
                                    <button class="btn-preventivo btn-secondary" onclick="PreventivoUI.chiudiModal()">
                                        â† Chiudi
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    document.body.insertAdjacentHTML('beforeend', html);
                    return;
                }
                
                const html = `
                    <div class="preventivo-modal-overlay" id="preventivo-modal" onclick="if(event.target===this) PreventivoUI.chiudiModal()">
                        <div class="preventivo-modal preventivo-modal-large">
                            <div class="preventivo-modal-header">
                                <div>
                                    <h2 class="preventivo-modal-title">ğŸ’° Preventivo Commessa</h2>
                                    <p class="preventivo-modal-subtitle">${preventivo.progetto}</p>
                                </div>
                                <button class="preventivo-modal-close" onclick="PreventivoUI.chiudiModal()">âœ•</button>
                            </div>
                            
                            <div class="preventivo-cliente-info">
                                <div class="preventivo-info-item">
                                    <span class="preventivo-info-label">Cliente:</span>
                                    <span class="preventivo-info-value">${preventivo.cliente.nome || 'N/D'}</span>
                                </div>
                                ${preventivo.cliente.indirizzo ? `
                                <div class="preventivo-info-item">
                                    <span class="preventivo-info-label">Indirizzo:</span>
                                    <span class="preventivo-info-value">${preventivo.cliente.indirizzo}</span>
                                </div>
                                ` : ''}
                                <div class="preventivo-info-item">
                                    <span class="preventivo-info-label">Data:</span>
                                    <span class="preventivo-info-value">${new Date().toLocaleDateString('it-IT')}</span>
                                </div>
                            </div>
                            
                            ${preventivo.warnings.length > 0 ? `
                            <div class="preventivo-warnings-list">
                                <div class="preventivo-warnings-title">âš ï¸ Avvisi:</div>
                                ${preventivo.warnings.map(w => `<div class="preventivo-warning-item">${w}</div>`).join('')}
                            </div>
                            ` : ''}
                            
                            <div class="preventivo-table-container">
                                <table class="preventivo-table">
                                    <thead>
                                        <tr>
                                            <th>Posizione</th>
                                            <th>Tipo</th>
                                            <th>Descrizione</th>
                                            <th>Misure</th>
                                            <th>QtÃ </th>
                                            <th>Prezzo Unit.</th>
                                            <th>Importo</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${preventivo.voci.map(voce => `
                                            <tr>
                                                <td>${voce.posizione}</td>
                                                <td><span class="voce-tipo-badge ${voce.tipo.toLowerCase()}">${voce.tipo}</span></td>
                                                <td>${voce.descrizione}</td>
                                                <td style="font-family: monospace; font-size: 0.9rem;">${voce.misure}</td>
                                                <td style="text-align: center; font-weight: 600;">${voce.quantita}</td>
                                                <td style="text-align: right;">â‚¬ ${voce.prezzo_unitario}</td>
                                                <td style="text-align: right; font-weight: 700;">â‚¬ ${voce.importo}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>
                            
                            <div class="preventivo-totali">
                                <div class="preventivo-totale-row">
                                    <span>Materiali:</span>
                                    <span>â‚¬ ${preventivo.totali.materiali.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row">
                                    <span>Posa:</span>
                                    <span>â‚¬ ${preventivo.totali.posa.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row">
                                    <span>Smontaggio:</span>
                                    <span>â‚¬ ${preventivo.totali.smontaggio.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row subtotale">
                                    <span>Subtotale:</span>
                                    <span>â‚¬ ${preventivo.totali.subtotale.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row">
                                    <span>IVA (22%):</span>
                                    <span>â‚¬ ${preventivo.totali.iva.toFixed(2)}</span>
                                </div>
                                <div class="preventivo-totale-row finale">
                                    <span>TOTALE:</span>
                                    <span>â‚¬ ${preventivo.totali.totale.toFixed(2)}</span>
                                </div>
                            </div>
                            
                            <div class="preventivo-modal-actions">
                                <button class="btn-preventivo btn-secondary" onclick="PreventivoUI.chiudiModal()">
                                    â† Chiudi
                                </button>
                                <button class="btn-preventivo btn-primary" onclick="PreventivoUI.esportaPDF()">
                                    ğŸ“„ Esporta PDF
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.innerHTML = html;
                document.body.appendChild(container.firstElementChild);
            },
            
            chiudiModal() {
                const modal = document.getElementById('preventivo-modal');
                if (modal) {
                    modal.remove();
                }
            },
            
            esportaPDF() {
                if (!this.preventivoCorrente) {
                    alert('Nessun preventivo da esportare');
                    return;
                }
                
                console.log('ğŸ“„ Esportazione PDF preventivo...');
                alert('Funzione esportazione PDF in arrivo!');
            },
            
            mostraErrore(messaggio) {
                alert('âŒ ' + messaggio);
            }
        };

        console.log('ğŸ¨ PreventivoUI loaded');
    </script>
    
    <script>
        // ============================================================================
        // WIZARD COMPLETAMENTO DATI - Sistema intelligente multi-step
        // ============================================================================
        window.WizardCompletamento = {
            
            datiProgetto: null,
            analisi: null,
            configurazioneMisure: null,
            attributiCompletati: {},
            stepCorrente: 0,
            
            /**
             * Avvia analisi dati progetto
             */
            avviaAnalisi() {
                console.log('ğŸ” Avvio analisi dati progetto...');
                
                this.datiProgetto = window.currentData;
                this.analisi = this.analizzaDati();
                
                console.log('ğŸ“Š Analisi completata:', this.analisi);
                
                // Se tutto OK, vai diretto al preventivo
                if (this.analisi.tuttoOK) {
                    console.log('âœ… Tutti i dati presenti, genero preventivo diretto');
                    window.PreventivoUI.apriModalPreventivo();
                    return;
                }
                
                // Altrimenti apri wizard
                this.apriWizard();
            },
            
            /**
             * Analizza dati e trova cosa manca
             */
            analizzaDati() {
                const analisi = {
                    tuttoOK: true,
                    posizioniTotali: 0,
                    posizioniComplete: 0,
                    problemi: {
                        misureBRM: [],
                        attributi: []
                    }
                };
                
                const posizioni = this.datiProgetto.posizioni || [];
                analisi.posizioniTotali = posizioni.length;
                
                posizioni.forEach((pos, idx) => {
                    let posOK = true;
                    
                    // Controlla ogni tipo di prodotto
                    ['infisso', 'zanzariera', 'persiana', 'tapparella', 'cassonetto'].forEach(tipo => {
                        const prodotto = pos[tipo];
                        
                        if (prodotto && prodotto.quantita > 0) {
                            // Verifica BRM
                            const brmOK = this.verificaBRM(prodotto, tipo);
                            if (!brmOK) {
                                analisi.problemi.misureBRM.push({
                                    posizioneIdx: idx,
                                    posizione: pos.nome || pos.ambiente || `Posizione ${idx + 1}`,
                                    tipo: tipo,
                                    prodotto: prodotto,
                                    misureDisponibili: pos.misure || {}
                                });
                                posOK = false;
                                analisi.tuttoOK = false;
                            }
                            
                            // Verifica attributi specifici
                            const attributiMancanti = this.verificaAttributi(prodotto, tipo);
                            if (attributiMancanti.length > 0) {
                                analisi.problemi.attributi.push({
                                    posizioneIdx: idx,
                                    posizione: pos.nome || pos.ambiente || `Posizione ${idx + 1}`,
                                    tipo: tipo,
                                    prodotto: prodotto,
                                    attributiMancanti: attributiMancanti
                                });
                                posOK = false;
                                analisi.tuttoOK = false;
                            }
                        }
                    });
                    
                    if (posOK) analisi.posizioniComplete++;
                });
                
                return analisi;
            },
            
            /**
             * Verifica se BRM Ã¨ presente e valido
             */
            verificaBRM(prodotto, tipo) {
                if (tipo === 'cassonetto') {
                    // Cassonetto serve solo L
                    return prodotto.brm && prodotto.brm.L && prodotto.brm.L > 0;
                } else {
                    // Altri prodotti servono L e H
                    return prodotto.brm && 
                           prodotto.brm.L && prodotto.brm.L > 0 &&
                           prodotto.brm.H && prodotto.brm.H > 0;
                }
            },
            
            /**
             * Verifica attributi specifici per tipo prodotto
             */
            verificaAttributi(prodotto, tipo) {
                const mancanti = [];
                
                switch(tipo) {
                    case 'persiana':
                        if (!prodotto.telaio) mancanti.push({campo: 'telaio', label: 'Tipo Telaio'});
                        if (!prodotto.colore) mancanti.push({campo: 'colore', label: 'Colore'});
                        break;
                    
                    case 'zanzariera':
                        if (!prodotto.modello && !prodotto.tipo) mancanti.push({campo: 'modello', label: 'Modello'});
                        break;
                    
                    case 'infisso':
                        if (!prodotto.tipo) mancanti.push({campo: 'tipo', label: 'Tipo Infisso'});
                        if (!prodotto.azienda) mancanti.push({campo: 'azienda', label: 'Azienda/Fornitore'});
                        break;
                }
                
                return mancanti;
            },
            
            /**
             * Apre il wizard multi-step
             */
            apriWizard() {
                console.log('ğŸ§™ Apertura wizard completamento dati...');
                this.stepCorrente = 0;
                this.renderWizard();
            },
            
            /**
             * Render wizard container
             */
            renderWizard() {
                const html = `
                    <div class="wizard-overlay" id="wizard-preventivo" onclick="if(event.target===this) WizardCompletamento.chiudiWizard()">
                        <div class="wizard-container">
                            <div id="wizard-content"></div>
                        </div>
                    </div>
                `;
                
                const container = document.createElement('div');
                container.innerHTML = html;
                document.body.appendChild(container.firstElementChild);
                
                this.renderStepCorrente();
            },
            
            /**
             * Render step corrente
             */
            renderStepCorrente() {
                const content = document.getElementById('wizard-content');
                if (!content) return;
                
                switch(this.stepCorrente) {
                    case 0:
                        content.innerHTML = this.renderStepAnalisi();
                        break;
                    case 1:
                        content.innerHTML = this.renderStepConfiguraMisure();
                        break;
                    case 2:
                        content.innerHTML = this.renderStepAttributi();
                        break;
                    case 3:
                        content.innerHTML = this.renderStepRiepilogo();
                        break;
                }
            },
            
            /**
             * STEP 1: Analisi
             */
            renderStepAnalisi() {
                const a = this.analisi;
                
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">ğŸ” Analisi Progetto</h2>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-info-box">
                            <div class="wizard-info-row">
                                <span class="wizard-info-label">Progetto:</span>
                                <span class="wizard-info-value">${this.datiProgetto.nome || 'Senza nome'}</span>
                            </div>
                            <div class="wizard-info-row">
                                <span class="wizard-info-label">Posizioni totali:</span>
                                <span class="wizard-info-value">${a.posizioniTotali}</span>
                            </div>
                        </div>
                        
                        <div class="wizard-analysis">
                            ${a.posizioniComplete > 0 ? `
                            <div class="wizard-stat success">
                                <div class="wizard-stat-icon">âœ…</div>
                                <div class="wizard-stat-text">
                                    ${a.posizioniComplete} posizioni hanno dati completi
                                </div>
                            </div>
                            ` : ''}
                            
                            ${a.problemi.misureBRM.length > 0 ? `
                            <div class="wizard-stat warning">
                                <div class="wizard-stat-icon">âš ï¸</div>
                                <div class="wizard-stat-text">
                                    ${a.problemi.misureBRM.length} posizioni mancano misure BRM
                                </div>
                            </div>
                            ` : ''}
                            
                            ${a.problemi.attributi.length > 0 ? `
                            <div class="wizard-stat warning">
                                <div class="wizard-stat-icon">âš ï¸</div>
                                <div class="wizard-stat-text">
                                    ${a.problemi.attributi.length} posizioni mancano attributi
                                </div>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="wizard-message">
                            <p>Il wizard ti guiderÃ  nella configurazione dei dati mancanti.</p>
                            <p><strong>Configurazione globale:</strong> Imposti i parametri UNA VOLTA e si applicano a tutte le posizioni.</p>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.chiudiWizard()">
                            â† Annulla
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.avanti()">
                            Continua â†’
                        </button>
                    </div>
                `;
            },
            
            /**
             * STEP 2: Configurazione Misure BRM Globale
             */
            renderStepConfiguraMisure() {
                const problemi = this.analisi.problemi.misureBRM;
                
                if (problemi.length === 0) {
                    // Salta questo step
                    this.stepCorrente++;
                    return this.renderStepCorrente();
                }
                
                // Trova misure disponibili (esempio dalla prima posizione)
                const primaPosConMisure = problemi[0];
                const misureDisp = primaPosConMisure.misureDisponibili || {};
                
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">âš™ï¸ Configurazione Misure BRM</h2>
                        <p class="wizard-subtitle">Si applica a TUTTE le ${problemi.length} posizioni mancanti</p>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Posizioni da configurare:</h3>
                            <ul class="wizard-list">
                                ${problemi.map(p => `
                                    <li>â€¢ ${p.posizione} (${p.tipo.charAt(0).toUpperCase() + p.tipo.slice(1)})</li>
                                `).join('')}
                            </ul>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Misure disponibili nel rilievo:</h3>
                            <div class="wizard-misure-disponibili">
                                ${Object.keys(misureDisp).length > 0 ? Object.keys(misureDisp).map(key => `
                                    <div class="wizard-misura-badge">âœ“ ${key}</div>
                                `).join('') : '<div class="wizard-warning-text">Nessuna misura trovata nel rilievo</div>'}
                            </div>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Quale misura vuoi usare come riferimento?</h3>
                            <div class="wizard-radio-group">
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="LF" checked>
                                    <span class="wizard-radio-label">Luce Foro (LF)</span>
                                </label>
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="FM">
                                    <span class="wizard-radio-label">Foro Muro (FM)</span>
                                </label>
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="MT">
                                    <span class="wizard-radio-label">Misura Telaio (MT)</span>
                                </label>
                                <label class="wizard-radio">
                                    <input type="radio" name="misura-riferimento" value="manuale">
                                    <span class="wizard-radio-label">Inserimento manuale</span>
                                </label>
                            </div>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">Correzioni da applicare:</h3>
                            <div class="wizard-corrections">
                                <div class="wizard-correction-item">
                                    <label class="wizard-label">Larghezza:</label>
                                    <div class="wizard-input-group">
                                        <button class="wizard-btn-mini" onclick="this.nextElementSibling.value = '+'; this.nextElementSibling.nextElementSibling.nextElementSibling.value = '+'">+</button>
                                        <input type="text" id="correzione-segno-L" value="+" style="width: 40px; text-align: center" readonly>
                                        <input type="number" id="correzione-valore-L" value="20" style="width: 80px">
                                        <button class="wizard-btn-mini" onclick="document.getElementById('correzione-segno-L').value = '-'; document.getElementById('correzione-valore-L').value = Math.abs(parseInt(document.getElementById('correzione-valore-L').value) || 0)">-</button>
                                        <span class="wizard-unit">mm</span>
                                    </div>
                                </div>
                                <div class="wizard-correction-item">
                                    <label class="wizard-label">Altezza:</label>
                                    <div class="wizard-input-group">
                                        <button class="wizard-btn-mini" onclick="this.nextElementSibling.value = '+'; this.nextElementSibling.nextElementSibling.nextElementSibling.value = '+'">+</button>
                                        <input type="text" id="correzione-segno-H" value="-" style="width: 40px; text-align: center" readonly>
                                        <input type="number" id="correzione-valore-H" value="10" style="width: 80px">
                                        <button class="wizard-btn-mini" onclick="document.getElementById('correzione-segno-H').value = '-'; document.getElementById('correzione-valore-H').value = Math.abs(parseInt(document.getElementById('correzione-valore-H').value) || 0)">-</button>
                                        <span class="wizard-unit">mm</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="wizard-example">
                                ğŸ’¡ Esempio: Se LF=1200mm, con +20mm â†’ BRM=1220mm
                            </div>
                        </div>
                        
                        <div class="wizard-section">
                            <h3 class="wizard-section-title">ğŸ“‹ Anteprima applicazione:</h3>
                            <div class="wizard-preview" id="preview-misure">
                                <div class="wizard-loading">Seleziona parametri sopra...</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.indietro()">
                            â† Indietro
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.applicaMisure()">
                            Applica a Tutte â†’
                        </button>
                    </div>
                `;
            },
            
            /**
             * STEP 3: Attributi prodotti (placeholder - da espandere)
             */
            renderStepAttributi() {
                const problemi = this.analisi.problemi.attributi;
                
                if (problemi.length === 0) {
                    this.stepCorrente++;
                    return this.renderStepCorrente();
                }
                
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">ğŸ¨ Completa Attributi Prodotti</h2>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-message">
                            <p>Trovati ${problemi.length} prodotti con attributi mancanti.</p>
                            <p><em>FunzionalitÃ  in sviluppo - per ora usa valori default</em></p>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.indietro()">
                            â† Indietro
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.avanti()">
                            Salta â†’
                        </button>
                    </div>
                `;
            },
            
            /**
             * STEP 4: Riepilogo
             */
            renderStepRiepilogo() {
                return `
                    <div class="wizard-header">
                        <h2 class="wizard-title">ğŸ“Š Riepilogo Configurazione</h2>
                        <button class="wizard-close" onclick="WizardCompletamento.chiudiWizard()">âœ•</button>
                    </div>
                    
                    <div class="wizard-body">
                        <div class="wizard-summary">
                            <div class="wizard-summary-item success">
                                <div class="wizard-summary-icon">âœ…</div>
                                <div class="wizard-summary-text">
                                    <strong>Configurazione completata</strong>
                                    <p>Tutti i dati sono stati configurati</p>
                                </div>
                            </div>
                            
                            ${this.configurazioneMisure ? `
                            <div class="wizard-summary-section">
                                <h4>Misure BRM:</h4>
                                <ul>
                                    <li>Riferimento: ${this.configurazioneMisure.riferimento}</li>
                                    <li>Correzione L: ${this.configurazioneMisure.correzioneL}</li>
                                    <li>Correzione H: ${this.configurazioneMisure.correzioneH}</li>
                                </ul>
                            </div>
                            ` : ''}
                        </div>
                        
                        <div class="wizard-message">
                            <p><strong>Pronto per generare il preventivo!</strong></p>
                            <p>Click su "Genera Preventivo" per calcolare i costi.</p>
                        </div>
                    </div>
                    
                    <div class="wizard-footer">
                        <button class="wizard-btn wizard-btn-secondary" onclick="WizardCompletamento.chiudiWizard()">
                            â† Annulla
                        </button>
                        <button class="wizard-btn wizard-btn-primary" onclick="WizardCompletamento.generaPreventivo()">
                            ğŸ“„ Genera Preventivo
                        </button>
                    </div>
                `;
            },
            
            /**
             * Naviga avanti
             */
            avanti() {
                this.stepCorrente++;
                this.renderStepCorrente();
            },
            
            /**
             * Naviga indietro
             */
            indietro() {
                if (this.stepCorrente > 0) {
                    this.stepCorrente--;
                    this.renderStepCorrente();
                }
            },
            
            /**
             * Applica configurazione misure
             */
            applicaMisure() {
                const riferimento = document.querySelector('input[name="misura-riferimento"]:checked')?.value || 'LF';
                const segnoL = document.getElementById('correzione-segno-L')?.value || '+';
                const valoreL = parseInt(document.getElementById('correzione-valore-L')?.value || 0);
                const segnoH = document.getElementById('correzione-segno-H')?.value || '+';
                const valoreH = parseInt(document.getElementById('correzione-valore-H')?.value || 0);
                
                this.configurazioneMisure = {
                    riferimento: riferimento,
                    correzioneL: `${segnoL}${valoreL}mm`,
                    correzioneH: `${segnoH}${valoreH}mm`
                };
                
                console.log('âœ… Configurazione misure salvata:', this.configurazioneMisure);
                
                // Applica alle posizioni
                this.applicaMisureAiDati();
                
                // Vai avanti
                this.avanti();
            },
            
            /**
             * Applica misure configurate ai dati progetto
             */
            applicaMisureAiDati() {
                const problemi = this.analisi.problemi.misureBRM;
                
                problemi.forEach(problema => {
                    const pos = this.datiProgetto.posizioni[problema.posizioneIdx];
                    const prodotto = pos[problema.tipo];
                    
                    // Se giÃ  ha BRM, salta
                    if (this.verificaBRM(prodotto, problema.tipo)) return;
                    
                    // Inizializza BRM se non esiste
                    if (!prodotto.brm) prodotto.brm = {};
                    
                    // Calcola BRM da misure disponibili
                    const misure = problema.misureDisponibili;
                    const rif = this.configurazioneMisure.riferimento;
                    
                    // Prova a trovare la misura di riferimento
                    let misuraBase = misure[rif] || misure['LF'] || misure['FM'] || misure['luce_foro'];
                    
                    if (misuraBase) {
                        // Applica correzioni
                        const correzioneL = parseInt(this.configurazioneMisure.correzioneL.replace(/[^0-9-]/g, ''));
                        const correzioneH = parseInt(this.configurazioneMisure.correzioneH.replace(/[^0-9-]/g, ''));
                        
                        prodotto.brm.L = (misuraBase.L || 0) + correzioneL;
                        prodotto.brm.H = (misuraBase.H || 0) + correzioneH;
                        
                        console.log(`âœ… BRM applicato a ${problema.posizione}: ${prodotto.brm.L}Ã—${prodotto.brm.H}`);
                    } else {
                        // Usa valori di default se non trova misure
                        prodotto.brm.L = 1000;
                        prodotto.brm.H = 1200;
                        console.warn(`âš ï¸ Nessuna misura trovata per ${problema.posizione}, uso default`);
                    }
                });
            },
            
            /**
             * Genera preventivo finale
             */
            generaPreventivo() {
                console.log('ğŸ“Š Generazione preventivo con dati completati...');
                
                // Chiudi wizard
                this.chiudiWizard();
                
                // Apri preventivo con dati aggiornati
                setTimeout(() => {
                    window.PreventivoUI.apriModalPreventivo();
                }, 300);
            },
            
            /**
             * Chiudi wizard
             */
            chiudiWizard() {
                const wizard = document.getElementById('wizard-preventivo');
                if (wizard) {
                    wizard.remove();
                }
            }
        };

        console.log('ğŸ§™ WizardCompletamento loaded');
    </script>
    
    <script>
        // Listino Finstral inline (opzionale - rimosso caricamento fetch)
        // TODO: Integrare listino se necessario
        
        // Init completion tracker quando dati disponibili
        if (window.currentData) {
            console.log('ğŸš€ Initializing completion tracker...');
            CompletionTracker.updateMenuStatus(menuStructure, window.currentData);
            renderAdvancedMenu();
        }
    </script>

    <!-- MODAL SCELTA BRM -->
    <div id="brm-modal-overlay" class="brm-modal-overlay">
        <div class="brm-modal">
            <div class="brm-modal-header">
                <h2 class="brm-modal-title">âš ï¸ Selezione Misure BRM</h2>
                <p class="brm-modal-subtitle" id="brm-posizione-nome"></p>
            </div>
            
            <div class="brm-modal-body">
                <div class="brm-alert">
                    <p class="brm-alert-text">
                        Le misure BRM non sono state definite nel rilievo. 
                        Seleziona quali misure usare come riferimento per il listino Finstral.
                    </p>
                </div>
                
                <!-- SEZIONE LARGHEZZA -->
                <div class="brm-section" id="brm-section-larghezza" style="display: none;">
                    <div class="brm-section-title">
                        <span class="brm-section-icon">â†”ï¸</span>
                        LARGHEZZA
                    </div>
                    <div class="brm-options" id="brm-options-larghezza"></div>
                </div>
                
                <!-- SEZIONE ALTEZZA -->
                <div class="brm-section" id="brm-section-altezza" style="display: none;">
                    <div class="brm-section-title">
                        <span class="brm-section-icon">â†•ï¸</span>
                        ALTEZZA
                    </div>
                    <div class="brm-options" id="brm-options-altezza"></div>
                </div>
            </div>
            
            <div class="brm-modal-actions">
                <button class="brm-btn brm-btn-secondary" onclick="chiudiModalBRM()">Annulla</button>
                <button class="brm-btn brm-btn-primary" id="brm-btn-conferma" onclick="confermaBRM()" disabled>
                    Conferma e Calcola âœ“
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE GESTIONE LISTINI -->
    <div id="listini-modal" class="preventivo-modal-overlay" style="display: none;" onclick="if(event.target===this) chiudiGestioneListini()">
        <div class="preventivo-modal" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="preventivo-modal-header">
                <h2 class="preventivo-modal-title">ğŸ“š Gestione Listini Prezzi</h2>
                <button class="preventivo-modal-close" onclick="chiudiGestioneListini()">âœ•</button>
            </div>
            
            <!-- Tab Navigation -->
            <div style="display: flex; gap: 1rem; padding: 1rem; border-bottom: 2px solid #e5e7eb; background: #f9fafb;">
                <button class="tab-listini active" onclick="switchTabListini('persiane')">
                    ğŸšª Persiane
                </button>
                <button class="tab-listini" onclick="switchTabListini('zanzariere')">
                    ğŸ¦Ÿ Zanzariere
                </button>
                <button class="tab-listini" onclick="switchTabListini('test')">
                    ğŸ§ª Test Calcolo
                </button>
            </div>
            
            <!-- Content Persiane -->
            <div id="tab-content-persiane" class="tab-content-listini" style="padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Persiane - STEP 1</h3>
                
                <!-- Info Generale -->
                <div style="background: #f0fdf4; border-left: 4px solid #10b981; padding: 1rem; margin-bottom: 1.5rem; border-radius: 0.5rem;">
                    <p style="margin: 0; font-weight: 600; color: #065f46;">
                        â„¹ï¸ Versione: <span id="listino-persiane-versione"></span> | 
                        Aggiornamento: <span id="listino-persiane-data"></span>
                    </p>
                    <p style="margin: 0.5rem 0 0 0; font-size: 0.875rem; color: #047857;">
                        ğŸ“„ Fonte: <span id="listino-persiane-fonte"></span>
                    </p>
                </div>
                
                <!-- Modelli -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ—ï¸ Modelli Disponibili</h4>
                    <div id="listino-persiane-modelli"></div>
                </div>
                
                <!-- Telai -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ› ï¸ Telai</h4>
                    <div id="listino-persiane-telai"></div>
                </div>
                
                <!-- Colori -->
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ¨ Colori</h4>
                    <div id="listino-persiane-colori"></div>
                </div>
                
                <!-- Supplementi -->
                <div>
                    <h4 style="margin-bottom: 0.75rem; color: #374151;">ğŸ’° Supplementi</h4>
                    <div id="listino-persiane-supplementi"></div>
                </div>
            </div>
            
            <!-- Content Zanzariere -->
            <div id="tab-content-zanzariere" class="tab-content-listini" style="display: none; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ“Š Listino Zanzariere</h3>
                <div id="listino-zanzariere-content"></div>
            </div>
            
            <!-- Content Test -->
            <div id="tab-content-test" class="tab-content-listini" style="display: none; padding: 1.5rem;">
                <h3 style="margin-bottom: 1rem; color: #1f2937;">ğŸ§ª Test Calcolo Rapido</h3>
                
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                    <h4 style="margin-bottom: 1rem; color: #374151;">Persiana</h4>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; margin-bottom: 1rem;">
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Modello:</label>
                            <select id="test-modello" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Tipologia:</label>
                            <select id="test-tipologia" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Seleziona...</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Larghezza (mm):</label>
                            <input type="number" id="test-larghezza" placeholder="es. 1400" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Altezza (mm):</label>
                            <input type="number" id="test-altezza" placeholder="es. 1300" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Telaio:</label>
                            <select id="test-telaio" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Nessuno</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 0.25rem; font-weight: 600; color: #4b5563;">Colore:</label>
                            <select id="test-colore" style="width: 100%; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0.375rem;">
                                <option value="">Nessuno</option>
                            </select>
                        </div>
                    </div>
                    
                    <button onclick="eseguiTestCalcolo()" style="width: 100%; padding: 0.75rem; background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; border: none; border-radius: 0.5rem; font-weight: 600; cursor: pointer;">
                        ğŸ§® Calcola Prezzo
                    </button>
                    
                    <div id="test-risultato" style="margin-top: 1rem;"></div>
                </div>
            </div>
            
            <div class="preventivo-modal-actions">
                <button class="btn-preventivo btn-secondary" onclick="chiudiGestioneListini()">
                    â† Chiudi
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE INSERIMENTO MANUALE PREZZO PERSIANA -->
    <div id="modal-prezzo-manuale" class="preventivo-modal-overlay" style="display: none;" onclick="if(event.target===this) chiudiModalPrezzoManuale()">
        <div class="preventivo-modal" style="max-width: 600px;">
            <div class="preventivo-modal-header">
                <h2 class="preventivo-modal-title">âš ï¸ Inserimento Manuale Prezzo</h2>
                <button class="preventivo-modal-close" onclick="chiudiModalPrezzoManuale()">âœ•</button>
            </div>
            
            <div style="padding: 1.5rem;">
                <!-- Info dimensione non trovata -->
                <div style="background: #fef3c7; border-left: 4px solid #f59e0b; padding: 1rem; border-radius: 0.375rem; margin-bottom: 1.5rem;">
                    <p style="margin: 0; color: #92400e; font-weight: 600;">
                        ğŸ“ Dimensione non trovata nel listino
                    </p>
                    <p id="dimensione-mancante-info" style="margin: 0.5rem 0 0 0; color: #78350f; font-size: 0.875rem;"></p>
                </div>
                
                <!-- Form inserimento -->
                <div style="background: #f9fafb; border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ’° Prezzo Base (â‚¬): *
                        </label>
                        <input type="number" id="input-prezzo-base-manuale" 
                               placeholder="es. 850.00" 
                               step="0.01"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ› ï¸ Prezzo Telaio (â‚¬):
                        </label>
                        <input type="number" id="input-telaio-manuale" 
                               placeholder="es. 136.00 (opzionale)" 
                               step="0.01"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ¨ Maggiorazione Colore (%):
                        </label>
                        <input type="number" id="input-colore-perc-manuale" 
                               placeholder="es. 30 (opzionale)" 
                               min="0" 
                               max="100"
                               style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem;">
                    </div>
                    
                    <div style="margin-bottom: 1rem;">
                        <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; color: #374151;">
                            ğŸ“ Note:
                        </label>
                        <textarea id="input-note-manuale" 
                                  placeholder="es. Prezzo da preventivo fornitore ABC del 15/11/2025" 
                                  rows="3"
                                  style="width: 100%; padding: 0.75rem; border: 2px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; resize: vertical;"></textarea>
                    </div>
                    
                    <!-- Anteprima calcolo -->
                    <div id="anteprima-calcolo-manuale" style="background: white; border: 2px solid #10b981; border-radius: 0.375rem; padding: 1rem; margin-top: 1rem; display: none;">
                        <h4 style="margin: 0 0 0.75rem 0; color: #065f46;">ğŸ’¡ Anteprima Calcolo:</h4>
                        <div style="display: grid; grid-template-columns: 1fr auto; gap: 0.5rem; font-size: 0.875rem;">
                            <div style="color: #6b7280;">Prezzo Base:</div>
                            <div id="preview-base" style="font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="color: #6b7280;">Telaio:</div>
                            <div id="preview-telaio" style="font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Subtotale:</div>
                            <div id="preview-subtotale" style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="color: #6b7280;">Colore (%):</div>
                            <div id="preview-colore" style="font-weight: 600; color: #f59e0b;"></div>
                            
                            <div style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; color: #6b7280;">Totale Prodotto:</div>
                            <div id="preview-totale-prodotto" style="padding-top: 0.5rem; border-top: 1px solid #e5e7eb; font-weight: 700; color: #059669;"></div>
                            
                            <div style="color: #6b7280;">Contributo:</div>
                            <div id="preview-contributo" style="font-weight: 600; color: #1f2937;">â‚¬57.00</div>
                            
                            <div style="color: #6b7280;">Imballo (3%):</div>
                            <div id="preview-imballo" style="font-weight: 600; color: #1f2937;"></div>
                            
                            <div style="padding-top: 0.5rem; border-top: 2px solid #10b981; color: #065f46; font-weight: 700;">TOTALE FINALE:</div>
                            <div id="preview-finale" style="padding-top: 0.5rem; border-top: 2px solid #10b981; font-weight: 700; color: #059669; font-size: 1.125rem;"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="preventivo-modal-actions">
                <button class="btn-preventivo btn-secondary" onclick="chiudiModalPrezzoManuale()">
                    Annulla
                </button>
                <button class="btn-preventivo btn-primary" onclick="calcolaAnteprimaManuale()" style="background: #3b82f6;">
                    ğŸ§® Calcola Anteprima
                </button>
                <button id="btn-salva-prezzo-manuale" class="btn-preventivo btn-primary" onclick="salvaPrezzoManuale()" disabled style="opacity: 0.5;">
                    âœ… Salva Prezzo
                </button>
            </div>
        </div>
    </div>

</body>
</html>
