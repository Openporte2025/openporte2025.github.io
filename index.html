<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenPorte v3.5 - Menu Sistema Integrato</title>
    
    <!-- TUTTI GLI STILI IN UN UNICO POSTO -->
    <style>
        /* Reset base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding-top: 0;
        }
        
        /* Container principale */
        #app {
            transition: margin-left 0.3s ease;
            min-height: 100vh;
        }
        
        /* ===== MENU SISTEMA STYLES ===== */
        .menu-sistema {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background: linear-gradient(180deg, #2c3e50 0%, #34495e 100%);
            box-shadow: 2px 0 10px rgba(0,0,0,0.3);
            transition: left 0.3s ease;
            z-index: 9999;
            overflow-y: auto;
        }
        
        .menu-sistema.active {
            left: 0;
        }
        
        .menu-header {
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        
        .menu-title {
            color: white;
            font-size: 24px;
            font-weight: bold;
            margin: 0;
        }
        
        .menu-subtitle {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            margin-top: 5px;
        }
        
        .menu-items {
            padding: 10px 0;
        }
        
        .menu-item {
            position: relative;
            color: white;
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .menu-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 30px;
        }
        
        .menu-item.active {
            background: rgba(52, 152, 219, 0.3);
            border-left: 4px solid #3498db;
        }
        
        .menu-icon {
            font-size: 20px;
            min-width: 30px;
            text-align: center;
        }
        
        .menu-label {
            flex: 1;
            font-size: 16px;
        }
        
        .menu-arrow {
            color: rgba(255,255,255,0.5);
            transition: transform 0.3s;
        }
        
        .menu-item.expanded .menu-arrow {
            transform: rotate(90deg);
        }
        
        .submenu {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease;
            background: rgba(0,0,0,0.2);
        }
        
        .submenu.active {
            max-height: 500px;
        }
        
        .submenu-item {
            color: rgba(255,255,255,0.9);
            padding: 12px 20px 12px 60px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .submenu-item:hover {
            background: rgba(255,255,255,0.1);
            padding-left: 70px;
        }
        
        .menu-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 50px;
            height: 50px;
            background: #3498db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }
        
        .menu-toggle:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .menu-toggle.active {
            left: 260px;
        }
        
        .menu-toggle-icon {
            color: white;
            font-size: 24px;
        }
        
        .menu-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.5);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 9998;
        }
        
        .menu-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .menu-footer {
            position: absolute;
            bottom: 0;
            width: 100%;
            padding: 20px;
            background: rgba(0,0,0,0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
        }
        
        .sync-status {
            color: rgba(255,255,255,0.7);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .sync-status.connected {
            color: #2ecc71;
        }
        
        /* ===== APP STYLES ===== */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .project-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            cursor: pointer;
            transition: transform 0.3s;
        }
        
        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }
        
        .project-title {
            font-size: 18px;
            font-weight: bold;
            margin-bottom: 10px;
            color: #333;
        }
        
        .project-client {
            color: #666;
            margin-bottom: 5px;
        }
        
        .project-positions {
            color: #999;
            font-size: 14px;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 10px;
            margin-top: 40px;
        }
        
        .empty-state h2 {
            color: #666;
            margin-bottom: 20px;
        }
        
        .btn {
            display: inline-block;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
            text-decoration: none;
            margin: 5px;
        }
        
        .btn-primary {
            background: #3498db;
            color: white;
        }
        
        .btn-primary:hover {
            background: #2980b9;
        }
        
        .btn-success {
            background: #2ecc71;
            color: white;
        }
        
        .btn-success:hover {
            background: #27ae60;
        }
        
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 5px;
            color: white;
            z-index: 10001;
            animation: slideIn 0.3s;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }
            to {
                transform: translateX(0);
            }
        }
        
        .notification.success {
            background: #2ecc71;
        }
        
        .notification.error {
            background: #e74c3c;
        }
        
        .notification.info {
            background: #3498db;
        }
        
        .notification.warning {
            background: #f39c12;
        }
    </style>
</head>
<body>
    <div id="app"></div>
    
    <script>
        // ===== CONFIGURAZIONE GLOBALE =====
        const GITHUB_CONFIG = {
            owner: 'Openporte2025',
            repo: 'dati-cantieri',
            projectsPath: 'progetti',
            token: null
        };
        
        // ===== STATO APPLICAZIONE =====
        let state = {
            screen: 'list',
            projects: [],
            currentProject: null,
            currentPosition: null,
            github: {
                connected: false,
                token: null,
                lastSyncTime: null,
                syncStatus: 'disconnected'
            }
        };
        
        // ===== MENU SISTEMA =====
        const MenuSistema = {
            config: {
                menuItems: []
            },
            
            init() {
                console.log('üöÄ Inizializzazione Menu Sistema...');
                this.createMenuStructure();
                this.attachEventListeners();
                this.updateSyncStatus();
                console.log('‚úÖ Menu Sistema inizializzato!');
            },
            
            createMenuStructure() {
                // Rimuovi elementi esistenti
                document.querySelectorAll('.menu-sistema, .menu-toggle, .menu-overlay').forEach(el => el.remove());
                
                // Crea menu
                const menuContainer = document.createElement('div');
                menuContainer.className = 'menu-sistema';
                menuContainer.innerHTML = `
                    <div class="menu-header">
                        <div class="menu-title">OpenPorte</div>
                        <div class="menu-subtitle">Sistema Gestione Cantieri</div>
                    </div>
                    <div class="menu-items" id="menu-items-container"></div>
                    <div class="menu-footer">
                        <div class="sync-status" id="menu-sync-status">
                            <span class="sync-icon">üîÑ</span>
                            <span class="sync-text">Non connesso</span>
                        </div>
                    </div>
                `;
                
                // Toggle button
                const toggleButton = document.createElement('div');
                toggleButton.className = 'menu-toggle';
                toggleButton.innerHTML = '<span class="menu-toggle-icon">‚ò∞</span>';
                
                // Overlay
                const overlay = document.createElement('div');
                overlay.className = 'menu-overlay';
                
                // Aggiungi al DOM
                document.body.appendChild(menuContainer);
                document.body.appendChild(toggleButton);
                document.body.appendChild(overlay);
                
                // Aggiorna menu items
                this.updateMenuItems();
            },
            
            updateMenuItems() {
                const container = document.getElementById('menu-items-container');
                if (!container) return;
                
                // Definisci menu items
                this.config.menuItems = [
                    {
                        id: 'progetti',
                        label: 'Lista Progetti',
                        icon: 'üìÅ',
                        action: () => {
                            showScreen('list');
                            this.closeMenu();
                        }
                    },
                    {
                        id: 'nuovo-progetto',
                        label: 'Nuovo Progetto',
                        icon: '‚ûï',
                        action: () => {
                            createNewProject();
                            this.closeMenu();
                        }
                    },
                    {
                        id: 'sincronizzazione',
                        label: 'Sincronizzazione',
                        icon: 'üîÑ',
                        submenu: [
                            {
                                id: 'github-settings',
                                label: 'Impostazioni GitHub',
                                icon: '‚öôÔ∏è',
                                action: () => {
                                    showGitHubSettings();
                                    this.closeMenu();
                                }
                            },
                            {
                                id: 'download-github',
                                label: 'Scarica da GitHub',
                                icon: '‚¨áÔ∏è',
                                action: () => {
                                    downloadFromGitHub();
                                    this.closeMenu();
                                }
                            }
                        ]
                    },
                    {
                        id: 'import-export',
                        label: 'Import/Export',
                        icon: 'üíæ',
                        submenu: [
                            {
                                id: 'import',
                                label: 'Importa Progetti',
                                icon: 'üì•',
                                action: () => {
                                    importProjects();
                                    this.closeMenu();
                                }
                            },
                            {
                                id: 'export',
                                label: 'Esporta Progetti',
                                icon: 'üì§',
                                action: () => {
                                    exportProjects();
                                    this.closeMenu();
                                }
                            }
                        ]
                    }
                ];
                
                container.innerHTML = this.renderMenuItems(this.config.menuItems);
            },
            
            renderMenuItems(items) {
                return items.map(item => {
                    const hasSubmenu = item.submenu && item.submenu.length > 0;
                    let html = `
                        <div class="menu-item" data-menu-id="${item.id}">
                            <span class="menu-icon">${item.icon}</span>
                            <span class="menu-label">${item.label}</span>
                            ${hasSubmenu ? '<span class="menu-arrow">‚ñ∂</span>' : ''}
                        </div>
                    `;
                    
                    if (hasSubmenu) {
                        html += `
                            <div class="submenu" data-parent-id="${item.id}">
                                ${item.submenu.map(subitem => `
                                    <div class="submenu-item" data-menu-id="${subitem.id}">
                                        <span class="menu-icon">${subitem.icon}</span>
                                        <span class="menu-label">${subitem.label}</span>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                    
                    return html;
                }).join('');
            },
            
            attachEventListeners() {
                const toggle = document.querySelector('.menu-toggle');
                const overlay = document.querySelector('.menu-overlay');
                
                toggle?.addEventListener('click', () => this.toggleMenu());
                overlay?.addEventListener('click', () => this.closeMenu());
                
                // Event delegation per menu items
                document.addEventListener('click', (e) => {
                    const menuItem = e.target.closest('.menu-item');
                    if (menuItem) {
                        const menuId = menuItem.dataset.menuId;
                        const config = this.config.menuItems.find(m => m.id === menuId);
                        
                        if (config?.submenu) {
                            menuItem.classList.toggle('expanded');
                            const submenu = document.querySelector(`.submenu[data-parent-id="${menuId}"]`);
                            submenu?.classList.toggle('active');
                        } else if (config?.action) {
                            config.action();
                        }
                    }
                    
                    const submenuItem = e.target.closest('.submenu-item');
                    if (submenuItem) {
                        e.stopPropagation();
                        const menuId = submenuItem.dataset.menuId;
                        
                        for (const menuItem of this.config.menuItems) {
                            if (menuItem.submenu) {
                                const subItem = menuItem.submenu.find(s => s.id === menuId);
                                if (subItem?.action) {
                                    subItem.action();
                                    break;
                                }
                            }
                        }
                    }
                });
            },
            
            toggleMenu() {
                const menu = document.querySelector('.menu-sistema');
                const toggle = document.querySelector('.menu-toggle');
                const overlay = document.querySelector('.menu-overlay');
                
                menu?.classList.toggle('active');
                toggle?.classList.toggle('active');
                overlay?.classList.toggle('active');
            },
            
            closeMenu() {
                const menu = document.querySelector('.menu-sistema');
                const toggle = document.querySelector('.menu-toggle');
                const overlay = document.querySelector('.menu-overlay');
                
                menu?.classList.remove('active');
                toggle?.classList.remove('active');
                overlay?.classList.remove('active');
            },
            
            updateSyncStatus() {
                const syncStatus = document.getElementById('menu-sync-status');
                if (!syncStatus) return;
                
                const isConnected = state.github?.connected || false;
                
                if (isConnected) {
                    syncStatus.classList.add('connected');
                    syncStatus.innerHTML = `
                        <span class="sync-icon">‚úÖ</span>
                        <span class="sync-text">GitHub connesso</span>
                    `;
                } else {
                    syncStatus.classList.remove('connected');
                    syncStatus.innerHTML = `
                        <span class="sync-icon">üîÑ</span>
                        <span class="sync-text">Non connesso</span>
                    `;
                }
            }
        };
        
        // ===== FUNZIONI PRINCIPALI =====
        
        function loadState() {
            const saved = localStorage.getItem('openPorteData');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    
                    // Assicura che arrays e oggetti esistano
                    if (!Array.isArray(state.projects)) {
                        state.projects = [];
                    }
                    
                    if (!state.github) {
                        state.github = {
                            connected: false,
                            token: null,
                            lastSyncTime: null,
                            syncStatus: 'disconnected'
                        };
                    }
                    
                    // Carica token GitHub se presente
                    if (state.github.token) {
                        GITHUB_CONFIG.token = state.github.token;
                    }
                    
                    console.log(`üìÇ Caricati ${state.projects.length} progetti da localStorage`);
                } catch (e) {
                    console.error('Errore caricamento stato:', e);
                    initializeEmptyState();
                }
            } else {
                console.log('üì≠ Primo avvio - stato inizializzato');
                initializeEmptyState();
            }
        }
        
        function initializeEmptyState() {
            state = {
                screen: 'list',
                projects: [],
                currentProject: null,
                currentPosition: null,
                github: {
                    connected: false,
                    token: null,
                    lastSyncTime: null,
                    syncStatus: 'disconnected'
                }
            };
            
            // Crea progetto demo se in localhost
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                const demoProject = {
                    id: 'demo_' + Date.now(),
                    name: 'Progetto Demo',
                    client: 'Cliente Esempio',
                    positions: [],
                    createdAt: new Date().toISOString()
                };
                state.projects.push(demoProject);
                console.log('‚úÖ Creato progetto demo per test');
            }
            
            saveState();
        }
        
        function saveState() {
            try {
                localStorage.setItem('openPorteData', JSON.stringify(state));
                console.log('üíæ Stato salvato');
            } catch (e) {
                console.error('Errore salvataggio stato:', e);
            }
        }
        
        function showScreen(screen) {
            state.screen = screen;
            render();
        }
        
        function render() {
            const app = document.getElementById('app');
            
            switch(state.screen) {
                case 'list':
                    renderProjectsList();
                    break;
                case 'project':
                    renderProject();
                    break;
                default:
                    renderProjectsList();
            }
        }
        
        function renderProjectsList() {
            const app = document.getElementById('app');
            
            let html = `
                <div class="container">
                    <div class="header">
                        <h1>I Miei Progetti</h1>
                        <div style="margin-top: 10px;">
                            <button class="btn btn-primary" onclick="createNewProject()">‚ûï Nuovo Progetto</button>
                            <button class="btn btn-success" onclick="importProjects()">üì• Importa</button>
                            <button class="btn btn-success" onclick="exportProjects()">üì§ Esporta</button>
                        </div>
                    </div>
            `;
            
            if (state.projects && state.projects.length > 0) {
                html += '<div class="projects-grid">';
                
                state.projects.forEach(project => {
                    // Gestisci valori undefined
                    const projectName = project.name || 'Progetto senza nome';
                    const clientName = project.client || 'Cliente non specificato';
                    const positionsCount = (project.positions && Array.isArray(project.positions)) ? project.positions.length : 0;
                    
                    html += `
                        <div class="project-card" onclick="openProject('${project.id}')">
                            <div class="project-title">${projectName}</div>
                            <div class="project-client">Cliente: ${clientName}</div>
                            <div class="project-positions">${positionsCount} posizioni</div>
                        </div>
                    `;
                });
                
                html += '</div>';
            } else {
                html += `
                    <div class="empty-state">
                        <h2>Nessun progetto presente</h2>
                        <p>Crea un nuovo progetto o scarica da GitHub</p>
                        <button class="btn btn-primary" onclick="createNewProject()">‚ûï Crea Nuovo Progetto</button>
                        <button class="btn btn-success" onclick="downloadFromGitHub()">‚¨áÔ∏è Scarica da GitHub</button>
                    </div>
                `;
            }
            
            html += '</div>';
            app.innerHTML = html;
        }
        
        function renderProject() {
            const app = document.getElementById('app');
            const project = state.projects.find(p => p.id === state.currentProject);
            
            if (!project) {
                showScreen('list');
                return;
            }
            
            app.innerHTML = `
                <div class="container">
                    <div class="header">
                        <button class="btn" onclick="showScreen('list')">‚Üê Torna ai progetti</button>
                        <h1>${project.name || 'Progetto'}</h1>
                        <p>Cliente: ${project.client || 'Non specificato'}</p>
                    </div>
                    <div style="padding: 20px; background: white; border-radius: 10px;">
                        <p>Dettagli progetto in sviluppo...</p>
                        <p>Posizioni: ${project.positions ? project.positions.length : 0}</p>
                    </div>
                </div>
            `;
        }
        
        function createNewProject() {
            const name = prompt('Nome del progetto:');
            if (!name) return;
            
            const client = prompt('Nome del cliente:');
            
            const project = {
                id: 'project_' + Date.now(),
                name: name,
                client: client || 'Non specificato',
                positions: [],
                createdAt: new Date().toISOString()
            };
            
            state.projects.push(project);
            saveState();
            showNotification('Progetto creato', 'success');
            render();
        }
        
        function openProject(projectId) {
            state.currentProject = projectId;
            showScreen('project');
        }
        
        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, duration);
        }
        
        function importProjects() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const data = JSON.parse(event.target.result);
                        
                        if (Array.isArray(data)) {
                            state.projects = [...state.projects, ...data];
                        } else if (data.projects && Array.isArray(data.projects)) {
                            state.projects = [...state.projects, ...data.projects];
                        } else if (data.id) {
                            state.projects.push(data);
                        }
                        
                        saveState();
                        showNotification('Progetti importati', 'success');
                        render();
                    } catch (err) {
                        showNotification('Errore importazione', 'error');
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }
        
        function exportProjects() {
            const data = {
                version: '1.0',
                date: new Date().toISOString(),
                projects: state.projects
            };
            
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `openporte-export-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            showNotification('Progetti esportati', 'success');
        }
        
        function showGitHubSettings() {
            const token = prompt('Inserisci il token GitHub:');
            if (token) {
                GITHUB_CONFIG.token = token;
                state.github.token = token;
                state.github.connected = true;
                saveState();
                MenuSistema.updateSyncStatus();
                showNotification('GitHub configurato', 'success');
            }
        }
        
        async function downloadFromGitHub() {
            if (!GITHUB_CONFIG.token) {
                showNotification('Configura prima GitHub', 'warning');
                showGitHubSettings();
                return;
            }
            
            showNotification('Download in corso...', 'info');
            
            try {
                const response = await fetch(
                    `https://api.github.com/repos/${GITHUB_CONFIG.owner}/${GITHUB_CONFIG.repo}/contents/${GITHUB_CONFIG.projectsPath}`,
                    {
                        headers: {
                            'Authorization': `token ${GITHUB_CONFIG.token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        }
                    }
                );
                
                if (!response.ok) {
                    throw new Error(`Errore GitHub: ${response.status}`);
                }
                
                const files = await response.json();
                const jsonFiles = files.filter(f => f.name.endsWith('.json'));
                
                let imported = 0;
                for (const file of jsonFiles) {
                    try {
                        const contentResponse = await fetch(file.url, {
                            headers: {
                                'Authorization': `token ${GITHUB_CONFIG.token}`,
                                'Accept': 'application/vnd.github.v3+json'
                            }
                        });
                        
                        const contentData = await contentResponse.json();
                        const content = atob(contentData.content.replace(/\n/g, ''));
                        const projectData = JSON.parse(content);
                        
                        // Aggiungi progetto se non esiste gi√†
                        if (projectData.id && !state.projects.find(p => p.id === projectData.id)) {
                            state.projects.push(projectData);
                            imported++;
                        }
                    } catch (e) {
                        console.error(`Errore file ${file.name}:`, e);
                    }
                }
                
                saveState();
                render();
                showNotification(`Importati ${imported} progetti da GitHub`, 'success');
                
            } catch (error) {
                console.error('Errore download:', error);
                showNotification('Errore download da GitHub', 'error');
            }
        }
        
        // ===== INIZIALIZZAZIONE =====
        window.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ Avvio OpenPorte...');
            
            // Carica stato
            loadState();
            
            // Inizializza menu
            MenuSistema.init();
            
            // Render iniziale
            render();
            
            console.log('‚úÖ App pronta!');
        });
        
        // Esponi funzioni globali necessarie
        window.showScreen = showScreen;
        window.createNewProject = createNewProject;
        window.openProject = openProject;
        window.importProjects = importProjects;
        window.exportProjects = exportProjects;
        window.showGitHubSettings = showGitHubSettings;
        window.downloadFromGitHub = downloadFromGitHub;
    </script>
</body>
</html>
